CREATE OR REPLACE FUNCTION projects.get_project_details(
  p_project_id uuid
)
RETURNS TABLE (
  project_id uuid,
  title text,
  status text,
  banner_url text,
  is_starred boolean,
  owner_id uuid,
  owner_name text,
  owner_avatar_url text,
  stages jsonb
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, projects, org, auth
AS $$
DECLARE
  v_user_id uuid := auth.uid();
BEGIN
  -- Security check omitted for brevity (same as before)
  IF NOT EXISTS (
    SELECT 1 FROM projects.projects p
    LEFT JOIN projects.project_participants pp ON pp.project_id = p.id
    WHERE p.id = p_project_id
    AND (
        p.owner_user_id = v_user_id 
        OR pp.profile_id IN (
            SELECT id FROM org.freelancer_profiles WHERE user_id = v_user_id
            UNION 
            SELECT id FROM org.business_profiles WHERE owner_user_id = v_user_id
        )
    )
  ) THEN
    RAISE EXCEPTION 'Access Denied';
  END IF;

  RETURN QUERY
  SELECT
    p.id,
    p.title,
    p.status::text,
    NULL::text as banner_url,
    COALESCE(pref.is_starred, false),
    
    p.owner_user_id,
    -- FIX: Name construction logic applied here too
    CASE 
      WHEN bp.id IS NOT NULL THEN bp.name 
      ELSE COALESCE(
        NULLIF(TRIM(CONCAT_WS(' ', up.first_name, up.last_name)), ''), 
        up.username
      )
    END as owner_name,
    COALESCE(bp.logo_url, up.avatar_url) as owner_avatar_url,
    
    (
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', ps.id,
          'name', ps.name,
          'status', ps.status,
          'stage_type', ps.stage_type,
          'unread', EXISTS(
             SELECT 1 FROM comms.notifications n 
             WHERE n.user_id = v_user_id 
             AND n.read_at IS NULL 
             AND n.entity_table = 'projects.project_stages' 
             AND n.entity_id = ps.id
          ),
          'last_updated', (
             SELECT MAX(created_at) 
             FROM projects.project_activity pa 
             WHERE pa.entity_table = 'projects.project_stages' 
             AND pa.entity_id = ps.id
          )
        ) ORDER BY ps."order" ASC
      )
      FROM projects.project_stages ps
      WHERE ps.project_id = p.id
    ) as stages

  FROM projects.projects p
  LEFT JOIN projects.user_preferences pref ON pref.project_id = p.id AND pref.user_id = v_user_id
  LEFT JOIN org.business_profiles bp ON bp.id = p.client_business_id
  LEFT JOIN org.users_public up ON up.user_id = p.owner_user_id
  WHERE p.id = p_project_id;
END;
$$;