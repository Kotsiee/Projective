# Project Codebase Context

## Project Tree

```text
apps/
web/
client.ts
components/
auth/
buttons/
fields/
navigation/
public/
search/
Theme.tsx
contracts/
account/
auth/
navigation.ts
public/
deno.json
islands/
NavBar.tsx
pages/
main.ts
routes/
(auth)/
(dashboard)/
(public)/
api/
_app.tsx
_middleware.ts
server/
auth/
core/
dashboard/
middleware/
public/
static/
favicon.ico
logo.svg
styles/
components/
layouts/
pages/
styles.css
themes/
svg/
tests/
api/
unit/
_helpers/
types/
dashboard/
public/
utils.ts
codebase_context.md
db/
functions/
auth_project_or_dm_participant.sql
migrations/
0001_init_schemas.sql
0002_security_tables.sql
0003_org_tables.sql
0004_ops_tables.sql
0005_projects_tables.sql
0006_comms_tables.sql
0007_finance_tables.sql
0020_helpers_functions.sql
policies/
comms/
finance/
marketplace/
org/
business_profiles.sql
freelancer_profiles.sql
teams.sql
team_memberships.sql
users_public.sql
user_emails.sql
projects/
security/
audit_logs.sql
refresh_tokens.sql
session_context.sql
v_current_context.sql
storage/
scripts/
diff.sh
dump.sh
restore.sh
seeds/
views/
analytics_earnings_by_stage_mv.sql
security/
v_current_context.sql
deno.json
deno.lock
docs/
01_Vision.md
02_Features.md
03_TechStack.md
04_Roadmap.md
05_Security.md
06_InvestorSummary.md
07_UserStories.md
08_UserFlows.md
09_Tables.md
10_APIEndpints.md
11_Storage.md
12_RLS.md
13_FolderStructure.md
14_Sitemap.md
api/
README.md
architecture/
README.md
product/
README.md
uml.png
uml.svg
infra/
cf/
README.md
deno/
README.md
stripe/
README.md
LICENSE
packages/
backend/
auth/
jwt.ts
tokens.ts
config.ts
cookies.ts
crypto.ts
deno.json
env.ts
mod.ts
rateLimiter.ts
shared/
cookies.ts
deno.json
mod.ts
types.ts
validation/
auth.ts
ui/
components/
deno.json
hooks/
mod.ts
providers/
README.md
themes/
utils/
ThemeSwitcher.ts
wasm/
image_ops/
README.md
pack_project.ts
Projective Logo - White.png
Projective Logo.png
Projective Logo.svg
README.md
scripts/
dev.sh
setup.sh
test.sh
validate_names.ts
setup.ps1
supabase/
cli-latest
config/
README.md
edge-functions/
README.md
storage-rules/
README.md
testing.env.test
vite.config.ts
```

## File Contents

### File: apps\web\client.ts

```ts
import '@styles/styles.css';

```

### File: apps\web\components\auth\GitHubRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGithub } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/github/github-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGithub />
				{loading ? 'Connecting…' : 'Continue with GitHub'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleLoginButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleLoginButton({ redirectTo = '/' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-login?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\LoginButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { Signal } from '@preact/signals';

type Props = {
	redirectTo?: string;
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
};

export default function LoginButton({ redirectTo = '/', email, password }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/email/login', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: email, password: password }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Login success:', data);
				globalThis.location.href = data.redirectTo;
			} else {
				const c = await response.json();
				console.error('Login failed:', response);
				console.error('Login failed:', c.error.code);
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='login-button'
		>
			{loading ? 'Connecting…' : 'Log In'}
		</button>
	);
}

```

### File: apps\web\components\auth\OnboardingSubmit.tsx

```tsx
// apps/web/islands/auth/OnboardingSubmit.tsx
import { useCallback, useState } from 'preact/hooks';
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { getCsrfToken } from '@shared';

export default function OnboardingSubmit({
	firstName,
	lastName,
	username,
	type,
}: OnboardingRequest) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const csrf = getCsrfToken();

			if (!csrf) {
				setLoading(false);
				return;
			}

			const response = await fetch('/api/v1/auth/onboarding', {
				method: 'POST',
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json',
					'X-CSRF': csrf,
				},
				body: JSON.stringify({ firstName, lastName, username, type }),
			});

			if (!response.ok) {
				const errorBody = await response.json().catch(() => null);
				console.error('Onboarding failed:', errorBody ?? response.statusText);
				return;
			}

			const data = await response.json();
			console.log('Onboarding success:', data);
			// globalThis.location.href = '/dashboard';
		} catch (err) {
			console.error('Onboarding error:', err);
		} finally {
			setLoading(false);
		}
	}, [loading, firstName, lastName, username, type]);

	return (
		<button
			type='button'
			class='onboarding-submit'
			onClick={handleClick}
			disabled={loading}
			aria-busy={loading}
			aria-label='Create Profile'
		>
			{loading ? 'Saving…' : 'Continue'}
		</button>
	);
}

```

### File: apps\web\components\auth\RegisterButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import RegisterWithEmail from 'packages/shared/validation/auth.ts';
import { computed, Signal } from '@preact/signals';

type Props = {
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
	confirmPassword: Signal<string | undefined>;
};

export default function RegisterButton({
	email,
	password,
	confirmPassword,
}: Props) {
	const [loading, setLoading] = useState(false);

	const hasErrors = computed(() => {
		const e = (email.value || '').trim();
		const p = (password.value || '').trim();
		const c = (confirmPassword.value || '').trim();

		const v = RegisterWithEmail.validate({
			email: e,
			password: p,
			confirmPassword: c,
		}).ok;

		return !v;
	});

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const e = (email.value || '').trim();
			const p = (password.value || '').trim();
			const c = (confirmPassword.value || '').trim();

			const { ok } = RegisterWithEmail.validate({
				email: e,
				password: p,
				confirmPassword: c,
			});

			if (!ok) return;

			const response = await fetch('/api/v1/auth/email/register', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: e, password: p }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Registration success:', data);
				globalThis.location.href = '/verify';
			} else {
				console.error('Registration failed:', response);
			}
		} finally {
			setLoading(false);
		}
	}, [loading, email, password, confirmPassword]);

	return (
		<button
			type='button'
			class='login-button'
			onClick={handleClick}
			disabled={hasErrors.value}
			aria-busy={loading}
			aria-label='Create account'
		>
			{loading ? 'Connecting…' : 'Create Account'}
		</button>
	);
}

```

### File: apps\web\components\auth\ResendButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';

type Props = {
	email: string | undefined;
};

export default function ResendButton({ email }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/resend', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email }),
			});

			if (response.ok) {
				const data = await response.json();
			} else {
				const c = await response.json();
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='verify-button'
		>
			Resend verification email
		</button>
	);
}

```

### File: apps\web\components\fields\DropdownField.tsx

```tsx
import '@styles/components/fields/DropdownField.css';
import { Icon, IconChevronDown, IconX } from '@tabler/icons-preact';
import { Signal } from '@preact/signals';

export interface IDropdownItem {
	icon?: Icon | string;
	value: string;
	displayName?: string;
	label?: string;
}

export interface IDropdownFieldOptions {
	multiselect?: boolean;
	searchable?: boolean;
}

export interface IDropdownField {
	values: IDropdownItem[];
	defaultValues?: IDropdownItem[];
	selected?: Signal<IDropdownItem[]>;
	placeholder?: string;
	name?: string;
	options?: IDropdownFieldOptions;
}

export default function DropdownField(
	{ values, placeholder, selected, name, defaultValues, options }: IDropdownField,
) {
	const testClick = () => {
		console.log('dropdown-field__button click');
	};

	const testClick2 = () => {
		console.log('dropdown-field__selected__item__close click');
	};

	return (
		<div class='dropdown-field__container'>
			<div class='dropdown-field__input'>
				{
					/* <div class='dropdown-field__input__selected'>
					<div class='dropdown-field__input__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__input__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div> */
				}

				<button type='button' class='dropdown-field__input__button' onClick={() => testClick()}>
					{options?.searchable
						? (
							<input
								type='text'
								class='dropdown-field__input__button__input'
								placeholder={placeholder}
							/>
						)
						: <span class='dropdown-field__input__button__span'>{placeholder}</span>}

					<IconChevronDown />
				</button>
			</div>

			<div class='dropdown-field__selected__container'>
				<div class='dropdown-field__selected'>
					<div class='dropdown-field__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\components\fields\DualSliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\FormStages.tsx

```tsx
import '@styles/components/fields/FormStages.css';

export interface IFormStages {
	stage: number;
	stages: string[];
}

export default function FormStages({ stage, stages }: IFormStages) {
	return (
		<div class='form-stages'>
			{stages.map((stg, index) => {
				return (
					<>
						<div class='form-stages__item' data-selected={stage === index + 1}>
							<div class='form-stages__item__container'>
								<div class='form-stages__item__circle'>
									<p>
										{index + 1}
									</p>
								</div>
								<p class='form-stages__item__name'>{stg}</p>
							</div>

							{index != stages.length - 1 &&
								<hr class='form-stages__item__divider' />}
						</div>
					</>
				);
			})}
		</div>
	);
}

```

### File: apps\web\components\fields\PasswordField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';
import { IconEye, IconEyeClosed } from '@tabler/icons-preact';
import { signal } from '@preact/signals';

const type = signal<boolean>(true);

export default function PasswordField(props: InputHTMLAttributes<HTMLInputElement>) {
	const toggleVisibility = () => {
		type.value = !type.value;
	};

	return (
		<span class='password-field'>
			<input type={type.value ? 'password' : 'text'} {...props} />
			<button
				type='button'
				onClick={toggleVisibility}
				class='password-field__toggle-visibility'
			>
				{type.value ? <IconEyeClosed /> : <IconEye />}
			</button>
		</span>
	);
}

```

### File: apps\web\components\fields\RatingField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\RichTextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null },
) {
	return (
		<div class='text-field__container'>
			<small>{props.error}</small>
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
		</div>
	);
}

```

### File: apps\web\components\fields\SliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextAreaField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextAreaField(
	props: InputHTMLAttributes<HTMLTextAreaElement> & {
		error?: string | null;
		field?: string | null;
	},
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-area-field'>
				<textarea {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarGuest.tsx

```tsx
import '@styles/components/navigation/nav-bar-guest.css';
import { theme } from '../../../../packages/ui/utils/ThemeSwitcher.ts';

export default function NavBarGuest() {
	const switchTheme = () => {
		if (theme.value === 'light') {
			theme.value = 'dark';
		} else {
			theme.value = 'light';
		}
	};

	return (
		<div class='header-container'>
			<div class='header__logo'>
				<h1>Projective</h1>
			</div>
			<div class='header__buttons'>
				<button type='button'>search</button>
				<button type='button' onClick={() => switchTheme()}>{theme.value}</button>
				<a href='#'>Explore</a>
				<a class='header__buttons__user header__buttons__login' href='/login'>Login</a>
				<a class='header__buttons__user header__buttons__join' href='/register'>Join</a>
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUser.tsx

```tsx
import '@styles/components/navigation/nav-bar-user.css';
import { IconBell } from '@tabler/icons-preact';
import NavBarUserProfile from './profile/NavBarUserProfile.tsx';

export default function NavBarUser() {
	return (
		<div class='nav-bar-user'>
			<div class='nav-bar-user__logo'>
				<img class='nav-bar-user__logo__svg' src='/logo.svg' alt='Logo' />
				<h1>Projective</h1>
			</div>
			<div class='nav-bar-user__search'>
				<h1>Logo</h1>
			</div>
			<div class='nav-bar-user__actions'>
				<IconBell />
				<NavBarUserProfile />
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUserSide.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-side.css';
import { apps } from '@contracts/navigation.ts';
import { useEffect, useState } from 'preact/hooks';
import { signal } from '@preact/signals';
import { IconLayoutSidebarLeftCollapse, IconLayoutSidebarLeftExpand } from '@tabler/icons-preact';

const open = signal(false);

export default function NavBarUserSide() {
	const navApps = apps;
	const [selected, setSelected] = useState('');

	useEffect(() => {
		const loc = globalThis.location.pathname.substring(1).split('/')[0];
		setSelected(`/${loc.trim()}`);
	}, [globalThis.location]);

	const handleButtonClick = (_: MouseEvent) => {
		open.value = !open.value;
	};

	return (
		<aside class='nav-bar-user-side' data-sidebar-open={open.value}>
			<nav class='nav-bar-user-side__container'>
				{navApps.map((group) => {
					return (
						<div class='nav-bar-user-side__group'>
							{group.map((app) => {
								return (
									<a
										class='nav-bar-user-side__app'
										href={app.link}
										data-selected={selected === app.link}
										data-tooltip={app.name}
									>
										<app.icon />
										{open.value && <span>{app.name}</span>}
									</a>
								);
							})}
							<hr />
						</div>
					);
				})}
				<button type='button' class='nav-bar-user-side__open' onClick={handleButtonClick}>
					{open.value ? <IconLayoutSidebarLeftCollapse /> : <IconLayoutSidebarLeftExpand />}
				</button>
			</nav>
		</aside>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfile.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile.css';
import NavBarUserProfileDropdown from './NavBarUserProfileDropdown.tsx';
import { signal } from '@preact/signals';
import { useEffect, useRef } from 'preact/hooks';

const open = signal(false);

export default function NavBarUserProfile() {
	const rootRef = useRef<HTMLDivElement | null>(null);

	useEffect(() => {
		const handleClickOutside = (event: MouseEvent) => {
			const root = rootRef.current;
			if (!root) return;
			if (root.contains(event.target as Node)) return;
			open.value = false;
		};

		document.addEventListener('click', handleClickOutside);
		return () => {
			document.removeEventListener('click', handleClickOutside);
		};
	}, []);

	const handleButtonClick = (event: MouseEvent) => {
		console.log('huh');
		event.stopPropagation();
		open.value = !open.value;
	};

	return (
		<div class='nav-bar-user__profile' ref={rootRef}>
			<button
				type='button'
				class='nav-bar-user__profile__btn'
				onClick={handleButtonClick}
			>
				<div class='nav-bar-user__profile__btn__img'>
					<img src='https://placehold.co/50x50' />
				</div>
			</button>

			{open.value && (
				<div
					class='nav-bar-user__profile__dropdown-wrapper'
					tabIndex={0}
					onClick={(event: MouseEvent) => event.stopPropagation()}
				>
					<NavBarUserProfileDropdown />
				</div>
			)}
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdown.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown.css';
import { IconArrowsLeftRight, IconUser } from '@tabler/icons-preact';
import NavBarUserProfileDropdownActions from './NavBarUserProfileDropdownActions.tsx';
import NavBarUserProfileDropdownSwitch from './NavBarUserProfileDropdownSwitch.tsx';
import { signal } from '@preact/signals';

const switchView = signal(true);

export default function NavBarUserProfileDropdown() {
	return (
		<div class='nav-bar-user__profile__dropdown'>
			<div class='nav-bar-user__profile__dropdown__current'>
				<div class='nav-bar-user__profile__dropdown__current__profile'>
					<img src='https://placehold.co/50x50' />
					<div class='nav-bar-user__profile__dropdown__current__profile__name'>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__name'>bla</p>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__username'>bla</p>
					</div>
				</div>
				<button
					type='button'
					class='nav-bar-user__profile__dropdown__current__switch'
					data-tooltip={switchView.value ? 'Switch Account' : 'Account Actions'}
					onClick={() => switchView.value = !switchView.value}
				>
					{switchView.value ? <IconArrowsLeftRight /> : <IconUser />}
				</button>
			</div>
			<div>
				{switchView.value
					? <NavBarUserProfileDropdownActions />
					: <NavBarUserProfileDropdownSwitch />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownActions.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-actions.css';

export default function NavBarUserProfileDropdownActions() {
	return (
		<div class='nav-bar-user__profile__dropdown__actions'>
			<a>Profile</a>
			<a>Log Out</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownBusiness.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-business.css';

export default function NavBarUserProfileDropdownBusiness() {
	return (
		<div class='nav-bar-user__profile__dropdown__business'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Business
			</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownSwitch.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-switch.css';
import { signal } from '@preact/signals';
import NavBarUserProfileDropdownTeams from './NavBarUserProfileDropdownTeams.tsx';
import NavBarUserProfileDropdownBusiness from './NavBarUserProfileDropdownBusiness.tsx';

const switchView = signal(false);

export default function NavBarUserProfileDropdownSwitch() {
	return (
		<div class='nav-bar-user__profile__dropdown__switch'>
			<div class='nav-bar-user__profile__dropdown__switch__switch'>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--teams'
						value='teams'
						onInput={() => switchView.value = false}
						checked={switchView.value == false}
						hidden
					/>
					Teams
				</label>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--business'
						value='business'
						onInput={() => switchView.value = true}
						checked={switchView.value == true}
						hidden
					/>
					Business
				</label>
			</div>
			<hr />
			<div class='nav-bar-user__profile__dropdown__switch__account-type'>
				{!switchView.value
					? <NavBarUserProfileDropdownTeams />
					: <NavBarUserProfileDropdownBusiness />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownTeams.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-teams.css';

export default function NavBarUserProfileDropdownTeams() {
	return (
		<div class='nav-bar-user__profile__dropdown__teams'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Team
			</a>
		</div>
	);
}

```

### File: apps\web\components\public\explore\Filters.tsx

```tsx
import '@styles/components/public/explore/filters.css';
import DropdownField from '../../fields/DropdownField.tsx';

export default function ExploreFilters() {
	return (
		<div class='explore-filters'>
			<DropdownField values={[]} placeholder='Skills' options={{ searchable: true }} />
		</div>
	);
}

```

### File: apps\web\components\public\explore\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\search\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\Theme.tsx

```tsx

```

### File: apps\web\contracts\auth\login.ts

```ts
export interface LoginWithEmailRequest {
	email: string;
	password: string;
}

```

### File: apps\web\contracts\auth\onboading.ts

```ts
export interface OnboardingRequest {
	firstName: string;
	lastName: string;
	username: string;
	type: 'freelancer' | 'client';
}

```

### File: apps\web\contracts\auth\register.ts

```ts
export interface RegisterWithEmailRequest {
	email: string;
	password: string;
}

export interface RegisterWithEmailResponse {
	data: {
		user: {
			id: string;
			aud: string;
			role: string;
			email: string;
			email_confirmed_at: string;
			phone: string;
			last_sign_in_at: string;
			app_metadata: {
				provider: string;
				providers: string[];
			};
			user_metadata: {};
			identities: [
				{
					identity_id: string;
					id: string;
					user_id: string;
					identity_data: {
						email: string;
						email_verified: string;
						phone_verified: string;
						sub: string;
					};
					provider: string;
					last_sign_in_at: string;
					created_at: string;
					updated_at: string;
					email: string;
				},
			];
			created_at: string;
			updated_at: string;
		};
		session: {
			access_token: string;
			token_type: string;
			expires_in: number;
			expires_at: number;
			refresh_token: string;
			user: {
				id: string;
				aud: string;
				role: string;
				email: string;
				email_confirmed_at: string;
				phone: string;
				last_sign_in_at: string;
				app_metadata: {
					provider: string;
					providers: string[];
				};
				user_metadata: {};
				identities: [
					{
						identity_id: string;
						id: string;
						user_id: string;
						identity_data: {
							email: string;
							email_verified: false;
							phone_verified: false;
							sub: string;
						};
						provider: string;
						last_sign_in_at: string;
						created_at: string;
						updated_at: string;
						email: string;
					},
				];
				created_at: string;
				updated_at: string;
			};
		};
	};
	error: string | null;
}

```

### File: apps\web\contracts\navigation.ts

```ts
import {
	Icon,
	IconBriefcase,
	IconBuilding,
	IconChartLine,
	IconCompass,
	IconHome,
	IconMessages,
	IconPlug,
	IconSettings,
	IconUsers,
	IconWallet,
} from '@tabler/icons-preact';

export interface INavApp {
	icon: Icon;
	name: string;
	link: string;
}

export const apps1: INavApp[] = [
	{
		icon: IconHome,
		name: 'Dashboard',
		link: '/dashboard',
	},
	{
		icon: IconCompass,
		name: 'Explore',
		link: '/explore',
	},
	{
		icon: IconMessages,
		name: 'Messages',
		link: '/messages',
	},
];

export const apps2: INavApp[] = [
	{
		icon: IconBriefcase,
		name: 'Projects',
		link: '/projects',
	},
	{
		icon: IconUsers,
		name: 'Teams',
		link: '/teams',
	},
	{
		icon: IconBuilding,
		name: 'Businesses',
		link: '/businesses',
	},
];

export const apps3: INavApp[] = [
	{
		icon: IconChartLine,
		name: 'Analytics',
		link: '/analytics',
	},
	{
		icon: IconWallet,
		name: 'Earnings',
		link: '/earnings',
	},
	{
		icon: IconSettings,
		name: 'Settings',
		link: '/settings',
	},
];

export const apps = [apps1, apps2, apps3];

```

### File: apps\web\contracts\public\IExploreCategories.ts

```ts
// packages/lib/search/explore/explore-categories.ts
// Explore-specific categories, subcategories, and sort options.

export type ExploreCategory = 'work' | 'resources' | 'projects';

export type ExploreSubcategory =
	| 'services'
	| 'freelancers'
	| 'teams'
	| 'templates'
	| 'products'
	| 'articles'
	| 'courses'
	| 'projects';

export type IExploreRequestSortBy =
	| 'recommended'
	| 'newest'
	| 'oldest'
	| 'mostPopular'
	| 'highestRated'
	| 'lowestRated'
	| 'priceLowToHigh'
	| 'priceHighToLow';

// Compile-time mapping from subcategory → category.
// This is purely a type-level mapping, no runtime code.
export type ExploreCategoryForSubcategory<S extends ExploreSubcategory> = S extends
	| 'services'
	| 'freelancers'
	| 'teams' ? 'work'
	: S extends 'projects' ? 'projects'
	: 'resources';

```

### File: apps\web\contracts\public\IExploreFacets.ts

```ts
// packages/lib/search/explore/explore-facets.ts
// Facet / aggregation models that you use to build filters from result sets.

export interface NumericFacet {
	min: number | null;
	max: number | null;
	avg?: number | null;
}

export interface TermFacetBucket {
	value: string;
	count: number;
}

export type TermFacet = TermFacetBucket[];

// Generic facets bag. You can extend this per endpoint if needed via generics.
export interface ExploreFacets {
	// money
	price?: NumericFacet;
	hourlyRate?: NumericFacet;
	budget?: NumericFacet;

	// common categorical facets
	languages?: TermFacet;
	skills?: TermFacet;
	countries?: TermFacet;
	timezones?: TermFacet;
	topics?: TermFacet;
	serviceCategories?: TermFacet;
	productTypes?: TermFacet;
	licenseTypes?: TermFacet;

	// allow extension without changing this file
	[key: string]: NumericFacet | TermFacet | undefined;
}

// Generic response wrapper for any explore endpoint.
export interface ExploreResponse<
	TItem,
	TFacets extends ExploreFacets = ExploreFacets,
> {
	items: TItem[];
	page: number;
	pageSize: number;
	total: number;
	facets: Partial<TFacets>;
}

```

### File: apps\web\contracts\public\IExploreFilters.ts

```ts
// packages/lib/search/explore/explore-filters.ts
// Explore-specific filter models (no request/response shapes here).

// ---- Filter atoms ----

export interface PriceRangeFilter {
	minPriceCents?: number;
	maxPriceCents?: number;
	currency?: string; // 'GBP', 'USD', etc.
}

export interface HourlyRateFilter {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	currency?: string;
}

export interface RatingFilter {
	minRating?: number; // 1–5
	maxRating?: number; // rarely used but available
}

export interface LocationFilter {
	countries?: string[]; // ISO codes or canonical names
	timezones?: string[]; // 'Europe/London', etc.
	remoteOnly?: boolean;
}

export interface LanguageFilter {
	languages?: string[]; // matches your text[] language fields
}

export interface SkillsFilter {
	skills?: string[]; // skill slugs/ids
	minSkillScore?: number; // optional if you ever store skill proficiency
}

export interface AvailabilityFilter {
	availability?:
		| 'immediate'
		| 'thisWeek'
		| 'nextWeek'
		| 'scheduled';
}

export interface MetaFilter {
	minCompletedProjects?: number;
	minSales?: number;
}

export interface BudgetRangeFilter {
	minBudgetCents?: number;
	maxBudgetCents?: number;
	currency?: string;
}

// ---- Work (services / freelancers / teams) ----

export interface WorkBaseFilters
	extends
		PriceRangeFilter,
		RatingFilter,
		LocationFilter,
		LanguageFilter,
		SkillsFilter,
		AvailabilityFilter,
		MetaFilter {
	topics?: string[]; // 'design', 'marketing', etc.
}

export interface ServicesFilters extends WorkBaseFilters {
	serviceCategoryIds?: string[]; // taxonomy table / search topics
	durationMinutesMax?: number; // for calls / sessions
}

export interface FreelancerFilters extends WorkBaseFilters {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	minPortfolioItems?: number;
}

export interface TeamFilters extends WorkBaseFilters {
	minTeamSize?: number;
	maxTeamSize?: number;
	requireMultipleRoles?: boolean;
}

// ---- Resources (templates / products / articles / courses) ----

export interface ResourceBaseFilters extends PriceRangeFilter, RatingFilter, LanguageFilter {
	topics?: string[];
	formats?: string[]; // 'figma', 'pdf', 'notion', 'video', etc.
}

export interface TemplatesFilters extends ResourceBaseFilters {
	templateType?: string[]; // 'landing-page', 'saas-ui', ...
	requiresCode?: boolean;
}

export interface ProductsFilters extends ResourceBaseFilters {
	productType?: string[]; // 'theme', 'component-library', etc.
	licenseType?: string[]; // 'full_rights', 'template_only', ...
	digitalOnly?: boolean;
}

export interface ArticlesFilters extends ResourceBaseFilters {
	readTimeMinutesMax?: number;
	publishedAfter?: string; // ISO date
	publishedBefore?: string; // ISO date
}

export interface CoursesFilters extends ResourceBaseFilters {
	level?: ('beginner' | 'intermediate' | 'advanced')[];
	minLessons?: number;
	maxLessons?: number;
}

// ---- Projects ----

export type ProjectStatus = 'draft' | 'active' | 'on_hold';

export interface ProjectsFilters extends BudgetRangeFilter, LocationFilter, LanguageFilter {
	status?: ProjectStatus[];
	stageTypes?: string[]; // filter by presence of certain stage types
}

```

### File: apps\web\contracts\public\IExploreRequest.ts

```ts
import {
	ExploreCategoryForSubcategory,
	ExploreSubcategory,
	IExploreRequestSortBy,
} from './IExploreCategories.ts';
import {
	ArticlesFilters,
	CoursesFilters,
	FreelancerFilters,
	ProductsFilters,
	ProjectsFilters,
	ServicesFilters,
	TeamFilters,
	TemplatesFilters,
} from './IExploreFilters.ts';
import { ISearchRequestWithSortAndFilter } from './ISearchRequest.ts';

// Text/semantic query shape, extendable later.
export interface ExploreQuery {
	term?: string;
}

// Mapping from subcategory → filters interface.
export interface ExploreFiltersBySubcategory {
	services: ServicesFilters;
	freelancers: FreelancerFilters;
	teams: TeamFilters;
	templates: TemplatesFilters;
	products: ProductsFilters;
	articles: ArticlesFilters;
	courses: CoursesFilters;
	projects: ProjectsFilters;
}

export type ExploreFilters<S extends ExploreSubcategory> = ExploreFiltersBySubcategory[S];

export type ExploreRequestFor<S extends ExploreSubcategory> =
	& ISearchRequestWithSortAndFilter<
		ExploreQuery,
		ExploreFilters<S>,
		IExploreRequestSortBy
	>
	& {
		category: ExploreCategoryForSubcategory<S>;
		subcategory: S;
	};

// Union type for handlers that accept any explore subcategory.
export type ExploreRequest =
	| ExploreRequestFor<'services'>
	| ExploreRequestFor<'freelancers'>
	| ExploreRequestFor<'teams'>
	| ExploreRequestFor<'templates'>
	| ExploreRequestFor<'products'>
	| ExploreRequestFor<'articles'>
	| ExploreRequestFor<'courses'>
	| ExploreRequestFor<'projects'>;

// Optional convenience helper to infer subcategory from a request.
export type InferExploreSubcategory<T extends ExploreRequest> = T['subcategory'];

// Optional convenience helper to get filters type from a subcategory.
export type InferExploreFilters<T extends ExploreRequest> = T extends
	ExploreRequestFor<infer S extends ExploreSubcategory> ? ExploreFilters<S>
	: never;

```

### File: apps\web\contracts\public\IExploreResponse.ts

```ts
import { ExploreSubcategory } from './IExploreCategories.ts';
import { ProjectStatus } from './IExploreFilters.ts';

export interface ExploreUploader {
	id: string;
	username: string;
	displayName: string;
	avatarUrl: string | null;
	profileSlug?: string;
}

// ---- Common item base ----

export interface ExploreItemBase {
	id: string;
	slug?: string;
	subcategory: ExploreSubcategory;
	name: string; // item name/title
	imageUrl: string | null;
	uploader: ExploreUploader;
}

// ---- Meta building blocks ----

export interface RatingMeta {
	rating: number | null; // 0–5 , null if no ratings yet
	ratingCount: number;
}

export interface PriceMeta extends RatingMeta {
	priceCents: number;
	currency: string; // 'GBP', 'USD', etc.
	originalPriceCents?: number; // for discounts
	isDiscounted?: boolean;
}

export interface TemplateMeta extends RatingMeta {
	description: string;
}

export interface ArticleMeta extends RatingMeta {
	estimatedReadTimeMinutes: number;
}

export interface ProjectMeta {
	durationDays: number;
	status: ProjectStatus;
}

export interface FreelancerTeamMeta extends RatingMeta {
	serviceCount: number;
	productCount: number;
	headline: string;
}

// ---- Items per subcategory ----

// Services: rating, number of ratings, price
export interface ServiceExploreItem extends ExploreItemBase {
	subcategory: 'services';
	meta: PriceMeta;
}

// Products: rating, number of ratings, price
export interface ProductExploreItem extends ExploreItemBase {
	subcategory: 'products';
	meta: PriceMeta;
}

// Courses: rating, number of ratings, price
export interface CourseExploreItem extends ExploreItemBase {
	subcategory: 'courses';
	meta: PriceMeta;
}

// Templates: rating, number of ratings, description
export interface TemplateExploreItem extends ExploreItemBase {
	subcategory: 'templates';
	meta: TemplateMeta;
}

// Articles: rating, number of ratings, estimated read time
export interface ArticleExploreItem extends ExploreItemBase {
	subcategory: 'articles';
	meta: ArticleMeta;
}

// Projects: duration and status
export interface ProjectExploreItem extends ExploreItemBase {
	subcategory: 'projects';
	meta: ProjectMeta;
}

// Freelancers: rating, number of ratings, number of services, number of products, headline
export interface FreelancerExploreItem extends ExploreItemBase {
	subcategory: 'freelancers';
	meta: FreelancerTeamMeta;
}

// Teams: rating, number of ratings, number of services, number of products, headline
export interface TeamExploreItem extends ExploreItemBase {
	subcategory: 'teams';
	meta: FreelancerTeamMeta;
}

// Union of all possible explore items
export type ExploreItem =
	| ServiceExploreItem
	| ProductExploreItem
	| CourseExploreItem
	| TemplateExploreItem
	| ArticleExploreItem
	| ProjectExploreItem
	| FreelancerExploreItem
	| TeamExploreItem;

```

### File: apps\web\contracts\public\ISearchRequest.ts

```ts
export interface ISearchRequest<Q> {
	query: Q;
	page: number;
	pageSize: number;
}

export type SortOrder = 'asc' | 'desc';

export interface ISearchRequestWithSort<Q, S> extends ISearchRequest<Q> {
	sortBy: S;
	sortOrder: SortOrder;
}

export interface ISearchRequestWithFilter<Q, F> extends ISearchRequest<Q> {
	filters: F;
}

export interface ISearchRequestWithSortAndFilter<Q, F, S>
	extends ISearchRequestWithSort<Q, S>, ISearchRequestWithFilter<Q, F> {}

export type IFilterTypes = 'string' | 'number' | 'boolean' | 'date' | 'range' | 'array';

export interface ISearchRequestFilterDefinition<T> {
	type: IFilterTypes;
	values?: T[];
	min?: number;
	max?: number;
}

```

### File: apps\web\contracts\public\ISearchResponse.ts

```ts
export interface ISearchResponse<T> {
	results: T[];
	totalCount: number;
	page: number;
	pageSize: number;
}

```

### File: apps\web\deno.json

```json
{
  "tasks": {
    "check": "deno fmt --check && deno lint && deno check main.ts",
    "dev": "vite --port 3000 --open --host --mode development",
    "build": "vite build --mode production",
    "start": "deno serve -A --watch --port 3000 --env-file=../../.env main.ts",
    "update": "deno run -A -r jsr:@fresh/update ."
  },
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "preact"
  }
}

```

### File: apps\web\islands\NavBar.tsx

```tsx
import '@styles/components/navigation/nav-bar.css';
import NavBarGuest from '@components/navigation/NavBarGuest.tsx';
import NavBarUser from '@components/navigation/NavBarUser.tsx';
import NavBarUserSide from '@components/navigation/NavBarUserSide.tsx';

export default function NavBar(props: { isAuthenticated?: boolean }) {
	return (
		<>
			<header>
				<nav>
					{props.isAuthenticated ? <NavBarUser /> : <NavBarGuest />}
				</nav>
			</header>
			{props.isAuthenticated &&
				<NavBarUserSide />}
		</>
	);
}

```

### File: apps\web\islands\pages\auth\AuthLayout.tsx

```tsx
import '@styles/layouts/auth.css';
import { type ComponentChildren } from 'preact';

type AuthLayoutProps = {
	children: ComponentChildren;
};

export default function AuthLayout(props: AuthLayoutProps) {
	return (
		<div class='layout-auth'>
			<img
				src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
				alt='background'
				class='background'
			/>

			<div class='layout-auth__modal'>
				<div class='layout-auth__modal__window'>
					<img
						src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
						alt='background'
						class='backgrounds'
					/>
					<div class='layout-auth__modal__window__content'>
						<div class='layout-auth__modal__window__content__quote'>
							<p>Everything you can imagine is real</p>
							<div class='layout-auth__modal__window__content__quote__line-container'>
								<div class='layout-auth__modal__window__content__quote__line'></div>
								<span>Pablo Picasso</span>
							</div>
						</div>

						<div class='layout-auth__modal__window__content__slogan'>
							<h1 class='build-together'>Build Together.</h1>
							<h1 class='deliver-better'>Deliver Better.</h1>
						</div>
					</div>
				</div>

				<div class='layout-auth__modal__content'>
					<h1>Welcome</h1>
					{props.children}
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Login.tsx

```tsx
import '@styles/pages/auth/login.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import LoginButton from '@components/auth/LoginButton.tsx';
import GoogleLoginButton from '@components/auth/GoogleLoginButton.tsx';
import GitHubLoginButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);

export default function LoginIsland() {
	return (
		<div class='login'>
			<div class='login__container'>
				<div class='login__container__center'>
					<div class='login__header'>
						<h1>Welcome Back</h1>
						<p>Dive back in, right where you left off</p>
					</div>

					<div class='login__fields__container'>
						<div class='login__fields'>
							<TextField
								id='email'
								placeholder='Email'
								autocomplete='email'
								type='email'
								aria-label='Email address'
								aria-required='true'
								aria-describedby='email-error'
								onInput={(e) => {
									email.value = e.currentTarget.value;
								}}
							/>
							<div>
								<PasswordField
									id='password'
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								<div class='login__fields__options'>
									<label for='remember-me' class='remember-me'>
										<input type='checkbox' id='remember-me' />
										<span>Remember Me</span>
									</label>
									<a href='/auth/forgot-password'>Forgot Password?</a>
								</div>
							</div>
						</div>

						<div class='login__actions'>
							<LoginButton
								email={email}
								password={password}
							/>
							<GoogleLoginButton />
							<GitHubLoginButton />
						</div>
					</div>
				</div>
			</div>
			<div class='switch-auth'>
				<p class='switch-auth__text'>Don't have an account?</p>
				<a class='switch-auth__link' href='/register'>Register</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Onboarding.tsx

```tsx
import '@styles/pages/auth/onboarding.css';
import { useEffect } from 'preact/hooks';
import { signal } from '@preact/signals';
import OnboardingSubmit from '@components/auth/OnboardingSubmit.tsx';
import TextField from '@components/fields/TextField.tsx';

const firstName = signal('');
const lastName = signal('');
const username = signal('');
const type = signal<'freelancer' | 'client'>('client');

export default function OnboardingIsland() {
	useEffect(() => {
		const run = async () => {
			const response = await fetch('/api/v1/auth/user', {
				method: 'GET',
			});

			if (response.ok && response.status === 200) {
				const resp = await response.json();
				firstName.value = resp.firstName ?? '';
				lastName.value = resp.lastName ?? '';
				username.value = resp.username ?? '';
				console.log(resp);
			}
		};

		run();
	}, []);

	const onUserTypeChange = (e: InputEvent) => {
		type.value = (e.currentTarget as HTMLInputElement).value as ('freelancer' | 'client');
	};

	return (
		<div class='onboarding'>
			<div class='onboarding-stages'>
				<form class='onboarding-stage'>
					<div class='onboarding-stage__account-type__container'>
						<label
							for='onboarding-stage__account-type--client'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--client'
								value='client'
								hidden
								checked={type.value === 'client'}
								onInput={onUserTypeChange}
							/>
							Client
						</label>
						<label
							for='onboarding-stage__account-type--seller'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--seller'
								value='freelancer'
								hidden
								checked={type.value === 'freelancer'}
								onInput={onUserTypeChange}
							/>
							Seller
						</label>
					</div>

					<hr class='onboarding-stage__separator' />

					<div class='onboarding-stage__name'>
						<TextField value={firstName} placeholder='First Name' />
						<TextField value={lastName} placeholder='Last Name' />
					</div>

					<TextField value={username} placeholder='DoB' />
					<TextField value={username} placeholder='Username' />
				</form>
			</div>
			<div class='onboarding-stage-location'>
				<OnboardingSubmit
					firstName={firstName.value}
					lastName={lastName.value}
					username={username.value}
					type={type.value}
				/>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Register.tsx

```tsx
import '@styles/pages/auth/register.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import RegisterButton from '@components/auth/RegisterButton.tsx';
import GoogleRegisterButton from '@components/auth/GoogleRegisterButton.tsx';
import GitHubRegisterButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';
import { AuthValidator, RegisterErrors } from '@shared';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);
const confirmPassword = signal<string | undefined>(undefined);

const emailError = signal<string | null>(null);
const passwordError = signal<string | null>(null);
const confirmPasswordError = signal<string | null>(null);

const errors = signal<RegisterErrors>({});

export default function RegisterIsland() {
	return (
		<div class='register'>
			<div class='register__container'>
				<div class='register__container__center'>
					<div class='register__header'>
						<h1>Create an account</h1>
						<p>Begin Your Journey Here</p>
					</div>

					<form class='register__fields__container'>
						<div class='register__fields'>
							<div class='register__field'>
								<TextField
									id='email'
									onFocus={() => {
										emailError.value = '';
									}}
									onBlur={() => {
										emailError.value = AuthValidator
											.validateEmail(email.value || '');
									}}
									placeholder='Email'
									autocomplete='email'
									type='email'
									aria-label='Email address'
									aria-required='true'
									aria-invalid={!!emailError.value}
									aria-describedby='email-error'
									onInput={(e) => {
										email.value = e.currentTarget.value;
									}}
								/>
								{emailError.value && (
									<p
										id='email-error'
										class='register__field-error'
										role='alert'
									>
										{emailError.value ||
											errors.value?.email}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='password'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
										confirmPasswordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
									}}
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-invalid={!!passwordError.value}
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								{passwordError.value && (
									<p
										id='password-error'
										class='register__field-error'
										role='alert'
									>
										{passwordError.value ||
											errors.value?.password}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='confirmPassword'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
										confirmPasswordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
									}}
									placeholder='Re-enter Password'
									autocomplete='new-password'
									aria-label='Confirm password'
									aria-required='true'
									aria-invalid={!!confirmPasswordError.value}
									aria-describedby='confirmPassword-error'
									onInput={(e) => {
										confirmPassword.value = e.currentTarget.value;
									}}
								/>
								{confirmPasswordError.value && (
									<p
										id='confirmPassword-error'
										class='register__field-error'
										role='alert'
									>
										{confirmPasswordError.value ||
											errors.value?.confirmPassword}
									</p>
								)}
							</div>
						</div>

						<div class='register__actions'>
							<RegisterButton
								email={email}
								password={password}
								confirmPassword={confirmPassword}
							/>
							<GoogleRegisterButton />
							<GitHubRegisterButton />
						</div>
					</form>
				</div>
			</div>

			<div class='switch-auth'>
				<p class='switch-auth__text'>Already have an account?</p>
				<a class='switch-auth__link' href='/login'>Log In</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Verify.tsx

```tsx
import { useEffect, useState } from 'preact/hooks';
import ResendButton from '@components/auth/ResendButton.tsx';

type Props = {
	email: string | undefined;
};

export default function VerifyIsland({ email }: Props) {
	const [status, setStatus] = useState<'parsing' | 'verifying' | 'awaiting' | 'done' | 'error'>(
		'parsing',
	);
	const [err, setErr] = useState<string | null>(null);

	useEffect(() => {
		const params = new URLSearchParams(globalThis.location.hash.replace(/^#/, ''));
		const access_token = params.get('access_token');
		const refresh_token = params.get('refresh_token');

		if (access_token && refresh_token) {
			setStatus('verifying');
			fetch('/api/v1/auth/callback', {
				method: 'POST',
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify({ access_token, refresh_token }),
			})
				.then(async (r) => {
					console.log('1 -----', r);
					if (!r.ok) throw new Error((await r.json()).error?.message ?? 'Failed to set session');
					console.log('2 -----', r);
					setStatus('done');
					globalThis.location.href = '/onboarding';
				})
				.catch((e) => {
					console.log('error ------', e.message);
					setErr(e.message);
					setStatus('error');
				});
		} else {
			setStatus('awaiting');
		}
	}, []);

	return (
		<main class='mx-auto max-w-md p-6'>
			<h1 class='text-2xl font-semibold mb-4'>Verify your email</h1>

			{status === 'parsing' && <p>Preparing…</p>}
			{status === 'verifying' && <p>Signing you in…</p>}
			{status === 'done' && <p>Redirecting…</p>}

			{status === 'awaiting' && (
				<section>
					<p class='mb-3'>We’ve sent a verification link to your email. Click it to continue.</p>
					<p>{email}</p>
					<ResendButton email={email} />
				</section>
			)}

			{status === 'error' && (
				<section class='text-red-600'>
					<p class='mb-2'>We couldn’t verify your session.</p>
					<p class='mb-4 text-sm'>{err}</p>
					<a class='underline' href='/verify'>Try again</a>
				</section>
			)}
		</main>
	);
}

```

### File: apps\web\islands\pages\home\hero.tsx

```tsx
import '@styles/pages/home/hero.css';
import SearchBar from '@components/search/SearchBar.tsx';
import { IconChevronRight } from '@tabler/icons-preact';

export default function HomeHeroIsland() {
	return (
		<section id='hero' class='home__hero'>
			<div class='home__hero__bg'>
				<img
					class='home__hero__bg__image'
					src='https://images.unsplash.com/photo-1535957998253-26ae1ef29506?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=736'
				/>
			</div>
			<div class='home__hero__content'>
				<h1 class='home__hero__content__title'>
					Build Together.<br />Deliver Better.
				</h1>

				<div class='home__hero__content__search'>
					<SearchBar />
				</div>

				<div class='home__hero__content__actions'>
					<a class='home__hero__content__actions__join' href='#s'>
						<span>Start Creating</span>
						<IconChevronRight />
					</a>
					<a class='home__hero__content__actions__explore' href='#s'>
						<span>Explore</span>
						<IconChevronRight />
					</a>
				</div>
			</div>
		</section>
	);
}

```

### File: apps\web\islands\pages\public\explore.tsx

```tsx

```

### File: apps\web\islands\pages\public\search.tsx

```tsx
import '@styles/pages/public/explore/search.css';
import SearchBar from '@components/public/explore/SearchBar.tsx';
import { signal } from '@preact/signals';
import { IconLayout2Filled, IconList } from '@tabler/icons-preact';
import ExploreFilters from '@components/public/explore/Filters.tsx';

const showFilters = signal(true);
const displayType = signal(true);

export default function SearchIsland({ query }: { query: string }) {
	return (
		<div class='search-page'>
			<section class='search-page__search'>
				<h1 class='search-page__search__title'>{query}</h1>
				<div class='search-page__search__related'>
					<span>Related:</span>
				</div>
				<SearchBar />
			</section>
			<section class='search-page__options'>
				<div class='search-page__options__top'>
					<div class='search-page__options__toggle-filter'>
						<label for='search-page__options__toggle-filter'>
							<input
								type='checkbox'
								name='search-page__options__toggle-filter--toggle'
								id='search-page__options__toggle-filter'
								onInput={() => showFilters.value = !showFilters.value}
								checked={showFilters.value}
								hidden
							/>
							Filters
						</label>
					</div>
					<div class='search-page__options__categories'>
						<label>
							<input type='radio' value='work' name='search-page__options__categories' hidden />
							Work
						</label>
						<label>
							<input
								type='radio'
								value='resources'
								name='search-page__options__categories'
								hidden
							/>
							Resources
						</label>
						<label>
							<input type='radio' value='projects' name='search-page__options__categories' hidden />
							Projects
						</label>
					</div>
					<div class='search-page__options__sort'>
						<button type='button'>Sort</button>
					</div>
				</div>

				<div class='search-page__options__bottom'>
					<div class='search-page__options__results-count'>
						<p type='button'>Showing 472 results for "{query}" category</p>
					</div>
					<div class='search-page__options__category-type'>
						<label>
							<input
								type='radio'
								value='resources-templates'
								name='search-page__options__category-type'
								hidden
							/>
							Templates
						</label>
						<label>
							<input
								type='radio'
								value='resources-products'
								name='search-page__options__category-type'
								hidden
							/>
							Products
						</label>
						<label>
							<input
								type='radio'
								value='resources-articles'
								name='search-page__options__category-type'
								hidden
							/>
							Articles
						</label>
						<label>
							<input
								type='radio'
								value='resources-courses'
								name='search-page__options__category-type'
								hidden
							/>
							Courses
						</label>
					</div>
					<div class='search-page__options__layout'>
						<label for='search-page__options__layout--layout-list'>
							<input
								type='radio'
								value='layout-list'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-list'
								hidden
								checked={!displayType.value}
								onInput={() => displayType.value = false}
							/>
							<IconList />
						</label>
						<label for='search-page__options__layout--layout-grid'>
							<input
								type='radio'
								value='layout-grid'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-grid'
								hidden
								checked={displayType.value}
								onInput={() => displayType.value = true}
							/>
							<IconLayout2Filled />
						</label>
					</div>
				</div>
			</section>
			<div class='search-page__results'>
				{showFilters.value &&
					(
						<aside class='search-page__results__filters__container'>
							<ExploreFilters />
						</aside>
					)}
				<div class='search-page__results__content'>
					Search Results
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\main.ts

```ts
import { App, staticFiles } from 'fresh';
import { State } from './utils.ts';
import 'packages/backend/env.ts';

const app = new App<State>();

app.use(staticFiles());
app.fsRoutes();

export { app };

```

### File: apps\web\routes\(auth)\forgot-password.tsx

```tsx

```

### File: apps\web\routes\(auth)\login.tsx

```tsx
import { Head } from 'fresh/runtime';
import LoginIsland from '@islands/pages/auth/Login.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Login</title>
			</Head>

			<LoginIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\onboarding\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import OnboardingIsland from '@islands/pages/auth/Onboarding.tsx';

export default function Onboarding() {
	return (
		<>
			<Head>
				<title>Onboarding</title>
			</Head>

			<OnboardingIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\register.tsx

```tsx
import { Head } from 'fresh/runtime';
import RegisterIsland from '@islands/pages/auth/Register.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Sign Up</title>
			</Head>

			<RegisterIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\reset\[token].tsx

```tsx

```

### File: apps\web\routes\(auth)\verify\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import VerifyIsland from '@islands/pages/auth/Verify.tsx';
import { State } from '@utils';
import { getCookies } from '@std/http/cookie';
import { RenderableProps } from 'preact';
import { PageProps } from 'fresh';

// deno-lint-ignore no-explicit-any
export default function Verify(ctx: RenderableProps<PageProps<never, State>, any>) {
	const cookies = getCookies(ctx.req.headers);
	const email = cookies['verify_email'] ? decodeURIComponent(cookies['verify_email']) : undefined;

	return (
		<>
			<Head>
				<title>Verify</title>
			</Head>

			<VerifyIsland email={email} />
		</>
	);
}

```

### File: apps\web\routes\(auth)\_layout.tsx

```tsx
import { define } from '@utils';
import AuthLayout from '@islands/pages/auth/authLayout.tsx';

export default define.layout(function App(props) {
	const { Component } = props;

	return (
		<AuthLayout>
			<Component />
		</AuthLayout>
	);
});

```

### File: apps\web\routes\(auth)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/dashboard',
			},
		});
	}

	if (ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(dashboard)\dashboard\index.tsx

```tsx
export default function Dashboard() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\earnings\index.tsx

```tsx
export default function Earnings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\messages\index.tsx

```tsx
export default function Messages() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\projects\index.tsx

```tsx
export default function Projects() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\settings\index.tsx

```tsx
export default function Settings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\teams\index.tsx

```tsx
export default function Teams() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\(dashboard)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (!ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/login',
			},
		});
	}

	if (!ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(public)\(index)\index.tsx

```tsx
import '@styles/pages/home/home.css';
import HomeHeroIsland from '@islands/pages/home/hero.tsx';

export default function Home() {
	return (
		<div class='home'>
			<HomeHeroIsland />
		</div>
	);
}

```

### File: apps\web\routes\(public)\about.tsx

```tsx

```

### File: apps\web\routes\(public)\explore\index.tsx

```tsx
export default function Explore() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\explore\search\[query].tsx

```tsx
import { RenderableProps } from 'preact/src/index.d.ts';
import { PageProps } from 'https://jsr.io/@fresh/core/2.2.0/src/render.ts';
import { State } from '@utils';
import SearchIsland from '@islands/pages/public/search.tsx';

export default function Search(ctx: RenderableProps<PageProps<never, State>, any>) {
	ctx.params.query;
	console.log(ctx.params.query);

	return (
		<div class='search-page__container'>
			<SearchIsland query={ctx.params.query} />
		</div>
	);
}

```

### File: apps\web\routes\(public)\explore\[...path].tsx

```tsx
export default function ExploreItem() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\help\index.tsx

```tsx

```

### File: apps\web\routes\(public)\help\[...path].tsx

```tsx

```

### File: apps\web\routes\(public)\privacy.tsx

```tsx

```

### File: apps\web\routes\(public)\terms.tsx

```tsx

```

### File: apps\web\routes\(public)\[user]\index.tsx

```tsx

```

### File: apps\web\routes\(public)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\api\test\test.ts

```ts
import { define } from '@utils';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async GET(ctx) {
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setCookie(headers, {
			name: 'verify_email',
			value: 'email@email.com',
			path: '/verify',
			maxAge: 10000,
			httpOnly: true,
			sameSite: 'Lax',
			secure: true,
		});

		return new Response(null, {
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\callback.ts

```ts
import { define } from '@utils';
import { setAuthCookies } from '@backend';

export const handler = define.handlers({
	async POST(ctx) {
		const reqUrl = new URL(ctx.req.url);
		const { access_token, refresh_token } = await ctx.req.json();
		if (!access_token || !refresh_token) {
			return new Response(
				JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
				{
					status: 400,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: access_token,
			refreshToken: refresh_token,
			requestUrl: reqUrl,
		});
		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\email\login.ts

```ts
import { define } from '@utils';
import { loginWithEmail } from '@server/auth/email/login.ts';
import { setCookie } from '@std/http/cookie';
import { setAuthCookies } from '@backend';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await loginWithEmail(body);

		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		// IMPORTANT: keep a single Headers instance and append cookies to it.
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 401);
			return new Response(JSON.stringify({ error: res.error }), { status, headers });
		}

		// If the user isn’t verified, set a short-lived helper cookie and tell the client to go to /verify.
		const user = res.data.user;
		const unverified = user && !(user.email_confirmed_at ?? user.confirmed_at);

		if (unverified) {
			const email = user.email ?? (typeof body?.email === 'string' ? body.email : '');
			if (email) {
				setCookie(headers, {
					name: 'verify_email',
					value: encodeURIComponent(email),
					httpOnly: true,
					sameSite: 'Lax',
					secure: reqUrl.protocol === 'https:',
					path: '/verify',
					maxAge: 10 * 60,
				});
			}
			// Don’t replace headers—reuse the same instance so previously appended Set-Cookie aren’t lost.
			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		// If we have a session, persist tokens via cookies (append both, plus CSRF).
		if (res.data.session) {
			const { access_token, refresh_token } = res.data.session;
			if (!access_token || !refresh_token) {
				return new Response(
					JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
					{
						status: 400,
						headers,
					},
				);
			}
			// Derive secure + naming from the request URL/host inside the helper.
			setAuthCookies(headers, {
				accessToken: access_token,
				refreshToken: refresh_token,
				requestUrl: reqUrl,
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/' }), {
			status: 200,
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\email\register.ts

```ts
import { define } from '@utils';
import { registerWithEmail } from '@server/auth/email/register.ts';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await registerWithEmail(body, {}, {});
		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 500);
			return new Response(JSON.stringify({ error: res.error }), {
				status,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		const email = res.data.user?.email ?? (typeof body?.email === 'string' ? body.email : '');

		const headers = new Headers({
			location: verifyUrl,
		});
		if (email) {
			setCookie(headers, {
				name: 'verify_email',
				value: encodeURIComponent(email),
				httpOnly: true,
				sameSite: 'Lax',
				secure: reqUrl.protocol === 'https:',
				path: '/verify',
				maxAge: 10 * 60,
			});

			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		return new Response(null, { status: 303, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-login.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'login', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-register.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'register', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\logout.ts

```ts

```

### File: apps\web\routes\api\v1\auth\me.ts

```ts
// apps/web/routes/api/v1/auth/me.ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';
import { getAuthCookies } from '@backend';

export const handler = define.handlers({
	async GET(ctx) {
		const { accessToken } = getAuthCookies(ctx.req);
		if (!accessToken) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		const sb = await supabaseClient(ctx.req);
		const { data: userRes, error: userErr } = await sb.auth.getUser();
		if (userErr || !userRes?.user) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		// Fetch public profile under RLS
		const { data: row } = await sb
			.from('org.users_public')
			.select(
				'user_id, display_name, avatar_url, active_profile_type, active_profile_id, active_team_id',
			)
			.eq('user_id', userRes.user.id)
			.single();

		const payload = row
			? {
				id: row.user_id as string,
				displayName: (row.display_name as string) ?? null,
				avatarUrl: (row.avatar_url as string) ?? null,
				activeProfileType: (row.active_profile_type as 'freelancer' | 'business' | null) ?? null,
				activeProfileId: (row.active_profile_id as string | null) ?? null,
				activeTeamId: (row.active_team_id as string | null) ?? null,
			}
			: {
				id: userRes.user.id,
				displayName: null,
				avatarUrl: null,
				activeProfileType: null,
				activeProfileId: null,
				activeTeamId: null,
			};

		return new Response(JSON.stringify({ user: payload }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\onboarding.ts

```ts
import { define } from '@utils';
import { onboarding } from '@server/auth/onboarding.ts';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await onboarding(body, {
			getClient: () => supabaseClient(ctx.req),
		});

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/dashboard' }), {
			status: 200,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\refresh.ts

```ts
// apps/web/routes/api/v1/auth/refresh.ts
import { define } from '@utils';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';
import { clearAuthCookies, setAuthCookies } from '@backend';

export const handler = define.handlers({
	async POST(ctx) {
		const url = new URL(ctx.req.url);
		const refreshed = await maybeRefreshFromRequest(ctx.req);

		if (!refreshed) {
			const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
			clearAuthCookies(headers, url);
			return new Response(JSON.stringify({ ok: false, error: { code: 'refresh_failed' } }), {
				status: 401,
				headers,
			});
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: refreshed.access,
			refreshToken: refreshed.refresh,
			requestUrl: url,
		});

		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\resend.ts

```ts
import { define } from '@utils';
import { resendVerificationEmail } from '@server/auth/resend.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const { email } = await ctx.req.json();
		const res = await resendVerificationEmail((email ?? '').trim().toLowerCase());

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\switch-profile.ts

```ts

```

### File: apps\web\routes\api\v1\auth\switch-team.ts

```ts

```

### File: apps\web\routes\api\v1\auth\user.ts

```ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async GET(ctx) {
		const sb = await supabaseClient(ctx.req);
		const { data, error } = await sb.auth.getUser();

		if (!error && data.user && data.user.user_metadata) {
			const user = data.user.user_metadata;
			const name = user.name.split(' ');
			const firstName = name[0];
			const lastName = name[name.length - 1];
			const username = user.user_name;

			return new Response(JSON.stringify({ firstName, lastName, username }), {
				status: 200,
			});
		}

		return new Response('', { status: 204 });
	},
});

```

### File: apps\web\routes\api\v1\meta\health.ts

```ts
import { define } from '@utils';
import { Config } from '@backend';

const startedAt = Date.now();

type HealthPayload = {
	status: 'ok';
	service: string;
	version: string;
	uptime_ms: number;
	started_at: string;
	commit?: string;
	env: 'development' | 'production' | 'test' | string;
};

function payload(): HealthPayload {
	const uptime = Math.max(0, Date.now() - startedAt);
	const env = Config.APP_ENV ? 'production' : 'development';
	return {
		status: 'ok',
		service: Deno.env.get('APP_NAME') ?? 'projective-api',
		version: Deno.env.get('APP_VERSION') ?? '0.0.0',
		uptime_ms: uptime,
		started_at: new Date(startedAt).toISOString(),
		commit: Deno.env.get('GIT_COMMIT') ?? undefined,
		env,
	};
}

export const handler = define.handlers({
	async GET() {
		return new Response(JSON.stringify(payload()), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},

	async HEAD() {
		return new Response(null, {
			status: 200,
			headers: { 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\_app.tsx

```tsx
import { Head } from 'fresh/runtime';
import { State } from '@utils';

export default function App(
	ctx: { Component: preact.ComponentType; stateTheme?: 'light' | 'dark'; state: State },
) {
	const initial = ctx.stateTheme ?? 'dark';

	return (
		<html lang='en' data-theme={initial}>
			<Head>
				<meta charSet='utf-8' />
				<meta name='viewport' content='width=device-width, initial-scale=1' />
				<meta
					name='description'
					content='Collaborative freelancing platform.'
				/>
				<title>Projective</title>
			</Head>
			<body data-onboarded={ctx.state.isOnboarded}>
				<main>
					<ctx.Component />
				</main>
			</body>
		</html>
	);
}

```

### File: apps\web\routes\_middleware.ts

```ts
// apps/web/routes/_middleware.ts
import { define } from '@utils';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';
import { isOnboarded } from '@server/auth/onboarding.ts';
import {
	clearAuthCookies,
	getAuthCookies,
	rateLimitByIP,
	setAuthCookies,
	verifyCsrf,
} from '@backend';

function jwtExp(token: string): number | null {
	try {
		const payload = token.split('.')[1];
		if (!payload) return null;
		const json = JSON.parse(
			new TextDecoder().decode(
				Uint8Array.from(
					atob(payload.replace(/-/g, '+').replace(/_/g, '/')),
					(c) => c.charCodeAt(0),
				),
			),
		);
		return typeof json.exp === 'number' ? json.exp : null;
	} catch {
		return null;
	}
}

const middleware1 = define.middleware(async (ctx) => {
	const req = ctx.req;
	const url = new URL(req.url);
	const path = url.pathname;

	const { accessToken, refreshToken } = getAuthCookies(req);
	const now = Math.floor(Date.now() / 1000);
	const skew = 60;

	const ip = (req.headers.get('x-forwarded-for') ?? '127.0.0.1').split(',')[0];
	const { allowed } = rateLimitByIP(ip);
	if (!allowed) return new Response('Too Many Requests', { status: 429 });

	ctx.state.isAuthenticated = !!accessToken;

	if (!ctx.state.isAuthenticated) {
		ctx.state.isOnboarded = false;
	}

	// Decide if we should refresh
	let shouldRefresh = false;
	if (refreshToken) {
		if (!accessToken) shouldRefresh = true;
		else {
			const exp = jwtExp(accessToken);
			if (!exp || exp <= now + skew) shouldRefresh = true;
		}
	}

	// Use ctx.state fields (OK), do NOT reassign ctx.state
	ctx.state.refreshedTokens = null;
	ctx.state.clearAuth = false;

	if (shouldRefresh) {
		const refreshed = await maybeRefreshFromRequest(req);
		if (refreshed) {
			ctx.state.refreshedTokens = refreshed;
		} else {
			ctx.state.clearAuth = true;
		}
	}

	// CSRF for cookie-auth state-changing requests (skip if Authorization: Bearer present)
	const isStateChanging = ['POST', 'PUT', 'PATCH', 'DELETE'].includes(req.method.toUpperCase());
	const hasBearer = !!req.headers.get('authorization')?.startsWith('Bearer ');
	if (isStateChanging && !hasBearer && (accessToken || ctx.state.refreshedTokens)) {
		if (!verifyCsrf(req)) {
			return new Response(
				JSON.stringify({ error: { code: 'csrf_failed', message: 'CSRF check failed' } }),
				{ status: 403, headers: { 'content-type': 'application/json; charset=utf-8' } },
			);
		}
	}

	// Always allow /verify
	if (path.startsWith('/verify')) {
		const res = await ctx.next();
		if (ctx.state.refreshedTokens) {
			const { access, refresh } = ctx.state.refreshedTokens;
			setAuthCookies(res.headers, {
				accessToken: access,
				refreshToken: refresh,
				requestUrl: url,
			});
		}
		if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);
		return res;
	}

	const res = await ctx.next();

	if (ctx.state.refreshedTokens) {
		const { access, refresh } = ctx.state.refreshedTokens;
		setAuthCookies(res.headers, {
			accessToken: access,
			refreshToken: refresh,
			requestUrl: url,
		});
	}
	if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);

	return res;
});

const middleware2 = define.middleware(async (ctx) => {
	if (ctx.state.isAuthenticated && !ctx.state.isOnboarded) {
		ctx.state.isOnboarded = await isOnboarded(ctx.req);
	}

	return await ctx.next();
});

export default [middleware1, middleware2];

```

### File: apps\web\server\auth\claims.ts

```ts
export type JwtClaims = {
	sub: string;
	exp?: number;
	active_profile_type?: 'freelancer' | 'business';
	active_profile_id?: string;
	active_team_id?: string | null;
} | null;

export function parseJwt(token?: string): JwtClaims {
	if (!token) return null;
	try {
		const [, b64] = token.split('.');
		if (!b64) return null;
		const json = atob(b64.replace(/-/g, '+').replace(/_/g, '/'));
		return JSON.parse(json);
	} catch {
		return null;
	}
}

export function isExpired(exp?: number, skewSec = 30) {
	if (!exp) return true;
	return exp <= Math.floor(Date.now() / 1000) + skewSec;
}

```

### File: apps\web\server\auth\email\login.ts

```ts
import { LoginWithEmailRequest } from "@contracts/auth/login.ts";
import { supabaseClient } from "../../core/clients/supabase.ts";
import { fail, ok, Result } from "../../core/http/result.ts";
import { isLikelyEmail } from "../../core/validation/email.ts";
import { Deps, SignInData } from "../_shared/types.ts";
import {
	normaliseSupabaseError,
	normaliseUnknownError,
} from "../../core/errors/normalise.ts";
import { Config } from "@backend";

export async function loginWithEmail(
	{ email, password }: LoginWithEmailRequest,
	deps: Deps = {},
): Promise<Result<SignInData>> {
	const e = (email ?? "").trim().toLowerCase();
	const p = (password ?? "").trim();

	if (!e || !p) {
		return fail("bad_request", "Email and password are required.", 400);
	}
	if (!isLikelyEmail(e)) {
		return fail("bad_request", "Invalid email format.", 400);
	}

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signInWithPassword({
			email: e,
			password: p,
		});

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\email\register.ts

```ts
import { RegisterWithEmailRequest } from '@contracts/auth/register.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';
import { Deps, RegisterOptions, SignUpData } from '../_shared/types.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';
import { Config } from '@backend';

export async function registerWithEmail(
	{ email, password }: RegisterWithEmailRequest,
	deps: Deps = {},
	opts: RegisterOptions = {},
): Promise<Result<SignUpData>> {
	const e = (email ?? '').trim().toLowerCase();
	const p = (password ?? '').trim();

	if (!e || !p) return fail('bad_request', 'Email and password are required.', 400);
	if (!isLikelyEmail(e)) return fail('bad_request', 'Invalid email format.', 400);
	if (p.length < 8) return fail('bad_request', 'Password must be at least 8 characters.', 400);

	try {
		const emailRedirectTo = `${Config.BASE_URL}/verify`;
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signUp({
			email: e,
			password: p,
			options: {
				data: opts.metadata,
				emailRedirectTo,
				captchaToken: opts.captchaToken,
			},
		});

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\finalise-login.ts

```ts

```

### File: apps\web\server\auth\oauth.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';

export type OAuthProvider = 'google' | 'github';
export type OAuthIntent = 'login' | 'register';

export async function getProviderRedirectUrl(
	provider: OAuthProvider,
	intent: OAuthIntent,
	requestUrl: URL,
	next = '/',
): Promise<string> {
	const verifyUrl = new URL('/verify', requestUrl);
	if (next && next !== '/') {
		verifyUrl.searchParams.set('next', next);
	}
	verifyUrl.searchParams.set('intent', intent);

	const sb = await supabaseClient();
	const { data, error } = await sb.auth.signInWithOAuth({
		provider,
		options: {
			redirectTo: verifyUrl.toString(),
			skipBrowserRedirect: true,
		} as any,
	});

	console.log({ provider, url: data?.url }, error);

	if (error || !data?.url) {
		throw new Error(error?.message || 'OAuth init failed');
	}
	return data.url;
}

```

### File: apps\web\server\auth\onboarding.ts

```ts
// server/auth/onboarding.ts
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { Deps, SignInData } from './_shared/types.ts';
import { fail, ok, Result } from '../core/http/result.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { supabaseClient } from '../core/clients/supabase.ts';

export async function onboarding(
	{
		firstName,
		lastName,
		username,
		type,
	}: OnboardingRequest,
	deps: Deps = {},
): Promise<Result<any>> {
	if (!firstName || !username) {
		return fail('bad_request', 'First name and username are required.', 400);
	}

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		// Make sure we actually have an authenticated user
		const { data, error: authError } = await supabase.auth.getUser();
		if (authError || !data.user) {
			return fail('unauthorized', 'You must be signed in to onboard.', 401);
		}

		const userId = data.user.id;

		// Insert public profile
		const { error: userError } = await supabase
			.schema('org')
			.from('users_public')
			.insert({
				user_id: userId,
				first_name: firstName,
				last_name: lastName,
				username,
			});

		if (userError) {
			const n = normaliseSupabaseError(userError);
			return fail(n.code, n.message, n.status);
		}

		// Optionally create freelancer profile
		if (type === 'freelancer') {
			const { error: freelancerError } = await supabase
				.schema('org')
				.from('freelancer_profiles')
				.insert({
					user_id: userId, // <- use the same authenticated user
				});

			if (freelancerError) {
				const n = normaliseSupabaseError(freelancerError);
				return fail(n.code, n.message, n.status);
			}
		}

		return ok<any>({}); // TODO: return whatever you actually need
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

export async function isOnboarded(req: Request) {
	const supabase = await supabaseClient(req);
	const { data, error } = await supabase.auth.getUser();

	if (error || !data.user.id) {
		return false;
	}

	const { data: userData } = await supabase.schema('org').from('users_public').select('user_id').eq(
		'user_id',
		data.user.id,
	);

	if (userData) {
		return true;
	}

	return false;
}

```

### File: apps\web\server\auth\refresh.ts

```ts
import { getAuthCookies } from '@backend';
import { supabaseClient } from '../core/clients/supabase.ts';

type RefreshResult = { access: string; refresh: string } | null;

export async function refreshWithToken(refreshToken: string): Promise<RefreshResult> {
	const sb = await supabaseClient();
	const { data, error } = await sb.auth.refreshSession({ refresh_token: refreshToken });

	if (error || !data?.session?.access_token || !data?.session?.refresh_token) {
		return null;
	}
	return {
		access: data.session.access_token,
		refresh: data.session.refresh_token,
	};
}

export async function maybeRefreshFromRequest(req: Request): Promise<RefreshResult> {
	const { refreshToken } = getAuthCookies(req);
	if (!refreshToken) return null;
	return await refreshWithToken(refreshToken);
}

```

### File: apps\web\server\auth\resend.ts

```ts
import { Config } from '@backend';
import { supabaseClient } from '../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { fail, ok, Result } from '../core/http/result.ts';

export async function resendVerificationEmail(email: string): Promise<Result<{ sent: true }>> {
	if (!email) return fail('bad_request', 'Email is required.', 400);
	try {
		const emailRedirectTo = `${Config.BASE_URL}/verify`;
		const supabase = await supabaseClient();
		const { error } = await supabase.auth.resend({
			type: 'signup',
			email,
			options: {
				emailRedirectTo,
			},
		});
		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}
		return ok({ sent: true });
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\session-context-service.ts

```ts

```

### File: apps\web\server\auth\_shared\types.ts

```ts
import type { AuthResponse, AuthTokenResponsePassword, SupabaseClient } from 'supabaseClient';

export type SignUpData = AuthResponse['data'];

export type SignInData = AuthTokenResponsePassword['data'];

export type Deps = {
	getClient?: () => Promise<SupabaseClient>;
};

export type RegisterOptions = {
	emailRedirectTo?: string;
	captchaToken?: string;
	metadata?: Record<string, unknown>;
};

```

### File: apps\web\server\core\clients\supabase.ts

```ts
import { createClient, type SupabaseClient, type SupabaseClientOptions } from 'supabaseClient';
import { Config, getAuthCookies } from '@backend';

let anonClient: SupabaseClient /*<Database>*/ | null = null;

function getEnv() {
	const SUPABASE_URL = Config.SUPABASE_URL;
	const ANON_KEY = Config.SUPABASE_SERVICE_ROLE_KEY;
	if (!SUPABASE_URL || !ANON_KEY) throw new Error('Missing SUPABASE_URL or SUPABASE_ANON_KEY');
	return { SUPABASE_URL, ANON_KEY };
}

/**
 * Returns a Supabase client:
 * - If `req` contains an access token cookie, a **new per-request client** with `Authorization: Bearer <token>`.
 * - Otherwise, a **shared anon client** (cached).
 *
 * No session persistence; SSR-safe.
 */
export async function supabaseClient(req?: Request): Promise<SupabaseClient> {
	const { SUPABASE_URL, ANON_KEY } = getEnv();

	const baseOptions: SupabaseClientOptions<'public'> = {
		auth: {
			persistSession: false,
			detectSessionInUrl: false,
		},
	};

	if (req) {
		const { accessToken } = getAuthCookies(req);
		if (accessToken) {
			return createClient(SUPABASE_URL, ANON_KEY, {
				...baseOptions,
				global: {
					headers: {
						Authorization: `Bearer ${accessToken}`,
					},
				},
			});
		}
	}

	if (!anonClient) {
		anonClient = createClient(SUPABASE_URL, ANON_KEY, baseOptions);
	}
	return anonClient;
}

```

### File: apps\web\server\core\errors\normalise.ts

```ts
export function normaliseSupabaseError(error: unknown): {
	code: string;
	message: string;
	status?: number;
} {
	const e = error as { code?: string; message?: string; status?: number };
	const raw = (e.code ?? '').toLowerCase();

	if (raw.includes('rate') || e.status === 429) {
		return {
			code: 'rate_limit',
			message: e.message ?? 'Too many attempts. Please try later.',
			status: 429,
		};
	}
	if (raw.includes('user') && raw.includes('exists')) {
		return { code: 'user_exists', message: e.message ?? 'User already exists.', status: 409 };
	}
	if ((raw.includes('invalid') && raw.includes('credentials')) || e.status === 401) {
		return {
			code: 'invalid_credentials',
			message: e.message ?? 'Invalid email or password.',
			status: 401,
		};
	}
	if (raw === 'signup_failed' || raw === 'invalid_signup' || e.status === 400) {
		return {
			code: 'signup_failed',
			message: e.message ?? 'Sign up failed.',
			status: e.status ?? 400,
		};
	}

	return { code: raw || 'auth_error', message: e.message ?? 'Authentication error.' };
}

export function normaliseUnknownError(err: unknown): {
	code: string;
	message: string;
} {
	if (err && typeof err === 'object') {
		const anyErr = err as { name?: string; message?: string };
		const name = (anyErr.name ?? '').toLowerCase();
		const message = anyErr.message ?? 'Unknown error';
		if (name === '' || name === 'error') {
			return { code: 'unknown_error', message };
		}
		return { code: name, message };
	}
	return { code: 'unknown_error', message: 'Unknown error' };
}

```

### File: apps\web\server\core\http\result.ts

```ts
export type Ok<T> = { ok: true; data: T };
export type Fail = { ok: false; error: { code: string; message: string; status?: number } };
export type Result<T> = Ok<T> | Fail;

export function ok<T>(data: T): Ok<T> {
	return { ok: true, data };
}
export function fail(code: string, message: string, status?: number): Fail {
	return { ok: false, error: { code, message, status } };
}

```

### File: apps\web\server\core\validation\email.ts

```ts
export function isLikelyEmail(s: string): boolean {
	if (!s || !s.includes('@')) return false;
	const [, domain = ''] = s.split('@');
	return domain.includes('.') && !/\s/.test(s);
}

```

### File: apps\web\server\middleware\auth\verify_guard.ts

```ts
import { Deps, SignInData } from '../../auth/_shared/types.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';

export async function loginWithEmail(email: string, deps: Deps = {}): Promise<any> {
	const e = (email ?? '').trim().toLowerCase();

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.get({ email: e, password: p });

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\middleware\auth_guard.ts

```ts

```

### File: apps\web\styles\components\auth\login-button.css

```css
.login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  background-color: black;
  color: white;
  border-radius: var(--border-radius__large);

  &:disabled {
    background-color: red;
  }
}

```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-1.css

```css
.onboarding-stage-1 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;

    .onboarding-stage-1__account-type__container {
        display: flex;
        gap: 0.75em;
        width: 100%;

        .onboarding-stage-1__account-type {
            width: 100%;
            background-color: #fff5;
            color: var(--primary);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--fast);

            &:hover {
                background-color: #fff4;
            }

            &:has(input:checked) {
                background-color: #000;
                color: white;
                font-weight: bold;
            }
        }
    }

    .onboarding-stage-1__separator {
        width: 100%;
        border: 1px solid #fff3;
    }

    .onboarding-stage-1__name {
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 0.75em;
    }
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-2.css

```css
.onboarding-stage-2 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-3.css

```css

```

### File: apps\web\styles\components\auth\provider-login-button.css

```css
.provider-login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  border: 1px solid hsla(0, 100%, 100%, 0.2);
  color: white;
  border-radius: var(--border-radius__large);
}

```

### File: apps\web\styles\components\fields\DropdownField.css

```css
.dropdown-field__container {
  width: 100%;
  position: relative;
}

.dropdown-field__input {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  border-radius: var(--border-radius);
  box-shadow: inset 0 3px 6px #0004;
  background-color: #fff;
  /* outline: 1px solid #ccc; */
  position: relative;

  .dropdown-field__input__button {
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 0.25rem;

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input {
      width: 100%;
      height: 100%;
      padding: 0.4rem;
      text-align: left;
    }

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input::placeholder {
      color: var(--text-dark);
    }
  }

  &:has(.dropdown-field__input__selected) {
    .dropdown-field__input__button {
      padding: 0.25rem 0;

      .dropdown-field__input__button__span,
      .dropdown-field__input__button__input {
        padding: 0.4rem 0;
      }
    }
  }

  .dropdown-field__input__selected {
    height: 100%;
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 0.25rem;

    .dropdown-field__input__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: var(--border-radius);

      background-color: #fff;
      box-shadow: 0 2px 6px #0004;
      padding: 0.3rem 0.4rem;
      color: var(--text);

      .dropdown-field__input__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}


.dropdown-field__selected__container {
  width: 100%;
  display: flex;

  .dropdown-field__selected {
    position: relative;
    width: 100%;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
    border: 1px solid var(--card);
    border-radius: var(--border-radius);
    padding: 0.5rem;

    .dropdown-field__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: 2rem;

      background-color: var(--primary-half);
      padding: 0.2rem 0.5rem;
      color: white;
      font-size: 0.8rem;

      .dropdown-field__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}
```

### File: apps\web\styles\components\fields\FormStages.css

```css
.form-stages {
  display: flex;
  align-items: center;
  gap: 1em;

  .form-stages__item {
    display: flex;
    align-items: center;
    gap: 1em;
    position: relative;

    &[data-selected="true"] {
      font-weight: bold;

      .form-stages__item__container {

        opacity: 1;
      }
    }

    .form-stages__item__container {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.5;


      .form-stages__item__circle {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 4em;
        width: 4em;
        background-color: white;
        color: var(--primary);
        font-weight: bold;
        border-radius: 4em;

        p {
          padding: 0;
          margin: 0;
          font-size: 2em;
        }
      }

      .form-stages__item__name {
        font-size: 1;
        padding-top: 0.5em;
        margin: 0;
      }
    }

    .form-stages__item__divider {
      position: relative;
      width: 5em;
      border: 0.1em dashed white;
      top: -0.75em;
      opacity: 0.3;
    }
  }
}
```

### File: apps\web\styles\components\fields\TextField.css

```css
.text-field,
.password-field,
.text-area-field {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  background-color: hsla(0, 100%, 100%, 0.3);
  border-radius: var(--border-radius);

  * {
    stroke: var(--primary);
  }

  textarea,
  input {
    font-size: inherit;
    padding: 0.8em 1em;
    outline: none;
    border: none;
    background: none;
    width: 100%;

    &::placeholder {
      color: var(--primary);
    }
  }
}

.text-field__container {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-guest.css

```css
.header-container {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10rem;
}

.header__buttons {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-weight: bold;

  .header__buttons__user {
    padding: 0.4rem 2rem;
    border-radius: var(--border-radius);
    transition: background var(--medium), color var(--medium),
      border var(--medium);

    &.header__buttons__login {
      color: var(--primary);
      border: 1px solid var(--primary);

      &:hover {
        border: 1px solid var(--primary-highlight);
        color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }

    &.header__buttons__join {
      background-color: var(--primary);
      color: white;

      &:hover {
        background-color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-actions.css

```css
  .nav-bar-user__profile__dropdown__actions {
    display: flex;
    flex-direction: column;

    a {
      padding: 0.5em 1em;
      border-radius: var(--border-radius__small);
      cursor: pointer;

      &:hover {
        background-color: var(--button-hover);
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-business.css

```css
  .nav-bar-user__profile__dropdown__switch__business {
    width: 100%;
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-switch.css

```css
  .nav-bar-user__profile__dropdown__switch {
    display: flex;
    flex-direction: column;
    align-items: center;

    .nav-bar-user__profile__dropdown__switch__switch {
      display: flex;
      justify-content: space-evenly;
      width: 100%;

      .nav-bar-user__profile__dropdown__switch__label {
        cursor: pointer;

        &:has(input:checked) {
          color: var(--primary);
          font-weight: bold;
        }
      }
    }

    hr {
      width: 75%;
      border: 1px solid var(--text-dark);
    }

    .nav-bar-user__profile__dropdown__switch__account-type {
      width: 75%;

      .nav-bar-user__profile__dropdown__add {
        width: 100%;
        color: var(--button-hover-light);
        border: 1px solid var(--button-hover-light);
        padding: 0.5rem 0;
        border-radius: var(--border-radius__small);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 0.8em;

        &:hover {
          background-color: var(--button-hover);
          color: var(--text);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-teams.css

```css
.nav-bar-user__profile__dropdown__teams {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown.css

```css
  .nav-bar-user__profile__dropdown {
    position: absolute;
    top: var(--header-height);
    right: 0;
    background-color: var(--header);
    width: 400px;
    padding: 1em;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    border-radius: var(--border-radius__large);

    .nav-bar-user__profile__dropdown__current {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .nav-bar-user__profile__dropdown__current__profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;

        img {
          height: 4em;
          width: 4em;
          border-radius: 4em;
          border: 1px solid var(--text-dark);
        }

        p {
          margin: 0;
          padding: 0;
        }

        .nav-bar-user__profile__dropdown__current__profile__name {

          .nav-bar-user__profile__dropdown__current__profile__name__name {
            font-size: 1.5em;
            font-weight: 500;
          }

          .nav-bar-user__profile__dropdown__current__profile__name__username {
            font-size: 0.8em;
            color: var(--text-medium);
          }
        }
      }

      .nav-bar-user__profile__dropdown__current__switch {
        border-radius: var(--border-radius__small);
        height: 2rem;
        width: 2rem;

        display: flex;
        align-items: center;
        justify-content: center;

        svg * {
          stroke: var(--text-medium);
        }

        &:hover {
          background-color: var(--button-hover);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile.css

```css
.nav-bar-user__profile {
  position: relative;

  .nav-bar-user__profile__btn {
    height: 2.75rem;
    width: 2.75rem;
    min-height: 2.75rem;
    min-width: 2.75rem;
    max-height: 2.75rem;
    max-width: 2.75rem;
    border-radius: 4rem;

    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;

    .nav-bar-user__profile__btn__img {
      min-height: inherit;
      min-width: inherit;

      border: 1px solid var(--text-dark);
      border-radius: 4rem;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;

      img {
        min-height: inherit;
        min-width: inherit;
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-side.css

```css
.nav-bar-user-side {
  position: fixed;
  left: 1rem;
  top: calc(var(--header-height) + 1rem);
  width: var(--side-nav-width);
  height: calc(100% - var(--header-height) - 1rem);
  z-index: 1000;
  display: flex;

  .nav-bar-user-side__container {
    margin: 1rem 0;
    height: 100%;
    max-height: calc(100% - 4rem);
    width: 100%;
    background-color: var(--header);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    position: relative;
    border-radius: 1rem;
  }

  .nav-bar-user-side__group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    width: 100%;

    .nav-bar-user-side__app {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 2.5rem;

      &[data-selected="true"] {
        box-shadow: 0 0 12px var(--primary);
        background-color: var(--primary-half);
        outline: 1px solid var(--primary);
        color: white;
      }
    }
  }

  .nav-bar-user-side__open {
    position: absolute;
    left: 0.75rem;
    bottom: 1rem;
  }

  a,
  button {
    border-radius: var(--border-radius__small);
    height: 2.5rem;
    min-height: 2.5rem;
    width: 2.5rem;
    min-width: 2.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-dark);

    &:hover {
      background-color: var(--button-hover);
      color: var(--text-medium);
    }
  }

  hr {
    border: 1px solid var(--text-dark);
    width: 80%;
    opacity: 0.5;
  }

  &[data-sidebar-open='true'] {
    .nav-bar-user-side__app {
      justify-content: start !important;
      gap: 0.5rem !important;
      padding: 0 0.5rem !important;
      width: calc(100% - 1rem) !important;
    }

    [data-tooltip]::before {
      display: none;
    }

    [data-tooltip]:hover::before {
      display: none;
    }
  }

  &[data-sidebar-open='false'] {
    .nav-bar-user-side__app {
      justify-content: center !important;
      gap: 0 !important;
      padding: 0 !important;
      width: 100% !important;
    }

    [data-tooltip]::before {
      left: 100% !important;
      transform: translate(1rem, calc(-100% - 0.75rem));
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user.css

```css
.nav-bar-user {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1rem;

  .nav-bar-user__logo {
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;

    .nav-bar-user__logo__svg {
      height: 2rem;
      width: auto;
    }
  }

  .nav-bar-user__search {
    /* background-color: blue; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-bar-user__actions {
    /* background-color: green; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: right;
    gap: 1rem;
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar.css

```css
header {
  width: 100%;
  max-width: 100vw;
  height: var(--header-height);
  position: fixed;
  top: 0;
  left: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  padding-top: 1rem;
  z-index: 1000;

  nav {
    margin: 1rem;
    width: 100%;
    height: 100%;
    background-color: var(--header);

    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 1rem;
  }
}
```

### File: apps\web\styles\components\public\explore\filters.css

```css
.explore-filters {

}
```

### File: apps\web\styles\components\search\SearchBar.css

```css
.search-bar {
  display: flex;
  align-items: center;
  gap: 0.5em;
  width: 100%;
  border-radius: var(--border-radius);
  background-color: var(--card);

  .search-bar__input {
    width: 100%;
    background: none;
    font-size: 1.5em;
    padding: 0.75em;
    outline: none;
    border: none;
  }

  .search-bar__enter {
    margin-right: 0.75em;
    height: 3.5em;
    width: 3.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--primary);
    border-radius: var(--border-radius__small);
    color: white;
  }

  &:has(.search-bar__input:focus) {
    outline: 1px solid var(--primary);
  }
}

```

### File: apps\web\styles\layouts\auth.css

```css
:root {
  main {
    margin-top: 0 !important;
  }
}

.layout-auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  width: 100vw;
  position: relative;
  overflow: hidden;
}

.background {
  position: absolute;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  object-fit: cover;
  z-index: -1;
}

.layout-auth__modal {
  width: 90vw;
  height: 90vh;
  background-color: var(--primary);
  color: white;
  border-radius: 50px;
  display: flex;
  gap: 2rem;
  position: relative;

  .layout-auth__modal__window {
    position: relative;
    top: 10px;
    left: 10px;
    height: calc(100% - 20px);
    width: 40%;
    border-radius: 40px;
    overflow: hidden;
    background-color: white;

    img {
      position: absolute;
      top: calc(-5vh - 10px);
      left: calc(-5vw - 10px);
      height: 100vh;
      width: 100vw;
      object-fit: cover;
      filter: brightness(1.2) blur(10px);
    }

    .layout-auth__modal__window__content {
      position: relative;
      height: calc(100% - 8rem);
      width: calc(100% - 8rem);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: white;
      padding: 4rem;

      .layout-auth__modal__window__content__quote__line-container {
        display: flex;
        align-items: center;
        gap: 1rem;

        .layout-auth__modal__window__content__quote__line {
          height: 2px;
          width: 30%;
          background-color: white;
        }
      }

      .layout-auth__modal__window__content__slogan {
        .deliver-better {
          margin-left: 20%;
        }
      }

      h1 {
        padding: 0;
        margin: 0;
        font-size: 3rem;
      }

      p {
        font-size: 1.2rem;
      }
    }
  }

  .layout-auth__modal__content {
    width: 60%;
    height: 100%;
    margin-right: 2rem;
  }
}

```

### File: apps\web\styles\pages\auth\login.css

```css
.login {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .login__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .login__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .login__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }
}

.login__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .login__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .login__fields__options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;

      .remember-me {
        display: flex;
        align-items: center;
        gap: 0.5rem;

        input[type="checkbox"] {
          width: 1rem;
          height: 1rem;
        }
      }

      a {
        color: white;
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }
    }
  }
}

.login__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}

```

### File: apps\web\styles\pages\auth\onboarding.css

```css
.onboarding {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 85%;


    .onboarding-stages-indicator {
        font-size: 0.8rem;
    }

    .onboarding-stages {
        width: 60%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;

        .onboarding-stage {
            position: relative;
            width: 100%;
            top: -4rem;

            display: flex;
            flex-direction: column;
            gap: 0.75em;
            width: 100%;

            .onboarding-stage__account-type__container {
                display: flex;
                gap: 0.75em;
                width: 100%;

                .onboarding-stage__account-type {
                    width: 100%;
                    background-color: #fff5;
                    color: var(--primary);
                    border-radius: var(--border-radius);
                    padding: 1rem;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                    transition: background-color var(--fast);

                    &:hover {
                        background-color: #fff4;
                    }

                    &:has(input:checked) {
                        background-color: #000;
                        color: white;
                        font-weight: bold;
                    }
                }
            }

            .onboarding-stage__separator {
                width: 100%;
                border: 1px solid #fff3;
            }

            .onboarding-stage__name {
                width: 100%;
                display: flex;
                justify-content: space-between;
                gap: 0.75em;
            }
        }
    }

    .onboarding-stage-location {
        width: 60%;
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;

        .onboarding-back,
        .onboarding-submit,
        .onboarding-continue {
            width: 100%;
            background-color: #000;
            border-radius: var(--border-radius);
            padding: 1rem;

            &:hover {
                background-color: #222;

            }
        }
    }
}
```

### File: apps\web\styles\pages\auth\register.css

```css
.register {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .register__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .register__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .register__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }

  .register__field-error {
    font-size: 0.6em;
    color: red;
  }
}

.register__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .register__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .register__fields__name {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
  }
}

.register__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}
```

### File: apps\web\styles\pages\home\hero.css

```css
#hero {
  position: relative;
  height: 100%;
  width: 100%;

  &.home__hero {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    .home__hero__bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      /* background-color: red;  */

      .home__hero__bg__image {
        position: absolute;
        top: -1%;
        left: -1%;
        width: 102%;
        height: 102%;
        object-fit: cover;
        filter: brightness(0.5) blur(5px) saturate(0.8);
      }
    }

    .home__hero__content {
      display: flex;
      flex-direction: column;
      width: 75%;

      .home__hero__content__title {
        font-size: 4rem;
        color: white;
        font-weight: 600;
      }


      .home__hero__content__search {
        .search-bar {
          background-color: #202020;
          color: white;
        }
      }

      .home__hero__content__actions {
        display: flex;
        justify-content: center;
        gap: 1em;
        margin-top: 2em;

        a {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.4em 1.5em;
          padding-right: 0.75em;
          border-radius: 2em;
          font-size: 1.25em;
          font-weight: 500;
          gap: 1em;
        }

        .home__hero__content__actions__join {
          background-color: var(--primary);
          color: white;
        }

        .home__hero__content__actions__join:hover {
          background-color: var(--primary-hover);
          box-shadow: 0 0 8px var(--primary);
        }

        .home__hero__content__actions__explore {
          background-color: #fff3;
          border: 1px solid white;
          color: white;
        }

        .home__hero__content__actions__explore:hover {
          background-color: #fff5;
          box-shadow: 0 0 8px white;
        }
      }
    }
  }
}

/* #hero .home__hero__bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -1;
  overflow: hidden;
}

#hero .home__hero__bg__image {
  position: absolute;
  top: -1%;
  left: -1%;
  width: 102%;
  height: 102%;
  object-fit: cover;
  filter: brightness(0.5) blur(5px) saturate(0.8);
}

#hero .home__hero__content {
  display: flex;
  flex-direction: column;
  width: 100%;
}

#hero .home__hero__content__title {
  font-size: 4rem;
  color: white;
  font-weight: 600;
}

#hero .home__hero__content__search .search-bar {
  background-color: #202020;
  color: white;
}

#hero .home__hero__content__actions {
  display: flex;
  justify-content: center;
  gap: 1em;
  margin-top: 2em;
}

#hero .home__hero__content__actions a {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.4em 1.5em;
  padding-right: 0.75em;
  border-radius: 2em;
  font-size: 1.25em;
  font-weight: 500;
  gap: 1em;
}

#hero .home__hero__content__actions__join {
  background-color: var(--primary);
  color: white;
}

#hero .home__hero__content__actions__join:hover {
  background-color: var(--primary-hover);
  box-shadow: 0 0 8px var(--primary);
}

#hero .home__hero__content__actions__explore {
  background-color: #fff3;
  border: 1px solid white;
  color: white;
}

#hero .home__hero__content__actions__explore:hover {
  background-color: #fff5;
  box-shadow: 0 0 8px white;
} */
```

### File: apps\web\styles\pages\home\home.css

```css
.home {
    position: relative;
    padding: 0;
    margin: 0;

    height: calc(100% + (var(--header-height) + 1rem));
    width: calc(100% + (var(--side-nav-width) + 1rem));

    top: calc((var(--header-height) + 1rem) * -1);
    left: calc((var(--side-nav-width) + 1rem) * -1);
}
```

### File: apps\web\styles\pages\public\explore\search.css

```css
.search-page__container {
    display: flex;
    justify-content: center;
}

.search-page {
    width: 90%;

    .search-page__search {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;

        .search-page__search__title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .search-page__search__related {}

        .search-page__search__search-bar {}
    }

    .search-page__options {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 2rem;

        .search-page__options__top,
        .search-page__options__bottom {
            width: 100%;
            display: flex;
            align-items: space-between;
        }

        .search-page__options__results-count,
        .search-page__options__category-type,
        .search-page__options__layout,
        .search-page__options__categories,
        .search-page__options__sort,
        .search-page__options__toggle-filter {
            width: 100%;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .search-page__options__results-count,
        .search-page__options__toggle-filter {
            justify-content: left;
        }

        .search-page__options__category-type,
        .search-page__options__categories {
            justify-content: center;
        }

        .search-page__options__sort,
        .search-page__options__layout {
            justify-content: right;
        }

        .search-page__options__top {

            .search-page__options__sort button,
            .search-page__options__toggle-filter label {
                border: 1px solid var(--text-medium);
                color: var(--text);
                padding: 0.5em 2em;
                margin: 0;
                font-size: 1rem;
                cursor: pointer;
            }

            .search-page__options__sort * {
                border-radius: var(--border-radius);
            }

            .search-page__options__toggle-filter label {
                border-radius: 2em;
            }

            .search-page__options__categories {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    border-radius: 2rem;
                    text-align: center;
                    width: 6rem;
                    cursor: pointer;
                    color: var(--text-medium);
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        font-weight: bold;
                    }
                }
            }
        }

        .search-page__options__bottom {
            .search-page__options__layout {
                display: flex;
                gap: 0.5rem;

                label {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 0.5rem;
                    height: 2rem;
                    width: 2rem;
                    padding: 0.2rem;

                    background: none;
                    border-radius: var(--border-radius);

                    outline: 1px solid var(--text-medium);
                    color: var(--text-medium);

                    cursor: pointer;

                    &:has(input:checked) {
                        background: var(--primary);
                        color: white;
                        outline: none;
                    }
                }
            }

            .search-page__options__category-type {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    text-align: center;
                    margin: 0;
                    width: 6rem;

                    background: none;

                    border-top: 1px solid var(--card);
                    color: var(--text-medium);
                    cursor: pointer;
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                        border-top: 1px solid var(--bg);
                        border-radius: var(--border-radius);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        border-top: 1px solid var(--bg);
                        font-weight: bold;
                        border-radius: var(--border-radius);
                    }
                }
            }

            .search-page__options__results-count {
                p {
                    margin: 0;
                    padding: 0;
                    font-size: 0.8rem;
                    color: var(--text-medium);
                }
            }
        }
    }

    .search-page__results {
        display: flex;
        gap: 1rem;
        position: relative;

        .search-page__results__filters__container {
            width: 20vw;
            min-width: 20rem;
            min-height: 30rem;
            height: fit-content;
            position: sticky;
            background-color: var(--header);
            top: calc(var(--header-height) + 2rem);
            border-radius: var(--border-radius__large);
            padding: 2rem;

            /* .search-page__results__filters {
                width: 100%;
                height: fit-content;
                position: sticky;
                background-color: pink;
            } */
        }

        .search-page__results__content {
            background-color: blue;
            width: 100%;
            height: 200vh;
        }
    }
}
```

### File: apps\web\styles\styles.css

```css
@import "themes/light.css";
@import "themes/dark.css";

:root {
  --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
    "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  --font-dyslexia: "OpenDyslexic", Atkinson, var(--font-sans);

  --scale: 1;

  --primary-hue: 186;
  --primary-saturation: 57%;
  --primary-lightness: 36%;

  --primary: hsl(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness));
  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 60%);

  --primary-half: hsla(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness), 0.5);

  --header-height: 4rem;
  --side-nav-width: 0;

  --border-radius__xsmall: 4px;
  --border-radius__small: 6px;
  --border-radius: 8px;
  --border-radius__large: 12px;
  --border-radius__xlarge: 16px;

  --fast: 100ms;
  --medium: 200ms;
  --slow: 300ms;

  background-color: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);

  [data-sidebar-open] {
    --side-nav-width: 4rem;

  }

  [data-sidebar-open='true'] {
    --side-nav-width: 14rem;
  }
}

body {
  width: 100%;
  margin: 0;
  padding: 0;

  main {
    position: relative;
    margin: 0;
    padding: 0;
  }
}

.container {
  position: relative;
  height: calc(100vh - (var(--header-height) + 1rem));
  width: calc(100vw - (var(--side-nav-width) + 2.1rem));
  top: calc(var(--header-height) + 1rem);
  left: calc(var(--side-nav-width) + 1rem);
}

a {
  text-decoration: none;
  color: inherit;
  transition: all var(--fast);
}

input,
button {
  font-family: inherit;
  border: none;
  background: none;
  color: inherit;
  outline: none;
  border: none;
}

button {
  cursor: pointer;
  transition: all var(--fast);
}

[data-tooltip] {
  position: relative;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  top: calc(100% + 0.5rem);
  transform: translateX(-50%);
  color: var(--text-medium);
  background-color: var(--card);
  border: 1px solid var(--card-light);
  border-radius: var(--border-radius);
  padding: 0.25rem 1rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity var(--fast) ease;
  z-index: 100;
  font-size: 0.75rem;
}

[data-tooltip]:hover::before {
  opacity: 1;
}
```

### File: apps\web\styles\themes\dark.css

```css
:root[data-theme="dark"] {
  --bg: #222222;
  --header: #191919;
  --text: #ffffff;
  --text-medium: #999;
  --text-dark: #555555;
  --card: #303030;
  --card-dark: #202020;
  --card-light: #555555;
  --button-hover: #fff2;
  --button-hover-light: #fff6;

  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
  --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-highlight-active: hsl(var(--primary-hue),
      var(--primary-saturation),
      55%);
}
```

### File: apps\web\styles\themes\dim.css

```css

```

### File: apps\web\styles\themes\dyslexia.css

```css

```

### File: apps\web\styles\themes\high-contrast.css

```css

```

### File: apps\web\styles\themes\light.css

```css
:root {
    --bg: #f0f0f0;
    --header: #ffffff;
    --text: #000000;
    --text-medium: #999;
    --text-dark: #BBBBBB;
    --card: #dfdfdf;
    --card-dark: #202020;
    --card-light: #555555;
    --button-hover: #0002;
    --button-hover-light: #0006;

    --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
    --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
    --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
    --primary-highlight-active: hsl(var(--primary-hue),
            var(--primary-saturation),
            55%);
}
```

### File: apps\web\styles\themes\reduce-motion.css

```css

```

### File: apps\web\styles\themes\sepia.css

```css

```

### File: apps\web\tests\api\auth\login_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { loginWithEmail } from '../../../server/auth/email/login.ts';

type FakeAuthReturn =
	| { data: { user: unknown; session: unknown }; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>) {
	return {
		auth: {
			signInWithPassword: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: {
			signInWithPassword: (a: { email: string; password: string }) => Promise<FakeAuthReturn>;
		};
	};
}

Deno.test({
	name: 'loginWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await loginWithEmail({ email: 'nope', password: 'whatever' });
		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'loginWithEmail: invalid credentials -> 401',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Invalid login credentials', code: 'invalid_credentials', status: 401 },
		}));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'wrong' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'invalid_credentials');
		assertEquals(res.error.status, 401);
	},
});

Deno.test({
	name: 'loginWithEmail: success returns user+session',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const data = {
			user: { id: crypto.randomUUID(), email: 'a@example.com' },
			session: { access_token: 'token', expires_in: 3600 },
		};
		const client = fakeClient(async () => ({ data, error: null }));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data.user, data.user);
		assertEquals(res.data.session, data.session);
	},
});

```

### File: apps\web\tests\api\auth\register_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { registerWithEmail } from '../../../server/auth/email/register.ts';

type FakeAuthReturn =
	| { data: unknown; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(
	impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>,
) {
	return {
		auth: {
			signUp: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: { signUp: (a: { email: string; password: string }) => Promise<FakeAuthReturn> };
	};
}

Deno.test({
	name: 'registerWithEmail: missing email/password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: '', password: '' } as unknown as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'not-an-email', password: 'secret123!' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: short password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'a@example.com', password: 'short' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: propagates Supabase error (e.g., rate_limit 429)',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Email rate limit exceeded', code: 'rate_limit', status: 429 },
		}));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'rate_limit');
		assertEquals(res.error.status, 429);
	},
});

Deno.test({
	name: 'registerWithEmail: success returns ok and data',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const user = {
			user: { id: '00000000-0000-0000-0000-000000000000', email: 'a@example.com' },
			session: null,
		};
		const client = fakeClient(async () => ({ data: user, error: null }));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data, user as unknown);
	},
});

Deno.test({
	name: 'registerWithEmail: thrown error -> unknown_error',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{
				getClient: async () => {
					throw new Error('boom');
				},
			},
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'unknown_error');
	},
});

```

### File: apps\web\tests\api\meta\health.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import * as Health from '../../../routes/api/v1/meta/health.ts';

const GET = (Health as unknown as {
	GET?: (r: Request) => Promise<Response>;
	handler?: { GET: (r: Request) => Promise<Response> };
}).GET ??
	(Health as unknown as { handler?: { GET: (r: Request) => Promise<Response> } }).handler?.GET;

const HEAD = (Health as unknown as {
	HEAD?: (r: Request) => Promise<Response>;
	handler?: { HEAD: (r: Request) => Promise<Response> };
}).HEAD ??
	(Health as unknown as { handler?: { HEAD: (r: Request) => Promise<Response> } }).handler?.HEAD;

if (typeof GET !== 'function') {
	throw new Error('Health GET handler not found (expected export GET or handler.GET).');
}
if (typeof HEAD !== 'function') {
	throw new Error('Health HEAD handler not found (expected export HEAD or handler.HEAD).');
}

Deno.test({
	name: 'GET /api/v1/meta/health returns a valid payload',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'GET' });
		const res = await GET(req);

		assertEquals(res.status, 200);
		assert(res.headers.get('content-type')?.includes('application/json'));

		const json = await res.json() as {
			status: string;
			service: string;
			version: string;
			uptime_ms: number;
			started_at: string;
			commit?: string;
			env: string;
		};

		assertEquals(json.status, 'ok');
		assert(typeof json.service === 'string' && json.service.length > 0);
		assert(typeof json.version === 'string');
		assert(Number.isFinite(json.uptime_ms) && json.uptime_ms >= 0);
		assert(!Number.isNaN(Date.parse(json.started_at)));
		assert(typeof json.env === 'string');
	},
});

Deno.test({
	name: 'HEAD /api/v1/meta/health is fast and empty',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'HEAD' });
		const res = await HEAD(req);

		assertEquals(res.status, 200);
		const body = await res.text();
		assertEquals(body, '');
		assert(res.headers.get('cache-control')?.includes('no-store'));
	},
});

```

### File: apps\web\tests\unit\math.test.ts

```ts
import { assertEquals } from '../_helpers/asserts.ts';

Deno.test({
	name: 'add()',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	fn() {
		const add = (a: number, b: number) => a + b;
		assertEquals(add(2, 3), 5);
	},
});

```

### File: apps\web\tests\_helpers\asserts.ts

```ts
export { assert, assertEquals, assertMatch, assertRejects, assertStrictEquals } from '@std/assert';

export { restore, stub } from '@std/testing/mock';

```

### File: apps\web\tests\_helpers\request.ts

```ts
type HttpMethod = 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
type RouteHandler = (req: Request) => Promise<Response> | Response;

export async function call(handler: RouteHandler, init?: RequestInit) {
	const req = new Request('http://localhost/test', init);
	const res = await handler(req);
	const body = await res.text();
	const json = safeJson(body);
	return { res, body, json };
}

function safeJson(s: string) {
	try {
		return JSON.parse(s);
	} catch {
		return undefined;
	}
}

export function json(method: HttpMethod, data?: unknown, headers: HeadersInit = {}) {
	return {
		method,
		headers: { 'content-type': 'application/json', ...headers },
		body: data === undefined ? undefined : JSON.stringify(data),
	} satisfies RequestInit;
}

```

### File: apps\web\utils.ts

```ts
// apps/web/utils/index.ts
import { createDefine } from 'fresh';

// Per-request state (you can mutate its fields)
export interface State {
	shared?: string;

	// Auth middleware flags
	refreshedTokens?: { access: string; refresh: string } | null;
	clearAuth?: boolean;
	isAuthenticated?: boolean;
	isOnboarded?: boolean;
}

export const define = createDefine<State>();

```

### File: codebase_context.md

```md
# Project Codebase Context

## Project Tree

```text
apps/
web/
client.ts
components/
auth/
buttons/
fields/
navigation/
public/
search/
Theme.tsx
contracts/
account/
auth/
navigation.ts
public/
deno.json
islands/
NavBar.tsx
pages/
main.ts
routes/
(auth)/
(dashboard)/
(public)/
api/
_app.tsx
_middleware.ts
server/
auth/
core/
dashboard/
env.ts
middleware/
public/
static/
favicon.ico
logo.svg
styles/
components/
layouts/
pages/
styles.css
themes/
svg/
tests/
api/
unit/
_helpers/
types/
dashboard/
public/
utils.ts
codebase_context.md
db/
functions/
auth_project_or_dm_participant.sql
migrations/
0001_init_schemas.sql
0002_security_tables.sql
0003_org_tables.sql
0004_ops_tables.sql
0005_projects_tables.sql
0006_comms_tables.sql
0007_finance_tables.sql
0020_helpers_functions.sql
policies/
comms/
finance/
marketplace/
org/
business_profiles.sql
freelancer_profiles.sql
teams.sql
team_memberships.sql
users_public.sql
user_emails.sql
projects/
security/
audit_logs.sql
refresh_tokens.sql
session_context.sql
v_current_context.sql
storage/
scripts/
diff.sh
dump.sh
restore.sh
seeds/
views/
analytics_earnings_by_stage_mv.sql
security/
v_current_context.sql
deno.json
deno.lock
docs/
01_Vision.md
02_Features.md
03_TechStack.md
04_Roadmap.md
05_Security.md
06_InvestorSummary.md
07_UserStories.md
08_UserFlows.md
09_Tables.md
10_APIEndpints.md
11_Storage.md
12_RLS.md
13_FolderStructure.md
14_Sitemap.md
api/
README.md
architecture/
README.md
product/
README.md
uml.png
uml.svg
infra/
cf/
README.md
deno/
README.md
stripe/
README.md
LICENSE
packages/
backend/
auth/
jwt.ts
tokens.ts
config.ts
crypto.ts
deno.json
mod.ts
shared/
deno.json
mod.ts
types.ts
validation/
auth.ts
ui/
components/
deno.json
hooks/
mod.ts
providers/
README.md
themes/
utils/
ThemeSwitcher.ts
utils/
server/
cookies.ts
index.ts
rateLimiter.ts
wasm/
image_ops/
README.md
pack_project.ts
Projective Logo - White.png
Projective Logo.png
Projective Logo.svg
README.md
scripts/
dev.sh
setup.sh
test.sh
validate_names.ts
setup.ps1
supabase/
cli-latest
config/
README.md
edge-functions/
README.md
storage-rules/
README.md
testing.env.test
vite.config.ts
```

## File Contents

### File: apps\web\client.ts

```ts
import '@styles/styles.css';

```

### File: apps\web\components\auth\GitHubRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGithub } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/github/github-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGithub />
				{loading ? 'Connecting…' : 'Continue with GitHub'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleLoginButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleLoginButton({ redirectTo = '/' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-login?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\LoginButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { Signal } from '@preact/signals';

type Props = {
	redirectTo?: string;
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
};

export default function LoginButton({ redirectTo = '/', email, password }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/email/login', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: email, password: password }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Login success:', data);
				globalThis.location.href = data.redirectTo;
			} else {
				const c = await response.json();
				console.error('Login failed:', response);
				console.error('Login failed:', c.error.code);
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='login-button'
		>
			{loading ? 'Connecting…' : 'Log In'}
		</button>
	);
}

```

### File: apps\web\components\auth\OnboardingSubmit.tsx

```tsx
// apps/web/islands/auth/OnboardingSubmit.tsx
import { useCallback, useState } from 'preact/hooks';
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { getCsrfToken } from '@server/auth/cookies.ts';

export default function OnboardingSubmit({
	firstName,
	lastName,
	username,
	type,
}: OnboardingRequest) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const csrf = getCsrfToken();

			if (!csrf) {
				setLoading(false);
				return;
			}

			const response = await fetch('/api/v1/auth/onboarding', {
				method: 'POST',
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json',
					'X-CSRF': csrf,
				},
				body: JSON.stringify({ firstName, lastName, username, type }),
			});

			if (!response.ok) {
				const errorBody = await response.json().catch(() => null);
				console.error('Onboarding failed:', errorBody ?? response.statusText);
				return;
			}

			const data = await response.json();
			console.log('Onboarding success:', data);
			// globalThis.location.href = '/dashboard';
		} catch (err) {
			console.error('Onboarding error:', err);
		} finally {
			setLoading(false);
		}
	}, [loading, firstName, lastName, username, type]);

	return (
		<button
			type='button'
			class='onboarding-submit'
			onClick={handleClick}
			disabled={loading}
			aria-busy={loading}
			aria-label='Create Profile'
		>
			{loading ? 'Saving…' : 'Continue'}
		</button>
	);
}

```

### File: apps\web\components\auth\RegisterButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import RegisterWithEmail from 'packages/shared/validation/auth.ts';
import { computed, Signal } from '@preact/signals';

type Props = {
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
	confirmPassword: Signal<string | undefined>;
};

export default function RegisterButton({
	email,
	password,
	confirmPassword,
}: Props) {
	const [loading, setLoading] = useState(false);

	const hasErrors = computed(() => {
		const e = (email.value || '').trim();
		const p = (password.value || '').trim();
		const c = (confirmPassword.value || '').trim();

		const v = RegisterWithEmail.validate({
			email: e,
			password: p,
			confirmPassword: c,
		}).ok;

		return !v;
	});

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const e = (email.value || '').trim();
			const p = (password.value || '').trim();
			const c = (confirmPassword.value || '').trim();

			const { ok } = RegisterWithEmail.validate({
				email: e,
				password: p,
				confirmPassword: c,
			});

			if (!ok) return;

			const response = await fetch('/api/v1/auth/email/register', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: e, password: p }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Registration success:', data);
				globalThis.location.href = '/verify';
			} else {
				console.error('Registration failed:', response);
			}
		} finally {
			setLoading(false);
		}
	}, [loading, email, password, confirmPassword]);

	return (
		<button
			type='button'
			class='login-button'
			onClick={handleClick}
			disabled={hasErrors.value}
			aria-busy={loading}
			aria-label='Create account'
		>
			{loading ? 'Connecting…' : 'Create Account'}
		</button>
	);
}

```

### File: apps\web\components\auth\ResendButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';

type Props = {
	email: string | undefined;
};

export default function ResendButton({ email }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/resend', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email }),
			});

			if (response.ok) {
				const data = await response.json();
			} else {
				const c = await response.json();
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='verify-button'
		>
			Resend verification email
		</button>
	);
}

```

### File: apps\web\components\fields\DropdownField.tsx

```tsx
import '@styles/components/fields/DropdownField.css';
import { Icon, IconChevronDown, IconX } from '@tabler/icons-preact';
import { Signal } from '@preact/signals';

export interface IDropdownItem {
	icon?: Icon | string;
	value: string;
	displayName?: string;
	label?: string;
}

export interface IDropdownFieldOptions {
	multiselect?: boolean;
	searchable?: boolean;
}

export interface IDropdownField {
	values: IDropdownItem[];
	defaultValues?: IDropdownItem[];
	selected?: Signal<IDropdownItem[]>;
	placeholder?: string;
	name?: string;
	options?: IDropdownFieldOptions;
}

export default function DropdownField(
	{ values, placeholder, selected, name, defaultValues, options }: IDropdownField,
) {
	const testClick = () => {
		console.log('dropdown-field__button click');
	};

	const testClick2 = () => {
		console.log('dropdown-field__selected__item__close click');
	};

	return (
		<div class='dropdown-field__container'>
			<div class='dropdown-field__input'>
				{
					/* <div class='dropdown-field__input__selected'>
					<div class='dropdown-field__input__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__input__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div> */
				}

				<button type='button' class='dropdown-field__input__button' onClick={() => testClick()}>
					{options?.searchable
						? (
							<input
								type='text'
								class='dropdown-field__input__button__input'
								placeholder={placeholder}
							/>
						)
						: <span class='dropdown-field__input__button__span'>{placeholder}</span>}

					<IconChevronDown />
				</button>
			</div>

			<div class='dropdown-field__selected__container'>
				<div class='dropdown-field__selected'>
					<div class='dropdown-field__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\components\fields\DualSliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\FormStages.tsx

```tsx
import '@styles/components/fields/FormStages.css';

export interface IFormStages {
	stage: number;
	stages: string[];
}

export default function FormStages({ stage, stages }: IFormStages) {
	return (
		<div class='form-stages'>
			{stages.map((stg, index) => {
				return (
					<>
						<div class='form-stages__item' data-selected={stage === index + 1}>
							<div class='form-stages__item__container'>
								<div class='form-stages__item__circle'>
									<p>
										{index + 1}
									</p>
								</div>
								<p class='form-stages__item__name'>{stg}</p>
							</div>

							{index != stages.length - 1 &&
								<hr class='form-stages__item__divider' />}
						</div>
					</>
				);
			})}
		</div>
	);
}

```

### File: apps\web\components\fields\PasswordField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';
import { IconEye, IconEyeClosed } from '@tabler/icons-preact';
import { signal } from '@preact/signals';

const type = signal<boolean>(true);

export default function PasswordField(props: InputHTMLAttributes<HTMLInputElement>) {
	const toggleVisibility = () => {
		type.value = !type.value;
	};

	return (
		<span class='password-field'>
			<input type={type.value ? 'password' : 'text'} {...props} />
			<button
				type='button'
				onClick={toggleVisibility}
				class='password-field__toggle-visibility'
			>
				{type.value ? <IconEyeClosed /> : <IconEye />}
			</button>
		</span>
	);
}

```

### File: apps\web\components\fields\RatingField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\RichTextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null },
) {
	return (
		<div class='text-field__container'>
			<small>{props.error}</small>
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
		</div>
	);
}

```

### File: apps\web\components\fields\SliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextAreaField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextAreaField(
	props: InputHTMLAttributes<HTMLTextAreaElement> & {
		error?: string | null;
		field?: string | null;
	},
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-area-field'>
				<textarea {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarGuest.tsx

```tsx
import '@styles/components/navigation/nav-bar-guest.css';
import { theme } from '../../../../packages/ui/utils/ThemeSwitcher.ts';

export default function NavBarGuest() {
	const switchTheme = () => {
		if (theme.value === 'light') {
			theme.value = 'dark';
		} else {
			theme.value = 'light';
		}
	};

	return (
		<div class='header-container'>
			<div class='header__logo'>
				<h1>Projective</h1>
			</div>
			<div class='header__buttons'>
				<button type='button'>search</button>
				<button type='button' onClick={() => switchTheme()}>{theme.value}</button>
				<a href='#'>Explore</a>
				<a class='header__buttons__user header__buttons__login' href='/login'>Login</a>
				<a class='header__buttons__user header__buttons__join' href='/register'>Join</a>
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUser.tsx

```tsx
import '@styles/components/navigation/nav-bar-user.css';
import { IconBell } from '@tabler/icons-preact';
import NavBarUserProfile from './profile/NavBarUserProfile.tsx';

export default function NavBarUser() {
	return (
		<div class='nav-bar-user'>
			<div class='nav-bar-user__logo'>
				<img class='nav-bar-user__logo__svg' src='/logo.svg' alt='Logo' />
				<h1>Projective</h1>
			</div>
			<div class='nav-bar-user__search'>
				<h1>Logo</h1>
			</div>
			<div class='nav-bar-user__actions'>
				<IconBell />
				<NavBarUserProfile />
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUserSide.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-side.css';
import { apps } from '@contracts/navigation.ts';
import { IconLayoutSidebarLeftCollapse, IconLayoutSidebarLeftExpand } from '@tabler/icons-preact';
import { useEffect, useState } from 'preact/hooks';
import { signal } from '@preact/signals';

const open = signal(false);

export default function NavBarUserSide() {
	const navApps = apps;
	const [selected, setSelected] = useState('');

	useEffect(() => {
		const loc = globalThis.location.pathname.substring(1).split('/')[0];
		setSelected(`/${loc.trim()}`);
	}, [globalThis.location]);

	const handleButtonClick = (_: MouseEvent) => {
		open.value = !open.value;
	};

	return (
		<aside class='nav-bar-user-side' data-sidebar-open={open.value}>
			<nav class='nav-bar-user-side__container'>
				{navApps.map((group) => {
					return (
						<div class='nav-bar-user-side__group'>
							{group.map((app) => {
								return (
									<a
										class='nav-bar-user-side__app'
										href={app.link}
										data-selected={selected === app.link}
										data-tooltip={app.name}
									>
										<app.icon />
										{open.value && <span>{app.name}</span>}
									</a>
								);
							})}
							<hr />
						</div>
					);
				})}
				<button type='button' class='nav-bar-user-side__open' onClick={handleButtonClick}>
					{open.value ? <IconLayoutSidebarLeftCollapse /> : <IconLayoutSidebarLeftExpand />}
				</button>
			</nav>
		</aside>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfile.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile.css';
import NavBarUserProfileDropdown from './NavBarUserProfileDropdown.tsx';
import { signal } from '@preact/signals';
import { useEffect, useRef } from 'preact/hooks';

const open = signal(false);

export default function NavBarUserProfile() {
	const rootRef = useRef<HTMLDivElement | null>(null);

	useEffect(() => {
		const handleClickOutside = (event: MouseEvent) => {
			const root = rootRef.current;
			if (!root) return;
			if (root.contains(event.target as Node)) return;
			open.value = false;
		};

		document.addEventListener('click', handleClickOutside);
		return () => {
			document.removeEventListener('click', handleClickOutside);
		};
	}, []);

	const handleButtonClick = (event: MouseEvent) => {
		console.log('huh');
		event.stopPropagation();
		open.value = !open.value;
	};

	return (
		<div class='nav-bar-user__profile' ref={rootRef}>
			<button
				type='button'
				class='nav-bar-user__profile__btn'
				onClick={handleButtonClick}
			>
				<div class='nav-bar-user__profile__btn__img'>
					<img src='https://placehold.co/50x50' />
				</div>
			</button>

			{open.value && (
				<div
					class='nav-bar-user__profile__dropdown-wrapper'
					tabIndex={0}
					onClick={(event: MouseEvent) => event.stopPropagation()}
				>
					<NavBarUserProfileDropdown />
				</div>
			)}
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdown.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown.css';
import { IconArrowsLeftRight, IconUser } from '@tabler/icons-preact';
import NavBarUserProfileDropdownActions from './NavBarUserProfileDropdownActions.tsx';
import NavBarUserProfileDropdownSwitch from './NavBarUserProfileDropdownSwitch.tsx';
import { signal } from '@preact/signals';

const switchView = signal(true);

export default function NavBarUserProfileDropdown() {
	return (
		<div class='nav-bar-user__profile__dropdown'>
			<div class='nav-bar-user__profile__dropdown__current'>
				<div class='nav-bar-user__profile__dropdown__current__profile'>
					<img src='https://placehold.co/50x50' />
					<div class='nav-bar-user__profile__dropdown__current__profile__name'>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__name'>bla</p>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__username'>bla</p>
					</div>
				</div>
				<button
					type='button'
					class='nav-bar-user__profile__dropdown__current__switch'
					data-tooltip={switchView.value ? 'Switch Account' : 'Account Actions'}
					onClick={() => switchView.value = !switchView.value}
				>
					{switchView.value ? <IconArrowsLeftRight /> : <IconUser />}
				</button>
			</div>
			<div>
				{switchView.value
					? <NavBarUserProfileDropdownActions />
					: <NavBarUserProfileDropdownSwitch />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownActions.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-actions.css';

export default function NavBarUserProfileDropdownActions() {
	return (
		<div class='nav-bar-user__profile__dropdown__actions'>
			<a>Profile</a>
			<a>Log Out</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownBusiness.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-business.css';

export default function NavBarUserProfileDropdownBusiness() {
	return (
		<div class='nav-bar-user__profile__dropdown__business'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Business
			</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownSwitch.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-switch.css';
import { signal } from '@preact/signals';
import NavBarUserProfileDropdownTeams from './NavBarUserProfileDropdownTeams.tsx';
import NavBarUserProfileDropdownBusiness from './NavBarUserProfileDropdownBusiness.tsx';

const switchView = signal(false);

export default function NavBarUserProfileDropdownSwitch() {
	return (
		<div class='nav-bar-user__profile__dropdown__switch'>
			<div class='nav-bar-user__profile__dropdown__switch__switch'>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--teams'
						value='teams'
						onInput={() => switchView.value = false}
						checked={switchView.value == false}
						hidden
					/>
					Teams
				</label>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--business'
						value='business'
						onInput={() => switchView.value = true}
						checked={switchView.value == true}
						hidden
					/>
					Business
				</label>
			</div>
			<hr />
			<div class='nav-bar-user__profile__dropdown__switch__account-type'>
				{!switchView.value
					? <NavBarUserProfileDropdownTeams />
					: <NavBarUserProfileDropdownBusiness />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownTeams.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-teams.css';

export default function NavBarUserProfileDropdownTeams() {
	return (
		<div class='nav-bar-user__profile__dropdown__teams'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Team
			</a>
		</div>
	);
}

```

### File: apps\web\components\public\explore\Filters.tsx

```tsx
import '@styles/components/public/explore/filters.css';
import DropdownField from '../../fields/DropdownField.tsx';

export default function ExploreFilters() {
	return (
		<div class='explore-filters'>
			<DropdownField values={[]} placeholder='Skills' options={{ searchable: true }} />
		</div>
	);
}

```

### File: apps\web\components\public\explore\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\search\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\Theme.tsx

```tsx

```

### File: apps\web\contracts\auth\login.ts

```ts
export interface LoginWithEmailRequest {
	email: string;
	password: string;
}

```

### File: apps\web\contracts\auth\onboading.ts

```ts
export interface OnboardingRequest {
	firstName: string;
	lastName: string;
	username: string;
	type: 'freelancer' | 'client';
}

```

### File: apps\web\contracts\auth\register.ts

```ts
export interface RegisterWithEmailRequest {
	email: string;
	password: string;
}

export interface RegisterWithEmailResponse {
	data: {
		user: {
			id: string;
			aud: string;
			role: string;
			email: string;
			email_confirmed_at: string;
			phone: string;
			last_sign_in_at: string;
			app_metadata: {
				provider: string;
				providers: string[];
			};
			user_metadata: {};
			identities: [
				{
					identity_id: string;
					id: string;
					user_id: string;
					identity_data: {
						email: string;
						email_verified: string;
						phone_verified: string;
						sub: string;
					};
					provider: string;
					last_sign_in_at: string;
					created_at: string;
					updated_at: string;
					email: string;
				},
			];
			created_at: string;
			updated_at: string;
		};
		session: {
			access_token: string;
			token_type: string;
			expires_in: number;
			expires_at: number;
			refresh_token: string;
			user: {
				id: string;
				aud: string;
				role: string;
				email: string;
				email_confirmed_at: string;
				phone: string;
				last_sign_in_at: string;
				app_metadata: {
					provider: string;
					providers: string[];
				};
				user_metadata: {};
				identities: [
					{
						identity_id: string;
						id: string;
						user_id: string;
						identity_data: {
							email: string;
							email_verified: false;
							phone_verified: false;
							sub: string;
						};
						provider: string;
						last_sign_in_at: string;
						created_at: string;
						updated_at: string;
						email: string;
					},
				];
				created_at: string;
				updated_at: string;
			};
		};
	};
	error: string | null;
}

```

### File: apps\web\contracts\navigation.ts

```ts
import {
	Icon,
	IconBriefcase,
	IconBuilding,
	IconChartLine,
	IconCompass,
	IconHome,
	IconMessages,
	IconPlug,
	IconSettings,
	IconUsers,
	IconWallet,
} from '@tabler/icons-preact';

export interface INavApp {
	icon: Icon;
	name: string;
	link: string;
}

export const apps1: INavApp[] = [
	{
		icon: IconHome,
		name: 'Dashboard',
		link: '/dashboard',
	},
	{
		icon: IconCompass,
		name: 'Explore',
		link: '/explore',
	},
	{
		icon: IconMessages,
		name: 'Messages',
		link: '/messages',
	},
];

export const apps2: INavApp[] = [
	{
		icon: IconBriefcase,
		name: 'Projects',
		link: '/projects',
	},
	{
		icon: IconUsers,
		name: 'Teams',
		link: '/teams',
	},
	{
		icon: IconBuilding,
		name: 'Businesses',
		link: '/businesses',
	},
];

export const apps3: INavApp[] = [
	{
		icon: IconChartLine,
		name: 'Analytics',
		link: '/analytics',
	},
	{
		icon: IconWallet,
		name: 'Earnings',
		link: '/earnings',
	},
	{
		icon: IconSettings,
		name: 'Settings',
		link: '/settings',
	},
];

export const apps = [apps1, apps2, apps3];

```

### File: apps\web\contracts\public\IExploreCategories.ts

```ts
// packages/lib/search/explore/explore-categories.ts
// Explore-specific categories, subcategories, and sort options.

export type ExploreCategory = 'work' | 'resources' | 'projects';

export type ExploreSubcategory =
	| 'services'
	| 'freelancers'
	| 'teams'
	| 'templates'
	| 'products'
	| 'articles'
	| 'courses'
	| 'projects';

export type IExploreRequestSortBy =
	| 'recommended'
	| 'newest'
	| 'oldest'
	| 'mostPopular'
	| 'highestRated'
	| 'lowestRated'
	| 'priceLowToHigh'
	| 'priceHighToLow';

// Compile-time mapping from subcategory → category.
// This is purely a type-level mapping, no runtime code.
export type ExploreCategoryForSubcategory<S extends ExploreSubcategory> = S extends
	| 'services'
	| 'freelancers'
	| 'teams' ? 'work'
	: S extends 'projects' ? 'projects'
	: 'resources';

```

### File: apps\web\contracts\public\IExploreFacets.ts

```ts
// packages/lib/search/explore/explore-facets.ts
// Facet / aggregation models that you use to build filters from result sets.

export interface NumericFacet {
	min: number | null;
	max: number | null;
	avg?: number | null;
}

export interface TermFacetBucket {
	value: string;
	count: number;
}

export type TermFacet = TermFacetBucket[];

// Generic facets bag. You can extend this per endpoint if needed via generics.
export interface ExploreFacets {
	// money
	price?: NumericFacet;
	hourlyRate?: NumericFacet;
	budget?: NumericFacet;

	// common categorical facets
	languages?: TermFacet;
	skills?: TermFacet;
	countries?: TermFacet;
	timezones?: TermFacet;
	topics?: TermFacet;
	serviceCategories?: TermFacet;
	productTypes?: TermFacet;
	licenseTypes?: TermFacet;

	// allow extension without changing this file
	[key: string]: NumericFacet | TermFacet | undefined;
}

// Generic response wrapper for any explore endpoint.
export interface ExploreResponse<
	TItem,
	TFacets extends ExploreFacets = ExploreFacets,
> {
	items: TItem[];
	page: number;
	pageSize: number;
	total: number;
	facets: Partial<TFacets>;
}

```

### File: apps\web\contracts\public\IExploreFilters.ts

```ts
// packages/lib/search/explore/explore-filters.ts
// Explore-specific filter models (no request/response shapes here).

// ---- Filter atoms ----

export interface PriceRangeFilter {
	minPriceCents?: number;
	maxPriceCents?: number;
	currency?: string; // 'GBP', 'USD', etc.
}

export interface HourlyRateFilter {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	currency?: string;
}

export interface RatingFilter {
	minRating?: number; // 1–5
	maxRating?: number; // rarely used but available
}

export interface LocationFilter {
	countries?: string[]; // ISO codes or canonical names
	timezones?: string[]; // 'Europe/London', etc.
	remoteOnly?: boolean;
}

export interface LanguageFilter {
	languages?: string[]; // matches your text[] language fields
}

export interface SkillsFilter {
	skills?: string[]; // skill slugs/ids
	minSkillScore?: number; // optional if you ever store skill proficiency
}

export interface AvailabilityFilter {
	availability?:
		| 'immediate'
		| 'thisWeek'
		| 'nextWeek'
		| 'scheduled';
}

export interface MetaFilter {
	minCompletedProjects?: number;
	minSales?: number;
}

export interface BudgetRangeFilter {
	minBudgetCents?: number;
	maxBudgetCents?: number;
	currency?: string;
}

// ---- Work (services / freelancers / teams) ----

export interface WorkBaseFilters
	extends
		PriceRangeFilter,
		RatingFilter,
		LocationFilter,
		LanguageFilter,
		SkillsFilter,
		AvailabilityFilter,
		MetaFilter {
	topics?: string[]; // 'design', 'marketing', etc.
}

export interface ServicesFilters extends WorkBaseFilters {
	serviceCategoryIds?: string[]; // taxonomy table / search topics
	durationMinutesMax?: number; // for calls / sessions
}

export interface FreelancerFilters extends WorkBaseFilters {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	minPortfolioItems?: number;
}

export interface TeamFilters extends WorkBaseFilters {
	minTeamSize?: number;
	maxTeamSize?: number;
	requireMultipleRoles?: boolean;
}

// ---- Resources (templates / products / articles / courses) ----

export interface ResourceBaseFilters extends PriceRangeFilter, RatingFilter, LanguageFilter {
	topics?: string[];
	formats?: string[]; // 'figma', 'pdf', 'notion', 'video', etc.
}

export interface TemplatesFilters extends ResourceBaseFilters {
	templateType?: string[]; // 'landing-page', 'saas-ui', ...
	requiresCode?: boolean;
}

export interface ProductsFilters extends ResourceBaseFilters {
	productType?: string[]; // 'theme', 'component-library', etc.
	licenseType?: string[]; // 'full_rights', 'template_only', ...
	digitalOnly?: boolean;
}

export interface ArticlesFilters extends ResourceBaseFilters {
	readTimeMinutesMax?: number;
	publishedAfter?: string; // ISO date
	publishedBefore?: string; // ISO date
}

export interface CoursesFilters extends ResourceBaseFilters {
	level?: ('beginner' | 'intermediate' | 'advanced')[];
	minLessons?: number;
	maxLessons?: number;
}

// ---- Projects ----

export type ProjectStatus = 'draft' | 'active' | 'on_hold';

export interface ProjectsFilters extends BudgetRangeFilter, LocationFilter, LanguageFilter {
	status?: ProjectStatus[];
	stageTypes?: string[]; // filter by presence of certain stage types
}

```

### File: apps\web\contracts\public\IExploreRequest.ts

```ts
import {
	ExploreCategoryForSubcategory,
	ExploreSubcategory,
	IExploreRequestSortBy,
} from './IExploreCategories.ts';
import {
	ArticlesFilters,
	CoursesFilters,
	FreelancerFilters,
	ProductsFilters,
	ProjectsFilters,
	ServicesFilters,
	TeamFilters,
	TemplatesFilters,
} from './IExploreFilters.ts';
import { ISearchRequestWithSortAndFilter } from './ISearchRequest.ts';

// Text/semantic query shape, extendable later.
export interface ExploreQuery {
	term?: string;
}

// Mapping from subcategory → filters interface.
export interface ExploreFiltersBySubcategory {
	services: ServicesFilters;
	freelancers: FreelancerFilters;
	teams: TeamFilters;
	templates: TemplatesFilters;
	products: ProductsFilters;
	articles: ArticlesFilters;
	courses: CoursesFilters;
	projects: ProjectsFilters;
}

export type ExploreFilters<S extends ExploreSubcategory> = ExploreFiltersBySubcategory[S];

export type ExploreRequestFor<S extends ExploreSubcategory> =
	& ISearchRequestWithSortAndFilter<
		ExploreQuery,
		ExploreFilters<S>,
		IExploreRequestSortBy
	>
	& {
		category: ExploreCategoryForSubcategory<S>;
		subcategory: S;
	};

// Union type for handlers that accept any explore subcategory.
export type ExploreRequest =
	| ExploreRequestFor<'services'>
	| ExploreRequestFor<'freelancers'>
	| ExploreRequestFor<'teams'>
	| ExploreRequestFor<'templates'>
	| ExploreRequestFor<'products'>
	| ExploreRequestFor<'articles'>
	| ExploreRequestFor<'courses'>
	| ExploreRequestFor<'projects'>;

// Optional convenience helper to infer subcategory from a request.
export type InferExploreSubcategory<T extends ExploreRequest> = T['subcategory'];

// Optional convenience helper to get filters type from a subcategory.
export type InferExploreFilters<T extends ExploreRequest> = T extends
	ExploreRequestFor<infer S extends ExploreSubcategory> ? ExploreFilters<S>
	: never;

```

### File: apps\web\contracts\public\IExploreResponse.ts

```ts
import { ExploreSubcategory } from './IExploreCategories.ts';
import { ProjectStatus } from './IExploreFilters.ts';

export interface ExploreUploader {
	id: string;
	username: string;
	displayName: string;
	avatarUrl: string | null;
	profileSlug?: string;
}

// ---- Common item base ----

export interface ExploreItemBase {
	id: string;
	slug?: string;
	subcategory: ExploreSubcategory;
	name: string; // item name/title
	imageUrl: string | null;
	uploader: ExploreUploader;
}

// ---- Meta building blocks ----

export interface RatingMeta {
	rating: number | null; // 0–5 , null if no ratings yet
	ratingCount: number;
}

export interface PriceMeta extends RatingMeta {
	priceCents: number;
	currency: string; // 'GBP', 'USD', etc.
	originalPriceCents?: number; // for discounts
	isDiscounted?: boolean;
}

export interface TemplateMeta extends RatingMeta {
	description: string;
}

export interface ArticleMeta extends RatingMeta {
	estimatedReadTimeMinutes: number;
}

export interface ProjectMeta {
	durationDays: number;
	status: ProjectStatus;
}

export interface FreelancerTeamMeta extends RatingMeta {
	serviceCount: number;
	productCount: number;
	headline: string;
}

// ---- Items per subcategory ----

// Services: rating, number of ratings, price
export interface ServiceExploreItem extends ExploreItemBase {
	subcategory: 'services';
	meta: PriceMeta;
}

// Products: rating, number of ratings, price
export interface ProductExploreItem extends ExploreItemBase {
	subcategory: 'products';
	meta: PriceMeta;
}

// Courses: rating, number of ratings, price
export interface CourseExploreItem extends ExploreItemBase {
	subcategory: 'courses';
	meta: PriceMeta;
}

// Templates: rating, number of ratings, description
export interface TemplateExploreItem extends ExploreItemBase {
	subcategory: 'templates';
	meta: TemplateMeta;
}

// Articles: rating, number of ratings, estimated read time
export interface ArticleExploreItem extends ExploreItemBase {
	subcategory: 'articles';
	meta: ArticleMeta;
}

// Projects: duration and status
export interface ProjectExploreItem extends ExploreItemBase {
	subcategory: 'projects';
	meta: ProjectMeta;
}

// Freelancers: rating, number of ratings, number of services, number of products, headline
export interface FreelancerExploreItem extends ExploreItemBase {
	subcategory: 'freelancers';
	meta: FreelancerTeamMeta;
}

// Teams: rating, number of ratings, number of services, number of products, headline
export interface TeamExploreItem extends ExploreItemBase {
	subcategory: 'teams';
	meta: FreelancerTeamMeta;
}

// Union of all possible explore items
export type ExploreItem =
	| ServiceExploreItem
	| ProductExploreItem
	| CourseExploreItem
	| TemplateExploreItem
	| ArticleExploreItem
	| ProjectExploreItem
	| FreelancerExploreItem
	| TeamExploreItem;

```

### File: apps\web\contracts\public\ISearchRequest.ts

```ts
export interface ISearchRequest<Q> {
	query: Q;
	page: number;
	pageSize: number;
}

export type SortOrder = 'asc' | 'desc';

export interface ISearchRequestWithSort<Q, S> extends ISearchRequest<Q> {
	sortBy: S;
	sortOrder: SortOrder;
}

export interface ISearchRequestWithFilter<Q, F> extends ISearchRequest<Q> {
	filters: F;
}

export interface ISearchRequestWithSortAndFilter<Q, F, S>
	extends ISearchRequestWithSort<Q, S>, ISearchRequestWithFilter<Q, F> {}

export type IFilterTypes = 'string' | 'number' | 'boolean' | 'date' | 'range' | 'array';

export interface ISearchRequestFilterDefinition<T> {
	type: IFilterTypes;
	values?: T[];
	min?: number;
	max?: number;
}

```

### File: apps\web\contracts\public\ISearchResponse.ts

```ts
export interface ISearchResponse<T> {
	results: T[];
	totalCount: number;
	page: number;
	pageSize: number;
}

```

### File: apps\web\deno.json

```json
{
  "tasks": {
    "check": "deno fmt --check && deno lint && deno check main.ts",
    "dev": "vite --port 3000 --open --host --mode development",
    "build": "vite build --mode production",
    "start": "deno serve -A --watch --port 3000 --env-file=../../.env main.ts",
    "update": "deno run -A -r jsr:@fresh/update ."
  },
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "preact"
  }
}

```

### File: apps\web\islands\NavBar.tsx

```tsx
import '@styles/components/navigation/nav-bar.css';
import NavBarGuest from '@components/navigation/NavBarGuest.tsx';
import NavBarUser from '@components/navigation/NavBarUser.tsx';
import NavBarUserSide from '@components/navigation/NavBarUserSide.tsx';

export default function NavBar(props: { isAuthenticated?: boolean }) {
	return (
		<>
			<header>
				<nav>
					{props.isAuthenticated ? <NavBarUser /> : <NavBarGuest />}
				</nav>
			</header>
			{props.isAuthenticated &&
				<NavBarUserSide />}
		</>
	);
}

```

### File: apps\web\islands\pages\auth\AuthLayout.tsx

```tsx
import '@styles/layouts/auth.css';
import { type ComponentChildren } from 'preact';

type AuthLayoutProps = {
	children: ComponentChildren;
};

export default function AuthLayout(props: AuthLayoutProps) {
	return (
		<div class='layout-auth'>
			<img
				src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
				alt='background'
				class='background'
			/>

			<div class='layout-auth__modal'>
				<div class='layout-auth__modal__window'>
					<img
						src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
						alt='background'
						class='backgrounds'
					/>
					<div class='layout-auth__modal__window__content'>
						<div class='layout-auth__modal__window__content__quote'>
							<p>Everything you can imagine is real</p>
							<div class='layout-auth__modal__window__content__quote__line-container'>
								<div class='layout-auth__modal__window__content__quote__line'></div>
								<span>Pablo Picasso</span>
							</div>
						</div>

						<div class='layout-auth__modal__window__content__slogan'>
							<h1 class='build-together'>Build Together.</h1>
							<h1 class='deliver-better'>Deliver Better.</h1>
						</div>
					</div>
				</div>

				<div class='layout-auth__modal__content'>
					<h1>Welcome</h1>
					{props.children}
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Login.tsx

```tsx
import '@styles/pages/auth/login.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import LoginButton from '@components/auth/LoginButton.tsx';
import GoogleLoginButton from '@components/auth/GoogleLoginButton.tsx';
import GitHubLoginButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);

export default function LoginIsland() {
	return (
		<div class='login'>
			<div class='login__container'>
				<div class='login__container__center'>
					<div class='login__header'>
						<h1>Welcome Back</h1>
						<p>Dive back in, right where you left off</p>
					</div>

					<div class='login__fields__container'>
						<div class='login__fields'>
							<TextField
								id='email'
								placeholder='Email'
								autocomplete='email'
								type='email'
								aria-label='Email address'
								aria-required='true'
								aria-describedby='email-error'
								onInput={(e) => {
									email.value = e.currentTarget.value;
								}}
							/>
							<div>
								<PasswordField
									id='password'
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								<div class='login__fields__options'>
									<label for='remember-me' class='remember-me'>
										<input type='checkbox' id='remember-me' />
										<span>Remember Me</span>
									</label>
									<a href='/auth/forgot-password'>Forgot Password?</a>
								</div>
							</div>
						</div>

						<div class='login__actions'>
							<LoginButton
								email={email}
								password={password}
							/>
							<GoogleLoginButton />
							<GitHubLoginButton />
						</div>
					</div>
				</div>
			</div>
			<div class='switch-auth'>
				<p class='switch-auth__text'>Don't have an account?</p>
				<a class='switch-auth__link' href='/register'>Register</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Onboarding.tsx

```tsx
import '@styles/pages/auth/onboarding.css';
import { useEffect } from 'preact/hooks';
import { signal } from '@preact/signals';
import OnboardingSubmit from '@components/auth/OnboardingSubmit.tsx';
import TextField from '@components/fields/TextField.tsx';

const firstName = signal('');
const lastName = signal('');
const username = signal('');
const type = signal<'freelancer' | 'client'>('client');

export default function OnboardingIsland() {
	useEffect(() => {
		const run = async () => {
			const response = await fetch('/api/v1/auth/user', {
				method: 'GET',
			});

			if (response.ok && response.status === 200) {
				const resp = await response.json();
				firstName.value = resp.firstName ?? '';
				lastName.value = resp.lastName ?? '';
				username.value = resp.username ?? '';
				console.log(resp);
			}
		};

		run();
	}, []);

	const onUserTypeChange = (e: InputEvent) => {
		type.value = (e.currentTarget as HTMLInputElement).value as ('freelancer' | 'client');
	};

	return (
		<div class='onboarding'>
			<div class='onboarding-stages'>
				<form class='onboarding-stage'>
					<div class='onboarding-stage__account-type__container'>
						<label
							for='onboarding-stage__account-type--client'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--client'
								value='client'
								hidden
								checked={type.value === 'client'}
								onInput={onUserTypeChange}
							/>
							Client
						</label>
						<label
							for='onboarding-stage__account-type--seller'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--seller'
								value='freelancer'
								hidden
								checked={type.value === 'freelancer'}
								onInput={onUserTypeChange}
							/>
							Seller
						</label>
					</div>

					<hr class='onboarding-stage__separator' />

					<div class='onboarding-stage__name'>
						<TextField value={firstName} placeholder='First Name' />
						<TextField value={lastName} placeholder='Last Name' />
					</div>

					<TextField value={username} placeholder='DoB' />
					<TextField value={username} placeholder='Username' />
				</form>
			</div>
			<div class='onboarding-stage-location'>
				<OnboardingSubmit
					firstName={firstName.value}
					lastName={lastName.value}
					username={username.value}
					type={type.value}
				/>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Register.tsx

```tsx
import '@styles/pages/auth/register.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import RegisterButton from '@components/auth/RegisterButton.tsx';
import GoogleRegisterButton from '@components/auth/GoogleRegisterButton.tsx';
import GitHubRegisterButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';
import { AuthValidator, RegisterErrors } from '@shared';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);
const confirmPassword = signal<string | undefined>(undefined);

const emailError = signal<string | null>(null);
const passwordError = signal<string | null>(null);
const confirmPasswordError = signal<string | null>(null);

const errors = signal<RegisterErrors>({});

export default function RegisterIsland() {
	return (
		<div class='register'>
			<div class='register__container'>
				<div class='register__container__center'>
					<div class='register__header'>
						<h1>Create an account</h1>
						<p>Begin Your Journey Here</p>
					</div>

					<form class='register__fields__container'>
						<div class='register__fields'>
							<div class='register__field'>
								<TextField
									id='email'
									onFocus={() => {
										emailError.value = '';
									}}
									onBlur={() => {
										emailError.value = AuthValidator
											.validateEmail(email.value || '');
									}}
									placeholder='Email'
									autocomplete='email'
									type='email'
									aria-label='Email address'
									aria-required='true'
									aria-invalid={!!emailError.value}
									aria-describedby='email-error'
									onInput={(e) => {
										email.value = e.currentTarget.value;
									}}
								/>
								{emailError.value && (
									<p
										id='email-error'
										class='register__field-error'
										role='alert'
									>
										{emailError.value ||
											errors.value?.email}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='password'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
										confirmPasswordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
									}}
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-invalid={!!passwordError.value}
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								{passwordError.value && (
									<p
										id='password-error'
										class='register__field-error'
										role='alert'
									>
										{passwordError.value ||
											errors.value?.password}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='confirmPassword'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
										confirmPasswordError.value = AuthValidator
											.validateConfirmPassword(
												password.value || '',
												confirmPassword.value || '',
											);
									}}
									placeholder='Re-enter Password'
									autocomplete='new-password'
									aria-label='Confirm password'
									aria-required='true'
									aria-invalid={!!confirmPasswordError.value}
									aria-describedby='confirmPassword-error'
									onInput={(e) => {
										confirmPassword.value = e.currentTarget.value;
									}}
								/>
								{confirmPasswordError.value && (
									<p
										id='confirmPassword-error'
										class='register__field-error'
										role='alert'
									>
										{confirmPasswordError.value ||
											errors.value?.confirmPassword}
									</p>
								)}
							</div>
						</div>

						<div class='register__actions'>
							<RegisterButton
								email={email}
								password={password}
								confirmPassword={confirmPassword}
							/>
							<GoogleRegisterButton />
							<GitHubRegisterButton />
						</div>
					</form>
				</div>
			</div>

			<div class='switch-auth'>
				<p class='switch-auth__text'>Already have an account?</p>
				<a class='switch-auth__link' href='/login'>Log In</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Verify.tsx

```tsx
import { useEffect, useState } from 'preact/hooks';
import ResendButton from '@components/auth/ResendButton.tsx';

type Props = {
	email: string | undefined;
};

export default function VerifyIsland({ email }: Props) {
	const [status, setStatus] = useState<'parsing' | 'verifying' | 'awaiting' | 'done' | 'error'>(
		'parsing',
	);
	const [err, setErr] = useState<string | null>(null);

	useEffect(() => {
		const params = new URLSearchParams(globalThis.location.hash.replace(/^#/, ''));
		const access_token = params.get('access_token');
		const refresh_token = params.get('refresh_token');

		if (access_token && refresh_token) {
			setStatus('verifying');
			fetch('/api/v1/auth/callback', {
				method: 'POST',
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify({ access_token, refresh_token }),
			})
				.then(async (r) => {
					console.log('1 -----', r);
					if (!r.ok) throw new Error((await r.json()).error?.message ?? 'Failed to set session');
					console.log('2 -----', r);
					setStatus('done');
					globalThis.location.href = '/onboarding';
				})
				.catch((e) => {
					console.log('error ------', e.message);
					setErr(e.message);
					setStatus('error');
				});
		} else {
			setStatus('awaiting');
		}
	}, []);

	return (
		<main class='mx-auto max-w-md p-6'>
			<h1 class='text-2xl font-semibold mb-4'>Verify your email</h1>

			{status === 'parsing' && <p>Preparing…</p>}
			{status === 'verifying' && <p>Signing you in…</p>}
			{status === 'done' && <p>Redirecting…</p>}

			{status === 'awaiting' && (
				<section>
					<p class='mb-3'>We’ve sent a verification link to your email. Click it to continue.</p>
					<p>{email}</p>
					<ResendButton email={email} />
				</section>
			)}

			{status === 'error' && (
				<section class='text-red-600'>
					<p class='mb-2'>We couldn’t verify your session.</p>
					<p class='mb-4 text-sm'>{err}</p>
					<a class='underline' href='/verify'>Try again</a>
				</section>
			)}
		</main>
	);
}

```

### File: apps\web\islands\pages\home\hero.tsx

```tsx
import '@styles/pages/home/hero.css';
import SearchBar from '@components/search/SearchBar.tsx';
import { IconChevronRight } from '@tabler/icons-preact';

export default function HomeHeroIsland() {
	return (
		<section id='hero' class='home__hero'>
			<div class='home__hero__bg'>
				<img
					class='home__hero__bg__image'
					src='https://images.unsplash.com/photo-1535957998253-26ae1ef29506?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=736'
				/>
			</div>
			<div class='home__hero__content'>
				<h1 class='home__hero__content__title'>
					Build Together.<br />Deliver Better.
				</h1>

				<div class='home__hero__content__search'>
					<SearchBar />
				</div>

				<div class='home__hero__content__actions'>
					<a class='home__hero__content__actions__join' href='#s'>
						<span>Start Creating</span>
						<IconChevronRight />
					</a>
					<a class='home__hero__content__actions__explore' href='#s'>
						<span>Explore</span>
						<IconChevronRight />
					</a>
				</div>
			</div>
		</section>
	);
}

```

### File: apps\web\islands\pages\public\explore.tsx

```tsx

```

### File: apps\web\islands\pages\public\search.tsx

```tsx
import '@styles/pages/public/explore/search.css';
import SearchBar from '@components/public/explore/SearchBar.tsx';
import { signal } from '@preact/signals';
import { IconLayout2Filled, IconList } from '@tabler/icons-preact';
import ExploreFilters from '@components/public/explore/Filters.tsx';

const showFilters = signal(true);
const displayType = signal(true);

export default function SearchIsland({ query }: { query: string }) {
	return (
		<div class='search-page'>
			<section class='search-page__search'>
				<h1 class='search-page__search__title'>{query}</h1>
				<div class='search-page__search__related'>
					<span>Related:</span>
				</div>
				<SearchBar />
			</section>
			<section class='search-page__options'>
				<div class='search-page__options__top'>
					<div class='search-page__options__toggle-filter'>
						<label for='search-page__options__toggle-filter'>
							<input
								type='checkbox'
								name='search-page__options__toggle-filter--toggle'
								id='search-page__options__toggle-filter'
								onInput={() => showFilters.value = !showFilters.value}
								checked={showFilters.value}
								hidden
							/>
							Filters
						</label>
					</div>
					<div class='search-page__options__categories'>
						<label>
							<input type='radio' value='work' name='search-page__options__categories' hidden />
							Work
						</label>
						<label>
							<input
								type='radio'
								value='resources'
								name='search-page__options__categories'
								hidden
							/>
							Resources
						</label>
						<label>
							<input type='radio' value='projects' name='search-page__options__categories' hidden />
							Projects
						</label>
					</div>
					<div class='search-page__options__sort'>
						<button type='button'>Sort</button>
					</div>
				</div>

				<div class='search-page__options__bottom'>
					<div class='search-page__options__results-count'>
						<p type='button'>Showing 472 results for "{query}" category</p>
					</div>
					<div class='search-page__options__category-type'>
						<label>
							<input
								type='radio'
								value='resources-templates'
								name='search-page__options__category-type'
								hidden
							/>
							Templates
						</label>
						<label>
							<input
								type='radio'
								value='resources-products'
								name='search-page__options__category-type'
								hidden
							/>
							Products
						</label>
						<label>
							<input
								type='radio'
								value='resources-articles'
								name='search-page__options__category-type'
								hidden
							/>
							Articles
						</label>
						<label>
							<input
								type='radio'
								value='resources-courses'
								name='search-page__options__category-type'
								hidden
							/>
							Courses
						</label>
					</div>
					<div class='search-page__options__layout'>
						<label for='search-page__options__layout--layout-list'>
							<input
								type='radio'
								value='layout-list'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-list'
								hidden
								checked={!displayType.value}
								onInput={() => displayType.value = false}
							/>
							<IconList />
						</label>
						<label for='search-page__options__layout--layout-grid'>
							<input
								type='radio'
								value='layout-grid'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-grid'
								hidden
								checked={displayType.value}
								onInput={() => displayType.value = true}
							/>
							<IconLayout2Filled />
						</label>
					</div>
				</div>
			</section>
			<div class='search-page__results'>
				{showFilters.value &&
					(
						<aside class='search-page__results__filters__container'>
							<ExploreFilters />
						</aside>
					)}
				<div class='search-page__results__content'>
					Search Results
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\main.ts

```ts
import { App, staticFiles } from 'fresh';
import { State } from './utils.ts';
import '@server/env.ts';

const app = new App<State>();

app.use(staticFiles());
app.fsRoutes();

export { app };

```

### File: apps\web\routes\(auth)\forgot-password.tsx

```tsx

```

### File: apps\web\routes\(auth)\login.tsx

```tsx
import { Head } from 'fresh/runtime';
import LoginIsland from '@islands/pages/auth/Login.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Login</title>
			</Head>

			<LoginIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\onboarding\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import OnboardingIsland from '@islands/pages/auth/Onboarding.tsx';

export default function Onboarding() {
	return (
		<>
			<Head>
				<title>Onboarding</title>
			</Head>

			<OnboardingIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\register.tsx

```tsx
import { Head } from 'fresh/runtime';
import RegisterIsland from '@islands/pages/auth/Register.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Sign Up</title>
			</Head>

			<RegisterIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\reset\[token].tsx

```tsx

```

### File: apps\web\routes\(auth)\verify\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import VerifyIsland from '@islands/pages/auth/Verify.tsx';
import { State } from '@utils';
import { getCookies } from '@std/http/cookie';
import { RenderableProps } from 'preact';
import { PageProps } from 'fresh';

// deno-lint-ignore no-explicit-any
export default function Verify(ctx: RenderableProps<PageProps<never, State>, any>) {
	const cookies = getCookies(ctx.req.headers);
	const email = cookies['verify_email'] ? decodeURIComponent(cookies['verify_email']) : undefined;

	return (
		<>
			<Head>
				<title>Verify</title>
			</Head>

			<VerifyIsland email={email} />
		</>
	);
}

```

### File: apps\web\routes\(auth)\_layout.tsx

```tsx
import { define } from '@utils';
import AuthLayout from '@islands/pages/auth/authLayout.tsx';

export default define.layout(function App(props) {
	const { Component } = props;

	return (
		<AuthLayout>
			<Component />
		</AuthLayout>
	);
});

```

### File: apps\web\routes\(auth)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/dashboard',
			},
		});
	}

	if (ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(dashboard)\dashboard\index.tsx

```tsx
export default function Dashboard() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\earnings\index.tsx

```tsx
export default function Earnings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\messages\index.tsx

```tsx
export default function Messages() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\projects\index.tsx

```tsx
export default function Projects() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\settings\index.tsx

```tsx
export default function Settings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\teams\index.tsx

```tsx
export default function Teams() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\(dashboard)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (!ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/login',
			},
		});
	}

	if (!ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(public)\(index)\index.tsx

```tsx
import '@styles/pages/home/home.css';
import HomeHeroIsland from '@islands/pages/home/hero.tsx';

export default function Home() {
	return (
		<div class='home'>
			<HomeHeroIsland />
		</div>
	);
}

```

### File: apps\web\routes\(public)\about.tsx

```tsx

```

### File: apps\web\routes\(public)\explore\index.tsx

```tsx
export default function Explore() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\explore\search\[query].tsx

```tsx
import { RenderableProps } from 'preact/src/index.d.ts';
import { PageProps } from 'https://jsr.io/@fresh/core/2.2.0/src/render.ts';
import { State } from '@utils';
import SearchIsland from '@islands/pages/public/search.tsx';

export default function Search(ctx: RenderableProps<PageProps<never, State>, any>) {
	ctx.params.query;
	console.log(ctx.params.query);

	return (
		<div class='search-page__container'>
			<SearchIsland query={ctx.params.query} />
		</div>
	);
}

```

### File: apps\web\routes\(public)\explore\[...path].tsx

```tsx
export default function ExploreItem() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\help\index.tsx

```tsx

```

### File: apps\web\routes\(public)\help\[...path].tsx

```tsx

```

### File: apps\web\routes\(public)\privacy.tsx

```tsx

```

### File: apps\web\routes\(public)\terms.tsx

```tsx

```

### File: apps\web\routes\(public)\[user]\index.tsx

```tsx

```

### File: apps\web\routes\(public)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\api\test\test.ts

```ts
import { define } from '@utils';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async GET(ctx) {
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setCookie(headers, {
			name: 'verify_email',
			value: 'email@email.com',
			path: '/verify',
			maxAge: 10000,
			httpOnly: true,
			sameSite: 'Lax',
			secure: true,
		});

		return new Response(null, {
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\callback.ts

```ts
import { define } from '@utils';
import { setAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const reqUrl = new URL(ctx.req.url);
		const { access_token, refresh_token } = await ctx.req.json();
		if (!access_token || !refresh_token) {
			return new Response(
				JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
				{
					status: 400,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: access_token,
			refreshToken: refresh_token,
			requestUrl: reqUrl,
		});
		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\email\login.ts

```ts
import { define } from '@utils';
import { loginWithEmail } from '@server/auth/email/login.ts';
import { setCookie } from '@std/http/cookie';
import { setAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await loginWithEmail(body);

		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		// IMPORTANT: keep a single Headers instance and append cookies to it.
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 401);
			return new Response(JSON.stringify({ error: res.error }), { status, headers });
		}

		// If the user isn’t verified, set a short-lived helper cookie and tell the client to go to /verify.
		const user = res.data.user;
		const unverified = user && !(user.email_confirmed_at ?? user.confirmed_at);

		if (unverified) {
			const email = user.email ?? (typeof body?.email === 'string' ? body.email : '');
			if (email) {
				setCookie(headers, {
					name: 'verify_email',
					value: encodeURIComponent(email),
					httpOnly: true,
					sameSite: 'Lax',
					secure: reqUrl.protocol === 'https:',
					path: '/verify',
					maxAge: 10 * 60,
				});
			}
			// Don’t replace headers—reuse the same instance so previously appended Set-Cookie aren’t lost.
			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		// If we have a session, persist tokens via cookies (append both, plus CSRF).
		if (res.data.session) {
			const { access_token, refresh_token } = res.data.session;
			if (!access_token || !refresh_token) {
				return new Response(
					JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
					{
						status: 400,
						headers,
					},
				);
			}
			// Derive secure + naming from the request URL/host inside the helper.
			setAuthCookies(headers, {
				accessToken: access_token,
				refreshToken: refresh_token,
				requestUrl: reqUrl,
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/' }), {
			status: 200,
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\email\register.ts

```ts
import { define } from '@utils';
import { registerWithEmail } from '@server/auth/email/register.ts';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await registerWithEmail(body, {}, {});
		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 500);
			return new Response(JSON.stringify({ error: res.error }), {
				status,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		const email = res.data.user?.email ?? (typeof body?.email === 'string' ? body.email : '');

		const headers = new Headers({
			location: verifyUrl,
		});
		if (email) {
			setCookie(headers, {
				name: 'verify_email',
				value: encodeURIComponent(email),
				httpOnly: true,
				sameSite: 'Lax',
				secure: reqUrl.protocol === 'https:',
				path: '/verify',
				maxAge: 10 * 60,
			});

			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		return new Response(null, { status: 303, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-login.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'login', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-register.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'register', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\logout.ts

```ts

```

### File: apps\web\routes\api\v1\auth\me.ts

```ts
// apps/web/routes/api/v1/auth/me.ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';
import { getAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async GET(ctx) {
		const { accessToken } = getAuthCookies(ctx.req);
		if (!accessToken) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		const sb = await supabaseClient(ctx.req);
		const { data: userRes, error: userErr } = await sb.auth.getUser();
		if (userErr || !userRes?.user) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		// Fetch public profile under RLS
		const { data: row } = await sb
			.from('org.users_public')
			.select(
				'user_id, display_name, avatar_url, active_profile_type, active_profile_id, active_team_id',
			)
			.eq('user_id', userRes.user.id)
			.single();

		const payload = row
			? {
				id: row.user_id as string,
				displayName: (row.display_name as string) ?? null,
				avatarUrl: (row.avatar_url as string) ?? null,
				activeProfileType: (row.active_profile_type as 'freelancer' | 'business' | null) ?? null,
				activeProfileId: (row.active_profile_id as string | null) ?? null,
				activeTeamId: (row.active_team_id as string | null) ?? null,
			}
			: {
				id: userRes.user.id,
				displayName: null,
				avatarUrl: null,
				activeProfileType: null,
				activeProfileId: null,
				activeTeamId: null,
			};

		return new Response(JSON.stringify({ user: payload }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\onboarding.ts

```ts
import { define } from '@utils';
import { onboarding } from '@server/auth/onboarding.ts';
import { getAuthCookies } from '@server/auth/cookies.ts';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await onboarding(body, {
			getClient: () => supabaseClient(ctx.req),
		});

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/dashboard' }), {
			status: 200,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\refresh.ts

```ts
// apps/web/routes/api/v1/auth/refresh.ts
import { define } from '@utils';
import { clearAuthCookies, setAuthCookies } from '@server/auth/cookies.ts';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const url = new URL(ctx.req.url);
		const refreshed = await maybeRefreshFromRequest(ctx.req);

		if (!refreshed) {
			const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
			clearAuthCookies(headers, url);
			return new Response(JSON.stringify({ ok: false, error: { code: 'refresh_failed' } }), {
				status: 401,
				headers,
			});
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: refreshed.access,
			refreshToken: refreshed.refresh,
			requestUrl: url,
		});

		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\resend.ts

```ts
import { define } from '@utils';
import { resendVerificationEmail } from '@server/auth/resend.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const { email } = await ctx.req.json();
		const res = await resendVerificationEmail((email ?? '').trim().toLowerCase());

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\switch-profile.ts

```ts

```

### File: apps\web\routes\api\v1\auth\switch-team.ts

```ts

```

### File: apps\web\routes\api\v1\auth\user.ts

```ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async GET(ctx) {
		const sb = await supabaseClient(ctx.req);
		const { data, error } = await sb.auth.getUser();

		if (!error && data.user && data.user.user_metadata) {
			const user = data.user.user_metadata;
			const name = user.name.split(' ');
			const firstName = name[0];
			const lastName = name[name.length - 1];
			const username = user.user_name;

			return new Response(JSON.stringify({ firstName, lastName, username }), {
				status: 200,
			});
		}

		return new Response('', { status: 204 });
	},
});

```

### File: apps\web\routes\api\v1\meta\health.ts

```ts
import { define } from '@utils';

const startedAt = Date.now();

type HealthPayload = {
	status: 'ok';
	service: string;
	version: string;
	uptime_ms: number;
	started_at: string;
	commit?: string;
	env: 'development' | 'production' | 'test' | string;
};

function payload(): HealthPayload {
	const uptime = Math.max(0, Date.now() - startedAt);
	const env = Deno.env.get('APP_ENV') ??
		(Deno.env.get('DENO_DEPLOYMENT_ID') ? 'production' : 'development');
	return {
		status: 'ok',
		service: Deno.env.get('APP_NAME') ?? 'projective-api',
		version: Deno.env.get('APP_VERSION') ?? '0.0.0',
		uptime_ms: uptime,
		started_at: new Date(startedAt).toISOString(),
		commit: Deno.env.get('GIT_COMMIT') ?? undefined,
		env,
	};
}

export const handler = define.handlers({
	async GET() {
		return new Response(JSON.stringify(payload()), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},

	async HEAD() {
		return new Response(null, {
			status: 200,
			headers: { 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\_app.tsx

```tsx
import { Head } from 'fresh/runtime';
import { State } from '@utils';

export default function App(
	ctx: { Component: preact.ComponentType; stateTheme?: 'light' | 'dark'; state: State },
) {
	const initial = ctx.stateTheme ?? 'dark';

	return (
		<html lang='en' data-theme={initial}>
			<Head>
				<meta charSet='utf-8' />
				<meta name='viewport' content='width=device-width, initial-scale=1' />
				<meta
					name='description'
					content='Collaborative freelancing platform.'
				/>
				<title>Projective</title>
			</Head>
			<body data-onboarded={ctx.state.isOnboarded}>
				<main>
					<ctx.Component />
				</main>
			</body>
		</html>
	);
}

```

### File: apps\web\routes\_middleware.ts

```ts
// apps/web/routes/_middleware.ts
import { define } from '@utils';
import {
	clearAuthCookies,
	getAuthCookies,
	setAuthCookies,
	verifyCsrf,
} from '@server/auth/cookies.ts';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';
import { isOnboarded } from '@server/auth/onboarding.ts';

function jwtExp(token: string): number | null {
	try {
		const payload = token.split('.')[1];
		if (!payload) return null;
		const json = JSON.parse(
			new TextDecoder().decode(
				Uint8Array.from(
					atob(payload.replace(/-/g, '+').replace(/_/g, '/')),
					(c) => c.charCodeAt(0),
				),
			),
		);
		return typeof json.exp === 'number' ? json.exp : null;
	} catch {
		return null;
	}
}

const middleware1 = define.middleware(async (ctx) => {
	const req = ctx.req;
	const url = new URL(req.url);
	const path = url.pathname;

	const { accessToken, refreshToken } = getAuthCookies(req);
	const now = Math.floor(Date.now() / 1000);
	const skew = 60;

	ctx.state.isAuthenticated = !!accessToken;

	if (!ctx.state.isAuthenticated) {
		ctx.state.isOnboarded = false;
	}

	// Decide if we should refresh
	let shouldRefresh = false;
	if (refreshToken) {
		if (!accessToken) shouldRefresh = true;
		else {
			const exp = jwtExp(accessToken);
			if (!exp || exp <= now + skew) shouldRefresh = true;
		}
	}

	// Use ctx.state fields (OK), do NOT reassign ctx.state
	ctx.state.refreshedTokens = null;
	ctx.state.clearAuth = false;

	if (shouldRefresh) {
		const refreshed = await maybeRefreshFromRequest(req);
		if (refreshed) {
			ctx.state.refreshedTokens = refreshed;
		} else {
			ctx.state.clearAuth = true;
		}
	}

	// CSRF for cookie-auth state-changing requests (skip if Authorization: Bearer present)
	const isStateChanging = ['POST', 'PUT', 'PATCH', 'DELETE'].includes(req.method.toUpperCase());
	const hasBearer = !!req.headers.get('authorization')?.startsWith('Bearer ');
	if (isStateChanging && !hasBearer && (accessToken || ctx.state.refreshedTokens)) {
		if (!verifyCsrf(req)) {
			return new Response(
				JSON.stringify({ error: { code: 'csrf_failed', message: 'CSRF check failed' } }),
				{ status: 403, headers: { 'content-type': 'application/json; charset=utf-8' } },
			);
		}
	}

	// Always allow /verify
	if (path.startsWith('/verify')) {
		const res = await ctx.next();
		if (ctx.state.refreshedTokens) {
			const { access, refresh } = ctx.state.refreshedTokens;
			setAuthCookies(res.headers, {
				accessToken: access,
				refreshToken: refresh,
				requestUrl: url,
			});
		}
		if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);
		return res;
	}

	const res = await ctx.next();

	if (ctx.state.refreshedTokens) {
		const { access, refresh } = ctx.state.refreshedTokens;
		setAuthCookies(res.headers, {
			accessToken: access,
			refreshToken: refresh,
			requestUrl: url,
		});
	}
	if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);

	return res;
});

const middleware2 = define.middleware(async (ctx) => {
	if (ctx.state.isAuthenticated && !ctx.state.isOnboarded) {
		ctx.state.isOnboarded = await isOnboarded(ctx.req);
	}

	return await ctx.next();
});

export default [middleware1, middleware2];

```

### File: apps\web\server\auth\claims.ts

```ts
export type JwtClaims = {
	sub: string;
	exp?: number;
	active_profile_type?: 'freelancer' | 'business';
	active_profile_id?: string;
	active_team_id?: string | null;
} | null;

export function parseJwt(token?: string): JwtClaims {
	if (!token) return null;
	try {
		const [, b64] = token.split('.');
		if (!b64) return null;
		const json = atob(b64.replace(/-/g, '+').replace(/_/g, '/'));
		return JSON.parse(json);
	} catch {
		return null;
	}
}

export function isExpired(exp?: number, skewSec = 30) {
	if (!exp) return true;
	return exp <= Math.floor(Date.now() / 1000) + skewSec;
}

```

### File: apps\web\server\auth\cookies.ts

```ts
import { type Cookie, deleteCookie, getCookies, setCookie } from '@std/http/cookie';

type SetAuthOpts = {
	accessToken: string;
	refreshToken: string;
	/** Pass the current request URL so we can decide secure + naming correctly. */
	requestUrl: URL;
};

/** Local dev can’t use __Host-* (requires secure + no Domain + Path=/ on HTTPS). */
function resolveCookieNames(isSecureOrigin: boolean, isLocalhost: boolean) {
	if (isSecureOrigin && !isLocalhost) {
		return { ACCESS_NAME: '__Host-pjv-at', REFRESH_NAME: '__Host-pjv-rt' };
	}
	return { ACCESS_NAME: 'pjv-at', REFRESH_NAME: 'pjv-rt' };
}

function isLocalhostHost(hostname: string) {
	return (
		hostname === 'localhost' ||
		hostname === '127.0.0.1' ||
		hostname === '[::1]' ||
		/\.local(domain)?$/i.test(hostname)
	);
}

export function setAuthCookies(
	headers: Headers,
	{ accessToken, refreshToken, requestUrl }: SetAuthOpts,
) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	// Common attributes for auth cookies
	const common: Partial<Cookie> = {
		httpOnly: true,
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal, // never mark Secure on localhost
		path: '/', // required for __Host-* and fine for non-__Host too
	};

	// Access: ~15 minutes
	setCookie(headers, {
		...common,
		name: ACCESS_NAME,
		value: accessToken,
		maxAge: 60 * 15,
	});

	// Refresh: ~30 days
	setCookie(headers, {
		...common,
		name: REFRESH_NAME,
		value: refreshToken,
		maxAge: 60 * 60 * 24 * 30,
	});

	// CSRF (readable) — double-submit token, same naming irrespective of env
	setCookie(headers, {
		name: 'pjv-csrf',
		value: randomToken(),
		httpOnly: false, // must be readable by JS
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal,
		path: '/',
		maxAge: 60 * 60 * 24 * 30,
	});
}

export function clearAuthCookies(headers: Headers, requestUrl: URL) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	const base = { path: '/', secure: isSecureOrigin && !isLocal } as const;

	// Delete both possible names just in case a previous env wrote the other variant.
	deleteCookie(headers, ACCESS_NAME, base);
	deleteCookie(headers, REFRESH_NAME, base);
	deleteCookie(headers, 'pjv-csrf', base);

	// Also try deleting the opposite flavor to avoid sticky leftovers across envs.
	deleteCookie(headers, '__Host-pjv-at', base);
	deleteCookie(headers, '__Host-pjv-rt', base);
	deleteCookie(headers, 'pjv-at', base);
	deleteCookie(headers, 'pjv-rt', base);
}

export function getAuthCookies(req: Request) {
	const c = getCookies(req.headers);
	// Support both name variants seamlessly.
	const accessToken = c['__Host-pjv-at'] ?? c['pjv-at'];
	const refreshToken = c['__Host-pjv-rt'] ?? c['pjv-rt'];
	return {
		accessToken,
		refreshToken,
		csrf: c['pjv-csrf'],
	};
}

// ---- CSRF helpers ----

export function verifyCsrf(req: Request): boolean {
	const method = req.method.toUpperCase();
	if (!['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) return true;

	const cookies = getCookies(req.headers);
	const sent = req.headers.get('X-CSRF');
	const expected = cookies['pjv-csrf'];
	return Boolean(sent && expected && sent === expected);
}

// Generate a CSRF token
function randomToken(bytes = 32) {
	const a = new Uint8Array(bytes);
	crypto.getRandomValues(a);
	return btoa(String.fromCharCode(...a)).replace(/=+$/, '');
}

export function getCsrfToken(name = 'pjv-csrf'): string | null {
	const cookie = typeof document !== 'undefined' ? document.cookie : '';
	if (!cookie) return null;

	const match = cookie.match(
		new RegExp('(?:^|; )' + name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&') + '=([^;]*)'),
	);

	return match ? decodeURIComponent(match[1]) : null;
}

```

### File: apps\web\server\auth\email\login.ts

```ts
import { LoginWithEmailRequest } from "@contracts/auth/login.ts";
import { supabaseClient } from "../../core/clients/supabase.ts";
import { fail, ok, Result } from "../../core/http/result.ts";
import { isLikelyEmail } from "../../core/validation/email.ts";
import { Deps, SignInData } from "../_shared/types.ts";
import {
	normaliseSupabaseError,
	normaliseUnknownError,
} from "../../core/errors/normalise.ts";
import { Config } from "@backend";

export async function loginWithEmail(
	{ email, password }: LoginWithEmailRequest,
	deps: Deps = {},
): Promise<Result<SignInData>> {
	const e = (email ?? "").trim().toLowerCase();
	const p = (password ?? "").trim();

	if (!e || !p) {
		return fail("bad_request", "Email and password are required.", 400);
	}
	if (!isLikelyEmail(e)) {
		return fail("bad_request", "Invalid email format.", 400);
	}

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signInWithPassword({
			email: e,
			password: p,
		});

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\email\register.ts

```ts
import { RegisterWithEmailRequest } from '@contracts/auth/register.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';
import { Deps, RegisterOptions, SignUpData } from '../_shared/types.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';

export async function registerWithEmail(
	{ email, password }: RegisterWithEmailRequest,
	deps: Deps = {},
	opts: RegisterOptions = {},
): Promise<Result<SignUpData>> {
	const e = (email ?? '').trim().toLowerCase();
	const p = (password ?? '').trim();

	if (!e || !p) return fail('bad_request', 'Email and password are required.', 400);
	if (!isLikelyEmail(e)) return fail('bad_request', 'Invalid email format.', 400);
	if (p.length < 8) return fail('bad_request', 'Password must be at least 8 characters.', 400);

	try {
		const emailRedirectTo = `${Deno.env.get('URL')}/verify`;
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signUp({
			email: e,
			password: p,
			options: {
				data: opts.metadata,
				emailRedirectTo,
				captchaToken: opts.captchaToken,
			},
		});

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\finalise-login.ts

```ts

```

### File: apps\web\server\auth\oauth.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';

export type OAuthProvider = 'google' | 'github';
export type OAuthIntent = 'login' | 'register';

export async function getProviderRedirectUrl(
	provider: OAuthProvider,
	intent: OAuthIntent,
	requestUrl: URL,
	next = '/',
): Promise<string> {
	const verifyUrl = new URL('/verify', requestUrl);
	if (next && next !== '/') {
		verifyUrl.searchParams.set('next', next);
	}
	verifyUrl.searchParams.set('intent', intent);

	const sb = await supabaseClient();
	const { data, error } = await sb.auth.signInWithOAuth({
		provider,
		options: {
			redirectTo: verifyUrl.toString(),
			skipBrowserRedirect: true,
		} as any,
	});

	console.log({ provider, url: data?.url }, error);

	if (error || !data?.url) {
		throw new Error(error?.message || 'OAuth init failed');
	}
	return data.url;
}

```

### File: apps\web\server\auth\onboarding.ts

```ts
// server/auth/onboarding.ts
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { Deps, SignInData } from './_shared/types.ts';
import { fail, ok, Result } from '../core/http/result.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { supabaseClient } from '../core/clients/supabase.ts';

export async function onboarding(
	{
		firstName,
		lastName,
		username,
		type,
	}: OnboardingRequest,
	deps: Deps = {},
): Promise<Result<any>> {
	if (!firstName || !username) {
		return fail('bad_request', 'First name and username are required.', 400);
	}

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		// Make sure we actually have an authenticated user
		const { data, error: authError } = await supabase.auth.getUser();
		if (authError || !data.user) {
			return fail('unauthorized', 'You must be signed in to onboard.', 401);
		}

		const userId = data.user.id;

		// Insert public profile
		const { error: userError } = await supabase
			.schema('org')
			.from('users_public')
			.insert({
				user_id: userId,
				first_name: firstName,
				last_name: lastName,
				username,
			});

		if (userError) {
			const n = normaliseSupabaseError(userError);
			return fail(n.code, n.message, n.status);
		}

		// Optionally create freelancer profile
		if (type === 'freelancer') {
			const { error: freelancerError } = await supabase
				.schema('org')
				.from('freelancer_profiles')
				.insert({
					user_id: userId, // <- use the same authenticated user
				});

			if (freelancerError) {
				const n = normaliseSupabaseError(freelancerError);
				return fail(n.code, n.message, n.status);
			}
		}

		return ok<any>({}); // TODO: return whatever you actually need
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

export async function isOnboarded(req: Request) {
	const supabase = await supabaseClient(req);
	const { data, error } = await supabase.auth.getUser();

	if (error || !data.user.id) {
		return false;
	}

	const { data: userData } = await supabase.schema('org').from('users_public').select('user_id').eq(
		'user_id',
		data.user.id,
	);

	if (userData) {
		return true;
	}

	return false;
}

```

### File: apps\web\server\auth\refresh.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';
import { getAuthCookies } from './cookies.ts';

type RefreshResult = { access: string; refresh: string } | null;

export async function refreshWithToken(refreshToken: string): Promise<RefreshResult> {
	const sb = await supabaseClient();
	const { data, error } = await sb.auth.refreshSession({ refresh_token: refreshToken });

	if (error || !data?.session?.access_token || !data?.session?.refresh_token) {
		return null;
	}
	return {
		access: data.session.access_token,
		refresh: data.session.refresh_token,
	};
}

export async function maybeRefreshFromRequest(req: Request): Promise<RefreshResult> {
	const { refreshToken } = getAuthCookies(req);
	if (!refreshToken) return null;
	return await refreshWithToken(refreshToken);
}

```

### File: apps\web\server\auth\resend.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { fail, ok, Result } from '../core/http/result.ts';

export async function resendVerificationEmail(email: string): Promise<Result<{ sent: true }>> {
	if (!email) return fail('bad_request', 'Email is required.', 400);
	try {
		const emailRedirectTo = `${Deno.env.get('URL')}/verify`;
		const supabase = await supabaseClient();
		const { error } = await supabase.auth.resend({
			type: 'signup',
			email,
			options: {
				emailRedirectTo,
			},
		});
		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}
		return ok({ sent: true });
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\session-context-service.ts

```ts

```

### File: apps\web\server\auth\_shared\types.ts

```ts
import type { AuthResponse, AuthTokenResponsePassword, SupabaseClient } from 'supabaseClient';

export type SignUpData = AuthResponse['data'];

export type SignInData = AuthTokenResponsePassword['data'];

export type Deps = {
	getClient?: () => Promise<SupabaseClient>;
};

export type RegisterOptions = {
	emailRedirectTo?: string;
	captchaToken?: string;
	metadata?: Record<string, unknown>;
};

```

### File: apps\web\server\core\clients\supabase.ts

```ts
import { createClient, type SupabaseClient, type SupabaseClientOptions } from 'supabaseClient';

import { getAuthCookies } from '../../auth/cookies.ts';

let anonClient: SupabaseClient /*<Database>*/ | null = null;

function getEnv() {
	const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
	const ANON_KEY = Deno.env.get('SUPABASE_ANON_KEY');
	if (!SUPABASE_URL || !ANON_KEY) throw new Error('Missing SUPABASE_URL or SUPABASE_ANON_KEY');
	return { SUPABASE_URL, ANON_KEY };
}

/**
 * Returns a Supabase client:
 * - If `req` contains an access token cookie, a **new per-request client** with `Authorization: Bearer <token>`.
 * - Otherwise, a **shared anon client** (cached).
 *
 * No session persistence; SSR-safe.
 */
export async function supabaseClient(req?: Request): Promise<SupabaseClient> {
	const { SUPABASE_URL, ANON_KEY } = getEnv();

	const baseOptions: SupabaseClientOptions<'public'> = {
		auth: {
			persistSession: false,
			detectSessionInUrl: false,
		},
	};

	if (req) {
		const { accessToken } = getAuthCookies(req);
		if (accessToken) {
			return createClient(SUPABASE_URL, ANON_KEY, {
				...baseOptions,
				global: {
					headers: {
						Authorization: `Bearer ${accessToken}`,
					},
				},
			});
		}
	}

	if (!anonClient) {
		anonClient = createClient(SUPABASE_URL, ANON_KEY, baseOptions);
	}
	return anonClient;
}

```

### File: apps\web\server\core\errors\normalise.ts

```ts
export function normaliseSupabaseError(error: unknown): {
	code: string;
	message: string;
	status?: number;
} {
	const e = error as { code?: string; message?: string; status?: number };
	const raw = (e.code ?? '').toLowerCase();

	if (raw.includes('rate') || e.status === 429) {
		return {
			code: 'rate_limit',
			message: e.message ?? 'Too many attempts. Please try later.',
			status: 429,
		};
	}
	if (raw.includes('user') && raw.includes('exists')) {
		return { code: 'user_exists', message: e.message ?? 'User already exists.', status: 409 };
	}
	if ((raw.includes('invalid') && raw.includes('credentials')) || e.status === 401) {
		return {
			code: 'invalid_credentials',
			message: e.message ?? 'Invalid email or password.',
			status: 401,
		};
	}
	if (raw === 'signup_failed' || raw === 'invalid_signup' || e.status === 400) {
		return {
			code: 'signup_failed',
			message: e.message ?? 'Sign up failed.',
			status: e.status ?? 400,
		};
	}

	return { code: raw || 'auth_error', message: e.message ?? 'Authentication error.' };
}

export function normaliseUnknownError(err: unknown): {
	code: string;
	message: string;
} {
	if (err && typeof err === 'object') {
		const anyErr = err as { name?: string; message?: string };
		const name = (anyErr.name ?? '').toLowerCase();
		const message = anyErr.message ?? 'Unknown error';
		if (name === '' || name === 'error') {
			return { code: 'unknown_error', message };
		}
		return { code: name, message };
	}
	return { code: 'unknown_error', message: 'Unknown error' };
}

```

### File: apps\web\server\core\http\result.ts

```ts
export type Ok<T> = { ok: true; data: T };
export type Fail = { ok: false; error: { code: string; message: string; status?: number } };
export type Result<T> = Ok<T> | Fail;

export function ok<T>(data: T): Ok<T> {
	return { ok: true, data };
}
export function fail(code: string, message: string, status?: number): Fail {
	return { ok: false, error: { code, message, status } };
}

```

### File: apps\web\server\core\validation\email.ts

```ts
export function isLikelyEmail(s: string): boolean {
	if (!s || !s.includes('@')) return false;
	const [, domain = ''] = s.split('@');
	return domain.includes('.') && !/\s/.test(s);
}

```

### File: apps\web\server\env.ts

```ts
import { loadSync } from '@std/dotenv';

loadSync({ export: true });

const mode = Deno.env.get('MODE') ??
	Deno.env.get('NODE_ENV') ??
	Deno.env.get('VITE_MODE') ??
	'development';

loadSync({ envPath: `.env.${mode}`, export: true });

```

### File: apps\web\server\middleware\auth\verify_guard.ts

```ts
import { Deps, SignInData } from '../../auth/_shared/types.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';

export async function loginWithEmail(email: string, deps: Deps = {}): Promise<any> {
	const e = (email ?? '').trim().toLowerCase();

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.get({ email: e, password: p });

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\middleware\auth_guard.ts

```ts

```

### File: apps\web\styles\components\auth\login-button.css

```css
.login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  background-color: black;
  color: white;
  border-radius: var(--border-radius__large);

  &:disabled {
    background-color: red;
  }
}

```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-1.css

```css
.onboarding-stage-1 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;

    .onboarding-stage-1__account-type__container {
        display: flex;
        gap: 0.75em;
        width: 100%;

        .onboarding-stage-1__account-type {
            width: 100%;
            background-color: #fff5;
            color: var(--primary);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--fast);

            &:hover {
                background-color: #fff4;
            }

            &:has(input:checked) {
                background-color: #000;
                color: white;
                font-weight: bold;
            }
        }
    }

    .onboarding-stage-1__separator {
        width: 100%;
        border: 1px solid #fff3;
    }

    .onboarding-stage-1__name {
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 0.75em;
    }
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-2.css

```css
.onboarding-stage-2 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-3.css

```css

```

### File: apps\web\styles\components\auth\provider-login-button.css

```css
.provider-login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  border: 1px solid hsla(0, 100%, 100%, 0.2);
  color: white;
  border-radius: var(--border-radius__large);
}

```

### File: apps\web\styles\components\fields\DropdownField.css

```css
.dropdown-field__container {
  width: 100%;
  position: relative;
}

.dropdown-field__input {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  border-radius: var(--border-radius);
  box-shadow: inset 0 3px 6px #0004;
  background-color: #fff;
  /* outline: 1px solid #ccc; */
  position: relative;

  .dropdown-field__input__button {
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 0.25rem;

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input {
      width: 100%;
      height: 100%;
      padding: 0.4rem;
      text-align: left;
    }

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input::placeholder {
      color: var(--text-dark);
    }
  }

  &:has(.dropdown-field__input__selected) {
    .dropdown-field__input__button {
      padding: 0.25rem 0;

      .dropdown-field__input__button__span,
      .dropdown-field__input__button__input {
        padding: 0.4rem 0;
      }
    }
  }

  .dropdown-field__input__selected {
    height: 100%;
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 0.25rem;

    .dropdown-field__input__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: var(--border-radius);

      background-color: #fff;
      box-shadow: 0 2px 6px #0004;
      padding: 0.3rem 0.4rem;
      color: var(--text);

      .dropdown-field__input__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}


.dropdown-field__selected__container {
  width: 100%;
  display: flex;

  .dropdown-field__selected {
    position: relative;
    width: 100%;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
    border: 1px solid var(--card);
    border-radius: var(--border-radius);
    padding: 0.5rem;

    .dropdown-field__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: 2rem;

      background-color: var(--primary-half);
      padding: 0.2rem 0.5rem;
      color: white;
      font-size: 0.8rem;

      .dropdown-field__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}
```

### File: apps\web\styles\components\fields\FormStages.css

```css
.form-stages {
  display: flex;
  align-items: center;
  gap: 1em;

  .form-stages__item {
    display: flex;
    align-items: center;
    gap: 1em;
    position: relative;

    &[data-selected="true"] {
      font-weight: bold;

      .form-stages__item__container {

        opacity: 1;
      }
    }

    .form-stages__item__container {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.5;


      .form-stages__item__circle {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 4em;
        width: 4em;
        background-color: white;
        color: var(--primary);
        font-weight: bold;
        border-radius: 4em;

        p {
          padding: 0;
          margin: 0;
          font-size: 2em;
        }
      }

      .form-stages__item__name {
        font-size: 1;
        padding-top: 0.5em;
        margin: 0;
      }
    }

    .form-stages__item__divider {
      position: relative;
      width: 5em;
      border: 0.1em dashed white;
      top: -0.75em;
      opacity: 0.3;
    }
  }
}
```

### File: apps\web\styles\components\fields\TextField.css

```css
.text-field,
.password-field,
.text-area-field {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  background-color: hsla(0, 100%, 100%, 0.3);
  border-radius: var(--border-radius);

  * {
    stroke: var(--primary);
  }

  textarea,
  input {
    font-size: inherit;
    padding: 0.8em 1em;
    outline: none;
    border: none;
    background: none;
    width: 100%;

    &::placeholder {
      color: var(--primary);
    }
  }
}

.text-field__container {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-guest.css

```css
.header-container {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10rem;
}

.header__buttons {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-weight: bold;

  .header__buttons__user {
    padding: 0.4rem 2rem;
    border-radius: var(--border-radius);
    transition: background var(--medium), color var(--medium),
      border var(--medium);

    &.header__buttons__login {
      color: var(--primary);
      border: 1px solid var(--primary);

      &:hover {
        border: 1px solid var(--primary-highlight);
        color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }

    &.header__buttons__join {
      background-color: var(--primary);
      color: white;

      &:hover {
        background-color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-actions.css

```css
  .nav-bar-user__profile__dropdown__actions {
    display: flex;
    flex-direction: column;

    a {
      padding: 0.5em 1em;
      border-radius: var(--border-radius__small);
      cursor: pointer;

      &:hover {
        background-color: var(--button-hover);
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-business.css

```css
  .nav-bar-user__profile__dropdown__switch__business {
    width: 100%;
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-switch.css

```css
  .nav-bar-user__profile__dropdown__switch {
    display: flex;
    flex-direction: column;
    align-items: center;

    .nav-bar-user__profile__dropdown__switch__switch {
      display: flex;
      justify-content: space-evenly;
      width: 100%;

      .nav-bar-user__profile__dropdown__switch__label {
        cursor: pointer;

        &:has(input:checked) {
          color: var(--primary);
          font-weight: bold;
        }
      }
    }

    hr {
      width: 75%;
      border: 1px solid var(--text-dark);
    }

    .nav-bar-user__profile__dropdown__switch__account-type {
      width: 75%;

      .nav-bar-user__profile__dropdown__add {
        width: 100%;
        color: var(--button-hover-light);
        border: 1px solid var(--button-hover-light);
        padding: 0.5rem 0;
        border-radius: var(--border-radius__small);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 0.8em;

        &:hover {
          background-color: var(--button-hover);
          color: var(--text);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-teams.css

```css
.nav-bar-user__profile__dropdown__teams {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown.css

```css
  .nav-bar-user__profile__dropdown {
    position: absolute;
    top: var(--header-height);
    right: 0;
    background-color: var(--header);
    width: 400px;
    padding: 1em;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    border-radius: var(--border-radius__large);

    .nav-bar-user__profile__dropdown__current {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .nav-bar-user__profile__dropdown__current__profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;

        img {
          height: 4em;
          width: 4em;
          border-radius: 4em;
          border: 1px solid var(--text-dark);
        }

        p {
          margin: 0;
          padding: 0;
        }

        .nav-bar-user__profile__dropdown__current__profile__name {

          .nav-bar-user__profile__dropdown__current__profile__name__name {
            font-size: 1.5em;
            font-weight: 500;
          }

          .nav-bar-user__profile__dropdown__current__profile__name__username {
            font-size: 0.8em;
            color: var(--text-medium);
          }
        }
      }

      .nav-bar-user__profile__dropdown__current__switch {
        border-radius: var(--border-radius__small);
        height: 2rem;
        width: 2rem;

        display: flex;
        align-items: center;
        justify-content: center;

        svg * {
          stroke: var(--text-medium);
        }

        &:hover {
          background-color: var(--button-hover);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile.css

```css
.nav-bar-user__profile {
  position: relative;

  .nav-bar-user__profile__btn {
    height: 2.75rem;
    width: 2.75rem;
    min-height: 2.75rem;
    min-width: 2.75rem;
    max-height: 2.75rem;
    max-width: 2.75rem;
    border-radius: 4rem;

    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;

    .nav-bar-user__profile__btn__img {
      min-height: inherit;
      min-width: inherit;

      border: 1px solid var(--text-dark);
      border-radius: 4rem;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;

      img {
        min-height: inherit;
        min-width: inherit;
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-side.css

```css
.nav-bar-user-side {
  position: fixed;
  left: 1rem;
  top: calc(var(--header-height) + 1rem);
  width: var(--side-nav-width);
  height: calc(100% - var(--header-height) - 1rem);
  z-index: 1000;
  display: flex;

  .nav-bar-user-side__container {
    margin: 1rem 0;
    height: 100%;
    max-height: calc(100% - 4rem);
    width: 100%;
    background-color: var(--header);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    position: relative;
    border-radius: 1rem;
  }

  .nav-bar-user-side__group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    width: 100%;

    .nav-bar-user-side__app {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 2.5rem;

      &[data-selected="true"] {
        box-shadow: 0 0 12px var(--primary);
        background-color: var(--primary-half);
        outline: 1px solid var(--primary);
        color: white;
      }
    }
  }

  .nav-bar-user-side__open {
    position: absolute;
    left: 0.75rem;
    bottom: 1rem;
  }

  a,
  button {
    border-radius: var(--border-radius__small);
    height: 2.5rem;
    min-height: 2.5rem;
    width: 2.5rem;
    min-width: 2.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-dark);

    &:hover {
      background-color: var(--button-hover);
      color: var(--text-medium);
    }
  }

  hr {
    border: 1px solid var(--text-dark);
    width: 80%;
    opacity: 0.5;
  }

  &[data-sidebar-open='true'] {
    .nav-bar-user-side__app {
      justify-content: start !important;
      gap: 0.5rem !important;
      padding: 0 0.5rem !important;
      width: calc(100% - 1rem) !important;
    }

    [data-tooltip]::before {
      display: none;
    }

    [data-tooltip]:hover::before {
      display: none;
    }
  }

  &[data-sidebar-open='false'] {
    .nav-bar-user-side__app {
      justify-content: center !important;
      gap: 0 !important;
      padding: 0 !important;
      width: 100% !important;
    }

    [data-tooltip]::before {
      left: 100% !important;
      transform: translate(1rem, calc(-100% - 0.75rem));
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user.css

```css
.nav-bar-user {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1rem;

  .nav-bar-user__logo {
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;

    .nav-bar-user__logo__svg {
      height: 2rem;
      width: auto;
    }
  }

  .nav-bar-user__search {
    /* background-color: blue; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-bar-user__actions {
    /* background-color: green; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: right;
    gap: 1rem;
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar.css

```css
header {
  width: 100%;
  max-width: 100vw;
  height: var(--header-height);
  position: fixed;
  top: 0;
  left: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  padding-top: 1rem;
  z-index: 1000;

  nav {
    margin: 1rem;
    width: 100%;
    height: 100%;
    background-color: var(--header);

    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 1rem;
  }
}
```

### File: apps\web\styles\components\public\explore\filters.css

```css
.explore-filters {

}
```

### File: apps\web\styles\components\search\SearchBar.css

```css
.search-bar {
  display: flex;
  align-items: center;
  gap: 0.5em;
  width: 100%;
  border-radius: var(--border-radius);
  background-color: var(--card);

  .search-bar__input {
    width: 100%;
    background: none;
    font-size: 1.5em;
    padding: 0.75em;
    outline: none;
    border: none;
  }

  .search-bar__enter {
    margin-right: 0.75em;
    height: 3.5em;
    width: 3.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--primary);
    border-radius: var(--border-radius__small);
    color: white;
  }

  &:has(.search-bar__input:focus) {
    outline: 1px solid var(--primary);
  }
}

```

### File: apps\web\styles\layouts\auth.css

```css
:root {
  main {
    margin-top: 0 !important;
  }
}

.layout-auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  width: 100vw;
  position: relative;
  overflow: hidden;
}

.background {
  position: absolute;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  object-fit: cover;
  z-index: -1;
}

.layout-auth__modal {
  width: 90vw;
  height: 90vh;
  background-color: var(--primary);
  color: white;
  border-radius: 50px;
  display: flex;
  gap: 2rem;
  position: relative;

  .layout-auth__modal__window {
    position: relative;
    top: 10px;
    left: 10px;
    height: calc(100% - 20px);
    width: 40%;
    border-radius: 40px;
    overflow: hidden;
    background-color: white;

    img {
      position: absolute;
      top: calc(-5vh - 10px);
      left: calc(-5vw - 10px);
      height: 100vh;
      width: 100vw;
      object-fit: cover;
      filter: brightness(1.2) blur(10px);
    }

    .layout-auth__modal__window__content {
      position: relative;
      height: calc(100% - 8rem);
      width: calc(100% - 8rem);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: white;
      padding: 4rem;

      .layout-auth__modal__window__content__quote__line-container {
        display: flex;
        align-items: center;
        gap: 1rem;

        .layout-auth__modal__window__content__quote__line {
          height: 2px;
          width: 30%;
          background-color: white;
        }
      }

      .layout-auth__modal__window__content__slogan {
        .deliver-better {
          margin-left: 20%;
        }
      }

      h1 {
        padding: 0;
        margin: 0;
        font-size: 3rem;
      }

      p {
        font-size: 1.2rem;
      }
    }
  }

  .layout-auth__modal__content {
    width: 60%;
    height: 100%;
    margin-right: 2rem;
  }
}

```

### File: apps\web\styles\pages\auth\login.css

```css
.login {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .login__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .login__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .login__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }
}

.login__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .login__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .login__fields__options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;

      .remember-me {
        display: flex;
        align-items: center;
        gap: 0.5rem;

        input[type="checkbox"] {
          width: 1rem;
          height: 1rem;
        }
      }

      a {
        color: white;
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }
    }
  }
}

.login__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}

```

### File: apps\web\styles\pages\auth\onboarding.css

```css
.onboarding {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 85%;


    .onboarding-stages-indicator {
        font-size: 0.8rem;
    }

    .onboarding-stages {
        width: 60%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;

        .onboarding-stage {
            position: relative;
            width: 100%;
            top: -4rem;

            display: flex;
            flex-direction: column;
            gap: 0.75em;
            width: 100%;

            .onboarding-stage__account-type__container {
                display: flex;
                gap: 0.75em;
                width: 100%;

                .onboarding-stage__account-type {
                    width: 100%;
                    background-color: #fff5;
                    color: var(--primary);
                    border-radius: var(--border-radius);
                    padding: 1rem;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                    transition: background-color var(--fast);

                    &:hover {
                        background-color: #fff4;
                    }

                    &:has(input:checked) {
                        background-color: #000;
                        color: white;
                        font-weight: bold;
                    }
                }
            }

            .onboarding-stage__separator {
                width: 100%;
                border: 1px solid #fff3;
            }

            .onboarding-stage__name {
                width: 100%;
                display: flex;
                justify-content: space-between;
                gap: 0.75em;
            }
        }
    }

    .onboarding-stage-location {
        width: 60%;
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;

        .onboarding-back,
        .onboarding-submit,
        .onboarding-continue {
            width: 100%;
            background-color: #000;
            border-radius: var(--border-radius);
            padding: 1rem;

            &:hover {
                background-color: #222;

            }
        }
    }
}
```

### File: apps\web\styles\pages\auth\register.css

```css
.register {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .register__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .register__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .register__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }

  .register__field-error {
    font-size: 0.6em;
    color: red;
  }
}

.register__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .register__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .register__fields__name {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
  }
}

.register__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}
```

### File: apps\web\styles\pages\home\hero.css

```css
#hero {
  position: relative;
  height: 100%;
  width: 100%;

  &.home__hero {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    .home__hero__bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      /* background-color: red;  */

      .home__hero__bg__image {
        position: absolute;
        top: -1%;
        left: -1%;
        width: 102%;
        height: 102%;
        object-fit: cover;
        filter: brightness(0.5) blur(5px) saturate(0.8);
      }
    }

    .home__hero__content {
      display: flex;
      flex-direction: column;
      width: 75%;

      .home__hero__content__title {
        font-size: 4rem;
        color: white;
        font-weight: 600;
      }


      .home__hero__content__search {
        .search-bar {
          background-color: #202020;
          color: white;
        }
      }

      .home__hero__content__actions {
        display: flex;
        justify-content: center;
        gap: 1em;
        margin-top: 2em;

        a {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.4em 1.5em;
          padding-right: 0.75em;
          border-radius: 2em;
          font-size: 1.25em;
          font-weight: 500;
          gap: 1em;
        }

        .home__hero__content__actions__join {
          background-color: var(--primary);
          color: white;
        }

        .home__hero__content__actions__join:hover {
          background-color: var(--primary-hover);
          box-shadow: 0 0 8px var(--primary);
        }

        .home__hero__content__actions__explore {
          background-color: #fff3;
          border: 1px solid white;
          color: white;
        }

        .home__hero__content__actions__explore:hover {
          background-color: #fff5;
          box-shadow: 0 0 8px white;
        }
      }
    }
  }
}

/* #hero .home__hero__bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -1;
  overflow: hidden;
}

#hero .home__hero__bg__image {
  position: absolute;
  top: -1%;
  left: -1%;
  width: 102%;
  height: 102%;
  object-fit: cover;
  filter: brightness(0.5) blur(5px) saturate(0.8);
}

#hero .home__hero__content {
  display: flex;
  flex-direction: column;
  width: 100%;
}

#hero .home__hero__content__title {
  font-size: 4rem;
  color: white;
  font-weight: 600;
}

#hero .home__hero__content__search .search-bar {
  background-color: #202020;
  color: white;
}

#hero .home__hero__content__actions {
  display: flex;
  justify-content: center;
  gap: 1em;
  margin-top: 2em;
}

#hero .home__hero__content__actions a {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.4em 1.5em;
  padding-right: 0.75em;
  border-radius: 2em;
  font-size: 1.25em;
  font-weight: 500;
  gap: 1em;
}

#hero .home__hero__content__actions__join {
  background-color: var(--primary);
  color: white;
}

#hero .home__hero__content__actions__join:hover {
  background-color: var(--primary-hover);
  box-shadow: 0 0 8px var(--primary);
}

#hero .home__hero__content__actions__explore {
  background-color: #fff3;
  border: 1px solid white;
  color: white;
}

#hero .home__hero__content__actions__explore:hover {
  background-color: #fff5;
  box-shadow: 0 0 8px white;
} */
```

### File: apps\web\styles\pages\home\home.css

```css
.home {
    position: relative;
    padding: 0;
    margin: 0;

    height: calc(100% + (var(--header-height) + 1rem));
    width: calc(100% + (var(--side-nav-width) + 1rem));

    top: calc((var(--header-height) + 1rem) * -1);
    left: calc((var(--side-nav-width) + 1rem) * -1);
}
```

### File: apps\web\styles\pages\public\explore\search.css

```css
.search-page__container {
    display: flex;
    justify-content: center;
}

.search-page {
    width: 90%;

    .search-page__search {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;

        .search-page__search__title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .search-page__search__related {}

        .search-page__search__search-bar {}
    }

    .search-page__options {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 2rem;

        .search-page__options__top,
        .search-page__options__bottom {
            width: 100%;
            display: flex;
            align-items: space-between;
        }

        .search-page__options__results-count,
        .search-page__options__category-type,
        .search-page__options__layout,
        .search-page__options__categories,
        .search-page__options__sort,
        .search-page__options__toggle-filter {
            width: 100%;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .search-page__options__results-count,
        .search-page__options__toggle-filter {
            justify-content: left;
        }

        .search-page__options__category-type,
        .search-page__options__categories {
            justify-content: center;
        }

        .search-page__options__sort,
        .search-page__options__layout {
            justify-content: right;
        }

        .search-page__options__top {

            .search-page__options__sort button,
            .search-page__options__toggle-filter label {
                border: 1px solid var(--text-medium);
                color: var(--text);
                padding: 0.5em 2em;
                margin: 0;
                font-size: 1rem;
                cursor: pointer;
            }

            .search-page__options__sort * {
                border-radius: var(--border-radius);
            }

            .search-page__options__toggle-filter label {
                border-radius: 2em;
            }

            .search-page__options__categories {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    border-radius: 2rem;
                    text-align: center;
                    width: 6rem;
                    cursor: pointer;
                    color: var(--text-medium);
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        font-weight: bold;
                    }
                }
            }
        }

        .search-page__options__bottom {
            .search-page__options__layout {
                display: flex;
                gap: 0.5rem;

                label {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 0.5rem;
                    height: 2rem;
                    width: 2rem;
                    padding: 0.2rem;

                    background: none;
                    border-radius: var(--border-radius);

                    outline: 1px solid var(--text-medium);
                    color: var(--text-medium);

                    cursor: pointer;

                    &:has(input:checked) {
                        background: var(--primary);
                        color: white;
                        outline: none;
                    }
                }
            }

            .search-page__options__category-type {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    text-align: center;
                    margin: 0;
                    width: 6rem;

                    background: none;

                    border-top: 1px solid var(--card);
                    color: var(--text-medium);
                    cursor: pointer;
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                        border-top: 1px solid var(--bg);
                        border-radius: var(--border-radius);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        border-top: 1px solid var(--bg);
                        font-weight: bold;
                        border-radius: var(--border-radius);
                    }
                }
            }

            .search-page__options__results-count {
                p {
                    margin: 0;
                    padding: 0;
                    font-size: 0.8rem;
                    color: var(--text-medium);
                }
            }
        }
    }

    .search-page__results {
        display: flex;
        gap: 1rem;
        position: relative;

        .search-page__results__filters__container {
            width: 20vw;
            min-width: 20rem;
            min-height: 30rem;
            height: fit-content;
            position: sticky;
            background-color: var(--header);
            top: calc(var(--header-height) + 2rem);
            border-radius: var(--border-radius__large);
            padding: 2rem;

            /* .search-page__results__filters {
                width: 100%;
                height: fit-content;
                position: sticky;
                background-color: pink;
            } */
        }

        .search-page__results__content {
            background-color: blue;
            width: 100%;
            height: 200vh;
        }
    }
}
```

### File: apps\web\styles\styles.css

```css
@import "themes/light.css";
@import "themes/dark.css";

:root {
  --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
    "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  --font-dyslexia: "OpenDyslexic", Atkinson, var(--font-sans);

  --scale: 1;

  --primary-hue: 186;
  --primary-saturation: 57%;
  --primary-lightness: 36%;

  --primary: hsl(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness));
  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 60%);

  --primary-half: hsla(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness), 0.5);

  --header-height: 4rem;
  --side-nav-width: 0;

  --border-radius__xsmall: 4px;
  --border-radius__small: 6px;
  --border-radius: 8px;
  --border-radius__large: 12px;
  --border-radius__xlarge: 16px;

  --fast: 100ms;
  --medium: 200ms;
  --slow: 300ms;

  background-color: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);

  [data-sidebar-open] {
    --side-nav-width: 4rem;

  }

  [data-sidebar-open='true'] {
    --side-nav-width: 14rem;
  }
}

body {
  width: 100%;
  margin: 0;
  padding: 0;

  main {
    position: relative;
    margin: 0;
    padding: 0;
  }
}

.container {
  position: relative;
  height: calc(100vh - (var(--header-height) + 1rem));
  width: calc(100vw - (var(--side-nav-width) + 2.1rem));
  top: calc(var(--header-height) + 1rem);
  left: calc(var(--side-nav-width) + 1rem);
}

a {
  text-decoration: none;
  color: inherit;
  transition: all var(--fast);
}

input,
button {
  font-family: inherit;
  border: none;
  background: none;
  color: inherit;
  outline: none;
  border: none;
}

button {
  cursor: pointer;
  transition: all var(--fast);
}

[data-tooltip] {
  position: relative;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  top: calc(100% + 0.5rem);
  transform: translateX(-50%);
  color: var(--text-medium);
  background-color: var(--card);
  border: 1px solid var(--card-light);
  border-radius: var(--border-radius);
  padding: 0.25rem 1rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity var(--fast) ease;
  z-index: 100;
  font-size: 0.75rem;
}

[data-tooltip]:hover::before {
  opacity: 1;
}
```

### File: apps\web\styles\themes\dark.css

```css
:root[data-theme="dark"] {
  --bg: #222222;
  --header: #191919;
  --text: #ffffff;
  --text-medium: #999;
  --text-dark: #555555;
  --card: #303030;
  --card-dark: #202020;
  --card-light: #555555;
  --button-hover: #fff2;
  --button-hover-light: #fff6;

  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
  --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-highlight-active: hsl(var(--primary-hue),
      var(--primary-saturation),
      55%);
}
```

### File: apps\web\styles\themes\dim.css

```css

```

### File: apps\web\styles\themes\dyslexia.css

```css

```

### File: apps\web\styles\themes\high-contrast.css

```css

```

### File: apps\web\styles\themes\light.css

```css
:root {
    --bg: #f0f0f0;
    --header: #ffffff;
    --text: #000000;
    --text-medium: #999;
    --text-dark: #BBBBBB;
    --card: #dfdfdf;
    --card-dark: #202020;
    --card-light: #555555;
    --button-hover: #0002;
    --button-hover-light: #0006;

    --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
    --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
    --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
    --primary-highlight-active: hsl(var(--primary-hue),
            var(--primary-saturation),
            55%);
}
```

### File: apps\web\styles\themes\reduce-motion.css

```css

```

### File: apps\web\styles\themes\sepia.css

```css

```

### File: apps\web\tests\api\auth\login_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { loginWithEmail } from '../../../server/auth/email/login.ts';

type FakeAuthReturn =
	| { data: { user: unknown; session: unknown }; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>) {
	return {
		auth: {
			signInWithPassword: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: {
			signInWithPassword: (a: { email: string; password: string }) => Promise<FakeAuthReturn>;
		};
	};
}

Deno.test({
	name: 'loginWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await loginWithEmail({ email: 'nope', password: 'whatever' });
		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'loginWithEmail: invalid credentials -> 401',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Invalid login credentials', code: 'invalid_credentials', status: 401 },
		}));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'wrong' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'invalid_credentials');
		assertEquals(res.error.status, 401);
	},
});

Deno.test({
	name: 'loginWithEmail: success returns user+session',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const data = {
			user: { id: crypto.randomUUID(), email: 'a@example.com' },
			session: { access_token: 'token', expires_in: 3600 },
		};
		const client = fakeClient(async () => ({ data, error: null }));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data.user, data.user);
		assertEquals(res.data.session, data.session);
	},
});

```

### File: apps\web\tests\api\auth\register_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { registerWithEmail } from '../../../server/auth/email/register.ts';

type FakeAuthReturn =
	| { data: unknown; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(
	impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>,
) {
	return {
		auth: {
			signUp: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: { signUp: (a: { email: string; password: string }) => Promise<FakeAuthReturn> };
	};
}

Deno.test({
	name: 'registerWithEmail: missing email/password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: '', password: '' } as unknown as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'not-an-email', password: 'secret123!' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: short password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'a@example.com', password: 'short' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: propagates Supabase error (e.g., rate_limit 429)',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Email rate limit exceeded', code: 'rate_limit', status: 429 },
		}));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'rate_limit');
		assertEquals(res.error.status, 429);
	},
});

Deno.test({
	name: 'registerWithEmail: success returns ok and data',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const user = {
			user: { id: '00000000-0000-0000-0000-000000000000', email: 'a@example.com' },
			session: null,
		};
		const client = fakeClient(async () => ({ data: user, error: null }));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data, user as unknown);
	},
});

Deno.test({
	name: 'registerWithEmail: thrown error -> unknown_error',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{
				getClient: async () => {
					throw new Error('boom');
				},
			},
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'unknown_error');
	},
});

```

### File: apps\web\tests\api\meta\health.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import * as Health from '../../../routes/api/v1/meta/health.ts';

const GET = (Health as unknown as {
	GET?: (r: Request) => Promise<Response>;
	handler?: { GET: (r: Request) => Promise<Response> };
}).GET ??
	(Health as unknown as { handler?: { GET: (r: Request) => Promise<Response> } }).handler?.GET;

const HEAD = (Health as unknown as {
	HEAD?: (r: Request) => Promise<Response>;
	handler?: { HEAD: (r: Request) => Promise<Response> };
}).HEAD ??
	(Health as unknown as { handler?: { HEAD: (r: Request) => Promise<Response> } }).handler?.HEAD;

if (typeof GET !== 'function') {
	throw new Error('Health GET handler not found (expected export GET or handler.GET).');
}
if (typeof HEAD !== 'function') {
	throw new Error('Health HEAD handler not found (expected export HEAD or handler.HEAD).');
}

Deno.test({
	name: 'GET /api/v1/meta/health returns a valid payload',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'GET' });
		const res = await GET(req);

		assertEquals(res.status, 200);
		assert(res.headers.get('content-type')?.includes('application/json'));

		const json = await res.json() as {
			status: string;
			service: string;
			version: string;
			uptime_ms: number;
			started_at: string;
			commit?: string;
			env: string;
		};

		assertEquals(json.status, 'ok');
		assert(typeof json.service === 'string' && json.service.length > 0);
		assert(typeof json.version === 'string');
		assert(Number.isFinite(json.uptime_ms) && json.uptime_ms >= 0);
		assert(!Number.isNaN(Date.parse(json.started_at)));
		assert(typeof json.env === 'string');
	},
});

Deno.test({
	name: 'HEAD /api/v1/meta/health is fast and empty',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'HEAD' });
		const res = await HEAD(req);

		assertEquals(res.status, 200);
		const body = await res.text();
		assertEquals(body, '');
		assert(res.headers.get('cache-control')?.includes('no-store'));
	},
});

```

### File: apps\web\tests\unit\math.test.ts

```ts
import { assertEquals } from '../_helpers/asserts.ts';

Deno.test({
	name: 'add()',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	fn() {
		const add = (a: number, b: number) => a + b;
		assertEquals(add(2, 3), 5);
	},
});

```

### File: apps\web\tests\_helpers\asserts.ts

```ts
export { assert, assertEquals, assertMatch, assertRejects, assertStrictEquals } from '@std/assert';

export { restore, stub } from '@std/testing/mock';

```

### File: apps\web\tests\_helpers\request.ts

```ts
type HttpMethod = 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
type RouteHandler = (req: Request) => Promise<Response> | Response;

export async function call(handler: RouteHandler, init?: RequestInit) {
	const req = new Request('http://localhost/test', init);
	const res = await handler(req);
	const body = await res.text();
	const json = safeJson(body);
	return { res, body, json };
}

function safeJson(s: string) {
	try {
		return JSON.parse(s);
	} catch {
		return undefined;
	}
}

export function json(method: HttpMethod, data?: unknown, headers: HeadersInit = {}) {
	return {
		method,
		headers: { 'content-type': 'application/json', ...headers },
		body: data === undefined ? undefined : JSON.stringify(data),
	} satisfies RequestInit;
}

```

### File: apps\web\utils.ts

```ts
// apps/web/utils/index.ts
import { createDefine } from 'fresh';

// Per-request state (you can mutate its fields)
export interface State {
	shared?: string;

	// Auth middleware flags
	refreshedTokens?: { access: string; refresh: string } | null;
	clearAuth?: boolean;
	isAuthenticated?: boolean;
	isOnboarded?: boolean;
}

export const define = createDefine<State>();

```

### File: codebase_context.md

```md
# Project Codebase Context

## Project Tree

```text
apps/
web/
client.ts
components/
auth/
buttons/
fields/
navigation/
public/
search/
Theme.tsx
contracts/
account/
auth/
navigation.ts
public/
islands/
NavBar.tsx
pages/
main.ts
routes/
(auth)/
(dashboard)/
(public)/
api/
_app.tsx
_middleware.ts
server/
auth/
core/
dashboard/
env.ts
middleware/
public/
static/
favicon.ico
logo.svg
styles/
components/
layouts/
pages/
styles.css
themes/
svg/
tests/
api/
unit/
_helpers/
types/
dashboard/
public/
utils.ts
db/
functions/
auth_project_or_dm_participant.sql
migrations/
0001_init_schemas.sql
0002_security_tables.sql
0003_org_tables.sql
0004_ops_tables.sql
0005_projects_tables.sql
0006_comms_tables.sql
0007_finance_tables.sql
0020_helpers_functions.sql
policies/
comms/
finance/
marketplace/
org/
business_profiles.sql
freelancer_profiles.sql
teams.sql
team_memberships.sql
users_public.sql
user_emails.sql
projects/
security/
audit_logs.sql
refresh_tokens.sql
session_context.sql
v_current_context.sql
storage/
scripts/
diff.sh
dump.sh
restore.sh
seeds/
views/
analytics_earnings_by_stage_mv.sql
security/
v_current_context.sql
deno.json
deno.lock
docs/
01_Vision.md
02_Features.md
03_TechStack.md
04_Roadmap.md
05_Security.md
06_InvestorSummary.md
07_UserStories.md
08_UserFlows.md
09_Tables.md
10_APIEndpints.md
11_Storage.md
12_RLS.md
13_FolderStructure.md
14_Sitemap.md
api/
README.md
architecture/
README.md
product/
README.md
uml.png
uml.svg
infra/
cf/
README.md
deno/
README.md
stripe/
README.md
LICENSE
packages/
lib/
README.md
sdk/
README.md
types/
ui/
components/
hooks/
providers/
README.md
themes/
utils/
ThemeSwitcher.ts
utils/
auth/
register.ts
parser/
server/
cookies.ts
crypto.ts
env.ts
index.ts
jwt.ts
rateLimiter.ts
token.ts
wasm/
image_ops/
README.md
pack_project.ts
Projective Logo - White.png
Projective Logo.png
Projective Logo.svg
README.md
scripts/
dev.sh
setup.sh
test.sh
validate_names.ts
setup.ps1
supabase/
cli-latest
config/
README.md
edge-functions/
README.md
storage-rules/
README.md
testing.env.test
vite.config.ts
```

## File Contents

### File: apps\web\client.ts

```ts
import '@styles/styles.css';

```

### File: apps\web\components\auth\GitHubRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGithub } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/github/github-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGithub />
				{loading ? 'Connecting…' : 'Continue with GitHub'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleLoginButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleLoginButton({ redirectTo = '/' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-login?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\GoogleRegisterButton.tsx

```tsx
import '@styles/components/auth/provider-login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { IconBrandGoogle } from '@tabler/icons-preact';

type Props = { redirectTo?: string };

export default function GoogleRegisterButton({ redirectTo = '/verify' }: Props) {
	const [loading, setLoading] = useState(false);
	const [err, setErr] = useState<string | null>(null);

	const handleClick = useCallback(() => {
		if (loading) return;
		setErr(null);
		setLoading(true);

		try {
			const params = new URLSearchParams({
				next: redirectTo || '/',
			});
			const startUrl = `/api/v1/auth/google/google-register?${params.toString()}`;

			globalThis.location.assign(startUrl);
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'Unknown error starting OAuth';
			setErr(msg);
			console.error('OAuth start exception', e);
			globalThis.dispatchEvent(
				new CustomEvent('auth:error', { detail: { stage: 'oauth_start', error: String(msg) } }),
			);
			setLoading(false);
		}
	}, [loading, redirectTo]);

	return (
		<div class='w-full'>
			<button
				type='button'
				onClick={handleClick}
				disabled={loading}
				class='provider-login-button'
				aria-busy={loading}
				aria-label='Continue with Google'
			>
				<IconBrandGoogle />
				{loading ? 'Connecting…' : 'Continue with Google'}
			</button>
			{err && (
				<p role='alert' aria-live='polite' class='mt-2 text-sm text-red-600'>
					{err}
				</p>
			)}
		</div>
	);
}

```

### File: apps\web\components\auth\LoginButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import { Signal } from '@preact/signals';

type Props = {
	redirectTo?: string;
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
};

export default function LoginButton({ redirectTo = '/', email, password }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/email/login', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: email, password: password }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Login success:', data);
				globalThis.location.href = data.redirectTo;
			} else {
				const c = await response.json();
				console.error('Login failed:', response);
				console.error('Login failed:', c.error.code);
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='login-button'
		>
			{loading ? 'Connecting…' : 'Log In'}
		</button>
	);
}

```

### File: apps\web\components\auth\OnboardingSubmit.tsx

```tsx
// apps/web/islands/auth/OnboardingSubmit.tsx
import { useCallback, useState } from 'preact/hooks';
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { getCsrfToken } from '@server/auth/cookies.ts';

export default function OnboardingSubmit({
	firstName,
	lastName,
	username,
	type,
}: OnboardingRequest) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const csrf = getCsrfToken();

			if (!csrf) {
				setLoading(false);
				return;
			}

			const response = await fetch('/api/v1/auth/onboarding', {
				method: 'POST',
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json',
					'X-CSRF': csrf,
				},
				body: JSON.stringify({ firstName, lastName, username, type }),
			});

			if (!response.ok) {
				const errorBody = await response.json().catch(() => null);
				console.error('Onboarding failed:', errorBody ?? response.statusText);
				return;
			}

			const data = await response.json();
			console.log('Onboarding success:', data);
			// globalThis.location.href = '/dashboard';
		} catch (err) {
			console.error('Onboarding error:', err);
		} finally {
			setLoading(false);
		}
	}, [loading, firstName, lastName, username, type]);

	return (
		<button
			type='button'
			class='onboarding-submit'
			onClick={handleClick}
			disabled={loading}
			aria-busy={loading}
			aria-label='Create Profile'
		>
			{loading ? 'Saving…' : 'Continue'}
		</button>
	);
}

```

### File: apps\web\components\auth\RegisterButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';
import RegisterWithEmail from 'packages/utils/auth/register.ts';
import { computed, Signal } from '@preact/signals';

type Props = {
	email: Signal<string | undefined>;
	password: Signal<string | undefined>;
	confirmPassword: Signal<string | undefined>;
};

export default function RegisterButton({
	email,
	password,
	confirmPassword,
}: Props) {
	const [loading, setLoading] = useState(false);

	const hasErrors = computed(() => {
		const e = (email.value || '').trim();
		const p = (password.value || '').trim();
		const c = (confirmPassword.value || '').trim();

		const v = RegisterWithEmail.validate({
			email: e,
			password: p,
			confirmPassword: c,
		}).ok;

		return !v;
	});

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const e = (email.value || '').trim();
			const p = (password.value || '').trim();
			const c = (confirmPassword.value || '').trim();

			const { ok } = RegisterWithEmail.validate({
				email: e,
				password: p,
				confirmPassword: c,
			});

			if (!ok) return;

			const response = await fetch('/api/v1/auth/email/register', {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: e, password: p }),
			});

			if (response.ok) {
				const data = await response.json();
				console.log('Registration success:', data);
				globalThis.location.href = '/verify';
			} else {
				console.error('Registration failed:', response);
			}
		} finally {
			setLoading(false);
		}
	}, [loading, email, password, confirmPassword]);

	return (
		<button
			type='button'
			class='login-button'
			onClick={handleClick}
			disabled={hasErrors.value}
			aria-busy={loading}
			aria-label='Create account'
		>
			{loading ? 'Connecting…' : 'Create Account'}
		</button>
	);
}

```

### File: apps\web\components\auth\ResendButton.tsx

```tsx
import '@styles/components/auth/login-button.css';
import { useCallback, useState } from 'preact/hooks';

type Props = {
	email: string | undefined;
};

export default function ResendButton({ email }: Props) {
	const [loading, setLoading] = useState(false);

	const handleClick = useCallback(async () => {
		if (loading) return;
		setLoading(true);

		try {
			const response = await fetch('/api/v1/auth/resend', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email }),
			});

			if (response.ok) {
				const data = await response.json();
			} else {
				const c = await response.json();
			}
		} finally {
			setLoading(false);
		}
	}, [loading]);

	return (
		<button
			type='button'
			onClick={handleClick}
			disabled={loading}
			class='verify-button'
		>
			Resend verification email
		</button>
	);
}

```

### File: apps\web\components\fields\DropdownField.tsx

```tsx
import '@styles/components/fields/DropdownField.css';
import { Icon, IconChevronDown, IconX } from '@tabler/icons-preact';
import { Signal } from '@preact/signals';

export interface IDropdownItem {
	icon?: Icon | string;
	value: string;
	displayName?: string;
	label?: string;
}

export interface IDropdownFieldOptions {
	multiselect?: boolean;
	searchable?: boolean;
}

export interface IDropdownField {
	values: IDropdownItem[];
	defaultValues?: IDropdownItem[];
	selected?: Signal<IDropdownItem[]>;
	placeholder?: string;
	name?: string;
	options?: IDropdownFieldOptions;
}

export default function DropdownField(
	{ values, placeholder, selected, name, defaultValues, options }: IDropdownField,
) {
	const testClick = () => {
		console.log('dropdown-field__button click');
	};

	const testClick2 = () => {
		console.log('dropdown-field__selected__item__close click');
	};

	return (
		<div class='dropdown-field__container'>
			<div class='dropdown-field__input'>
				{
					/* <div class='dropdown-field__input__selected'>
					<div class='dropdown-field__input__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__input__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div> */
				}

				<button type='button' class='dropdown-field__input__button' onClick={() => testClick()}>
					{options?.searchable
						? (
							<input
								type='text'
								class='dropdown-field__input__button__input'
								placeholder={placeholder}
							/>
						)
						: <span class='dropdown-field__input__button__span'>{placeholder}</span>}

					<IconChevronDown />
				</button>
			</div>

			<div class='dropdown-field__selected__container'>
				<div class='dropdown-field__selected'>
					<div class='dropdown-field__selected__item'>
						<span>Value</span>
						<button
							type='button'
							class='dropdown-field__selected__item__close'
							onClick={() => testClick2()}
						>
							<IconX />
						</button>
					</div>
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\components\fields\DualSliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\FormStages.tsx

```tsx
import '@styles/components/fields/FormStages.css';

export interface IFormStages {
	stage: number;
	stages: string[];
}

export default function FormStages({ stage, stages }: IFormStages) {
	return (
		<div class='form-stages'>
			{stages.map((stg, index) => {
				return (
					<>
						<div class='form-stages__item' data-selected={stage === index + 1}>
							<div class='form-stages__item__container'>
								<div class='form-stages__item__circle'>
									<p>
										{index + 1}
									</p>
								</div>
								<p class='form-stages__item__name'>{stg}</p>
							</div>

							{index != stages.length - 1 &&
								<hr class='form-stages__item__divider' />}
						</div>
					</>
				);
			})}
		</div>
	);
}

```

### File: apps\web\components\fields\PasswordField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';
import { IconEye, IconEyeClosed } from '@tabler/icons-preact';
import { signal } from '@preact/signals';

const type = signal<boolean>(true);

export default function PasswordField(props: InputHTMLAttributes<HTMLInputElement>) {
	const toggleVisibility = () => {
		type.value = !type.value;
	};

	return (
		<span class='password-field'>
			<input type={type.value ? 'password' : 'text'} {...props} />
			<button
				type='button'
				onClick={toggleVisibility}
				class='password-field__toggle-visibility'
			>
				{type.value ? <IconEyeClosed /> : <IconEye />}
			</button>
		</span>
	);
}

```

### File: apps\web\components\fields\RatingField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\RichTextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null },
) {
	return (
		<div class='text-field__container'>
			<small>{props.error}</small>
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
		</div>
	);
}

```

### File: apps\web\components\fields\SliderField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextAreaField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextAreaField(
	props: InputHTMLAttributes<HTMLTextAreaElement> & {
		error?: string | null;
		field?: string | null;
	},
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-area-field'>
				<textarea {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\fields\TextField.tsx

```tsx
import { InputHTMLAttributes } from 'preact';
import '@styles/components/fields/TextField.css';

export default function TextField(
	props: InputHTMLAttributes<HTMLInputElement> & { error?: string | null; field?: string | null },
) {
	return (
		<div class='text-field__container'>
			{props.field && <p>{props.field}</p>}
			<span class='text-field'>
				<input type='text' {...props} />
			</span>
			<small>{props.error}</small>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarGuest.tsx

```tsx
import '@styles/components/navigation/nav-bar-guest.css';
import { theme } from '../../../../packages/ui/utils/ThemeSwitcher.ts';

export default function NavBarGuest() {
	const switchTheme = () => {
		if (theme.value === 'light') {
			theme.value = 'dark';
		} else {
			theme.value = 'light';
		}
	};

	return (
		<div class='header-container'>
			<div class='header__logo'>
				<h1>Projective</h1>
			</div>
			<div class='header__buttons'>
				<button type='button'>search</button>
				<button type='button' onClick={() => switchTheme()}>{theme.value}</button>
				<a href='#'>Explore</a>
				<a class='header__buttons__user header__buttons__login' href='/login'>Login</a>
				<a class='header__buttons__user header__buttons__join' href='/register'>Join</a>
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUser.tsx

```tsx
import '@styles/components/navigation/nav-bar-user.css';
import { IconBell } from '@tabler/icons-preact';
import NavBarUserProfile from './profile/NavBarUserProfile.tsx';

export default function NavBarUser() {
	return (
		<div class='nav-bar-user'>
			<div class='nav-bar-user__logo'>
				<img class='nav-bar-user__logo__svg' src='/logo.svg' alt='Logo' />
				<h1>Projective</h1>
			</div>
			<div class='nav-bar-user__search'>
				<h1>Logo</h1>
			</div>
			<div class='nav-bar-user__actions'>
				<IconBell />
				<NavBarUserProfile />
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\NavBarUserSide.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-side.css';
import { apps } from '@contracts/navigation.ts';
import { IconLayoutSidebarLeftCollapse, IconLayoutSidebarLeftExpand } from '@tabler/icons-preact';
import { useEffect, useState } from 'preact/hooks';
import { signal } from '@preact/signals';

const open = signal(false);

export default function NavBarUserSide() {
	const navApps = apps;
	const [selected, setSelected] = useState('');

	useEffect(() => {
		const loc = globalThis.location.pathname.substring(1).split('/')[0];
		setSelected(`/${loc.trim()}`);
	}, [globalThis.location]);

	const handleButtonClick = (_: MouseEvent) => {
		open.value = !open.value;
	};

	return (
		<aside class='nav-bar-user-side' data-sidebar-open={open.value}>
			<nav class='nav-bar-user-side__container'>
				{navApps.map((group) => {
					return (
						<div class='nav-bar-user-side__group'>
							{group.map((app) => {
								return (
									<a
										class='nav-bar-user-side__app'
										href={app.link}
										data-selected={selected === app.link}
										data-tooltip={app.name}
									>
										<app.icon />
										{open.value && <span>{app.name}</span>}
									</a>
								);
							})}
							<hr />
						</div>
					);
				})}
				<button type='button' class='nav-bar-user-side__open' onClick={handleButtonClick}>
					{open.value ? <IconLayoutSidebarLeftCollapse /> : <IconLayoutSidebarLeftExpand />}
				</button>
			</nav>
		</aside>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfile.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile.css';
import NavBarUserProfileDropdown from './NavBarUserProfileDropdown.tsx';
import { signal } from '@preact/signals';
import { useEffect, useRef } from 'preact/hooks';

const open = signal(false);

export default function NavBarUserProfile() {
	const rootRef = useRef<HTMLDivElement | null>(null);

	useEffect(() => {
		const handleClickOutside = (event: MouseEvent) => {
			const root = rootRef.current;
			if (!root) return;
			if (root.contains(event.target as Node)) return;
			open.value = false;
		};

		document.addEventListener('click', handleClickOutside);
		return () => {
			document.removeEventListener('click', handleClickOutside);
		};
	}, []);

	const handleButtonClick = (event: MouseEvent) => {
		console.log('huh');
		event.stopPropagation();
		open.value = !open.value;
	};

	return (
		<div class='nav-bar-user__profile' ref={rootRef}>
			<button
				type='button'
				class='nav-bar-user__profile__btn'
				onClick={handleButtonClick}
			>
				<div class='nav-bar-user__profile__btn__img'>
					<img src='https://placehold.co/50x50' />
				</div>
			</button>

			{open.value && (
				<div
					class='nav-bar-user__profile__dropdown-wrapper'
					tabIndex={0}
					onClick={(event: MouseEvent) => event.stopPropagation()}
				>
					<NavBarUserProfileDropdown />
				</div>
			)}
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdown.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown.css';
import { IconArrowsLeftRight, IconUser } from '@tabler/icons-preact';
import NavBarUserProfileDropdownActions from './NavBarUserProfileDropdownActions.tsx';
import NavBarUserProfileDropdownSwitch from './NavBarUserProfileDropdownSwitch.tsx';
import { signal } from '@preact/signals';

const switchView = signal(true);

export default function NavBarUserProfileDropdown() {
	return (
		<div class='nav-bar-user__profile__dropdown'>
			<div class='nav-bar-user__profile__dropdown__current'>
				<div class='nav-bar-user__profile__dropdown__current__profile'>
					<img src='https://placehold.co/50x50' />
					<div class='nav-bar-user__profile__dropdown__current__profile__name'>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__name'>bla</p>
						<p class='nav-bar-user__profile__dropdown__current__profile__name__username'>bla</p>
					</div>
				</div>
				<button
					type='button'
					class='nav-bar-user__profile__dropdown__current__switch'
					data-tooltip={switchView.value ? 'Switch Account' : 'Account Actions'}
					onClick={() => switchView.value = !switchView.value}
				>
					{switchView.value ? <IconArrowsLeftRight /> : <IconUser />}
				</button>
			</div>
			<div>
				{switchView.value
					? <NavBarUserProfileDropdownActions />
					: <NavBarUserProfileDropdownSwitch />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownActions.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-actions.css';

export default function NavBarUserProfileDropdownActions() {
	return (
		<div class='nav-bar-user__profile__dropdown__actions'>
			<a>Profile</a>
			<a>Log Out</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownBusiness.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-business.css';

export default function NavBarUserProfileDropdownBusiness() {
	return (
		<div class='nav-bar-user__profile__dropdown__business'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Business
			</a>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownSwitch.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-switch.css';
import { signal } from '@preact/signals';
import NavBarUserProfileDropdownTeams from './NavBarUserProfileDropdownTeams.tsx';
import NavBarUserProfileDropdownBusiness from './NavBarUserProfileDropdownBusiness.tsx';

const switchView = signal(false);

export default function NavBarUserProfileDropdownSwitch() {
	return (
		<div class='nav-bar-user__profile__dropdown__switch'>
			<div class='nav-bar-user__profile__dropdown__switch__switch'>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--teams'
						value='teams'
						onInput={() => switchView.value = false}
						checked={switchView.value == false}
						hidden
					/>
					Teams
				</label>
				<label class='nav-bar-user__profile__dropdown__switch__label'>
					<input
						type='radio'
						class='nav-bar-user__profile__dropdown__switch__input'
						name='nav-bar-user__profile__dropdown__switch__input'
						id='nav-bar-user__profile__dropdown__switch__input--business'
						value='business'
						onInput={() => switchView.value = true}
						checked={switchView.value == true}
						hidden
					/>
					Business
				</label>
			</div>
			<hr />
			<div class='nav-bar-user__profile__dropdown__switch__account-type'>
				{!switchView.value
					? <NavBarUserProfileDropdownTeams />
					: <NavBarUserProfileDropdownBusiness />}
			</div>
		</div>
	);
}

```

### File: apps\web\components\navigation\profile\NavBarUserProfileDropdownTeams.tsx

```tsx
import '@styles/components/navigation/nav-bar-user-profile-dropdown-teams.css';

export default function NavBarUserProfileDropdownTeams() {
	return (
		<div class='nav-bar-user__profile__dropdown__teams'>
			<a class='nav-bar-user__profile__dropdown__add'>
				+ Add Team
			</a>
		</div>
	);
}

```

### File: apps\web\components\public\explore\Filters.tsx

```tsx
import '@styles/components/public/explore/filters.css';
import DropdownField from '../../fields/DropdownField.tsx';

export default function ExploreFilters() {
	return (
		<div class='explore-filters'>
			<DropdownField values={[]} placeholder='Skills' options={{ searchable: true }} />
		</div>
	);
}

```

### File: apps\web\components\public\explore\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\search\SearchBar.tsx

```tsx
import '@styles/components/search/SearchBar.css';
import { IconSearch } from '@tabler/icons-preact';

export default function SearchBar() {
	return (
		<div class='search-bar'>
			<input class='search-bar__input' type='text' placeholder='Search Projects...' />
			<button class='search-bar__enter' type='submit'>
				<IconSearch />
			</button>
		</div>
	);
}

```

### File: apps\web\components\Theme.tsx

```tsx

```

### File: apps\web\contracts\auth\login.ts

```ts
export interface LoginWithEmailRequest {
	email: string;
	password: string;
}

```

### File: apps\web\contracts\auth\onboading.ts

```ts
export interface OnboardingRequest {
	firstName: string;
	lastName: string;
	username: string;
	type: 'freelancer' | 'client';
}

```

### File: apps\web\contracts\auth\register.ts

```ts
export interface RegisterWithEmailRequest {
	email: string;
	password: string;
}

export interface RegisterWithEmailResponse {
	data: {
		user: {
			id: string;
			aud: string;
			role: string;
			email: string;
			email_confirmed_at: string;
			phone: string;
			last_sign_in_at: string;
			app_metadata: {
				provider: string;
				providers: string[];
			};
			user_metadata: {};
			identities: [
				{
					identity_id: string;
					id: string;
					user_id: string;
					identity_data: {
						email: string;
						email_verified: string;
						phone_verified: string;
						sub: string;
					};
					provider: string;
					last_sign_in_at: string;
					created_at: string;
					updated_at: string;
					email: string;
				},
			];
			created_at: string;
			updated_at: string;
		};
		session: {
			access_token: string;
			token_type: string;
			expires_in: number;
			expires_at: number;
			refresh_token: string;
			user: {
				id: string;
				aud: string;
				role: string;
				email: string;
				email_confirmed_at: string;
				phone: string;
				last_sign_in_at: string;
				app_metadata: {
					provider: string;
					providers: string[];
				};
				user_metadata: {};
				identities: [
					{
						identity_id: string;
						id: string;
						user_id: string;
						identity_data: {
							email: string;
							email_verified: false;
							phone_verified: false;
							sub: string;
						};
						provider: string;
						last_sign_in_at: string;
						created_at: string;
						updated_at: string;
						email: string;
					},
				];
				created_at: string;
				updated_at: string;
			};
		};
	};
	error: string | null;
}

```

### File: apps\web\contracts\navigation.ts

```ts
import {
	Icon,
	IconBriefcase,
	IconBuilding,
	IconChartLine,
	IconCompass,
	IconHome,
	IconMessages,
	IconPlug,
	IconSettings,
	IconUsers,
	IconWallet,
} from '@tabler/icons-preact';

export interface INavApp {
	icon: Icon;
	name: string;
	link: string;
}

export const apps1: INavApp[] = [
	{
		icon: IconHome,
		name: 'Dashboard',
		link: '/dashboard',
	},
	{
		icon: IconCompass,
		name: 'Explore',
		link: '/explore',
	},
	{
		icon: IconMessages,
		name: 'Messages',
		link: '/messages',
	},
];

export const apps2: INavApp[] = [
	{
		icon: IconBriefcase,
		name: 'Projects',
		link: '/projects',
	},
	{
		icon: IconUsers,
		name: 'Teams',
		link: '/teams',
	},
	{
		icon: IconBuilding,
		name: 'Businesses',
		link: '/businesses',
	},
];

export const apps3: INavApp[] = [
	{
		icon: IconChartLine,
		name: 'Analytics',
		link: '/analytics',
	},
	{
		icon: IconWallet,
		name: 'Earnings',
		link: '/earnings',
	},
	{
		icon: IconSettings,
		name: 'Settings',
		link: '/settings',
	},
];

export const apps = [apps1, apps2, apps3];

```

### File: apps\web\contracts\public\IExploreCategories.ts

```ts
// packages/lib/search/explore/explore-categories.ts
// Explore-specific categories, subcategories, and sort options.

export type ExploreCategory = 'work' | 'resources' | 'projects';

export type ExploreSubcategory =
	| 'services'
	| 'freelancers'
	| 'teams'
	| 'templates'
	| 'products'
	| 'articles'
	| 'courses'
	| 'projects';

export type IExploreRequestSortBy =
	| 'recommended'
	| 'newest'
	| 'oldest'
	| 'mostPopular'
	| 'highestRated'
	| 'lowestRated'
	| 'priceLowToHigh'
	| 'priceHighToLow';

// Compile-time mapping from subcategory → category.
// This is purely a type-level mapping, no runtime code.
export type ExploreCategoryForSubcategory<S extends ExploreSubcategory> = S extends
	| 'services'
	| 'freelancers'
	| 'teams' ? 'work'
	: S extends 'projects' ? 'projects'
	: 'resources';

```

### File: apps\web\contracts\public\IExploreFacets.ts

```ts
// packages/lib/search/explore/explore-facets.ts
// Facet / aggregation models that you use to build filters from result sets.

export interface NumericFacet {
	min: number | null;
	max: number | null;
	avg?: number | null;
}

export interface TermFacetBucket {
	value: string;
	count: number;
}

export type TermFacet = TermFacetBucket[];

// Generic facets bag. You can extend this per endpoint if needed via generics.
export interface ExploreFacets {
	// money
	price?: NumericFacet;
	hourlyRate?: NumericFacet;
	budget?: NumericFacet;

	// common categorical facets
	languages?: TermFacet;
	skills?: TermFacet;
	countries?: TermFacet;
	timezones?: TermFacet;
	topics?: TermFacet;
	serviceCategories?: TermFacet;
	productTypes?: TermFacet;
	licenseTypes?: TermFacet;

	// allow extension without changing this file
	[key: string]: NumericFacet | TermFacet | undefined;
}

// Generic response wrapper for any explore endpoint.
export interface ExploreResponse<
	TItem,
	TFacets extends ExploreFacets = ExploreFacets,
> {
	items: TItem[];
	page: number;
	pageSize: number;
	total: number;
	facets: Partial<TFacets>;
}

```

### File: apps\web\contracts\public\IExploreFilters.ts

```ts
// packages/lib/search/explore/explore-filters.ts
// Explore-specific filter models (no request/response shapes here).

// ---- Filter atoms ----

export interface PriceRangeFilter {
	minPriceCents?: number;
	maxPriceCents?: number;
	currency?: string; // 'GBP', 'USD', etc.
}

export interface HourlyRateFilter {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	currency?: string;
}

export interface RatingFilter {
	minRating?: number; // 1–5
	maxRating?: number; // rarely used but available
}

export interface LocationFilter {
	countries?: string[]; // ISO codes or canonical names
	timezones?: string[]; // 'Europe/London', etc.
	remoteOnly?: boolean;
}

export interface LanguageFilter {
	languages?: string[]; // matches your text[] language fields
}

export interface SkillsFilter {
	skills?: string[]; // skill slugs/ids
	minSkillScore?: number; // optional if you ever store skill proficiency
}

export interface AvailabilityFilter {
	availability?:
		| 'immediate'
		| 'thisWeek'
		| 'nextWeek'
		| 'scheduled';
}

export interface MetaFilter {
	minCompletedProjects?: number;
	minSales?: number;
}

export interface BudgetRangeFilter {
	minBudgetCents?: number;
	maxBudgetCents?: number;
	currency?: string;
}

// ---- Work (services / freelancers / teams) ----

export interface WorkBaseFilters
	extends
		PriceRangeFilter,
		RatingFilter,
		LocationFilter,
		LanguageFilter,
		SkillsFilter,
		AvailabilityFilter,
		MetaFilter {
	topics?: string[]; // 'design', 'marketing', etc.
}

export interface ServicesFilters extends WorkBaseFilters {
	serviceCategoryIds?: string[]; // taxonomy table / search topics
	durationMinutesMax?: number; // for calls / sessions
}

export interface FreelancerFilters extends WorkBaseFilters {
	minHourlyRateCents?: number;
	maxHourlyRateCents?: number;
	minPortfolioItems?: number;
}

export interface TeamFilters extends WorkBaseFilters {
	minTeamSize?: number;
	maxTeamSize?: number;
	requireMultipleRoles?: boolean;
}

// ---- Resources (templates / products / articles / courses) ----

export interface ResourceBaseFilters extends PriceRangeFilter, RatingFilter, LanguageFilter {
	topics?: string[];
	formats?: string[]; // 'figma', 'pdf', 'notion', 'video', etc.
}

export interface TemplatesFilters extends ResourceBaseFilters {
	templateType?: string[]; // 'landing-page', 'saas-ui', ...
	requiresCode?: boolean;
}

export interface ProductsFilters extends ResourceBaseFilters {
	productType?: string[]; // 'theme', 'component-library', etc.
	licenseType?: string[]; // 'full_rights', 'template_only', ...
	digitalOnly?: boolean;
}

export interface ArticlesFilters extends ResourceBaseFilters {
	readTimeMinutesMax?: number;
	publishedAfter?: string; // ISO date
	publishedBefore?: string; // ISO date
}

export interface CoursesFilters extends ResourceBaseFilters {
	level?: ('beginner' | 'intermediate' | 'advanced')[];
	minLessons?: number;
	maxLessons?: number;
}

// ---- Projects ----

export type ProjectStatus = 'draft' | 'active' | 'on_hold';

export interface ProjectsFilters extends BudgetRangeFilter, LocationFilter, LanguageFilter {
	status?: ProjectStatus[];
	stageTypes?: string[]; // filter by presence of certain stage types
}

```

### File: apps\web\contracts\public\IExploreRequest.ts

```ts
import {
	ExploreCategoryForSubcategory,
	ExploreSubcategory,
	IExploreRequestSortBy,
} from './IExploreCategories.ts';
import {
	ArticlesFilters,
	CoursesFilters,
	FreelancerFilters,
	ProductsFilters,
	ProjectsFilters,
	ServicesFilters,
	TeamFilters,
	TemplatesFilters,
} from './IExploreFilters.ts';
import { ISearchRequestWithSortAndFilter } from './ISearchRequest.ts';

// Text/semantic query shape, extendable later.
export interface ExploreQuery {
	term?: string;
}

// Mapping from subcategory → filters interface.
export interface ExploreFiltersBySubcategory {
	services: ServicesFilters;
	freelancers: FreelancerFilters;
	teams: TeamFilters;
	templates: TemplatesFilters;
	products: ProductsFilters;
	articles: ArticlesFilters;
	courses: CoursesFilters;
	projects: ProjectsFilters;
}

export type ExploreFilters<S extends ExploreSubcategory> = ExploreFiltersBySubcategory[S];

export type ExploreRequestFor<S extends ExploreSubcategory> =
	& ISearchRequestWithSortAndFilter<
		ExploreQuery,
		ExploreFilters<S>,
		IExploreRequestSortBy
	>
	& {
		category: ExploreCategoryForSubcategory<S>;
		subcategory: S;
	};

// Union type for handlers that accept any explore subcategory.
export type ExploreRequest =
	| ExploreRequestFor<'services'>
	| ExploreRequestFor<'freelancers'>
	| ExploreRequestFor<'teams'>
	| ExploreRequestFor<'templates'>
	| ExploreRequestFor<'products'>
	| ExploreRequestFor<'articles'>
	| ExploreRequestFor<'courses'>
	| ExploreRequestFor<'projects'>;

// Optional convenience helper to infer subcategory from a request.
export type InferExploreSubcategory<T extends ExploreRequest> = T['subcategory'];

// Optional convenience helper to get filters type from a subcategory.
export type InferExploreFilters<T extends ExploreRequest> = T extends
	ExploreRequestFor<infer S extends ExploreSubcategory> ? ExploreFilters<S>
	: never;

```

### File: apps\web\contracts\public\IExploreResponse.ts

```ts
import { ExploreSubcategory } from './IExploreCategories.ts';
import { ProjectStatus } from './IExploreFilters.ts';

export interface ExploreUploader {
	id: string;
	username: string;
	displayName: string;
	avatarUrl: string | null;
	profileSlug?: string;
}

// ---- Common item base ----

export interface ExploreItemBase {
	id: string;
	slug?: string;
	subcategory: ExploreSubcategory;
	name: string; // item name/title
	imageUrl: string | null;
	uploader: ExploreUploader;
}

// ---- Meta building blocks ----

export interface RatingMeta {
	rating: number | null; // 0–5 , null if no ratings yet
	ratingCount: number;
}

export interface PriceMeta extends RatingMeta {
	priceCents: number;
	currency: string; // 'GBP', 'USD', etc.
	originalPriceCents?: number; // for discounts
	isDiscounted?: boolean;
}

export interface TemplateMeta extends RatingMeta {
	description: string;
}

export interface ArticleMeta extends RatingMeta {
	estimatedReadTimeMinutes: number;
}

export interface ProjectMeta {
	durationDays: number;
	status: ProjectStatus;
}

export interface FreelancerTeamMeta extends RatingMeta {
	serviceCount: number;
	productCount: number;
	headline: string;
}

// ---- Items per subcategory ----

// Services: rating, number of ratings, price
export interface ServiceExploreItem extends ExploreItemBase {
	subcategory: 'services';
	meta: PriceMeta;
}

// Products: rating, number of ratings, price
export interface ProductExploreItem extends ExploreItemBase {
	subcategory: 'products';
	meta: PriceMeta;
}

// Courses: rating, number of ratings, price
export interface CourseExploreItem extends ExploreItemBase {
	subcategory: 'courses';
	meta: PriceMeta;
}

// Templates: rating, number of ratings, description
export interface TemplateExploreItem extends ExploreItemBase {
	subcategory: 'templates';
	meta: TemplateMeta;
}

// Articles: rating, number of ratings, estimated read time
export interface ArticleExploreItem extends ExploreItemBase {
	subcategory: 'articles';
	meta: ArticleMeta;
}

// Projects: duration and status
export interface ProjectExploreItem extends ExploreItemBase {
	subcategory: 'projects';
	meta: ProjectMeta;
}

// Freelancers: rating, number of ratings, number of services, number of products, headline
export interface FreelancerExploreItem extends ExploreItemBase {
	subcategory: 'freelancers';
	meta: FreelancerTeamMeta;
}

// Teams: rating, number of ratings, number of services, number of products, headline
export interface TeamExploreItem extends ExploreItemBase {
	subcategory: 'teams';
	meta: FreelancerTeamMeta;
}

// Union of all possible explore items
export type ExploreItem =
	| ServiceExploreItem
	| ProductExploreItem
	| CourseExploreItem
	| TemplateExploreItem
	| ArticleExploreItem
	| ProjectExploreItem
	| FreelancerExploreItem
	| TeamExploreItem;

```

### File: apps\web\contracts\public\ISearchRequest.ts

```ts
export interface ISearchRequest<Q> {
	query: Q;
	page: number;
	pageSize: number;
}

export type SortOrder = 'asc' | 'desc';

export interface ISearchRequestWithSort<Q, S> extends ISearchRequest<Q> {
	sortBy: S;
	sortOrder: SortOrder;
}

export interface ISearchRequestWithFilter<Q, F> extends ISearchRequest<Q> {
	filters: F;
}

export interface ISearchRequestWithSortAndFilter<Q, F, S>
	extends ISearchRequestWithSort<Q, S>, ISearchRequestWithFilter<Q, F> {}

export type IFilterTypes = 'string' | 'number' | 'boolean' | 'date' | 'range' | 'array';

export interface ISearchRequestFilterDefinition<T> {
	type: IFilterTypes;
	values?: T[];
	min?: number;
	max?: number;
}

```

### File: apps\web\contracts\public\ISearchResponse.ts

```ts
export interface ISearchResponse<T> {
	results: T[];
	totalCount: number;
	page: number;
	pageSize: number;
}

```

### File: apps\web\islands\NavBar.tsx

```tsx
import '@styles/components/navigation/nav-bar.css';
import NavBarGuest from '@components/navigation/NavBarGuest.tsx';
import NavBarUser from '@components/navigation/NavBarUser.tsx';
import NavBarUserSide from '@components/navigation/NavBarUserSide.tsx';

export default function NavBar(props: { isAuthenticated?: boolean }) {
	return (
		<>
			<header>
				<nav>
					{props.isAuthenticated ? <NavBarUser /> : <NavBarGuest />}
				</nav>
			</header>
			{props.isAuthenticated &&
				<NavBarUserSide />}
		</>
	);
}

```

### File: apps\web\islands\pages\auth\AuthLayout.tsx

```tsx
import '@styles/layouts/auth.css';
import { type ComponentChildren } from 'preact';

type AuthLayoutProps = {
	children: ComponentChildren;
};

export default function AuthLayout(props: AuthLayoutProps) {
	return (
		<div class='layout-auth'>
			<img
				src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
				alt='background'
				class='background'
			/>

			<div class='layout-auth__modal'>
				<div class='layout-auth__modal__window'>
					<img
						src='https://images.unsplash.com/photo-1690791456616-8d7a5cb8925d?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=1170'
						alt='background'
						class='backgrounds'
					/>
					<div class='layout-auth__modal__window__content'>
						<div class='layout-auth__modal__window__content__quote'>
							<p>Everything you can imagine is real</p>
							<div class='layout-auth__modal__window__content__quote__line-container'>
								<div class='layout-auth__modal__window__content__quote__line'></div>
								<span>Pablo Picasso</span>
							</div>
						</div>

						<div class='layout-auth__modal__window__content__slogan'>
							<h1 class='build-together'>Build Together.</h1>
							<h1 class='deliver-better'>Deliver Better.</h1>
						</div>
					</div>
				</div>

				<div class='layout-auth__modal__content'>
					<h1>Welcome</h1>
					{props.children}
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Login.tsx

```tsx
import '@styles/pages/auth/login.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import LoginButton from '@components/auth/LoginButton.tsx';
import GoogleLoginButton from '@components/auth/GoogleLoginButton.tsx';
import GitHubLoginButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);

export default function LoginIsland() {
	return (
		<div class='login'>
			<div class='login__container'>
				<div class='login__container__center'>
					<div class='login__header'>
						<h1>Welcome Back</h1>
						<p>Dive back in, right where you left off</p>
					</div>

					<div class='login__fields__container'>
						<div class='login__fields'>
							<TextField
								id='email'
								placeholder='Email'
								autocomplete='email'
								type='email'
								aria-label='Email address'
								aria-required='true'
								aria-describedby='email-error'
								onInput={(e) => {
									email.value = e.currentTarget.value;
								}}
							/>
							<div>
								<PasswordField
									id='password'
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								<div class='login__fields__options'>
									<label for='remember-me' class='remember-me'>
										<input type='checkbox' id='remember-me' />
										<span>Remember Me</span>
									</label>
									<a href='/auth/forgot-password'>Forgot Password?</a>
								</div>
							</div>
						</div>

						<div class='login__actions'>
							<LoginButton
								email={email}
								password={password}
							/>
							<GoogleLoginButton />
							<GitHubLoginButton />
						</div>
					</div>
				</div>
			</div>
			<div class='switch-auth'>
				<p class='switch-auth__text'>Don't have an account?</p>
				<a class='switch-auth__link' href='/register'>Register</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Onboarding.tsx

```tsx
import '@styles/pages/auth/onboarding.css';
import { useEffect } from 'preact/hooks';
import { signal } from '@preact/signals';
import OnboardingSubmit from '@components/auth/OnboardingSubmit.tsx';
import TextField from '@components/fields/TextField.tsx';

const firstName = signal('');
const lastName = signal('');
const username = signal('');
const type = signal<'freelancer' | 'client'>('client');

export default function OnboardingIsland() {
	useEffect(() => {
		const run = async () => {
			const response = await fetch('/api/v1/auth/user', {
				method: 'GET',
			});

			if (response.ok && response.status === 200) {
				const resp = await response.json();
				firstName.value = resp.firstName ?? '';
				lastName.value = resp.lastName ?? '';
				username.value = resp.username ?? '';
				console.log(resp);
			}
		};

		run();
	}, []);

	const onUserTypeChange = (e: InputEvent) => {
		type.value = (e.currentTarget as HTMLInputElement).value as ('freelancer' | 'client');
	};

	return (
		<div class='onboarding'>
			<div class='onboarding-stages'>
				<form class='onboarding-stage'>
					<div class='onboarding-stage__account-type__container'>
						<label
							for='onboarding-stage__account-type--client'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--client'
								value='client'
								hidden
								checked={type.value === 'client'}
								onInput={onUserTypeChange}
							/>
							Client
						</label>
						<label
							for='onboarding-stage__account-type--seller'
							class='onboarding-stage__account-type'
						>
							<input
								type='radio'
								name='onboarding-stage__account-type'
								id='onboarding-stage__account-type--seller'
								value='freelancer'
								hidden
								checked={type.value === 'freelancer'}
								onInput={onUserTypeChange}
							/>
							Seller
						</label>
					</div>

					<hr class='onboarding-stage__separator' />

					<div class='onboarding-stage__name'>
						<TextField value={firstName} placeholder='First Name' />
						<TextField value={lastName} placeholder='Last Name' />
					</div>

					<TextField value={username} placeholder='DoB' />
					<TextField value={username} placeholder='Username' />
				</form>
			</div>
			<div class='onboarding-stage-location'>
				<OnboardingSubmit
					firstName={firstName.value}
					lastName={lastName.value}
					username={username.value}
					type={type.value}
				/>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Register.tsx

```tsx
import '@styles/pages/auth/register.css';
import TextField from '@components/fields/TextField.tsx';
import PasswordField from '@components/fields/PasswordField.tsx';
import RegisterButton from '@components/auth/RegisterButton.tsx';
import GoogleRegisterButton from '@components/auth/GoogleRegisterButton.tsx';
import GitHubRegisterButton from '@components/auth/GitHubRegisterButton.tsx';
import { signal } from '@preact/signals';
import RegisterWithEmail, { RegisterErrors } from 'packages/utils/auth/register.ts';

const email = signal<string | undefined>(undefined);
const password = signal<string | undefined>(undefined);
const confirmPassword = signal<string | undefined>(undefined);

const emailError = signal<string | null>(null);
const passwordError = signal<string | null>(null);
const confirmPasswordError = signal<string | null>(null);

const errors = signal<RegisterErrors>({});

export default function RegisterIsland() {
	return (
		<div class='register'>
			<div class='register__container'>
				<div class='register__container__center'>
					<div class='register__header'>
						<h1>Create an account</h1>
						<p>Begin Your Journey Here</p>
					</div>

					<form class='register__fields__container'>
						<div class='register__fields'>
							<div class='register__field'>
								<TextField
									id='email'
									onFocus={() => {
										emailError.value = '';
									}}
									onBlur={() => {
										emailError.value = RegisterWithEmail.validateEmail(email.value || '');
									}}
									placeholder='Email'
									autocomplete='email'
									type='email'
									aria-label='Email address'
									aria-required='true'
									aria-invalid={!!emailError.value}
									aria-describedby='email-error'
									onInput={(e) => {
										email.value = e.currentTarget.value;
									}}
								/>
								{emailError.value && (
									<p id='email-error' class='register__field-error' role='alert'>
										{emailError.value || errors.value?.email}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='password'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = RegisterWithEmail.validateConfirmPassword(
											password.value || '',
											confirmPassword.value || '',
										);
										confirmPasswordError.value = RegisterWithEmail.validateConfirmPassword(
											password.value || '',
											confirmPassword.value || '',
										);
									}}
									placeholder='Password'
									autocomplete='new-password'
									aria-label='Password'
									aria-required='true'
									aria-invalid={!!passwordError.value}
									aria-describedby='password-error'
									onInput={(e) => {
										password.value = e.currentTarget.value;
									}}
								/>
								{passwordError.value && (
									<p id='password-error' class='register__field-error' role='alert'>
										{passwordError.value || errors.value?.password}
									</p>
								)}
							</div>

							<div class='register__field'>
								<PasswordField
									id='confirmPassword'
									onFocus={() => {
										passwordError.value = '';
										confirmPasswordError.value = '';
									}}
									onBlur={() => {
										passwordError.value = RegisterWithEmail.validateConfirmPassword(
											password.value || '',
											confirmPassword.value || '',
										);
										confirmPasswordError.value = RegisterWithEmail.validateConfirmPassword(
											password.value || '',
											confirmPassword.value || '',
										);
									}}
									placeholder='Re-enter Password'
									autocomplete='new-password'
									aria-label='Confirm password'
									aria-required='true'
									aria-invalid={!!confirmPasswordError.value}
									aria-describedby='confirmPassword-error'
									onInput={(e) => {
										confirmPassword.value = e.currentTarget.value;
									}}
								/>
								{confirmPasswordError.value && (
									<p id='confirmPassword-error' class='register__field-error' role='alert'>
										{confirmPasswordError.value || errors.value?.confirmPassword}
									</p>
								)}
							</div>
						</div>

						<div class='register__actions'>
							<RegisterButton
								email={email}
								password={password}
								confirmPassword={confirmPassword}
							/>
							<GoogleRegisterButton />
							<GitHubRegisterButton />
						</div>
					</form>
				</div>
			</div>

			<div class='switch-auth'>
				<p class='switch-auth__text'>Already have an account?</p>
				<a class='switch-auth__link' href='/login'>Log In</a>
			</div>
		</div>
	);
}

```

### File: apps\web\islands\pages\auth\Verify.tsx

```tsx
import { useEffect, useState } from 'preact/hooks';
import ResendButton from '@components/auth/ResendButton.tsx';

type Props = {
	email: string | undefined;
};

export default function VerifyIsland({ email }: Props) {
	const [status, setStatus] = useState<'parsing' | 'verifying' | 'awaiting' | 'done' | 'error'>(
		'parsing',
	);
	const [err, setErr] = useState<string | null>(null);

	useEffect(() => {
		const params = new URLSearchParams(globalThis.location.hash.replace(/^#/, ''));
		const access_token = params.get('access_token');
		const refresh_token = params.get('refresh_token');

		if (access_token && refresh_token) {
			setStatus('verifying');
			fetch('/api/v1/auth/callback', {
				method: 'POST',
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify({ access_token, refresh_token }),
			})
				.then(async (r) => {
					console.log('1 -----', r);
					if (!r.ok) throw new Error((await r.json()).error?.message ?? 'Failed to set session');
					console.log('2 -----', r);
					setStatus('done');
					globalThis.location.href = '/onboarding';
				})
				.catch((e) => {
					console.log('error ------', e.message);
					setErr(e.message);
					setStatus('error');
				});
		} else {
			setStatus('awaiting');
		}
	}, []);

	return (
		<main class='mx-auto max-w-md p-6'>
			<h1 class='text-2xl font-semibold mb-4'>Verify your email</h1>

			{status === 'parsing' && <p>Preparing…</p>}
			{status === 'verifying' && <p>Signing you in…</p>}
			{status === 'done' && <p>Redirecting…</p>}

			{status === 'awaiting' && (
				<section>
					<p class='mb-3'>We’ve sent a verification link to your email. Click it to continue.</p>
					<p>{email}</p>
					<ResendButton email={email} />
				</section>
			)}

			{status === 'error' && (
				<section class='text-red-600'>
					<p class='mb-2'>We couldn’t verify your session.</p>
					<p class='mb-4 text-sm'>{err}</p>
					<a class='underline' href='/verify'>Try again</a>
				</section>
			)}
		</main>
	);
}

```

### File: apps\web\islands\pages\home\hero.tsx

```tsx
import '@styles/pages/home/hero.css';
import SearchBar from '@components/search/SearchBar.tsx';
import { IconChevronRight } from '@tabler/icons-preact';

export default function HomeHeroIsland() {
	return (
		<section id='hero' class='home__hero'>
			<div class='home__hero__bg'>
				<img
					class='home__hero__bg__image'
					src='https://images.unsplash.com/photo-1535957998253-26ae1ef29506?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=736'
				/>
			</div>
			<div class='home__hero__content'>
				<h1 class='home__hero__content__title'>
					Build Together.<br />Deliver Better.
				</h1>

				<div class='home__hero__content__search'>
					<SearchBar />
				</div>

				<div class='home__hero__content__actions'>
					<a class='home__hero__content__actions__join' href='#s'>
						<span>Start Creating</span>
						<IconChevronRight />
					</a>
					<a class='home__hero__content__actions__explore' href='#s'>
						<span>Explore</span>
						<IconChevronRight />
					</a>
				</div>
			</div>
		</section>
	);
}

```

### File: apps\web\islands\pages\public\explore.tsx

```tsx

```

### File: apps\web\islands\pages\public\search.tsx

```tsx
import '@styles/pages/public/explore/search.css';
import SearchBar from '@components/public/explore/SearchBar.tsx';
import { signal } from '@preact/signals';
import { IconLayout2Filled, IconList } from '@tabler/icons-preact';
import ExploreFilters from '@components/public/explore/Filters.tsx';

const showFilters = signal(true);
const displayType = signal(true);

export default function SearchIsland({ query }: { query: string }) {
	return (
		<div class='search-page'>
			<section class='search-page__search'>
				<h1 class='search-page__search__title'>{query}</h1>
				<div class='search-page__search__related'>
					<span>Related:</span>
				</div>
				<SearchBar />
			</section>
			<section class='search-page__options'>
				<div class='search-page__options__top'>
					<div class='search-page__options__toggle-filter'>
						<label for='search-page__options__toggle-filter'>
							<input
								type='checkbox'
								name='search-page__options__toggle-filter--toggle'
								id='search-page__options__toggle-filter'
								onInput={() => showFilters.value = !showFilters.value}
								checked={showFilters.value}
								hidden
							/>
							Filters
						</label>
					</div>
					<div class='search-page__options__categories'>
						<label>
							<input type='radio' value='work' name='search-page__options__categories' hidden />
							Work
						</label>
						<label>
							<input
								type='radio'
								value='resources'
								name='search-page__options__categories'
								hidden
							/>
							Resources
						</label>
						<label>
							<input type='radio' value='projects' name='search-page__options__categories' hidden />
							Projects
						</label>
					</div>
					<div class='search-page__options__sort'>
						<button type='button'>Sort</button>
					</div>
				</div>

				<div class='search-page__options__bottom'>
					<div class='search-page__options__results-count'>
						<p type='button'>Showing 472 results for "{query}" category</p>
					</div>
					<div class='search-page__options__category-type'>
						<label>
							<input
								type='radio'
								value='resources-templates'
								name='search-page__options__category-type'
								hidden
							/>
							Templates
						</label>
						<label>
							<input
								type='radio'
								value='resources-products'
								name='search-page__options__category-type'
								hidden
							/>
							Products
						</label>
						<label>
							<input
								type='radio'
								value='resources-articles'
								name='search-page__options__category-type'
								hidden
							/>
							Articles
						</label>
						<label>
							<input
								type='radio'
								value='resources-courses'
								name='search-page__options__category-type'
								hidden
							/>
							Courses
						</label>
					</div>
					<div class='search-page__options__layout'>
						<label for='search-page__options__layout--layout-list'>
							<input
								type='radio'
								value='layout-list'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-list'
								hidden
								checked={!displayType.value}
								onInput={() => displayType.value = false}
							/>
							<IconList />
						</label>
						<label for='search-page__options__layout--layout-grid'>
							<input
								type='radio'
								value='layout-grid'
								name='search-page__options__layout'
								id='search-page__options__layout--layout-grid'
								hidden
								checked={displayType.value}
								onInput={() => displayType.value = true}
							/>
							<IconLayout2Filled />
						</label>
					</div>
				</div>
			</section>
			<div class='search-page__results'>
				{showFilters.value &&
					(
						<aside class='search-page__results__filters__container'>
							<ExploreFilters />
						</aside>
					)}
				<div class='search-page__results__content'>
					Search Results
				</div>
			</div>
		</div>
	);
}

```

### File: apps\web\main.ts

```ts
import { App, staticFiles } from 'fresh';
import { State } from './utils.ts';
import '@server/env.ts';

const app = new App<State>();

app.use(staticFiles());
app.fsRoutes();

export { app };

```

### File: apps\web\routes\(auth)\forgot-password.tsx

```tsx

```

### File: apps\web\routes\(auth)\login.tsx

```tsx
import { Head } from 'fresh/runtime';
import LoginIsland from '@islands/pages/auth/Login.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Login</title>
			</Head>

			<LoginIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\onboarding\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import OnboardingIsland from '@islands/pages/auth/Onboarding.tsx';

export default function Onboarding() {
	return (
		<>
			<Head>
				<title>Onboarding</title>
			</Head>

			<OnboardingIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\register.tsx

```tsx
import { Head } from 'fresh/runtime';
import RegisterIsland from '@islands/pages/auth/Register.tsx';

export default function Login() {
	return (
		<>
			<Head>
				<title>Sign Up</title>
			</Head>

			<RegisterIsland />
		</>
	);
}

```

### File: apps\web\routes\(auth)\reset\[token].tsx

```tsx

```

### File: apps\web\routes\(auth)\verify\index.tsx

```tsx
import { Head } from 'fresh/runtime';
import VerifyIsland from '@islands/pages/auth/Verify.tsx';
import { State } from '@utils';
import { getCookies } from '@std/http/cookie';
import { RenderableProps } from 'preact';
import { PageProps } from 'fresh';

// deno-lint-ignore no-explicit-any
export default function Verify(ctx: RenderableProps<PageProps<never, State>, any>) {
	const cookies = getCookies(ctx.req.headers);
	const email = cookies['verify_email'] ? decodeURIComponent(cookies['verify_email']) : undefined;

	return (
		<>
			<Head>
				<title>Verify</title>
			</Head>

			<VerifyIsland email={email} />
		</>
	);
}

```

### File: apps\web\routes\(auth)\_layout.tsx

```tsx
import { define } from '@utils';
import AuthLayout from '@islands/pages/auth/authLayout.tsx';

export default define.layout(function App(props) {
	const { Component } = props;

	return (
		<AuthLayout>
			<Component />
		</AuthLayout>
	);
});

```

### File: apps\web\routes\(auth)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/dashboard',
			},
		});
	}

	if (ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(dashboard)\dashboard\index.tsx

```tsx
export default function Dashboard() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\earnings\index.tsx

```tsx
export default function Earnings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\messages\index.tsx

```tsx
export default function Messages() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\projects\index.tsx

```tsx
export default function Projects() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\settings\index.tsx

```tsx
export default function Settings() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\teams\index.tsx

```tsx
export default function Teams() {
	return <div></div>;
}

```

### File: apps\web\routes\(dashboard)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\(dashboard)\_middleware.ts

```ts
import { define } from '@utils';

export const handler = define.middleware(async (ctx) => {
	if (!ctx.state.isAuthenticated) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/login',
			},
		});
	}

	if (!ctx.state.isOnboarded) {
		return new Response(null, {
			status: 302,
			headers: {
				Location: '/onboarding',
			},
		});
	}

	const res = await ctx.next();
	return res;
});

```

### File: apps\web\routes\(public)\(index)\index.tsx

```tsx
import '@styles/pages/home/home.css';
import HomeHeroIsland from '@islands/pages/home/hero.tsx';

export default function Home() {
	return (
		<div class='home'>
			<HomeHeroIsland />
		</div>
	);
}

```

### File: apps\web\routes\(public)\about.tsx

```tsx

```

### File: apps\web\routes\(public)\explore\index.tsx

```tsx
export default function Explore() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\explore\search\[query].tsx

```tsx
import { RenderableProps } from 'preact/src/index.d.ts';
import { PageProps } from 'https://jsr.io/@fresh/core/2.2.0/src/render.ts';
import { State } from '@utils';
import SearchIsland from '@islands/pages/public/search.tsx';

export default function Search(ctx: RenderableProps<PageProps<never, State>, any>) {
	ctx.params.query;
	console.log(ctx.params.query);

	return (
		<div class='search-page__container'>
			<SearchIsland query={ctx.params.query} />
		</div>
	);
}

```

### File: apps\web\routes\(public)\explore\[...path].tsx

```tsx
export default function ExploreItem() {
	return <div></div>;
}

```

### File: apps\web\routes\(public)\help\index.tsx

```tsx

```

### File: apps\web\routes\(public)\help\[...path].tsx

```tsx

```

### File: apps\web\routes\(public)\privacy.tsx

```tsx

```

### File: apps\web\routes\(public)\terms.tsx

```tsx

```

### File: apps\web\routes\(public)\[user]\index.tsx

```tsx

```

### File: apps\web\routes\(public)\_layout.tsx

```tsx
import { define } from '@utils';
import NavBar from '@islands/NavBar.tsx';

export default define.layout(function App({ Component, state }) {
	return (
		<>
			<NavBar isAuthenticated={state.isOnboarded} />

			<div class='container'>
				<Component />
			</div>
		</>
	);
});

```

### File: apps\web\routes\api\test\test.ts

```ts
import { define } from '@utils';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async GET(ctx) {
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setCookie(headers, {
			name: 'verify_email',
			value: 'email@email.com',
			path: '/verify',
			maxAge: 10000,
			httpOnly: true,
			sameSite: 'Lax',
			secure: true,
		});

		return new Response(null, {
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\callback.ts

```ts
import { define } from '@utils';
import { setAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const reqUrl = new URL(ctx.req.url);
		const { access_token, refresh_token } = await ctx.req.json();
		if (!access_token || !refresh_token) {
			return new Response(
				JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
				{
					status: 400,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: access_token,
			refreshToken: refresh_token,
			requestUrl: reqUrl,
		});
		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\email\login.ts

```ts
import { define } from '@utils';
import { loginWithEmail } from '@server/auth/email/login.ts';
import { setCookie } from '@std/http/cookie';
import { setAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await loginWithEmail(body);

		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		// IMPORTANT: keep a single Headers instance and append cookies to it.
		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 401);
			return new Response(JSON.stringify({ error: res.error }), { status, headers });
		}

		// If the user isn’t verified, set a short-lived helper cookie and tell the client to go to /verify.
		const user = res.data.user;
		const unverified = user && !(user.email_confirmed_at ?? user.confirmed_at);

		if (unverified) {
			const email = user.email ?? (typeof body?.email === 'string' ? body.email : '');
			if (email) {
				setCookie(headers, {
					name: 'verify_email',
					value: encodeURIComponent(email),
					httpOnly: true,
					sameSite: 'Lax',
					secure: reqUrl.protocol === 'https:',
					path: '/verify',
					maxAge: 10 * 60,
				});
			}
			// Don’t replace headers—reuse the same instance so previously appended Set-Cookie aren’t lost.
			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		// If we have a session, persist tokens via cookies (append both, plus CSRF).
		if (res.data.session) {
			const { access_token, refresh_token } = res.data.session;
			if (!access_token || !refresh_token) {
				return new Response(
					JSON.stringify({ error: { code: 'bad_request', message: 'Missing tokens' } }),
					{
						status: 400,
						headers,
					},
				);
			}
			// Derive secure + naming from the request URL/host inside the helper.
			setAuthCookies(headers, {
				accessToken: access_token,
				refreshToken: refresh_token,
				requestUrl: reqUrl,
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/' }), {
			status: 200,
			headers,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\email\register.ts

```ts
import { define } from '@utils';
import { registerWithEmail } from '@server/auth/email/register.ts';
import { setCookie } from '@std/http/cookie';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await registerWithEmail(body, {}, {});
		const reqUrl = new URL(ctx.req.url);
		const verifyUrl = new URL('/verify', reqUrl).href;

		if (!res.ok) {
			const status = res.error.status ?? (res.error.code === 'bad_request' ? 400 : 500);
			return new Response(JSON.stringify({ error: res.error }), {
				status,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		const email = res.data.user?.email ?? (typeof body?.email === 'string' ? body.email : '');

		const headers = new Headers({
			location: verifyUrl,
		});
		if (email) {
			setCookie(headers, {
				name: 'verify_email',
				value: encodeURIComponent(email),
				httpOnly: true,
				sameSite: 'Lax',
				secure: reqUrl.protocol === 'https:',
				path: '/verify',
				maxAge: 10 * 60,
			});

			return new Response(JSON.stringify({ ok: true, redirectTo: verifyUrl }), {
				status: 200,
				headers,
			});
		}

		return new Response(null, { status: 303, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-login.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'login', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\google\google-register.ts

```ts
import { define } from '@utils';
import { getProviderRedirectUrl } from '@server/auth/oauth.ts';

export const handler = define.handlers({
	async GET(ctx) {
		try {
			const url = new URL(ctx.req.url);

			const next = url.searchParams.get('next') || '/';

			const redirect = await getProviderRedirectUrl('google', 'register', url, next);
			console.log('redirect', redirect, url.href, next);

			return new Response(null, {
				status: 303,
				headers: { Location: redirect },
			});
		} catch (e) {
			const msg = e instanceof Error ? e.message : 'OAuth init failed';
			console.log('redirect error', msg);

			return new Response(
				JSON.stringify({ error: { code: 'oauth_init_failed', message: msg } }),
				{
					status: 500,
					headers: { 'content-type': 'application/json; charset=utf-8' },
				},
			);
		}
	},
});

```

### File: apps\web\routes\api\v1\auth\logout.ts

```ts

```

### File: apps\web\routes\api\v1\auth\me.ts

```ts
// apps/web/routes/api/v1/auth/me.ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';
import { getAuthCookies } from '@server/auth/cookies.ts';

export const handler = define.handlers({
	async GET(ctx) {
		const { accessToken } = getAuthCookies(ctx.req);
		if (!accessToken) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		const sb = await supabaseClient(ctx.req);
		const { data: userRes, error: userErr } = await sb.auth.getUser();
		if (userErr || !userRes?.user) {
			return new Response(JSON.stringify({ error: { code: 'unauthorized' } }), {
				status: 401,
				headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
			});
		}

		// Fetch public profile under RLS
		const { data: row } = await sb
			.from('org.users_public')
			.select(
				'user_id, display_name, avatar_url, active_profile_type, active_profile_id, active_team_id',
			)
			.eq('user_id', userRes.user.id)
			.single();

		const payload = row
			? {
				id: row.user_id as string,
				displayName: (row.display_name as string) ?? null,
				avatarUrl: (row.avatar_url as string) ?? null,
				activeProfileType: (row.active_profile_type as 'freelancer' | 'business' | null) ?? null,
				activeProfileId: (row.active_profile_id as string | null) ?? null,
				activeTeamId: (row.active_team_id as string | null) ?? null,
			}
			: {
				id: userRes.user.id,
				displayName: null,
				avatarUrl: null,
				activeProfileType: null,
				activeProfileId: null,
				activeTeamId: null,
			};

		return new Response(JSON.stringify({ user: payload }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\onboarding.ts

```ts
import { define } from '@utils';
import { onboarding } from '@server/auth/onboarding.ts';
import { getAuthCookies } from '@server/auth/cookies.ts';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const body = await ctx.req.json();
		const res = await onboarding(body, {
			getClient: () => supabaseClient(ctx.req),
		});

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true, redirectTo: '/dashboard' }), {
			status: 200,
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\refresh.ts

```ts
// apps/web/routes/api/v1/auth/refresh.ts
import { define } from '@utils';
import { clearAuthCookies, setAuthCookies } from '@server/auth/cookies.ts';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const url = new URL(ctx.req.url);
		const refreshed = await maybeRefreshFromRequest(ctx.req);

		if (!refreshed) {
			const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
			clearAuthCookies(headers, url);
			return new Response(JSON.stringify({ ok: false, error: { code: 'refresh_failed' } }), {
				status: 401,
				headers,
			});
		}

		const headers = new Headers({ 'content-type': 'application/json; charset=utf-8' });
		setAuthCookies(headers, {
			accessToken: refreshed.access,
			refreshToken: refreshed.refresh,
			requestUrl: url,
		});

		return new Response(JSON.stringify({ ok: true }), { status: 200, headers });
	},
});

```

### File: apps\web\routes\api\v1\auth\resend.ts

```ts
import { define } from '@utils';
import { resendVerificationEmail } from '@server/auth/resend.ts';

export const handler = define.handlers({
	async POST(ctx) {
		const { email } = await ctx.req.json();
		const res = await resendVerificationEmail((email ?? '').trim().toLowerCase());

		if (!res.ok) {
			return new Response(JSON.stringify({ error: res.error }), {
				status: res.error.status ?? 400,
				headers: { 'content-type': 'application/json; charset=utf-8' },
			});
		}

		return new Response(JSON.stringify({ ok: true }), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8' },
		});
	},
});

```

### File: apps\web\routes\api\v1\auth\switch-profile.ts

```ts

```

### File: apps\web\routes\api\v1\auth\switch-team.ts

```ts

```

### File: apps\web\routes\api\v1\auth\user.ts

```ts
import { define } from '@utils';
import { supabaseClient } from '@server/core/clients/supabase.ts';

export const handler = define.handlers({
	async GET(ctx) {
		const sb = await supabaseClient(ctx.req);
		const { data, error } = await sb.auth.getUser();

		if (!error && data.user && data.user.user_metadata) {
			const user = data.user.user_metadata;
			const name = user.name.split(' ');
			const firstName = name[0];
			const lastName = name[name.length - 1];
			const username = user.user_name;

			return new Response(JSON.stringify({ firstName, lastName, username }), {
				status: 200,
			});
		}

		return new Response('', { status: 204 });
	},
});

```

### File: apps\web\routes\api\v1\meta\health.ts

```ts
import { define } from '@utils';

const startedAt = Date.now();

type HealthPayload = {
	status: 'ok';
	service: string;
	version: string;
	uptime_ms: number;
	started_at: string;
	commit?: string;
	env: 'development' | 'production' | 'test' | string;
};

function payload(): HealthPayload {
	const uptime = Math.max(0, Date.now() - startedAt);
	const env = Deno.env.get('APP_ENV') ??
		(Deno.env.get('DENO_DEPLOYMENT_ID') ? 'production' : 'development');
	return {
		status: 'ok',
		service: Deno.env.get('APP_NAME') ?? 'projective-api',
		version: Deno.env.get('APP_VERSION') ?? '0.0.0',
		uptime_ms: uptime,
		started_at: new Date(startedAt).toISOString(),
		commit: Deno.env.get('GIT_COMMIT') ?? undefined,
		env,
	};
}

export const handler = define.handlers({
	async GET() {
		return new Response(JSON.stringify(payload()), {
			status: 200,
			headers: { 'content-type': 'application/json; charset=utf-8', 'cache-control': 'no-store' },
		});
	},

	async HEAD() {
		return new Response(null, {
			status: 200,
			headers: { 'cache-control': 'no-store' },
		});
	},
});

```

### File: apps\web\routes\_app.tsx

```tsx
import { Head } from 'fresh/runtime';
import { State } from '@utils';

export default function App(
	ctx: { Component: preact.ComponentType; stateTheme?: 'light' | 'dark'; state: State },
) {
	const initial = ctx.stateTheme ?? 'dark';

	return (
		<html lang='en' data-theme={initial}>
			<Head>
				<meta charSet='utf-8' />
				<meta name='viewport' content='width=device-width, initial-scale=1' />
				<meta
					name='description'
					content='Collaborative freelancing platform.'
				/>
				<title>Projective</title>
			</Head>
			<body data-onboarded={ctx.state.isOnboarded}>
				<main>
					<ctx.Component />
				</main>
			</body>
		</html>
	);
}

```

### File: apps\web\routes\_middleware.ts

```ts
// apps/web/routes/_middleware.ts
import { define } from '@utils';
import {
	clearAuthCookies,
	getAuthCookies,
	setAuthCookies,
	verifyCsrf,
} from '@server/auth/cookies.ts';
import { maybeRefreshFromRequest } from '@server/auth/refresh.ts';
import { isOnboarded } from '@server/auth/onboarding.ts';

function jwtExp(token: string): number | null {
	try {
		const payload = token.split('.')[1];
		if (!payload) return null;
		const json = JSON.parse(
			new TextDecoder().decode(
				Uint8Array.from(
					atob(payload.replace(/-/g, '+').replace(/_/g, '/')),
					(c) => c.charCodeAt(0),
				),
			),
		);
		return typeof json.exp === 'number' ? json.exp : null;
	} catch {
		return null;
	}
}

const middleware1 = define.middleware(async (ctx) => {
	const req = ctx.req;
	const url = new URL(req.url);
	const path = url.pathname;

	const { accessToken, refreshToken } = getAuthCookies(req);
	const now = Math.floor(Date.now() / 1000);
	const skew = 60;

	ctx.state.isAuthenticated = !!accessToken;

	if (!ctx.state.isAuthenticated) {
		ctx.state.isOnboarded = false;
	}

	// Decide if we should refresh
	let shouldRefresh = false;
	if (refreshToken) {
		if (!accessToken) shouldRefresh = true;
		else {
			const exp = jwtExp(accessToken);
			if (!exp || exp <= now + skew) shouldRefresh = true;
		}
	}

	// Use ctx.state fields (OK), do NOT reassign ctx.state
	ctx.state.refreshedTokens = null;
	ctx.state.clearAuth = false;

	if (shouldRefresh) {
		const refreshed = await maybeRefreshFromRequest(req);
		if (refreshed) {
			ctx.state.refreshedTokens = refreshed;
		} else {
			ctx.state.clearAuth = true;
		}
	}

	// CSRF for cookie-auth state-changing requests (skip if Authorization: Bearer present)
	const isStateChanging = ['POST', 'PUT', 'PATCH', 'DELETE'].includes(req.method.toUpperCase());
	const hasBearer = !!req.headers.get('authorization')?.startsWith('Bearer ');
	if (isStateChanging && !hasBearer && (accessToken || ctx.state.refreshedTokens)) {
		if (!verifyCsrf(req)) {
			return new Response(
				JSON.stringify({ error: { code: 'csrf_failed', message: 'CSRF check failed' } }),
				{ status: 403, headers: { 'content-type': 'application/json; charset=utf-8' } },
			);
		}
	}

	// Always allow /verify
	if (path.startsWith('/verify')) {
		const res = await ctx.next();
		if (ctx.state.refreshedTokens) {
			const { access, refresh } = ctx.state.refreshedTokens;
			setAuthCookies(res.headers, {
				accessToken: access,
				refreshToken: refresh,
				requestUrl: url,
			});
		}
		if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);
		return res;
	}

	const res = await ctx.next();

	if (ctx.state.refreshedTokens) {
		const { access, refresh } = ctx.state.refreshedTokens;
		setAuthCookies(res.headers, {
			accessToken: access,
			refreshToken: refresh,
			requestUrl: url,
		});
	}
	if (ctx.state.clearAuth) clearAuthCookies(res.headers, url);

	return res;
});

const middleware2 = define.middleware(async (ctx) => {
	if (ctx.state.isAuthenticated && !ctx.state.isOnboarded) {
		ctx.state.isOnboarded = await isOnboarded(ctx.req);
	}

	return await ctx.next();
});

export default [middleware1, middleware2];

```

### File: apps\web\server\auth\claims.ts

```ts
export type JwtClaims = {
	sub: string;
	exp?: number;
	active_profile_type?: 'freelancer' | 'business';
	active_profile_id?: string;
	active_team_id?: string | null;
} | null;

export function parseJwt(token?: string): JwtClaims {
	if (!token) return null;
	try {
		const [, b64] = token.split('.');
		if (!b64) return null;
		const json = atob(b64.replace(/-/g, '+').replace(/_/g, '/'));
		return JSON.parse(json);
	} catch {
		return null;
	}
}

export function isExpired(exp?: number, skewSec = 30) {
	if (!exp) return true;
	return exp <= Math.floor(Date.now() / 1000) + skewSec;
}

```

### File: apps\web\server\auth\cookies.ts

```ts
import { type Cookie, deleteCookie, getCookies, setCookie } from '@std/http/cookie';

type SetAuthOpts = {
	accessToken: string;
	refreshToken: string;
	/** Pass the current request URL so we can decide secure + naming correctly. */
	requestUrl: URL;
};

/** Local dev can’t use __Host-* (requires secure + no Domain + Path=/ on HTTPS). */
function resolveCookieNames(isSecureOrigin: boolean, isLocalhost: boolean) {
	if (isSecureOrigin && !isLocalhost) {
		return { ACCESS_NAME: '__Host-pjv-at', REFRESH_NAME: '__Host-pjv-rt' };
	}
	return { ACCESS_NAME: 'pjv-at', REFRESH_NAME: 'pjv-rt' };
}

function isLocalhostHost(hostname: string) {
	return (
		hostname === 'localhost' ||
		hostname === '127.0.0.1' ||
		hostname === '[::1]' ||
		/\.local(domain)?$/i.test(hostname)
	);
}

export function setAuthCookies(
	headers: Headers,
	{ accessToken, refreshToken, requestUrl }: SetAuthOpts,
) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	// Common attributes for auth cookies
	const common: Partial<Cookie> = {
		httpOnly: true,
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal, // never mark Secure on localhost
		path: '/', // required for __Host-* and fine for non-__Host too
	};

	// Access: ~15 minutes
	setCookie(headers, {
		...common,
		name: ACCESS_NAME,
		value: accessToken,
		maxAge: 60 * 15,
	});

	// Refresh: ~30 days
	setCookie(headers, {
		...common,
		name: REFRESH_NAME,
		value: refreshToken,
		maxAge: 60 * 60 * 24 * 30,
	});

	// CSRF (readable) — double-submit token, same naming irrespective of env
	setCookie(headers, {
		name: 'pjv-csrf',
		value: randomToken(),
		httpOnly: false, // must be readable by JS
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal,
		path: '/',
		maxAge: 60 * 60 * 24 * 30,
	});
}

export function clearAuthCookies(headers: Headers, requestUrl: URL) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	const base = { path: '/', secure: isSecureOrigin && !isLocal } as const;

	// Delete both possible names just in case a previous env wrote the other variant.
	deleteCookie(headers, ACCESS_NAME, base);
	deleteCookie(headers, REFRESH_NAME, base);
	deleteCookie(headers, 'pjv-csrf', base);

	// Also try deleting the opposite flavor to avoid sticky leftovers across envs.
	deleteCookie(headers, '__Host-pjv-at', base);
	deleteCookie(headers, '__Host-pjv-rt', base);
	deleteCookie(headers, 'pjv-at', base);
	deleteCookie(headers, 'pjv-rt', base);
}

export function getAuthCookies(req: Request) {
	const c = getCookies(req.headers);
	// Support both name variants seamlessly.
	const accessToken = c['__Host-pjv-at'] ?? c['pjv-at'];
	const refreshToken = c['__Host-pjv-rt'] ?? c['pjv-rt'];
	return {
		accessToken,
		refreshToken,
		csrf: c['pjv-csrf'],
	};
}

// ---- CSRF helpers ----

export function verifyCsrf(req: Request): boolean {
	const method = req.method.toUpperCase();
	if (!['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) return true;

	const cookies = getCookies(req.headers);
	const sent = req.headers.get('X-CSRF');
	const expected = cookies['pjv-csrf'];
	return Boolean(sent && expected && sent === expected);
}

// Generate a CSRF token
function randomToken(bytes = 32) {
	const a = new Uint8Array(bytes);
	crypto.getRandomValues(a);
	return btoa(String.fromCharCode(...a)).replace(/=+$/, '');
}

export function getCsrfToken(name = 'pjv-csrf'): string | null {
	const cookie = typeof document !== 'undefined' ? document.cookie : '';
	if (!cookie) return null;

	const match = cookie.match(
		new RegExp('(?:^|; )' + name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&') + '=([^;]*)'),
	);

	return match ? decodeURIComponent(match[1]) : null;
}

```

### File: apps\web\server\auth\email\login.ts

```ts
import { LoginWithEmailRequest } from '@contracts/auth/login.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';
import { Deps, SignInData } from '../_shared/types.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';

export async function loginWithEmail(
	{ email, password }: LoginWithEmailRequest,
	deps: Deps = {},
): Promise<Result<SignInData>> {
	const e = (email ?? '').trim().toLowerCase();
	const p = (password ?? '').trim();

	if (!e || !p) return fail('bad_request', 'Email and password are required.', 400);
	if (!isLikelyEmail(e)) return fail('bad_request', 'Invalid email format.', 400);

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signInWithPassword({ email: e, password: p });

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\email\register.ts

```ts
import { RegisterWithEmailRequest } from '@contracts/auth/register.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';
import { Deps, RegisterOptions, SignUpData } from '../_shared/types.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';

export async function registerWithEmail(
	{ email, password }: RegisterWithEmailRequest,
	deps: Deps = {},
	opts: RegisterOptions = {},
): Promise<Result<SignUpData>> {
	const e = (email ?? '').trim().toLowerCase();
	const p = (password ?? '').trim();

	if (!e || !p) return fail('bad_request', 'Email and password are required.', 400);
	if (!isLikelyEmail(e)) return fail('bad_request', 'Invalid email format.', 400);
	if (p.length < 8) return fail('bad_request', 'Password must be at least 8 characters.', 400);

	try {
		const emailRedirectTo = `${Deno.env.get('URL')}/verify`;
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.signUp({
			email: e,
			password: p,
			options: {
				data: opts.metadata,
				emailRedirectTo,
				captchaToken: opts.captchaToken,
			},
		});

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\finalise-login.ts

```ts

```

### File: apps\web\server\auth\oauth.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';

export type OAuthProvider = 'google' | 'github';
export type OAuthIntent = 'login' | 'register';

export async function getProviderRedirectUrl(
	provider: OAuthProvider,
	intent: OAuthIntent,
	requestUrl: URL,
	next = '/',
): Promise<string> {
	const verifyUrl = new URL('/verify', requestUrl);
	if (next && next !== '/') {
		verifyUrl.searchParams.set('next', next);
	}
	verifyUrl.searchParams.set('intent', intent);

	const sb = await supabaseClient();
	const { data, error } = await sb.auth.signInWithOAuth({
		provider,
		options: {
			redirectTo: verifyUrl.toString(),
			skipBrowserRedirect: true,
		} as any,
	});

	console.log({ provider, url: data?.url }, error);

	if (error || !data?.url) {
		throw new Error(error?.message || 'OAuth init failed');
	}
	return data.url;
}

```

### File: apps\web\server\auth\onboarding.ts

```ts
// server/auth/onboarding.ts
import { OnboardingRequest } from '@contracts/auth/onboading.ts';
import { Deps, SignInData } from './_shared/types.ts';
import { fail, ok, Result } from '../core/http/result.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { supabaseClient } from '../core/clients/supabase.ts';

export async function onboarding(
	{
		firstName,
		lastName,
		username,
		type,
	}: OnboardingRequest,
	deps: Deps = {},
): Promise<Result<any>> {
	if (!firstName || !username) {
		return fail('bad_request', 'First name and username are required.', 400);
	}

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		// Make sure we actually have an authenticated user
		const { data, error: authError } = await supabase.auth.getUser();
		if (authError || !data.user) {
			return fail('unauthorized', 'You must be signed in to onboard.', 401);
		}

		const userId = data.user.id;

		// Insert public profile
		const { error: userError } = await supabase
			.schema('org')
			.from('users_public')
			.insert({
				user_id: userId,
				first_name: firstName,
				last_name: lastName,
				username,
			});

		if (userError) {
			const n = normaliseSupabaseError(userError);
			return fail(n.code, n.message, n.status);
		}

		// Optionally create freelancer profile
		if (type === 'freelancer') {
			const { error: freelancerError } = await supabase
				.schema('org')
				.from('freelancer_profiles')
				.insert({
					user_id: userId, // <- use the same authenticated user
				});

			if (freelancerError) {
				const n = normaliseSupabaseError(freelancerError);
				return fail(n.code, n.message, n.status);
			}
		}

		return ok<any>({}); // TODO: return whatever you actually need
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

export async function isOnboarded(req: Request) {
	const supabase = await supabaseClient(req);
	const { data, error } = await supabase.auth.getUser();

	if (error || !data.user.id) {
		return false;
	}

	const { data: userData } = await supabase.schema('org').from('users_public').select('user_id').eq(
		'user_id',
		data.user.id,
	);

	if (userData) {
		return true;
	}

	return false;
}

```

### File: apps\web\server\auth\refresh.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';
import { getAuthCookies } from './cookies.ts';

type RefreshResult = { access: string; refresh: string } | null;

export async function refreshWithToken(refreshToken: string): Promise<RefreshResult> {
	const sb = await supabaseClient();
	const { data, error } = await sb.auth.refreshSession({ refresh_token: refreshToken });

	if (error || !data?.session?.access_token || !data?.session?.refresh_token) {
		return null;
	}
	return {
		access: data.session.access_token,
		refresh: data.session.refresh_token,
	};
}

export async function maybeRefreshFromRequest(req: Request): Promise<RefreshResult> {
	const { refreshToken } = getAuthCookies(req);
	if (!refreshToken) return null;
	return await refreshWithToken(refreshToken);
}

```

### File: apps\web\server\auth\resend.ts

```ts
import { supabaseClient } from '../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../core/errors/normalise.ts';
import { fail, ok, Result } from '../core/http/result.ts';

export async function resendVerificationEmail(email: string): Promise<Result<{ sent: true }>> {
	if (!email) return fail('bad_request', 'Email is required.', 400);
	try {
		const emailRedirectTo = `${Deno.env.get('URL')}/verify`;
		const supabase = await supabaseClient();
		const { error } = await supabase.auth.resend({
			type: 'signup',
			email,
			options: {
				emailRedirectTo,
			},
		});
		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}
		return ok({ sent: true });
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\auth\session-context-service.ts

```ts

```

### File: apps\web\server\auth\_shared\types.ts

```ts
import type { AuthResponse, AuthTokenResponsePassword, SupabaseClient } from 'supabaseClient';

export type SignUpData = AuthResponse['data'];

export type SignInData = AuthTokenResponsePassword['data'];

export type Deps = {
	getClient?: () => Promise<SupabaseClient>;
};

export type RegisterOptions = {
	emailRedirectTo?: string;
	captchaToken?: string;
	metadata?: Record<string, unknown>;
};

```

### File: apps\web\server\core\clients\supabase.ts

```ts
import { createClient, type SupabaseClient, type SupabaseClientOptions } from 'supabaseClient';

import { getAuthCookies } from '../../auth/cookies.ts';

let anonClient: SupabaseClient /*<Database>*/ | null = null;

function getEnv() {
	const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
	const ANON_KEY = Deno.env.get('SUPABASE_ANON_KEY');
	if (!SUPABASE_URL || !ANON_KEY) throw new Error('Missing SUPABASE_URL or SUPABASE_ANON_KEY');
	return { SUPABASE_URL, ANON_KEY };
}

/**
 * Returns a Supabase client:
 * - If `req` contains an access token cookie, a **new per-request client** with `Authorization: Bearer <token>`.
 * - Otherwise, a **shared anon client** (cached).
 *
 * No session persistence; SSR-safe.
 */
export async function supabaseClient(req?: Request): Promise<SupabaseClient> {
	const { SUPABASE_URL, ANON_KEY } = getEnv();

	const baseOptions: SupabaseClientOptions<'public'> = {
		auth: {
			persistSession: false,
			detectSessionInUrl: false,
		},
	};

	if (req) {
		const { accessToken } = getAuthCookies(req);
		if (accessToken) {
			return createClient(SUPABASE_URL, ANON_KEY, {
				...baseOptions,
				global: {
					headers: {
						Authorization: `Bearer ${accessToken}`,
					},
				},
			});
		}
	}

	if (!anonClient) {
		anonClient = createClient(SUPABASE_URL, ANON_KEY, baseOptions);
	}
	return anonClient;
}

```

### File: apps\web\server\core\errors\normalise.ts

```ts
export function normaliseSupabaseError(error: unknown): {
	code: string;
	message: string;
	status?: number;
} {
	const e = error as { code?: string; message?: string; status?: number };
	const raw = (e.code ?? '').toLowerCase();

	if (raw.includes('rate') || e.status === 429) {
		return {
			code: 'rate_limit',
			message: e.message ?? 'Too many attempts. Please try later.',
			status: 429,
		};
	}
	if (raw.includes('user') && raw.includes('exists')) {
		return { code: 'user_exists', message: e.message ?? 'User already exists.', status: 409 };
	}
	if ((raw.includes('invalid') && raw.includes('credentials')) || e.status === 401) {
		return {
			code: 'invalid_credentials',
			message: e.message ?? 'Invalid email or password.',
			status: 401,
		};
	}
	if (raw === 'signup_failed' || raw === 'invalid_signup' || e.status === 400) {
		return {
			code: 'signup_failed',
			message: e.message ?? 'Sign up failed.',
			status: e.status ?? 400,
		};
	}

	return { code: raw || 'auth_error', message: e.message ?? 'Authentication error.' };
}

export function normaliseUnknownError(err: unknown): {
	code: string;
	message: string;
} {
	if (err && typeof err === 'object') {
		const anyErr = err as { name?: string; message?: string };
		const name = (anyErr.name ?? '').toLowerCase();
		const message = anyErr.message ?? 'Unknown error';
		if (name === '' || name === 'error') {
			return { code: 'unknown_error', message };
		}
		return { code: name, message };
	}
	return { code: 'unknown_error', message: 'Unknown error' };
}

```

### File: apps\web\server\core\http\result.ts

```ts
export type Ok<T> = { ok: true; data: T };
export type Fail = { ok: false; error: { code: string; message: string; status?: number } };
export type Result<T> = Ok<T> | Fail;

export function ok<T>(data: T): Ok<T> {
	return { ok: true, data };
}
export function fail(code: string, message: string, status?: number): Fail {
	return { ok: false, error: { code, message, status } };
}

```

### File: apps\web\server\core\validation\email.ts

```ts
export function isLikelyEmail(s: string): boolean {
	if (!s || !s.includes('@')) return false;
	const [, domain = ''] = s.split('@');
	return domain.includes('.') && !/\s/.test(s);
}

```

### File: apps\web\server\env.ts

```ts
import { loadSync } from '@std/dotenv';

loadSync({ export: true });

const mode = Deno.env.get('MODE') ??
	Deno.env.get('NODE_ENV') ??
	Deno.env.get('VITE_MODE') ??
	'development';

loadSync({ envPath: `.env.${mode}`, export: true });

```

### File: apps\web\server\middleware\auth\verify_guard.ts

```ts
import { Deps, SignInData } from '../../auth/_shared/types.ts';
import { supabaseClient } from '../../core/clients/supabase.ts';
import { normaliseSupabaseError, normaliseUnknownError } from '../../core/errors/normalise.ts';
import { fail, ok, Result } from '../../core/http/result.ts';
import { isLikelyEmail } from '../../core/validation/email.ts';

export async function loginWithEmail(email: string, deps: Deps = {}): Promise<any> {
	const e = (email ?? '').trim().toLowerCase();

	try {
		const getClient = deps.getClient ?? supabaseClient;
		const supabase = await getClient();

		const { data, error } = await supabase.auth.get({ email: e, password: p });

		if (error) {
			const n = normaliseSupabaseError(error);
			return fail(n.code, n.message, n.status);
		}

		return ok(data);
	} catch (err) {
		const n = normaliseUnknownError(err);
		return fail(n.code, n.message, 500);
	}
}

```

### File: apps\web\server\middleware\auth_guard.ts

```ts

```

### File: apps\web\styles\components\auth\login-button.css

```css
.login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  background-color: black;
  color: white;
  border-radius: var(--border-radius__large);

  &:disabled {
    background-color: red;
  }
}

```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-1.css

```css
.onboarding-stage-1 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;

    .onboarding-stage-1__account-type__container {
        display: flex;
        gap: 0.75em;
        width: 100%;

        .onboarding-stage-1__account-type {
            width: 100%;
            background-color: #fff5;
            color: var(--primary);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--fast);

            &:hover {
                background-color: #fff4;
            }

            &:has(input:checked) {
                background-color: #000;
                color: white;
                font-weight: bold;
            }
        }
    }

    .onboarding-stage-1__separator {
        width: 100%;
        border: 1px solid #fff3;
    }

    .onboarding-stage-1__name {
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 0.75em;
    }
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-2.css

```css
.onboarding-stage-2 {
    display: flex;
    flex-direction: column;
    gap: 0.75em;
    width: 100%;
}
```

### File: apps\web\styles\components\auth\onboarding\onboarding-stage-3.css

```css

```

### File: apps\web\styles\components\auth\provider-login-button.css

```css
.provider-login-button {
  font-size: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1em;
  padding: 0.5em 1em;
  width: 100%;

  border: 1px solid hsla(0, 100%, 100%, 0.2);
  color: white;
  border-radius: var(--border-radius__large);
}

```

### File: apps\web\styles\components\fields\DropdownField.css

```css
.dropdown-field__container {
  width: 100%;
  position: relative;
}

.dropdown-field__input {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  border-radius: var(--border-radius);
  box-shadow: inset 0 3px 6px #0004;
  background-color: #fff;
  /* outline: 1px solid #ccc; */
  position: relative;

  .dropdown-field__input__button {
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 0.25rem;

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input {
      width: 100%;
      height: 100%;
      padding: 0.4rem;
      text-align: left;
    }

    .dropdown-field__input__button__span,
    .dropdown-field__input__button__input::placeholder {
      color: var(--text-dark);
    }
  }

  &:has(.dropdown-field__input__selected) {
    .dropdown-field__input__button {
      padding: 0.25rem 0;

      .dropdown-field__input__button__span,
      .dropdown-field__input__button__input {
        padding: 0.4rem 0;
      }
    }
  }

  .dropdown-field__input__selected {
    height: 100%;
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 0.25rem;

    .dropdown-field__input__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: var(--border-radius);

      background-color: #fff;
      box-shadow: 0 2px 6px #0004;
      padding: 0.3rem 0.4rem;
      color: var(--text);

      .dropdown-field__input__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}


.dropdown-field__selected__container {
  width: 100%;
  display: flex;

  .dropdown-field__selected {
    position: relative;
    width: 100%;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
    border: 1px solid var(--card);
    border-radius: var(--border-radius);
    padding: 0.5rem;

    .dropdown-field__selected__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      border-radius: 2rem;

      background-color: var(--primary-half);
      padding: 0.2rem 0.5rem;
      color: white;
      font-size: 0.8rem;

      .dropdown-field__selected__item__close {
        padding: 0;
        margin: 0;
        height: 1rem;
        width: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }
}
```

### File: apps\web\styles\components\fields\FormStages.css

```css
.form-stages {
  display: flex;
  align-items: center;
  gap: 1em;

  .form-stages__item {
    display: flex;
    align-items: center;
    gap: 1em;
    position: relative;

    &[data-selected="true"] {
      font-weight: bold;

      .form-stages__item__container {

        opacity: 1;
      }
    }

    .form-stages__item__container {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.5;


      .form-stages__item__circle {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 4em;
        width: 4em;
        background-color: white;
        color: var(--primary);
        font-weight: bold;
        border-radius: 4em;

        p {
          padding: 0;
          margin: 0;
          font-size: 2em;
        }
      }

      .form-stages__item__name {
        font-size: 1;
        padding-top: 0.5em;
        margin: 0;
      }
    }

    .form-stages__item__divider {
      position: relative;
      width: 5em;
      border: 0.1em dashed white;
      top: -0.75em;
      opacity: 0.3;
    }
  }
}
```

### File: apps\web\styles\components\fields\TextField.css

```css
.text-field,
.password-field,
.text-area-field {
  display: flex;
  align-items: center;
  gap: 1em;
  justify-content: space-between;
  width: 100%;

  background-color: hsla(0, 100%, 100%, 0.3);
  border-radius: var(--border-radius);

  * {
    stroke: var(--primary);
  }

  textarea,
  input {
    font-size: inherit;
    padding: 0.8em 1em;
    outline: none;
    border: none;
    background: none;
    width: 100%;

    &::placeholder {
      color: var(--primary);
    }
  }
}

.text-field__container {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-guest.css

```css
.header-container {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10rem;
}

.header__buttons {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-weight: bold;

  .header__buttons__user {
    padding: 0.4rem 2rem;
    border-radius: var(--border-radius);
    transition: background var(--medium), color var(--medium),
      border var(--medium);

    &.header__buttons__login {
      color: var(--primary);
      border: 1px solid var(--primary);

      &:hover {
        border: 1px solid var(--primary-highlight);
        color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }

    &.header__buttons__join {
      background-color: var(--primary);
      color: white;

      &:hover {
        background-color: var(--primary-highlight);
        box-shadow: 0 0 12px var(--primary);
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-actions.css

```css
  .nav-bar-user__profile__dropdown__actions {
    display: flex;
    flex-direction: column;

    a {
      padding: 0.5em 1em;
      border-radius: var(--border-radius__small);
      cursor: pointer;

      &:hover {
        background-color: var(--button-hover);
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-business.css

```css
  .nav-bar-user__profile__dropdown__switch__business {
    width: 100%;
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-switch.css

```css
  .nav-bar-user__profile__dropdown__switch {
    display: flex;
    flex-direction: column;
    align-items: center;

    .nav-bar-user__profile__dropdown__switch__switch {
      display: flex;
      justify-content: space-evenly;
      width: 100%;

      .nav-bar-user__profile__dropdown__switch__label {
        cursor: pointer;

        &:has(input:checked) {
          color: var(--primary);
          font-weight: bold;
        }
      }
    }

    hr {
      width: 75%;
      border: 1px solid var(--text-dark);
    }

    .nav-bar-user__profile__dropdown__switch__account-type {
      width: 75%;

      .nav-bar-user__profile__dropdown__add {
        width: 100%;
        color: var(--button-hover-light);
        border: 1px solid var(--button-hover-light);
        padding: 0.5rem 0;
        border-radius: var(--border-radius__small);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 0.8em;

        &:hover {
          background-color: var(--button-hover);
          color: var(--text);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown-teams.css

```css
.nav-bar-user__profile__dropdown__teams {
  width: 100%;
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile-dropdown.css

```css
  .nav-bar-user__profile__dropdown {
    position: absolute;
    top: var(--header-height);
    right: 0;
    background-color: var(--header);
    width: 400px;
    padding: 1em;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    border-radius: var(--border-radius__large);

    .nav-bar-user__profile__dropdown__current {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .nav-bar-user__profile__dropdown__current__profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;

        img {
          height: 4em;
          width: 4em;
          border-radius: 4em;
          border: 1px solid var(--text-dark);
        }

        p {
          margin: 0;
          padding: 0;
        }

        .nav-bar-user__profile__dropdown__current__profile__name {

          .nav-bar-user__profile__dropdown__current__profile__name__name {
            font-size: 1.5em;
            font-weight: 500;
          }

          .nav-bar-user__profile__dropdown__current__profile__name__username {
            font-size: 0.8em;
            color: var(--text-medium);
          }
        }
      }

      .nav-bar-user__profile__dropdown__current__switch {
        border-radius: var(--border-radius__small);
        height: 2rem;
        width: 2rem;

        display: flex;
        align-items: center;
        justify-content: center;

        svg * {
          stroke: var(--text-medium);
        }

        &:hover {
          background-color: var(--button-hover);
        }
      }
    }
  }
```

### File: apps\web\styles\components\navigation\nav-bar-user-profile.css

```css
.nav-bar-user__profile {
  position: relative;

  .nav-bar-user__profile__btn {
    height: 2.75rem;
    width: 2.75rem;
    min-height: 2.75rem;
    min-width: 2.75rem;
    max-height: 2.75rem;
    max-width: 2.75rem;
    border-radius: 4rem;

    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;

    .nav-bar-user__profile__btn__img {
      min-height: inherit;
      min-width: inherit;

      border: 1px solid var(--text-dark);
      border-radius: 4rem;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;

      img {
        min-height: inherit;
        min-width: inherit;
      }
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user-side.css

```css
.nav-bar-user-side {
  position: fixed;
  left: 1rem;
  top: calc(var(--header-height) + 1rem);
  width: var(--side-nav-width);
  height: calc(100% - var(--header-height) - 1rem);
  z-index: 1000;
  display: flex;

  .nav-bar-user-side__container {
    margin: 1rem 0;
    height: 100%;
    max-height: calc(100% - 4rem);
    width: 100%;
    background-color: var(--header);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    position: relative;
    border-radius: 1rem;
  }

  .nav-bar-user-side__group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    width: 100%;

    .nav-bar-user-side__app {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 2.5rem;

      &[data-selected="true"] {
        box-shadow: 0 0 12px var(--primary);
        background-color: var(--primary-half);
        outline: 1px solid var(--primary);
        color: white;
      }
    }
  }

  .nav-bar-user-side__open {
    position: absolute;
    left: 0.75rem;
    bottom: 1rem;
  }

  a,
  button {
    border-radius: var(--border-radius__small);
    height: 2.5rem;
    min-height: 2.5rem;
    width: 2.5rem;
    min-width: 2.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-dark);

    &:hover {
      background-color: var(--button-hover);
      color: var(--text-medium);
    }
  }

  hr {
    border: 1px solid var(--text-dark);
    width: 80%;
    opacity: 0.5;
  }

  &[data-sidebar-open='true'] {
    .nav-bar-user-side__app {
      justify-content: start !important;
      gap: 0.5rem !important;
      padding: 0 0.5rem !important;
      width: calc(100% - 1rem) !important;
    }

    [data-tooltip]::before {
      display: none;
    }

    [data-tooltip]:hover::before {
      display: none;
    }
  }

  &[data-sidebar-open='false'] {
    .nav-bar-user-side__app {
      justify-content: center !important;
      gap: 0 !important;
      padding: 0 !important;
      width: 100% !important;
    }

    [data-tooltip]::before {
      left: 100% !important;
      transform: translate(1rem, calc(-100% - 0.75rem));
    }
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar-user.css

```css
.nav-bar-user {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1rem;

  .nav-bar-user__logo {
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;

    .nav-bar-user__logo__svg {
      height: 2rem;
      width: auto;
    }
  }

  .nav-bar-user__search {
    /* background-color: blue; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nav-bar-user__actions {
    /* background-color: green; */
    width: calc(100% / 3);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: right;
    gap: 1rem;
  }
}
```

### File: apps\web\styles\components\navigation\nav-bar.css

```css
header {
  width: 100%;
  max-width: 100vw;
  height: var(--header-height);
  position: fixed;
  top: 0;
  left: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  padding-top: 1rem;
  z-index: 1000;

  nav {
    margin: 1rem;
    width: 100%;
    height: 100%;
    background-color: var(--header);

    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 1rem;
  }
}
```

### File: apps\web\styles\components\public\explore\filters.css

```css
.explore-filters {

}
```

### File: apps\web\styles\components\search\SearchBar.css

```css
.search-bar {
  display: flex;
  align-items: center;
  gap: 0.5em;
  width: 100%;
  border-radius: var(--border-radius);
  background-color: var(--card);

  .search-bar__input {
    width: 100%;
    background: none;
    font-size: 1.5em;
    padding: 0.75em;
    outline: none;
    border: none;
  }

  .search-bar__enter {
    margin-right: 0.75em;
    height: 3.5em;
    width: 3.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--primary);
    border-radius: var(--border-radius__small);
    color: white;
  }

  &:has(.search-bar__input:focus) {
    outline: 1px solid var(--primary);
  }
}

```

### File: apps\web\styles\layouts\auth.css

```css
:root {
  main {
    margin-top: 0 !important;
  }
}

.layout-auth {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  width: 100vw;
  position: relative;
  overflow: hidden;
}

.background {
  position: absolute;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  object-fit: cover;
  z-index: -1;
}

.layout-auth__modal {
  width: 90vw;
  height: 90vh;
  background-color: var(--primary);
  color: white;
  border-radius: 50px;
  display: flex;
  gap: 2rem;
  position: relative;

  .layout-auth__modal__window {
    position: relative;
    top: 10px;
    left: 10px;
    height: calc(100% - 20px);
    width: 40%;
    border-radius: 40px;
    overflow: hidden;
    background-color: white;

    img {
      position: absolute;
      top: calc(-5vh - 10px);
      left: calc(-5vw - 10px);
      height: 100vh;
      width: 100vw;
      object-fit: cover;
      filter: brightness(1.2) blur(10px);
    }

    .layout-auth__modal__window__content {
      position: relative;
      height: calc(100% - 8rem);
      width: calc(100% - 8rem);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: white;
      padding: 4rem;

      .layout-auth__modal__window__content__quote__line-container {
        display: flex;
        align-items: center;
        gap: 1rem;

        .layout-auth__modal__window__content__quote__line {
          height: 2px;
          width: 30%;
          background-color: white;
        }
      }

      .layout-auth__modal__window__content__slogan {
        .deliver-better {
          margin-left: 20%;
        }
      }

      h1 {
        padding: 0;
        margin: 0;
        font-size: 3rem;
      }

      p {
        font-size: 1.2rem;
      }
    }
  }

  .layout-auth__modal__content {
    width: 60%;
    height: 100%;
    margin-right: 2rem;
  }
}

```

### File: apps\web\styles\pages\auth\login.css

```css
.login {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .login__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .login__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .login__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }
}

.login__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .login__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .login__fields__options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;

      .remember-me {
        display: flex;
        align-items: center;
        gap: 0.5rem;

        input[type="checkbox"] {
          width: 1rem;
          height: 1rem;
        }
      }

      a {
        color: white;
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }
    }
  }
}

.login__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}

```

### File: apps\web\styles\pages\auth\onboarding.css

```css
.onboarding {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 85%;


    .onboarding-stages-indicator {
        font-size: 0.8rem;
    }

    .onboarding-stages {
        width: 60%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;

        .onboarding-stage {
            position: relative;
            width: 100%;
            top: -4rem;

            display: flex;
            flex-direction: column;
            gap: 0.75em;
            width: 100%;

            .onboarding-stage__account-type__container {
                display: flex;
                gap: 0.75em;
                width: 100%;

                .onboarding-stage__account-type {
                    width: 100%;
                    background-color: #fff5;
                    color: var(--primary);
                    border-radius: var(--border-radius);
                    padding: 1rem;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                    transition: background-color var(--fast);

                    &:hover {
                        background-color: #fff4;
                    }

                    &:has(input:checked) {
                        background-color: #000;
                        color: white;
                        font-weight: bold;
                    }
                }
            }

            .onboarding-stage__separator {
                width: 100%;
                border: 1px solid #fff3;
            }

            .onboarding-stage__name {
                width: 100%;
                display: flex;
                justify-content: space-between;
                gap: 0.75em;
            }
        }
    }

    .onboarding-stage-location {
        width: 60%;
        display: flex;
        gap: 0.5rem;
        justify-content: space-between;

        .onboarding-back,
        .onboarding-submit,
        .onboarding-continue {
            width: 100%;
            background-color: #000;
            border-radius: var(--border-radius);
            padding: 1rem;

            &:hover {
                background-color: #222;

            }
        }
    }
}
```

### File: apps\web\styles\pages\auth\register.css

```css
.register {
  width: 100%;
  height: 85%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;

  h1,
  p {
    margin: 0;
    padding: 0;
  }

  .register__container {
    width: 60%;
    height: 80%;
    min-width: 300px;
    display: flex;
    align-items: center;

    .register__container__center {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  .register__header {
    margin-bottom: 2rem;
    text-align: left;
    width: 100%;
    font-weight: 400;

    h1 {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      font-weight: inherit;
    }
  }

  .register__field-error {
    font-size: 0.6em;
    color: red;
  }
}

.register__fields__container {
  height: 100%;
  width: 90%;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 5rem;

  .register__fields {
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;

    .register__fields__name {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
  }
}

.register__actions {
  font-size: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

.switch-auth {
  width: 80%;
  display: flex;
  justify-content: end;
  align-items: center;
  gap: 0.5rem;

  .switch-auth__text {
    margin: 0;
    padding: 0;
    font-size: 1rem;
  }

  .switch-auth__link {
    color: white;
    text-decoration: none;
    font-size: 1rem;
    font-weight: bold;
    background-color: hsla(0, 100%, 100%, 0.2);
    padding: 0.5em 2em;
    border-radius: 4rem;

    &:hover {
      background-color: hsla(0, 100%, 100%, 0.1);
    }
  }
}
```

### File: apps\web\styles\pages\home\hero.css

```css
#hero {
  position: relative;
  height: 100%;
  width: 100%;

  &.home__hero {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    .home__hero__bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      /* background-color: red;  */

      .home__hero__bg__image {
        position: absolute;
        top: -1%;
        left: -1%;
        width: 102%;
        height: 102%;
        object-fit: cover;
        filter: brightness(0.5) blur(5px) saturate(0.8);
      }
    }

    .home__hero__content {
      display: flex;
      flex-direction: column;
      width: 75%;

      .home__hero__content__title {
        font-size: 4rem;
        color: white;
        font-weight: 600;
      }


      .home__hero__content__search {
        .search-bar {
          background-color: #202020;
          color: white;
        }
      }

      .home__hero__content__actions {
        display: flex;
        justify-content: center;
        gap: 1em;
        margin-top: 2em;

        a {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.4em 1.5em;
          padding-right: 0.75em;
          border-radius: 2em;
          font-size: 1.25em;
          font-weight: 500;
          gap: 1em;
        }

        .home__hero__content__actions__join {
          background-color: var(--primary);
          color: white;
        }

        .home__hero__content__actions__join:hover {
          background-color: var(--primary-hover);
          box-shadow: 0 0 8px var(--primary);
        }

        .home__hero__content__actions__explore {
          background-color: #fff3;
          border: 1px solid white;
          color: white;
        }

        .home__hero__content__actions__explore:hover {
          background-color: #fff5;
          box-shadow: 0 0 8px white;
        }
      }
    }
  }
}

/* #hero .home__hero__bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -1;
  overflow: hidden;
}

#hero .home__hero__bg__image {
  position: absolute;
  top: -1%;
  left: -1%;
  width: 102%;
  height: 102%;
  object-fit: cover;
  filter: brightness(0.5) blur(5px) saturate(0.8);
}

#hero .home__hero__content {
  display: flex;
  flex-direction: column;
  width: 100%;
}

#hero .home__hero__content__title {
  font-size: 4rem;
  color: white;
  font-weight: 600;
}

#hero .home__hero__content__search .search-bar {
  background-color: #202020;
  color: white;
}

#hero .home__hero__content__actions {
  display: flex;
  justify-content: center;
  gap: 1em;
  margin-top: 2em;
}

#hero .home__hero__content__actions a {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.4em 1.5em;
  padding-right: 0.75em;
  border-radius: 2em;
  font-size: 1.25em;
  font-weight: 500;
  gap: 1em;
}

#hero .home__hero__content__actions__join {
  background-color: var(--primary);
  color: white;
}

#hero .home__hero__content__actions__join:hover {
  background-color: var(--primary-hover);
  box-shadow: 0 0 8px var(--primary);
}

#hero .home__hero__content__actions__explore {
  background-color: #fff3;
  border: 1px solid white;
  color: white;
}

#hero .home__hero__content__actions__explore:hover {
  background-color: #fff5;
  box-shadow: 0 0 8px white;
} */
```

### File: apps\web\styles\pages\home\home.css

```css
.home {
    position: relative;
    padding: 0;
    margin: 0;

    height: calc(100% + (var(--header-height) + 1rem));
    width: calc(100% + (var(--side-nav-width) + 1rem));

    top: calc((var(--header-height) + 1rem) * -1);
    left: calc((var(--side-nav-width) + 1rem) * -1);
}
```

### File: apps\web\styles\pages\public\explore\search.css

```css
.search-page__container {
    display: flex;
    justify-content: center;
}

.search-page {
    width: 90%;

    .search-page__search {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;

        .search-page__search__title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .search-page__search__related {}

        .search-page__search__search-bar {}
    }

    .search-page__options {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1.5rem;
        margin-bottom: 2rem;

        .search-page__options__top,
        .search-page__options__bottom {
            width: 100%;
            display: flex;
            align-items: space-between;
        }

        .search-page__options__results-count,
        .search-page__options__category-type,
        .search-page__options__layout,
        .search-page__options__categories,
        .search-page__options__sort,
        .search-page__options__toggle-filter {
            width: 100%;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .search-page__options__results-count,
        .search-page__options__toggle-filter {
            justify-content: left;
        }

        .search-page__options__category-type,
        .search-page__options__categories {
            justify-content: center;
        }

        .search-page__options__sort,
        .search-page__options__layout {
            justify-content: right;
        }

        .search-page__options__top {

            .search-page__options__sort button,
            .search-page__options__toggle-filter label {
                border: 1px solid var(--text-medium);
                color: var(--text);
                padding: 0.5em 2em;
                margin: 0;
                font-size: 1rem;
                cursor: pointer;
            }

            .search-page__options__sort * {
                border-radius: var(--border-radius);
            }

            .search-page__options__toggle-filter label {
                border-radius: 2em;
            }

            .search-page__options__categories {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    border-radius: 2rem;
                    text-align: center;
                    width: 6rem;
                    cursor: pointer;
                    color: var(--text-medium);
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        font-weight: bold;
                    }
                }
            }
        }

        .search-page__options__bottom {
            .search-page__options__layout {
                display: flex;
                gap: 0.5rem;

                label {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 0.5rem;
                    height: 2rem;
                    width: 2rem;
                    padding: 0.2rem;

                    background: none;
                    border-radius: var(--border-radius);

                    outline: 1px solid var(--text-medium);
                    color: var(--text-medium);

                    cursor: pointer;

                    &:has(input:checked) {
                        background: var(--primary);
                        color: white;
                        outline: none;
                    }
                }
            }

            .search-page__options__category-type {
                display: flex;
                gap: 0.5rem;

                label {
                    padding: 0.5em 2em;
                    text-align: center;
                    margin: 0;
                    width: 6rem;

                    background: none;

                    border-top: 1px solid var(--card);
                    color: var(--text-medium);
                    cursor: pointer;
                    transition: all var(--fast);

                    &:hover {
                        background-color: var(--card);
                        border-top: 1px solid var(--bg);
                        border-radius: var(--border-radius);
                    }

                    &:has(input:checked) {
                        background-color: var(--primary);
                        color: white;
                        border-top: 1px solid var(--bg);
                        font-weight: bold;
                        border-radius: var(--border-radius);
                    }
                }
            }

            .search-page__options__results-count {
                p {
                    margin: 0;
                    padding: 0;
                    font-size: 0.8rem;
                    color: var(--text-medium);
                }
            }
        }
    }

    .search-page__results {
        display: flex;
        gap: 1rem;
        position: relative;

        .search-page__results__filters__container {
            width: 20vw;
            min-width: 20rem;
            min-height: 30rem;
            height: fit-content;
            position: sticky;
            background-color: var(--header);
            top: calc(var(--header-height) + 2rem);
            border-radius: var(--border-radius__large);
            padding: 2rem;

            /* .search-page__results__filters {
                width: 100%;
                height: fit-content;
                position: sticky;
                background-color: pink;
            } */
        }

        .search-page__results__content {
            background-color: blue;
            width: 100%;
            height: 200vh;
        }
    }
}
```

### File: apps\web\styles\styles.css

```css
@import "themes/light.css";
@import "themes/dark.css";

:root {
  --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
    "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  --font-dyslexia: "OpenDyslexic", Atkinson, var(--font-sans);

  --scale: 1;

  --primary-hue: 186;
  --primary-saturation: 57%;
  --primary-lightness: 36%;

  --primary: hsl(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness));
  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 60%);

  --primary-half: hsla(var(--primary-hue),
      var(--primary-saturation),
      var(--primary-lightness), 0.5);

  --header-height: 4rem;
  --side-nav-width: 0;

  --border-radius__xsmall: 4px;
  --border-radius__small: 6px;
  --border-radius: 8px;
  --border-radius__large: 12px;
  --border-radius__xlarge: 16px;

  --fast: 100ms;
  --medium: 200ms;
  --slow: 300ms;

  background-color: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);

  [data-sidebar-open] {
    --side-nav-width: 4rem;

  }

  [data-sidebar-open='true'] {
    --side-nav-width: 14rem;
  }
}

body {
  width: 100%;
  margin: 0;
  padding: 0;

  main {
    position: relative;
    margin: 0;
    padding: 0;
  }
}

.container {
  position: relative;
  height: calc(100vh - (var(--header-height) + 1rem));
  width: calc(100vw - (var(--side-nav-width) + 2.1rem));
  top: calc(var(--header-height) + 1rem);
  left: calc(var(--side-nav-width) + 1rem);
}

a {
  text-decoration: none;
  color: inherit;
  transition: all var(--fast);
}

input,
button {
  font-family: inherit;
  border: none;
  background: none;
  color: inherit;
  outline: none;
  border: none;
}

button {
  cursor: pointer;
  transition: all var(--fast);
}

[data-tooltip] {
  position: relative;
}

[data-tooltip]::before {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  top: calc(100% + 0.5rem);
  transform: translateX(-50%);
  color: var(--text-medium);
  background-color: var(--card);
  border: 1px solid var(--card-light);
  border-radius: var(--border-radius);
  padding: 0.25rem 1rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity var(--fast) ease;
  z-index: 100;
  font-size: 0.75rem;
}

[data-tooltip]:hover::before {
  opacity: 1;
}
```

### File: apps\web\styles\themes\dark.css

```css
:root[data-theme="dark"] {
  --bg: #222222;
  --header: #191919;
  --text: #ffffff;
  --text-medium: #999;
  --text-dark: #555555;
  --card: #303030;
  --card-dark: #202020;
  --card-light: #555555;
  --button-hover: #fff2;
  --button-hover-light: #fff6;

  --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
  --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
  --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
  --primary-highlight-active: hsl(var(--primary-hue),
      var(--primary-saturation),
      55%);
}
```

### File: apps\web\styles\themes\dim.css

```css

```

### File: apps\web\styles\themes\dyslexia.css

```css

```

### File: apps\web\styles\themes\high-contrast.css

```css

```

### File: apps\web\styles\themes\light.css

```css
:root {
    --bg: #f0f0f0;
    --header: #ffffff;
    --text: #000000;
    --text-medium: #999;
    --text-dark: #BBBBBB;
    --card: #dfdfdf;
    --card-dark: #202020;
    --card-light: #555555;
    --button-hover: #0002;
    --button-hover-light: #0006;

    --primary-hover: hsl(var(--primary-hue), var(--primary-saturation), 30%);
    --primary-active: hsl(var(--primary-hue), var(--primary-saturation), 20%);
    --primary-highlight: hsl(var(--primary-hue), var(--primary-saturation), 50%);
    --primary-highlight-active: hsl(var(--primary-hue),
            var(--primary-saturation),
            55%);
}
```

### File: apps\web\styles\themes\reduce-motion.css

```css

```

### File: apps\web\styles\themes\sepia.css

```css

```

### File: apps\web\tests\api\auth\login_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { loginWithEmail } from '../../../server/auth/email/login.ts';

type FakeAuthReturn =
	| { data: { user: unknown; session: unknown }; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>) {
	return {
		auth: {
			signInWithPassword: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: {
			signInWithPassword: (a: { email: string; password: string }) => Promise<FakeAuthReturn>;
		};
	};
}

Deno.test({
	name: 'loginWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await loginWithEmail({ email: 'nope', password: 'whatever' });
		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'loginWithEmail: invalid credentials -> 401',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Invalid login credentials', code: 'invalid_credentials', status: 401 },
		}));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'wrong' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'invalid_credentials');
		assertEquals(res.error.status, 401);
	},
});

Deno.test({
	name: 'loginWithEmail: success returns user+session',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const data = {
			user: { id: crypto.randomUUID(), email: 'a@example.com' },
			session: { access_token: 'token', expires_in: 3600 },
		};
		const client = fakeClient(async () => ({ data, error: null }));

		const res = await loginWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data.user, data.user);
		assertEquals(res.data.session, data.session);
	},
});

```

### File: apps\web\tests\api\auth\register_with_email.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import { registerWithEmail } from '../../../server/auth/email/register.ts';

type FakeAuthReturn =
	| { data: unknown; error: null }
	| { data: null; error: { message: string; code?: string; status?: number } };

function fakeClient(
	impl: (args: { email: string; password: string }) => Promise<FakeAuthReturn>,
) {
	return {
		auth: {
			signUp: ({ email, password }: { email: string; password: string }) =>
				impl({ email, password }),
		},
	} as unknown as {
		auth: { signUp: (a: { email: string; password: string }) => Promise<FakeAuthReturn> };
	};
}

Deno.test({
	name: 'registerWithEmail: missing email/password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: '', password: '' } as unknown as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: invalid email format -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'not-an-email', password: 'secret123!' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: short password -> bad_request',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail({ email: 'a@example.com', password: 'short' } as {
			email: string;
			password: string;
		});

		assert(!res.ok);
		assertEquals(res.error.code, 'bad_request');
	},
});

Deno.test({
	name: 'registerWithEmail: propagates Supabase error (e.g., rate_limit 429)',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const client = fakeClient(async () => ({
			data: null,
			error: { message: 'Email rate limit exceeded', code: 'rate_limit', status: 429 },
		}));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'rate_limit');
		assertEquals(res.error.status, 429);
	},
});

Deno.test({
	name: 'registerWithEmail: success returns ok and data',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const user = {
			user: { id: '00000000-0000-0000-0000-000000000000', email: 'a@example.com' },
			session: null,
		};
		const client = fakeClient(async () => ({ data: user, error: null }));

		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{ getClient: async () => client as never },
		);

		assert(res.ok);
		assertEquals(res.data, user as unknown);
	},
});

Deno.test({
	name: 'registerWithEmail: thrown error -> unknown_error',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const res = await registerWithEmail(
			{ email: 'a@example.com', password: 'secret123!' },
			{
				getClient: async () => {
					throw new Error('boom');
				},
			},
		);

		assert(!res.ok);
		assertEquals(res.error.code, 'unknown_error');
	},
});

```

### File: apps\web\tests\api\meta\health.test.ts

```ts
import { assert, assertEquals } from '../../_helpers/asserts.ts';
import * as Health from '../../../routes/api/v1/meta/health.ts';

const GET = (Health as unknown as {
	GET?: (r: Request) => Promise<Response>;
	handler?: { GET: (r: Request) => Promise<Response> };
}).GET ??
	(Health as unknown as { handler?: { GET: (r: Request) => Promise<Response> } }).handler?.GET;

const HEAD = (Health as unknown as {
	HEAD?: (r: Request) => Promise<Response>;
	handler?: { HEAD: (r: Request) => Promise<Response> };
}).HEAD ??
	(Health as unknown as { handler?: { HEAD: (r: Request) => Promise<Response> } }).handler?.HEAD;

if (typeof GET !== 'function') {
	throw new Error('Health GET handler not found (expected export GET or handler.GET).');
}
if (typeof HEAD !== 'function') {
	throw new Error('Health HEAD handler not found (expected export HEAD or handler.HEAD).');
}

Deno.test({
	name: 'GET /api/v1/meta/health returns a valid payload',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'GET' });
		const res = await GET(req);

		assertEquals(res.status, 200);
		assert(res.headers.get('content-type')?.includes('application/json'));

		const json = await res.json() as {
			status: string;
			service: string;
			version: string;
			uptime_ms: number;
			started_at: string;
			commit?: string;
			env: string;
		};

		assertEquals(json.status, 'ok');
		assert(typeof json.service === 'string' && json.service.length > 0);
		assert(typeof json.version === 'string');
		assert(Number.isFinite(json.uptime_ms) && json.uptime_ms >= 0);
		assert(!Number.isNaN(Date.parse(json.started_at)));
		assert(typeof json.env === 'string');
	},
});

Deno.test({
	name: 'HEAD /api/v1/meta/health is fast and empty',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	async fn() {
		const req = new Request('http://localhost/api/v1/meta/health', { method: 'HEAD' });
		const res = await HEAD(req);

		assertEquals(res.status, 200);
		const body = await res.text();
		assertEquals(body, '');
		assert(res.headers.get('cache-control')?.includes('no-store'));
	},
});

```

### File: apps\web\tests\unit\math.test.ts

```ts
import { assertEquals } from '../_helpers/asserts.ts';

Deno.test({
	name: 'add()',
	sanitizeOps: true,
	sanitizeResources: true,
	sanitizeExit: true,
	fn() {
		const add = (a: number, b: number) => a + b;
		assertEquals(add(2, 3), 5);
	},
});

```

### File: apps\web\tests\_helpers\asserts.ts

```ts
export { assert, assertEquals, assertMatch, assertRejects, assertStrictEquals } from '@std/assert';

export { restore, stub } from '@std/testing/mock';

```

### File: apps\web\tests\_helpers\request.ts

```ts
type HttpMethod = 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
type RouteHandler = (req: Request) => Promise<Response> | Response;

export async function call(handler: RouteHandler, init?: RequestInit) {
	const req = new Request('http://localhost/test', init);
	const res = await handler(req);
	const body = await res.text();
	const json = safeJson(body);
	return { res, body, json };
}

function safeJson(s: string) {
	try {
		return JSON.parse(s);
	} catch {
		return undefined;
	}
}

export function json(method: HttpMethod, data?: unknown, headers: HeadersInit = {}) {
	return {
		method,
		headers: { 'content-type': 'application/json', ...headers },
		body: data === undefined ? undefined : JSON.stringify(data),
	} satisfies RequestInit;
}

```

### File: apps\web\utils.ts

```ts
// apps/web/utils/index.ts
import { createDefine } from 'fresh';

// Per-request state (you can mutate its fields)
export interface State {
	shared?: string;

	// Auth middleware flags
	refreshedTokens?: { access: string; refresh: string } | null;
	clearAuth?: boolean;
	isAuthenticated?: boolean;
	isOnboarded?: boolean;
}

export const define = createDefine<State>();

```

### File: db\functions\auth_project_or_dm_participant.sql

```sql
��- -   E x a m p l e   S Q L   f u n c t i o n  
 
```

### File: db\migrations\0001_init_schemas.sql

```sql
-- db/migrations/0001_init_schemas.sql

-- core schemas
CREATE SCHEMA IF NOT EXISTS security;
CREATE SCHEMA IF NOT EXISTS org;
CREATE SCHEMA IF NOT EXISTS projects;
CREATE SCHEMA IF NOT EXISTS comms;
CREATE SCHEMA IF NOT EXISTS finance;
CREATE SCHEMA IF NOT EXISTS marketplace;
CREATE SCHEMA IF NOT EXISTS search;
CREATE SCHEMA IF NOT EXISTS ops;
CREATE SCHEMA IF NOT EXISTS analytics;
CREATE SCHEMA IF NOT EXISTS integrations;

-- enums
CREATE TYPE profile_type AS ENUM ('freelancer', 'business');
CREATE TYPE assignment_type AS ENUM ('freelancer', 'team');
CREATE TYPE visibility AS ENUM ('public', 'invite_only', 'unlisted');
CREATE TYPE project_status AS ENUM ('draft', 'active', 'on_hold', 'completed', 'cancelled');
CREATE TYPE stage_status AS ENUM ('open','assigned','in_progress','submitted','approved','revisions','paid');
CREATE TYPE dispute_status AS ENUM ('open', 'under_review', 'resolved', 'refunded');


```

### File: db\migrations\0002_security_tables.sql

```sql
CREATE TABLE security.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  action text NOT NULL,
  entity_table text NOT NULL,
  entity_id uuid NOT NULL,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  ip inet,
  user_agent text,
  request_id uuid,
  actor_profile_id uuid,
  actor_team_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);

CREATE TABLE security.feature_flags (
  key text NOT NULL,
  enabled boolean NOT NULL DEFAULT false,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT feature_flags_pkey PRIMARY KEY (key)
);

CREATE TABLE security.refresh_tokens (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL,
    token_hash text NOT NULL,
    revoked boolean NOT NULL DEFAULT false,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        replaced_by uuid,
        CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id),
        CONSTRAINT refresh_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id),
        CONSTRAINT refresh_tokens_replaced_by_fkey FOREIGN KEY (replaced_by) REFERENCES security.refresh_tokens (id)
);

CREATE TABLE security.session_context (
    user_id uuid NOT NULL,
    active_profile_type USER - DEFINED NOT NULL,
    active_profile_id uuid NOT NULL,
    active_team_id uuid,
    updated_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT session_context_pkey PRIMARY KEY (user_id),
        CONSTRAINT session_context_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);

CREATE TABLE security.turnstile_verifications (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid,
    ip inet NOT NULL,
    token_prefix text NOT NULL,
    success boolean NOT NULL,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT turnstile_verifications_pkey PRIMARY KEY (id),
        CONSTRAINT turnstile_verifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);
```

### File: db\migrations\0003_org_tables.sql

```sql
CREATE TABLE org.business_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_user_id uuid NOT NULL REFERENCES auth.users(id),
  name text NOT NULL,
  legal_name text,
  logo_url text,
  country text,
  billing_email text NOT NULL,
  plan text NOT NULL DEFAULT 'free',
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  default_currency text
);

CREATE TABLE org.freelancer_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id),
  hourly_rate integer,
  skills text[] NOT NULL DEFAULT '{}',
  bio text NOT NULL DEFAULT '',
  headline text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  country text,
  visibility text NOT NULL DEFAULT 'public', 
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.skills (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    slug text NOT NULL UNIQUE,
    label text NOT NULL
);

CREATE TABLE org.user_skills (
    user_id uuid NOT NULL REFERENCES auth.users (id),
    skill_id uuid NOT NULL REFERENCES org.skills (id),
    proficiency smallint,
    PRIMARY KEY (user_id, skill_id)
);

CREATE TABLE org.users_public (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id),
  avatar_url text,
  country text,
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  visibility text NOT NULL DEFAULT 'unlisted',
  first_name text,
  last_name text,
  username text NOT NULL UNIQUE
);

CREATE TABLE org.teams (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    name text NOT NULL,
    owner_user_id uuid NOT NULL REFERENCES auth.users (id),
    description text NOT NULL DEFAULT '',
    visibility text NOT NULL DEFAULT 'invite_only',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.team_memberships (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    role text NOT NULL DEFAULT 'freelancer',
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (team_id, user_id)
);

CREATE TABLE org.team_roles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    title text NOT NULL,
    permissions jsonb NOT NULL DEFAULT '{}'
);

CREATE TABLE org.user_emails (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    email text NOT NULL,
    is_primary boolean NOT NULL DEFAULT false,
    verified_at timestamptz,
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (user_id, email)
);

CREATE TABLE org.attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_profile_id uuid NOT NULL,
    bucket text NOT NULL,
    path text NOT NULL,
    original_filename text NOT NULL,
    display_name text NOT NULL,
    mime_type text NOT NULL,
    size_bytes bigint NOT NULL,
    sha256 text,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_freelancer FOREIGN KEY (owner_profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_business FOREIGN KEY (owner_profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.portfolios (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id),
    title text NOT NULL,
    description text NOT NULL,
    cover_url text,
    attachment_id uuid REFERENCES org.attachments (id) ON DELETE SET NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.profile_links (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_type text NOT NULL,
    profile_id uuid NOT NULL,
    kind text NOT NULL,
    url text NOT NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.org_invitations (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    inviter_user_id uuid NOT NULL REFERENCES auth.users (id),
    target_email text NOT NULL,
    team_id uuid REFERENCES org.teams (id) ON DELETE CASCADE,
    business_profile_id uuid REFERENCES org.business_profiles (id) ON DELETE CASCADE,
    token text NOT NULL,
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz NOT NULL DEFAULT now()
);
```

### File: db\migrations\0004_ops_tables.sql

```sql
CREATE TABLE ops.admin_users (
  user_id uuid NOT NULL,
  role text NOT NULL DEFAULT 'admin'::text,
  granted_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT admin_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT admin_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT admin_users_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES auth.users(id)
);
```

### File: db\migrations\0005_projects_tables.sql

```sql
CREATE TABLE IF NOT EXISTS projects.projects (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    client_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    title text NOT NULL,
    description text NOT NULL,
    status project_status NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_projects_client_business ON projects.projects (client_business_id);

CREATE INDEX IF NOT EXISTS idx_projects_status_created_at ON projects.projects (status, created_at DESC);

CREATE TABLE IF NOT EXISTS projects.project_stages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    "order" integer NOT NULL,
    description text NOT NULL,
    status stage_status NOT NULL DEFAULT 'open',
    due_date timestamptz NULL,
    completed_at timestamptz NULL,
    stage_type text NULL,
    ip_mode text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_project_stages_project_order ON projects.project_stages (project_id, "order");

CREATE INDEX IF NOT EXISTS idx_project_stages_project_status ON projects.project_stages (project_id, status);

CREATE TABLE IF NOT EXISTS projects.stage_budget_rules (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    type text NOT NULL,
    amount_currency text NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    notes text NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_budget_rules_stage ON projects.stage_budget_rules (project_stage_id);

CREATE TABLE IF NOT EXISTS projects.stage_assignments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    assignee_type assignment_type NOT NULL,
    freelancer_profile_id uuid NULL REFERENCES org.freelancer_profiles (id) ON DELETE SET NULL,
    team_id uuid NULL REFERENCES org.teams (id) ON DELETE SET NULL,
    assigned_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    status text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_stage_assignments_assignee CHECK (
        (
            assignee_type = 'freelancer'
            AND freelancer_profile_id IS NOT NULL
            AND team_id IS NULL
        )
        OR (
            assignee_type = 'team'
            AND team_id IS NOT NULL
            AND freelancer_profile_id IS NULL
        )
    )
);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_stage ON projects.stage_assignments (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_freelancer ON projects.stage_assignments (freelancer_profile_id)
WHERE
    freelancer_profile_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_stage_assignments_team ON projects.stage_assignments (team_id)
WHERE
    team_id IS NOT NULL;

CREATE TABLE IF NOT EXISTS projects.stage_submissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    submitted_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_stage_submissions_stage_created ON projects.stage_submissions (
    project_stage_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS projects.stage_revision_requests (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    requested_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    type text NOT NULL,
    reason text NOT NULL,
    status text NOT NULL DEFAULT 'open',
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_stage ON projects.stage_revision_requests (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_status ON projects.stage_revision_requests (status);

CREATE TABLE IF NOT EXISTS projects.maintenance_contracts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT,
    business_profile_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    currency text NOT NULL,
    interval text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_project ON projects.maintenance_contracts (project_id);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_business ON projects.maintenance_contracts (business_profile_id);

CREATE TABLE IF NOT EXISTS projects.project_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_project_participants_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_project_participants_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_project_participants_project_profile ON projects.project_participants (
    project_id,
    profile_type,
    profile_id
);

CREATE INDEX IF NOT EXISTS idx_project_participants_profile ON projects.project_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS projects.project_activity (
id            uuid        PRIMARY KEY DEFAULT gen_random_uuid(),
project_id    uuid        NOT NULL REFERENCES projects.projects(id) ON DELETE CASCADE,
actor_user_id uuid        NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
kind          text        NOT NULL, 
payload       jsonb       NOT NULL DEFAULT '{}'::jsonb,
entity_table  text        NOT NULL,
entity_id     uuid        NOT NULL,
created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_project_activity_project_created ON projects.project_activity (project_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_project_activity_entity ON projects.project_activity (entity_table, entity_id);

COMMIT;
```

### File: db\migrations\0006_comms_tables.sql

```sql
CREATE TABLE IF NOT EXISTS comms.project_channels (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    stage_id uuid NULL REFERENCES projects.project_stages (id) ON DELETE SET NULL,
    visibility text NOT NULL DEFAULT 'project_all',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_project_channels_project_name UNIQUE (project_id, name)
);

CREATE INDEX IF NOT EXISTS idx_project_channels_project ON comms.project_channels (project_id);

CREATE INDEX IF NOT EXISTS idx_project_channels_stage ON comms.project_channels (stage_id);

CREATE TABLE IF NOT EXISTS comms.project_channel_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL DEFAULT 'participant',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_projchan_participant_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_projchan_participant_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT uq_project_channel_participant UNIQUE (
        channel_id,
        profile_type,
        profile_id
    )
);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_channel ON comms.project_channel_participants (channel_id);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_profile ON comms.project_channel_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS comms.project_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    edited_at timestamptz NULL,
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_project_messages_channel_created ON comms.project_messages (channel_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.dm_threads (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    created_by_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dm_threads_creator ON comms.dm_threads (
    created_by_user_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS comms.dm_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    joined_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_dm_participants_thread_user UNIQUE (thread_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_dm_participants_user ON comms.dm_participants (user_id);

CREATE TABLE IF NOT EXISTS comms.dm_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_dm_messages_thread_created ON comms.dm_messages (thread_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.message_attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    message_table text NOT NULL,
    message_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_message_attachments_table CHECK (
        message_table IN (
            'comms.project_messages',
            'comms.dm_messages'
        )
    ),
    CONSTRAINT uq_message_attachment UNIQUE (
        message_table,
        message_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_message_attachments_message ON comms.message_attachments (message_table, message_id);

CREATE INDEX IF NOT EXISTS idx_message_attachments_attachment ON comms.message_attachments (attachment_id);

CREATE TABLE IF NOT EXISTS comms.channel_files (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_type text NOT NULL,
    channel_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_channel_files_type CHECK (
        channel_type IN ('project', 'dm')
    ),
    CONSTRAINT uq_channel_files_channel_attachment UNIQUE (
        channel_type,
        channel_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_channel_files_channel ON comms.channel_files (channel_type, channel_id);

CREATE INDEX IF NOT EXISTS idx_channel_files_attachment ON comms.channel_files (attachment_id);

CREATE TABLE IF NOT EXISTS comms.notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    type text NOT NULL,
    title text NOT NULL,
    body text NOT NULL,
    entity_table text NULL,
    entity_id uuid NULL,
    read_at timestamptz NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notifications_user_created ON comms.notifications (user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_notifications_user_unread ON comms.notifications (user_id)
WHERE
    read_at IS NULL;

CREATE TABLE IF NOT EXISTS comms.notification_prefs (
    user_id uuid PRIMARY KEY REFERENCES auth.users (id) ON DELETE CASCADE,
    email boolean NOT NULL DEFAULT true,
    push boolean NOT NULL DEFAULT false,
    in_app boolean NOT NULL DEFAULT true,
    digest boolean NOT NULL DEFAULT false,
    quiet_hours tstzrange NULL
);

CREATE TABLE IF NOT EXISTS comms.device_tokens (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    provider text NOT NULL,
    token text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_device_tokens_provider_token UNIQUE (provider, token)
);

CREATE INDEX IF NOT EXISTS idx_device_tokens_user ON comms.device_tokens (user_id);

DO $$
BEGIN
PERFORM 1
FROM pg_publication
WHERE pubname = 'supabase_realtime';

IF NOT FOUND THEN
CREATE PUBLICATION supabase_realtime;
END IF;
END;
$$;


ALTER TABLE comms.project_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.dm_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.notifications REPLICA IDENTITY FULL;

ALTER PUBLICATION supabase_realtime
ADD
TABLE comms.project_messages,
comms.dm_messages,
comms.notifications;
```

### File: db\migrations\0007_finance_tables.sql

```sql
CREATE TABLE IF NOT EXISTS finance.wallets (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    currency text NOT NULL,
    balance_cents bigint NOT NULL DEFAULT 0 CHECK (balance_cents >= 0),
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_wallet_owner_currency UNIQUE (
        owner_type,
        owner_id,
        currency
    )
);

CREATE INDEX IF NOT EXISTS idx_wallets_owner ON finance.wallets (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.transactions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    wallet_id uuid NOT NULL REFERENCES finance.wallets (id) ON DELETE CASCADE,
    direction text NOT NULL CHECK (
        direction IN ('credit', 'debit')
    ),
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    reason text NOT NULL,
    ref_table text NULL,
    ref_id uuid NULL,
    balance_after_cents bigint NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_transactions_wallet_created ON finance.transactions (wallet_id, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.escrows (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE RESTRICT,
    payer_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    payee_type assignment_type NOT NULL,
    payee_id uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'funded',
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_freelancer FOREIGN KEY (payee_id) REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_team FOREIGN KEY (payee_id) REFERENCES org.teams (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

CREATE INDEX IF NOT EXISTS idx_escrows_stage ON finance.escrows (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payer_business ON finance.escrows (payer_business_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payee ON finance.escrows (payee_type, payee_id);

CREATE TABLE IF NOT EXISTS finance.payout_accounts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    provider text NOT NULL,
    account_id text NOT NULL,
    status text NOT NULL DEFAULT 'pending_verification',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_payout_accounts_provider_account UNIQUE (provider, account_id)
);

CREATE INDEX IF NOT EXISTS idx_payout_accounts_owner ON finance.payout_accounts (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.invoices (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    issue_to_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    issue_from_profile uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_invoices_business ON finance.invoices (
    issue_to_business_id,
    created_at DESC
);

CREATE INDEX IF NOT EXISTS idx_invoices_stage ON finance.invoices (project_stage_id);

CREATE TABLE IF NOT EXISTS finance.disputes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    escrow_id uuid NOT NULL REFERENCES finance.escrows (id) ON DELETE CASCADE,
    opened_by_profile uuid NOT NULL,
    reason text NOT NULL,
    status dispute_status NOT NULL DEFAULT 'open',
    resolution_notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_disputes_escrow ON finance.disputes (escrow_id);

CREATE INDEX IF NOT EXISTS idx_disputes_status ON finance.disputes (status, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.dispute_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    dispute_id uuid NOT NULL REFERENCES finance.disputes (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dispute_messages_dispute_created ON finance.dispute_messages (dispute_id, created_at ASC);

CREATE TABLE IF NOT EXISTS finance.ratings (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    rater_profile uuid NOT NULL,
    ratee_type text NOT NULL,
    ratee_id uuid NOT NULL,
    score smallint NOT NULL CHECK (score BETWEEN 1 AND 5),
    comment text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_ratings_ratee ON finance.ratings (ratee_type, ratee_id);

CREATE INDEX IF NOT EXISTS idx_ratings_project ON finance.ratings (project_id);

CREATE TABLE IF NOT EXISTS finance.subscriptions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_id uuid NOT NULL,
    plan text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    started_at timestamptz NOT NULL DEFAULT now(),
    ends_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_subscriptions_profile ON finance.subscriptions (profile_id, status);
```

### File: db\migrations\0020_helpers_functions.sql

```sql
-- db/migrations/0004_helpers_functions.sql

-- NOTE: we rely on pgcrypto/gen_random_uuid(). Make sure extension is on.
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- is_admin(): check ops.admin_users
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$;

-- simple debug helper: return current JWT context
CREATE OR REPLACE FUNCTION security.current_context()
RETURNS jsonb
LANGUAGE sql
STABLE
AS $$
  SELECT jsonb_build_object(
    'user_id', auth.uid(),
    'active_profile_type', auth.jwt()->>'active_profile_type',
    'active_profile_id',   auth.jwt()->>'active_profile_id',
    'active_team_id',      auth.jwt()->>'active_team_id'
  );
$$;

```

### File: db\policies\org\business_profiles.sql

```sql
ALTER TABLE org.business_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_business_profiles_select_owner
ON org.business_profiles
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create business profiles for themselves
CREATE POLICY pol_org_business_profiles_insert_self
ON org.business_profiles
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: owner or admin
CREATE POLICY pol_org_business_profiles_update_owner
ON org.business_profiles
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_business_profiles_delete_owner
ON org.business_profiles
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\freelancer_profiles.sql

```sql
ALTER TABLE org.freelancer_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_freelancer_profiles_select_owner
ON org.freelancer_profiles
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create exactly one freelancer profile tied to themselves
CREATE POLICY pol_org_freelancer_profiles_insert_self
ON org.freelancer_profiles
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner / admin can edit
CREATE POLICY pol_org_freelancer_profiles_update_owner
ON org.freelancer_profiles
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

/* no DELETE */

```

### File: db\policies\org\teams.sql

```sql
ALTER TABLE org.teams ENABLE ROW LEVEL SECURITY;

-- SELECT: show teams you are a member of OR that you own OR admin
CREATE POLICY pol_org_teams_select_member_or_owner
ON org.teams
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships tm
    WHERE tm.team_id = id
      AND tm.user_id = auth.uid()
      AND tm.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: any user can create a team they own
CREATE POLICY pol_org_teams_insert_self
ON org.teams
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner or admin
CREATE POLICY pol_org_teams_update_owner
ON org.teams
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_teams_delete_owner
ON org.teams
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\team_memberships.sql

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;

-- SELECT: any active member of the same team may view
CREATE POLICY pol_org_team_memberships_select_team_member
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin) can add members
CREATE POLICY pol_org_team_memberships_insert_team_owner
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner, team_lead/admin role, or platform admin
CREATE POLICY pol_org_team_memberships_update_team_owner
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK (
  TRUE
);

-- DELETE: same as update (remove member)
CREATE POLICY pol_org_team_memberships_delete_team_owner
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

```

### File: db\policies\org\users_public.sql

```sql
��A L T E R   T A B L E   o r g . u s e r s _ p u b l i c   E N A B L E   R O W   L E V E L   S E C U R I T Y ;  
  
 - -   A n y   l o g g e d - i n   u s e r   c a n   r e a d   p u b l i c   p r o f i l e s  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ s e l e c t _ a l l _ a u t h  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   S E L E C T  
 U S I N G   (   a u t h . u i d ( )   I S   N O T   N U L L   ) ;  
  
 - -   U s e r   c a n   c r e a t e   t h e i r   o w n   p u b l i c   r o w  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ i n s e r t _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   I N S E R T  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 - -   U s e r   c a n   u p d a t e   o n l y   t h e i r   o w n   r o w   ( o r   a d m i n   c a n )  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ u p d a t e _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   U P D A T E  
 U S I N G   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 )  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 / *   n o   D E L E T E   * /  
 
```

### File: db\policies\org\user_emails.sql

```sql
ALTER TABLE org.user_emails ENABLE ROW LEVEL SECURITY;

-- SELECT: you can read only your own email records
CREATE POLICY pol_org_user_emails_select_self
ON org.user_emails
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: you can add an email for yourself
CREATE POLICY pol_org_user_emails_insert_self
ON org.user_emails
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: you can update only your own row
CREATE POLICY pol_org_user_emails_update_self
ON org.user_emails
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: you can delete only your own row
CREATE POLICY pol_org_user_emails_delete_self
ON org.user_emails
FOR DELETE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\security\audit_logs.sql

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

-- allow a user to read only their own audit trail, plus admins
CREATE POLICY pol_security_audit_logs_select_self_or_admin
ON security.audit_logs
FOR SELECT
USING (
  audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- no INSERT/UPDATE/DELETE policies for public
-- audit rows are inserted by service_role from the API layer

```

### File: db\policies\security\refresh_tokens.sql

```sql
ALTER TABLE security.refresh_tokens ENABLE ROW LEVEL SECURITY;

-- DO NOT expose refresh tokens to regular users at all.
-- No SELECT/INSERT/UPDATE/DELETE policies on purpose.

-- Only service_role should ever touch this table, and service_role bypasses RLS.
-- That means from the browser you literally cannot query this table.

```

### File: db\policies\security\session_context.sql

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;

-- SELECT own context
CREATE POLICY pol_security_session_context_select_self
ON security.session_context
FOR SELECT
USING ( user_id = auth.uid() );

-- INSERT own context
CREATE POLICY pol_security_session_context_insert_self
ON security.session_context
FOR INSERT
WITH CHECK ( user_id = auth.uid() );

-- UPDATE own context
CREATE POLICY pol_security_session_context_update_self
ON security.session_context
FOR UPDATE
USING ( user_id = auth.uid() )
WITH CHECK ( user_id = auth.uid() );

-- no DELETE policy for normal users

```

### File: db\policies\security\v_current_context.sql

```sql
ALTER VIEW security.v_current_context SET (security_invoker = true);

-- Views don’t use RLS directly, so we do NOT need policies here.
-- The WHERE clause already ties it to auth.uid().
-- (If Supabase complains about querying this view from the client,
-- you can instead expose a helper RPC function.)

```

### File: db\views\analytics_earnings_by_stage_mv.sql

```sql
��- -   E x a m p l e   m a t e r i a l i z e d   v i e w  
 
```

### File: db\views\security\v_current_context.sql

```sql
CREATE OR REPLACE VIEW security.v_current_context AS
SELECT
  sc.user_id,
  sc.active_profile_type,
  sc.active_profile_id,
  sc.active_team_id,
  sc.updated_at
FROM security.session_context sc
WHERE sc.user_id = auth.uid();

```

### File: deno.json

```json
{
  "nodeModulesDir": "auto",
  "tasks": {
    "format": "deno fmt --check",
    "lint": "deno lint",
    "typecheck": "deno check",
    "names": "deno run -A scripts/validate_names.ts",
    "check": "deno fmt --check && deno lint && deno check && deno run -A scripts/validate_names.ts",
    "test": "deno test --fail-fast --coverage=coverage -A --trace-leaks",
    "dev": "vite --port 3000 --open --host --mode development",
    "build": "vite build --mode production",
    "start": "deno serve -A --watch --port 3000 --env-file=.env.production apps/web/_fresh/server.js",
    "update": "deno run -A -r jsr:@fresh/update .",
    "db:reset": "bash db/scripts/test_db_reset.sh",
    "db:smoke": "supabase db query < db/scripts/test_db_smoke.sql",
    "coverage:lcov": "deno coverage coverage --lcov --output=coverage.lcov",
    "coverage:html": "deno coverage coverage --html",
    "preview": "deno run -A main.ts"
  },
  "fmt": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "_fresh/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx",
        "*.css"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "options": {
      "lineWidth": 100,
      "indentWidth": 2,
      "useTabs": true,
      "singleQuote": true
    }
  },
  "lint": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "rules": { "tags": ["recommended", "fresh"] }
  },
  "compilerOptions": {
    "lib": ["dom", "dom.asynciterable", "dom.iterable", "deno.ns"],
    "jsx": "react-jsx",
    "jsxImportSource": "preact",
    "jsxPrecompileSkipElements": [
      "a",
      "img",
      "source",
      "body",
      "html",
      "head",
      "title",
      "meta",
      "script",
      "link",
      "style",
      "base",
      "noscript",
      "template"
    ],
    "types": ["vite/client"]
  },
  "imports": {
    "@std/assert": "jsr:@std/assert@^1.0.15",
    "@std/testing": "jsr:@std/testing@^1.0.16",
    "@std/dotenv": "jsr:@std/dotenv@^0.225.5",
    "@std/regexp": "jsr:@std/regexp@^1.0.1",
    "@std/http": "jsr:@std/http@^1.0.21",
    "@fresh/plugin-vite": "jsr:@fresh/plugin-vite@^1.0.8",
    "@preact/signals": "npm:@preact/signals@^2.5.0",
    "@tabler/icons-preact": "npm:@tabler/icons-preact@^3.35.0",
    "djwt": "jsr:@zaubrik/djwt@^3.0.2",
    "fresh": "jsr:@fresh/core@^2.2.0",
    "preact": "npm:preact@^10.27.2",
    "supabaseClient": "npm:@supabase/supabase-js@2.76.1",
    "vite": "npm:vite@^7.1.3",
    "@deno/loader": "jsr:@deno/loader@0.3.9",
    "@": "./apps/web/",
    "@styles/": "./apps/web/styles/",
    "@components/": "./apps/web/components/",
    "@contracts/": "./apps/web/contracts/",
    "@features/": "./apps/web/features/",
    "@islands/": "./apps/web/islands/",
    "@server/": "./apps/web/server/",
    "@static/": "./apps/web/static/",
    "@svg/": "./apps/web/svg/",
    "@services/": "./apps/web/services/",
    "packages/": "./packages/",
    "@types/": "./apps/web/types/",
    "@utils": "./apps/web/utils.ts",
    "vite-plugin-svgr": "npm:vite-plugin-svgr@^4.5.0",
    "$fresh/": "https://deno.land/x/fresh@1.7.3/",
    "preact/": "https://esm.sh/preact@10.22.0/",
    "@preact/signals-core": "https://esm.sh/*@preact/signals-core@1.5.1"
  },
  "exclude": ["**/_fresh/*"]
}

```

### File: docs\01_Vision.md

```md
# Platform for Collaborative Freelancing

### Vision

A modern freelancing ecosystem where businesses can hire individuals, multiple freelancers, or entire teams to collaborate on structured projects with predefined costs and deliverables.

### Core Philosophy

- **Collaboration-first**: Freelancers can form teams that function like micro-agencies.
- **Transparency**: Clear pricing per stage, no endless negotiations.
- **Scalability**: Businesses can scale from one freelancer to entire coordinated teams.
- **Fair entry**: Low barrier for new freelancers via transparent stage pricing and templated projects.

### Problem

Traditional freelancing platforms (Upwork, Fiverr) isolate freelancers and force clients into constant negotiation. This slows projects, fragments collaboration, and inflates costs.

### Solution

A project-based collaboration platform that:

- Simplifies hiring through structured **project templates**.
- Allows **freelancers and teams** to work together.
- Supports **fixed-stage budgets** with optional revisions.
- Provides a **shared workspace** with chat, file exchange, and progress tracking.

### Elevator Pitch

> “A collaborative freelancing marketplace where teams deliver complete projects with predictable pricing — the efficiency of Fiverr meets the teamwork of Upwork agencies.”

```

### File: docs\02_Features.md

```md
# Core Features

## For Businesses

- Post projects or use guided templates.
- Hire individuals or full teams.
- Mix freelancers and teams per project stage.
- Track progress, files, and communications in one workspace.
- Approve and pay by stage (Design, MVP, Testing, etc.).
- Set budgets for revisions and maintenance.

## For Freelancers

- Create portfolios with previous work.
- Form or join **freelancer teams**.
- Offer stage-based pricing.
- Apply to project templates.
- Showcase completed work and, later, sell digital assets.

## For Freelancer Teams

- Define roles, pricing, and collaborative tools.
- Manage internal task boards.
- Share revenue and reviews collectively.

---

# Future Enhancements (Phase 4+)

- **Marketplace Layer:** Sell digital assets, templates, or previous work.
- **Smart Matching:** AI-assisted team and project pairing.
- **Escrow & Payments:** Stripe Connect for milestone-based transactions.

```

### File: docs\03_TechStack.md

```md
# Technology Overview

## Frontend

- **Framework:** Deno Fresh + Preact Islands.
- **Runtime:** Deno Deploy (Edge-first).
- **Styling:** Tailwind CSS + Shadcn UI.

## Backend / API

- **Database:** Supabase (PostgreSQL + RLS).
- **Auth:** Supabase Auth (JWT + custom refresh tokens hashed with Argon2id).
- **Realtime:** Supabase Realtime (WebSocket events).
- **Rate Limiting / KV:** Deno KV atomic counters.
- **WASM:** Rust modules compiled to WebAssembly for CPU-heavy work (e.g., image optimization, file processing).
- **Security:**
  - JWT access tokens (short-lived).
  - Hashed refresh tokens (rotated).
  - Strict RLS policies per user/team.
  - CORS & CSP via middleware.
  - Cloudflare Turnstile for bot protection.
  - Signed URLs for all file access.

## Architecture

```text
Frontend (FreshJS Islands)
  |
  ├── Auth + API Gateway (Fresh API routes, Hono optional)
  │     ├── JWT verification
  │     ├── Rate limiting (Deno KV)
  │     ├── Supabase queries (role-based)
  │     └── WASM modules (Rust compute)
  |
  └── Supabase (DB, Auth, Realtime, Storage)
```

## Account Switching Logic

- A single `users` record may own:
  - **One `freelancer_profile`**
  - **Many `business_profiles`**
- The UI includes an **Account Switcher** in the dashboard header.
- When a user switches:
  - Frontend updates the `active_profile_id` in session.
  - Backend JWT claims change (`sub` = user_id, `active_profile` = selected profile).
  - Supabase Row-Level Security filters all queries using `active_profile_id`.
- Context is cached in Deno KV for quick lookups and revocation.

### Example

```text
User (uuid: U1)
├── FreelancerProfile (uuid: F1)
├── BusinessProfile (uuid: B1)
└── BusinessProfile (uuid: B2)

Active session: `{ user_id: U1, active_profile_type: "business", active_profile_id: B2 }`
```

## Team Membership Architecture

- Freelancers can join **multiple teams**.
- Each membership record links a `user_id` to a `team_id` with role-based permissions.
- The UI displays a **Team Selector** (similar to the Account Switcher) showing:
  - Teams owned
  - Teams joined
- Switching between teams updates `active_team_id` in session.
- Supabase RLS filters project data by both `active_profile_id` and `active_team_id`.
- Permissions flow:
  - `freelancer` → can access personal and joined team projects.
  - `team_lead` → can manage members and approve work.
  - `business` → can interact only with teams they hire.

```

### File: docs\04_Roadmap.md

```md
# Phased Roadmap

## Phase 1 — MVP: Core Collaboration

- Auth + roles (client, freelancer, team lead)
- Project creation & management
- Team formation
- Messaging & file sharing
- Stage-based pricing & revision budgets
- Supabase RLS enforcement

## Phase 2 — Payments & Trust

- Stripe Connect (escrow)
- Stage payments & revision releases
- Review & rating system
- Dispute workflow
- Analytics dashboards

## Phase 3 — Guided Hiring

- Project templates (e.g., Web App Build, Marketing Campaign)
- Smart freelancer/team suggestions
- Template-based pricing generator
- Search & recommendation via pgvector

## Phase 4 — Marketplace Expansion

- Freelancer storefronts for templates / assets
- Digital delivery & licensing
- Passive income for freelancers
- Referral & affiliate programs

## Phase 5 — Enterprise Layer

- Multi-team orchestration
- API access for enterprise clients
- Reporting dashboards & audits

```

### File: docs\05_Security.md

```md
# Security Overview

## Authentication & Authorization

- JWT-based access tokens (15m expiry).
- Opaque refresh tokens (rotating, Argon2id-hashed).
- Supabase RLS per project, user, team.
- Project ownership & membership validation at query level.

## API Security

- Rate limiting with Deno KV (60 req/min/user).
- CORS allowlist via env var.
- Content-Security-Policy & Referrer-Policy in middleware.
- CAPTCHA (Turnstile) for anon POST endpoints.
- HTTPS enforced; cookies marked Secure + HttpOnly.

## Data Security

- All Supabase buckets private by default.
- Signed URLs (60s TTL) for file access.
- Encryption at rest (Supabase-managed).
- Sanitized file uploads (MIME + size checks).

## Performance & Scalability

- Edge caching for static routes (Fresh Islands).
- Lazy hydration (Preact islands).
- Deno Deploy’s auto-scaling edge functions.
- Supabase horizontally scalable with PG bloat control.
- Optional Rust WASM compute for heavy workloads.

```

### File: docs\06_InvestorSummary.md

```md
# Executive Summary

### Elevator Pitch

A collaborative freelancing marketplace that lets businesses hire entire teams to deliver projects end-to-end — predictable costs, faster delivery, and fairer work for freelancers.

### Why Now

The freelancing economy is fragmented and inefficient. Businesses waste time managing multiple freelancers separately, while freelancers struggle to collaborate and scale.

### Market

- Global freelancing market: $1.5T (Upwork 2023 report)
- Increasing shift toward distributed, project-based work.
- Opportunity: become the go-to “agency builder” for freelance teams.

### Competitive Advantage

- Collaboration-first architecture (teams > individuals)
- Fixed stage pricing (no endless bidding)
- Built-in transparency for clients
- Future-ready (marketplace + AI-guided hiring)

### Monetization (Phase 2+)

- 10% service fee per project stage
- Subscription tiers for freelancers/teams
- Marketplace commissions (digital assets)
- Team analytics & premium project templates

### Status

- MVP under development using Deno Fresh, Supabase, and Rust WASM.
- Fully open-source stack; minimal operational cost.
- Designed for scalability and transparency.

```

### File: docs\07_UserStories.md

```md
# User Stories – Collaborative Freelancing Platform

## Overview

The platform enables **businesses**, **freelancers**, and **freelancer teams** to collaborate on structured projects with clear budgets and milestones.  
It combines the simplicity of Fiverr, the project depth of Upwork, and the collaboration of small consultancies.

---

## 👤 User Roles

1. **Business Client** – posts projects, hires freelancers or teams, approves work, and manages budgets.
2. **Freelancer** – offers services, applies for projects, and can join multiple teams.
3. **Freelancer Team** – a group of freelancers acting as a mini-agency with shared portfolios and collective pricing.
4. **Multi-Account User (Hybrid)** – a single registered person who can:
   - Own **one freelancer profile** (personal or part of a team).
   - Own and manage **multiple business profiles** (companies, brands, or projects).
   - **Switch accounts** from a single login session without re-authenticating.

---

## 🧱 Core Platform Features

- Discover and filter **individual freelancers**.
- View detailed **freelancer portfolios** and past projects.
- **Create and manage teams** (by freelancers themselves).
- **Hire individuals or full teams** for project stages.
- **Post projects** or choose from **guided project templates**.
- **Set and manage budgets** per project stage or revision type.
- Built-in **messaging and file sharing** for collaboration.
- **Freelancers can sell previous work** (digital templates, products).

---

## 🏗️ Epic 1 – Discovery & Profiles

### As a Business Client:

- I want to **browse and filter freelancers** by skills, experience, rating, and location.
- I want to **view freelancer portfolios** to see examples of past work before hiring.
- I want to **search for teams** that specialize in certain project types.

### As a Freelancer:

- I want to **create a public portfolio** to showcase my best work.
- I want to **list my services and stage-based pricing** clearly.
- I want to **tag my profile with specializations** (e.g., “UI Design”, “MVP Implementation”).

### As a Freelancer Team:

- I want to **build a shared team profile** that highlights collective experience.
- I want to **add or remove members** dynamically as projects evolve.
- I want to **share reviews and ratings** collectively as a team brand.

---

## 🧩 Epic 2 – Project Creation & Hiring

### As a Business Client:

- I want to **post new projects** with clear descriptions, budgets, and deadlines.
- I want to **use project templates** that automatically define common stages (e.g., “Design”, “Testing”).
- I want to **mix and match freelancers or teams per stage** of a project.
- I want to **view cost breakdowns** for each stage before committing.
- I want to **hire multiple freelancers** for larger jobs.
- I want to **hire full teams** for complex, multi-stage projects.

### As a Freelancer or Team:

- I want to **apply to posted projects** that match my skills.
- I want to **see which stages of a project are open for bids or collaboration.**
- I want to **set budgets per stage**, including optional revision costs.
- I want to **propose stage pricing** dynamically (e.g., higher for “Major Revisions”, lower for “Tweaks”).

---

## 💰 Epic 3 – Budgets & Stage Pricing

### As a Business Client:

- I want to **view total project cost** broken down by stage.
- I want to **approve or modify budgets** before finalizing a contract.
- I want to **see optional revision costs** (“Minor Tweaks”, “Major Revisions”).

### As a Freelancer or Team:

- I want to **set fixed budgets per stage** (e.g., Design £40, Implementation £260).
- I want to **offer certain stages for free** to attract clients (e.g., “Consultation – Free”).
- I want to **charge monthly maintenance fees** for ongoing work.

### Example – Team Pricing:

| Stage                        | Description            | Budget     |
| ---------------------------- | ---------------------- | ---------- |
| Market Research & Consulting | Discovery phase        | Free       |
| Design                       | UI/UX layout           | £40        |
| MVP Implementation           | Prototype build        | £260       |
| Full Implementation          | Production-ready build | £430       |
| Testing                      | QA, bug fixes          | £70        |
| Minor Tweaks                 | Post-launch fixes      | £10        |
| Major Revisions              | Reworks                | Up to £300 |
| Maintenance                  | Monthly retainer       | £50/month  |
| Marketing                    | Launch campaigns       | Up to £500 |

---

## 🧑‍💻 Epic 3A – Team Membership

### As a Freelancer:

- I want to **join multiple teams** so I can collaborate on different projects simultaneously.
- I want to **see which teams I belong to** and easily switch between them in my dashboard.
- I want to **set my visibility** (public or invite-only membership).
- I want to **choose whether a project invitation goes to me personally or via one of my teams**.
- I want to **leave a team at any time**, unless I have an active project stage assigned to me.

### As a Team Lead:

- I want to **invite existing freelancers** to join my team.
- I want to **see all members across multiple active projects**.
- I want to **assign roles** (e.g., Developer, Designer, Tester) within the team.
- I want to **review and rate freelancers** after project completion.

### As a Business Client:

- I want to **see the full composition of any team** I hire (roles, members, reputation).
- I want to **know if a freelancer I hire is already part of another team** for transparency.

---

## 🧠 Epic 4 – Guided Project Templates

### As a Business Client:

- I want to **select a project template** (e.g., “Build a SaaS MVP”, “Design a Landing Page”).
- I want the platform to **recommend suitable freelancers or teams** for each stage.
- I want to **customize the template** by replacing or removing stages.
- I want to **preview total cost and timeline** before confirming.

### As a Freelancer:

- I want to **attach my services to specific template stages**.
- I want to **see when businesses select my stage** in a template.
- I want to **get notified when a template project matches my profile.**

---

## 🤝 Epic 5 – Collaboration & Communication

### As a Business Client:

- I want to **chat with freelancers and teams** directly inside project rooms.
- I want to **upload reference files and documentation**.
- I want to **receive milestone updates** as stages are completed.

### As a Freelancer/Team:

- I want to **collaborate with others on the same project** (shared workspace).
- I want to **track progress** with task boards or checklists.
- I want to **share deliverables securely** through Supabase Storage.

---

## 💼 Epic 6 – Review, Payments & Revisions (Phase 2+)

### As a Business Client:

- I want to **approve deliverables per stage** before payment is released.
- I want to **request revisions** if I’m not satisfied.
- I want to **rate freelancers and teams** after project completion.

### As a Freelancer:

- I want to **receive payments securely** (via Stripe Connect).
- I want to **track my earnings and withdrawal history.**
- I want to **see client feedback** for continuous improvement.

---

## 🛍️ Epic 7 – Marketplace for Previous Work (Future Expansion)

### As a Freelancer:

- I want to **sell past designs, templates, or products** directly on my profile.
- I want to **define licenses or exclusivity** (e.g., “Full Rights”, “Template Use Only”).
- I want to **track downloads and sales analytics**.

### As a Business Client:

- I want to **browse and buy ready-made assets** (website templates, designs, code).
- I want to **preview and customize digital assets** before purchase.

**Examples:**

- A designer sells a T-shirt design and optionally prints the product.
- A developer sells an unused website domain or UI template.

---

## 🔐 Epic 8 – Account & Security

### As Any User:

- I want to **log in securely** using Supabase Auth (email/password or OAuth).
- I want to **receive session tokens that expire safely** (JWT + hashed refresh).
- I want to **recover my account** if I forget credentials.
- I want to **verify my identity** before taking payments or forming teams.

---

## 📊 Epic 9 – Analytics & Insights (Later Phase)

- Businesses can view **budget breakdowns** and project performance.
- Freelancers can view **earnings analytics** and stage efficiency.
- Teams can track **member contributions** and client satisfaction.

---

## 🔮 Epic 10 – Long-Term Vision

- **AI-assisted team recommendations** (“Best team for your budget”).
- **Automated milestone forecasting** (timeline prediction based on prior data).
- **Cross-platform integrations** (Notion, Slack, GitHub).
- **API access** for enterprise clients.

---

## 🔄 Epic 11 – Multi-Account Switching

### As a User:

- I want to **associate multiple business accounts** under my profile.
- I want to **switch between my business accounts and my freelancer profile** from a single dashboard.
- I want to **see which account is currently active** when viewing projects or payments.
- I want to **maintain separate wallets and analytics** for each business account.
- I want to **use the same email/login credentials** for all associated accounts.

### As a Business Owner:

- I want to **delegate access** to collaborators (e.g., team members or assistants).
- I want to **assign roles** (Owner, Manager, Viewer) per business account.

### As a Freelancer:

- I want to **operate my freelancer account independently** of any business accounts.
- I want my freelancer identity (ratings, portfolio) to remain consistent even if I switch to a business context.

---

## 🔐 Account & Security (Updated)

- Each **user ID** can own one `freelancer_profile` and multiple `business_profiles`.
- Switching context updates `active_profile_id` in session JWT.
- **RLS policies** ensure all database operations are filtered by the currently active account.
- All **API endpoints** respect `active_profile_type` (`freelancer` or `business`) for access control.
- **Audit logs** record all account switches for transparency.

```

### File: docs\08_UserFlows.md

```md
# Projective User Flows  
Version: Draft MVP Architecture  
Date: 25 Oct 2025  
Author: GPT-5 (Projective System Docs)

---

## Actors (Who’s doing what)

### Business / Creator
- A person or company that wants work done.
- They can own multiple business profiles.
- They create projects, approve work, fund payments, open disputes.

### Freelancer
- An individual who offers services.
- Can act solo, join multiple teams, and sell work.
- Can take on different types of work modes (Create, Run, Educate, etc.).

### Team
- A group of freelancers acting like a micro-agency.
- Can be hired as a unit for certain stages or entire projects.

### Platform / System
- Handles auth, RLS isolation, escrow, dispute moderation, file access, audit trail, IP policy references, etc.

### Moderator (Internal / Admin)
- Only steps in for escalated disputes, fraud, abuse, safety, or IP claims.

---

## 1. Onboarding → First Project Flow (End-to-end narrative)

High level:
1. User signs up.
2. User chooses what they are.
3. User sets up profile + payout/billing.
4. User either posts a project (as a creator/business) or looks for work (as a freelancer).
5. The first project is created and staffed.
6. Work is delivered, paid, reviewed, possibly disputed.

We'll break that into phases.

---

### 1.1 Account Creation & Role Setup

``` text
Start
↓
Signup/Login (Supabase Auth)
- email/password OR OAuth
- Turnstile check for bots
↓
Verify Email (token link)
↓
Choose Path:
  [ I'm here to HIRE / I need work done ] → becomes Creator
  [ I'm here to WORK / Offer services ] → becomes Freelancer
↓
System creates:
- `auth.users` row
- `security.session_context` row
- If Freelancer path: create `org.freelancer_profiles`
- If Creator path: create `org.business_profiles`
↓
Dashboard boot
```

Details:
- A single human user can actually become both later. This is done through the account switcher (they can own one freelancer profile and many business profiles).
- We store in `session_context` which profile is “active,” and that value is embedded in the JWT for RLS.

Security notes:
- Refresh tokens are hashed and rotated.
- Every request to the API uses the active profile for access filtering via RLS.

---

### 1.2 Profile Completion

For Freelancers:
- Add headline, skills, pricing style, availability.
- Attach portfolio samples (uploads go → `attachments` bucket → scanned in `quarantine` first).
- Optionally join or create a Team.

For Creators (business):
- Add business name, billing email, location.
- Add payment method for funding stages later (Stripe on file).
- (Later phase) Verify identity for high-value spend / anti-fraud.

For Teams:
- A freelancer can create a team, invite others, and define roles (designer, dev, QA, PM).
- Team shows up as a hireable “unit” for a stage.

---

### 1.3 Payment Setup (Creator side)

Why early?
- You can’t actually start a paid stage without funding escrow.

Flow:
- Creator adds payment details (card / business payment method).
- The platform prepares “wallets” and enables escrows.
- No money moves yet, but escrow will be pulled before work starts.

``` text
Creator Dashboard
↓
Settings / Wallet
↓
Add Payment Method
↓
Stripe Connect / billing link
↓
Ready to fund escrows
```

(Teams / freelancers later add payout accounts so they can receive funds after stage approval.)

---

## 2. Project Lifecycle Overview

Now we zoom into how a project is created, staffed, executed, delivered, paid, and possibly disputed.

We cover:
- Full project (multi-stage)
- Single-stage projects
- Stage types and how they behave
- Tabs within a stage
- Escrow and approvals
- Revisions and disputes
- IP handling

---

### 2.1 Creating a Project (Creator perspective)

There are two paths:
A. Custom project (“Describe what you need”)  
B. Template (“Landing Page Build”, “SEO Campaign”, “Pitch Deck Coaching”, “App MVP”)

``` text
Creator Dashboard
↓
"New Project"
↓
Option A: Custom Project
  - Title, description, goals, timeline, budget comfort
  - Add first stage(s) manually
Option B: Use Template
  - Pick template category
  - System auto-loads suggested stages (Design, Build MVP, Test, etc.)
  - Each stage has a recommended Stage Type and suggested cost ranges
↓
Project Draft Created in DB:
- projects.projects (status = draft)
- projects.project_stages[] (status = open)
↓
Creator Reviews Stage List
  - Can remove stages
  - Can reorder them
  - Can change who they want to hire per stage:
    - Single freelancer
    - Multiple freelancers across stages
    - Whole team for multiple stages
↓
Save
```

During this step:
- No one is hired yet.
- Budget rules can be defined per stage:
  - fixed price
  - cap / hourly cap
  - free (like discovery/consult)

This maps to `projects.stage_budget_rules`.

---

### 2.2 Stage Types (How work is structured)

Stages are atomic units of work that can be assigned to either:
- A single freelancer
- A team
- (Eventually) multiple freelancers in parallel, but MVP tends toward 1 assignee per stage

Each stage has a “Stage Type,” which drives UI, approval rules, completion signals, and payment triggers.

#### 2.2.1 File Based
Typical freelancer types:
- Create (design, code, copywriting)
- Run / Execute (do the task and provide output)
- Test / Tweak (QA report, improved version)
What delivery looks like:
- Deliverable is a file, zip, doc, or link.
- Stage is marked “submitted” when files are uploaded as a Submission.
Tabs:
- Chat
- Attachments
- Details
- Submissions (required for File Based)

#### 2.2.2 Session Based
Typical freelancer types:
- Educate
- Advise
What delivery looks like:
- A booked call / session between creator and freelancer.
- Completion is logged after the session happens.
Tabs:
- Chat
- Attachments
- Details
- Calendar (session scheduling tab)

#### 2.2.3 Group Session Based
Typical freelancer types:
- Educate (group coaching / training class)
What delivery looks like:
- A live session with multiple attendees (e.g. 1 freelancer coach + 10 attendees from the creator’s team or audience).
- Completion is attendance + confirmation by the creator.
Tabs:
- Chat
- Attachments
- Details
- Calendar
- Attendees (list of registered participants, attendance log)

#### 2.2.4 Management Based
Typical freelancer types:
- Empower / Manage
(Example: project manager / producer / coordinator role.)
What delivery looks like:
- Ongoing coordination, reporting, decisions, directing other contributors.
- Completion may be time-bound (e.g. “2 weeks of PM coverage”).
Tabs:
- Chat
- Attachments
- Details
No special Submission tab because the “output” is the process itself, not one packaged file.

#### 2.2.5 Maintenance Based
Typical freelancer types:
- Execute
- Test / Tweak
(Example: “Keep the landing page updated weekly,” “Monthly bug fixes,” “Social calendar maintenance”.)
What delivery looks like:
- Ongoing recurring work for a period or retainer.
- Completion is either:
  - a recurring billing cycle (weekly/monthly), OR
  - explicit “maintenance complete” for this window.
Tabs:
- Chat
- Attachments
- Details
- Submissions (can be used to log periodic drops/updates)

---

### 2.3 Mapping Freelancer Types ↔ Stage Types

- Create → File Based  
  (Designer delivers Figma file, Developer delivers repo, Writer delivers copy doc.)
- Run / Execute → File Based or Maintenance Based  
  (VA uploads spreadsheets, marketing operator posts campaign reports weekly.)
- Educate → Session Based  
  (1:1 coaching call.)
- Educate (Group) → Group Session Based  
  (Training workshop for 20 employees.)
- Advise → Session Based  
  (Consulting, strategy call, technical guidance call.)
- Test / Tweak → File Based or Maintenance Based  
  (QA report, code review, performance audit, copy edit pass.)
- Empower / Manage → Management Based  
  (Project manager keeps everyone moving, communicates status, tracks blockers.)

This matters because:
- Different stage types imply different “what counts as done”.
- Different stage types change which tabs are shown in the UI.
- Different stage types can affect how escrow pays out.

---

### 2.4 Staffing a Stage (Hiring flow)

A stage can be filled in two main ways:

1. Creator browses and directly invites a freelancer or team.
2. Freelancers/teams apply to open stages of public or semi-public projects.

Hiring flow:
1. Creator selects a stage like “UI Design (File Based)”.
2. Creator views suggested freelancers / teams with matching skills.
3. Creator invites one (or more) to take that stage.
4. Invitee accepts.

When accepted:
- `projects.stage_assignments` is populated with who’s responsible.
- Stage status moves from `open` → `assigned` → `in_progress`.

If a team is hired, the team lead can internally assign sub-work. The platform does not need to micromanage internal distribution at MVP; we only track which team is accountable to deliver.

---

### 2.5 Funding & Escrow (Before work starts)

Before work officially starts, the Creator must fund that stage.

``` text
Stage "Design Landing Page" (File Based)
status: open
↓
Creator selects freelancer or team
↓
Platform calculates cost from stage_budget_rules
↓
Creator clicks "Fund Stage"
↓
Escrow created in finance.escrows
- status = funded
- amount_cents = agreed fee
↓
Stage moves to in_progress
Freelancer/team starts work
```

This prevents “do work first, maybe get paid later.”  
Funds sit in escrow, not yet released to the freelancer/team.

---

### 2.6 Collaboration During the Stage

Every stage has a “Stage Room” (like a mini workspace). Tabs:

- Chat  
  Real-time thread between the creator and the assigned freelancer/team (plus PM, plus anyone else allowed on that stage).
- Attachments  
  Shared files (stored in `attachments` bucket, mapped through `comms.message_attachments`, etc.).
- Details  
  Scope, acceptance criteria, deadlines, budget, revision terms.
- Submissions  
  (File Based / Maintenance Based only) Formal handover of deliverables. This is how payment approval is triggered.
- Calendar  
  (Session Based / Group Session Based only) Schedule, upcoming calls.
- Attendees  
  (Group Session Based only) Who’s attending the session(s), attendance history.

For Management Based stages:
- The PM / coordinator is expected to keep Chat, Details, and Attachments updated.  
- There is often no “final file,” just reporting and management outcomes.

---

### 2.7 Submission, Review, and Approval

For File Based and Maintenance Based stages:
1. Freelancer/team uploads final deliverable(s) to Submissions.
2. Stage status moves to `submitted`.
3. Creator reviews.

The creator now has 3 options:
- Approve  
- Request Revision  
- Dispute

#### Approve
- Stage status: `approved`.
- Escrow is released.
- Freelancer/team wallet is credited (transactions + payouts).

#### Request Revision
- Stage status: `revisions`.
- A `stage_revision_request` record is created:
  - type: minor | major
  - reason / requested changes
- The freelancer/team updates the work and resubmits.
- This can repeat, but eventually should converge to approval or dispute.

#### Dispute
- If the creator claims “this is not what we agreed,” “low quality,” “fraud,” etc., they can open a dispute tied to that stage’s escrow.
- finance.disputes is created:
  - opened_by_profile
  - reason
  - status = open
- Both parties can post statements / evidence into `finance.dispute_messages`.
- A moderator can escalate, rule, refund, partially release, etc.
- Stage is blocked from payout until dispute is resolved.

---

### 2.8 Session Based & Group Session Based completion

For these stage types, “submission” is not a file. It’s “did the session happen?”

- After the scheduled call/session:
  - Freelancer/team marks session delivered.
  - Creator confirms attendance and value received.
  - Creator can Approve, Request Revision (rare: e.g. “this session never happened / you didn’t show”), or Dispute.

For Group Session Based:
- Creator can confirm attendee list vs. what was promised.
- Freelancers/coaches get paid upon approval.

---

### 2.9 Management Based completion

Management Based stages (Empower / Manage type) are usually:
- “2 weeks project management”
- “Campaign coordination for October”
- “Launch oversight until go-live date”

They close when:
- The agreed period ends
- The creator is satisfied that the PM/manager fulfilled the agreed responsibilities

Approval then triggers escrow release.

If the creator claims “you didn’t actually manage anything,” that can become a dispute.

---

### 2.10 Maintenance Based & Retainers

Maintenance Based stages can act like mini-retainers or recurring upkeep:
- “Ongoing bug fixes for 30 days”
- “Weekly content uploads”
- “Monthly social media upkeep”

Two patterns:
- As one stage within a larger project (single billing window)
- As recurring contract (post-launch maintenance, long-term relationship)

In the recurring case, this evolves into something like a `maintenance_contract`:
- amount per period
- renewal cadence (weekly/monthly)
- who’s responsible

Payment is sliced per billing window and approved like any other stage window. This can be auto-approved if no dispute is filed by cutoff.

---

## 3. Single-Stage Projects

Not every job needs a complex multi-stage project.

Example use cases:
- “Write me a blog post”
- “Run an audit call for my landing page”
- “Coach my team for 1 hour”
- “Fix this bug”
- “Manage my launch this weekend”

Flow is simpler:

``` text
Creator → New Project
↓
Add one Stage only
  e.g. "SEO audit call" (Session Based)
  or "Fix Stripe webhook bug" (File Based)
↓
Invite freelancer OR pick from suggestions
↓
Fund escrow
↓
Work happens
↓
Submission or Session Complete
↓
Approve → Release escrow
(Or Revision / Dispute)
↓
Project marked completed
```

In DB terms:
- projects.projects has one row
- projects.project_stages has exactly one row
- After approval and payout, project.status becomes `completed`

This is crucial for early adoption: very low friction, same trust mechanics.

---

## 4. Disputes and IP Ownership

### 4.1 Disputes

A dispute can be opened when:
- Work not delivered
- Work delivered but not matching scope
- Work quality is unacceptable
- Freelancer says creator is abusing revision requests
- Session did not occur as claimed
- Breach of terms / harassment / non-payment
- IP misuse

What happens when a dispute opens:
1. finance.disputes row is created (status = open).
2. Linked to escrow for that stage (so funds are locked).
3. Both parties can submit evidence/messages (finance.dispute_messages).
4. Moderator is notified.

Outcomes:
- Release full escrow to freelancer/team.
- Refund full escrow to creator.
- Split escrow (partial payout).
- Mark as resolved with notes.
- In extreme cases: suspend accounts, flag IP, restrict withdrawals.

The RLS model ensures only involved parties plus moderators can see the dispute data.

### 4.2 IP & Licensing

We need IP clarity because:
- You explicitly said you want freelancers and creators to both be able to reuse work unless they choose otherwise.
- You also said you'd like the platform to carry liability.

So at stage creation / agreement, we capture an “IP mode” for that stage:
- Exclusive Transfer — Creator fully owns the deliverable.
- Licensed Use — Creator can use it commercially, but freelancer retains rights to resell.
- Internal/Non-Commercial — Coaching / strategy / internal insights that aren’t to be resold.
- Public / Template — Work that was already a template or asset and can be resold (think marketplace item).

This IP mode should live in stage details (either within `projects.project_stages` or a related `stage_contract_terms` table in the future).

Why:
- In a dispute that claims “you’re reselling my brand assets,” the moderator checks that selected IP mode.
- Reviews/ratings can mention “Delivered exclusive rights as promised,” which protects both sides.

During dispute resolution over IP:
- Moderator can instruct takedown / forbid resale / require removal from marketplace.
- Moderator’s decision goes into `finance.disputes.resolution_notes`.

---

## 5. End State of a Project

Project is considered done when:
- All stages are approved and paid out, OR
- All remaining stages are cancelled/removed, and whatever is left is not owed.

End-of-project flow:

``` text
All stages either:
  - approved + paid
  - cancelled
  - resolved via dispute
↓
Creator leaves ratings for freelancers / teams
↓
Freelancers / teams rate the creator (mutual rating system)
↓
Project is archived as completed
↓
Its assets (final deliverables, transcripts, etc.) stay accessible in project files
↓
Wallets updated, payouts queued
```

After completion:
- Ratings affect discoverability.
- Assets can optionally be turned into marketplace items (future phase):  
  e.g. “the landing page template we built for you could be sold as a generic template,” depending on IP mode.

---

## 6. Flow Library (Quick Reference)

Below are the core flows in short form.

### 6.1 User Onboarding Flow (Freelancer or Creator)

``` text
Sign Up / Login
↓
Email Verify
↓
Pick Role (Hire vs Work)
↓
System creates profile(s)
↓
Payment setup:
  - Creator: add funding method
  - Freelancer/Team: add payout info
↓
Land in dashboard with proper context
```

---

### 6.2 Project Creation Flow (Creator)

``` text
Dashboard → New Project
↓
Pick Template OR Custom
↓
Auto-generate stages (with Stage Type + suggested pricing)
↓
Tweak stages / scope / IP mode / budget rules
↓
Save Draft
```

---

### 6.3 Staffing & Funding Flow

``` text
For each Stage:
  Invite freelancer OR team
  ↓
  Assignee accepts
  ↓
  Creator funds escrow
  ↓
  Stage moves to in_progress
  ↓
  Collaboration begins in Stage Room
```

---

### 6.4 Delivery & Approval Flow

For File Based / Maintenance Based:
``` text
Freelancer submits deliverable
↓
Creator reviews
↓
Approve → escrow releases → payout
OR
Request Revision → stage_revision_request logged
OR
Open Dispute → funds locked, moderator notified
```

For Session Based / Group Session Based:
``` text
Session happens
↓
Creator confirms attendance/value
↓
Approve → escrow releases → payout
OR
Mark "didn't happen" → dispute
```

For Management Based:
``` text
Time window ends
↓
Creator marks satisfied or not
↓
Approve → payout
OR
Dispute quality of management
```

---

### 6.5 Dispute Flow

``` text
Creator OR Freelancer opens Dispute on a Stage
↓
finance.disputes row created
↓
Dispute Messages open (evidence, conversation)
↓
Moderator review
↓
Moderator resolves:
- release funds
- partial split
- refund
- restrict IP reuse if applicable
↓
Stage + Project updated accordingly
↓
Ratings still can proceed
```

---

### 6.6 Project Completion Flow

``` text
All stages finalized (approved/cancelled/resolved)
↓
Project marked completed
↓
Both sides rate each other
↓
Final assets remain accessible
↓
Wallets / payouts finalized
↓
Project archived
```

---

## 7. Why this matters for build order

From an engineering standpoint:
1. You cannot build “projects” in isolation — you need:
   - Onboarding (session_context in JWT)
   - Stage types (so UI knows which tabs to render)
   - Escrow (for trust)
2. You cannot build payouts without:
   - Submission → Approval → Release trigger
   - Dispute path
3. You cannot build retention / long-tail revenue without:
   - Maintenance Based stages / maintenance contracts
4. You cannot scale trust without:
   - Ratings
   - IP mode logging
   - Audit trails
   - Dispute messaging

All of that informs tables like:
- `projects.stage_revision_requests`
- `finance.disputes` + `finance.dispute_messages`
- `projects.maintenance_contracts`
- `finance.wallets`, `finance.escrows`, `finance.transactions`
- `finance.ratings`

And all of that ties back to access control via RLS using `active_profile_id` and `active_team_id`.

---

## 8. TL;DR Core Flows You Now Have Spec’d

- Onboarding (account creation → active profile)
- Payment setup (funding & payout)
- Project creation (custom or template)
- Stage typing (File, Session, Group Session, Management, Maintenance)
- Hiring & escrow funding
- Workroom collaboration per stage (Chat / Attachments / Details / etc.)
- Submission / approval / revision loop
- Disputes, including IP edge cases
- Ratings and closeout
- Single-stage “micro-projects”
- Long-running “maintenance / retainer” stages

This document should live in `docs/product/user-flows.md` in the repo, next to `UserStories.md` and `Sitemap.md`.

```

### File: docs\09_Tables.md

```md
# Projective Database Schema (Relational Model)

Format: Table-per-entity with columns, types, PK/FK notes\
Date: 25 Oct 2025 (revised for client profiles & future organisations)\
Status: UPDATED (includes maintenance contracts, revision requests, dispute messages, subscriptions,
portfolios, organisation scaffolding, column refinements)

---

## ENUMS

### `profile_type`

| Value        | Description                          |
| ------------ | ------------------------------------ |
| `freelancer` | A freelancer profile context         |
| `business`   | A business / creator profile context |

> Used where a row is “owned” by a freelancer or business profile.\
> **Note:** Future `organisation` entities are modelled separately and use explicit FKs instead of
> this enum.

### `assignment_type`

| Value        | Description                               |
| ------------ | ----------------------------------------- |
| `freelancer` | Stage is assigned to a freelancer profile |
| `team`       | Stage is assigned to a team               |

### `visibility`

| Value         | Description                                 |
| ------------- | ------------------------------------------- |
| `public`      | Visible in search / market                  |
| `invite_only` | Only visible to invited collaborators/teams |

### `project_status`

| Value       | Description                        |
| ----------- | ---------------------------------- |
| `draft`     | Project created but not yet active |
| `active`    | In progress                        |
| `on_hold`   | Paused                             |
| `completed` | Finished and archived              |
| `cancelled` | Killed before completion           |

### `stage_status`

| Value         | Description                                             |
| ------------- | ------------------------------------------------------- |
| `open`        | Stage exists but not yet staffed                        |
| `assigned`    | Someone has been assigned but hasn't accepted / started |
| `in_progress` | Actively being worked on                                |
| `submitted`   | Work / session delivered for approval                   |
| `approved`    | Buyer/creator approved deliverable                      |
| `revisions`   | Creator requested changes / corrections                 |
| `paid`        | Escrow released / payout processed                      |

### `dispute_status`

| Value          | Description                       |
| -------------- | --------------------------------- |
| `open`         | Dispute filed                     |
| `under_review` | Moderator actively mediating      |
| `resolved`     | Outcome decided                   |
| `refunded`     | Payout refunded (full or partial) |

---

## 1. Supabase built-ins (`auth`, `storage`)

### Table: `auth.users`

| Column     | Type        | Notes                      |
| ---------- | ----------- | -------------------------- |
| id         | uuid        | PK                         |
| email      | text        | Unique per user (Supabase) |
| phone      | text        |                            |
| created_at | timestamptz |                            |
| updated_at | timestamptz |                            |

### Table: `auth.identities`

| Column        | Type        | Notes                                  |
| ------------- | ----------- | -------------------------------------- |
| id            | uuid        | PK                                     |
| user_id       | uuid        | FK → `auth.users.id`                   |
| provider      | text        | e.g. `email`, `github`, `google`, etc. |
| identity_data | jsonb       | Provider payload                       |
| created_at    | timestamptz |                                        |

### Table: `storage.buckets`

| Column     | Type        | Notes |
| ---------- | ----------- | ----- |
| id         | text        | PK    |
| name       | text        |       |
| created_at | timestamptz |       |

### Table: `storage.objects`

| Column     | Type        | Notes                                           |
| ---------- | ----------- | ----------------------------------------------- |
| id         | uuid        | PK                                              |
| bucket_id  | text        | FK → `storage.buckets.id`                       |
| name       | text        | Full path inside bucket (unique per bucket)     |
| owner      | uuid        | Owner user_id or profile id depending on policy |
| metadata   | jsonb       | sha256, mime_type, etc.                         |
| created_at | timestamptz |                                                 |
| updated_at | timestamptz |                                                 |

---

## 2. Security Schema (`security`)

### Table: `security.session_context`

| Column              | Type         | Notes                                                       |
| ------------------- | ------------ | ----------------------------------------------------------- |
| user_id             | uuid         | PK, FK → `auth.users.id`                                    |
| active_profile_type | profile_type | `freelancer` or `business`                                  |
| active_profile_id   | uuid         | The currently active freelancer_profile or business_profile |
| active_team_id      | uuid         | Active team context (if acting "as team")                   |
| updated_at          | timestamptz  | Last context switch                                         |

### Table: `security.audit_logs`

| Column           | Type        | Notes                                                                         |
| ---------------- | ----------- | ----------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                            |
| user_id          | uuid        | FK → `auth.users.id`                                                          |
| action           | text        | e.g. `stage.approved`, `profile.updated`, `dispute.opened`                    |
| entity_table     | text        | Logical target table name (`projects.project_stages`, etc.)                   |
| entity_id        | uuid        | Entity row id                                                                 |
| metadata         | jsonb       | Arbitrary contextual data                                                     |
| ip               | inet        | Calling IP                                                                    |
| created_at       | timestamptz | Timestamp                                                                     |
| request_id       | uuid        | (NEW) Correlates platform logs / trace id                                     |
| actor_profile_id | uuid        | (NEW) Active profile the user was acting as at the time (mirrors RLS context) |
| actor_team_id    | uuid        | (NEW) Active team context (if any)                                            |
| user_agent       | text        | (NEW) Captured UA / client info for abuse/fraud audit                         |

### Table: `security.turnstile_verifications`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| user_id      | uuid        | FK-ish (nullable before auth) |
| ip           | inet        | IP of request                 |
| token_prefix | text        | Partial token for reference   |
| success      | boolean     | CAPTCHA success               |
| created_at   | timestamptz | Timestamp                     |

### Table: `security.feature_flags`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| key        | text        | PK (flag key)            |
| enabled    | boolean     | Feature on/off           |
| payload    | jsonb       | Extra config for rollout |
| updated_at | timestamptz |                          |

---

## 3. Org Schema (`org`)

Users, freelancer profiles, client business profiles, teams, skills, attachments, emails,
portfolios, and (future) multi-user organisations.

### Table: `org.users_public`

| Column       | Type        | Notes                    |
| ------------ | ----------- | ------------------------ |
| user_id      | uuid        | PK, FK → `auth.users.id` |
| display_name | text        | Public-facing name       |
| avatar_url   | text        | Signed URL / storage ref |
| country      | text        | Optional                 |
| created_at   | timestamptz |                          |

> Public but still served under RLS; safe to show to any authenticated user.

---

### Table: `org.freelancer_profiles`

| Column      | Type        | Notes                                                              |
| ----------- | ----------- | ------------------------------------------------------------------ |
| id          | uuid        | PK                                                                 |
| user_id     | uuid        | FK → `auth.users.id`, UNIQUE (1 freelancer profile per human user) |
| headline    | text        | Short pitch (e.g. “Logo Designer                                   |
| bio         | text        | Profile description                                                |
| hourly_rate | integer     | Optional, rough signalling                                         |
| visibility  | visibility  | `public` or `invite_only`                                          |
| skills      | text[]      | Skill tags / fast filter                                           |
| languages   | text[]      | e.g. `{"English","Spanish"}`                                       |
| timezone    | text        | IANA string or human label (e.g. `Europe/London`)                  |
| country     | text        | For location filters                                               |
| created_at  | timestamptz |                                                                    |

> This is the main “seller” identity.\
> Social/portfolio links are stored in `org.profile_links` and `org.portfolios`.

---

### Table: `org.business_profiles` (client-facing profiles, MVP + future-proofed)

These are **lightweight client profiles** owned by a single human.\
They cover individual clients and small businesses that don’t need full organisation features.

| Column           | Type        | Notes                                                                                      |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                         |
| owner_user_id    | uuid        | FK → `auth.users.id` (who controls this client profile)                                    |
| name             | text        | Public / brand display name (“Acme Studio”, “Jane Doe – Marketing”)                        |
| headline         | text        | Short tagline (“E-commerce brand hiring design + UGC”)                                     |
| bio              | text        | “About” copy visible on the client profile page                                            |
| logo_url         | text        | Storage ref (used as avatar/logo for this client)                                          |
| country          | text        | Primary operating location                                                                 |
| languages        | text[]      | Languages this client can communicate in                                                   |
| timezone         | text        | Main timezone for meetings / deadlines                                                     |
| billing_email    | text        | Invoice recipient                                                                          |
| default_currency | text        | e.g. `GBP`, `USD` (helps with budgets and invoices)                                        |
| visibility       | visibility  | `public` for discoverable clients, `invite_only` to hide from search (optional future use) |
| plan             | text        | Current tier or plan label (`free`, `pro`, `enterprise-seed`, etc.)                        |
| created_at       | timestamptz |                                                                                            |

**Notes**

- A **single user can own multiple business_profiles** (different brands / ventures).
- Reviews left _about_ this client attach to `business_profiles.id`.
- Future **organisations** can associate many `business_profiles` under a single corporate umbrella
  without breaking this table.

---

### Table: `org.organisations` (NEW – future enterprise clients)

Represents a multi-user organisation (e.g. Google, Sony) that can have many employees and many
brands.

| Column          | Type        | Notes                                                                          |
| --------------- | ----------- | ------------------------------------------------------------------------------ |
| id              | uuid        | PK                                                                             |
| name            | text        | Organisation display name (“Google”, “Stripe”)                                 |
| legal_name      | text        | Registered legal entity name (optional initially)                              |
| logo_url        | text        | Logo / emblem                                                                  |
| country         | text        | Primary jurisdiction                                                           |
| website_url     | text        | Corporate site (used mainly for verification, not direct traffic off-platform) |
| billing_email   | text        | Central billing contact                                                        |
| plan            | text        | `enterprise`, `team`, etc.                                                     |
| verified_status | text        | `unverified`, `pending`, `verified`, `rejected`                                |
| settings        | jsonb       | Misc. org-wide settings (SSO required, 2FA policy, procurement rules, etc.)    |
| created_at      | timestamptz |                                                                                |

> MVP may not create rows here yet; this table is for Phase 3+ without requiring breaking
> migrations.

---

### Table: `org.organisation_members` (NEW – mapping users into organisations)

| Column                           | Type                                                      | Notes                                               |
| -------------------------------- | --------------------------------------------------------- | --------------------------------------------------- |
| id                               | uuid                                                      | PK                                                  |
| organisation_id                  | uuid                                                      | FK → `org.organisations.id`                         |
| user_id                          | uuid                                                      | FK → `auth.users.id`                                |
| role                             | text                                                      | e.g. `owner`, `admin`, `manager`, `buyer`, `viewer` |
| status                           | text                                                      | `active`, `invited`, `left`, `removed`              |
| created_at                       | timestamptz                                               |                                                     |
| UNIQUE(organisation_id, user_id) | Each user has at most one membership row per organisation |                                                     |

> Permissions in the app are derived from `role` + `status` on this table.\
> Reviews target the organisation itself, not individual members.

---

### Table: `org.organisation_departments` (NEW – optional departmental scoping)

| Column          | Type        | Notes                           |
| --------------- | ----------- | ------------------------------- |
| id              | uuid        | PK                              |
| organisation_id | uuid        | FK → `org.organisations.id`     |
| name            | text        | e.g. `Marketing`, `IT`, `Legal` |
| created_at      | timestamptz |                                 |

> Projects can optionally reference a department for reporting and routing.\
> MVP can ignore this; future enterprise features can hook into it.

---

### Table: `org.teams`

| Column        | Type        | Notes                                      |
| ------------- | ----------- | ------------------------------------------ |
| id            | uuid        | PK                                         |
| name          | text        | Team brand / label                         |
| owner_user_id | uuid        | FK → `auth.users.id` (ultimate controller) |
| description   | text        | Pitch / positioning                        |
| visibility    | visibility  | `public` or `invite_only`                  |
| created_at    | timestamptz |                                            |

### Table: `org.team_memberships`

| Column                   | Type               | Notes                                   |
| ------------------------ | ------------------ | --------------------------------------- |
| id                       | uuid               | PK                                      |
| team_id                  | uuid               | FK → `org.teams.id`                     |
| user_id                  | uuid               | FK → `auth.users.id`                    |
| role                     | text               | e.g. `freelancer`, `team_lead`, `admin` |
| status                   | text               | e.g. `active`, `invited`, `left`        |
| created_at               | timestamptz        |                                         |
| UNIQUE(team_id, user_id) | Enforced via index |                                         |

### Table: `org.team_roles`

| Column      | Type  | Notes                                   |
| ----------- | ----- | --------------------------------------- |
| id          | uuid  | PK                                      |
| team_id     | uuid  | FK → `org.teams.id`                     |
| title       | text  | e.g. "Designer", "PM", "QA Lead"        |
| permissions | jsonb | Serialized permission map for that role |

### Table: `org.org_invitations`

| Column              | Type        | Notes                                                             |
| ------------------- | ----------- | ----------------------------------------------------------------- |
| id                  | uuid        | PK                                                                |
| inviter_user_id     | uuid        | FK → `auth.users.id`                                              |
| target_email        | text        | Invitation target                                                 |
| team_id             | uuid        | FK → `org.teams.id` (optional depending on invite type)           |
| business_profile_id | uuid        | FK → `org.business_profiles.id` (optional)                        |
| organisation_id     | uuid        | FK → `org.organisations.id` (optional, future enterprise invites) |
| token               | text        | Secure/random token                                               |
| status              | text        | `pending`, `accepted`, `declined`, `expired`                      |
| created_at          | timestamptz |                                                                   |

### Table: `org.skills`

| Column | Type | Notes                   |
| ------ | ---- | ----------------------- |
| id     | uuid | PK                      |
| slug   | text | Unique machine-readable |
| label  | text | Human-readable display  |

### Table: `org.user_skills`

| Column                         | Type         | Notes                    |
| ------------------------------ | ------------ | ------------------------ |
| user_id                        | uuid         | FK → `auth.users.id`     |
| skill_id                       | uuid         | FK → `org.skills.id`     |
| proficiency                    | smallint     | User self-rating / level |
| PRIMARY KEY(user_id, skill_id) | Composite PK |                          |

### Table: `org.attachments`

| Column            | Type        | Notes                                                        |
| ----------------- | ----------- | ------------------------------------------------------------ |
| id                | uuid        | PK                                                           |
| owner_profile_id  | uuid        | The freelancer/business profile that "owns" this attachment  |
| bucket            | text        | FK → `storage.buckets.id` (e.g. `attachments`, `chat`, etc.) |
| path              | text        | Object path in bucket                                        |
| original_filename | text        | Client-side filename at upload time                          |
| display_name      | text        | User-editable "pretty name"                                  |
| mime_type         | text        | Sanitized / validated                                        |
| size_bytes        | bigint      |                                                              |
| sha256            | text        | File integrity                                               |
| status            | text        | e.g. `draft`, `uploaded`, `quarantined`, `clean`             |
| created_at        | timestamptz |                                                              |
| updated_at        | timestamptz |                                                              |

### Table: `org.user_emails`

| Column                 | Type               | Notes                                  |
| ---------------------- | ------------------ | -------------------------------------- |
| id                     | uuid               | PK                                     |
| user_id                | uuid               | FK → `auth.users.id`                   |
| email                  | text               | Secondary / alternate emails           |
| is_primary             | boolean            | Exactly one per user should be primary |
| verified_at            | timestamptz        | Null until verified                    |
| created_at             | timestamptz        |                                        |
| UNIQUE(user_id, email) | Prevent duplicates |                                        |

---

### Table: `org.portfolios`

| Column                | Type        | Notes                                                       |
| --------------------- | ----------- | ----------------------------------------------------------- |
| id                    | uuid        | PK                                                          |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`                           |
| title                 | text        | "Landing Page Redesign for Client X"                        |
| description           | text        | What was done / why it matters                              |
| cover_url             | text        | Screenshot / hero image (signed URL / preview)              |
| attachment_id         | uuid        | FK → `org.attachments.id` for source files / proof / output |
| is_public             | boolean     | Publicly viewable on freelancer profile                     |
| created_at            | timestamptz |                                                             |

### Table: `org.profile_links`

Stores social/portfolio links for both freelancers and business profiles.

| Column       | Type         | Notes                                                                                       |
| ------------ | ------------ | ------------------------------------------------------------------------------------------- |
| id           | uuid         | PK                                                                                          |
| profile_type | profile_type | `freelancer` or `business`                                                                  |
| profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `profile_type` |
| kind         | text         | `github`, `behance`, `dribbble`, `linkedin`, `youtube`, `website`, `other`                  |
| url          | text         | Validated URL                                                                               |
| is_public    | boolean      | Whether link is shown on the public profile                                                 |
| created_at   | timestamptz  |                                                                                             |

**Notes**

- UI can restrict certain `kind` values (e.g. hide `website` for MVP if you want to reduce
  off-platform leakage).
- Schema is flexible enough for future changes without new tables.

---

## 4. Projects Schema (`projects`)

Projects, stages, assignments, revisions, submissions, maintenance contracts, activity log.

### Table: `projects.projects`

| Column             | Type           | Notes                                                                                        |
| ------------------ | -------------- | -------------------------------------------------------------------------------------------- |
| id                 | uuid           | PK                                                                                           |
| client_business_id | uuid           | FK → `org.business_profiles.id` (the hiring creator / buyer profile for MVP and SMB clients) |
| title              | text           | Project name / headline                                                                      |
| description        | text           | Goals / scope                                                                                |
| status             | project_status | `draft`, `active`, `completed`, etc.                                                         |
| created_at         | timestamptz    |                                                                                              |

**Notes**

- For **MVP**, only `client_business_id` is populated; `organisation_id` / `department_id` remain
  NULL.
- For enterprise, `organisation_id` becomes the primary “owner” for reporting; `client_business_id`
  can represent a specific brand or sub-account under that org.

---

### Table: `projects.project_stages`

| Column       | Type         | Notes                                                                                |
| ------------ | ------------ | ------------------------------------------------------------------------------------ |
| id           | uuid         | PK                                                                                   |
| project_id   | uuid         | FK → `projects.projects.id`                                                          |
| name         | text         | e.g. "UI Design", "Coaching Call", "PM Oversight - Sprint 1"                         |
| "order"      | int          | Display order within the project                                                     |
| description  | text         | Scope / deliverables / agenda                                                        |
| status       | stage_status | `open`, `in_progress`, `submitted`, `approved`, `paid`, etc.                         |
| due_date     | timestamptz  | (NEW) Target completion date                                                         |
| completed_at | timestamptz  | (NEW) When stage was actually approved / closed                                      |
| stage_type   | text         | (Recommended) "file_based", "session", "group_session", "management", "maintenance"  |
| ip_mode      | text         | (Recommended) "exclusive_transfer", "licensed_use", "template_only", "internal_only" |
| created_at   | timestamptz  |                                                                                      |

> `stage_type` and `ip_mode` are important for UI behavior, payouts, disputes, and later licensing
> enforcement.

---

### Table: `projects.stage_budget_rules`

| Column           | Type   | Notes                                                                        |
| ---------------- | ------ | ---------------------------------------------------------------------------- |
| id               | uuid   | PK                                                                           |
| project_stage_id | uuid   | FK → `projects.project_stages.id`                                            |
| type             | text   | `fixed`, `cap`, `free`                                                       |
| amount_currency  | text   | e.g. `USD`, `GBP`                                                            |
| amount_cents     | bigint | Budget / cap / fee for that stage                                            |
| notes            | text   | Any custom pricing explanation (e.g. "First 2h free, then 50/hr up to £300") |

---

### Table: `projects.stage_assignments`

| Column                | Type            | Notes                                                                         |
| --------------------- | --------------- | ----------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                            |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                             |
| assignee_type         | assignment_type | `freelancer` or `team`                                                        |
| freelancer_profile_id | uuid            | FK → `org.freelancer_profiles.id` (nullable if assigned to team)              |
| team_id               | uuid            | FK → `org.teams.id` (nullable if assigned to single freelancer)               |
| assigned_by           | uuid            | FK → `auth.users.id` (the creator/buyer or team lead who made the assignment) |
| status                | text            | `invited`, `accepted`, `declined`, `active`                                   |
| created_at            | timestamptz     |                                                                               |

---

### Table: `projects.stage_submissions`

| Column           | Type        | Notes                                                                                                  |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                                      |
| submitted_by     | uuid        | FK → `auth.users.id` (who actually clicked submit)                                                     |
| notes            | text        | Context: "Final files attached", "Recording of session", "Maintenance summary for this billing period" |
| created_at       | timestamptz |                                                                                                        |

> Files linked to a submission will exist via `org.attachments` and tables like
> `comms.message_attachments` or a future `stage_submission_files` join.

---

### Table: `projects.stage_revision_requests`

| Column           | Type        | Notes                                                                                  |
| ---------------- | ----------- | -------------------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                      |
| requested_by     | uuid        | FK → `auth.users.id` (usually creator/business-side)                                   |
| type             | text        | `minor` or `major` (also drives potential extra budget or escalation)                  |
| reason           | text        | "The copy tone isn't what we agreed"; "You missed section 3"; "Session didn't cover X" |
| status           | text        | `open`, `in_progress`, `resolved`                                                      |
| created_at       | timestamptz |                                                                                        |
| resolved_at      | timestamptz |                                                                                        |

---

### Table: `projects.maintenance_contracts`

| Column                | Type        | Notes                               |
| --------------------- | ----------- | ----------------------------------- |
| id                    | uuid        | PK                                  |
| project_id            | uuid        | FK → `projects.projects.id`         |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`   |
| business_profile_id   | uuid        | FK → `org.business_profiles.id`     |
| amount_cents          | bigint      | Recurring cost per billing interval |
| currency              | text        | e.g. `USD`, `GBP`                   |
| interval              | text        | `weekly`, `monthly`, `quarterly`    |
| status                | text        | `active`, `paused`, `ended`         |
| created_at            | timestamptz |                                     |

> Covers ongoing "Maintenance Based" work such as retainer-style upkeep.

---

### Table: `projects.project_participants`

| Column                                       | Type                                       | Notes                                                                                            |
| -------------------------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| id                                           | uuid                                       | PK                                                                                               |
| project_id                                   | uuid                                       | FK → `projects.projects.id`                                                                      |
| profile_type                                 | profile_type                               | `freelancer` or `business`                                                                       |
| profile_id                                   | uuid                                       | Refers to `org.freelancer_profiles.id` OR `org.business_profiles.id` depending on `profile_type` |
| role                                         | text                                       | `viewer`, `collaborator`, maybe `owner`                                                          |
| UNIQUE(project_id, profile_type, profile_id) | Ensures no duplicate role rows per profile |                                                                                                  |

---

### Table: `projects.project_activity`

| Column        | Type        | Notes                                                                                               |
| ------------- | ----------- | --------------------------------------------------------------------------------------------------- |
| id            | uuid        | PK                                                                                                  |
| project_id    | uuid        | FK → `projects.projects.id`                                                                         |
| actor_user_id | uuid        | FK → `auth.users.id`                                                                                |
| kind          | text        | `status_change`, `file_upload`, `comment`, `budget_update`, etc.                                    |
| payload       | jsonb       | Arbitrary structured metadata (e.g. old_status/new_status, attachment refs, message ids)            |
| entity_table  | text        | Which entity this activity is about (`projects.project_stages`, `projects.stage_submissions`, etc.) |
| entity_id     | uuid        | The specific row in that entity                                                                     |
| created_at    | timestamptz |                                                                                                     |

---

## 5. Communication Schema (`comms`)

Project channels, DM threads, messages, and notification infrastructure.

### Table: `comms.project_channels`

| Column                   | Type                                                | Notes                                                                               |
| ------------------------ | --------------------------------------------------- | ----------------------------------------------------------------------------------- |
| id                       | uuid                                                | PK                                                                                  |
| project_id               | uuid                                                | FK → `projects.projects.id`                                                         |
| name                     | text                                                | `#general`, `#design`, etc. Must be unique per project                              |
| stage_id                 | uuid                                                | FK → `projects.project_stages.id` (optional: a stage-specific room like `#stage-2`) |
| visibility               | text                                                | `project_all` or `owner_and_assignees`                                              |
| created_at               | timestamptz                                         |                                                                                     |
| UNIQUE(project_id, name) | Prevent duplicate channel names inside same project |                                                                                     |

---

### Table: `comms.project_channel_participants`

| Column                                       | Type                                             | Notes                                |
| -------------------------------------------- | ------------------------------------------------ | ------------------------------------ |
| id                                           | uuid                                             | PK                                   |
| channel_id                                   | uuid                                             | FK → `comms.project_channels.id`     |
| profile_type                                 | profile_type                                     | `freelancer` or `business`           |
| profile_id                                   | uuid                                             | The profile in that channel          |
| role                                         | text                                             | `viewer`, `participant`, `moderator` |
| created_at                                   | timestamptz                                      |                                      |
| UNIQUE(channel_id, profile_type, profile_id) | Ensures no duplicate memberships in same channel |                                      |

---

### Table: `comms.project_messages`

| Column                        | Type                         | Notes                                   |
| ----------------------------- | ---------------------------- | --------------------------------------- |
| id                            | uuid                         | PK                                      |
| channel_id                    | uuid                         | FK → `comms.project_channels.id`        |
| sender_user_id                | uuid                         | FK → `auth.users.id`                    |
| body                          | text                         | Message text                            |
| created_at                    | timestamptz                  |                                         |
| edited_at                     | timestamptz                  | Null unless edited                      |
| deleted_at                    | timestamptz                  | Soft-delete flag for moderation / audit |
| INDEX(channel_id, created_at) | For chronological pagination |                                         |

---

### Table: `comms.dm_threads`

| Column             | Type        | Notes                |
| ------------------ | ----------- | -------------------- |
| id                 | uuid        | PK                   |
| created_by_user_id | uuid        | FK → `auth.users.id` |
| created_at         | timestamptz |                      |

### Table: `comms.dm_participants`

| Column                     | Type                                         | Notes                      |
| -------------------------- | -------------------------------------------- | -------------------------- |
| id                         | uuid                                         | PK                         |
| thread_id                  | uuid                                         | FK → `comms.dm_threads.id` |
| user_id                    | uuid                                         | FK → `auth.users.id`       |
| joined_at                  | timestamptz                                  |                            |
| UNIQUE(thread_id, user_id) | Prevent duplicate joins for same user/thread |                            |

### Table: `comms.dm_messages`

| Column                       | Type        | Notes                      |
| ---------------------------- | ----------- | -------------------------- |
| id                           | uuid        | PK                         |
| thread_id                    | uuid        | FK → `comms.dm_threads.id` |
| sender_user_id               | uuid        | FK → `auth.users.id`       |
| body                         | text        | Message text               |
| created_at                   | timestamptz |                            |
| INDEX(thread_id, created_at) | Pagination  |                            |

---

### Table: `comms.message_attachments`

| Column                                           | Type                                            | Notes                                                               |
| ------------------------------------------------ | ----------------------------------------------- | ------------------------------------------------------------------- |
| id                                               | uuid                                            | PK                                                                  |
| message_table                                    | text                                            | `'comms.project_messages'` or `'comms.dm_messages'`                 |
| message_id                                       | uuid                                            | References the row in whichever message table `message_table` names |
| attachment_id                                    | uuid                                            | FK → `org.attachments.id`                                           |
| created_at                                       | timestamptz                                     |                                                                     |
| UNIQUE(message_table, message_id, attachment_id) | Avoid attaching same file twice to same message |                                                                     |

> Allows any message to link to uploaded files (designs, deliverables, audit logs, etc.).

---

### Table: `comms.channel_files`

| Column                                          | Type                                              | Notes                                                                            |
| ----------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------------------------------- |
| id                                              | uuid                                              | PK                                                                               |
| channel_type                                    | text                                              | `'project'` or `'dm'`                                                            |
| channel_id                                      | uuid                                              | `comms.project_channels.id` OR `comms.dm_threads.id` depending on `channel_type` |
| attachment_id                                   | uuid                                              | FK → `org.attachments.id`                                                        |
| created_at                                      | timestamptz                                       |                                                                                  |
| UNIQUE(channel_type, channel_id, attachment_id) | Each file appears once in a channel-level gallery |                                                                                  |

---

### Table: `comms.notifications`

| Column       | Type        | Notes                                                     |
| ------------ | ----------- | --------------------------------------------------------- |
| id           | uuid        | PK                                                        |
| user_id      | uuid        | FK → `auth.users.id`                                      |
| type         | text        | e.g. `message.new`, `stage.submitted`, `payment.released` |
| title        | text        | Short summary                                             |
| body         | text        | Longer description                                        |
| entity_table | text        | Where this event originated                               |
| entity_id    | uuid        | The row ID in that entity                                 |
| read_at      | timestamptz | Null until read                                           |
| created_at   | timestamptz |                                                           |

### Table: `comms.notification_prefs`

| Column      | Type      | Notes                             |
| ----------- | --------- | --------------------------------- |
| user_id     | uuid      | PK, FK → `auth.users.id`          |
| email       | boolean   | Email alerts?                     |
| push        | boolean   | Push/mobile alerts?               |
| in_app      | boolean   | In-app notifications?             |
| digest      | boolean   | Summary digests allowed?          |
| quiet_hours | tstzrange | Time range where pushes are muted |

### Table: `comms.device_tokens`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| id         | uuid        | PK                       |
| user_id    | uuid        | FK → `auth.users.id`     |
| provider   | text        | `apns`, `fcm`, `webpush` |
| token      | text        | Push token               |
| created_at | timestamptz |                          |

---

## 6. Finance Schema (`finance`)

Wallets, escrows, payments, invoices, disputes, ratings, subscriptions.

### Table: `finance.wallets`

| Column                                 | Type                              | Notes                                                         |
| -------------------------------------- | --------------------------------- | ------------------------------------------------------------- |
| id                                     | uuid                              | PK                                                            |
| owner_type                             | text                              | `freelancer`, `team`, `business`, `organisation`              |
| owner_id                               | uuid                              | The profile/team/business/organisation this wallet belongs to |
| currency                               | text                              | `USD`, `GBP`, etc.                                            |
| balance_cents                          | bigint                            | Current balance                                               |
| created_at                             | timestamptz                       |                                                               |
| UNIQUE(owner_type, owner_id, currency) | One wallet per owner per currency |                                                               |

---

### Table: `finance.transactions`

| Column                       | Type                     | Notes                                                            |
| ---------------------------- | ------------------------ | ---------------------------------------------------------------- |
| id                           | uuid                     | PK                                                               |
| wallet_id                    | uuid                     | FK → `finance.wallets.id`                                        |
| direction                    | text                     | `credit` or `debit`                                              |
| amount_cents                 | bigint                   | Movement amount                                                  |
| currency                     | text                     | Currency code                                                    |
| reason                       | text                     | `escrow_release`, `refund`, `payout`, etc.                       |
| ref_table                    | text                     | Origin reference (e.g. `finance.escrows`)                        |
| ref_id                       | uuid                     | Origin row ID                                                    |
| balance_after_cents          | bigint                   | Snapshot of wallet after this transaction (for ledger reconcile) |
| created_at                   | timestamptz              |                                                                  |
| INDEX(wallet_id, created_at) | For statements / history |                                                                  |

---

### Table: `finance.escrows`

| Column                | Type            | Notes                                                                                     |
| --------------------- | --------------- | ----------------------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                                        |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                                         |
| payer_business_id     | uuid            | FK → `org.business_profiles.id` (who funded the stage)                                    |
| payer_organisation_id | uuid            | FK → `org.organisations.id` (optional; for enterprise payers)                             |
| payee_type            | assignment_type | `freelancer` or `team`                                                                    |
| payee_id              | uuid            | Points to either `org.freelancer_profiles.id` OR `org.teams.id` depending on `payee_type` |
| amount_cents          | bigint          | Escrowed amount                                                                           |
| currency              | text            |                                                                                           |
| status                | text            | `funded`, `released`, `refunded`, `disputed`                                              |
| created_at            | timestamptz     |                                                                                           |

---

### Table: `finance.payout_accounts`

| Column                       | Type                     | Notes                                                              |
| ---------------------------- | ------------------------ | ------------------------------------------------------------------ |
| id                           | uuid                     | PK                                                                 |
| owner_type                   | text                     | `freelancer`, `team`, `business`, `organisation`                   |
| owner_id                     | uuid                     | Profile / team / business / organisation referencing who gets paid |
| provider                     | text                     | `stripe`, etc.                                                     |
| account_id                   | text                     | External payout account reference                                  |
| status                       | text                     | `active`, `pending_verification`, `disabled`, etc.                 |
| UNIQUE(provider, account_id) | Avoid duplicate bindings |                                                                    |

---

### Table: `finance.invoices`

| Column                   | Type        | Notes                                                                 |
| ------------------------ | ----------- | --------------------------------------------------------------------- |
| id                       | uuid        | PK                                                                    |
| project_stage_id         | uuid        | FK → `projects.project_stages.id`                                     |
| issue_to_business_id     | uuid        | FK → `org.business_profiles.id` (buyer profile)                       |
| issue_to_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer)              |
| issue_from_profile       | uuid        | The freelancer profile / team / business that is issuing this invoice |
| amount_cents             | bigint      |                                                                       |
| currency                 | text        |                                                                       |
| status                   | text        | `draft`, `sent`, `paid`, `void`                                       |
| created_at               | timestamptz |                                                                       |

---

### Table: `finance.disputes`

| Column            | Type           | Notes                                                               |
| ----------------- | -------------- | ------------------------------------------------------------------- |
| id                | uuid           | PK                                                                  |
| escrow_id         | uuid           | FK → `finance.escrows.id` (the pot of money being fought over)      |
| opened_by_profile | uuid           | The profile_id (business or freelancer/team) who opened the dispute |
| reason            | text           | Human-readable complaint                                            |
| status            | dispute_status | `open`, `under_review`, `resolved`, `refunded`                      |
| resolution_notes  | text           | Moderator notes / final decision                                    |
| created_at        | timestamptz    |                                                                     |

### Table: `finance.dispute_messages`

| Column         | Type        | Notes                                  |
| -------------- | ----------- | -------------------------------------- |
| id             | uuid        | PK                                     |
| dispute_id     | uuid        | FK → `finance.disputes.id`             |
| sender_user_id | uuid        | FK → `auth.users.id`                   |
| body           | text        | Message / statement / evidence summary |
| created_at     | timestamptz |                                        |

> Internal "conversation" log for mediation / escalation during a dispute.

---

### Table: `finance.ratings`

| Column        | Type        | Notes                                            |
| ------------- | ----------- | ------------------------------------------------ |
| id            | uuid        | PK                                               |
| project_id    | uuid        | FK → `projects.projects.id`                      |
| rater_profile | uuid        | The profile who is leaving the rating            |
| ratee_type    | text        | `freelancer`, `team`, `business`, `organisation` |
| ratee_id      | uuid        | Profile/team/business/organisation being rated   |
| score         | smallint    | 1-5 stars                                        |
| comment       | text        | Public / semi-public feedback                    |
| created_at    | timestamptz |                                                  |

> This supports: freelancers rating clients (business or organisation) and clients rating
> freelancers/teams.

---

### Table: `finance.subscriptions`

| Column     | Type        | Notes                                                                           |
| ---------- | ----------- | ------------------------------------------------------------------------------- |
| id         | uuid        | PK                                                                              |
| profile_id | uuid        | The paying entity (freelancer_profile, team, business_profile, or organisation) |
| plan       | text        | Plan tier, e.g. `free`, `pro`, `team`, `enterprise`                             |
| status     | text        | `active`, `canceled`, `expired`                                                 |
| started_at | timestamptz | When billing/benefits started                                                   |
| ends_at    | timestamptz | When billing/benefits end if canceled or scheduled to lapse                     |

---

## 7. Marketplace Schema (`marketplace`)

Digital assets/templates for sale and purchase.

### Table: `marketplace.assets`

| Column            | Type        | Notes                                                   |
| ----------------- | ----------- | ------------------------------------------------------- |
| id                | uuid        | PK                                                      |
| seller_profile_id | uuid        | The freelancer/team/business profile selling this asset |
| title             | text        | Asset name                                              |
| description       | text        | Marketing copy                                          |
| preview_url       | text        | Public-ish preview (signed URL or downsample)           |
| file_ref          | text        | Internal reference to storage path of original asset    |
| category          | text        | For browsing / filtering                                |
| price_cents       | bigint      |                                                         |
| currency          | text        |                                                         |
| license_type      | text        | `full_rights`, `template_only`, etc.                    |
| status            | text        | `draft`, `published`                                    |
| created_at        | timestamptz |                                                         |

---

### Table: `marketplace.asset_versions`

| Column     | Type        | Notes                                       |
| ---------- | ----------- | ------------------------------------------- |
| id         | uuid        | PK                                          |
| asset_id   | uuid        | FK → `marketplace.assets.id`                |
| version    | int         | Version number                              |
| changelog  | text        | "Updated icons", "Fixed license text", etc. |
| file_ref   | text        | Storage ref for that specific version       |
| created_at | timestamptz |                                             |

---

### Table: `marketplace.asset_purchases`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id` (buyer).                 |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| amount_cents          | bigint      | Purchase amount                                          |
| currency              | text        |                                                          |
| license_granted       | text        | Snapshot of license terms at purchase time               |
| download_token        | text        | Token to enable secure short-lived download              |
| created_at            | timestamptz |                                                          |

---

### Table: `marketplace.asset_downloads`

| Column        | Type        | Notes                                 |
| ------------- | ----------- | ------------------------------------- |
| id            | uuid        | PK                                    |
| purchase_id   | uuid        | FK → `marketplace.asset_purchases.id` |
| downloaded_at | timestamptz | Timestamp of download                 |
| ip            | inet        | IP for audit / fraud                  |

---

### Table: `marketplace.asset_ratings`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id`                          |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| score                 | smallint    | Rating (1-5)                                             |
| comment               | text        | Feedback                                                 |
| created_at            | timestamptz |                                                          |

### Table: `marketplace.services`

| Column              | Type         | Notes                                                                                |
| ------------------- | ------------ | ------------------------------------------------------------------------------------ |
| id                  | uuid         | PK                                                                                   |
| seller_profile_type | profile_type | `freelancer` or `business` (future: extend enum if teams become first-class sellers) |
| seller_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on type    |
| title               | text         | Short name of the service (“Brand Audit”, “1:1 Coaching Call”)                       |
| slug                | text         | URL-safe identifier, unique per seller (e.g. `brand-audit`)                          |
| description         | text         | Long-form description of what’s included                                             |
| category            | text         | For browsing/filtering; can align with `search.topics.slug`                          |
| service_type        | text         | `one_off`, `package`, `retainer`, `session`                                          |
| base_price_cents    | bigint       | Starting price in minor units                                                        |
| currency            | text         | e.g. `GBP`, `USD`                                                                    |
| visibility          | visibility   | `public` or `invite_only`                                                            |
| status              | text         | `draft`, `published`, `paused`, `archived`                                           |
| estimated_duration  | interval     | Optional estimate (e.g. `2 hours`, `7 days`)                                         |
| created_at          | timestamptz  |                                                                                      |
| updated_at          | timestamptz  |                                                                                      |

---

## 8. Search Schema (`search`)

Search index and saved filters.

### Table: `search.search_index`

| Column                    | Type                                            | Notes                                                   |
| ------------------------- | ----------------------------------------------- | ------------------------------------------------------- |
| id                        | uuid                                            | PK                                                      |
| entity                    | text                                            | `freelancer`, `team`, `project_template`, `asset`, etc. |
| entity_id                 | uuid                                            | The row ID in that entity                               |
| text                      | tsvector                                        | Full-text index for Postgres search                     |
| updated_at                | timestamptz                                     |                                                         |
| UNIQUE(entity, entity_id) | De-duplicate search records per entity instance |                                                         |

### Table: `search.embeddings`

| Column                    | Type        | Notes                                   |
| ------------------------- | ----------- | --------------------------------------- |
| id                        | uuid        | PK                                      |
| entity                    | text        |                                         |
| entity_id                 | uuid        |                                         |
| embedding                 | vector      | pgvector column for semantic similarity |
| updated_at                | timestamptz |                                         |
| UNIQUE(entity, entity_id) |             |                                         |

### Table: `search.user_embeddings`

| Column     | Type        | Notes                     |
| ---------- | ----------- | ------------------------- |
| user_id    | uuid        | PK, FK → `auth.users.id`  |
| embedding  | vector      | User preference embedding |
| updated_at | timestamptz | Last rebuild time         |

### Table: `search.filters`

| Column        | Type  | Notes                                                |
| ------------- | ----- | ---------------------------------------------------- |
| id            | uuid  | PK                                                   |
| owner_user_id | uuid  | FK → `auth.users.id`                                 |
| name          | text  | Human-readable label ("My SEO/Figma freelancers UK") |
| query         | jsonb | Serialized filter config                             |

### Table: `search.topics`

| Column | Type | Notes                                                            |
| ------ | ---- | ---------------------------------------------------------------- |
| id     | uuid | PK                                                               |
| slug   | text | Unique machine-readable topic name (`marketing`, `design`, etc.) |
| label  | text | Human-readable display label                                     |

### Table: `search.entity_topics`

| Column                                   | Type | Notes                                          |
| ---------------------------------------- | ---- | ---------------------------------------------- |
| entity                                   | text | Same entity type used in `search.search_index` |
| entity_id                                | uuid | FK into the corresponding table                |
| topic_id                                 | uuid | FK → `search.topics.id`                        |
| PRIMARY KEY(entity, entity_id, topic_id) |      |                                                |

```sql
-- Suggested index
CREATE INDEX entity_topics_topic_idx ON search.entity_topics (topic_id);
```

---

## 9. Ops Schema (`ops`)

Admin/moderation, outbound webhooks, email queue, rate limit tracking.

### Table: `ops.admin_users`

| Column  | Type | Notes                              |
| ------- | ---- | ---------------------------------- |
| user_id | uuid | PK, FK → `auth.users.id`           |
| role    | text | `moderator`, `admin`, `superadmin` |

### Table: `ops.moderation_flags`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| entity_table | text        | Which table/entity is flagged |
| entity_id    | uuid        | Row being flagged             |
| reason       | text        | Why it's flagged              |
| status       | text        | `open`, `reviewing`, `closed` |
| created_at   | timestamptz |                               |

### Table: `ops.webhook_outbox`

| Column        | Type        | Notes                                                       |
| ------------- | ----------- | ----------------------------------------------------------- |
| id            | uuid        | PK                                                          |
| topic         | text        | Event type e.g. `project.updated`, `payment.released`, etc. |
| payload       | jsonb       | Serialized payload                                          |
| status        | text        | `pending`, `sent`, `failed`                                 |
| retry_count   | int         | Number of retry attempts                                    |
| next_retry_at | timestamptz | When to try next                                            |
| created_at    | timestamptz |                                                             |

### Table: `ops.email_queue`

| Column     | Type        | Notes                       |
| ---------- | ----------- | --------------------------- |
| id         | uuid        | PK                          |
| to_email   | text        | Recipient                   |
| template   | text        | Template key                |
| vars       | jsonb       | Template variables          |
| status     | text        | `pending`, `sent`, `failed` |
| created_at | timestamptz |                             |

### Table: `ops.rate_limit_counters`

| Column           | Type        | Notes                                                          |
| ---------------- | ----------- | -------------------------------------------------------------- |
| id               | uuid        | PK                                                             |
| bucket_key       | text        | User/IP/bucket identifier (like `user:123-action:sendMessage`) |
| count            | int         | Count in the active rate limit window                          |
| window_starts_at | timestamptz | Start timestamp for the rolling / fixed window                 |

---

## 10. Analytics Schema (`analytics`)

Event logs + rollups.

### Table: `analytics.event_log`

| Column     | Type        | Notes                                                     |
| ---------- | ----------- | --------------------------------------------------------- |
| id         | uuid        | PK                                                        |
| user_id    | uuid        | FK → `auth.users.id`                                      |
| event      | text        | e.g. `stage.submitted`, `escrow.funded`, `dispute.opened` |
| props      | jsonb       | Extra analytics data                                      |
| created_at | timestamptz | Timestamp                                                 |

### Table: `analytics.daily_rollups`

| Column                   | Type   | Notes                                                           |
| ------------------------ | ------ | --------------------------------------------------------------- |
| day                      | date   | Part of composite PK                                            |
| metric                   | text   | Part of composite PK (e.g. `new_projects`, `escrow_volume_gbp`) |
| value                    | bigint | Metric value                                                    |
| PRIMARY KEY(day, metric) |        |                                                                 |

### Table: `analytics.entity_stats`

| Column                         | Type         | Notes                                                           |
| ------------------------------ | ------------ | --------------------------------------------------------------- |
| entity                         | text         | e.g., `freelancer`, `team`, `service`, `asset`, `article`, etc. |
| entity_id                      | uuid         | PK (together with entity)                                       |
| rating_avg                     | numeric(3,2) | Aggregated rating                                               |
| rating_count                   | integer      | Number of ratings                                               |
| views_7d                       | integer      | View count past 7 days                                          |
| clicks_7d                      | integer      | Click count past 7 days                                         |
| saves_7d                       | integer      | Save/shortlist count past 7 days                                |
| hires_7d                       | integer      | Hire/purchase count past 7 days                                 |
| views_30d                      | integer      | View count past 30 days                                         |
| hires_30d                      | integer      | Hire/purchase count past 30 days                                |
| dispute_rate                   | numeric(5,4) | Derived from finance.disputes vs completed work                 |
| last_activity_at               | timestamptz  | Last meaningful update                                          |
| PRIMARY KEY(entity, entity_id) |              |                                                                 |

```sql
CREATE INDEX entity_stats_activity_idx ON analytics.entity_stats (last_activity_at DESC);
```

### Table: `analytics.user_entity_stats`

| Column                                  | Type        | Notes                           |
| --------------------------------------- | ----------- | ------------------------------- |
| user_id                                 | uuid        | FK → `auth.users.id`            |
| entity                                  | text        | Entity type                     |
| entity_id                               | uuid        | FK into the corresponding table |
| views                                   | integer     | Total views by this user        |
| clicks                                  | integer     | Total clicks                    |
| saves                                   | integer     | Saved/shortlisted count         |
| hires                                   | integer     | Hires or purchases              |
| last_interaction_at                     | timestamptz | Most recent interaction         |
| PRIMARY KEY(user_id, entity, entity_id) |             |                                 |

```sql
CREATE INDEX user_entity_stats_user_idx ON analytics.user_entity_stats (user_id);
```

### View / Materialized View: `analytics.earnings_by_stage_mv`

| Column            | Type        | Notes                                  |
| ----------------- | ----------- | -------------------------------------- |
| project_stage_id  | uuid        | FK → `projects.project_stages.id`      |
| total_cents       | bigint      | Sum of released payouts for that stage |
| currency          | text        |                                        |
| last_refreshed_at | timestamptz | When MV was last updated               |

(Backed by SQL view / materialized view files in `/db/views/analytics/`.)

---

## 11. Integrations Schema (`integrations`)

External service hookups (GitHub, Trello, Notion, etc.).

### Table: `integrations.providers`

| Column     | Type        | Notes                                   |
| ---------- | ----------- | --------------------------------------- |
| id         | text        | PK (`github`, `trello`, `notion`, etc.) |
| label      | text        | Display name                            |
| auth_type  | text        | `oauth2`, `api_key`, `none`             |
| scopes     | text[]      | Required perms/scopes                   |
| created_at | timestamptz |                                         |

### Table: `integrations.connections`

| Column                                   | Type                                      | Notes                                                                                 |
| ---------------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------- |
| id                                       | uuid                                      | PK                                                                                    |
| provider_id                              | text                                      | FK → `integrations.providers.id`                                                      |
| owner_type                               | profile_type                              | Which profile context this belongs to (`freelancer`, `business`), or `user` if needed |
| owner_id                                 | uuid                                      | Profile or user this connection belongs to                                            |
| external_account_id                      | text                                      | External provider account identifier                                                  |
| access                                   | jsonb                                     | Encrypted tokens/config                                                               |
| status                                   | text                                      | `active`, `revoked`                                                                   |
| created_at                               | timestamptz                               |                                                                                       |
| INDEX(provider_id, owner_type, owner_id) | Helpful for "show me all my integrations" |                                                                                       |

### Table: `integrations.installs`

| Column        | Type        | Notes                              |
| ------------- | ----------- | ---------------------------------- |
| id            | uuid        | PK                                 |
| connection_id | uuid        | FK → `integrations.connections.id` |
| scope         | text        | e.g. `project:{id}` or `workspace` |
| settings      | jsonb       | Install-level configuration        |
| created_at    | timestamptz |                                    |

## 12. Content Schema (`content`)

Author-created content such as articles, guides, and thought-leadership pieces. Used to drive
discovery for sellers and educate buyers.

### Table: `content.articles`

| Column              | Type         | Notes                                                                                              |
| ------------------- | ------------ | -------------------------------------------------------------------------------------------------- |
| id                  | uuid         | PK                                                                                                 |
| author_profile_type | profile_type | `freelancer` or `business` (later extend if you want org/team-authored content)                    |
| author_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `author_profile_type` |
| title               | text         | Article title                                                                                      |
| slug                | text         | URL-safe identifier, unique per author (e.g. `how-to-brief-a-designer`)                            |
| excerpt             | text         | Short summary for cards/previews                                                                   |
| body                | text         | Main article content (Markdown or rich-text serialisation)                                         |
| cover_attachment_id | uuid         | FK → `org.attachments.id` (optional cover image)                                                   |
| tags                | text[]       | Optional tag list; for display only (search tags live in `search.entity_topics`)                   |
| visibility          | visibility   | `public` or `invite_only`                                                                          |
| status              | text         | `draft`, `published`, `archived`                                                                   |
| published_at        | timestamptz  | When article went live (NULL while draft)                                                          |
| created_at          | timestamptz  |                                                                                                    |
| updated_at          | timestamptz  |                                                                                                    |

```

### File: docs\10_APIEndpints.md

```md
# Projective API Specification

**Base URL:** `/api/v1`  
**Auth:** Bearer JWT (short-lived access)  
**Refresh:** Opaque token rotation  
**CAPTCHA:** Cloudflare Turnstile for anonymous POSTs  
**Storage:** Supabase signed URLs (60s TTL)  
**Rate Limiting:** Per-IP and per-user  
**RLS Context:** `active_profile_id`, `active_team_id`

---

## 🧩 Auth & Session

| Method | Endpoint                 | Description                                 |
| ------ | ------------------------ | ------------------------------------------- |
| POST   | `/auth/signup`           | Create account (email/password + Turnstile) |
| POST   | `/auth/login`            | Login, returns access + refresh tokens      |
| POST   | `/auth/refresh`          | Rotate refresh → new access token           |
| POST   | `/auth/logout`           | Revoke refresh token                        |
| GET    | `/auth/me`               | Get current user context                    |
| POST   | `/auth/turnstile/verify` | Verify CAPTCHA token                        |
| POST   | `/auth/switch-profile`   | Switch between freelancer/business profiles |
| POST   | `/auth/switch-team`      | Switch active team                          |

---

### Emails

| Method | Endpoint                      | Description                |
| ------ | ----------------------------- | -------------------------- |
| GET    | `/account/emails`             | List linked emails         |
| POST   | `/account/emails`             | Add email (sends verify)   |
| GET    | `/account/emails/:id`         | Check verification         |
| PATCH  | `/account/emails/:id/primary` | Make primary               |
| DELETE | `/account/emails/:id`         | Remove (guards if primary) |

---

## 👤 Users & Profiles

### Users

| Method | Endpoint     | Description           |
| ------ | ------------ | --------------------- |
| GET    | `/users/:id` | Public user info      |
| PATCH  | `/users/:id` | Update profile (self) |

### Freelancer Profiles

| Method | Endpoint           | Description                                   |
| ------ | ------------------ | --------------------------------------------- |
| GET    | `/freelancers/:id` | Get freelancer details                        |
| POST   | `/freelancers`     | Create freelancer profile                     |
| PATCH  | `/freelancers/:id` | Update freelancer info                        |
| DELETE | `/freelancers/:id` | Delete freelancer profile                     |
| GET    | `/freelancers`     | Discover freelancers (filter by skills, rate) |

### Business Profiles

| Method | Endpoint          | Description             |
| ------ | ----------------- | ----------------------- |
| GET    | `/businesses/:id` | Get business details    |
| POST   | `/businesses`     | Create business profile |
| PATCH  | `/businesses/:id` | Update business         |
| DELETE | `/businesses/:id` | Delete business profile |
| GET    | `/businesses`     | List user’s businesses  |

### Skills

| Method | Endpoint                         | Description          |
| ------ | -------------------------------- | -------------------- |
| GET    | `/skills`                        | List skill directory |
| POST   | `/users/:userId/skills`          | Add a skill to user  |
| DELETE | `/users/:userId/skills/:skillId` | Remove skill         |

### Attachments

| Method | Endpoint           | Description             |
| ------ | ------------------ | ----------------------- |
| POST   | `/attachments`     | Get signed upload URL   |
| GET    | `/attachments/:id` | Get attachment metadata |
| DELETE | `/attachments/:id` | Delete attachment       |

---

## 🧑‍🤝‍🧑 Teams & Organizations

| Method | Endpoint     | Description               |
| ------ | ------------ | ------------------------- |
| GET    | `/teams/:id` | Get team profile          |
| POST   | `/teams`     | Create new team           |
| PATCH  | `/teams/:id` | Update team               |
| DELETE | `/teams/:id` | Delete team               |
| GET    | `/teams`     | List owned & joined teams |

### Memberships

| Method | Endpoint                           | Description        |
| ------ | ---------------------------------- | ------------------ |
| POST   | `/teams/:id/members`               | Invite/add member  |
| PATCH  | `/teams/:id/members/:membershipId` | Update member role |
| DELETE | `/teams/:id/members/:membershipId` | Remove member      |

### Roles

| Method | Endpoint                   | Description |
| ------ | -------------------------- | ----------- |
| GET    | `/teams/:id/roles`         | List roles  |
| POST   | `/teams/:id/roles`         | Create role |
| PATCH  | `/teams/:id/roles/:roleId` | Update role |
| DELETE | `/teams/:id/roles/:roleId` | Delete role |

### Invitations

| Method | Endpoint                          | Description                     |
| ------ | --------------------------------- | ------------------------------- |
| POST   | `/org/invitations`                | Create invitation (email token) |
| POST   | `/org/invitations/:token/accept`  | Accept invitation               |
| POST   | `/org/invitations/:token/decline` | Decline invitation              |

---

## 🧱 Projects & Stages

| Method | Endpoint        | Description                                        |
| ------ | --------------- | -------------------------------------------------- |
| POST   | `/projects`     | Create a new project for a business or client      |
| GET    | `/projects/:id` | Get project details                                |
| PATCH  | `/projects/:id` | Update project information                         |
| DELETE | `/projects/:id` | Delete a project                                   |
| GET    | `/projects`     | List projects (filtered by role, status, or owner) |

### Stages

| Method | Endpoint                       | Description                                   |
| ------ | ------------------------------ | --------------------------------------------- |
| POST   | `/projects/:id/stages`         | Create stage(s) for a project                 |
| GET    | `/projects/:id/stages`         | List all stages for a project                 |
| PATCH  | `/stages/:stageId`             | Update a stage (status, name, etc.)           |
| PUT    | `/stages/:stageId/budget-rule` | Define pricing model (fixed, hourly, capped)  |
| POST   | `/stages/:stageId/assign`      | Assign freelancer or team to a stage          |
| DELETE | `/stages/:stageId/assign`      | Unassign freelancer or team                   |
| POST   | `/stages/:stageId/submissions` | Submit deliverables for approval              |
| GET    | `/stages/:stageId/submissions` | View stage submissions                        |
| POST   | `/stages/:stageId/approve`     | Approve the stage submission                  |
| GET    | `/projects/:id/activity`       | View recent activity or updates for a project |

### Participants & Activity

| Method | Endpoint                     | Description                |
| ------ | ---------------------------- | -------------------------- |
| POST   | `/projects/:id/participants` | Add project collaborator   |
| GET    | `/projects/:id/participants` | List participants          |
| GET    | `/projects/:id/activity`     | View project activity feed |

---

## 💬 Collaboration & Messaging

### 🧱 Project Channels

Project-based chats between the project owner and assigned freelancers/teams.  
Each project can have multiple channels — for stages, roles, or general discussion.

| Method | Endpoint                                    | Description                                                |
| ------ | ------------------------------------------- | ---------------------------------------------------------- |
| POST   | `/projects/:id/channels`                    | Create a new project channel (`#general`, `#design`, etc.) |
| GET    | `/projects/:id/channels`                    | List all channels within a project                         |
| POST   | `/project-channels/:channelId/messages`     | Send a message to a project channel                        |
| GET    | `/project-channels/:channelId/messages`     | Get messages in a project channel (paginated)              |
| GET    | `/project-channels/:channelId/files`        | View all files uploaded or shared in this channel          |
| POST   | `/project-channels/:channelId/participants` | Add or remove channel participants (by profile/team)       |

---

### 💬 Private Chats (DMs)

One-to-one or group conversations between any users on the platform.  
Ideal for team discussions or networking — fully separate from project communications.

| Method | Endpoint                          | Description                                      |
| ------ | --------------------------------- | ------------------------------------------------ |
| POST   | `/dms/threads`                    | Start a new DM or group chat with selected users |
| GET    | `/dms/threads`                    | List all your private DM threads                 |
| POST   | `/dms/threads/:threadId/messages` | Send a message to a DM thread                    |
| GET    | `/dms/threads/:threadId/messages` | Get messages in a DM thread (paginated)          |
| GET    | `/dms/threads/:threadId/files`    | View all files shared in this DM thread          |

---

### 🔔 Notifications

System and in-app alerts for messages, mentions, and activity.

| Method | Endpoint                  | Description                                             |
| ------ | ------------------------- | ------------------------------------------------------- |
| GET    | `/notifications`          | Get all notifications for the current user              |
| PATCH  | `/notifications/:id/read` | Mark notification(s) as read                            |
| GET    | `/notification-prefs`     | Retrieve notification preferences (email, push, digest) |
| PUT    | `/notification-prefs`     | Update notification preferences                         |
| POST   | `/device-tokens`          | Register a device for push notifications                |
| DELETE | `/device-tokens/:id`      | Remove registered device token                          |

---

## 🧠 Templates (Guided Hiring)

| Method | Endpoint                                             | Description               |
| ------ | ---------------------------------------------------- | ------------------------- |
| POST   | `/templates`                                         | Create template           |
| GET    | `/templates/:id`                                     | Get template              |
| PATCH  | `/templates/:id`                                     | Update template           |
| DELETE | `/templates/:id`                                     | Delete template           |
| GET    | `/templates`                                         | Browse templates          |
| POST   | `/templates/:id/stages`                              | Add template stage        |
| PATCH  | `/templates/stages/:templateStageId`                 | Update stage              |
| PUT    | `/templates/stages/:templateStageId/recommendations` | Add AI recommendations    |
| PUT    | `/templates/stages/:templateStageId/price`           | Set suggested price       |
| POST   | `/templates/:id/apply-to-project/:projectId`         | Apply template to project |

---

## 💰 Finance

| Method | Endpoint                    | Description                |
| ------ | --------------------------- | -------------------------- |
| GET    | `/wallets/mine`             | Get wallet by profile/team |
| GET    | `/wallets/:id/transactions` | Transaction history        |
| POST   | `/escrows`                  | Create escrow for stage    |
| POST   | `/escrows/:id/release`      | Release payment            |
| POST   | `/escrows/:id/refund`       | Refund payment             |
| GET    | `/escrows/:id`              | Get escrow details         |
| GET    | `/stages/:stageId/escrow`   | Get escrow for stage       |
| POST   | `/invoices`                 | Create invoice             |
| GET    | `/invoices/:id`             | Get invoice                |
| PATCH  | `/invoices/:id`             | Update invoice             |
| POST   | `/disputes`                 | Create dispute             |
| PATCH  | `/disputes/:id`             | Update dispute status      |
| POST   | `/ratings`                  | Submit rating              |
| POST   | `/webhooks/stripe`          | Stripe webhook endpoint    |

---

## 🛍️ Marketplace

| Method | Endpoint                  | Description               |
| ------ | ------------------------- | ------------------------- |
| POST   | `/assets`                 | Upload new asset          |
| GET    | `/assets/:id`             | Get asset info            |
| PATCH  | `/assets/:id`             | Update asset              |
| DELETE | `/assets/:id`             | Delete asset              |
| POST   | `/assets/:id/versions`    | Add asset version         |
| GET    | `/assets`                 | Browse marketplace assets |
| POST   | `/assets/:id/purchase`    | Purchase asset            |
| GET    | `/purchases/:id/download` | Download purchased asset  |
| POST   | `/assets/:id/ratings`     | Rate asset                |

---

## 🔍 Search

| Method | Endpoint              | Description                                  |
| ------ | --------------------- | -------------------------------------------- |
| GET    | `/search`             | Search freelancers, teams, templates, assets |
| POST   | `/search/filters`     | Save search filter                           |
| GET    | `/search/filters`     | List saved filters                           |
| DELETE | `/search/filters/:id` | Delete saved filter                          |

---

## 🛠️ Admin & Ops

| Method | Endpoint                          | Description               |
| ------ | --------------------------------- | ------------------------- |
| GET    | `/admin/users`                    | Admin list users          |
| POST   | `/admin/moderation/flags`         | Create content flag       |
| PATCH  | `/admin/moderation/flags/:id`     | Update moderation flag    |
| GET    | `/admin/webhook-outbox`           | List outbound webhooks    |
| POST   | `/admin/webhook-outbox/:id/retry` | Retry webhook delivery    |
| POST   | `/admin/email-queue`              | Queue transactional email |
| GET    | `/admin/rate-limits/:bucketKey`   | Inspect rate limit bucket |
| GET    | `/admin/audit-logs`               | Filter audit events       |

---

## 📈 Analytics

| Method | Endpoint                                | Description                   |
| ------ | --------------------------------------- | ----------------------------- |
| POST   | `/analytics/events`                     | Record client analytics event |
| GET    | `/analytics/daily`                      | View daily metrics            |
| GET    | `/analytics/earnings-by-stage/:stageId` | View stage earnings report    |

---

## ⚙️ Meta & Health

| Method | Endpoint             | Description           |
| ------ | -------------------- | --------------------- |
| GET    | `/health`            | Health check          |
| GET    | `/ready`             | Readiness probe       |
| GET    | `/version`           | Current API version   |
| GET    | `/feature-flags`     | Get feature flags     |
| POST   | `/csp-report`        | Report CSP violation  |
| GET    | `/rate-limit-status` | Show user rate limits |

---

## ✉️ Notifications & Emails

| Method | Endpoint                        | Description             |
| ------ | ------------------------------- | ----------------------- |
| POST   | `/emails/test`                  | Send test email         |
| POST   | `/notifications/broadcast`      | Admin broadcast message |
| POST   | `/notifications/digest/preview` | Preview digest email    |

---

## 📦 Storage & Files

Users can manage their personal file library, rename files before upload, and re-use files in chats or projects without re-uploading.

### 🗂️ User File Library

| Method | Endpoint              | Description                                                                         |
| ------ | --------------------- | ----------------------------------------------------------------------------------- |
| GET    | `/files`              | List all files in the user’s personal library (filterable by status, type, or name) |
| POST   | `/files/initiate`     | Begin a new file upload (returns signed upload URL)                                 |
| PATCH  | `/files/:id/rename`   | Rename a file before or after upload                                                |
| PATCH  | `/files/:id/finalize` | Mark a file as uploaded and available for reuse                                     |
| GET    | `/files/:id`          | Get file metadata and signed download URL                                           |
| DELETE | `/files/:id`          | Delete a file from the user’s library                                               |

---

### 📎 Chat File Reuse

| Method | Endpoint                               | Description                                         |
| ------ | -------------------------------------- | --------------------------------------------------- |
| POST   | `/project-messages/:msgId/attachments` | Attach an existing file to a project message        |
| POST   | `/dm-messages/:msgId/attachments`      | Attach an existing file to a private DM message     |
| GET    | `/project-channels/:channelId/files`   | View all files shared in a specific project channel |
| GET    | `/dms/threads/:threadId/files`         | View all files shared in a private DM thread        |

---

## 🔔 Realtime

| Method | Endpoint             | Description                      |
| ------ | -------------------- | -------------------------------- |
| GET    | `/realtime/auth`     | Get Supabase Realtime auth token |
| POST   | `/realtime/presence` | Announce realtime presence       |

---

## 🌐 Webhooks (Outbound)

| Method | Endpoint                                                                                                | Description               |
| ------ | ------------------------------------------------------------------------------------------------------- | ------------------------- |
| POST   | `/hooks`                                                                                                | Register external webhook |
| DELETE | `/hooks/:id`                                                                                            | Remove webhook            |
| Topics | `project.updated`, `stage.status_changed`, `payment.released`, `dispute.opened`, `asset.purchased`, ... |

---

## 🧩 Non-CRUD Action Endpoints

| Method | Endpoint                   | Description                        |
| ------ | -------------------------- | ---------------------------------- |
| POST   | `/auth/switch-profile`     | Switch active profile              |
| POST   | `/auth/switch-team`        | Switch active team                 |
| POST   | `/stages/:stageId/submit`  | Submit work (alias for submission) |
| POST   | `/stages/:stageId/approve` | Approve stage (shortcut)           |
| POST   | `/escrows/:id/release`     | Release escrow funds               |
| POST   | `/escrows/:id/refund`      | Refund escrow funds                |
| POST   | `/assets/:id/purchase`     | Purchase marketplace asset         |
| GET    | `/purchases/:id/download`  | Download purchased item            |

## 🔌 Integrations & Plugins

Future-ready integration endpoints to connect tools such as GitHub, Trello, Notion, or AI assistants.

| Method | Endpoint                        | Description                                                         |
| ------ | ------------------------------- | ------------------------------------------------------------------- |
| GET    | `/integrations/providers`       | List all available integration providers                            |
| POST   | `/integrations/connections`     | Connect an external account (OAuth or API key)                      |
| GET    | `/integrations/connections`     | List connected integrations for the current user/profile            |
| DELETE | `/integrations/connections/:id` | Disconnect an integration                                           |
| POST   | `/integrations/installs`        | Install or enable a connected integration in a workspace or project |
| GET    | `/integrations/installs`        | List integrations installed in the current workspace/project        |

---

**Last Updated:** October 2025  
**Generated For:** Projective Platform v1  
**Author:** GPT-5 (Projective System Docs)

```

### File: docs\11_Storage.md

```md
# 🗄️ Projective Storage Architecture

Supabase Storage layout for Projective — covering user file libraries, chat attachments, project assets, marketplace items, and future plugin integrations.

All buckets are **private** by default.  
Access is always managed via the database (RLS) and **short-lived signed URLs (TTL 60 s)**.

---

## 📁 Bucket Overview

| Bucket         | Purpose                                             | Visibility                           | Lifecycle                  |
| -------------- | --------------------------------------------------- | ------------------------------------ | -------------------------- |
| `avatars`      | User/team/business avatars                          | Private (optional public read later) | Keep; replace on upload    |
| `attachments`  | User personal file library (draft → uploaded)       | Private                              | Drafts expire after 7 days |
| `chat`         | Optional denormalized copies for project & DM chats | Private                              | Mirrors message lifetime   |
| `project`      | Project-scoped exports/artifacts                    | Private                              | Keep or purge by project   |
| `marketplace`  | Publicly listed assets & paid versions              | Mixed (previews vs originals)        | Keep versions              |
| `previews`     | Thumbnails / PDF & video previews                   | Private                              | Delete after 30 days       |
| `quarantine`   | Virus/MIME scan staging                             | Private                              | Delete after 24 h          |
| `integrations` | External provider import/export data                | Private                              | Keep 90 days               |
| `tmp`          | Ephemeral exports/transcodes                        | Private                              | Delete after 1 h           |

---

## 🧍 Avatars (`avatars`)

**Purpose:** Profile pictures and logos.  
**Paths**

- avatars/users/{user_id}/{uuid}.{ext}
- avatars/teams/{team_id}/{uuid}.{ext}
- avatars/businesses/{business_id}/{uuid}.{ext}

**RLS**

- Write: owner or admin.
- Read: via signed URL (or make public later).

---

## 📎 Attachments (`attachments`)

**Purpose:** Core personal file library — powers pre-upload rename & re-use across chats.  
Backed by `org.attachments` table. :contentReference[oaicite:1]{index=1}

**Paths**

- attachments/{owner_profile_id}/drafts/{attachment_id}/{original_filename}
- attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}

**Flow**

1. **Initiate:** create DB row (`status=draft`) → signed upload URL to `drafts/…`.
2. **Rename:** update `display_name` before finalize.
3. **Finalize:** verify file, scan → move to `files/…`, set `status=uploaded`.

**RLS**

- `SELECT/UPDATE/DELETE`: owner only.
- Others access only through `message_attachments` / `channel_files` joins.

**Lifecycle**

- Delete drafts > 7 days old.
- Keep uploaded files until deleted.

---

## 💬 Chat Files (`chat`) _(optional)_

**Purpose:** Direct per-channel galleries (may be omitted; DB joins work fine). :contentReference[oaicite:2]{index=2}

**Paths**

- chat/projects/{project_id}/channels/{channel_id}/{attachment_id}/{filename}
- chat/dms/{thread_id}/{attachment_id}/{filename}

**Policy**

- Participants can read/write within their channels or DM threads.

**TTL**

- 60 s signed URLs; keep while messages exist.

---

## 🧱 Project Assets (`project`)

**Purpose:** Store compiled deliverables or exports not owned by individuals.

**Paths**

- project/{project_id}/exports/{yyyy-mm}/{uuid}.pdf
- project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}

**RLS**

- Project owners and participants can read.
- Writes by system jobs.

---

## 🛍️ Marketplace (`marketplace`)

**Purpose:** Marketplace asset versions and buyer-only downloads. :contentReference[oaicite:3]{index=3}

**Paths**

- marketplace/assets/{asset_id}/versions/{version_id}/{filename}
- marketplace/assets/{asset_id}/previews/{uuid}.{ext}
- marketplace/purchases/{purchase_id}/license/{license_id}.pdf

**Access**

- Previews: readable by anyone via signed URL.
- Originals: only verified buyers via `/purchases/:id/download`.

---

## 🖼️ Previews (`previews`)

**Purpose:** Generated thumbnails and PDF/video snapshots.

**Paths**

- previews/attachments/{attachment_id}/thumb.{ext}
- previews/attachments/{attachment_id}/page-1.png
- previews/marketplace/{asset_id}/grid/{size}/{uuid}.jpg

**Lifecycle:** purge after 30 days (regenerate on demand).

---

## 🧪 Quarantine (`quarantine`)

**Purpose:** Temporary holding area for antivirus & MIME scanning.

**Paths**

- quarantine/{owner_profile_id}/{attachment_id}/{original_filename}

**Flow**

1. Upload → scan service.
2. Move to `attachments/.../files` if clean.
3. Delete otherwise.

**Lifecycle:** delete after 24 h.

---

## 🔌 Integrations (`integrations`)

**Purpose:** Store plugin-related imports/exports (GitHub, Trello, Notion, etc.).

**Paths**

- integrations/{provider}/{owner_type}-{owner_id}/imports/{yyyy-mm}/{uuid}.json
- integrations/{provider}/{owner_type}-{owner_id}/exports/{yyyy-mm}/{uuid}.json

**RLS:** only connection owner may read/write.

---

## ⚙️ Temporary Files (`tmp`)

**Purpose:** Ad-hoc zips, transcodes, analytics exports.

**Paths**

- tmp/{user_id}/{uuid}.{ext}

**Lifecycle:** auto-delete after 1 h.

---

## 🔐 Cross-Cutting Settings

### Signed URL TTL

Default **60 seconds**; increase selectively for large transfers. :contentReference[oaicite:4]{index=4}

### Metadata (object headers)

| Key                   | Purpose             |
| --------------------- | ------------------- |
| `attachment_id`       | Link back to DB row |
| `owner_profile_id`    | RLS lookup          |
| `sha256`              | Integrity           |
| `mime_type`           | Validation          |
| `uploaded_by_user_id` | Audit trail         |

### Lifecycle Rules

| Path                      | Action | Retention |
| ------------------------- | ------ | --------- |
| `attachments/**/drafts/*` | Delete | 7 days    |
| `tmp/**`                  | Delete | 1 h       |
| `quarantine/**`           | Delete | 24 h      |
| `previews/**`             | Delete | 30 days   |

### Antivirus

Uploads start in `quarantine` → scan → move to destination on success → mark DB row clean.

---

## 🧾 Example Storage Policies (pseudocode)

**attachments**

```sql
CREATE POLICY "attachments_read_own_or_shared"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'attachments' AND (
    EXISTS (
      SELECT 1 FROM org.attachments a
      WHERE a.bucket = 'attachments'
        AND a.path = objects.name
        AND (
          a.owner_profile_id = auth.jwt()->>'active_profile_id'
          OR EXISTS (
            SELECT 1 FROM comms.message_attachments ma
            JOIN comms.channel_files cf ON cf.attachment_id = a.id
            WHERE ma.attachment_id = a.id
              AND project_or_dm_participant(auth.uid())
          )
        )
    )
  )
);

CREATE POLICY "chat_read_participants_only"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'chat' AND user_is_channel_participant(objects.name)
);

CREATE POLICY "marketplace_read_purchased_or_preview"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'marketplace' AND (
    path LIKE 'marketplace/assets/%/previews/%'
    OR EXISTS (
      SELECT 1 FROM marketplace.asset_purchases p
      WHERE path LIKE format('marketplace/assets/%s/%%', p.asset_id)
        AND p.buyer_profile_id = auth.jwt()->>'active_profile_id'
    )
  )
);
```

```

### File: docs\12_RLS.md

```md
# RLS Strategy & Claims Matrix

Projective Supabase RLS Strategy & Claims Matrix\
Last Updated: 28 Oct 2025\
Author: GPT-5 Thinking (Projective Security Spec)

---

## Purpose

We enforce “you only see what you’re currently acting as.”

- A single human user (`auth.users`) can act as:
  - themself
  - their freelancer profile
  - one of their business profiles (“creator” / “client”)
  - a team they’re part of (mini-agency)
- The frontend explicitly switches context and refreshes the JWT.
- The DB never trusts arbitrary row data — it always checks:
  - `auth.uid()` (the Supabase user id)
  - `auth.jwt()->>'active_profile_type'`
  - `auth.jwt()->>'active_profile_id'`
  - `auth.jwt()->>'active_team_id'`

Every table with sensitive data must:

1. Be RLS-enabled.
2. Have policies that assert:\
   “Row is visible only if it’s tied to the caller’s active profile, team, or user.”

This doc is the baseline reference for implementing policies in `/db/policies/**`.

---

## 1. JWT Claims (Session Context)

### Required JWT custom claims

| Claim                 | Example Value                  | Notes                                                             |
| --------------------- | ------------------------------ | ----------------------------------------------------------------- |
| `sub`                 | `"9a7f...uuid"`                | The Supabase `auth.users.id`                                      |
| `active_profile_type` | `"freelancer"` or `"business"` | Explicit role context for this session                            |
| `active_profile_id`   | `"f44c...uuid"`                | The freelancer_profile.id OR business_profile.id you’re acting as |
| `active_team_id`      | `"a12b...uuid"` or `null`      | If you’re acting on behalf of a team / agency                     |

These claims are derived from `security.session_context` for the current `user_id`.\
On profile/team switch, we write a new row (or update) in `security.session_context` then mint a new JWT.

### Access helpers in SQL

- `auth.uid()` → UUID of the logged-in human user.
- `auth.jwt()->>'active_profile_id'` → profile (string) for row scoping.
- `auth.jwt()->>'active_profile_type'` → `"freelancer"` / `"business"`.
- `auth.jwt()->>'active_team_id'` → team (string) for team-scope rules.

We assume helper functions like:

```sql
-- Returns true if the current human user is an active participant in
-- a given project or DM thread (used by comms/chat access).
CREATE OR REPLACE FUNCTION security.project_or_dm_participant(_channel_id uuid)
RETURNS boolean AS $$
  -- implementation detail lives in /db/functions/security.project_or_dm_participant.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;

-- Returns array of all team_ids that are considered valid actors
-- on a given project (for team-based access).
CREATE OR REPLACE FUNCTION security.project_team_ids(_project_id uuid)
RETURNS uuid[] AS $$
  -- implementation detail lives in /db/functions/security.project_team_ids.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

You’ll create/maintain these in `db/functions/`.

---

## 2. Default Policy Templates

These are “starter snippets” we’ll reuse per table.\
All policies should be named clearly (e.g. `pol_projects_projects_owner_select`).

### 2.1 SELECT template

Goal: allow reading rows that belong to the active profile, active team, or self.

```sql
CREATE POLICY "select_visible_rows"
ON <schema>.<table>
FOR SELECT
USING (
  (
    -- direct ownership via profile
    (<table>.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- direct ownership via team
    (<table>.team_id::text = auth.jwt()->>'active_team_id')
    OR
    -- direct ownership via user
    (<table>.user_id = auth.uid())
  )
  OR
  (
    -- project / channel participation (optional, for collab tables)
    security.project_or_dm_participant(<table>.id) = true
  )
);
```

### 2.2 INSERT template

Goal: user can only insert rows “as” their active context.

```sql
CREATE POLICY "insert_as_active_context"
ON <schema>.<table>
FOR INSERT
WITH CHECK (
  (
    -- user is inserting a row for themselves
    (NEW.user_id = auth.uid())
    OR
    -- user is inserting a row for the profile they are currently acting as
    (NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- user is inserting on behalf of team they currently act as
    (NEW.team_id::text = auth.jwt()->>'active_team_id')
  )
);
```

### 2.3 UPDATE template

Goal: cannot update things outside your scope.

```sql
CREATE POLICY "update_owned_rows"
ON <schema>.<table>
FOR UPDATE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
)
WITH CHECK (
  (
    NEW.user_id = auth.uid()
    OR NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR NEW.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

### 2.4 DELETE template

Goal: usually only owners or business “client_business_id” or project owners can delete.

```sql
CREATE POLICY "delete_owned_rows"
ON <schema>.<table>
FOR DELETE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

Note: for some tables (finance.escrows, audit logs, etc.) delete is disabled entirely.

---

## 3. Admin / Service Role Bypass

- Supabase “service_role” key runs queries with `role = service_role`, which ignores RLS.\
  Use this ONLY for:
  - background jobs
  - Stripe webhooks
  - scheduled maintenance
  - internal moderation dashboards

- Admin users (in `ops.admin_users`) still go through RLS at query time unless you explicitly add policies that check admin membership.

Recommended pattern:

```sql
-- Helper: is current user an admin?
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

Then in any table where admins need read access:

```sql
... OR security.is_admin() = true
```

### Restricted tables

- `security.refresh_tokens` (not shown in schema but implied by our auth model)
- `security.session_context`
- `security.audit_logs`

These SHOULD NOT be directly queryable by normal users except in the minimal ways documented below.

---

## 4. Table-by-Table RLS Examples

Below are concrete examples for seven key tables.\
These are examples, not final migrations.\
You’ll drop them in `/db/policies/<schema>/<table>.sql` and adapt columns.

---

### 4.1 `org.users_public`

**Purpose:** public display info per human user.\
Columns: `user_id`, `display_name`, etc.\
Rule:

- Anyone logged-in can `SELECT` any row (public directory-like).
- User can `UPDATE` ONLY their own row.
- Insert happens at onboarding.
- Delete is blocked (soft-delete or anonymize instead).

Enable RLS:

```sql
ALTER TABLE org.users_public ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read: any authenticated user can see public profiles
CREATE POLICY "org_users_public_select_all_auth"
ON org.users_public
FOR SELECT
USING ( auth.uid() IS NOT NULL );

-- Insert: user may create their own entry
CREATE POLICY "org_users_public_insert_self"
ON org.users_public
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

-- Update: user may update only their own row
CREATE POLICY "org_users_public_update_self"
ON org.users_public
FOR UPDATE
USING ( org.users_public.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- Delete: nobody (omit policy, or explicitly deny)
```

Note: If we want moderation/admin edit, extend `USING (...) OR security.is_admin()`.

---

### 4.2 `security.session_context`

**Purpose:** source of truth for the user’s current acting profile/team.\
Columns: `user_id`, `active_profile_type`, `active_profile_id`, `active_team_id`, `updated_at`.

Rules:

- User can read ONLY their own row.
- User can update ONLY their own row.
- No deletes.

Enable RLS:

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read own session context
CREATE POLICY "security_session_context_select_self"
ON security.session_context
FOR SELECT
USING ( security.session_context.user_id = auth.uid() );

-- Insert/Update own context (used on profile/team switch)
CREATE POLICY "security_session_context_upsert_self"
ON security.session_context
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

CREATE POLICY "security_session_context_update_self"
ON security.session_context
FOR UPDATE
USING ( security.session_context.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- No delete policy (effectively blocked for normal users)
```

Note: Background jobs and auth middleware can still overwrite via service_role.

---

### 4.3 `projects.projects`

Relevant columns:

- `id`
- `client_business_id` → `org.business_profiles.id` (the “buyer” / creator)
- (via joins) freelancers, teams, etc. in `projects.project_participants`

Access rules:

- The business profile that owns the project can read/update/delete that project.
- Any freelancer/team added to that project via `project_participants` can also `SELECT`.
- Only the business owner (`client_business_id`) can `UPDATE` or `DELETE`.

We’ll assume helper `projects.is_project_member(projects.id)` which checks:

- `auth.jwt()->>'active_profile_id'` matches a row in `project_participants`
  OR
- the project’s `client_business_id` matches `active_profile_id`
  OR
- current `active_team_id` is in `security.project_team_ids(projects.id)`.

Enable RLS:

```sql
ALTER TABLE projects.projects ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: project members or owning business can view
CREATE POLICY "projects_projects_select_members"
ON projects.projects
FOR SELECT
USING (
  (
    projects.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  EXISTS (
    SELECT 1
    FROM projects.project_participants pp
    WHERE pp.project_id = projects.id
      AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  (
    auth.jwt()->>'active_team_id' IS NOT NULL
    AND auth.jwt()->>'active_team_id' = ANY(
      security.project_team_ids(projects.id)
    )
  )
  OR security.is_admin() = true
);

-- INSERT: only a business profile can create a project,
-- and they can only do it for themselves.
CREATE POLICY "projects_projects_insert_business_owner"
ON projects.projects
FOR INSERT
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
  AND auth.jwt()->>'active_profile_type' = 'business'
);

-- UPDATE: only the owning business can update core project data
CREATE POLICY "projects_projects_update_owner"
ON projects.projects
FOR UPDATE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
)
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
);

-- DELETE: only the owning business can delete (e.g. cancel draft)
CREATE POLICY "projects_projects_delete_owner"
ON projects.projects
FOR DELETE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
);
```

---

### 4.4 `projects.project_stages`

Relevant columns:

- `project_id`
- assignment happens through `projects.stage_assignments`
- different actors (client, assigned freelancer/team) need visibility

Rules:

- Anyone who can see the parent project can `SELECT` its stages.
- UPDATE allowed if:
  - caller is `client_business_id` of parent project, OR
  - caller is the assigned freelancer/team for that stage.

Enable RLS:

```sql
ALTER TABLE projects.project_stages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: you can read a stage if you can read its parent project
CREATE POLICY "project_stages_select_members"
ON projects.project_stages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND (
        p.client_business_id::text = auth.jwt()->>'active_profile_id'
        OR EXISTS (
          SELECT 1
          FROM projects.project_participants pp
          WHERE pp.project_id = p.id
            AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
        )
        OR (
          auth.jwt()->>'active_team_id' IS NOT NULL
          AND auth.jwt()->>'active_team_id' = ANY(
            security.project_team_ids(p.id)
          )
        )
        OR security.is_admin() = true
      )
  )
);

-- INSERT: only project owner (business) can add stages
CREATE POLICY "project_stages_insert_owner"
ON projects.project_stages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = NEW.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
);

-- UPDATE: owner OR assigned freelancer/team
CREATE POLICY "project_stages_update_owner_or_assignee"
ON projects.project_stages
FOR UPDATE
USING (
  -- project owner?
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  -- assigned freelancer?
  EXISTS (
    SELECT 1
    FROM projects.stage_assignments sa
    WHERE sa.project_stage_id = project_stages.id
      AND (
        sa.freelancer_profile_id::text = auth.jwt()->>'active_profile_id'
        OR sa.team_id::text = auth.jwt()->>'active_team_id'
      )
      AND sa.status IN ('accepted','active')
  )
  OR security.is_admin() = true
)
WITH CHECK ( true ); -- we trust USING above for now

-- DELETE: usually disallowed (stages form payment trails), so no policy
```

---

### 4.5 `finance.transactions`

Relevant columns:

- `wallet_id` → belongs to a wallet
- `wallets.owner_type`, `wallets.owner_id`

Rules:

- You can read transactions only if you control the wallet’s owner (your active profile, or your active team, or you’re that business).
- No INSERT/UPDATE/DELETE from clients directly — finance is system-only.

Enable RLS:

```sql
ALTER TABLE finance.transactions ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: wallet owner only
CREATE POLICY "finance_transactions_select_wallet_owner"
ON finance.transactions
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM finance.wallets w
    WHERE w.id = transactions.wallet_id
      AND (
        -- acting profile owns the wallet
        w.owner_id::text = auth.jwt()->>'active_profile_id'
        OR
        -- acting team owns the wallet
        w.owner_id::text = auth.jwt()->>'active_team_id'
      )
  )
  OR security.is_admin() = true
);

-- No INSERT/UPDATE/DELETE policies for normal users
-- (service_role bypasses RLS for ledger writes)
```

---

### 4.6 `org.team_memberships`

Relevant columns:

- `team_id`
- `user_id` (the human account)
- `role`, `status`

Rules:

- A user can read rows if they are in that team.
- Team owner (and maybe `team_lead`) can update membership rows.
- You can’t randomly add yourself to teams you don’t control.

Enable RLS:

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: anyone who is an active member of that same team can view membership
CREATE POLICY "team_memberships_select_team_member"
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin role) can add members
CREATE POLICY "team_memberships_insert_team_owner"
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = NEW.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner or admin-level membership
CREATE POLICY "team_memberships_update_team_owner"
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK ( true );

-- DELETE: team owner (or admin) can remove members
CREATE POLICY "team_memberships_delete_team_owner"
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);
```

This gives team leads power to manage their roster without giving global access.

---

### 4.7 `comms.dm_threads` / `comms.dm_messages`

We’ll show `dm_threads` + `dm_messages` because they’re the cleanest messaging case.\
Core idea applies similarly to `comms.project_channels` and `comms.project_messages` (but those also check project membership).

#### `comms.dm_threads`

Columns:

- `id`
- `created_by_user_id`

Membership comes from `comms.dm_participants (thread_id, user_id)`.

RLS rules:

- You can `SELECT` a thread only if you’re in `dm_participants`.
- You can `INSERT` a new thread if you’re authenticated.
- You can’t `UPDATE` or `DELETE` other people’s threads (no policy).

Enable RLS:

```sql
ALTER TABLE comms.dm_threads ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant
CREATE POLICY "dm_threads_select_participant"
ON comms.dm_threads
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_threads.id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: any logged-in user can create a new DM thread
CREATE POLICY "dm_threads_insert_creator"
ON comms.dm_threads
FOR INSERT
WITH CHECK (
  NEW.created_by_user_id = auth.uid()
);
```

#### `comms.dm_messages`

Columns:

- `thread_id`
- `sender_user_id`
- `body`

RLS rules:

- You can `SELECT` messages in threads you participate in.
- You can `INSERT` only if you’re in that thread and you’re the sender.
- UPDATE/DELETE are disallowed to keep auditability (or can be “soft-delete”).

Enable RLS:

```sql
ALTER TABLE comms.dm_messages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant in the thread
CREATE POLICY "dm_messages_select_participant"
ON comms.dm_messages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_messages.thread_id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: must be participant AND the sender
CREATE POLICY "dm_messages_insert_participant_sender"
ON comms.dm_messages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = NEW.thread_id
      AND dp.user_id = auth.uid()
  )
  AND NEW.sender_user_id = auth.uid()
);
```

For `comms.project_messages`, your `USING` and `WITH CHECK` clauses would mirror logic from `projects.project_stages`, except the join is via `comms.project_channel_participants` instead of `comms.dm_participants`, and the scope is `active_profile_id` / `active_team_id` instead of just `auth.uid()`.

---

## 5. Special Notes & Gotchas

### 5.1 Service Role

- The Supabase “service_role” bypasses ALL RLS.
- Use it strictly in trusted server code (Edge runtime with secret key, cron, Stripe webhooks).
- Never expose service_role to the browser.

### 5.2 `ops.*`, `analytics.*`

- Operational / analytics tables (audit trail, rollups, rate limit counters) should either:
  - be service-role only, OR
  - expose read-only slices via views with stricter policies.

### 5.3 `security.audit_logs`

- Don’t let normal users read the global audit log of other users.
- You MAY allow a user to read back only their own entries for transparency.

Example:

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "audit_logs_select_self_or_admin"
ON security.audit_logs
FOR SELECT
USING (
  security.audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- No insert/update/delete policies for public;
-- logs are written by service_role only.
```

### 5.4 `security.refresh_tokens`

(If you store hashed refresh tokens in DB.)

- NO RLS policies for public.
- Table should be fully private: only service_role inserts/rotates/invalidates refresh tokens.
- Do not expose this table to clients at all. Never query from browser context.

### 5.5 `storage.objects`

- Storage also uses RLS in Supabase.
- You must align `storage.objects` policies with `org.attachments` and channel/project membership.
- Ensure that object path/bucket metadata can be joined back to a profile_id, project_id, channel_id, etc.

You’ll enforce rules like:

- “Attachment belongs to `auth.jwt()->>'active_profile_id'`”
- OR “Attachment is shared in a channel where `auth.uid()` is a participant”
- OR “Attachment is part of a project where active profile/team is a participant”
- Admin override OR service_role.

(See `11_Storage.md` for deeper per-bucket rules.)

---

## 6. Policy Naming, Placement & Conventions

- All policies live in versioned SQL under `db/policies/<schema>/<table>.sql`.
- One table per file.
- Names reflect WHO and WHY, not just CRUD:
  - `pol_projects_projects_owner_select`
  - `pol_projects_project_stages_update_owner_or_assignee`
  - `pol_finance_transactions_select_wallet_owner`
  - `pol_comms_dm_messages_insert_participant_sender`

This avoids mystery and helps audits.

---

## 7. Recap / TL;DR

1. Every authenticated request includes:
   - `auth.uid()`
   - `auth.jwt()->>'active_profile_type'`
   - `auth.jwt()->>'active_profile_id'`
   - `auth.jwt()->>'active_team_id'`

2. All sensitive tables are RLS-enabled.

3. Policies check:
   - Does this row belong to my active profile OR my active team?
   - Am I directly assigned / participating in this project, stage, channel, or thread?
   - Am I the wallet/payee/payer on the money row?
   - Am I the team owner / business owner / freelancer assigned?
   - OR am I an admin (`security.is_admin()`)?
   - Otherwise: no access.

4. Finance tables are read-only for end users, write-only for the system.
5. `security.*` tables are locked down to self or admin, never world-readable.
6. Storage rules mirror DB row ownership + sharing, never public by default.
7. The service_role key bypasses RLS and is only used in trusted server code (Stripe webhooks, cron, moderation tools).

This guarantees isolation between:

- different business profiles owned by the same human,
- freelancers inside and outside teams,
- teams hired by a business,
- and unrelated projects/DMs.

Everything is enforced at the database layer — even if the API layer forgets.

```
```

```

### File: docs\13_FolderStructure.md

```md
# Projective Monorepo — Folder Structure & Naming Conventions

This is a pragmatic structure for a Deno Fresh + Supabase (Postgres + RLS) + Rust WASM project. It keeps the edge app, API routes, database, and infra tidy; is CI-friendly; and scales from MVP to multi-team.

---

## 1) Top-Level Layout

```text
projective/
├─ apps/
│  └─ web/                     # Fresh (Deno) app: UI + API routes
├─ packages/
│  ├─ ui/                      # Shared UI (islands/components, Tailwind, shadcn wrappers)
│  ├─ lib/                     # Isomorphic TS utilities (validators, schema, errors, dates)
│  ├─ sdk/                     # Typed client for calling /api/v1 from browser/edge jobs
│  └─ wasm/                    # Rust crates compiled to WebAssembly
├─ db/
│  ├─ migrations/              # SQL migrations (idempotent, forward-only)
│  ├─ seeds/                   # Non-essential seed data
│  ├─ policies/                # RLS policies split by schema/table
│  ├─ functions/               # SQL & plpgsql functions (e.g., auth helpers)
│  ├─ views/                   # Views/materialized views
│  └─ scripts/                 # Local helpers (dump/restore, diff)
├─ supabase/
│  ├─ config/                  # Supabase CLI config, access roles
│  ├─ storage-rules/           # Storage (policy) snippets per bucket
│  └─ edge-functions/          # (Optional) Supabase Edge Functions
├─ infra/
│  ├─ deno/                    # Deno Deploy or self-host manifests
│  ├─ cf/                      # Cloudflare Turnstile or Workers (if used)
│  ├─ stripe/                  # Webhook fixtures & CLI scripts
│  └─ github/                  # GitHub Actions workflows
├─ docs/
│  ├─ architecture/            # ADRs, diagrams
│  ├─ api/                     # OpenAPI (generated), endpoint docs
│  └─ product/                 # Feature specs, user flows
├─ scripts/                    # Cross-repo task runners (deno task aliases)
├─ .env.example                # Example env config (never commit real secrets)
├─ deno.json                   # Deno config (tasks, import map, lint)
├─ import_map.json             # Bare module specifiers mapping
├─ README.md
└─ LICENSE
```

---

## 2) `apps/web` (Fresh App) Structure

```text

apps/web/
├─ routes/                     # Fresh routes: pages + API endpoints
│  ├─ (public)/                # Authless pages (marketing, landing)
│  ├─ (auth)/                  # /login, /signup
│  ├─ (dashboard)/             # Authenticated areas
│  ├─ api/                     # Fresh API routes (edge)
│  │  └─ v1/                   # /api/v1/*
│  │     ├─ auth/
│  │     ├─ users/
│  │     ├─ freelancers/
│  │     ├─ businesses/
│  │     ├─ teams/
│  │     ├─ projects/
│  │     ├─ stages/
│  │     ├─ dms/
│  │     ├─ templates/
│  │     ├─ finance/
│  │     ├─ marketplace/
│  │     ├─ search/
│  │     └─ meta/
│  └─ _app.tsx                 # App shell
├─ islands/                    # Preact interactive islands
├─ components/                 # Presentational components
├─ features/                   # Feature slices (screens, hooks, services)
│  ├─ auth/
│  ├─ account-switcher/
│  ├─ team-selector/
│  ├─ messaging/
│  ├─ projects/
│  ├─ marketplace/
│  └─ templates/
├─ server/                     # Server-side helpers (KV, cookies, auth)
│  ├─ auth/
│  ├─ kv/
│  └─ middleware/
├─ services/                   # API integrations (Supabase client, Stripe, Turnstile)
├─ styles/                     # Tailwind CSS, global styles
├─ types/                      # App-level TypeScript types
├─ tests/                      # e2e/integration tests (deno test)
└─ static/                     # Assets served as static files
```

**API route filenames** mirror endpoint paths. Example:

- `/api/v1/projects/[id].ts` → `GET, PATCH, DELETE` handlers
- `/api/v1/stages/[stageId]/approve.ts` → action endpoints  
  Keep one file per resource or action for discoverability.

---

## 3) `packages` (Shared Code)

```text

packages/ui/                   # Reusable UI (Tailwind + shadcn)
packages/lib/                  # Pure TS: zod schemas, errors, utils
packages/sdk/                  # Typed fetchers for /api/v1 (request/response types)
packages/wasm/
└─ image_ops/                  # Rust crate compiled to wasm (wasm-bindgen)
```

**Naming**

- Packages: `kebab-case`.
- Exports: prefer named exports; default export only for React components.
- WASM crates: `snake_case` (Rust convention); built artifacts published to `packages/wasm/<crate>/dist/`.

---

## 4) Database Files (`/db`)

```text

db/
├─ migrations/
│  ├─ 0001_init_schemas.sql
│  ├─ 0002_org_tables.sql
│  ├─ 0003_projects_tables.sql
│  ├─ 0004_comms_tables.sql
│  ├─ 0005_finance_tables.sql
│  ├─ 0006_marketplace_tables.sql
│  ├─ 0007_search_templates.sql
│  ├─ 0008_indexes_constraints.sql
│  ├─ 0009_rls_enable.sql
│  └─ 0010_policies_batch_1.sql
├─ policies/
│  ├─ org/
│  │  ├─ freelancer_profiles.sql
│  │  ├─ business_profiles.sql
│  │  ├─ team_memberships.sql
│  │  └─ attachments.sql
│  ├─ projects/
│  ├─ comms/
│  ├─ finance/
│  ├─ marketplace/
│  └─ storage/
├─ functions/
│  ├─ auth/
│  │  └─ project_or_dm_participant.sql
│  └─ helpers/
│     └─ project_team_ids.sql
├─ views/
│  └─ analytics/
│     ├─ earnings_by_stage_mv.sql
│     └─ refresh_earnings_by_stage.sql
├─ seeds/
│  ├─ 100_skills.sql
│  └─ demo_users.sql
└─ scripts/
   ├─ dump.sh
   ├─ restore.sh
   └─ diff.sh
```

**Migration naming**: `NNNN_descriptive_snake_case.sql` (monotonic, forward-only).  
**Policy files**: one table per file, named exactly as `<schema>/<table>.sql`.  
**Functions/Views**: 1 file per function/view; name equals the function/view.

---

## 5) Supabase Storage Conventions

**Buckets** (all lowercase, singular): `avatars`, `attachments`, `chat`, `project`, `marketplace`, `previews`, `quarantine`, `integrations`, `tmp`.

**Object path format** (use stable IDs, never user-provided names in path segments):

- `avatars/users/{user_id}/{uuid}.{ext}`
- `attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}`
- `project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}`
- `marketplace/assets/{asset_id}/versions/{version_id}/{filename}`

**Naming**: folder segments `snake_case`, files keep original name sanitized to `kebab-case.ext`.

---

## 6) Code & File Naming Conventions

### 6.1 General

- Directories: `kebab-case`
- Files: `kebab-case`
- TypeScript types: `PascalCase` (`UserProfile`, `ProjectStage`)
- Functions/variables: `camelCase`
- Constants: `UPPER_SNAKE_CASE`
- Enums (TS): `PascalCase` enum + `SCREAMING_SNAKE_CASE` members if numeric; otherwise `camelCase` string unions.

### 6.2 UI & Components

- Components: `PascalCase` files with `.tsx` (`AccountSwitcher.tsx`)
- Hooks: `use-*.ts` (`use-active-profile.ts`)
- Cons: `*-con.ts` (`session-con.ts`)
- Islands: end with `.island.tsx` when needed (`AccountSwitcher.island.tsx`)

### 6.3 API Routes (Fresh)

- Resource handlers in `/api/v1/...` named like the path:
  - `/api/v1/projects/[id].ts` (export `GET`, `PATCH`, `DELETE`)
  - `/api/v1/stages/[stageId]/approve.ts` (export `POST`)
- Do not suffix with `controller` or `handler`; the route file **is** the handler.

### 6.4 Services & Integrations

- Service modules: `*-service.ts` (`stripe-service.ts`, `supabase-service.ts`)
- Repositories (DB access wrappers when needed): `*-repo.ts`
- Validation schemas (zod): `*-schema.ts` (`project-schema.ts`)

### 6.5 Tests

- Unit tests: colocate as `*.test.ts` next to source.
- Integration/e2e: `apps/web/tests/*.test.ts` with helpers under `tests/_helpers/`.

---

## 7) Database Naming Conventions

- Schemas: `security`, `org`, `projects`, `comms`, `finance`, `marketplace`, `search`, `ops`, `analytics`, `integrations`.
- Tables: **`snake_case` plural** (`freelancer_profiles`, `project_stages`).
- Columns: `snake_case`. Primary keys named `id` (uuid). Foreign keys reference `<table>.<id>`.
- Enums: `snake_case` values (`draft`, `in_progress`), type names `snake_case`.
- Indexes: `idx_<table>_<col1>[_<col2>]` (e.g., `idx_project_stages_project_id_order`)
- Constraints: `chk_<table>_<column>`, `uq_<table>_<column(s)>`, `fk_<table>_<ref>`
- Policies: `pol_<schema>_<table>_<purpose>` (`pol_projects_projects_owner_access`)
- Triggers: `trg_<table>_<action>` (`trg_stage_submissions_set_timestamp`)
- Functions: `schema.fn_name(argtypes)` with file `schema/fn_name.sql`

**Do not** embed business meaning in primary keys; always use UUIDs.

---

## 8) RLS Policy Organization

- Enable RLS in a single migration early (`0009_rls_enable.sql`).
- One policy file per table in `db/policies/<schema>/<table>.sql`.
- Policy names reflect **who** and **why**:  
  `pol_project_messages_channel_participant_select`,  
  `pol_wallets_owner_select`,  
  `pol_attachments_owner_or_shared_select`.

---

## 9) Env Vars & Secrets

**Naming**: `UPPER_SNAKE_CASE`.  
**Prefixes**:

- Public (exposed to client): `PUBLIC_` (e.g., `PUBLIC_TURNSTILE_SITE_KEY`)
- Server-only: no `PUBLIC_` (e.g., `SUPABASE_SERVICE_ROLE_KEY`, `STRIPE_SECRET_KEY`)

**Files**:

- `.env.example` committed; `.env` ignored.
- For Deno Deploy: use project secrets UI; mirror keys from `.env.example`.

---

## 10) Commit, Branch & PR Conventions

- Branches: `type/short-description`
  - Types: `feat`, `fix`, `chore`, `docs`, `refactor`, `perf`, `test`
  - Example: `feat/account-switcher`, `fix/rls-attachments`
- Commits (Conventional Commits):
  - `feat(projects): add stage approval endpoint`
  - `fix(rls): allow team participants to read channel files`
- PR titles mirror first commit; include “**Scope**” and “**Testing**” sections in description.

---

## 11) Linting, Formatting, and Tasks

- Use Deno’s built-in: `deno lint`, `deno fmt`.
- `deno.json` tasks (examples):

```text json
{
  "tasks": {
    "dev": "deno task -q _dev",
    "_dev": "deno run -A --watch=routes,islands,components main.ts",
    "test": "deno test -A --fail-fast",
    "lint": "deno lint",
    "fmt": "deno fmt",
    "db:migrate": "supabase db reset --db-url $SUPABASE_DB_URL",
    "db:diff": "supabase db diff --linked",
    "typecheck": "deno check apps/web/routes/_app.tsx"
  }
}
```

---

## 12) Error Handling & Response Shapes

- Error objects: `{ error: { code: string, message: string, details?: unknown } }`
- Codes: `auth.invalid_token`, `auth.forbidden`, `validation.failed`, `resource.not_found`, `rate.limit_exceeded`
- Never leak internal stack traces to clients.

---

## 13) API Response & File Naming

- JSON fields: `snake_case` or `camelCase`? **Pick one and stick to it.**  
  For Deno + TS frontends, prefer **camelCase in JSON** (DX), keep **snake_case in DB**.
- Download filenames: `kebab-case` + semantic suffixes (`project-export-2025-10-18.zip`).

---

## 14) Logging, Metrics, and Audit

- App logs: `server/logger.ts` with levels `debug|info|warn|error`.
- Audit logs table: `security.audit_logs`.
- Structured log keys: `timestamp`, `level`, `message`, `con` (request id, user id, profile id).

---

## 15) Testing Conventions

- Unit: colocated `*.test.ts`.
- API integration: `apps/web/tests/api/*.test.ts` hitting `/api/v1` with mocked auth.
- DB invariants: SQL assertions in migration follow-ups (e.g., check policies compile).

---

## 16) Example File Names (Grab-bag)

- Component: `apps/web/components/avatar-uploader.tsx`
- Island: `apps/web/islands/account-switcher.island.tsx`
- Hook: `apps/web/features/auth/use-session.ts`
- Route: `apps/web/routes/api/v1/stages/[stageId]/approve.ts`
- Service: `apps/web/services/turnstile-service.ts`
- Policy file: `db/policies/org/attachments.sql`
- Function file: `db/functions/auth/project_or_dm_participant.sql`
- View file: `db/views/analytics/earnings_by_stage_mv.sql`

---

## 17) CI/CD (GitHub Actions)

```text
yaml
name: ci
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with: { deno-version: v1.x }
      - run: deno fmt --check
      - run: deno lint
      - run: deno test -A
```

Deploy workflows live under `infra/github/`. Separate jobs for `preview` and `production`.

---

## 18) Accessibility & i18n

- Components accept `aria-*` props; follow WAI-ARIA roles.
- Strings centralized in `packages/lib/i18n/` (lazy-loaded dictionaries).

---

## 19) Security Defaults

- CSP in middleware: default-deny; allow self + asset CDN; disallow inline except hashed.
- Cookies: `Secure; HttpOnly; SameSite=Lax`.
- JWT: short-lived access; opaque refresh rotated; store refresh in HttpOnly cookie.
- Turnstile for anonymous POST endpoints.
- Signed URLs (60s TTL) for Storage downloads.

---

## 20) Documentation

- API contracts in `docs/api/` (OpenAPI generated from handlers or typed definitions).
- Architecture Decision Records in `docs/architecture/adr-XXXX-title.md` (YYYY-MM-DD).
- Product docs in `docs/product/` (features, user stories, flows).

---

## 21) Versioning & Releases

- Tag format: `vMAJOR.MINOR.PATCH` (e.g., `v0.7.3`).
- Changelog: `docs/CHANGELOG.md` using Keep a Changelog syntax.
- Database: bump with each migration; record in `db/migrations/` and `docs/CHANGELOG.md`.

---

### TL;DR Defaults

- **Directories & files**: `kebab-case`.
- **DB**: schemas/tables/cols `snake_case` plural tables.
- **TS**: `camelCase` for code & JSON; `PascalCase` for types/components.
- **Migrations**: `NNNN_description.sql` (forward-only).
- **Routes**: path-mirrored filenames under `/api/v1`.
- **Policies/Functions/Views**: one object per file, name = object.
- **Env**: `PUBLIC_` for client-exposed, everything else server-only.

This scaffolding + naming playbook prevents bikeshedding and keeps velocity high as the codebase grows.

```

### File: docs\14_Sitemap.md

```md
# 🗺️ Projective – Routes & Sitemap (Freelancers, Creators, Teams)

> Tech: **Deno Fresh 2.x**  
> Conventions:  
> - **Route Groups**: `(group-name)/` — folder name does **not** appear in the URL.  
> - **Slug**: `[param]`  
> - **Catch-all**: `[...path]`  
> - **Regex / Constraints**: put a `matchers.ts` next to the route to validate params (see examples).  
> - Auth-gated areas live under `(dashboard)/…` with a shared `_middleware.ts`.

---

## 🌍 Public

| URL Path | Page | Route File (apps/web/routes) | Notes |
|---|---|---|---|
| `/` | Home | `(public)/index.tsx` | Marketing landing |
| `/about` | About | `(public)/about.tsx` |  |
| `/explore` | Explore / Search | `(public)/explore/index.tsx` | Unified search hub |
| `/categories` | Categories | `(public)/categories/index.tsx` | List all |
| `/categories/[slug]` | Category detail | `(public)/categories/[slug].tsx` | **Matcher**: `slug=/^[a-z0-9-]+$/` |
| `/freelancers/[handle]` | Public freelancer profile | `(public)/freelancers/[handle].tsx` | **Matcher**: `handle=/^[a-z0-9_-]{3,32}$/` |
| `/teams/[slug]` | Public team profile | `(public)/teams/[slug].tsx` | Slug constrained via matcher |
| `/articles` | Articles directory | `(public)/articles/index.tsx` |  |
| `/templates` | Templates directory | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Template detail | `(public)/templates/[id].tsx` | UUID matcher |
| `/assets` | Marketplace (future) | `(public)/marketplace/index.tsx` |  |
| `/assets/[id]` | Asset page (future) | `(public)/marketplace/[id].tsx` | UUID matcher |
| `/pricing` | Pricing (future) | `(public)/pricing.tsx` |  |
| `/help` | Help / Support | `(public)/help/index.tsx` |  |
| `/help/[...path]` | Help article catch-all | `(public)/help/[...path].tsx` | MD/MDX renderer |
| `/terms` | Terms | `(public)/legal/terms.tsx` |  |
| `/privacy` | Privacy | `(public)/legal/privacy.tsx` |  |

---

## 🔐 Auth & Account

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/login` | Login | `(auth)/login.tsx` |  |
| `/signup` | Signup | `(auth)/signup.tsx` |  |
| `/auth/verify/[token]` | Email verify | `(auth)/verify/[token].tsx` | **Matcher**: base64/uuid |
| `/auth/forgot-password` | Forgot | `(auth)/forgot-password.tsx` |  |
| `/auth/reset/[token]` | Reset | `(auth)/reset/[token].tsx` |  |
| `/setup` | Choose role | `(auth)/setup/index.tsx` |  |
| `/setup/freelancer` | Freelancer setup | `(auth)/setup/freelancer.tsx` |  |
| `/setup/creator` | Creator setup | `(auth)/setup/creator.tsx` |  |
| `/account` | User account (global) | `(dashboard)/account/index.tsx` | Security, profiles, emails, 2FA |
| `/switch-account` | Account switcher | `(dashboard)/switch-account.tsx` | Updates session context |

> `(dashboard)/_middleware.ts` enforces auth + injects session context (`active_profile_id`, `active_team_id`).

---

## 🧑‍🎨 Freelancer

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/freelancer` | Redirect → dashboard | `(dashboard)/freelancer/index.tsx` |  |
| `/freelancer/dashboard` | Overview | `(dashboard)/freelancer/dashboard.tsx` |  |
| `/freelancer/projects` | My projects | `(dashboard)/freelancer/projects/index.tsx` |  |
| `/freelancer/projects/[id]` | Project workspace | `(dashboard)/freelancer/projects/[id]/index.tsx` | UUID |
| `/freelancer/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/freelancer/projects/[id]/stage/[stageId].tsx` | UUIDs |
| `/freelancer/messages` | Inbox | `(dashboard)/freelancer/messages/index.tsx` |  |
| `/freelancer/messages/[threadId]` | Thread | `(dashboard)/freelancer/messages/[threadId].tsx` |  |
| `/freelancer/teams` | Teams list | `(dashboard)/freelancer/teams/index.tsx` |  |
| `/freelancer/teams/create` | Create team | `(dashboard)/freelancer/teams/create.tsx` |  |
| `/freelancer/teams/[teamId]` | Team dashboard | `(dashboard)/freelancer/teams/[teamId]/index.tsx` | UUID |
| `/freelancer/teams/[teamId]/members` | Manage members | `(dashboard)/freelancer/teams/[teamId]/members.tsx` |  |
| `/freelancer/profile` | Edit profile | `(dashboard)/freelancer/profile/index.tsx` |  |
| `/freelancer/portfolio/new` | Add portfolio item | `(dashboard)/freelancer/portfolio/new.tsx` |  |
| `/freelancer/earnings` | Wallet & payouts | `(dashboard)/freelancer/earnings.tsx` |  |
| `/freelancer/notifications` | Notifications | `(dashboard)/freelancer/notifications.tsx` |  |
| `/freelancer/settings` | Settings | `(dashboard)/freelancer/settings.tsx` |  |

---

## 🧑‍🤝‍🧑 Teams (shared)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/teams/[teamId]` | Team dashboard | `(dashboard)/teams/[teamId]/index.tsx` |  |
| `/teams/[teamId]/projects` | Team projects | `(dashboard)/teams/[teamId]/projects/index.tsx` |  |
| `/teams/[teamId]/projects/[projectId]` | Team project | `(dashboard)/teams/[teamId]/projects/[projectId]/index.tsx` |  |
| `/teams/[teamId]/members` | Members | `(dashboard)/teams/[teamId]/members.tsx` |  |
| `/teams/[teamId]/settings` | Settings | `(dashboard)/teams/[teamId]/settings.tsx` |  |
| `/teams/[teamId]/analytics` | Analytics (future) | `(dashboard)/teams/[teamId]/analytics.tsx` |  |

---

## ✨ Creator (formerly Business)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/creator` | Redirect → dashboard | `(dashboard)/creator/index.tsx` |  |
| `/creator/dashboard` | Overview | `(dashboard)/creator/dashboard.tsx` |  |
| `/creator/projects` | All projects | `(dashboard)/creator/projects/index.tsx` |  |
| `/creator/projects/new` | New project | `(dashboard)/creator/projects/new.tsx` |  |
| `/creator/projects/new/template` | Guided creation | `(dashboard)/creator/projects/new-template.tsx` |  |
| `/creator/projects/[id]` | Project overview | `(dashboard)/creator/projects/[id]/index.tsx` |  |
| `/creator/projects/[id]/stage/[stageId]` | Stage view | `(dashboard)/creator/projects/[id]/stage/[stageId].tsx` |  |
| `/creator/messages` | Inbox | `(dashboard)/creator/messages/index.tsx` |  |
| `/creator/messages/[threadId]` | Thread | `(dashboard)/creator/messages/[threadId].tsx` |  |
| `/creator/wallet` | Payments & invoices | `(dashboard)/creator/wallet.tsx` |  |
| `/creator/settings` | Creator profile & billing | `(dashboard)/creator/settings.tsx` |  |
| `/creator/notifications` | Notifications | `(dashboard)/creator/notifications.tsx` |  |

---

## 🧱 Project Workspace (URL-based, role-agnostic)

These mirror deep-links that both roles can use; they live under `(dashboard)/projects` to keep logic centralized. Your role decides what controls render.

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/projects/[id]` | Project dashboard | `(dashboard)/projects/[id]/index.tsx` |  |
| `/projects/[id]/stages` | Stages list | `(dashboard)/projects/[id]/stages.tsx` |  |
| `/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/projects/[id]/stage/[stageId].tsx` |  |
| `/projects/[id]/chat` | Project chat (general) | `(dashboard)/projects/[id]/chat/index.tsx` |  |
| `/projects/[id]/chat/[channelId]` | Channel view | `(dashboard)/projects/[id]/chat/[channelId].tsx` |  |
| `/projects/[id]/files` | File gallery | `(dashboard)/projects/[id]/files.tsx` |  |
| `/projects/[id]/activity` | Activity feed | `(dashboard)/projects/[id]/activity.tsx` |  |

---

## 💬 Global Messaging & Notifications

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/messages` | Unified inbox | `(dashboard)/(comms)/messages/index.tsx` | Combines DMs + project threads |
| `/messages/[threadId]` | DM / group thread | `(dashboard)/(comms)/messages/[threadId].tsx` |  |
| `/notifications` | Notification center | `(dashboard)/(comms)/notifications.tsx` |  |

---

## 🧩 Templates (creator & freelancer)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/templates` | Browse (public) | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Detail (public) | `(public)/templates/[id].tsx` |  |
| `/dashboard/templates` | My templates | `(dashboard)/dashboard/templates/index.tsx` | owner view |
| `/dashboard/templates/create` | Create template | `(dashboard)/dashboard/templates/create.tsx` |  |
| `/dashboard/templates/[id]/edit` | Edit template | `(dashboard)/dashboard/templates/[id]/edit.tsx` |  |

---

## Articles (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/articles` | Browse (public) | `(public)/articles/index.tsx` |  |
| `/articles/[id]` | Detail (public) | `(public)/articles/[id].tsx` |  |
| `/dashboard/articles` | My article | `(dashboard)/dashboard/articles/index.tsx` | owner view |
| `/dashboard/articles/create` | Create article | `(dashboard)/dashboard/articles/create.tsx` |  |
| `/dashboard/articles/[id]/edit` | Edit article | `(dashboard)/dashboard/articles/[id]/edit.tsx` |  |

---

## 🛍️ Marketplace (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/marketplace` | Catalog | `(public)/marketplace/index.tsx` |  |
| `/marketplace/[id]` | Asset | `(public)/marketplace/[id].tsx` |  |
| `/dashboard/marketplace/upload` | Upload asset | `(dashboard)/dashboard/marketplace/upload.tsx` |  |
| `/dashboard/marketplace/sales` | My sales | `(dashboard)/dashboard/marketplace/sales.tsx` |  |
| `/dashboard/marketplace/purchases` | My purchases | `(dashboard)/dashboard/marketplace/purchases.tsx` |  |

---

## 💰 Finance

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/wallet` | Wallet overview | `(dashboard)/finance/wallet/index.tsx` | Context-aware (profile/team) |
| `/transactions` | Transactions | `(dashboard)/finance/transactions.tsx` |  |
| `/invoices` | Invoices | `(dashboard)/finance/invoices/index.tsx` |  |
| `/invoices/[id]` | Invoice detail | `(dashboard)/finance/invoices/[id].tsx` |  |
| `/disputes` | Disputes | `(dashboard)/finance/disputes/index.tsx` |  |
| `/ratings` | Ratings & reviews | `(dashboard)/finance/ratings.tsx` |  |
| `/subscription` | Subscription (future) | `(dashboard)/finance/subscription.tsx` | Promoted listings mgmt later |

---

## 📊 Analytics (later)

| URL Path | Page | Route File |
|---|---|---|
| `/analytics/freelancer` | Freelancer insights | `(dashboard)/analytics/freelancer.tsx` |
| `/analytics/creator` | Creator insights | `(dashboard)/analytics/creator.tsx` |
| `/analytics/team` | Team insights | `(dashboard)/analytics/team.tsx` |

---

## ⚙️ Admin (internal)

| URL Path | Page | Route File |
|---|---|---|
| `/admin` | Dashboard | `(dashboard)/admin/index.tsx` |
| `/admin/users` | Users | `(dashboard)/admin/users.tsx` |
| `/admin/projects` | Projects | `(dashboard)/admin/projects.tsx` |
| `/admin/flags` | Moderation flags | `(dashboard)/admin/flags.tsx` |
| `/admin/emails` | Email queue | `(dashboard)/admin/emails.tsx` |
| `/admin/webhooks` | Webhooks | `(dashboard)/admin/webhooks.tsx` |
| `/admin/feature-flags` | Feature flags | `(dashboard)/admin/feature-flags.tsx` |

---

## 🔧 Matchers (Regex) — Examples

Create a `matchers.ts` next to any dynamic route to constrain params:

```ts
// apps/web/routes/(public)/freelancers/[handle].tsx
export const match = { handle: /^[a-z0-9_-]{3,32}$/i };

// apps/web/routes/(public)/templates/[id].tsx
export const match = { id: /^[0-9a-f-]{36}$/i }; // UUID v4 relaxed

// apps/web/routes/(dashboard)/projects/[id]/stage/[stageId].tsx
export const match = {
  id: /^[0-9a-f-]{36}$/i,
  stageId: /^[0-9a-f-]{36}$/i,
};
```

```text
apps/web/routes/
├─ (public)/
│  ├─ index.tsx
│  ├─ about.tsx
│  ├─ explore/index.tsx
│  ├─ categories/[slug].tsx
│  ├─ freelancers/[handle].tsx
│  ├─ teams/[slug].tsx
│  ├─ templates/[id].tsx
│  ├─ marketplace/[id].tsx
│  └─ help/[...path].tsx
├─ (auth)/
│  ├─ login.tsx
│  ├─ signup.tsx
│  ├─ verify/[token].tsx
│  ├─ forgot-password.tsx
│  ├─ reset/[token].tsx
│  └─ onboarding/{index.tsx, freelancer.tsx, creator.tsx}
├─ (dashboard)/
│  ├─ _middleware.ts
│  ├─ account/index.tsx
│  ├─ switch-account.tsx
│  ├─ freelancer/…
│  ├─ creator/…
│  ├─ teams/…
│  ├─ projects/…
│  ├─ comms/…
│  ├─ templates/…
│  ├─ finance/…
│  ├─ analytics/…
│  ├─ admin/…
│  └─ account/…
└─ _app.tsx
```
```

### File: packages\ui\utils\ThemeSwitcher.ts

```ts
import { effect, signal } from '@preact/signals';

export const theme = signal<'light' | 'dark'>('dark');

if (typeof window !== 'undefined') {
	const saved = localStorage.getItem('theme');
	if (saved === 'light' || saved === 'dark') theme.value = saved;

	effect(() => {
		document.documentElement.setAttribute('data-theme', theme.value);
		try {
			localStorage.setItem('theme', theme.value);
		} catch {
			//
		}
	});
}

```

### File: packages\utils\auth\register.ts

```ts
import { escape } from '@std/regexp/escape';

export type RegisterFields = {
	email: string;
	password: string;
	confirmPassword: string;
};

export type RegisterErrors = {
	email?: string;
	password?: string;
	confirmPassword?: string;
};

export default class RegisterWithEmail {
	// --- email validation ---
	static validateEmail(email: string): string | null {
		const trimmed = email.trim();

		if (!trimmed) {
			return 'Email is required.';
		}

		const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

		if (!emailPattern.test(trimmed)) {
			return 'Enter a valid email address.';
		}

		return null;
	}

	// --- password validation ---
	static validatePassword(password: string, email?: string): string | null {
		if (!password) {
			return 'Password is required.';
		}

		if (!/[a-z]/.test(password)) {
			return 'Password must contain at least one lowercase letter.';
		}

		if (!/[A-Z]/.test(password)) {
			return 'Password must contain at least one uppercase letter.';
		}

		if (!/[0-9]/.test(password)) {
			return 'Password must contain at least one digit.';
		}

		if (!/[^A-Za-z0-9]/.test(password)) {
			return 'Password must contain at least one symbol.';
		}

		if (/\s/.test(password)) {
			return 'Password must not contain spaces.';
		}

		if (password.length < 8) {
			return 'Password must be at least 8 characters long.';
		}

		if (email) {
			const trimmedEmail = email.trim();
			if (trimmedEmail) {
				const escapedEmail = escape(trimmedEmail);
				const emailInPassword = new RegExp(escapedEmail, 'i');

				if (emailInPassword.test(password)) {
					return 'Password must not contain your email.';
				}
			}
		}

		return null;
	}

	// --- confirm password validation ---
	static validateConfirmPassword(
		password: string,
		confirmPassword: string,
	): string | null {
		if (!confirmPassword) {
			return 'Please confirm your password.';
		}

		if (password !== confirmPassword) {
			return 'Passwords do not match.';
		}

		return null;
	}

	// --- full validation entrypoint ---
	static validate(
		fields: RegisterFields,
	): { ok: boolean; errors: RegisterErrors } {
		const errors: RegisterErrors = {};

		const emailError = this.validateEmail(fields.email);
		if (emailError) errors.email = emailError;

		const passwordError = this.validatePassword(
			fields.password,
			fields.email,
		);
		if (passwordError) errors.password = passwordError;

		const confirmError = this.validateConfirmPassword(
			fields.password,
			fields.confirmPassword,
		);
		if (confirmError) errors.confirmPassword = confirmError;

		const ok = Object.keys(errors).length === 0;

		return { ok, errors };
	}
}

```

### File: packages\utils\server\cookies.ts

```ts

```

### File: packages\utils\server\crypto.ts

```ts
// packages/server-utils/crypto.ts

// Generate URL-safe random string (base64-ish) for refresh tokens
export function randomTokenString(byteLength = 32): string {
	const raw = crypto.getRandomValues(new Uint8Array(byteLength));
	// convert Uint8Array -> binary string -> base64
	const bin = String.fromCharCode(...raw);
	return btoa(bin); // you can further make it URL-safe if you want
}

// TODO: replace with real Argon2id
export async function hashArgon2id(value: string): Promise<string> {
	// WARNING: placeholder.
	// You MUST replace this with a secure Argon2id hash implementation
	// before production. We're returning a SHA-256 for now just so dev works.
	const data = new TextEncoder().encode(value);
	const digest = await crypto.subtle.digest('SHA-256', data);
	const bytes = new Uint8Array(digest);
	return Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
}

```

### File: packages\utils\server\env.ts

```ts
function requireEnv(name: string): string {
	const value = Deno.env.get(name);
	if (!value) {
		throw new Error(`Missing required env var: ${name}`);
	}
	return value;
}

export const ENV = {
	SUPABASE_URL: requireEnv('SUPABASE_URL'),
	SUPABASE_SERVICE_ROLE_KEY: requireEnv('SUPABASE_SERVICE_ROLE_KEY'),
	JWT_SECRET: requireEnv('JWT_SECRET'),
};

```

### File: packages\utils\server\index.ts

```ts
// packages/server-utils/index.ts

export { ENV } from './env.ts';
export { rateLimitByIP } from './rateLimiter.ts';
export {
	buildAccessCookie,
	buildRefreshCookie,
	mintAccessToken,
	mintRefreshToken,
	type SessionClaims,
} from './token.ts';
export { hashArgon2id, randomTokenString } from './crypto.ts';

```

### File: packages\utils\server\jwt.ts

```ts
import { ENV } from './env.ts';

// packages/server-utils/jwt.ts
let _jwtKey: CryptoKey | null = null;

export async function getJwtKey(): Promise<CryptoKey> {
	if (_jwtKey) return _jwtKey;

	// ENV.JWT_SECRET is a string. We have to turn it into bytes for importKey.
	const raw = new TextEncoder().encode(ENV.JWT_SECRET);

	_jwtKey = await crypto.subtle.importKey(
		'raw',
		raw,
		{ name: 'HMAC', hash: 'SHA-256' },
		false,
		['sign', 'verify'],
	);

	return _jwtKey;
}

```

### File: packages\utils\server\rateLimiter.ts

```ts
// packages/server-utils/rateLimiter.ts

type BucketInfo = {
	count: number;
	resetAt: number; // ms timestamp
};

// naive in-memory store (resets on server restart)
const buckets = new Map<string, BucketInfo>();

export function rateLimitByIP(ip: string, limit = 20, windowMs = 60_000) {
	const now = Date.now();
	const bucket = buckets.get(ip);

	if (!bucket || now > bucket.resetAt) {
		// start/reset bucket
		buckets.set(ip, {
			count: 1,
			resetAt: now + windowMs,
		});
		return { allowed: true, remaining: limit - 1 };
	}

	if (bucket.count >= limit) {
		return { allowed: false, remaining: 0 };
	}

	bucket.count += 1;
	return { allowed: true, remaining: limit - bucket.count };
}

```

### File: packages\utils\server\token.ts

```ts
import { create } from 'djwt';
import { hashArgon2id, randomTokenString } from './crypto.ts';
import { getJwtKey } from './jwt.ts'; // <-- new

const ACCESS_TTL_SECONDS = 15 * 60; // 15 minutes
const REFRESH_TTL_SECONDS = 60 * 60 * 24 * 30; // ~30 days

export type SessionClaims = {
	userId: string;
	activeProfileType: 'freelancer' | 'business' | null;
	activeProfileId: string | null;
	activeTeamId: string | null;
};

export async function mintAccessToken(claims: SessionClaims) {
	const exp = Math.floor(Date.now() / 1000) + ACCESS_TTL_SECONDS;

	const payload = {
		sub: claims.userId,
		active_profile_type: claims.activeProfileType,
		active_profile_id: claims.activeProfileId,
		active_team_id: claims.activeTeamId,
		exp,
	};

	const key = await getJwtKey();

	const token = await create(
		{ alg: 'HS256', typ: 'JWT' },
		payload,
		key,
	);

	return { token, exp };
}

/**
 * Creates a new refresh token (opaque random string),
 * hashes it, and returns both the plaintext token (for cookie)
 * and the hash (for DB storage).
 */
export async function mintRefreshToken() {
	const plaintext = randomTokenString(32);
	const hash = await hashArgon2id(plaintext);
	const exp = Math.floor(Date.now() / 1000) + REFRESH_TTL_SECONDS;
	return { plaintext, hash, exp };
}

export function buildAccessCookie(accessToken: string, maxAgeSeconds = ACCESS_TTL_SECONDS) {
	return [
		'access_token=',
		accessToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		`; Max-Age=${maxAgeSeconds}`,
		'; Path=/',
	].join('');
}

export function buildRefreshCookie(refreshToken: string) {
	return [
		'refresh_token=',
		refreshToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		'; Path=/api/v1/auth',
	].join('');
}

```

### File: scripts\validate_names.ts

```ts
// scripts/validate_names.ts
// Adds support for special route files that start with "_" (e.g. _app, _layout, _middleware, _404)

const kebab = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
const pascal = /^[A-Z][A-Za-z0-9]*$/;

function isDynamicSegment(name: string) {
	return /^\[.+\]$/.test(name);
}

function isSpecialRouteBase(base: string) {
	if (!base.startsWith('_')) return false;
	const rest = base.slice(1);

	// Allow numeric error pages like _404, _500
	if (/^\d+$/.test(rest)) return true;

	// Common special names (Fresh/Next-style)
	const specials = new Set([
		'app',
		'layout',
		'middleware',
		'document',
		'error',
		'404',
		'500',
	]);
	if (specials.has(rest)) return true;

	// Or allow "_<kebab-case>" generally (e.g., _app-shell)
	if (kebab.test(rest)) return true;

	return false;
}

function norm(p: string) {
	return p.replaceAll('\\', '/');
}

async function* walk(dir: string): AsyncGenerator<string> {
	try {
		for await (const entry of Deno.readDir(dir)) {
			const p = `${dir}/${entry.name}`;
			if (entry.isDirectory) yield* walk(p);
			else yield p;
		}
	} catch {
		// ignore missing dirs
	}
}

function pathHasSegment(p: string, segment: 'routes' | 'islands' | 'components'): boolean {
	const parts = norm(p).split('/');
	return parts.includes(segment);
}

function nearestSegmentRoot(p: string, segment: 'routes' | 'islands' | 'components'): string {
	const parts = norm(p).split('/');
	const idx = parts.lastIndexOf(segment);
	return idx >= 0 ? parts.slice(0, idx + 1).join('/') : segment;
}

function checkRoutesPath(filePath: string): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	const root = nearestSegmentRoot(normalized, 'routes');
	const rel = normalized.slice(root.length + 1); // part under routes/

	const parts = rel.split('/');

	// Validate route directories (not filenames)
	for (let i = 0; i < parts.length - 1; i++) {
		const seg = parts[i];
		if (isDynamicSegment(seg)) continue; // allow [id], [...all]
		if (/\s/.test(seg)) errors.push(`folder "${seg}" must not contain spaces`);
		if (/[A-Z]/.test(seg)) errors.push(`folder "${seg}" must not contain uppercase`);
		if (!kebab.test(seg)) errors.push(`folder "${seg}" must be kebab-case or [dynamic]`);
	}

	// Validate filename
	const file = parts[parts.length - 1];
	const extMatch = file.match(/\.(tsx|ts|jsx|js)$/);
	if (!extMatch) return errors; // only care about code files

	const base = file.replace(/\.(tsx|ts|jsx|js)$/, '');
	if (
		base === 'index' ||
		isDynamicSegment(base) ||
		isSpecialRouteBase(base) // <-- NEW: allow _app, _layout, _404, or _<kebab>
	) {
		return errors;
	}

	if (/\s/.test(base)) errors.push(`file "${file}" must not contain spaces`);
	if (/[A-Z]/.test(base)) errors.push(`file "${file}" must not contain uppercase`);
	if (!kebab.test(base)) {
		errors.push(`file "${file}" must be kebab-case (or [dynamic]/index/_special)`);
	}

	return errors.map((e) => `routes: ${e} -> ${normalized}`);
}

function checkPascalDir(filePath: string, segment: 'islands' | 'components'): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	if (!/\.tsx$/.test(normalized)) return errors; // only enforce for TSX components

	const file = normalized.split('/').pop()!;
	const base = file.replace(/\.tsx$/, '');
	if (!pascal.test(base)) {
		errors.push(`${segment}: "${file}" must be PascalCase.tsx -> ${normalized}`);
	}
	return errors;
}

async function run() {
	const violations: string[] = [];
	for await (const file of walk('.')) {
		const p = norm(file);

		// Skip obvious non-source areas
		if (
			p.includes('/node_modules/') ||
			p.includes('/dist/') ||
			p.includes('/tmp/') ||
			p.includes('/infra/') ||
			p.includes('/supabase/')
		) continue;

		if (pathHasSegment(p, 'routes')) violations.push(...checkRoutesPath(p));
		if (pathHasSegment(p, 'islands')) violations.push(...checkPascalDir(p, 'islands'));
		if (pathHasSegment(p, 'components')) violations.push(...checkPascalDir(p, 'components'));
	}

	if (violations.length) {
		console.error('\n❌ Naming violations (' + violations.length + '):');
		for (const v of violations) console.error(' - ' + v);
		Deno.exit(1);
	} else {
		console.log('✅ Naming conventions OK');
	}
}

await run();

```

### File: vite.config.ts

```ts
import { defineConfig } from 'vite';
import { fresh } from '@fresh/plugin-vite';
import { fileURLToPath } from 'node:url';

const r = (p: string) => fileURLToPath(new URL(p, import.meta.url));

export default defineConfig({
	root: 'apps/web',

	plugins: [fresh()],

	resolve: {
		alias: {
			'@': r('./apps/web/'),
			'@styles': r('./apps/web/styles/'),
			'@components': r('./apps/web/components/'),
			'@features': r('./apps/web/features/'),
			'@islands': r('./apps/web/islands/'),
			'@server': r('./apps/web/server/'),
			'@services': r('./apps/web/services/'),
			'@types': r('./apps/web/types/'),
			'@utils': r('./apps/web/utils.ts'),
			'packages': r('./packages'),
		},
	},
});

```


```

### File: db\functions\auth_project_or_dm_participant.sql

```sql
��- -   E x a m p l e   S Q L   f u n c t i o n  
 
```

### File: db\migrations\0001_init_schemas.sql

```sql
-- db/migrations/0001_init_schemas.sql

-- core schemas
CREATE SCHEMA IF NOT EXISTS security;
CREATE SCHEMA IF NOT EXISTS org;
CREATE SCHEMA IF NOT EXISTS projects;
CREATE SCHEMA IF NOT EXISTS comms;
CREATE SCHEMA IF NOT EXISTS finance;
CREATE SCHEMA IF NOT EXISTS marketplace;
CREATE SCHEMA IF NOT EXISTS search;
CREATE SCHEMA IF NOT EXISTS ops;
CREATE SCHEMA IF NOT EXISTS analytics;
CREATE SCHEMA IF NOT EXISTS integrations;

-- enums
CREATE TYPE profile_type AS ENUM ('freelancer', 'business');
CREATE TYPE assignment_type AS ENUM ('freelancer', 'team');
CREATE TYPE visibility AS ENUM ('public', 'invite_only', 'unlisted');
CREATE TYPE project_status AS ENUM ('draft', 'active', 'on_hold', 'completed', 'cancelled');
CREATE TYPE stage_status AS ENUM ('open','assigned','in_progress','submitted','approved','revisions','paid');
CREATE TYPE dispute_status AS ENUM ('open', 'under_review', 'resolved', 'refunded');


```

### File: db\migrations\0002_security_tables.sql

```sql
CREATE TABLE security.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  action text NOT NULL,
  entity_table text NOT NULL,
  entity_id uuid NOT NULL,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  ip inet,
  user_agent text,
  request_id uuid,
  actor_profile_id uuid,
  actor_team_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);

CREATE TABLE security.feature_flags (
  key text NOT NULL,
  enabled boolean NOT NULL DEFAULT false,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT feature_flags_pkey PRIMARY KEY (key)
);

CREATE TABLE security.refresh_tokens (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL,
    token_hash text NOT NULL,
    revoked boolean NOT NULL DEFAULT false,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        replaced_by uuid,
        CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id),
        CONSTRAINT refresh_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id),
        CONSTRAINT refresh_tokens_replaced_by_fkey FOREIGN KEY (replaced_by) REFERENCES security.refresh_tokens (id)
);

CREATE TABLE security.session_context (
    user_id uuid NOT NULL,
    active_profile_type USER - DEFINED NOT NULL,
    active_profile_id uuid NOT NULL,
    active_team_id uuid,
    updated_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT session_context_pkey PRIMARY KEY (user_id),
        CONSTRAINT session_context_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);

CREATE TABLE security.turnstile_verifications (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid,
    ip inet NOT NULL,
    token_prefix text NOT NULL,
    success boolean NOT NULL,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT turnstile_verifications_pkey PRIMARY KEY (id),
        CONSTRAINT turnstile_verifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);
```

### File: db\migrations\0003_org_tables.sql

```sql
CREATE TABLE org.business_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_user_id uuid NOT NULL REFERENCES auth.users(id),
  name text NOT NULL,
  legal_name text,
  logo_url text,
  country text,
  billing_email text NOT NULL,
  plan text NOT NULL DEFAULT 'free',
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  default_currency text
);

CREATE TABLE org.freelancer_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id),
  hourly_rate integer,
  skills text[] NOT NULL DEFAULT '{}',
  bio text NOT NULL DEFAULT '',
  headline text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  country text,
  visibility text NOT NULL DEFAULT 'public', 
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.skills (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    slug text NOT NULL UNIQUE,
    label text NOT NULL
);

CREATE TABLE org.user_skills (
    user_id uuid NOT NULL REFERENCES auth.users (id),
    skill_id uuid NOT NULL REFERENCES org.skills (id),
    proficiency smallint,
    PRIMARY KEY (user_id, skill_id)
);

CREATE TABLE org.users_public (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id),
  avatar_url text,
  country text,
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  visibility text NOT NULL DEFAULT 'unlisted',
  first_name text,
  last_name text,
  username text NOT NULL UNIQUE
);

CREATE TABLE org.teams (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    name text NOT NULL,
    owner_user_id uuid NOT NULL REFERENCES auth.users (id),
    description text NOT NULL DEFAULT '',
    visibility text NOT NULL DEFAULT 'invite_only',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.team_memberships (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    role text NOT NULL DEFAULT 'freelancer',
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (team_id, user_id)
);

CREATE TABLE org.team_roles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    title text NOT NULL,
    permissions jsonb NOT NULL DEFAULT '{}'
);

CREATE TABLE org.user_emails (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    email text NOT NULL,
    is_primary boolean NOT NULL DEFAULT false,
    verified_at timestamptz,
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (user_id, email)
);

CREATE TABLE org.attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_profile_id uuid NOT NULL,
    bucket text NOT NULL,
    path text NOT NULL,
    original_filename text NOT NULL,
    display_name text NOT NULL,
    mime_type text NOT NULL,
    size_bytes bigint NOT NULL,
    sha256 text,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_freelancer FOREIGN KEY (owner_profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_business FOREIGN KEY (owner_profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.portfolios (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id),
    title text NOT NULL,
    description text NOT NULL,
    cover_url text,
    attachment_id uuid REFERENCES org.attachments (id) ON DELETE SET NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.profile_links (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_type text NOT NULL,
    profile_id uuid NOT NULL,
    kind text NOT NULL,
    url text NOT NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.org_invitations (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    inviter_user_id uuid NOT NULL REFERENCES auth.users (id),
    target_email text NOT NULL,
    team_id uuid REFERENCES org.teams (id) ON DELETE CASCADE,
    business_profile_id uuid REFERENCES org.business_profiles (id) ON DELETE CASCADE,
    token text NOT NULL,
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz NOT NULL DEFAULT now()
);
```

### File: db\migrations\0004_ops_tables.sql

```sql
CREATE TABLE ops.admin_users (
  user_id uuid NOT NULL,
  role text NOT NULL DEFAULT 'admin'::text,
  granted_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT admin_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT admin_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT admin_users_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES auth.users(id)
);
```

### File: db\migrations\0005_projects_tables.sql

```sql
CREATE TABLE IF NOT EXISTS projects.projects (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    client_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    title text NOT NULL,
    description text NOT NULL,
    status project_status NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_projects_client_business ON projects.projects (client_business_id);

CREATE INDEX IF NOT EXISTS idx_projects_status_created_at ON projects.projects (status, created_at DESC);

CREATE TABLE IF NOT EXISTS projects.project_stages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    "order" integer NOT NULL,
    description text NOT NULL,
    status stage_status NOT NULL DEFAULT 'open',
    due_date timestamptz NULL,
    completed_at timestamptz NULL,
    stage_type text NULL,
    ip_mode text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_project_stages_project_order ON projects.project_stages (project_id, "order");

CREATE INDEX IF NOT EXISTS idx_project_stages_project_status ON projects.project_stages (project_id, status);

CREATE TABLE IF NOT EXISTS projects.stage_budget_rules (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    type text NOT NULL,
    amount_currency text NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    notes text NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_budget_rules_stage ON projects.stage_budget_rules (project_stage_id);

CREATE TABLE IF NOT EXISTS projects.stage_assignments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    assignee_type assignment_type NOT NULL,
    freelancer_profile_id uuid NULL REFERENCES org.freelancer_profiles (id) ON DELETE SET NULL,
    team_id uuid NULL REFERENCES org.teams (id) ON DELETE SET NULL,
    assigned_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    status text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_stage_assignments_assignee CHECK (
        (
            assignee_type = 'freelancer'
            AND freelancer_profile_id IS NOT NULL
            AND team_id IS NULL
        )
        OR (
            assignee_type = 'team'
            AND team_id IS NOT NULL
            AND freelancer_profile_id IS NULL
        )
    )
);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_stage ON projects.stage_assignments (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_freelancer ON projects.stage_assignments (freelancer_profile_id)
WHERE
    freelancer_profile_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_stage_assignments_team ON projects.stage_assignments (team_id)
WHERE
    team_id IS NOT NULL;

CREATE TABLE IF NOT EXISTS projects.stage_submissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    submitted_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_stage_submissions_stage_created ON projects.stage_submissions (
    project_stage_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS projects.stage_revision_requests (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    requested_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    type text NOT NULL,
    reason text NOT NULL,
    status text NOT NULL DEFAULT 'open',
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_stage ON projects.stage_revision_requests (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_status ON projects.stage_revision_requests (status);

CREATE TABLE IF NOT EXISTS projects.maintenance_contracts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT,
    business_profile_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    currency text NOT NULL,
    interval text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_project ON projects.maintenance_contracts (project_id);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_business ON projects.maintenance_contracts (business_profile_id);

CREATE TABLE IF NOT EXISTS projects.project_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_project_participants_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_project_participants_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_project_participants_project_profile ON projects.project_participants (
    project_id,
    profile_type,
    profile_id
);

CREATE INDEX IF NOT EXISTS idx_project_participants_profile ON projects.project_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS projects.project_activity (
id            uuid        PRIMARY KEY DEFAULT gen_random_uuid(),
project_id    uuid        NOT NULL REFERENCES projects.projects(id) ON DELETE CASCADE,
actor_user_id uuid        NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
kind          text        NOT NULL, 
payload       jsonb       NOT NULL DEFAULT '{}'::jsonb,
entity_table  text        NOT NULL,
entity_id     uuid        NOT NULL,
created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_project_activity_project_created ON projects.project_activity (project_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_project_activity_entity ON projects.project_activity (entity_table, entity_id);

COMMIT;
```

### File: db\migrations\0006_comms_tables.sql

```sql
CREATE TABLE IF NOT EXISTS comms.project_channels (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    stage_id uuid NULL REFERENCES projects.project_stages (id) ON DELETE SET NULL,
    visibility text NOT NULL DEFAULT 'project_all',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_project_channels_project_name UNIQUE (project_id, name)
);

CREATE INDEX IF NOT EXISTS idx_project_channels_project ON comms.project_channels (project_id);

CREATE INDEX IF NOT EXISTS idx_project_channels_stage ON comms.project_channels (stage_id);

CREATE TABLE IF NOT EXISTS comms.project_channel_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL DEFAULT 'participant',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_projchan_participant_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_projchan_participant_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT uq_project_channel_participant UNIQUE (
        channel_id,
        profile_type,
        profile_id
    )
);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_channel ON comms.project_channel_participants (channel_id);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_profile ON comms.project_channel_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS comms.project_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    edited_at timestamptz NULL,
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_project_messages_channel_created ON comms.project_messages (channel_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.dm_threads (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    created_by_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dm_threads_creator ON comms.dm_threads (
    created_by_user_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS comms.dm_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    joined_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_dm_participants_thread_user UNIQUE (thread_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_dm_participants_user ON comms.dm_participants (user_id);

CREATE TABLE IF NOT EXISTS comms.dm_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_dm_messages_thread_created ON comms.dm_messages (thread_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.message_attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    message_table text NOT NULL,
    message_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_message_attachments_table CHECK (
        message_table IN (
            'comms.project_messages',
            'comms.dm_messages'
        )
    ),
    CONSTRAINT uq_message_attachment UNIQUE (
        message_table,
        message_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_message_attachments_message ON comms.message_attachments (message_table, message_id);

CREATE INDEX IF NOT EXISTS idx_message_attachments_attachment ON comms.message_attachments (attachment_id);

CREATE TABLE IF NOT EXISTS comms.channel_files (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_type text NOT NULL,
    channel_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_channel_files_type CHECK (
        channel_type IN ('project', 'dm')
    ),
    CONSTRAINT uq_channel_files_channel_attachment UNIQUE (
        channel_type,
        channel_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_channel_files_channel ON comms.channel_files (channel_type, channel_id);

CREATE INDEX IF NOT EXISTS idx_channel_files_attachment ON comms.channel_files (attachment_id);

CREATE TABLE IF NOT EXISTS comms.notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    type text NOT NULL,
    title text NOT NULL,
    body text NOT NULL,
    entity_table text NULL,
    entity_id uuid NULL,
    read_at timestamptz NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notifications_user_created ON comms.notifications (user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_notifications_user_unread ON comms.notifications (user_id)
WHERE
    read_at IS NULL;

CREATE TABLE IF NOT EXISTS comms.notification_prefs (
    user_id uuid PRIMARY KEY REFERENCES auth.users (id) ON DELETE CASCADE,
    email boolean NOT NULL DEFAULT true,
    push boolean NOT NULL DEFAULT false,
    in_app boolean NOT NULL DEFAULT true,
    digest boolean NOT NULL DEFAULT false,
    quiet_hours tstzrange NULL
);

CREATE TABLE IF NOT EXISTS comms.device_tokens (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    provider text NOT NULL,
    token text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_device_tokens_provider_token UNIQUE (provider, token)
);

CREATE INDEX IF NOT EXISTS idx_device_tokens_user ON comms.device_tokens (user_id);

DO $$
BEGIN
PERFORM 1
FROM pg_publication
WHERE pubname = 'supabase_realtime';

IF NOT FOUND THEN
CREATE PUBLICATION supabase_realtime;
END IF;
END;
$$;


ALTER TABLE comms.project_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.dm_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.notifications REPLICA IDENTITY FULL;

ALTER PUBLICATION supabase_realtime
ADD
TABLE comms.project_messages,
comms.dm_messages,
comms.notifications;
```

### File: db\migrations\0007_finance_tables.sql

```sql
CREATE TABLE IF NOT EXISTS finance.wallets (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    currency text NOT NULL,
    balance_cents bigint NOT NULL DEFAULT 0 CHECK (balance_cents >= 0),
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_wallet_owner_currency UNIQUE (
        owner_type,
        owner_id,
        currency
    )
);

CREATE INDEX IF NOT EXISTS idx_wallets_owner ON finance.wallets (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.transactions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    wallet_id uuid NOT NULL REFERENCES finance.wallets (id) ON DELETE CASCADE,
    direction text NOT NULL CHECK (
        direction IN ('credit', 'debit')
    ),
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    reason text NOT NULL,
    ref_table text NULL,
    ref_id uuid NULL,
    balance_after_cents bigint NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_transactions_wallet_created ON finance.transactions (wallet_id, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.escrows (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE RESTRICT,
    payer_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    payee_type assignment_type NOT NULL,
    payee_id uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'funded',
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_freelancer FOREIGN KEY (payee_id) REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_team FOREIGN KEY (payee_id) REFERENCES org.teams (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

CREATE INDEX IF NOT EXISTS idx_escrows_stage ON finance.escrows (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payer_business ON finance.escrows (payer_business_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payee ON finance.escrows (payee_type, payee_id);

CREATE TABLE IF NOT EXISTS finance.payout_accounts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    provider text NOT NULL,
    account_id text NOT NULL,
    status text NOT NULL DEFAULT 'pending_verification',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_payout_accounts_provider_account UNIQUE (provider, account_id)
);

CREATE INDEX IF NOT EXISTS idx_payout_accounts_owner ON finance.payout_accounts (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.invoices (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    issue_to_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    issue_from_profile uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_invoices_business ON finance.invoices (
    issue_to_business_id,
    created_at DESC
);

CREATE INDEX IF NOT EXISTS idx_invoices_stage ON finance.invoices (project_stage_id);

CREATE TABLE IF NOT EXISTS finance.disputes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    escrow_id uuid NOT NULL REFERENCES finance.escrows (id) ON DELETE CASCADE,
    opened_by_profile uuid NOT NULL,
    reason text NOT NULL,
    status dispute_status NOT NULL DEFAULT 'open',
    resolution_notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_disputes_escrow ON finance.disputes (escrow_id);

CREATE INDEX IF NOT EXISTS idx_disputes_status ON finance.disputes (status, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.dispute_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    dispute_id uuid NOT NULL REFERENCES finance.disputes (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dispute_messages_dispute_created ON finance.dispute_messages (dispute_id, created_at ASC);

CREATE TABLE IF NOT EXISTS finance.ratings (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    rater_profile uuid NOT NULL,
    ratee_type text NOT NULL,
    ratee_id uuid NOT NULL,
    score smallint NOT NULL CHECK (score BETWEEN 1 AND 5),
    comment text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_ratings_ratee ON finance.ratings (ratee_type, ratee_id);

CREATE INDEX IF NOT EXISTS idx_ratings_project ON finance.ratings (project_id);

CREATE TABLE IF NOT EXISTS finance.subscriptions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_id uuid NOT NULL,
    plan text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    started_at timestamptz NOT NULL DEFAULT now(),
    ends_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_subscriptions_profile ON finance.subscriptions (profile_id, status);
```

### File: db\migrations\0020_helpers_functions.sql

```sql
-- db/migrations/0004_helpers_functions.sql

-- NOTE: we rely on pgcrypto/gen_random_uuid(). Make sure extension is on.
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- is_admin(): check ops.admin_users
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$;

-- simple debug helper: return current JWT context
CREATE OR REPLACE FUNCTION security.current_context()
RETURNS jsonb
LANGUAGE sql
STABLE
AS $$
  SELECT jsonb_build_object(
    'user_id', auth.uid(),
    'active_profile_type', auth.jwt()->>'active_profile_type',
    'active_profile_id',   auth.jwt()->>'active_profile_id',
    'active_team_id',      auth.jwt()->>'active_team_id'
  );
$$;

```

### File: db\policies\org\business_profiles.sql

```sql
ALTER TABLE org.business_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_business_profiles_select_owner
ON org.business_profiles
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create business profiles for themselves
CREATE POLICY pol_org_business_profiles_insert_self
ON org.business_profiles
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: owner or admin
CREATE POLICY pol_org_business_profiles_update_owner
ON org.business_profiles
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_business_profiles_delete_owner
ON org.business_profiles
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\freelancer_profiles.sql

```sql
ALTER TABLE org.freelancer_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_freelancer_profiles_select_owner
ON org.freelancer_profiles
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create exactly one freelancer profile tied to themselves
CREATE POLICY pol_org_freelancer_profiles_insert_self
ON org.freelancer_profiles
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner / admin can edit
CREATE POLICY pol_org_freelancer_profiles_update_owner
ON org.freelancer_profiles
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

/* no DELETE */

```

### File: db\policies\org\teams.sql

```sql
ALTER TABLE org.teams ENABLE ROW LEVEL SECURITY;

-- SELECT: show teams you are a member of OR that you own OR admin
CREATE POLICY pol_org_teams_select_member_or_owner
ON org.teams
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships tm
    WHERE tm.team_id = id
      AND tm.user_id = auth.uid()
      AND tm.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: any user can create a team they own
CREATE POLICY pol_org_teams_insert_self
ON org.teams
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner or admin
CREATE POLICY pol_org_teams_update_owner
ON org.teams
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_teams_delete_owner
ON org.teams
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\team_memberships.sql

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;

-- SELECT: any active member of the same team may view
CREATE POLICY pol_org_team_memberships_select_team_member
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin) can add members
CREATE POLICY pol_org_team_memberships_insert_team_owner
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner, team_lead/admin role, or platform admin
CREATE POLICY pol_org_team_memberships_update_team_owner
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK (
  TRUE
);

-- DELETE: same as update (remove member)
CREATE POLICY pol_org_team_memberships_delete_team_owner
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

```

### File: db\policies\org\users_public.sql

```sql
��A L T E R   T A B L E   o r g . u s e r s _ p u b l i c   E N A B L E   R O W   L E V E L   S E C U R I T Y ;  
  
 - -   A n y   l o g g e d - i n   u s e r   c a n   r e a d   p u b l i c   p r o f i l e s  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ s e l e c t _ a l l _ a u t h  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   S E L E C T  
 U S I N G   (   a u t h . u i d ( )   I S   N O T   N U L L   ) ;  
  
 - -   U s e r   c a n   c r e a t e   t h e i r   o w n   p u b l i c   r o w  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ i n s e r t _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   I N S E R T  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 - -   U s e r   c a n   u p d a t e   o n l y   t h e i r   o w n   r o w   ( o r   a d m i n   c a n )  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ u p d a t e _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   U P D A T E  
 U S I N G   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 )  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 / *   n o   D E L E T E   * /  
 
```

### File: db\policies\org\user_emails.sql

```sql
ALTER TABLE org.user_emails ENABLE ROW LEVEL SECURITY;

-- SELECT: you can read only your own email records
CREATE POLICY pol_org_user_emails_select_self
ON org.user_emails
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: you can add an email for yourself
CREATE POLICY pol_org_user_emails_insert_self
ON org.user_emails
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: you can update only your own row
CREATE POLICY pol_org_user_emails_update_self
ON org.user_emails
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: you can delete only your own row
CREATE POLICY pol_org_user_emails_delete_self
ON org.user_emails
FOR DELETE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\security\audit_logs.sql

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

-- allow a user to read only their own audit trail, plus admins
CREATE POLICY pol_security_audit_logs_select_self_or_admin
ON security.audit_logs
FOR SELECT
USING (
  audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- no INSERT/UPDATE/DELETE policies for public
-- audit rows are inserted by service_role from the API layer

```

### File: db\policies\security\refresh_tokens.sql

```sql
ALTER TABLE security.refresh_tokens ENABLE ROW LEVEL SECURITY;

-- DO NOT expose refresh tokens to regular users at all.
-- No SELECT/INSERT/UPDATE/DELETE policies on purpose.

-- Only service_role should ever touch this table, and service_role bypasses RLS.
-- That means from the browser you literally cannot query this table.

```

### File: db\policies\security\session_context.sql

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;

-- SELECT own context
CREATE POLICY pol_security_session_context_select_self
ON security.session_context
FOR SELECT
USING ( user_id = auth.uid() );

-- INSERT own context
CREATE POLICY pol_security_session_context_insert_self
ON security.session_context
FOR INSERT
WITH CHECK ( user_id = auth.uid() );

-- UPDATE own context
CREATE POLICY pol_security_session_context_update_self
ON security.session_context
FOR UPDATE
USING ( user_id = auth.uid() )
WITH CHECK ( user_id = auth.uid() );

-- no DELETE policy for normal users

```

### File: db\policies\security\v_current_context.sql

```sql
ALTER VIEW security.v_current_context SET (security_invoker = true);

-- Views don’t use RLS directly, so we do NOT need policies here.
-- The WHERE clause already ties it to auth.uid().
-- (If Supabase complains about querying this view from the client,
-- you can instead expose a helper RPC function.)

```

### File: db\views\analytics_earnings_by_stage_mv.sql

```sql
��- -   E x a m p l e   m a t e r i a l i z e d   v i e w  
 
```

### File: db\views\security\v_current_context.sql

```sql
CREATE OR REPLACE VIEW security.v_current_context AS
SELECT
  sc.user_id,
  sc.active_profile_type,
  sc.active_profile_id,
  sc.active_team_id,
  sc.updated_at
FROM security.session_context sc
WHERE sc.user_id = auth.uid();

```

### File: deno.json

```json
{
  "nodeModulesDir": "auto",
  "workspace": [
    "./apps/web",
    "./packages/shared",
    "./packages/backend",
    "./packages/ui"
  ],
  "tasks": {
    "format": "deno fmt --check",
    "lint": "deno lint",
    "typecheck": "deno check",
    "names": "deno run -A scripts/validate_names.ts",
    "check": "deno fmt --check && deno lint && deno check && deno run -A scripts/validate_names.ts",
    "test": "deno test --fail-fast --coverage=coverage -A --trace-leaks",
    "dev": "vite --port 3000 --open --host --mode development",
    "build": "vite build --mode production",
    "start": "deno serve -A --watch --port 3000 --env-file=.env.production apps/web/_fresh/server.js",
    "update": "deno run -A -r jsr:@fresh/update .",
    "db:reset": "bash db/scripts/test_db_reset.sh",
    "db:smoke": "supabase db query < db/scripts/test_db_smoke.sql",
    "coverage:lcov": "deno coverage coverage --lcov --output=coverage.lcov",
    "coverage:html": "deno coverage coverage --html",
    "preview": "deno run -A main.ts"
  },
  "fmt": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "_fresh/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx",
        "*.css"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "options": {
      "lineWidth": 100,
      "indentWidth": 2,
      "useTabs": true,
      "singleQuote": true
    }
  },
  "lint": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "rules": { "tags": ["recommended", "fresh"] }
  },
  "compilerOptions": {
    "lib": ["dom", "dom.asynciterable", "dom.iterable", "deno.ns"],
    "jsx": "react-jsx",
    "jsxImportSource": "preact",
    "jsxPrecompileSkipElements": [
      "a",
      "img",
      "source",
      "body",
      "html",
      "head",
      "title",
      "meta",
      "script",
      "link",
      "style",
      "base",
      "noscript",
      "template"
    ],
    "types": ["vite/client"]
  },
  "imports": {
    "@std/assert": "jsr:@std/assert@^1.0.15",
    "@std/dotenv": "jsr:@std/dotenv@^0.225.5",
    "@std/http": "jsr:@std/http@^1.0.21",
    "@fresh/plugin-vite": "jsr:@fresh/plugin-vite@^1.0.8",
    "@preact/signals": "npm:@preact/signals@^2.5.0",
    "@std/regexp": "jsr:@std/regexp@^1.0.1",
    "djwt": "jsr:@zaubrik/djwt@^3.0.2",
    "fresh": "jsr:@fresh/core@^2.2.0",
    "preact": "npm:preact@^10.27.2",
    "supabaseClient": "npm:@supabase/supabase-js@2.76.1",

    "packages/": "./packages/",
    "@shared": "./packages/shared/mod.ts",
    "@backend": "./packages/backend/mod.ts",
    "@ui": "./packages/ui/mod.ts",

    "@/": "./apps/web/",
    "@components/": "./apps/web/components/",
    "@islands/": "./apps/web/islands/",
    "@styles/": "./apps/web/styles/",
    "@server/": "./apps/web/server/",
    "@contracts/": "./apps/web/contracts/",
    "@utils": "./apps/web/utils.ts"
  },
  "exclude": ["**/_fresh/*"]
}

```

### File: docs\01_Vision.md

```md
# Platform for Collaborative Freelancing

### Vision

A modern freelancing ecosystem where businesses can hire individuals, multiple freelancers, or entire teams to collaborate on structured projects with predefined costs and deliverables.

### Core Philosophy

- **Collaboration-first**: Freelancers can form teams that function like micro-agencies.
- **Transparency**: Clear pricing per stage, no endless negotiations.
- **Scalability**: Businesses can scale from one freelancer to entire coordinated teams.
- **Fair entry**: Low barrier for new freelancers via transparent stage pricing and templated projects.

### Problem

Traditional freelancing platforms (Upwork, Fiverr) isolate freelancers and force clients into constant negotiation. This slows projects, fragments collaboration, and inflates costs.

### Solution

A project-based collaboration platform that:

- Simplifies hiring through structured **project templates**.
- Allows **freelancers and teams** to work together.
- Supports **fixed-stage budgets** with optional revisions.
- Provides a **shared workspace** with chat, file exchange, and progress tracking.

### Elevator Pitch

> “A collaborative freelancing marketplace where teams deliver complete projects with predictable pricing — the efficiency of Fiverr meets the teamwork of Upwork agencies.”

```

### File: docs\02_Features.md

```md
# Core Features

## For Businesses

- Post projects or use guided templates.
- Hire individuals or full teams.
- Mix freelancers and teams per project stage.
- Track progress, files, and communications in one workspace.
- Approve and pay by stage (Design, MVP, Testing, etc.).
- Set budgets for revisions and maintenance.

## For Freelancers

- Create portfolios with previous work.
- Form or join **freelancer teams**.
- Offer stage-based pricing.
- Apply to project templates.
- Showcase completed work and, later, sell digital assets.

## For Freelancer Teams

- Define roles, pricing, and collaborative tools.
- Manage internal task boards.
- Share revenue and reviews collectively.

---

# Future Enhancements (Phase 4+)

- **Marketplace Layer:** Sell digital assets, templates, or previous work.
- **Smart Matching:** AI-assisted team and project pairing.
- **Escrow & Payments:** Stripe Connect for milestone-based transactions.

```

### File: docs\03_TechStack.md

```md
# Technology Overview

## Frontend

- **Framework:** Deno Fresh + Preact Islands.
- **Runtime:** Deno Deploy (Edge-first).
- **Styling:** Tailwind CSS + Shadcn UI.

## Backend / API

- **Database:** Supabase (PostgreSQL + RLS).
- **Auth:** Supabase Auth (JWT + custom refresh tokens hashed with Argon2id).
- **Realtime:** Supabase Realtime (WebSocket events).
- **Rate Limiting / KV:** Deno KV atomic counters.
- **WASM:** Rust modules compiled to WebAssembly for CPU-heavy work (e.g., image optimization, file processing).
- **Security:**
  - JWT access tokens (short-lived).
  - Hashed refresh tokens (rotated).
  - Strict RLS policies per user/team.
  - CORS & CSP via middleware.
  - Cloudflare Turnstile for bot protection.
  - Signed URLs for all file access.

## Architecture

```text
Frontend (FreshJS Islands)
  |
  ├── Auth + API Gateway (Fresh API routes, Hono optional)
  │     ├── JWT verification
  │     ├── Rate limiting (Deno KV)
  │     ├── Supabase queries (role-based)
  │     └── WASM modules (Rust compute)
  |
  └── Supabase (DB, Auth, Realtime, Storage)
```

## Account Switching Logic

- A single `users` record may own:
  - **One `freelancer_profile`**
  - **Many `business_profiles`**
- The UI includes an **Account Switcher** in the dashboard header.
- When a user switches:
  - Frontend updates the `active_profile_id` in session.
  - Backend JWT claims change (`sub` = user_id, `active_profile` = selected profile).
  - Supabase Row-Level Security filters all queries using `active_profile_id`.
- Context is cached in Deno KV for quick lookups and revocation.

### Example

```text
User (uuid: U1)
├── FreelancerProfile (uuid: F1)
├── BusinessProfile (uuid: B1)
└── BusinessProfile (uuid: B2)

Active session: `{ user_id: U1, active_profile_type: "business", active_profile_id: B2 }`
```

## Team Membership Architecture

- Freelancers can join **multiple teams**.
- Each membership record links a `user_id` to a `team_id` with role-based permissions.
- The UI displays a **Team Selector** (similar to the Account Switcher) showing:
  - Teams owned
  - Teams joined
- Switching between teams updates `active_team_id` in session.
- Supabase RLS filters project data by both `active_profile_id` and `active_team_id`.
- Permissions flow:
  - `freelancer` → can access personal and joined team projects.
  - `team_lead` → can manage members and approve work.
  - `business` → can interact only with teams they hire.

```

### File: docs\04_Roadmap.md

```md
# Phased Roadmap

## Phase 1 — MVP: Core Collaboration

- Auth + roles (client, freelancer, team lead)
- Project creation & management
- Team formation
- Messaging & file sharing
- Stage-based pricing & revision budgets
- Supabase RLS enforcement

## Phase 2 — Payments & Trust

- Stripe Connect (escrow)
- Stage payments & revision releases
- Review & rating system
- Dispute workflow
- Analytics dashboards

## Phase 3 — Guided Hiring

- Project templates (e.g., Web App Build, Marketing Campaign)
- Smart freelancer/team suggestions
- Template-based pricing generator
- Search & recommendation via pgvector

## Phase 4 — Marketplace Expansion

- Freelancer storefronts for templates / assets
- Digital delivery & licensing
- Passive income for freelancers
- Referral & affiliate programs

## Phase 5 — Enterprise Layer

- Multi-team orchestration
- API access for enterprise clients
- Reporting dashboards & audits

```

### File: docs\05_Security.md

```md
# Security Overview

## Authentication & Authorization

- JWT-based access tokens (15m expiry).
- Opaque refresh tokens (rotating, Argon2id-hashed).
- Supabase RLS per project, user, team.
- Project ownership & membership validation at query level.

## API Security

- Rate limiting with Deno KV (60 req/min/user).
- CORS allowlist via env var.
- Content-Security-Policy & Referrer-Policy in middleware.
- CAPTCHA (Turnstile) for anon POST endpoints.
- HTTPS enforced; cookies marked Secure + HttpOnly.

## Data Security

- All Supabase buckets private by default.
- Signed URLs (60s TTL) for file access.
- Encryption at rest (Supabase-managed).
- Sanitized file uploads (MIME + size checks).

## Performance & Scalability

- Edge caching for static routes (Fresh Islands).
- Lazy hydration (Preact islands).
- Deno Deploy’s auto-scaling edge functions.
- Supabase horizontally scalable with PG bloat control.
- Optional Rust WASM compute for heavy workloads.

```

### File: docs\06_InvestorSummary.md

```md
# Executive Summary

### Elevator Pitch

A collaborative freelancing marketplace that lets businesses hire entire teams to deliver projects end-to-end — predictable costs, faster delivery, and fairer work for freelancers.

### Why Now

The freelancing economy is fragmented and inefficient. Businesses waste time managing multiple freelancers separately, while freelancers struggle to collaborate and scale.

### Market

- Global freelancing market: $1.5T (Upwork 2023 report)
- Increasing shift toward distributed, project-based work.
- Opportunity: become the go-to “agency builder” for freelance teams.

### Competitive Advantage

- Collaboration-first architecture (teams > individuals)
- Fixed stage pricing (no endless bidding)
- Built-in transparency for clients
- Future-ready (marketplace + AI-guided hiring)

### Monetization (Phase 2+)

- 10% service fee per project stage
- Subscription tiers for freelancers/teams
- Marketplace commissions (digital assets)
- Team analytics & premium project templates

### Status

- MVP under development using Deno Fresh, Supabase, and Rust WASM.
- Fully open-source stack; minimal operational cost.
- Designed for scalability and transparency.

```

### File: docs\07_UserStories.md

```md
# User Stories – Collaborative Freelancing Platform

## Overview

The platform enables **businesses**, **freelancers**, and **freelancer teams** to collaborate on structured projects with clear budgets and milestones.  
It combines the simplicity of Fiverr, the project depth of Upwork, and the collaboration of small consultancies.

---

## 👤 User Roles

1. **Business Client** – posts projects, hires freelancers or teams, approves work, and manages budgets.
2. **Freelancer** – offers services, applies for projects, and can join multiple teams.
3. **Freelancer Team** – a group of freelancers acting as a mini-agency with shared portfolios and collective pricing.
4. **Multi-Account User (Hybrid)** – a single registered person who can:
   - Own **one freelancer profile** (personal or part of a team).
   - Own and manage **multiple business profiles** (companies, brands, or projects).
   - **Switch accounts** from a single login session without re-authenticating.

---

## 🧱 Core Platform Features

- Discover and filter **individual freelancers**.
- View detailed **freelancer portfolios** and past projects.
- **Create and manage teams** (by freelancers themselves).
- **Hire individuals or full teams** for project stages.
- **Post projects** or choose from **guided project templates**.
- **Set and manage budgets** per project stage or revision type.
- Built-in **messaging and file sharing** for collaboration.
- **Freelancers can sell previous work** (digital templates, products).

---

## 🏗️ Epic 1 – Discovery & Profiles

### As a Business Client:

- I want to **browse and filter freelancers** by skills, experience, rating, and location.
- I want to **view freelancer portfolios** to see examples of past work before hiring.
- I want to **search for teams** that specialize in certain project types.

### As a Freelancer:

- I want to **create a public portfolio** to showcase my best work.
- I want to **list my services and stage-based pricing** clearly.
- I want to **tag my profile with specializations** (e.g., “UI Design”, “MVP Implementation”).

### As a Freelancer Team:

- I want to **build a shared team profile** that highlights collective experience.
- I want to **add or remove members** dynamically as projects evolve.
- I want to **share reviews and ratings** collectively as a team brand.

---

## 🧩 Epic 2 – Project Creation & Hiring

### As a Business Client:

- I want to **post new projects** with clear descriptions, budgets, and deadlines.
- I want to **use project templates** that automatically define common stages (e.g., “Design”, “Testing”).
- I want to **mix and match freelancers or teams per stage** of a project.
- I want to **view cost breakdowns** for each stage before committing.
- I want to **hire multiple freelancers** for larger jobs.
- I want to **hire full teams** for complex, multi-stage projects.

### As a Freelancer or Team:

- I want to **apply to posted projects** that match my skills.
- I want to **see which stages of a project are open for bids or collaboration.**
- I want to **set budgets per stage**, including optional revision costs.
- I want to **propose stage pricing** dynamically (e.g., higher for “Major Revisions”, lower for “Tweaks”).

---

## 💰 Epic 3 – Budgets & Stage Pricing

### As a Business Client:

- I want to **view total project cost** broken down by stage.
- I want to **approve or modify budgets** before finalizing a contract.
- I want to **see optional revision costs** (“Minor Tweaks”, “Major Revisions”).

### As a Freelancer or Team:

- I want to **set fixed budgets per stage** (e.g., Design £40, Implementation £260).
- I want to **offer certain stages for free** to attract clients (e.g., “Consultation – Free”).
- I want to **charge monthly maintenance fees** for ongoing work.

### Example – Team Pricing:

| Stage                        | Description            | Budget     |
| ---------------------------- | ---------------------- | ---------- |
| Market Research & Consulting | Discovery phase        | Free       |
| Design                       | UI/UX layout           | £40        |
| MVP Implementation           | Prototype build        | £260       |
| Full Implementation          | Production-ready build | £430       |
| Testing                      | QA, bug fixes          | £70        |
| Minor Tweaks                 | Post-launch fixes      | £10        |
| Major Revisions              | Reworks                | Up to £300 |
| Maintenance                  | Monthly retainer       | £50/month  |
| Marketing                    | Launch campaigns       | Up to £500 |

---

## 🧑‍💻 Epic 3A – Team Membership

### As a Freelancer:

- I want to **join multiple teams** so I can collaborate on different projects simultaneously.
- I want to **see which teams I belong to** and easily switch between them in my dashboard.
- I want to **set my visibility** (public or invite-only membership).
- I want to **choose whether a project invitation goes to me personally or via one of my teams**.
- I want to **leave a team at any time**, unless I have an active project stage assigned to me.

### As a Team Lead:

- I want to **invite existing freelancers** to join my team.
- I want to **see all members across multiple active projects**.
- I want to **assign roles** (e.g., Developer, Designer, Tester) within the team.
- I want to **review and rate freelancers** after project completion.

### As a Business Client:

- I want to **see the full composition of any team** I hire (roles, members, reputation).
- I want to **know if a freelancer I hire is already part of another team** for transparency.

---

## 🧠 Epic 4 – Guided Project Templates

### As a Business Client:

- I want to **select a project template** (e.g., “Build a SaaS MVP”, “Design a Landing Page”).
- I want the platform to **recommend suitable freelancers or teams** for each stage.
- I want to **customize the template** by replacing or removing stages.
- I want to **preview total cost and timeline** before confirming.

### As a Freelancer:

- I want to **attach my services to specific template stages**.
- I want to **see when businesses select my stage** in a template.
- I want to **get notified when a template project matches my profile.**

---

## 🤝 Epic 5 – Collaboration & Communication

### As a Business Client:

- I want to **chat with freelancers and teams** directly inside project rooms.
- I want to **upload reference files and documentation**.
- I want to **receive milestone updates** as stages are completed.

### As a Freelancer/Team:

- I want to **collaborate with others on the same project** (shared workspace).
- I want to **track progress** with task boards or checklists.
- I want to **share deliverables securely** through Supabase Storage.

---

## 💼 Epic 6 – Review, Payments & Revisions (Phase 2+)

### As a Business Client:

- I want to **approve deliverables per stage** before payment is released.
- I want to **request revisions** if I’m not satisfied.
- I want to **rate freelancers and teams** after project completion.

### As a Freelancer:

- I want to **receive payments securely** (via Stripe Connect).
- I want to **track my earnings and withdrawal history.**
- I want to **see client feedback** for continuous improvement.

---

## 🛍️ Epic 7 – Marketplace for Previous Work (Future Expansion)

### As a Freelancer:

- I want to **sell past designs, templates, or products** directly on my profile.
- I want to **define licenses or exclusivity** (e.g., “Full Rights”, “Template Use Only”).
- I want to **track downloads and sales analytics**.

### As a Business Client:

- I want to **browse and buy ready-made assets** (website templates, designs, code).
- I want to **preview and customize digital assets** before purchase.

**Examples:**

- A designer sells a T-shirt design and optionally prints the product.
- A developer sells an unused website domain or UI template.

---

## 🔐 Epic 8 – Account & Security

### As Any User:

- I want to **log in securely** using Supabase Auth (email/password or OAuth).
- I want to **receive session tokens that expire safely** (JWT + hashed refresh).
- I want to **recover my account** if I forget credentials.
- I want to **verify my identity** before taking payments or forming teams.

---

## 📊 Epic 9 – Analytics & Insights (Later Phase)

- Businesses can view **budget breakdowns** and project performance.
- Freelancers can view **earnings analytics** and stage efficiency.
- Teams can track **member contributions** and client satisfaction.

---

## 🔮 Epic 10 – Long-Term Vision

- **AI-assisted team recommendations** (“Best team for your budget”).
- **Automated milestone forecasting** (timeline prediction based on prior data).
- **Cross-platform integrations** (Notion, Slack, GitHub).
- **API access** for enterprise clients.

---

## 🔄 Epic 11 – Multi-Account Switching

### As a User:

- I want to **associate multiple business accounts** under my profile.
- I want to **switch between my business accounts and my freelancer profile** from a single dashboard.
- I want to **see which account is currently active** when viewing projects or payments.
- I want to **maintain separate wallets and analytics** for each business account.
- I want to **use the same email/login credentials** for all associated accounts.

### As a Business Owner:

- I want to **delegate access** to collaborators (e.g., team members or assistants).
- I want to **assign roles** (Owner, Manager, Viewer) per business account.

### As a Freelancer:

- I want to **operate my freelancer account independently** of any business accounts.
- I want my freelancer identity (ratings, portfolio) to remain consistent even if I switch to a business context.

---

## 🔐 Account & Security (Updated)

- Each **user ID** can own one `freelancer_profile` and multiple `business_profiles`.
- Switching context updates `active_profile_id` in session JWT.
- **RLS policies** ensure all database operations are filtered by the currently active account.
- All **API endpoints** respect `active_profile_type` (`freelancer` or `business`) for access control.
- **Audit logs** record all account switches for transparency.

```

### File: docs\08_UserFlows.md

```md
# Projective User Flows  
Version: Draft MVP Architecture  
Date: 25 Oct 2025  
Author: GPT-5 (Projective System Docs)

---

## Actors (Who’s doing what)

### Business / Creator
- A person or company that wants work done.
- They can own multiple business profiles.
- They create projects, approve work, fund payments, open disputes.

### Freelancer
- An individual who offers services.
- Can act solo, join multiple teams, and sell work.
- Can take on different types of work modes (Create, Run, Educate, etc.).

### Team
- A group of freelancers acting like a micro-agency.
- Can be hired as a unit for certain stages or entire projects.

### Platform / System
- Handles auth, RLS isolation, escrow, dispute moderation, file access, audit trail, IP policy references, etc.

### Moderator (Internal / Admin)
- Only steps in for escalated disputes, fraud, abuse, safety, or IP claims.

---

## 1. Onboarding → First Project Flow (End-to-end narrative)

High level:
1. User signs up.
2. User chooses what they are.
3. User sets up profile + payout/billing.
4. User either posts a project (as a creator/business) or looks for work (as a freelancer).
5. The first project is created and staffed.
6. Work is delivered, paid, reviewed, possibly disputed.

We'll break that into phases.

---

### 1.1 Account Creation & Role Setup

``` text
Start
↓
Signup/Login (Supabase Auth)
- email/password OR OAuth
- Turnstile check for bots
↓
Verify Email (token link)
↓
Choose Path:
  [ I'm here to HIRE / I need work done ] → becomes Creator
  [ I'm here to WORK / Offer services ] → becomes Freelancer
↓
System creates:
- `auth.users` row
- `security.session_context` row
- If Freelancer path: create `org.freelancer_profiles`
- If Creator path: create `org.business_profiles`
↓
Dashboard boot
```

Details:
- A single human user can actually become both later. This is done through the account switcher (they can own one freelancer profile and many business profiles).
- We store in `session_context` which profile is “active,” and that value is embedded in the JWT for RLS.

Security notes:
- Refresh tokens are hashed and rotated.
- Every request to the API uses the active profile for access filtering via RLS.

---

### 1.2 Profile Completion

For Freelancers:
- Add headline, skills, pricing style, availability.
- Attach portfolio samples (uploads go → `attachments` bucket → scanned in `quarantine` first).
- Optionally join or create a Team.

For Creators (business):
- Add business name, billing email, location.
- Add payment method for funding stages later (Stripe on file).
- (Later phase) Verify identity for high-value spend / anti-fraud.

For Teams:
- A freelancer can create a team, invite others, and define roles (designer, dev, QA, PM).
- Team shows up as a hireable “unit” for a stage.

---

### 1.3 Payment Setup (Creator side)

Why early?
- You can’t actually start a paid stage without funding escrow.

Flow:
- Creator adds payment details (card / business payment method).
- The platform prepares “wallets” and enables escrows.
- No money moves yet, but escrow will be pulled before work starts.

``` text
Creator Dashboard
↓
Settings / Wallet
↓
Add Payment Method
↓
Stripe Connect / billing link
↓
Ready to fund escrows
```

(Teams / freelancers later add payout accounts so they can receive funds after stage approval.)

---

## 2. Project Lifecycle Overview

Now we zoom into how a project is created, staffed, executed, delivered, paid, and possibly disputed.

We cover:
- Full project (multi-stage)
- Single-stage projects
- Stage types and how they behave
- Tabs within a stage
- Escrow and approvals
- Revisions and disputes
- IP handling

---

### 2.1 Creating a Project (Creator perspective)

There are two paths:
A. Custom project (“Describe what you need”)  
B. Template (“Landing Page Build”, “SEO Campaign”, “Pitch Deck Coaching”, “App MVP”)

``` text
Creator Dashboard
↓
"New Project"
↓
Option A: Custom Project
  - Title, description, goals, timeline, budget comfort
  - Add first stage(s) manually
Option B: Use Template
  - Pick template category
  - System auto-loads suggested stages (Design, Build MVP, Test, etc.)
  - Each stage has a recommended Stage Type and suggested cost ranges
↓
Project Draft Created in DB:
- projects.projects (status = draft)
- projects.project_stages[] (status = open)
↓
Creator Reviews Stage List
  - Can remove stages
  - Can reorder them
  - Can change who they want to hire per stage:
    - Single freelancer
    - Multiple freelancers across stages
    - Whole team for multiple stages
↓
Save
```

During this step:
- No one is hired yet.
- Budget rules can be defined per stage:
  - fixed price
  - cap / hourly cap
  - free (like discovery/consult)

This maps to `projects.stage_budget_rules`.

---

### 2.2 Stage Types (How work is structured)

Stages are atomic units of work that can be assigned to either:
- A single freelancer
- A team
- (Eventually) multiple freelancers in parallel, but MVP tends toward 1 assignee per stage

Each stage has a “Stage Type,” which drives UI, approval rules, completion signals, and payment triggers.

#### 2.2.1 File Based
Typical freelancer types:
- Create (design, code, copywriting)
- Run / Execute (do the task and provide output)
- Test / Tweak (QA report, improved version)
What delivery looks like:
- Deliverable is a file, zip, doc, or link.
- Stage is marked “submitted” when files are uploaded as a Submission.
Tabs:
- Chat
- Attachments
- Details
- Submissions (required for File Based)

#### 2.2.2 Session Based
Typical freelancer types:
- Educate
- Advise
What delivery looks like:
- A booked call / session between creator and freelancer.
- Completion is logged after the session happens.
Tabs:
- Chat
- Attachments
- Details
- Calendar (session scheduling tab)

#### 2.2.3 Group Session Based
Typical freelancer types:
- Educate (group coaching / training class)
What delivery looks like:
- A live session with multiple attendees (e.g. 1 freelancer coach + 10 attendees from the creator’s team or audience).
- Completion is attendance + confirmation by the creator.
Tabs:
- Chat
- Attachments
- Details
- Calendar
- Attendees (list of registered participants, attendance log)

#### 2.2.4 Management Based
Typical freelancer types:
- Empower / Manage
(Example: project manager / producer / coordinator role.)
What delivery looks like:
- Ongoing coordination, reporting, decisions, directing other contributors.
- Completion may be time-bound (e.g. “2 weeks of PM coverage”).
Tabs:
- Chat
- Attachments
- Details
No special Submission tab because the “output” is the process itself, not one packaged file.

#### 2.2.5 Maintenance Based
Typical freelancer types:
- Execute
- Test / Tweak
(Example: “Keep the landing page updated weekly,” “Monthly bug fixes,” “Social calendar maintenance”.)
What delivery looks like:
- Ongoing recurring work for a period or retainer.
- Completion is either:
  - a recurring billing cycle (weekly/monthly), OR
  - explicit “maintenance complete” for this window.
Tabs:
- Chat
- Attachments
- Details
- Submissions (can be used to log periodic drops/updates)

---

### 2.3 Mapping Freelancer Types ↔ Stage Types

- Create → File Based  
  (Designer delivers Figma file, Developer delivers repo, Writer delivers copy doc.)
- Run / Execute → File Based or Maintenance Based  
  (VA uploads spreadsheets, marketing operator posts campaign reports weekly.)
- Educate → Session Based  
  (1:1 coaching call.)
- Educate (Group) → Group Session Based  
  (Training workshop for 20 employees.)
- Advise → Session Based  
  (Consulting, strategy call, technical guidance call.)
- Test / Tweak → File Based or Maintenance Based  
  (QA report, code review, performance audit, copy edit pass.)
- Empower / Manage → Management Based  
  (Project manager keeps everyone moving, communicates status, tracks blockers.)

This matters because:
- Different stage types imply different “what counts as done”.
- Different stage types change which tabs are shown in the UI.
- Different stage types can affect how escrow pays out.

---

### 2.4 Staffing a Stage (Hiring flow)

A stage can be filled in two main ways:

1. Creator browses and directly invites a freelancer or team.
2. Freelancers/teams apply to open stages of public or semi-public projects.

Hiring flow:
1. Creator selects a stage like “UI Design (File Based)”.
2. Creator views suggested freelancers / teams with matching skills.
3. Creator invites one (or more) to take that stage.
4. Invitee accepts.

When accepted:
- `projects.stage_assignments` is populated with who’s responsible.
- Stage status moves from `open` → `assigned` → `in_progress`.

If a team is hired, the team lead can internally assign sub-work. The platform does not need to micromanage internal distribution at MVP; we only track which team is accountable to deliver.

---

### 2.5 Funding & Escrow (Before work starts)

Before work officially starts, the Creator must fund that stage.

``` text
Stage "Design Landing Page" (File Based)
status: open
↓
Creator selects freelancer or team
↓
Platform calculates cost from stage_budget_rules
↓
Creator clicks "Fund Stage"
↓
Escrow created in finance.escrows
- status = funded
- amount_cents = agreed fee
↓
Stage moves to in_progress
Freelancer/team starts work
```

This prevents “do work first, maybe get paid later.”  
Funds sit in escrow, not yet released to the freelancer/team.

---

### 2.6 Collaboration During the Stage

Every stage has a “Stage Room” (like a mini workspace). Tabs:

- Chat  
  Real-time thread between the creator and the assigned freelancer/team (plus PM, plus anyone else allowed on that stage).
- Attachments  
  Shared files (stored in `attachments` bucket, mapped through `comms.message_attachments`, etc.).
- Details  
  Scope, acceptance criteria, deadlines, budget, revision terms.
- Submissions  
  (File Based / Maintenance Based only) Formal handover of deliverables. This is how payment approval is triggered.
- Calendar  
  (Session Based / Group Session Based only) Schedule, upcoming calls.
- Attendees  
  (Group Session Based only) Who’s attending the session(s), attendance history.

For Management Based stages:
- The PM / coordinator is expected to keep Chat, Details, and Attachments updated.  
- There is often no “final file,” just reporting and management outcomes.

---

### 2.7 Submission, Review, and Approval

For File Based and Maintenance Based stages:
1. Freelancer/team uploads final deliverable(s) to Submissions.
2. Stage status moves to `submitted`.
3. Creator reviews.

The creator now has 3 options:
- Approve  
- Request Revision  
- Dispute

#### Approve
- Stage status: `approved`.
- Escrow is released.
- Freelancer/team wallet is credited (transactions + payouts).

#### Request Revision
- Stage status: `revisions`.
- A `stage_revision_request` record is created:
  - type: minor | major
  - reason / requested changes
- The freelancer/team updates the work and resubmits.
- This can repeat, but eventually should converge to approval or dispute.

#### Dispute
- If the creator claims “this is not what we agreed,” “low quality,” “fraud,” etc., they can open a dispute tied to that stage’s escrow.
- finance.disputes is created:
  - opened_by_profile
  - reason
  - status = open
- Both parties can post statements / evidence into `finance.dispute_messages`.
- A moderator can escalate, rule, refund, partially release, etc.
- Stage is blocked from payout until dispute is resolved.

---

### 2.8 Session Based & Group Session Based completion

For these stage types, “submission” is not a file. It’s “did the session happen?”

- After the scheduled call/session:
  - Freelancer/team marks session delivered.
  - Creator confirms attendance and value received.
  - Creator can Approve, Request Revision (rare: e.g. “this session never happened / you didn’t show”), or Dispute.

For Group Session Based:
- Creator can confirm attendee list vs. what was promised.
- Freelancers/coaches get paid upon approval.

---

### 2.9 Management Based completion

Management Based stages (Empower / Manage type) are usually:
- “2 weeks project management”
- “Campaign coordination for October”
- “Launch oversight until go-live date”

They close when:
- The agreed period ends
- The creator is satisfied that the PM/manager fulfilled the agreed responsibilities

Approval then triggers escrow release.

If the creator claims “you didn’t actually manage anything,” that can become a dispute.

---

### 2.10 Maintenance Based & Retainers

Maintenance Based stages can act like mini-retainers or recurring upkeep:
- “Ongoing bug fixes for 30 days”
- “Weekly content uploads”
- “Monthly social media upkeep”

Two patterns:
- As one stage within a larger project (single billing window)
- As recurring contract (post-launch maintenance, long-term relationship)

In the recurring case, this evolves into something like a `maintenance_contract`:
- amount per period
- renewal cadence (weekly/monthly)
- who’s responsible

Payment is sliced per billing window and approved like any other stage window. This can be auto-approved if no dispute is filed by cutoff.

---

## 3. Single-Stage Projects

Not every job needs a complex multi-stage project.

Example use cases:
- “Write me a blog post”
- “Run an audit call for my landing page”
- “Coach my team for 1 hour”
- “Fix this bug”
- “Manage my launch this weekend”

Flow is simpler:

``` text
Creator → New Project
↓
Add one Stage only
  e.g. "SEO audit call" (Session Based)
  or "Fix Stripe webhook bug" (File Based)
↓
Invite freelancer OR pick from suggestions
↓
Fund escrow
↓
Work happens
↓
Submission or Session Complete
↓
Approve → Release escrow
(Or Revision / Dispute)
↓
Project marked completed
```

In DB terms:
- projects.projects has one row
- projects.project_stages has exactly one row
- After approval and payout, project.status becomes `completed`

This is crucial for early adoption: very low friction, same trust mechanics.

---

## 4. Disputes and IP Ownership

### 4.1 Disputes

A dispute can be opened when:
- Work not delivered
- Work delivered but not matching scope
- Work quality is unacceptable
- Freelancer says creator is abusing revision requests
- Session did not occur as claimed
- Breach of terms / harassment / non-payment
- IP misuse

What happens when a dispute opens:
1. finance.disputes row is created (status = open).
2. Linked to escrow for that stage (so funds are locked).
3. Both parties can submit evidence/messages (finance.dispute_messages).
4. Moderator is notified.

Outcomes:
- Release full escrow to freelancer/team.
- Refund full escrow to creator.
- Split escrow (partial payout).
- Mark as resolved with notes.
- In extreme cases: suspend accounts, flag IP, restrict withdrawals.

The RLS model ensures only involved parties plus moderators can see the dispute data.

### 4.2 IP & Licensing

We need IP clarity because:
- You explicitly said you want freelancers and creators to both be able to reuse work unless they choose otherwise.
- You also said you'd like the platform to carry liability.

So at stage creation / agreement, we capture an “IP mode” for that stage:
- Exclusive Transfer — Creator fully owns the deliverable.
- Licensed Use — Creator can use it commercially, but freelancer retains rights to resell.
- Internal/Non-Commercial — Coaching / strategy / internal insights that aren’t to be resold.
- Public / Template — Work that was already a template or asset and can be resold (think marketplace item).

This IP mode should live in stage details (either within `projects.project_stages` or a related `stage_contract_terms` table in the future).

Why:
- In a dispute that claims “you’re reselling my brand assets,” the moderator checks that selected IP mode.
- Reviews/ratings can mention “Delivered exclusive rights as promised,” which protects both sides.

During dispute resolution over IP:
- Moderator can instruct takedown / forbid resale / require removal from marketplace.
- Moderator’s decision goes into `finance.disputes.resolution_notes`.

---

## 5. End State of a Project

Project is considered done when:
- All stages are approved and paid out, OR
- All remaining stages are cancelled/removed, and whatever is left is not owed.

End-of-project flow:

``` text
All stages either:
  - approved + paid
  - cancelled
  - resolved via dispute
↓
Creator leaves ratings for freelancers / teams
↓
Freelancers / teams rate the creator (mutual rating system)
↓
Project is archived as completed
↓
Its assets (final deliverables, transcripts, etc.) stay accessible in project files
↓
Wallets updated, payouts queued
```

After completion:
- Ratings affect discoverability.
- Assets can optionally be turned into marketplace items (future phase):  
  e.g. “the landing page template we built for you could be sold as a generic template,” depending on IP mode.

---

## 6. Flow Library (Quick Reference)

Below are the core flows in short form.

### 6.1 User Onboarding Flow (Freelancer or Creator)

``` text
Sign Up / Login
↓
Email Verify
↓
Pick Role (Hire vs Work)
↓
System creates profile(s)
↓
Payment setup:
  - Creator: add funding method
  - Freelancer/Team: add payout info
↓
Land in dashboard with proper context
```

---

### 6.2 Project Creation Flow (Creator)

``` text
Dashboard → New Project
↓
Pick Template OR Custom
↓
Auto-generate stages (with Stage Type + suggested pricing)
↓
Tweak stages / scope / IP mode / budget rules
↓
Save Draft
```

---

### 6.3 Staffing & Funding Flow

``` text
For each Stage:
  Invite freelancer OR team
  ↓
  Assignee accepts
  ↓
  Creator funds escrow
  ↓
  Stage moves to in_progress
  ↓
  Collaboration begins in Stage Room
```

---

### 6.4 Delivery & Approval Flow

For File Based / Maintenance Based:
``` text
Freelancer submits deliverable
↓
Creator reviews
↓
Approve → escrow releases → payout
OR
Request Revision → stage_revision_request logged
OR
Open Dispute → funds locked, moderator notified
```

For Session Based / Group Session Based:
``` text
Session happens
↓
Creator confirms attendance/value
↓
Approve → escrow releases → payout
OR
Mark "didn't happen" → dispute
```

For Management Based:
``` text
Time window ends
↓
Creator marks satisfied or not
↓
Approve → payout
OR
Dispute quality of management
```

---

### 6.5 Dispute Flow

``` text
Creator OR Freelancer opens Dispute on a Stage
↓
finance.disputes row created
↓
Dispute Messages open (evidence, conversation)
↓
Moderator review
↓
Moderator resolves:
- release funds
- partial split
- refund
- restrict IP reuse if applicable
↓
Stage + Project updated accordingly
↓
Ratings still can proceed
```

---

### 6.6 Project Completion Flow

``` text
All stages finalized (approved/cancelled/resolved)
↓
Project marked completed
↓
Both sides rate each other
↓
Final assets remain accessible
↓
Wallets / payouts finalized
↓
Project archived
```

---

## 7. Why this matters for build order

From an engineering standpoint:
1. You cannot build “projects” in isolation — you need:
   - Onboarding (session_context in JWT)
   - Stage types (so UI knows which tabs to render)
   - Escrow (for trust)
2. You cannot build payouts without:
   - Submission → Approval → Release trigger
   - Dispute path
3. You cannot build retention / long-tail revenue without:
   - Maintenance Based stages / maintenance contracts
4. You cannot scale trust without:
   - Ratings
   - IP mode logging
   - Audit trails
   - Dispute messaging

All of that informs tables like:
- `projects.stage_revision_requests`
- `finance.disputes` + `finance.dispute_messages`
- `projects.maintenance_contracts`
- `finance.wallets`, `finance.escrows`, `finance.transactions`
- `finance.ratings`

And all of that ties back to access control via RLS using `active_profile_id` and `active_team_id`.

---

## 8. TL;DR Core Flows You Now Have Spec’d

- Onboarding (account creation → active profile)
- Payment setup (funding & payout)
- Project creation (custom or template)
- Stage typing (File, Session, Group Session, Management, Maintenance)
- Hiring & escrow funding
- Workroom collaboration per stage (Chat / Attachments / Details / etc.)
- Submission / approval / revision loop
- Disputes, including IP edge cases
- Ratings and closeout
- Single-stage “micro-projects”
- Long-running “maintenance / retainer” stages

This document should live in `docs/product/user-flows.md` in the repo, next to `UserStories.md` and `Sitemap.md`.

```

### File: docs\09_Tables.md

```md
# Projective Database Schema (Relational Model)

Format: Table-per-entity with columns, types, PK/FK notes\
Date: 25 Oct 2025 (revised for client profiles & future organisations)\
Status: UPDATED (includes maintenance contracts, revision requests, dispute messages, subscriptions,
portfolios, organisation scaffolding, column refinements)

---

## ENUMS

### `profile_type`

| Value        | Description                          |
| ------------ | ------------------------------------ |
| `freelancer` | A freelancer profile context         |
| `business`   | A business / creator profile context |

> Used where a row is “owned” by a freelancer or business profile.\
> **Note:** Future `organisation` entities are modelled separately and use explicit FKs instead of
> this enum.

### `assignment_type`

| Value        | Description                               |
| ------------ | ----------------------------------------- |
| `freelancer` | Stage is assigned to a freelancer profile |
| `team`       | Stage is assigned to a team               |

### `visibility`

| Value         | Description                                 |
| ------------- | ------------------------------------------- |
| `public`      | Visible in search / market                  |
| `invite_only` | Only visible to invited collaborators/teams |

### `project_status`

| Value       | Description                        |
| ----------- | ---------------------------------- |
| `draft`     | Project created but not yet active |
| `active`    | In progress                        |
| `on_hold`   | Paused                             |
| `completed` | Finished and archived              |
| `cancelled` | Killed before completion           |

### `stage_status`

| Value         | Description                                             |
| ------------- | ------------------------------------------------------- |
| `open`        | Stage exists but not yet staffed                        |
| `assigned`    | Someone has been assigned but hasn't accepted / started |
| `in_progress` | Actively being worked on                                |
| `submitted`   | Work / session delivered for approval                   |
| `approved`    | Buyer/creator approved deliverable                      |
| `revisions`   | Creator requested changes / corrections                 |
| `paid`        | Escrow released / payout processed                      |

### `dispute_status`

| Value          | Description                       |
| -------------- | --------------------------------- |
| `open`         | Dispute filed                     |
| `under_review` | Moderator actively mediating      |
| `resolved`     | Outcome decided                   |
| `refunded`     | Payout refunded (full or partial) |

---

## 1. Supabase built-ins (`auth`, `storage`)

### Table: `auth.users`

| Column     | Type        | Notes                      |
| ---------- | ----------- | -------------------------- |
| id         | uuid        | PK                         |
| email      | text        | Unique per user (Supabase) |
| phone      | text        |                            |
| created_at | timestamptz |                            |
| updated_at | timestamptz |                            |

### Table: `auth.identities`

| Column        | Type        | Notes                                  |
| ------------- | ----------- | -------------------------------------- |
| id            | uuid        | PK                                     |
| user_id       | uuid        | FK → `auth.users.id`                   |
| provider      | text        | e.g. `email`, `github`, `google`, etc. |
| identity_data | jsonb       | Provider payload                       |
| created_at    | timestamptz |                                        |

### Table: `storage.buckets`

| Column     | Type        | Notes |
| ---------- | ----------- | ----- |
| id         | text        | PK    |
| name       | text        |       |
| created_at | timestamptz |       |

### Table: `storage.objects`

| Column     | Type        | Notes                                           |
| ---------- | ----------- | ----------------------------------------------- |
| id         | uuid        | PK                                              |
| bucket_id  | text        | FK → `storage.buckets.id`                       |
| name       | text        | Full path inside bucket (unique per bucket)     |
| owner      | uuid        | Owner user_id or profile id depending on policy |
| metadata   | jsonb       | sha256, mime_type, etc.                         |
| created_at | timestamptz |                                                 |
| updated_at | timestamptz |                                                 |

---

## 2. Security Schema (`security`)

### Table: `security.session_context`

| Column              | Type         | Notes                                                       |
| ------------------- | ------------ | ----------------------------------------------------------- |
| user_id             | uuid         | PK, FK → `auth.users.id`                                    |
| active_profile_type | profile_type | `freelancer` or `business`                                  |
| active_profile_id   | uuid         | The currently active freelancer_profile or business_profile |
| active_team_id      | uuid         | Active team context (if acting "as team")                   |
| updated_at          | timestamptz  | Last context switch                                         |

### Table: `security.audit_logs`

| Column           | Type        | Notes                                                                         |
| ---------------- | ----------- | ----------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                            |
| user_id          | uuid        | FK → `auth.users.id`                                                          |
| action           | text        | e.g. `stage.approved`, `profile.updated`, `dispute.opened`                    |
| entity_table     | text        | Logical target table name (`projects.project_stages`, etc.)                   |
| entity_id        | uuid        | Entity row id                                                                 |
| metadata         | jsonb       | Arbitrary contextual data                                                     |
| ip               | inet        | Calling IP                                                                    |
| created_at       | timestamptz | Timestamp                                                                     |
| request_id       | uuid        | (NEW) Correlates platform logs / trace id                                     |
| actor_profile_id | uuid        | (NEW) Active profile the user was acting as at the time (mirrors RLS context) |
| actor_team_id    | uuid        | (NEW) Active team context (if any)                                            |
| user_agent       | text        | (NEW) Captured UA / client info for abuse/fraud audit                         |

### Table: `security.turnstile_verifications`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| user_id      | uuid        | FK-ish (nullable before auth) |
| ip           | inet        | IP of request                 |
| token_prefix | text        | Partial token for reference   |
| success      | boolean     | CAPTCHA success               |
| created_at   | timestamptz | Timestamp                     |

### Table: `security.feature_flags`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| key        | text        | PK (flag key)            |
| enabled    | boolean     | Feature on/off           |
| payload    | jsonb       | Extra config for rollout |
| updated_at | timestamptz |                          |

---

## 3. Org Schema (`org`)

Users, freelancer profiles, client business profiles, teams, skills, attachments, emails,
portfolios, and (future) multi-user organisations.

### Table: `org.users_public`

| Column       | Type        | Notes                    |
| ------------ | ----------- | ------------------------ |
| user_id      | uuid        | PK, FK → `auth.users.id` |
| display_name | text        | Public-facing name       |
| avatar_url   | text        | Signed URL / storage ref |
| country      | text        | Optional                 |
| created_at   | timestamptz |                          |

> Public but still served under RLS; safe to show to any authenticated user.

---

### Table: `org.freelancer_profiles`

| Column      | Type        | Notes                                                              |
| ----------- | ----------- | ------------------------------------------------------------------ |
| id          | uuid        | PK                                                                 |
| user_id     | uuid        | FK → `auth.users.id`, UNIQUE (1 freelancer profile per human user) |
| headline    | text        | Short pitch (e.g. “Logo Designer                                   |
| bio         | text        | Profile description                                                |
| hourly_rate | integer     | Optional, rough signalling                                         |
| visibility  | visibility  | `public` or `invite_only`                                          |
| skills      | text[]      | Skill tags / fast filter                                           |
| languages   | text[]      | e.g. `{"English","Spanish"}`                                       |
| timezone    | text        | IANA string or human label (e.g. `Europe/London`)                  |
| country     | text        | For location filters                                               |
| created_at  | timestamptz |                                                                    |

> This is the main “seller” identity.\
> Social/portfolio links are stored in `org.profile_links` and `org.portfolios`.

---

### Table: `org.business_profiles` (client-facing profiles, MVP + future-proofed)

These are **lightweight client profiles** owned by a single human.\
They cover individual clients and small businesses that don’t need full organisation features.

| Column           | Type        | Notes                                                                                      |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                         |
| owner_user_id    | uuid        | FK → `auth.users.id` (who controls this client profile)                                    |
| name             | text        | Public / brand display name (“Acme Studio”, “Jane Doe – Marketing”)                        |
| headline         | text        | Short tagline (“E-commerce brand hiring design + UGC”)                                     |
| bio              | text        | “About” copy visible on the client profile page                                            |
| logo_url         | text        | Storage ref (used as avatar/logo for this client)                                          |
| country          | text        | Primary operating location                                                                 |
| languages        | text[]      | Languages this client can communicate in                                                   |
| timezone         | text        | Main timezone for meetings / deadlines                                                     |
| billing_email    | text        | Invoice recipient                                                                          |
| default_currency | text        | e.g. `GBP`, `USD` (helps with budgets and invoices)                                        |
| visibility       | visibility  | `public` for discoverable clients, `invite_only` to hide from search (optional future use) |
| plan             | text        | Current tier or plan label (`free`, `pro`, `enterprise-seed`, etc.)                        |
| created_at       | timestamptz |                                                                                            |

**Notes**

- A **single user can own multiple business_profiles** (different brands / ventures).
- Reviews left _about_ this client attach to `business_profiles.id`.
- Future **organisations** can associate many `business_profiles` under a single corporate umbrella
  without breaking this table.

---

### Table: `org.organisations` (NEW – future enterprise clients)

Represents a multi-user organisation (e.g. Google, Sony) that can have many employees and many
brands.

| Column          | Type        | Notes                                                                          |
| --------------- | ----------- | ------------------------------------------------------------------------------ |
| id              | uuid        | PK                                                                             |
| name            | text        | Organisation display name (“Google”, “Stripe”)                                 |
| legal_name      | text        | Registered legal entity name (optional initially)                              |
| logo_url        | text        | Logo / emblem                                                                  |
| country         | text        | Primary jurisdiction                                                           |
| website_url     | text        | Corporate site (used mainly for verification, not direct traffic off-platform) |
| billing_email   | text        | Central billing contact                                                        |
| plan            | text        | `enterprise`, `team`, etc.                                                     |
| verified_status | text        | `unverified`, `pending`, `verified`, `rejected`                                |
| settings        | jsonb       | Misc. org-wide settings (SSO required, 2FA policy, procurement rules, etc.)    |
| created_at      | timestamptz |                                                                                |

> MVP may not create rows here yet; this table is for Phase 3+ without requiring breaking
> migrations.

---

### Table: `org.organisation_members` (NEW – mapping users into organisations)

| Column                           | Type                                                      | Notes                                               |
| -------------------------------- | --------------------------------------------------------- | --------------------------------------------------- |
| id                               | uuid                                                      | PK                                                  |
| organisation_id                  | uuid                                                      | FK → `org.organisations.id`                         |
| user_id                          | uuid                                                      | FK → `auth.users.id`                                |
| role                             | text                                                      | e.g. `owner`, `admin`, `manager`, `buyer`, `viewer` |
| status                           | text                                                      | `active`, `invited`, `left`, `removed`              |
| created_at                       | timestamptz                                               |                                                     |
| UNIQUE(organisation_id, user_id) | Each user has at most one membership row per organisation |                                                     |

> Permissions in the app are derived from `role` + `status` on this table.\
> Reviews target the organisation itself, not individual members.

---

### Table: `org.organisation_departments` (NEW – optional departmental scoping)

| Column          | Type        | Notes                           |
| --------------- | ----------- | ------------------------------- |
| id              | uuid        | PK                              |
| organisation_id | uuid        | FK → `org.organisations.id`     |
| name            | text        | e.g. `Marketing`, `IT`, `Legal` |
| created_at      | timestamptz |                                 |

> Projects can optionally reference a department for reporting and routing.\
> MVP can ignore this; future enterprise features can hook into it.

---

### Table: `org.teams`

| Column        | Type        | Notes                                      |
| ------------- | ----------- | ------------------------------------------ |
| id            | uuid        | PK                                         |
| name          | text        | Team brand / label                         |
| owner_user_id | uuid        | FK → `auth.users.id` (ultimate controller) |
| description   | text        | Pitch / positioning                        |
| visibility    | visibility  | `public` or `invite_only`                  |
| created_at    | timestamptz |                                            |

### Table: `org.team_memberships`

| Column                   | Type               | Notes                                   |
| ------------------------ | ------------------ | --------------------------------------- |
| id                       | uuid               | PK                                      |
| team_id                  | uuid               | FK → `org.teams.id`                     |
| user_id                  | uuid               | FK → `auth.users.id`                    |
| role                     | text               | e.g. `freelancer`, `team_lead`, `admin` |
| status                   | text               | e.g. `active`, `invited`, `left`        |
| created_at               | timestamptz        |                                         |
| UNIQUE(team_id, user_id) | Enforced via index |                                         |

### Table: `org.team_roles`

| Column      | Type  | Notes                                   |
| ----------- | ----- | --------------------------------------- |
| id          | uuid  | PK                                      |
| team_id     | uuid  | FK → `org.teams.id`                     |
| title       | text  | e.g. "Designer", "PM", "QA Lead"        |
| permissions | jsonb | Serialized permission map for that role |

### Table: `org.org_invitations`

| Column              | Type        | Notes                                                             |
| ------------------- | ----------- | ----------------------------------------------------------------- |
| id                  | uuid        | PK                                                                |
| inviter_user_id     | uuid        | FK → `auth.users.id`                                              |
| target_email        | text        | Invitation target                                                 |
| team_id             | uuid        | FK → `org.teams.id` (optional depending on invite type)           |
| business_profile_id | uuid        | FK → `org.business_profiles.id` (optional)                        |
| organisation_id     | uuid        | FK → `org.organisations.id` (optional, future enterprise invites) |
| token               | text        | Secure/random token                                               |
| status              | text        | `pending`, `accepted`, `declined`, `expired`                      |
| created_at          | timestamptz |                                                                   |

### Table: `org.skills`

| Column | Type | Notes                   |
| ------ | ---- | ----------------------- |
| id     | uuid | PK                      |
| slug   | text | Unique machine-readable |
| label  | text | Human-readable display  |

### Table: `org.user_skills`

| Column                         | Type         | Notes                    |
| ------------------------------ | ------------ | ------------------------ |
| user_id                        | uuid         | FK → `auth.users.id`     |
| skill_id                       | uuid         | FK → `org.skills.id`     |
| proficiency                    | smallint     | User self-rating / level |
| PRIMARY KEY(user_id, skill_id) | Composite PK |                          |

### Table: `org.attachments`

| Column            | Type        | Notes                                                        |
| ----------------- | ----------- | ------------------------------------------------------------ |
| id                | uuid        | PK                                                           |
| owner_profile_id  | uuid        | The freelancer/business profile that "owns" this attachment  |
| bucket            | text        | FK → `storage.buckets.id` (e.g. `attachments`, `chat`, etc.) |
| path              | text        | Object path in bucket                                        |
| original_filename | text        | Client-side filename at upload time                          |
| display_name      | text        | User-editable "pretty name"                                  |
| mime_type         | text        | Sanitized / validated                                        |
| size_bytes        | bigint      |                                                              |
| sha256            | text        | File integrity                                               |
| status            | text        | e.g. `draft`, `uploaded`, `quarantined`, `clean`             |
| created_at        | timestamptz |                                                              |
| updated_at        | timestamptz |                                                              |

### Table: `org.user_emails`

| Column                 | Type               | Notes                                  |
| ---------------------- | ------------------ | -------------------------------------- |
| id                     | uuid               | PK                                     |
| user_id                | uuid               | FK → `auth.users.id`                   |
| email                  | text               | Secondary / alternate emails           |
| is_primary             | boolean            | Exactly one per user should be primary |
| verified_at            | timestamptz        | Null until verified                    |
| created_at             | timestamptz        |                                        |
| UNIQUE(user_id, email) | Prevent duplicates |                                        |

---

### Table: `org.portfolios`

| Column                | Type        | Notes                                                       |
| --------------------- | ----------- | ----------------------------------------------------------- |
| id                    | uuid        | PK                                                          |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`                           |
| title                 | text        | "Landing Page Redesign for Client X"                        |
| description           | text        | What was done / why it matters                              |
| cover_url             | text        | Screenshot / hero image (signed URL / preview)              |
| attachment_id         | uuid        | FK → `org.attachments.id` for source files / proof / output |
| is_public             | boolean     | Publicly viewable on freelancer profile                     |
| created_at            | timestamptz |                                                             |

### Table: `org.profile_links`

Stores social/portfolio links for both freelancers and business profiles.

| Column       | Type         | Notes                                                                                       |
| ------------ | ------------ | ------------------------------------------------------------------------------------------- |
| id           | uuid         | PK                                                                                          |
| profile_type | profile_type | `freelancer` or `business`                                                                  |
| profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `profile_type` |
| kind         | text         | `github`, `behance`, `dribbble`, `linkedin`, `youtube`, `website`, `other`                  |
| url          | text         | Validated URL                                                                               |
| is_public    | boolean      | Whether link is shown on the public profile                                                 |
| created_at   | timestamptz  |                                                                                             |

**Notes**

- UI can restrict certain `kind` values (e.g. hide `website` for MVP if you want to reduce
  off-platform leakage).
- Schema is flexible enough for future changes without new tables.

---

## 4. Projects Schema (`projects`)

Projects, stages, assignments, revisions, submissions, maintenance contracts, activity log.

### Table: `projects.projects`

| Column             | Type           | Notes                                                                                        |
| ------------------ | -------------- | -------------------------------------------------------------------------------------------- |
| id                 | uuid           | PK                                                                                           |
| client_business_id | uuid           | FK → `org.business_profiles.id` (the hiring creator / buyer profile for MVP and SMB clients) |
| title              | text           | Project name / headline                                                                      |
| description        | text           | Goals / scope                                                                                |
| status             | project_status | `draft`, `active`, `completed`, etc.                                                         |
| created_at         | timestamptz    |                                                                                              |

**Notes**

- For **MVP**, only `client_business_id` is populated; `organisation_id` / `department_id` remain
  NULL.
- For enterprise, `organisation_id` becomes the primary “owner” for reporting; `client_business_id`
  can represent a specific brand or sub-account under that org.

---

### Table: `projects.project_stages`

| Column       | Type         | Notes                                                                                |
| ------------ | ------------ | ------------------------------------------------------------------------------------ |
| id           | uuid         | PK                                                                                   |
| project_id   | uuid         | FK → `projects.projects.id`                                                          |
| name         | text         | e.g. "UI Design", "Coaching Call", "PM Oversight - Sprint 1"                         |
| "order"      | int          | Display order within the project                                                     |
| description  | text         | Scope / deliverables / agenda                                                        |
| status       | stage_status | `open`, `in_progress`, `submitted`, `approved`, `paid`, etc.                         |
| due_date     | timestamptz  | (NEW) Target completion date                                                         |
| completed_at | timestamptz  | (NEW) When stage was actually approved / closed                                      |
| stage_type   | text         | (Recommended) "file_based", "session", "group_session", "management", "maintenance"  |
| ip_mode      | text         | (Recommended) "exclusive_transfer", "licensed_use", "template_only", "internal_only" |
| created_at   | timestamptz  |                                                                                      |

> `stage_type` and `ip_mode` are important for UI behavior, payouts, disputes, and later licensing
> enforcement.

---

### Table: `projects.stage_budget_rules`

| Column           | Type   | Notes                                                                        |
| ---------------- | ------ | ---------------------------------------------------------------------------- |
| id               | uuid   | PK                                                                           |
| project_stage_id | uuid   | FK → `projects.project_stages.id`                                            |
| type             | text   | `fixed`, `cap`, `free`                                                       |
| amount_currency  | text   | e.g. `USD`, `GBP`                                                            |
| amount_cents     | bigint | Budget / cap / fee for that stage                                            |
| notes            | text   | Any custom pricing explanation (e.g. "First 2h free, then 50/hr up to £300") |

---

### Table: `projects.stage_assignments`

| Column                | Type            | Notes                                                                         |
| --------------------- | --------------- | ----------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                            |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                             |
| assignee_type         | assignment_type | `freelancer` or `team`                                                        |
| freelancer_profile_id | uuid            | FK → `org.freelancer_profiles.id` (nullable if assigned to team)              |
| team_id               | uuid            | FK → `org.teams.id` (nullable if assigned to single freelancer)               |
| assigned_by           | uuid            | FK → `auth.users.id` (the creator/buyer or team lead who made the assignment) |
| status                | text            | `invited`, `accepted`, `declined`, `active`                                   |
| created_at            | timestamptz     |                                                                               |

---

### Table: `projects.stage_submissions`

| Column           | Type        | Notes                                                                                                  |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                                      |
| submitted_by     | uuid        | FK → `auth.users.id` (who actually clicked submit)                                                     |
| notes            | text        | Context: "Final files attached", "Recording of session", "Maintenance summary for this billing period" |
| created_at       | timestamptz |                                                                                                        |

> Files linked to a submission will exist via `org.attachments` and tables like
> `comms.message_attachments` or a future `stage_submission_files` join.

---

### Table: `projects.stage_revision_requests`

| Column           | Type        | Notes                                                                                  |
| ---------------- | ----------- | -------------------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                      |
| requested_by     | uuid        | FK → `auth.users.id` (usually creator/business-side)                                   |
| type             | text        | `minor` or `major` (also drives potential extra budget or escalation)                  |
| reason           | text        | "The copy tone isn't what we agreed"; "You missed section 3"; "Session didn't cover X" |
| status           | text        | `open`, `in_progress`, `resolved`                                                      |
| created_at       | timestamptz |                                                                                        |
| resolved_at      | timestamptz |                                                                                        |

---

### Table: `projects.maintenance_contracts`

| Column                | Type        | Notes                               |
| --------------------- | ----------- | ----------------------------------- |
| id                    | uuid        | PK                                  |
| project_id            | uuid        | FK → `projects.projects.id`         |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`   |
| business_profile_id   | uuid        | FK → `org.business_profiles.id`     |
| amount_cents          | bigint      | Recurring cost per billing interval |
| currency              | text        | e.g. `USD`, `GBP`                   |
| interval              | text        | `weekly`, `monthly`, `quarterly`    |
| status                | text        | `active`, `paused`, `ended`         |
| created_at            | timestamptz |                                     |

> Covers ongoing "Maintenance Based" work such as retainer-style upkeep.

---

### Table: `projects.project_participants`

| Column                                       | Type                                       | Notes                                                                                            |
| -------------------------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| id                                           | uuid                                       | PK                                                                                               |
| project_id                                   | uuid                                       | FK → `projects.projects.id`                                                                      |
| profile_type                                 | profile_type                               | `freelancer` or `business`                                                                       |
| profile_id                                   | uuid                                       | Refers to `org.freelancer_profiles.id` OR `org.business_profiles.id` depending on `profile_type` |
| role                                         | text                                       | `viewer`, `collaborator`, maybe `owner`                                                          |
| UNIQUE(project_id, profile_type, profile_id) | Ensures no duplicate role rows per profile |                                                                                                  |

---

### Table: `projects.project_activity`

| Column        | Type        | Notes                                                                                               |
| ------------- | ----------- | --------------------------------------------------------------------------------------------------- |
| id            | uuid        | PK                                                                                                  |
| project_id    | uuid        | FK → `projects.projects.id`                                                                         |
| actor_user_id | uuid        | FK → `auth.users.id`                                                                                |
| kind          | text        | `status_change`, `file_upload`, `comment`, `budget_update`, etc.                                    |
| payload       | jsonb       | Arbitrary structured metadata (e.g. old_status/new_status, attachment refs, message ids)            |
| entity_table  | text        | Which entity this activity is about (`projects.project_stages`, `projects.stage_submissions`, etc.) |
| entity_id     | uuid        | The specific row in that entity                                                                     |
| created_at    | timestamptz |                                                                                                     |

---

## 5. Communication Schema (`comms`)

Project channels, DM threads, messages, and notification infrastructure.

### Table: `comms.project_channels`

| Column                   | Type                                                | Notes                                                                               |
| ------------------------ | --------------------------------------------------- | ----------------------------------------------------------------------------------- |
| id                       | uuid                                                | PK                                                                                  |
| project_id               | uuid                                                | FK → `projects.projects.id`                                                         |
| name                     | text                                                | `#general`, `#design`, etc. Must be unique per project                              |
| stage_id                 | uuid                                                | FK → `projects.project_stages.id` (optional: a stage-specific room like `#stage-2`) |
| visibility               | text                                                | `project_all` or `owner_and_assignees`                                              |
| created_at               | timestamptz                                         |                                                                                     |
| UNIQUE(project_id, name) | Prevent duplicate channel names inside same project |                                                                                     |

---

### Table: `comms.project_channel_participants`

| Column                                       | Type                                             | Notes                                |
| -------------------------------------------- | ------------------------------------------------ | ------------------------------------ |
| id                                           | uuid                                             | PK                                   |
| channel_id                                   | uuid                                             | FK → `comms.project_channels.id`     |
| profile_type                                 | profile_type                                     | `freelancer` or `business`           |
| profile_id                                   | uuid                                             | The profile in that channel          |
| role                                         | text                                             | `viewer`, `participant`, `moderator` |
| created_at                                   | timestamptz                                      |                                      |
| UNIQUE(channel_id, profile_type, profile_id) | Ensures no duplicate memberships in same channel |                                      |

---

### Table: `comms.project_messages`

| Column                        | Type                         | Notes                                   |
| ----------------------------- | ---------------------------- | --------------------------------------- |
| id                            | uuid                         | PK                                      |
| channel_id                    | uuid                         | FK → `comms.project_channels.id`        |
| sender_user_id                | uuid                         | FK → `auth.users.id`                    |
| body                          | text                         | Message text                            |
| created_at                    | timestamptz                  |                                         |
| edited_at                     | timestamptz                  | Null unless edited                      |
| deleted_at                    | timestamptz                  | Soft-delete flag for moderation / audit |
| INDEX(channel_id, created_at) | For chronological pagination |                                         |

---

### Table: `comms.dm_threads`

| Column             | Type        | Notes                |
| ------------------ | ----------- | -------------------- |
| id                 | uuid        | PK                   |
| created_by_user_id | uuid        | FK → `auth.users.id` |
| created_at         | timestamptz |                      |

### Table: `comms.dm_participants`

| Column                     | Type                                         | Notes                      |
| -------------------------- | -------------------------------------------- | -------------------------- |
| id                         | uuid                                         | PK                         |
| thread_id                  | uuid                                         | FK → `comms.dm_threads.id` |
| user_id                    | uuid                                         | FK → `auth.users.id`       |
| joined_at                  | timestamptz                                  |                            |
| UNIQUE(thread_id, user_id) | Prevent duplicate joins for same user/thread |                            |

### Table: `comms.dm_messages`

| Column                       | Type        | Notes                      |
| ---------------------------- | ----------- | -------------------------- |
| id                           | uuid        | PK                         |
| thread_id                    | uuid        | FK → `comms.dm_threads.id` |
| sender_user_id               | uuid        | FK → `auth.users.id`       |
| body                         | text        | Message text               |
| created_at                   | timestamptz |                            |
| INDEX(thread_id, created_at) | Pagination  |                            |

---

### Table: `comms.message_attachments`

| Column                                           | Type                                            | Notes                                                               |
| ------------------------------------------------ | ----------------------------------------------- | ------------------------------------------------------------------- |
| id                                               | uuid                                            | PK                                                                  |
| message_table                                    | text                                            | `'comms.project_messages'` or `'comms.dm_messages'`                 |
| message_id                                       | uuid                                            | References the row in whichever message table `message_table` names |
| attachment_id                                    | uuid                                            | FK → `org.attachments.id`                                           |
| created_at                                       | timestamptz                                     |                                                                     |
| UNIQUE(message_table, message_id, attachment_id) | Avoid attaching same file twice to same message |                                                                     |

> Allows any message to link to uploaded files (designs, deliverables, audit logs, etc.).

---

### Table: `comms.channel_files`

| Column                                          | Type                                              | Notes                                                                            |
| ----------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------------------------------- |
| id                                              | uuid                                              | PK                                                                               |
| channel_type                                    | text                                              | `'project'` or `'dm'`                                                            |
| channel_id                                      | uuid                                              | `comms.project_channels.id` OR `comms.dm_threads.id` depending on `channel_type` |
| attachment_id                                   | uuid                                              | FK → `org.attachments.id`                                                        |
| created_at                                      | timestamptz                                       |                                                                                  |
| UNIQUE(channel_type, channel_id, attachment_id) | Each file appears once in a channel-level gallery |                                                                                  |

---

### Table: `comms.notifications`

| Column       | Type        | Notes                                                     |
| ------------ | ----------- | --------------------------------------------------------- |
| id           | uuid        | PK                                                        |
| user_id      | uuid        | FK → `auth.users.id`                                      |
| type         | text        | e.g. `message.new`, `stage.submitted`, `payment.released` |
| title        | text        | Short summary                                             |
| body         | text        | Longer description                                        |
| entity_table | text        | Where this event originated                               |
| entity_id    | uuid        | The row ID in that entity                                 |
| read_at      | timestamptz | Null until read                                           |
| created_at   | timestamptz |                                                           |

### Table: `comms.notification_prefs`

| Column      | Type      | Notes                             |
| ----------- | --------- | --------------------------------- |
| user_id     | uuid      | PK, FK → `auth.users.id`          |
| email       | boolean   | Email alerts?                     |
| push        | boolean   | Push/mobile alerts?               |
| in_app      | boolean   | In-app notifications?             |
| digest      | boolean   | Summary digests allowed?          |
| quiet_hours | tstzrange | Time range where pushes are muted |

### Table: `comms.device_tokens`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| id         | uuid        | PK                       |
| user_id    | uuid        | FK → `auth.users.id`     |
| provider   | text        | `apns`, `fcm`, `webpush` |
| token      | text        | Push token               |
| created_at | timestamptz |                          |

---

## 6. Finance Schema (`finance`)

Wallets, escrows, payments, invoices, disputes, ratings, subscriptions.

### Table: `finance.wallets`

| Column                                 | Type                              | Notes                                                         |
| -------------------------------------- | --------------------------------- | ------------------------------------------------------------- |
| id                                     | uuid                              | PK                                                            |
| owner_type                             | text                              | `freelancer`, `team`, `business`, `organisation`              |
| owner_id                               | uuid                              | The profile/team/business/organisation this wallet belongs to |
| currency                               | text                              | `USD`, `GBP`, etc.                                            |
| balance_cents                          | bigint                            | Current balance                                               |
| created_at                             | timestamptz                       |                                                               |
| UNIQUE(owner_type, owner_id, currency) | One wallet per owner per currency |                                                               |

---

### Table: `finance.transactions`

| Column                       | Type                     | Notes                                                            |
| ---------------------------- | ------------------------ | ---------------------------------------------------------------- |
| id                           | uuid                     | PK                                                               |
| wallet_id                    | uuid                     | FK → `finance.wallets.id`                                        |
| direction                    | text                     | `credit` or `debit`                                              |
| amount_cents                 | bigint                   | Movement amount                                                  |
| currency                     | text                     | Currency code                                                    |
| reason                       | text                     | `escrow_release`, `refund`, `payout`, etc.                       |
| ref_table                    | text                     | Origin reference (e.g. `finance.escrows`)                        |
| ref_id                       | uuid                     | Origin row ID                                                    |
| balance_after_cents          | bigint                   | Snapshot of wallet after this transaction (for ledger reconcile) |
| created_at                   | timestamptz              |                                                                  |
| INDEX(wallet_id, created_at) | For statements / history |                                                                  |

---

### Table: `finance.escrows`

| Column                | Type            | Notes                                                                                     |
| --------------------- | --------------- | ----------------------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                                        |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                                         |
| payer_business_id     | uuid            | FK → `org.business_profiles.id` (who funded the stage)                                    |
| payer_organisation_id | uuid            | FK → `org.organisations.id` (optional; for enterprise payers)                             |
| payee_type            | assignment_type | `freelancer` or `team`                                                                    |
| payee_id              | uuid            | Points to either `org.freelancer_profiles.id` OR `org.teams.id` depending on `payee_type` |
| amount_cents          | bigint          | Escrowed amount                                                                           |
| currency              | text            |                                                                                           |
| status                | text            | `funded`, `released`, `refunded`, `disputed`                                              |
| created_at            | timestamptz     |                                                                                           |

---

### Table: `finance.payout_accounts`

| Column                       | Type                     | Notes                                                              |
| ---------------------------- | ------------------------ | ------------------------------------------------------------------ |
| id                           | uuid                     | PK                                                                 |
| owner_type                   | text                     | `freelancer`, `team`, `business`, `organisation`                   |
| owner_id                     | uuid                     | Profile / team / business / organisation referencing who gets paid |
| provider                     | text                     | `stripe`, etc.                                                     |
| account_id                   | text                     | External payout account reference                                  |
| status                       | text                     | `active`, `pending_verification`, `disabled`, etc.                 |
| UNIQUE(provider, account_id) | Avoid duplicate bindings |                                                                    |

---

### Table: `finance.invoices`

| Column                   | Type        | Notes                                                                 |
| ------------------------ | ----------- | --------------------------------------------------------------------- |
| id                       | uuid        | PK                                                                    |
| project_stage_id         | uuid        | FK → `projects.project_stages.id`                                     |
| issue_to_business_id     | uuid        | FK → `org.business_profiles.id` (buyer profile)                       |
| issue_to_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer)              |
| issue_from_profile       | uuid        | The freelancer profile / team / business that is issuing this invoice |
| amount_cents             | bigint      |                                                                       |
| currency                 | text        |                                                                       |
| status                   | text        | `draft`, `sent`, `paid`, `void`                                       |
| created_at               | timestamptz |                                                                       |

---

### Table: `finance.disputes`

| Column            | Type           | Notes                                                               |
| ----------------- | -------------- | ------------------------------------------------------------------- |
| id                | uuid           | PK                                                                  |
| escrow_id         | uuid           | FK → `finance.escrows.id` (the pot of money being fought over)      |
| opened_by_profile | uuid           | The profile_id (business or freelancer/team) who opened the dispute |
| reason            | text           | Human-readable complaint                                            |
| status            | dispute_status | `open`, `under_review`, `resolved`, `refunded`                      |
| resolution_notes  | text           | Moderator notes / final decision                                    |
| created_at        | timestamptz    |                                                                     |

### Table: `finance.dispute_messages`

| Column         | Type        | Notes                                  |
| -------------- | ----------- | -------------------------------------- |
| id             | uuid        | PK                                     |
| dispute_id     | uuid        | FK → `finance.disputes.id`             |
| sender_user_id | uuid        | FK → `auth.users.id`                   |
| body           | text        | Message / statement / evidence summary |
| created_at     | timestamptz |                                        |

> Internal "conversation" log for mediation / escalation during a dispute.

---

### Table: `finance.ratings`

| Column        | Type        | Notes                                            |
| ------------- | ----------- | ------------------------------------------------ |
| id            | uuid        | PK                                               |
| project_id    | uuid        | FK → `projects.projects.id`                      |
| rater_profile | uuid        | The profile who is leaving the rating            |
| ratee_type    | text        | `freelancer`, `team`, `business`, `organisation` |
| ratee_id      | uuid        | Profile/team/business/organisation being rated   |
| score         | smallint    | 1-5 stars                                        |
| comment       | text        | Public / semi-public feedback                    |
| created_at    | timestamptz |                                                  |

> This supports: freelancers rating clients (business or organisation) and clients rating
> freelancers/teams.

---

### Table: `finance.subscriptions`

| Column     | Type        | Notes                                                                           |
| ---------- | ----------- | ------------------------------------------------------------------------------- |
| id         | uuid        | PK                                                                              |
| profile_id | uuid        | The paying entity (freelancer_profile, team, business_profile, or organisation) |
| plan       | text        | Plan tier, e.g. `free`, `pro`, `team`, `enterprise`                             |
| status     | text        | `active`, `canceled`, `expired`                                                 |
| started_at | timestamptz | When billing/benefits started                                                   |
| ends_at    | timestamptz | When billing/benefits end if canceled or scheduled to lapse                     |

---

## 7. Marketplace Schema (`marketplace`)

Digital assets/templates for sale and purchase.

### Table: `marketplace.assets`

| Column            | Type        | Notes                                                   |
| ----------------- | ----------- | ------------------------------------------------------- |
| id                | uuid        | PK                                                      |
| seller_profile_id | uuid        | The freelancer/team/business profile selling this asset |
| title             | text        | Asset name                                              |
| description       | text        | Marketing copy                                          |
| preview_url       | text        | Public-ish preview (signed URL or downsample)           |
| file_ref          | text        | Internal reference to storage path of original asset    |
| category          | text        | For browsing / filtering                                |
| price_cents       | bigint      |                                                         |
| currency          | text        |                                                         |
| license_type      | text        | `full_rights`, `template_only`, etc.                    |
| status            | text        | `draft`, `published`                                    |
| created_at        | timestamptz |                                                         |

---

### Table: `marketplace.asset_versions`

| Column     | Type        | Notes                                       |
| ---------- | ----------- | ------------------------------------------- |
| id         | uuid        | PK                                          |
| asset_id   | uuid        | FK → `marketplace.assets.id`                |
| version    | int         | Version number                              |
| changelog  | text        | "Updated icons", "Fixed license text", etc. |
| file_ref   | text        | Storage ref for that specific version       |
| created_at | timestamptz |                                             |

---

### Table: `marketplace.asset_purchases`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id` (buyer).                 |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| amount_cents          | bigint      | Purchase amount                                          |
| currency              | text        |                                                          |
| license_granted       | text        | Snapshot of license terms at purchase time               |
| download_token        | text        | Token to enable secure short-lived download              |
| created_at            | timestamptz |                                                          |

---

### Table: `marketplace.asset_downloads`

| Column        | Type        | Notes                                 |
| ------------- | ----------- | ------------------------------------- |
| id            | uuid        | PK                                    |
| purchase_id   | uuid        | FK → `marketplace.asset_purchases.id` |
| downloaded_at | timestamptz | Timestamp of download                 |
| ip            | inet        | IP for audit / fraud                  |

---

### Table: `marketplace.asset_ratings`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id`                          |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| score                 | smallint    | Rating (1-5)                                             |
| comment               | text        | Feedback                                                 |
| created_at            | timestamptz |                                                          |

### Table: `marketplace.services`

| Column              | Type         | Notes                                                                                |
| ------------------- | ------------ | ------------------------------------------------------------------------------------ |
| id                  | uuid         | PK                                                                                   |
| seller_profile_type | profile_type | `freelancer` or `business` (future: extend enum if teams become first-class sellers) |
| seller_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on type    |
| title               | text         | Short name of the service (“Brand Audit”, “1:1 Coaching Call”)                       |
| slug                | text         | URL-safe identifier, unique per seller (e.g. `brand-audit`)                          |
| description         | text         | Long-form description of what’s included                                             |
| category            | text         | For browsing/filtering; can align with `search.topics.slug`                          |
| service_type        | text         | `one_off`, `package`, `retainer`, `session`                                          |
| base_price_cents    | bigint       | Starting price in minor units                                                        |
| currency            | text         | e.g. `GBP`, `USD`                                                                    |
| visibility          | visibility   | `public` or `invite_only`                                                            |
| status              | text         | `draft`, `published`, `paused`, `archived`                                           |
| estimated_duration  | interval     | Optional estimate (e.g. `2 hours`, `7 days`)                                         |
| created_at          | timestamptz  |                                                                                      |
| updated_at          | timestamptz  |                                                                                      |

---

## 8. Search Schema (`search`)

Search index and saved filters.

### Table: `search.search_index`

| Column                    | Type                                            | Notes                                                   |
| ------------------------- | ----------------------------------------------- | ------------------------------------------------------- |
| id                        | uuid                                            | PK                                                      |
| entity                    | text                                            | `freelancer`, `team`, `project_template`, `asset`, etc. |
| entity_id                 | uuid                                            | The row ID in that entity                               |
| text                      | tsvector                                        | Full-text index for Postgres search                     |
| updated_at                | timestamptz                                     |                                                         |
| UNIQUE(entity, entity_id) | De-duplicate search records per entity instance |                                                         |

### Table: `search.embeddings`

| Column                    | Type        | Notes                                   |
| ------------------------- | ----------- | --------------------------------------- |
| id                        | uuid        | PK                                      |
| entity                    | text        |                                         |
| entity_id                 | uuid        |                                         |
| embedding                 | vector      | pgvector column for semantic similarity |
| updated_at                | timestamptz |                                         |
| UNIQUE(entity, entity_id) |             |                                         |

### Table: `search.user_embeddings`

| Column     | Type        | Notes                     |
| ---------- | ----------- | ------------------------- |
| user_id    | uuid        | PK, FK → `auth.users.id`  |
| embedding  | vector      | User preference embedding |
| updated_at | timestamptz | Last rebuild time         |

### Table: `search.filters`

| Column        | Type  | Notes                                                |
| ------------- | ----- | ---------------------------------------------------- |
| id            | uuid  | PK                                                   |
| owner_user_id | uuid  | FK → `auth.users.id`                                 |
| name          | text  | Human-readable label ("My SEO/Figma freelancers UK") |
| query         | jsonb | Serialized filter config                             |

### Table: `search.topics`

| Column | Type | Notes                                                            |
| ------ | ---- | ---------------------------------------------------------------- |
| id     | uuid | PK                                                               |
| slug   | text | Unique machine-readable topic name (`marketing`, `design`, etc.) |
| label  | text | Human-readable display label                                     |

### Table: `search.entity_topics`

| Column                                   | Type | Notes                                          |
| ---------------------------------------- | ---- | ---------------------------------------------- |
| entity                                   | text | Same entity type used in `search.search_index` |
| entity_id                                | uuid | FK into the corresponding table                |
| topic_id                                 | uuid | FK → `search.topics.id`                        |
| PRIMARY KEY(entity, entity_id, topic_id) |      |                                                |

```sql
-- Suggested index
CREATE INDEX entity_topics_topic_idx ON search.entity_topics (topic_id);
```

---

## 9. Ops Schema (`ops`)

Admin/moderation, outbound webhooks, email queue, rate limit tracking.

### Table: `ops.admin_users`

| Column  | Type | Notes                              |
| ------- | ---- | ---------------------------------- |
| user_id | uuid | PK, FK → `auth.users.id`           |
| role    | text | `moderator`, `admin`, `superadmin` |

### Table: `ops.moderation_flags`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| entity_table | text        | Which table/entity is flagged |
| entity_id    | uuid        | Row being flagged             |
| reason       | text        | Why it's flagged              |
| status       | text        | `open`, `reviewing`, `closed` |
| created_at   | timestamptz |                               |

### Table: `ops.webhook_outbox`

| Column        | Type        | Notes                                                       |
| ------------- | ----------- | ----------------------------------------------------------- |
| id            | uuid        | PK                                                          |
| topic         | text        | Event type e.g. `project.updated`, `payment.released`, etc. |
| payload       | jsonb       | Serialized payload                                          |
| status        | text        | `pending`, `sent`, `failed`                                 |
| retry_count   | int         | Number of retry attempts                                    |
| next_retry_at | timestamptz | When to try next                                            |
| created_at    | timestamptz |                                                             |

### Table: `ops.email_queue`

| Column     | Type        | Notes                       |
| ---------- | ----------- | --------------------------- |
| id         | uuid        | PK                          |
| to_email   | text        | Recipient                   |
| template   | text        | Template key                |
| vars       | jsonb       | Template variables          |
| status     | text        | `pending`, `sent`, `failed` |
| created_at | timestamptz |                             |

### Table: `ops.rate_limit_counters`

| Column           | Type        | Notes                                                          |
| ---------------- | ----------- | -------------------------------------------------------------- |
| id               | uuid        | PK                                                             |
| bucket_key       | text        | User/IP/bucket identifier (like `user:123-action:sendMessage`) |
| count            | int         | Count in the active rate limit window                          |
| window_starts_at | timestamptz | Start timestamp for the rolling / fixed window                 |

---

## 10. Analytics Schema (`analytics`)

Event logs + rollups.

### Table: `analytics.event_log`

| Column     | Type        | Notes                                                     |
| ---------- | ----------- | --------------------------------------------------------- |
| id         | uuid        | PK                                                        |
| user_id    | uuid        | FK → `auth.users.id`                                      |
| event      | text        | e.g. `stage.submitted`, `escrow.funded`, `dispute.opened` |
| props      | jsonb       | Extra analytics data                                      |
| created_at | timestamptz | Timestamp                                                 |

### Table: `analytics.daily_rollups`

| Column                   | Type   | Notes                                                           |
| ------------------------ | ------ | --------------------------------------------------------------- |
| day                      | date   | Part of composite PK                                            |
| metric                   | text   | Part of composite PK (e.g. `new_projects`, `escrow_volume_gbp`) |
| value                    | bigint | Metric value                                                    |
| PRIMARY KEY(day, metric) |        |                                                                 |

### Table: `analytics.entity_stats`

| Column                         | Type         | Notes                                                           |
| ------------------------------ | ------------ | --------------------------------------------------------------- |
| entity                         | text         | e.g., `freelancer`, `team`, `service`, `asset`, `article`, etc. |
| entity_id                      | uuid         | PK (together with entity)                                       |
| rating_avg                     | numeric(3,2) | Aggregated rating                                               |
| rating_count                   | integer      | Number of ratings                                               |
| views_7d                       | integer      | View count past 7 days                                          |
| clicks_7d                      | integer      | Click count past 7 days                                         |
| saves_7d                       | integer      | Save/shortlist count past 7 days                                |
| hires_7d                       | integer      | Hire/purchase count past 7 days                                 |
| views_30d                      | integer      | View count past 30 days                                         |
| hires_30d                      | integer      | Hire/purchase count past 30 days                                |
| dispute_rate                   | numeric(5,4) | Derived from finance.disputes vs completed work                 |
| last_activity_at               | timestamptz  | Last meaningful update                                          |
| PRIMARY KEY(entity, entity_id) |              |                                                                 |

```sql
CREATE INDEX entity_stats_activity_idx ON analytics.entity_stats (last_activity_at DESC);
```

### Table: `analytics.user_entity_stats`

| Column                                  | Type        | Notes                           |
| --------------------------------------- | ----------- | ------------------------------- |
| user_id                                 | uuid        | FK → `auth.users.id`            |
| entity                                  | text        | Entity type                     |
| entity_id                               | uuid        | FK into the corresponding table |
| views                                   | integer     | Total views by this user        |
| clicks                                  | integer     | Total clicks                    |
| saves                                   | integer     | Saved/shortlisted count         |
| hires                                   | integer     | Hires or purchases              |
| last_interaction_at                     | timestamptz | Most recent interaction         |
| PRIMARY KEY(user_id, entity, entity_id) |             |                                 |

```sql
CREATE INDEX user_entity_stats_user_idx ON analytics.user_entity_stats (user_id);
```

### View / Materialized View: `analytics.earnings_by_stage_mv`

| Column            | Type        | Notes                                  |
| ----------------- | ----------- | -------------------------------------- |
| project_stage_id  | uuid        | FK → `projects.project_stages.id`      |
| total_cents       | bigint      | Sum of released payouts for that stage |
| currency          | text        |                                        |
| last_refreshed_at | timestamptz | When MV was last updated               |

(Backed by SQL view / materialized view files in `/db/views/analytics/`.)

---

## 11. Integrations Schema (`integrations`)

External service hookups (GitHub, Trello, Notion, etc.).

### Table: `integrations.providers`

| Column     | Type        | Notes                                   |
| ---------- | ----------- | --------------------------------------- |
| id         | text        | PK (`github`, `trello`, `notion`, etc.) |
| label      | text        | Display name                            |
| auth_type  | text        | `oauth2`, `api_key`, `none`             |
| scopes     | text[]      | Required perms/scopes                   |
| created_at | timestamptz |                                         |

### Table: `integrations.connections`

| Column                                   | Type                                      | Notes                                                                                 |
| ---------------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------- |
| id                                       | uuid                                      | PK                                                                                    |
| provider_id                              | text                                      | FK → `integrations.providers.id`                                                      |
| owner_type                               | profile_type                              | Which profile context this belongs to (`freelancer`, `business`), or `user` if needed |
| owner_id                                 | uuid                                      | Profile or user this connection belongs to                                            |
| external_account_id                      | text                                      | External provider account identifier                                                  |
| access                                   | jsonb                                     | Encrypted tokens/config                                                               |
| status                                   | text                                      | `active`, `revoked`                                                                   |
| created_at                               | timestamptz                               |                                                                                       |
| INDEX(provider_id, owner_type, owner_id) | Helpful for "show me all my integrations" |                                                                                       |

### Table: `integrations.installs`

| Column        | Type        | Notes                              |
| ------------- | ----------- | ---------------------------------- |
| id            | uuid        | PK                                 |
| connection_id | uuid        | FK → `integrations.connections.id` |
| scope         | text        | e.g. `project:{id}` or `workspace` |
| settings      | jsonb       | Install-level configuration        |
| created_at    | timestamptz |                                    |

## 12. Content Schema (`content`)

Author-created content such as articles, guides, and thought-leadership pieces. Used to drive
discovery for sellers and educate buyers.

### Table: `content.articles`

| Column              | Type         | Notes                                                                                              |
| ------------------- | ------------ | -------------------------------------------------------------------------------------------------- |
| id                  | uuid         | PK                                                                                                 |
| author_profile_type | profile_type | `freelancer` or `business` (later extend if you want org/team-authored content)                    |
| author_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `author_profile_type` |
| title               | text         | Article title                                                                                      |
| slug                | text         | URL-safe identifier, unique per author (e.g. `how-to-brief-a-designer`)                            |
| excerpt             | text         | Short summary for cards/previews                                                                   |
| body                | text         | Main article content (Markdown or rich-text serialisation)                                         |
| cover_attachment_id | uuid         | FK → `org.attachments.id` (optional cover image)                                                   |
| tags                | text[]       | Optional tag list; for display only (search tags live in `search.entity_topics`)                   |
| visibility          | visibility   | `public` or `invite_only`                                                                          |
| status              | text         | `draft`, `published`, `archived`                                                                   |
| published_at        | timestamptz  | When article went live (NULL while draft)                                                          |
| created_at          | timestamptz  |                                                                                                    |
| updated_at          | timestamptz  |                                                                                                    |

```

### File: docs\10_APIEndpints.md

```md
# Projective API Specification

**Base URL:** `/api/v1`  
**Auth:** Bearer JWT (short-lived access)  
**Refresh:** Opaque token rotation  
**CAPTCHA:** Cloudflare Turnstile for anonymous POSTs  
**Storage:** Supabase signed URLs (60s TTL)  
**Rate Limiting:** Per-IP and per-user  
**RLS Context:** `active_profile_id`, `active_team_id`

---

## 🧩 Auth & Session

| Method | Endpoint                 | Description                                 |
| ------ | ------------------------ | ------------------------------------------- |
| POST   | `/auth/signup`           | Create account (email/password + Turnstile) |
| POST   | `/auth/login`            | Login, returns access + refresh tokens      |
| POST   | `/auth/refresh`          | Rotate refresh → new access token           |
| POST   | `/auth/logout`           | Revoke refresh token                        |
| GET    | `/auth/me`               | Get current user context                    |
| POST   | `/auth/turnstile/verify` | Verify CAPTCHA token                        |
| POST   | `/auth/switch-profile`   | Switch between freelancer/business profiles |
| POST   | `/auth/switch-team`      | Switch active team                          |

---

### Emails

| Method | Endpoint                      | Description                |
| ------ | ----------------------------- | -------------------------- |
| GET    | `/account/emails`             | List linked emails         |
| POST   | `/account/emails`             | Add email (sends verify)   |
| GET    | `/account/emails/:id`         | Check verification         |
| PATCH  | `/account/emails/:id/primary` | Make primary               |
| DELETE | `/account/emails/:id`         | Remove (guards if primary) |

---

## 👤 Users & Profiles

### Users

| Method | Endpoint     | Description           |
| ------ | ------------ | --------------------- |
| GET    | `/users/:id` | Public user info      |
| PATCH  | `/users/:id` | Update profile (self) |

### Freelancer Profiles

| Method | Endpoint           | Description                                   |
| ------ | ------------------ | --------------------------------------------- |
| GET    | `/freelancers/:id` | Get freelancer details                        |
| POST   | `/freelancers`     | Create freelancer profile                     |
| PATCH  | `/freelancers/:id` | Update freelancer info                        |
| DELETE | `/freelancers/:id` | Delete freelancer profile                     |
| GET    | `/freelancers`     | Discover freelancers (filter by skills, rate) |

### Business Profiles

| Method | Endpoint          | Description             |
| ------ | ----------------- | ----------------------- |
| GET    | `/businesses/:id` | Get business details    |
| POST   | `/businesses`     | Create business profile |
| PATCH  | `/businesses/:id` | Update business         |
| DELETE | `/businesses/:id` | Delete business profile |
| GET    | `/businesses`     | List user’s businesses  |

### Skills

| Method | Endpoint                         | Description          |
| ------ | -------------------------------- | -------------------- |
| GET    | `/skills`                        | List skill directory |
| POST   | `/users/:userId/skills`          | Add a skill to user  |
| DELETE | `/users/:userId/skills/:skillId` | Remove skill         |

### Attachments

| Method | Endpoint           | Description             |
| ------ | ------------------ | ----------------------- |
| POST   | `/attachments`     | Get signed upload URL   |
| GET    | `/attachments/:id` | Get attachment metadata |
| DELETE | `/attachments/:id` | Delete attachment       |

---

## 🧑‍🤝‍🧑 Teams & Organizations

| Method | Endpoint     | Description               |
| ------ | ------------ | ------------------------- |
| GET    | `/teams/:id` | Get team profile          |
| POST   | `/teams`     | Create new team           |
| PATCH  | `/teams/:id` | Update team               |
| DELETE | `/teams/:id` | Delete team               |
| GET    | `/teams`     | List owned & joined teams |

### Memberships

| Method | Endpoint                           | Description        |
| ------ | ---------------------------------- | ------------------ |
| POST   | `/teams/:id/members`               | Invite/add member  |
| PATCH  | `/teams/:id/members/:membershipId` | Update member role |
| DELETE | `/teams/:id/members/:membershipId` | Remove member      |

### Roles

| Method | Endpoint                   | Description |
| ------ | -------------------------- | ----------- |
| GET    | `/teams/:id/roles`         | List roles  |
| POST   | `/teams/:id/roles`         | Create role |
| PATCH  | `/teams/:id/roles/:roleId` | Update role |
| DELETE | `/teams/:id/roles/:roleId` | Delete role |

### Invitations

| Method | Endpoint                          | Description                     |
| ------ | --------------------------------- | ------------------------------- |
| POST   | `/org/invitations`                | Create invitation (email token) |
| POST   | `/org/invitations/:token/accept`  | Accept invitation               |
| POST   | `/org/invitations/:token/decline` | Decline invitation              |

---

## 🧱 Projects & Stages

| Method | Endpoint        | Description                                        |
| ------ | --------------- | -------------------------------------------------- |
| POST   | `/projects`     | Create a new project for a business or client      |
| GET    | `/projects/:id` | Get project details                                |
| PATCH  | `/projects/:id` | Update project information                         |
| DELETE | `/projects/:id` | Delete a project                                   |
| GET    | `/projects`     | List projects (filtered by role, status, or owner) |

### Stages

| Method | Endpoint                       | Description                                   |
| ------ | ------------------------------ | --------------------------------------------- |
| POST   | `/projects/:id/stages`         | Create stage(s) for a project                 |
| GET    | `/projects/:id/stages`         | List all stages for a project                 |
| PATCH  | `/stages/:stageId`             | Update a stage (status, name, etc.)           |
| PUT    | `/stages/:stageId/budget-rule` | Define pricing model (fixed, hourly, capped)  |
| POST   | `/stages/:stageId/assign`      | Assign freelancer or team to a stage          |
| DELETE | `/stages/:stageId/assign`      | Unassign freelancer or team                   |
| POST   | `/stages/:stageId/submissions` | Submit deliverables for approval              |
| GET    | `/stages/:stageId/submissions` | View stage submissions                        |
| POST   | `/stages/:stageId/approve`     | Approve the stage submission                  |
| GET    | `/projects/:id/activity`       | View recent activity or updates for a project |

### Participants & Activity

| Method | Endpoint                     | Description                |
| ------ | ---------------------------- | -------------------------- |
| POST   | `/projects/:id/participants` | Add project collaborator   |
| GET    | `/projects/:id/participants` | List participants          |
| GET    | `/projects/:id/activity`     | View project activity feed |

---

## 💬 Collaboration & Messaging

### 🧱 Project Channels

Project-based chats between the project owner and assigned freelancers/teams.  
Each project can have multiple channels — for stages, roles, or general discussion.

| Method | Endpoint                                    | Description                                                |
| ------ | ------------------------------------------- | ---------------------------------------------------------- |
| POST   | `/projects/:id/channels`                    | Create a new project channel (`#general`, `#design`, etc.) |
| GET    | `/projects/:id/channels`                    | List all channels within a project                         |
| POST   | `/project-channels/:channelId/messages`     | Send a message to a project channel                        |
| GET    | `/project-channels/:channelId/messages`     | Get messages in a project channel (paginated)              |
| GET    | `/project-channels/:channelId/files`        | View all files uploaded or shared in this channel          |
| POST   | `/project-channels/:channelId/participants` | Add or remove channel participants (by profile/team)       |

---

### 💬 Private Chats (DMs)

One-to-one or group conversations between any users on the platform.  
Ideal for team discussions or networking — fully separate from project communications.

| Method | Endpoint                          | Description                                      |
| ------ | --------------------------------- | ------------------------------------------------ |
| POST   | `/dms/threads`                    | Start a new DM or group chat with selected users |
| GET    | `/dms/threads`                    | List all your private DM threads                 |
| POST   | `/dms/threads/:threadId/messages` | Send a message to a DM thread                    |
| GET    | `/dms/threads/:threadId/messages` | Get messages in a DM thread (paginated)          |
| GET    | `/dms/threads/:threadId/files`    | View all files shared in this DM thread          |

---

### 🔔 Notifications

System and in-app alerts for messages, mentions, and activity.

| Method | Endpoint                  | Description                                             |
| ------ | ------------------------- | ------------------------------------------------------- |
| GET    | `/notifications`          | Get all notifications for the current user              |
| PATCH  | `/notifications/:id/read` | Mark notification(s) as read                            |
| GET    | `/notification-prefs`     | Retrieve notification preferences (email, push, digest) |
| PUT    | `/notification-prefs`     | Update notification preferences                         |
| POST   | `/device-tokens`          | Register a device for push notifications                |
| DELETE | `/device-tokens/:id`      | Remove registered device token                          |

---

## 🧠 Templates (Guided Hiring)

| Method | Endpoint                                             | Description               |
| ------ | ---------------------------------------------------- | ------------------------- |
| POST   | `/templates`                                         | Create template           |
| GET    | `/templates/:id`                                     | Get template              |
| PATCH  | `/templates/:id`                                     | Update template           |
| DELETE | `/templates/:id`                                     | Delete template           |
| GET    | `/templates`                                         | Browse templates          |
| POST   | `/templates/:id/stages`                              | Add template stage        |
| PATCH  | `/templates/stages/:templateStageId`                 | Update stage              |
| PUT    | `/templates/stages/:templateStageId/recommendations` | Add AI recommendations    |
| PUT    | `/templates/stages/:templateStageId/price`           | Set suggested price       |
| POST   | `/templates/:id/apply-to-project/:projectId`         | Apply template to project |

---

## 💰 Finance

| Method | Endpoint                    | Description                |
| ------ | --------------------------- | -------------------------- |
| GET    | `/wallets/mine`             | Get wallet by profile/team |
| GET    | `/wallets/:id/transactions` | Transaction history        |
| POST   | `/escrows`                  | Create escrow for stage    |
| POST   | `/escrows/:id/release`      | Release payment            |
| POST   | `/escrows/:id/refund`       | Refund payment             |
| GET    | `/escrows/:id`              | Get escrow details         |
| GET    | `/stages/:stageId/escrow`   | Get escrow for stage       |
| POST   | `/invoices`                 | Create invoice             |
| GET    | `/invoices/:id`             | Get invoice                |
| PATCH  | `/invoices/:id`             | Update invoice             |
| POST   | `/disputes`                 | Create dispute             |
| PATCH  | `/disputes/:id`             | Update dispute status      |
| POST   | `/ratings`                  | Submit rating              |
| POST   | `/webhooks/stripe`          | Stripe webhook endpoint    |

---

## 🛍️ Marketplace

| Method | Endpoint                  | Description               |
| ------ | ------------------------- | ------------------------- |
| POST   | `/assets`                 | Upload new asset          |
| GET    | `/assets/:id`             | Get asset info            |
| PATCH  | `/assets/:id`             | Update asset              |
| DELETE | `/assets/:id`             | Delete asset              |
| POST   | `/assets/:id/versions`    | Add asset version         |
| GET    | `/assets`                 | Browse marketplace assets |
| POST   | `/assets/:id/purchase`    | Purchase asset            |
| GET    | `/purchases/:id/download` | Download purchased asset  |
| POST   | `/assets/:id/ratings`     | Rate asset                |

---

## 🔍 Search

| Method | Endpoint              | Description                                  |
| ------ | --------------------- | -------------------------------------------- |
| GET    | `/search`             | Search freelancers, teams, templates, assets |
| POST   | `/search/filters`     | Save search filter                           |
| GET    | `/search/filters`     | List saved filters                           |
| DELETE | `/search/filters/:id` | Delete saved filter                          |

---

## 🛠️ Admin & Ops

| Method | Endpoint                          | Description               |
| ------ | --------------------------------- | ------------------------- |
| GET    | `/admin/users`                    | Admin list users          |
| POST   | `/admin/moderation/flags`         | Create content flag       |
| PATCH  | `/admin/moderation/flags/:id`     | Update moderation flag    |
| GET    | `/admin/webhook-outbox`           | List outbound webhooks    |
| POST   | `/admin/webhook-outbox/:id/retry` | Retry webhook delivery    |
| POST   | `/admin/email-queue`              | Queue transactional email |
| GET    | `/admin/rate-limits/:bucketKey`   | Inspect rate limit bucket |
| GET    | `/admin/audit-logs`               | Filter audit events       |

---

## 📈 Analytics

| Method | Endpoint                                | Description                   |
| ------ | --------------------------------------- | ----------------------------- |
| POST   | `/analytics/events`                     | Record client analytics event |
| GET    | `/analytics/daily`                      | View daily metrics            |
| GET    | `/analytics/earnings-by-stage/:stageId` | View stage earnings report    |

---

## ⚙️ Meta & Health

| Method | Endpoint             | Description           |
| ------ | -------------------- | --------------------- |
| GET    | `/health`            | Health check          |
| GET    | `/ready`             | Readiness probe       |
| GET    | `/version`           | Current API version   |
| GET    | `/feature-flags`     | Get feature flags     |
| POST   | `/csp-report`        | Report CSP violation  |
| GET    | `/rate-limit-status` | Show user rate limits |

---

## ✉️ Notifications & Emails

| Method | Endpoint                        | Description             |
| ------ | ------------------------------- | ----------------------- |
| POST   | `/emails/test`                  | Send test email         |
| POST   | `/notifications/broadcast`      | Admin broadcast message |
| POST   | `/notifications/digest/preview` | Preview digest email    |

---

## 📦 Storage & Files

Users can manage their personal file library, rename files before upload, and re-use files in chats or projects without re-uploading.

### 🗂️ User File Library

| Method | Endpoint              | Description                                                                         |
| ------ | --------------------- | ----------------------------------------------------------------------------------- |
| GET    | `/files`              | List all files in the user’s personal library (filterable by status, type, or name) |
| POST   | `/files/initiate`     | Begin a new file upload (returns signed upload URL)                                 |
| PATCH  | `/files/:id/rename`   | Rename a file before or after upload                                                |
| PATCH  | `/files/:id/finalize` | Mark a file as uploaded and available for reuse                                     |
| GET    | `/files/:id`          | Get file metadata and signed download URL                                           |
| DELETE | `/files/:id`          | Delete a file from the user’s library                                               |

---

### 📎 Chat File Reuse

| Method | Endpoint                               | Description                                         |
| ------ | -------------------------------------- | --------------------------------------------------- |
| POST   | `/project-messages/:msgId/attachments` | Attach an existing file to a project message        |
| POST   | `/dm-messages/:msgId/attachments`      | Attach an existing file to a private DM message     |
| GET    | `/project-channels/:channelId/files`   | View all files shared in a specific project channel |
| GET    | `/dms/threads/:threadId/files`         | View all files shared in a private DM thread        |

---

## 🔔 Realtime

| Method | Endpoint             | Description                      |
| ------ | -------------------- | -------------------------------- |
| GET    | `/realtime/auth`     | Get Supabase Realtime auth token |
| POST   | `/realtime/presence` | Announce realtime presence       |

---

## 🌐 Webhooks (Outbound)

| Method | Endpoint                                                                                                | Description               |
| ------ | ------------------------------------------------------------------------------------------------------- | ------------------------- |
| POST   | `/hooks`                                                                                                | Register external webhook |
| DELETE | `/hooks/:id`                                                                                            | Remove webhook            |
| Topics | `project.updated`, `stage.status_changed`, `payment.released`, `dispute.opened`, `asset.purchased`, ... |

---

## 🧩 Non-CRUD Action Endpoints

| Method | Endpoint                   | Description                        |
| ------ | -------------------------- | ---------------------------------- |
| POST   | `/auth/switch-profile`     | Switch active profile              |
| POST   | `/auth/switch-team`        | Switch active team                 |
| POST   | `/stages/:stageId/submit`  | Submit work (alias for submission) |
| POST   | `/stages/:stageId/approve` | Approve stage (shortcut)           |
| POST   | `/escrows/:id/release`     | Release escrow funds               |
| POST   | `/escrows/:id/refund`      | Refund escrow funds                |
| POST   | `/assets/:id/purchase`     | Purchase marketplace asset         |
| GET    | `/purchases/:id/download`  | Download purchased item            |

## 🔌 Integrations & Plugins

Future-ready integration endpoints to connect tools such as GitHub, Trello, Notion, or AI assistants.

| Method | Endpoint                        | Description                                                         |
| ------ | ------------------------------- | ------------------------------------------------------------------- |
| GET    | `/integrations/providers`       | List all available integration providers                            |
| POST   | `/integrations/connections`     | Connect an external account (OAuth or API key)                      |
| GET    | `/integrations/connections`     | List connected integrations for the current user/profile            |
| DELETE | `/integrations/connections/:id` | Disconnect an integration                                           |
| POST   | `/integrations/installs`        | Install or enable a connected integration in a workspace or project |
| GET    | `/integrations/installs`        | List integrations installed in the current workspace/project        |

---

**Last Updated:** October 2025  
**Generated For:** Projective Platform v1  
**Author:** GPT-5 (Projective System Docs)

```

### File: docs\11_Storage.md

```md
# 🗄️ Projective Storage Architecture

Supabase Storage layout for Projective — covering user file libraries, chat attachments, project assets, marketplace items, and future plugin integrations.

All buckets are **private** by default.  
Access is always managed via the database (RLS) and **short-lived signed URLs (TTL 60 s)**.

---

## 📁 Bucket Overview

| Bucket         | Purpose                                             | Visibility                           | Lifecycle                  |
| -------------- | --------------------------------------------------- | ------------------------------------ | -------------------------- |
| `avatars`      | User/team/business avatars                          | Private (optional public read later) | Keep; replace on upload    |
| `attachments`  | User personal file library (draft → uploaded)       | Private                              | Drafts expire after 7 days |
| `chat`         | Optional denormalized copies for project & DM chats | Private                              | Mirrors message lifetime   |
| `project`      | Project-scoped exports/artifacts                    | Private                              | Keep or purge by project   |
| `marketplace`  | Publicly listed assets & paid versions              | Mixed (previews vs originals)        | Keep versions              |
| `previews`     | Thumbnails / PDF & video previews                   | Private                              | Delete after 30 days       |
| `quarantine`   | Virus/MIME scan staging                             | Private                              | Delete after 24 h          |
| `integrations` | External provider import/export data                | Private                              | Keep 90 days               |
| `tmp`          | Ephemeral exports/transcodes                        | Private                              | Delete after 1 h           |

---

## 🧍 Avatars (`avatars`)

**Purpose:** Profile pictures and logos.  
**Paths**

- avatars/users/{user_id}/{uuid}.{ext}
- avatars/teams/{team_id}/{uuid}.{ext}
- avatars/businesses/{business_id}/{uuid}.{ext}

**RLS**

- Write: owner or admin.
- Read: via signed URL (or make public later).

---

## 📎 Attachments (`attachments`)

**Purpose:** Core personal file library — powers pre-upload rename & re-use across chats.  
Backed by `org.attachments` table. :contentReference[oaicite:1]{index=1}

**Paths**

- attachments/{owner_profile_id}/drafts/{attachment_id}/{original_filename}
- attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}

**Flow**

1. **Initiate:** create DB row (`status=draft`) → signed upload URL to `drafts/…`.
2. **Rename:** update `display_name` before finalize.
3. **Finalize:** verify file, scan → move to `files/…`, set `status=uploaded`.

**RLS**

- `SELECT/UPDATE/DELETE`: owner only.
- Others access only through `message_attachments` / `channel_files` joins.

**Lifecycle**

- Delete drafts > 7 days old.
- Keep uploaded files until deleted.

---

## 💬 Chat Files (`chat`) _(optional)_

**Purpose:** Direct per-channel galleries (may be omitted; DB joins work fine). :contentReference[oaicite:2]{index=2}

**Paths**

- chat/projects/{project_id}/channels/{channel_id}/{attachment_id}/{filename}
- chat/dms/{thread_id}/{attachment_id}/{filename}

**Policy**

- Participants can read/write within their channels or DM threads.

**TTL**

- 60 s signed URLs; keep while messages exist.

---

## 🧱 Project Assets (`project`)

**Purpose:** Store compiled deliverables or exports not owned by individuals.

**Paths**

- project/{project_id}/exports/{yyyy-mm}/{uuid}.pdf
- project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}

**RLS**

- Project owners and participants can read.
- Writes by system jobs.

---

## 🛍️ Marketplace (`marketplace`)

**Purpose:** Marketplace asset versions and buyer-only downloads. :contentReference[oaicite:3]{index=3}

**Paths**

- marketplace/assets/{asset_id}/versions/{version_id}/{filename}
- marketplace/assets/{asset_id}/previews/{uuid}.{ext}
- marketplace/purchases/{purchase_id}/license/{license_id}.pdf

**Access**

- Previews: readable by anyone via signed URL.
- Originals: only verified buyers via `/purchases/:id/download`.

---

## 🖼️ Previews (`previews`)

**Purpose:** Generated thumbnails and PDF/video snapshots.

**Paths**

- previews/attachments/{attachment_id}/thumb.{ext}
- previews/attachments/{attachment_id}/page-1.png
- previews/marketplace/{asset_id}/grid/{size}/{uuid}.jpg

**Lifecycle:** purge after 30 days (regenerate on demand).

---

## 🧪 Quarantine (`quarantine`)

**Purpose:** Temporary holding area for antivirus & MIME scanning.

**Paths**

- quarantine/{owner_profile_id}/{attachment_id}/{original_filename}

**Flow**

1. Upload → scan service.
2. Move to `attachments/.../files` if clean.
3. Delete otherwise.

**Lifecycle:** delete after 24 h.

---

## 🔌 Integrations (`integrations`)

**Purpose:** Store plugin-related imports/exports (GitHub, Trello, Notion, etc.).

**Paths**

- integrations/{provider}/{owner_type}-{owner_id}/imports/{yyyy-mm}/{uuid}.json
- integrations/{provider}/{owner_type}-{owner_id}/exports/{yyyy-mm}/{uuid}.json

**RLS:** only connection owner may read/write.

---

## ⚙️ Temporary Files (`tmp`)

**Purpose:** Ad-hoc zips, transcodes, analytics exports.

**Paths**

- tmp/{user_id}/{uuid}.{ext}

**Lifecycle:** auto-delete after 1 h.

---

## 🔐 Cross-Cutting Settings

### Signed URL TTL

Default **60 seconds**; increase selectively for large transfers. :contentReference[oaicite:4]{index=4}

### Metadata (object headers)

| Key                   | Purpose             |
| --------------------- | ------------------- |
| `attachment_id`       | Link back to DB row |
| `owner_profile_id`    | RLS lookup          |
| `sha256`              | Integrity           |
| `mime_type`           | Validation          |
| `uploaded_by_user_id` | Audit trail         |

### Lifecycle Rules

| Path                      | Action | Retention |
| ------------------------- | ------ | --------- |
| `attachments/**/drafts/*` | Delete | 7 days    |
| `tmp/**`                  | Delete | 1 h       |
| `quarantine/**`           | Delete | 24 h      |
| `previews/**`             | Delete | 30 days   |

### Antivirus

Uploads start in `quarantine` → scan → move to destination on success → mark DB row clean.

---

## 🧾 Example Storage Policies (pseudocode)

**attachments**

```sql
CREATE POLICY "attachments_read_own_or_shared"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'attachments' AND (
    EXISTS (
      SELECT 1 FROM org.attachments a
      WHERE a.bucket = 'attachments'
        AND a.path = objects.name
        AND (
          a.owner_profile_id = auth.jwt()->>'active_profile_id'
          OR EXISTS (
            SELECT 1 FROM comms.message_attachments ma
            JOIN comms.channel_files cf ON cf.attachment_id = a.id
            WHERE ma.attachment_id = a.id
              AND project_or_dm_participant(auth.uid())
          )
        )
    )
  )
);

CREATE POLICY "chat_read_participants_only"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'chat' AND user_is_channel_participant(objects.name)
);

CREATE POLICY "marketplace_read_purchased_or_preview"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'marketplace' AND (
    path LIKE 'marketplace/assets/%/previews/%'
    OR EXISTS (
      SELECT 1 FROM marketplace.asset_purchases p
      WHERE path LIKE format('marketplace/assets/%s/%%', p.asset_id)
        AND p.buyer_profile_id = auth.jwt()->>'active_profile_id'
    )
  )
);
```

```

### File: docs\12_RLS.md

```md
# RLS Strategy & Claims Matrix

Projective Supabase RLS Strategy & Claims Matrix\
Last Updated: 28 Oct 2025\
Author: GPT-5 Thinking (Projective Security Spec)

---

## Purpose

We enforce “you only see what you’re currently acting as.”

- A single human user (`auth.users`) can act as:
  - themself
  - their freelancer profile
  - one of their business profiles (“creator” / “client”)
  - a team they’re part of (mini-agency)
- The frontend explicitly switches context and refreshes the JWT.
- The DB never trusts arbitrary row data — it always checks:
  - `auth.uid()` (the Supabase user id)
  - `auth.jwt()->>'active_profile_type'`
  - `auth.jwt()->>'active_profile_id'`
  - `auth.jwt()->>'active_team_id'`

Every table with sensitive data must:

1. Be RLS-enabled.
2. Have policies that assert:\
   “Row is visible only if it’s tied to the caller’s active profile, team, or user.”

This doc is the baseline reference for implementing policies in `/db/policies/**`.

---

## 1. JWT Claims (Session Context)

### Required JWT custom claims

| Claim                 | Example Value                  | Notes                                                             |
| --------------------- | ------------------------------ | ----------------------------------------------------------------- |
| `sub`                 | `"9a7f...uuid"`                | The Supabase `auth.users.id`                                      |
| `active_profile_type` | `"freelancer"` or `"business"` | Explicit role context for this session                            |
| `active_profile_id`   | `"f44c...uuid"`                | The freelancer_profile.id OR business_profile.id you’re acting as |
| `active_team_id`      | `"a12b...uuid"` or `null`      | If you’re acting on behalf of a team / agency                     |

These claims are derived from `security.session_context` for the current `user_id`.\
On profile/team switch, we write a new row (or update) in `security.session_context` then mint a new JWT.

### Access helpers in SQL

- `auth.uid()` → UUID of the logged-in human user.
- `auth.jwt()->>'active_profile_id'` → profile (string) for row scoping.
- `auth.jwt()->>'active_profile_type'` → `"freelancer"` / `"business"`.
- `auth.jwt()->>'active_team_id'` → team (string) for team-scope rules.

We assume helper functions like:

```sql
-- Returns true if the current human user is an active participant in
-- a given project or DM thread (used by comms/chat access).
CREATE OR REPLACE FUNCTION security.project_or_dm_participant(_channel_id uuid)
RETURNS boolean AS $$
  -- implementation detail lives in /db/functions/security.project_or_dm_participant.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;

-- Returns array of all team_ids that are considered valid actors
-- on a given project (for team-based access).
CREATE OR REPLACE FUNCTION security.project_team_ids(_project_id uuid)
RETURNS uuid[] AS $$
  -- implementation detail lives in /db/functions/security.project_team_ids.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

You’ll create/maintain these in `db/functions/`.

---

## 2. Default Policy Templates

These are “starter snippets” we’ll reuse per table.\
All policies should be named clearly (e.g. `pol_projects_projects_owner_select`).

### 2.1 SELECT template

Goal: allow reading rows that belong to the active profile, active team, or self.

```sql
CREATE POLICY "select_visible_rows"
ON <schema>.<table>
FOR SELECT
USING (
  (
    -- direct ownership via profile
    (<table>.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- direct ownership via team
    (<table>.team_id::text = auth.jwt()->>'active_team_id')
    OR
    -- direct ownership via user
    (<table>.user_id = auth.uid())
  )
  OR
  (
    -- project / channel participation (optional, for collab tables)
    security.project_or_dm_participant(<table>.id) = true
  )
);
```

### 2.2 INSERT template

Goal: user can only insert rows “as” their active context.

```sql
CREATE POLICY "insert_as_active_context"
ON <schema>.<table>
FOR INSERT
WITH CHECK (
  (
    -- user is inserting a row for themselves
    (NEW.user_id = auth.uid())
    OR
    -- user is inserting a row for the profile they are currently acting as
    (NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- user is inserting on behalf of team they currently act as
    (NEW.team_id::text = auth.jwt()->>'active_team_id')
  )
);
```

### 2.3 UPDATE template

Goal: cannot update things outside your scope.

```sql
CREATE POLICY "update_owned_rows"
ON <schema>.<table>
FOR UPDATE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
)
WITH CHECK (
  (
    NEW.user_id = auth.uid()
    OR NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR NEW.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

### 2.4 DELETE template

Goal: usually only owners or business “client_business_id” or project owners can delete.

```sql
CREATE POLICY "delete_owned_rows"
ON <schema>.<table>
FOR DELETE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

Note: for some tables (finance.escrows, audit logs, etc.) delete is disabled entirely.

---

## 3. Admin / Service Role Bypass

- Supabase “service_role” key runs queries with `role = service_role`, which ignores RLS.\
  Use this ONLY for:
  - background jobs
  - Stripe webhooks
  - scheduled maintenance
  - internal moderation dashboards

- Admin users (in `ops.admin_users`) still go through RLS at query time unless you explicitly add policies that check admin membership.

Recommended pattern:

```sql
-- Helper: is current user an admin?
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

Then in any table where admins need read access:

```sql
... OR security.is_admin() = true
```

### Restricted tables

- `security.refresh_tokens` (not shown in schema but implied by our auth model)
- `security.session_context`
- `security.audit_logs`

These SHOULD NOT be directly queryable by normal users except in the minimal ways documented below.

---

## 4. Table-by-Table RLS Examples

Below are concrete examples for seven key tables.\
These are examples, not final migrations.\
You’ll drop them in `/db/policies/<schema>/<table>.sql` and adapt columns.

---

### 4.1 `org.users_public`

**Purpose:** public display info per human user.\
Columns: `user_id`, `display_name`, etc.\
Rule:

- Anyone logged-in can `SELECT` any row (public directory-like).
- User can `UPDATE` ONLY their own row.
- Insert happens at onboarding.
- Delete is blocked (soft-delete or anonymize instead).

Enable RLS:

```sql
ALTER TABLE org.users_public ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read: any authenticated user can see public profiles
CREATE POLICY "org_users_public_select_all_auth"
ON org.users_public
FOR SELECT
USING ( auth.uid() IS NOT NULL );

-- Insert: user may create their own entry
CREATE POLICY "org_users_public_insert_self"
ON org.users_public
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

-- Update: user may update only their own row
CREATE POLICY "org_users_public_update_self"
ON org.users_public
FOR UPDATE
USING ( org.users_public.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- Delete: nobody (omit policy, or explicitly deny)
```

Note: If we want moderation/admin edit, extend `USING (...) OR security.is_admin()`.

---

### 4.2 `security.session_context`

**Purpose:** source of truth for the user’s current acting profile/team.\
Columns: `user_id`, `active_profile_type`, `active_profile_id`, `active_team_id`, `updated_at`.

Rules:

- User can read ONLY their own row.
- User can update ONLY their own row.
- No deletes.

Enable RLS:

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read own session context
CREATE POLICY "security_session_context_select_self"
ON security.session_context
FOR SELECT
USING ( security.session_context.user_id = auth.uid() );

-- Insert/Update own context (used on profile/team switch)
CREATE POLICY "security_session_context_upsert_self"
ON security.session_context
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

CREATE POLICY "security_session_context_update_self"
ON security.session_context
FOR UPDATE
USING ( security.session_context.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- No delete policy (effectively blocked for normal users)
```

Note: Background jobs and auth middleware can still overwrite via service_role.

---

### 4.3 `projects.projects`

Relevant columns:

- `id`
- `client_business_id` → `org.business_profiles.id` (the “buyer” / creator)
- (via joins) freelancers, teams, etc. in `projects.project_participants`

Access rules:

- The business profile that owns the project can read/update/delete that project.
- Any freelancer/team added to that project via `project_participants` can also `SELECT`.
- Only the business owner (`client_business_id`) can `UPDATE` or `DELETE`.

We’ll assume helper `projects.is_project_member(projects.id)` which checks:

- `auth.jwt()->>'active_profile_id'` matches a row in `project_participants`
  OR
- the project’s `client_business_id` matches `active_profile_id`
  OR
- current `active_team_id` is in `security.project_team_ids(projects.id)`.

Enable RLS:

```sql
ALTER TABLE projects.projects ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: project members or owning business can view
CREATE POLICY "projects_projects_select_members"
ON projects.projects
FOR SELECT
USING (
  (
    projects.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  EXISTS (
    SELECT 1
    FROM projects.project_participants pp
    WHERE pp.project_id = projects.id
      AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  (
    auth.jwt()->>'active_team_id' IS NOT NULL
    AND auth.jwt()->>'active_team_id' = ANY(
      security.project_team_ids(projects.id)
    )
  )
  OR security.is_admin() = true
);

-- INSERT: only a business profile can create a project,
-- and they can only do it for themselves.
CREATE POLICY "projects_projects_insert_business_owner"
ON projects.projects
FOR INSERT
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
  AND auth.jwt()->>'active_profile_type' = 'business'
);

-- UPDATE: only the owning business can update core project data
CREATE POLICY "projects_projects_update_owner"
ON projects.projects
FOR UPDATE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
)
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
);

-- DELETE: only the owning business can delete (e.g. cancel draft)
CREATE POLICY "projects_projects_delete_owner"
ON projects.projects
FOR DELETE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
);
```

---

### 4.4 `projects.project_stages`

Relevant columns:

- `project_id`
- assignment happens through `projects.stage_assignments`
- different actors (client, assigned freelancer/team) need visibility

Rules:

- Anyone who can see the parent project can `SELECT` its stages.
- UPDATE allowed if:
  - caller is `client_business_id` of parent project, OR
  - caller is the assigned freelancer/team for that stage.

Enable RLS:

```sql
ALTER TABLE projects.project_stages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: you can read a stage if you can read its parent project
CREATE POLICY "project_stages_select_members"
ON projects.project_stages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND (
        p.client_business_id::text = auth.jwt()->>'active_profile_id'
        OR EXISTS (
          SELECT 1
          FROM projects.project_participants pp
          WHERE pp.project_id = p.id
            AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
        )
        OR (
          auth.jwt()->>'active_team_id' IS NOT NULL
          AND auth.jwt()->>'active_team_id' = ANY(
            security.project_team_ids(p.id)
          )
        )
        OR security.is_admin() = true
      )
  )
);

-- INSERT: only project owner (business) can add stages
CREATE POLICY "project_stages_insert_owner"
ON projects.project_stages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = NEW.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
);

-- UPDATE: owner OR assigned freelancer/team
CREATE POLICY "project_stages_update_owner_or_assignee"
ON projects.project_stages
FOR UPDATE
USING (
  -- project owner?
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  -- assigned freelancer?
  EXISTS (
    SELECT 1
    FROM projects.stage_assignments sa
    WHERE sa.project_stage_id = project_stages.id
      AND (
        sa.freelancer_profile_id::text = auth.jwt()->>'active_profile_id'
        OR sa.team_id::text = auth.jwt()->>'active_team_id'
      )
      AND sa.status IN ('accepted','active')
  )
  OR security.is_admin() = true
)
WITH CHECK ( true ); -- we trust USING above for now

-- DELETE: usually disallowed (stages form payment trails), so no policy
```

---

### 4.5 `finance.transactions`

Relevant columns:

- `wallet_id` → belongs to a wallet
- `wallets.owner_type`, `wallets.owner_id`

Rules:

- You can read transactions only if you control the wallet’s owner (your active profile, or your active team, or you’re that business).
- No INSERT/UPDATE/DELETE from clients directly — finance is system-only.

Enable RLS:

```sql
ALTER TABLE finance.transactions ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: wallet owner only
CREATE POLICY "finance_transactions_select_wallet_owner"
ON finance.transactions
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM finance.wallets w
    WHERE w.id = transactions.wallet_id
      AND (
        -- acting profile owns the wallet
        w.owner_id::text = auth.jwt()->>'active_profile_id'
        OR
        -- acting team owns the wallet
        w.owner_id::text = auth.jwt()->>'active_team_id'
      )
  )
  OR security.is_admin() = true
);

-- No INSERT/UPDATE/DELETE policies for normal users
-- (service_role bypasses RLS for ledger writes)
```

---

### 4.6 `org.team_memberships`

Relevant columns:

- `team_id`
- `user_id` (the human account)
- `role`, `status`

Rules:

- A user can read rows if they are in that team.
- Team owner (and maybe `team_lead`) can update membership rows.
- You can’t randomly add yourself to teams you don’t control.

Enable RLS:

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: anyone who is an active member of that same team can view membership
CREATE POLICY "team_memberships_select_team_member"
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin role) can add members
CREATE POLICY "team_memberships_insert_team_owner"
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = NEW.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner or admin-level membership
CREATE POLICY "team_memberships_update_team_owner"
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK ( true );

-- DELETE: team owner (or admin) can remove members
CREATE POLICY "team_memberships_delete_team_owner"
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);
```

This gives team leads power to manage their roster without giving global access.

---

### 4.7 `comms.dm_threads` / `comms.dm_messages`

We’ll show `dm_threads` + `dm_messages` because they’re the cleanest messaging case.\
Core idea applies similarly to `comms.project_channels` and `comms.project_messages` (but those also check project membership).

#### `comms.dm_threads`

Columns:

- `id`
- `created_by_user_id`

Membership comes from `comms.dm_participants (thread_id, user_id)`.

RLS rules:

- You can `SELECT` a thread only if you’re in `dm_participants`.
- You can `INSERT` a new thread if you’re authenticated.
- You can’t `UPDATE` or `DELETE` other people’s threads (no policy).

Enable RLS:

```sql
ALTER TABLE comms.dm_threads ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant
CREATE POLICY "dm_threads_select_participant"
ON comms.dm_threads
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_threads.id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: any logged-in user can create a new DM thread
CREATE POLICY "dm_threads_insert_creator"
ON comms.dm_threads
FOR INSERT
WITH CHECK (
  NEW.created_by_user_id = auth.uid()
);
```

#### `comms.dm_messages`

Columns:

- `thread_id`
- `sender_user_id`
- `body`

RLS rules:

- You can `SELECT` messages in threads you participate in.
- You can `INSERT` only if you’re in that thread and you’re the sender.
- UPDATE/DELETE are disallowed to keep auditability (or can be “soft-delete”).

Enable RLS:

```sql
ALTER TABLE comms.dm_messages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant in the thread
CREATE POLICY "dm_messages_select_participant"
ON comms.dm_messages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_messages.thread_id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: must be participant AND the sender
CREATE POLICY "dm_messages_insert_participant_sender"
ON comms.dm_messages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = NEW.thread_id
      AND dp.user_id = auth.uid()
  )
  AND NEW.sender_user_id = auth.uid()
);
```

For `comms.project_messages`, your `USING` and `WITH CHECK` clauses would mirror logic from `projects.project_stages`, except the join is via `comms.project_channel_participants` instead of `comms.dm_participants`, and the scope is `active_profile_id` / `active_team_id` instead of just `auth.uid()`.

---

## 5. Special Notes & Gotchas

### 5.1 Service Role

- The Supabase “service_role” bypasses ALL RLS.
- Use it strictly in trusted server code (Edge runtime with secret key, cron, Stripe webhooks).
- Never expose service_role to the browser.

### 5.2 `ops.*`, `analytics.*`

- Operational / analytics tables (audit trail, rollups, rate limit counters) should either:
  - be service-role only, OR
  - expose read-only slices via views with stricter policies.

### 5.3 `security.audit_logs`

- Don’t let normal users read the global audit log of other users.
- You MAY allow a user to read back only their own entries for transparency.

Example:

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "audit_logs_select_self_or_admin"
ON security.audit_logs
FOR SELECT
USING (
  security.audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- No insert/update/delete policies for public;
-- logs are written by service_role only.
```

### 5.4 `security.refresh_tokens`

(If you store hashed refresh tokens in DB.)

- NO RLS policies for public.
- Table should be fully private: only service_role inserts/rotates/invalidates refresh tokens.
- Do not expose this table to clients at all. Never query from browser context.

### 5.5 `storage.objects`

- Storage also uses RLS in Supabase.
- You must align `storage.objects` policies with `org.attachments` and channel/project membership.
- Ensure that object path/bucket metadata can be joined back to a profile_id, project_id, channel_id, etc.

You’ll enforce rules like:

- “Attachment belongs to `auth.jwt()->>'active_profile_id'`”
- OR “Attachment is shared in a channel where `auth.uid()` is a participant”
- OR “Attachment is part of a project where active profile/team is a participant”
- Admin override OR service_role.

(See `11_Storage.md` for deeper per-bucket rules.)

---

## 6. Policy Naming, Placement & Conventions

- All policies live in versioned SQL under `db/policies/<schema>/<table>.sql`.
- One table per file.
- Names reflect WHO and WHY, not just CRUD:
  - `pol_projects_projects_owner_select`
  - `pol_projects_project_stages_update_owner_or_assignee`
  - `pol_finance_transactions_select_wallet_owner`
  - `pol_comms_dm_messages_insert_participant_sender`

This avoids mystery and helps audits.

---

## 7. Recap / TL;DR

1. Every authenticated request includes:
   - `auth.uid()`
   - `auth.jwt()->>'active_profile_type'`
   - `auth.jwt()->>'active_profile_id'`
   - `auth.jwt()->>'active_team_id'`

2. All sensitive tables are RLS-enabled.

3. Policies check:
   - Does this row belong to my active profile OR my active team?
   - Am I directly assigned / participating in this project, stage, channel, or thread?
   - Am I the wallet/payee/payer on the money row?
   - Am I the team owner / business owner / freelancer assigned?
   - OR am I an admin (`security.is_admin()`)?
   - Otherwise: no access.

4. Finance tables are read-only for end users, write-only for the system.
5. `security.*` tables are locked down to self or admin, never world-readable.
6. Storage rules mirror DB row ownership + sharing, never public by default.
7. The service_role key bypasses RLS and is only used in trusted server code (Stripe webhooks, cron, moderation tools).

This guarantees isolation between:

- different business profiles owned by the same human,
- freelancers inside and outside teams,
- teams hired by a business,
- and unrelated projects/DMs.

Everything is enforced at the database layer — even if the API layer forgets.

```
```

```

### File: docs\13_FolderStructure.md

```md
# Projective Monorepo — Folder Structure & Naming Conventions

This is a pragmatic structure for a Deno Fresh + Supabase (Postgres + RLS) + Rust WASM project. It keeps the edge app, API routes, database, and infra tidy; is CI-friendly; and scales from MVP to multi-team.

---

## 1) Top-Level Layout

```text
projective/
├─ apps/
│  └─ web/                     # Fresh (Deno) app: UI + API routes
├─ packages/
│  ├─ ui/                      # Shared UI (islands/components, Tailwind, shadcn wrappers)
│  ├─ lib/                     # Isomorphic TS utilities (validators, schema, errors, dates)
│  ├─ sdk/                     # Typed client for calling /api/v1 from browser/edge jobs
│  └─ wasm/                    # Rust crates compiled to WebAssembly
├─ db/
│  ├─ migrations/              # SQL migrations (idempotent, forward-only)
│  ├─ seeds/                   # Non-essential seed data
│  ├─ policies/                # RLS policies split by schema/table
│  ├─ functions/               # SQL & plpgsql functions (e.g., auth helpers)
│  ├─ views/                   # Views/materialized views
│  └─ scripts/                 # Local helpers (dump/restore, diff)
├─ supabase/
│  ├─ config/                  # Supabase CLI config, access roles
│  ├─ storage-rules/           # Storage (policy) snippets per bucket
│  └─ edge-functions/          # (Optional) Supabase Edge Functions
├─ infra/
│  ├─ deno/                    # Deno Deploy or self-host manifests
│  ├─ cf/                      # Cloudflare Turnstile or Workers (if used)
│  ├─ stripe/                  # Webhook fixtures & CLI scripts
│  └─ github/                  # GitHub Actions workflows
├─ docs/
│  ├─ architecture/            # ADRs, diagrams
│  ├─ api/                     # OpenAPI (generated), endpoint docs
│  └─ product/                 # Feature specs, user flows
├─ scripts/                    # Cross-repo task runners (deno task aliases)
├─ .env.example                # Example env config (never commit real secrets)
├─ deno.json                   # Deno config (tasks, import map, lint)
├─ import_map.json             # Bare module specifiers mapping
├─ README.md
└─ LICENSE
```

---

## 2) `apps/web` (Fresh App) Structure

```text

apps/web/
├─ routes/                     # Fresh routes: pages + API endpoints
│  ├─ (public)/                # Authless pages (marketing, landing)
│  ├─ (auth)/                  # /login, /signup
│  ├─ (dashboard)/             # Authenticated areas
│  ├─ api/                     # Fresh API routes (edge)
│  │  └─ v1/                   # /api/v1/*
│  │     ├─ auth/
│  │     ├─ users/
│  │     ├─ freelancers/
│  │     ├─ businesses/
│  │     ├─ teams/
│  │     ├─ projects/
│  │     ├─ stages/
│  │     ├─ dms/
│  │     ├─ templates/
│  │     ├─ finance/
│  │     ├─ marketplace/
│  │     ├─ search/
│  │     └─ meta/
│  └─ _app.tsx                 # App shell
├─ islands/                    # Preact interactive islands
├─ components/                 # Presentational components
├─ features/                   # Feature slices (screens, hooks, services)
│  ├─ auth/
│  ├─ account-switcher/
│  ├─ team-selector/
│  ├─ messaging/
│  ├─ projects/
│  ├─ marketplace/
│  └─ templates/
├─ server/                     # Server-side helpers (KV, cookies, auth)
│  ├─ auth/
│  ├─ kv/
│  └─ middleware/
├─ services/                   # API integrations (Supabase client, Stripe, Turnstile)
├─ styles/                     # Tailwind CSS, global styles
├─ types/                      # App-level TypeScript types
├─ tests/                      # e2e/integration tests (deno test)
└─ static/                     # Assets served as static files
```

**API route filenames** mirror endpoint paths. Example:

- `/api/v1/projects/[id].ts` → `GET, PATCH, DELETE` handlers
- `/api/v1/stages/[stageId]/approve.ts` → action endpoints  
  Keep one file per resource or action for discoverability.

---

## 3) `packages` (Shared Code)

```text

packages/ui/                   # Reusable UI (Tailwind + shadcn)
packages/lib/                  # Pure TS: zod schemas, errors, utils
packages/sdk/                  # Typed fetchers for /api/v1 (request/response types)
packages/wasm/
└─ image_ops/                  # Rust crate compiled to wasm (wasm-bindgen)
```

**Naming**

- Packages: `kebab-case`.
- Exports: prefer named exports; default export only for React components.
- WASM crates: `snake_case` (Rust convention); built artifacts published to `packages/wasm/<crate>/dist/`.

---

## 4) Database Files (`/db`)

```text

db/
├─ migrations/
│  ├─ 0001_init_schemas.sql
│  ├─ 0002_org_tables.sql
│  ├─ 0003_projects_tables.sql
│  ├─ 0004_comms_tables.sql
│  ├─ 0005_finance_tables.sql
│  ├─ 0006_marketplace_tables.sql
│  ├─ 0007_search_templates.sql
│  ├─ 0008_indexes_constraints.sql
│  ├─ 0009_rls_enable.sql
│  └─ 0010_policies_batch_1.sql
├─ policies/
│  ├─ org/
│  │  ├─ freelancer_profiles.sql
│  │  ├─ business_profiles.sql
│  │  ├─ team_memberships.sql
│  │  └─ attachments.sql
│  ├─ projects/
│  ├─ comms/
│  ├─ finance/
│  ├─ marketplace/
│  └─ storage/
├─ functions/
│  ├─ auth/
│  │  └─ project_or_dm_participant.sql
│  └─ helpers/
│     └─ project_team_ids.sql
├─ views/
│  └─ analytics/
│     ├─ earnings_by_stage_mv.sql
│     └─ refresh_earnings_by_stage.sql
├─ seeds/
│  ├─ 100_skills.sql
│  └─ demo_users.sql
└─ scripts/
   ├─ dump.sh
   ├─ restore.sh
   └─ diff.sh
```

**Migration naming**: `NNNN_descriptive_snake_case.sql` (monotonic, forward-only).  
**Policy files**: one table per file, named exactly as `<schema>/<table>.sql`.  
**Functions/Views**: 1 file per function/view; name equals the function/view.

---

## 5) Supabase Storage Conventions

**Buckets** (all lowercase, singular): `avatars`, `attachments`, `chat`, `project`, `marketplace`, `previews`, `quarantine`, `integrations`, `tmp`.

**Object path format** (use stable IDs, never user-provided names in path segments):

- `avatars/users/{user_id}/{uuid}.{ext}`
- `attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}`
- `project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}`
- `marketplace/assets/{asset_id}/versions/{version_id}/{filename}`

**Naming**: folder segments `snake_case`, files keep original name sanitized to `kebab-case.ext`.

---

## 6) Code & File Naming Conventions

### 6.1 General

- Directories: `kebab-case`
- Files: `kebab-case`
- TypeScript types: `PascalCase` (`UserProfile`, `ProjectStage`)
- Functions/variables: `camelCase`
- Constants: `UPPER_SNAKE_CASE`
- Enums (TS): `PascalCase` enum + `SCREAMING_SNAKE_CASE` members if numeric; otherwise `camelCase` string unions.

### 6.2 UI & Components

- Components: `PascalCase` files with `.tsx` (`AccountSwitcher.tsx`)
- Hooks: `use-*.ts` (`use-active-profile.ts`)
- Cons: `*-con.ts` (`session-con.ts`)
- Islands: end with `.island.tsx` when needed (`AccountSwitcher.island.tsx`)

### 6.3 API Routes (Fresh)

- Resource handlers in `/api/v1/...` named like the path:
  - `/api/v1/projects/[id].ts` (export `GET`, `PATCH`, `DELETE`)
  - `/api/v1/stages/[stageId]/approve.ts` (export `POST`)
- Do not suffix with `controller` or `handler`; the route file **is** the handler.

### 6.4 Services & Integrations

- Service modules: `*-service.ts` (`stripe-service.ts`, `supabase-service.ts`)
- Repositories (DB access wrappers when needed): `*-repo.ts`
- Validation schemas (zod): `*-schema.ts` (`project-schema.ts`)

### 6.5 Tests

- Unit tests: colocate as `*.test.ts` next to source.
- Integration/e2e: `apps/web/tests/*.test.ts` with helpers under `tests/_helpers/`.

---

## 7) Database Naming Conventions

- Schemas: `security`, `org`, `projects`, `comms`, `finance`, `marketplace`, `search`, `ops`, `analytics`, `integrations`.
- Tables: **`snake_case` plural** (`freelancer_profiles`, `project_stages`).
- Columns: `snake_case`. Primary keys named `id` (uuid). Foreign keys reference `<table>.<id>`.
- Enums: `snake_case` values (`draft`, `in_progress`), type names `snake_case`.
- Indexes: `idx_<table>_<col1>[_<col2>]` (e.g., `idx_project_stages_project_id_order`)
- Constraints: `chk_<table>_<column>`, `uq_<table>_<column(s)>`, `fk_<table>_<ref>`
- Policies: `pol_<schema>_<table>_<purpose>` (`pol_projects_projects_owner_access`)
- Triggers: `trg_<table>_<action>` (`trg_stage_submissions_set_timestamp`)
- Functions: `schema.fn_name(argtypes)` with file `schema/fn_name.sql`

**Do not** embed business meaning in primary keys; always use UUIDs.

---

## 8) RLS Policy Organization

- Enable RLS in a single migration early (`0009_rls_enable.sql`).
- One policy file per table in `db/policies/<schema>/<table>.sql`.
- Policy names reflect **who** and **why**:  
  `pol_project_messages_channel_participant_select`,  
  `pol_wallets_owner_select`,  
  `pol_attachments_owner_or_shared_select`.

---

## 9) Env Vars & Secrets

**Naming**: `UPPER_SNAKE_CASE`.  
**Prefixes**:

- Public (exposed to client): `PUBLIC_` (e.g., `PUBLIC_TURNSTILE_SITE_KEY`)
- Server-only: no `PUBLIC_` (e.g., `SUPABASE_SERVICE_ROLE_KEY`, `STRIPE_SECRET_KEY`)

**Files**:

- `.env.example` committed; `.env` ignored.
- For Deno Deploy: use project secrets UI; mirror keys from `.env.example`.

---

## 10) Commit, Branch & PR Conventions

- Branches: `type/short-description`
  - Types: `feat`, `fix`, `chore`, `docs`, `refactor`, `perf`, `test`
  - Example: `feat/account-switcher`, `fix/rls-attachments`
- Commits (Conventional Commits):
  - `feat(projects): add stage approval endpoint`
  - `fix(rls): allow team participants to read channel files`
- PR titles mirror first commit; include “**Scope**” and “**Testing**” sections in description.

---

## 11) Linting, Formatting, and Tasks

- Use Deno’s built-in: `deno lint`, `deno fmt`.
- `deno.json` tasks (examples):

```text json
{
  "tasks": {
    "dev": "deno task -q _dev",
    "_dev": "deno run -A --watch=routes,islands,components main.ts",
    "test": "deno test -A --fail-fast",
    "lint": "deno lint",
    "fmt": "deno fmt",
    "db:migrate": "supabase db reset --db-url $SUPABASE_DB_URL",
    "db:diff": "supabase db diff --linked",
    "typecheck": "deno check apps/web/routes/_app.tsx"
  }
}
```

---

## 12) Error Handling & Response Shapes

- Error objects: `{ error: { code: string, message: string, details?: unknown } }`
- Codes: `auth.invalid_token`, `auth.forbidden`, `validation.failed`, `resource.not_found`, `rate.limit_exceeded`
- Never leak internal stack traces to clients.

---

## 13) API Response & File Naming

- JSON fields: `snake_case` or `camelCase`? **Pick one and stick to it.**  
  For Deno + TS frontends, prefer **camelCase in JSON** (DX), keep **snake_case in DB**.
- Download filenames: `kebab-case` + semantic suffixes (`project-export-2025-10-18.zip`).

---

## 14) Logging, Metrics, and Audit

- App logs: `server/logger.ts` with levels `debug|info|warn|error`.
- Audit logs table: `security.audit_logs`.
- Structured log keys: `timestamp`, `level`, `message`, `con` (request id, user id, profile id).

---

## 15) Testing Conventions

- Unit: colocated `*.test.ts`.
- API integration: `apps/web/tests/api/*.test.ts` hitting `/api/v1` with mocked auth.
- DB invariants: SQL assertions in migration follow-ups (e.g., check policies compile).

---

## 16) Example File Names (Grab-bag)

- Component: `apps/web/components/avatar-uploader.tsx`
- Island: `apps/web/islands/account-switcher.island.tsx`
- Hook: `apps/web/features/auth/use-session.ts`
- Route: `apps/web/routes/api/v1/stages/[stageId]/approve.ts`
- Service: `apps/web/services/turnstile-service.ts`
- Policy file: `db/policies/org/attachments.sql`
- Function file: `db/functions/auth/project_or_dm_participant.sql`
- View file: `db/views/analytics/earnings_by_stage_mv.sql`

---

## 17) CI/CD (GitHub Actions)

```text
yaml
name: ci
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with: { deno-version: v1.x }
      - run: deno fmt --check
      - run: deno lint
      - run: deno test -A
```

Deploy workflows live under `infra/github/`. Separate jobs for `preview` and `production`.

---

## 18) Accessibility & i18n

- Components accept `aria-*` props; follow WAI-ARIA roles.
- Strings centralized in `packages/lib/i18n/` (lazy-loaded dictionaries).

---

## 19) Security Defaults

- CSP in middleware: default-deny; allow self + asset CDN; disallow inline except hashed.
- Cookies: `Secure; HttpOnly; SameSite=Lax`.
- JWT: short-lived access; opaque refresh rotated; store refresh in HttpOnly cookie.
- Turnstile for anonymous POST endpoints.
- Signed URLs (60s TTL) for Storage downloads.

---

## 20) Documentation

- API contracts in `docs/api/` (OpenAPI generated from handlers or typed definitions).
- Architecture Decision Records in `docs/architecture/adr-XXXX-title.md` (YYYY-MM-DD).
- Product docs in `docs/product/` (features, user stories, flows).

---

## 21) Versioning & Releases

- Tag format: `vMAJOR.MINOR.PATCH` (e.g., `v0.7.3`).
- Changelog: `docs/CHANGELOG.md` using Keep a Changelog syntax.
- Database: bump with each migration; record in `db/migrations/` and `docs/CHANGELOG.md`.

---

### TL;DR Defaults

- **Directories & files**: `kebab-case`.
- **DB**: schemas/tables/cols `snake_case` plural tables.
- **TS**: `camelCase` for code & JSON; `PascalCase` for types/components.
- **Migrations**: `NNNN_description.sql` (forward-only).
- **Routes**: path-mirrored filenames under `/api/v1`.
- **Policies/Functions/Views**: one object per file, name = object.
- **Env**: `PUBLIC_` for client-exposed, everything else server-only.

This scaffolding + naming playbook prevents bikeshedding and keeps velocity high as the codebase grows.

```

### File: docs\14_Sitemap.md

```md
# 🗺️ Projective – Routes & Sitemap (Freelancers, Creators, Teams)

> Tech: **Deno Fresh 2.x**  
> Conventions:  
> - **Route Groups**: `(group-name)/` — folder name does **not** appear in the URL.  
> - **Slug**: `[param]`  
> - **Catch-all**: `[...path]`  
> - **Regex / Constraints**: put a `matchers.ts` next to the route to validate params (see examples).  
> - Auth-gated areas live under `(dashboard)/…` with a shared `_middleware.ts`.

---

## 🌍 Public

| URL Path | Page | Route File (apps/web/routes) | Notes |
|---|---|---|---|
| `/` | Home | `(public)/index.tsx` | Marketing landing |
| `/about` | About | `(public)/about.tsx` |  |
| `/explore` | Explore / Search | `(public)/explore/index.tsx` | Unified search hub |
| `/categories` | Categories | `(public)/categories/index.tsx` | List all |
| `/categories/[slug]` | Category detail | `(public)/categories/[slug].tsx` | **Matcher**: `slug=/^[a-z0-9-]+$/` |
| `/freelancers/[handle]` | Public freelancer profile | `(public)/freelancers/[handle].tsx` | **Matcher**: `handle=/^[a-z0-9_-]{3,32}$/` |
| `/teams/[slug]` | Public team profile | `(public)/teams/[slug].tsx` | Slug constrained via matcher |
| `/articles` | Articles directory | `(public)/articles/index.tsx` |  |
| `/templates` | Templates directory | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Template detail | `(public)/templates/[id].tsx` | UUID matcher |
| `/assets` | Marketplace (future) | `(public)/marketplace/index.tsx` |  |
| `/assets/[id]` | Asset page (future) | `(public)/marketplace/[id].tsx` | UUID matcher |
| `/pricing` | Pricing (future) | `(public)/pricing.tsx` |  |
| `/help` | Help / Support | `(public)/help/index.tsx` |  |
| `/help/[...path]` | Help article catch-all | `(public)/help/[...path].tsx` | MD/MDX renderer |
| `/terms` | Terms | `(public)/legal/terms.tsx` |  |
| `/privacy` | Privacy | `(public)/legal/privacy.tsx` |  |

---

## 🔐 Auth & Account

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/login` | Login | `(auth)/login.tsx` |  |
| `/signup` | Signup | `(auth)/signup.tsx` |  |
| `/auth/verify/[token]` | Email verify | `(auth)/verify/[token].tsx` | **Matcher**: base64/uuid |
| `/auth/forgot-password` | Forgot | `(auth)/forgot-password.tsx` |  |
| `/auth/reset/[token]` | Reset | `(auth)/reset/[token].tsx` |  |
| `/setup` | Choose role | `(auth)/setup/index.tsx` |  |
| `/setup/freelancer` | Freelancer setup | `(auth)/setup/freelancer.tsx` |  |
| `/setup/creator` | Creator setup | `(auth)/setup/creator.tsx` |  |
| `/account` | User account (global) | `(dashboard)/account/index.tsx` | Security, profiles, emails, 2FA |
| `/switch-account` | Account switcher | `(dashboard)/switch-account.tsx` | Updates session context |

> `(dashboard)/_middleware.ts` enforces auth + injects session context (`active_profile_id`, `active_team_id`).

---

## 🧑‍🎨 Freelancer

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/freelancer` | Redirect → dashboard | `(dashboard)/freelancer/index.tsx` |  |
| `/freelancer/dashboard` | Overview | `(dashboard)/freelancer/dashboard.tsx` |  |
| `/freelancer/projects` | My projects | `(dashboard)/freelancer/projects/index.tsx` |  |
| `/freelancer/projects/[id]` | Project workspace | `(dashboard)/freelancer/projects/[id]/index.tsx` | UUID |
| `/freelancer/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/freelancer/projects/[id]/stage/[stageId].tsx` | UUIDs |
| `/freelancer/messages` | Inbox | `(dashboard)/freelancer/messages/index.tsx` |  |
| `/freelancer/messages/[threadId]` | Thread | `(dashboard)/freelancer/messages/[threadId].tsx` |  |
| `/freelancer/teams` | Teams list | `(dashboard)/freelancer/teams/index.tsx` |  |
| `/freelancer/teams/create` | Create team | `(dashboard)/freelancer/teams/create.tsx` |  |
| `/freelancer/teams/[teamId]` | Team dashboard | `(dashboard)/freelancer/teams/[teamId]/index.tsx` | UUID |
| `/freelancer/teams/[teamId]/members` | Manage members | `(dashboard)/freelancer/teams/[teamId]/members.tsx` |  |
| `/freelancer/profile` | Edit profile | `(dashboard)/freelancer/profile/index.tsx` |  |
| `/freelancer/portfolio/new` | Add portfolio item | `(dashboard)/freelancer/portfolio/new.tsx` |  |
| `/freelancer/earnings` | Wallet & payouts | `(dashboard)/freelancer/earnings.tsx` |  |
| `/freelancer/notifications` | Notifications | `(dashboard)/freelancer/notifications.tsx` |  |
| `/freelancer/settings` | Settings | `(dashboard)/freelancer/settings.tsx` |  |

---

## 🧑‍🤝‍🧑 Teams (shared)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/teams/[teamId]` | Team dashboard | `(dashboard)/teams/[teamId]/index.tsx` |  |
| `/teams/[teamId]/projects` | Team projects | `(dashboard)/teams/[teamId]/projects/index.tsx` |  |
| `/teams/[teamId]/projects/[projectId]` | Team project | `(dashboard)/teams/[teamId]/projects/[projectId]/index.tsx` |  |
| `/teams/[teamId]/members` | Members | `(dashboard)/teams/[teamId]/members.tsx` |  |
| `/teams/[teamId]/settings` | Settings | `(dashboard)/teams/[teamId]/settings.tsx` |  |
| `/teams/[teamId]/analytics` | Analytics (future) | `(dashboard)/teams/[teamId]/analytics.tsx` |  |

---

## ✨ Creator (formerly Business)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/creator` | Redirect → dashboard | `(dashboard)/creator/index.tsx` |  |
| `/creator/dashboard` | Overview | `(dashboard)/creator/dashboard.tsx` |  |
| `/creator/projects` | All projects | `(dashboard)/creator/projects/index.tsx` |  |
| `/creator/projects/new` | New project | `(dashboard)/creator/projects/new.tsx` |  |
| `/creator/projects/new/template` | Guided creation | `(dashboard)/creator/projects/new-template.tsx` |  |
| `/creator/projects/[id]` | Project overview | `(dashboard)/creator/projects/[id]/index.tsx` |  |
| `/creator/projects/[id]/stage/[stageId]` | Stage view | `(dashboard)/creator/projects/[id]/stage/[stageId].tsx` |  |
| `/creator/messages` | Inbox | `(dashboard)/creator/messages/index.tsx` |  |
| `/creator/messages/[threadId]` | Thread | `(dashboard)/creator/messages/[threadId].tsx` |  |
| `/creator/wallet` | Payments & invoices | `(dashboard)/creator/wallet.tsx` |  |
| `/creator/settings` | Creator profile & billing | `(dashboard)/creator/settings.tsx` |  |
| `/creator/notifications` | Notifications | `(dashboard)/creator/notifications.tsx` |  |

---

## 🧱 Project Workspace (URL-based, role-agnostic)

These mirror deep-links that both roles can use; they live under `(dashboard)/projects` to keep logic centralized. Your role decides what controls render.

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/projects/[id]` | Project dashboard | `(dashboard)/projects/[id]/index.tsx` |  |
| `/projects/[id]/stages` | Stages list | `(dashboard)/projects/[id]/stages.tsx` |  |
| `/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/projects/[id]/stage/[stageId].tsx` |  |
| `/projects/[id]/chat` | Project chat (general) | `(dashboard)/projects/[id]/chat/index.tsx` |  |
| `/projects/[id]/chat/[channelId]` | Channel view | `(dashboard)/projects/[id]/chat/[channelId].tsx` |  |
| `/projects/[id]/files` | File gallery | `(dashboard)/projects/[id]/files.tsx` |  |
| `/projects/[id]/activity` | Activity feed | `(dashboard)/projects/[id]/activity.tsx` |  |

---

## 💬 Global Messaging & Notifications

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/messages` | Unified inbox | `(dashboard)/(comms)/messages/index.tsx` | Combines DMs + project threads |
| `/messages/[threadId]` | DM / group thread | `(dashboard)/(comms)/messages/[threadId].tsx` |  |
| `/notifications` | Notification center | `(dashboard)/(comms)/notifications.tsx` |  |

---

## 🧩 Templates (creator & freelancer)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/templates` | Browse (public) | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Detail (public) | `(public)/templates/[id].tsx` |  |
| `/dashboard/templates` | My templates | `(dashboard)/dashboard/templates/index.tsx` | owner view |
| `/dashboard/templates/create` | Create template | `(dashboard)/dashboard/templates/create.tsx` |  |
| `/dashboard/templates/[id]/edit` | Edit template | `(dashboard)/dashboard/templates/[id]/edit.tsx` |  |

---

## Articles (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/articles` | Browse (public) | `(public)/articles/index.tsx` |  |
| `/articles/[id]` | Detail (public) | `(public)/articles/[id].tsx` |  |
| `/dashboard/articles` | My article | `(dashboard)/dashboard/articles/index.tsx` | owner view |
| `/dashboard/articles/create` | Create article | `(dashboard)/dashboard/articles/create.tsx` |  |
| `/dashboard/articles/[id]/edit` | Edit article | `(dashboard)/dashboard/articles/[id]/edit.tsx` |  |

---

## 🛍️ Marketplace (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/marketplace` | Catalog | `(public)/marketplace/index.tsx` |  |
| `/marketplace/[id]` | Asset | `(public)/marketplace/[id].tsx` |  |
| `/dashboard/marketplace/upload` | Upload asset | `(dashboard)/dashboard/marketplace/upload.tsx` |  |
| `/dashboard/marketplace/sales` | My sales | `(dashboard)/dashboard/marketplace/sales.tsx` |  |
| `/dashboard/marketplace/purchases` | My purchases | `(dashboard)/dashboard/marketplace/purchases.tsx` |  |

---

## 💰 Finance

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/wallet` | Wallet overview | `(dashboard)/finance/wallet/index.tsx` | Context-aware (profile/team) |
| `/transactions` | Transactions | `(dashboard)/finance/transactions.tsx` |  |
| `/invoices` | Invoices | `(dashboard)/finance/invoices/index.tsx` |  |
| `/invoices/[id]` | Invoice detail | `(dashboard)/finance/invoices/[id].tsx` |  |
| `/disputes` | Disputes | `(dashboard)/finance/disputes/index.tsx` |  |
| `/ratings` | Ratings & reviews | `(dashboard)/finance/ratings.tsx` |  |
| `/subscription` | Subscription (future) | `(dashboard)/finance/subscription.tsx` | Promoted listings mgmt later |

---

## 📊 Analytics (later)

| URL Path | Page | Route File |
|---|---|---|
| `/analytics/freelancer` | Freelancer insights | `(dashboard)/analytics/freelancer.tsx` |
| `/analytics/creator` | Creator insights | `(dashboard)/analytics/creator.tsx` |
| `/analytics/team` | Team insights | `(dashboard)/analytics/team.tsx` |

---

## ⚙️ Admin (internal)

| URL Path | Page | Route File |
|---|---|---|
| `/admin` | Dashboard | `(dashboard)/admin/index.tsx` |
| `/admin/users` | Users | `(dashboard)/admin/users.tsx` |
| `/admin/projects` | Projects | `(dashboard)/admin/projects.tsx` |
| `/admin/flags` | Moderation flags | `(dashboard)/admin/flags.tsx` |
| `/admin/emails` | Email queue | `(dashboard)/admin/emails.tsx` |
| `/admin/webhooks` | Webhooks | `(dashboard)/admin/webhooks.tsx` |
| `/admin/feature-flags` | Feature flags | `(dashboard)/admin/feature-flags.tsx` |

---

## 🔧 Matchers (Regex) — Examples

Create a `matchers.ts` next to any dynamic route to constrain params:

```ts
// apps/web/routes/(public)/freelancers/[handle].tsx
export const match = { handle: /^[a-z0-9_-]{3,32}$/i };

// apps/web/routes/(public)/templates/[id].tsx
export const match = { id: /^[0-9a-f-]{36}$/i }; // UUID v4 relaxed

// apps/web/routes/(dashboard)/projects/[id]/stage/[stageId].tsx
export const match = {
  id: /^[0-9a-f-]{36}$/i,
  stageId: /^[0-9a-f-]{36}$/i,
};
```

```text
apps/web/routes/
├─ (public)/
│  ├─ index.tsx
│  ├─ about.tsx
│  ├─ explore/index.tsx
│  ├─ categories/[slug].tsx
│  ├─ freelancers/[handle].tsx
│  ├─ teams/[slug].tsx
│  ├─ templates/[id].tsx
│  ├─ marketplace/[id].tsx
│  └─ help/[...path].tsx
├─ (auth)/
│  ├─ login.tsx
│  ├─ signup.tsx
│  ├─ verify/[token].tsx
│  ├─ forgot-password.tsx
│  ├─ reset/[token].tsx
│  └─ onboarding/{index.tsx, freelancer.tsx, creator.tsx}
├─ (dashboard)/
│  ├─ _middleware.ts
│  ├─ account/index.tsx
│  ├─ switch-account.tsx
│  ├─ freelancer/…
│  ├─ creator/…
│  ├─ teams/…
│  ├─ projects/…
│  ├─ comms/…
│  ├─ templates/…
│  ├─ finance/…
│  ├─ analytics/…
│  ├─ admin/…
│  └─ account/…
└─ _app.tsx
```
```

### File: packages\backend\auth\jwt.ts

```ts
import { ENV } from "../config.ts";

// packages/server-utils/jwt.ts
let _jwtKey: CryptoKey | null = null;

export async function getJwtKey(): Promise<CryptoKey> {
	if (_jwtKey) return _jwtKey;

	// ENV.JWT_SECRET is a string. We have to turn it into bytes for importKey.
	const raw = new TextEncoder().encode(ENV.JWT_SECRET);

	_jwtKey = await crypto.subtle.importKey(
		"raw",
		raw,
		{ name: "HMAC", hash: "SHA-256" },
		false,
		["sign", "verify"],
	);

	return _jwtKey;
}

```

### File: packages\backend\auth\tokens.ts

```ts
import { create } from 'djwt';
import { hashArgon2id, randomTokenString } from '../crypto.ts';
import { getJwtKey } from './jwt.ts'; // <-- new

const ACCESS_TTL_SECONDS = 15 * 60; // 15 minutes
const REFRESH_TTL_SECONDS = 60 * 60 * 24 * 30; // ~30 days

export type SessionClaims = {
	userId: string;
	activeProfileType: 'freelancer' | 'business' | null;
	activeProfileId: string | null;
	activeTeamId: string | null;
};

export async function mintAccessToken(claims: SessionClaims) {
	const exp = Math.floor(Date.now() / 1000) + ACCESS_TTL_SECONDS;

	const payload = {
		sub: claims.userId,
		active_profile_type: claims.activeProfileType,
		active_profile_id: claims.activeProfileId,
		active_team_id: claims.activeTeamId,
		exp,
	};

	const key = await getJwtKey();

	const token = await create(
		{ alg: 'HS256', typ: 'JWT' },
		payload,
		key,
	);

	return { token, exp };
}

/**
 * Creates a new refresh token (opaque random string),
 * hashes it, and returns both the plaintext token (for cookie)
 * and the hash (for DB storage).
 */
export async function mintRefreshToken() {
	const plaintext = randomTokenString(32);
	const hash = await hashArgon2id(plaintext);
	const exp = Math.floor(Date.now() / 1000) + REFRESH_TTL_SECONDS;
	return { plaintext, hash, exp };
}

export function buildAccessCookie(accessToken: string, maxAgeSeconds = ACCESS_TTL_SECONDS) {
	return [
		'access_token=',
		accessToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		`; Max-Age=${maxAgeSeconds}`,
		'; Path=/',
	].join('');
}

export function buildRefreshCookie(refreshToken: string) {
	return [
		'refresh_token=',
		refreshToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		'; Path=/api/v1/auth',
	].join('');
}

```

### File: packages\backend\config.ts

```ts
import { loadSync } from '@std/dotenv';

loadSync({ export: true });

function requireEnv(name: string): string {
	const value = Deno.env.get(name);
	if (!value) {
		console.error(`Missing required env var: ${name}`);
		if (Deno.env.get('DENO_DEPLOYMENT_ID')) return '';
		throw new Error(`Missing env: ${name}`);
	}
	return value;
}

export const Config = {
	SUPABASE_URL: requireEnv('SUPABASE_URL'),
	SUPABASE_SERVICE_ROLE_KEY: requireEnv('SUPABASE_SERVICE_ROLE_KEY'),
	JWT_SECRET: requireEnv('JWT_SECRET'),
	APP_ENV: Deno.env.get('APP_ENV') ?? 'development',
};

```

### File: packages\backend\crypto.ts

```ts
// packages/server-utils/crypto.ts

// Generate URL-safe random string (base64-ish) for refresh tokens
export function randomTokenString(byteLength = 32): string {
	const raw = crypto.getRandomValues(new Uint8Array(byteLength));
	// convert Uint8Array -> binary string -> base64
	const bin = String.fromCharCode(...raw);
	return btoa(bin); // you can further make it URL-safe if you want
}

// TODO: replace with real Argon2id
export async function hashArgon2id(value: string): Promise<string> {
	// WARNING: placeholder.
	// You MUST replace this with a secure Argon2id hash implementation
	// before production. We're returning a SHA-256 for now just so dev works.
	const data = new TextEncoder().encode(value);
	const digest = await crypto.subtle.digest('SHA-256', data);
	const bytes = new Uint8Array(digest);
	return Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
}

```

### File: packages\backend\deno.json

```json
{
  "name": "@backend",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\backend\mod.ts

```ts
export * from './config.ts';
export * from './crypto.ts';
export * from './auth/jwt.ts';
export * from './auth/tokens.ts';

```

### File: packages\shared\deno.json

```json
{
  "name": "@shared",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\shared\mod.ts

```ts
// export * from './types.ts';
export * from "./validation/auth.ts";

```

### File: packages\shared\types.ts

```ts

```

### File: packages\shared\validation\auth.ts

```ts
import { escape } from '@std/regexp/escape';

export type RegisterFields = {
	email: string;
	password: string;
	confirmPassword: string;
};

export type RegisterErrors = {
	email?: string;
	password?: string;
	confirmPassword?: string;
};

export class AuthValidator {
	// --- email validation ---
	static validateEmail(email: string): string | null {
		const trimmed = email.trim();
		if (!trimmed) return 'Email is required.';
		// Basic regex, can be improved
		const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailPattern.test(trimmed)) return 'Enter a valid email address.';
		return null;
	}

	// --- password validation ---
	static validatePassword(password: string, email?: string): string | null {
		if (!password) {
			return 'Password is required.';
		}

		if (password.length < 8) {
			return 'Password must be at least 8 characters long.';
		}

		if (!/[a-z]/.test(password)) {
			return 'Password must contain at least one lowercase letter.';
		}

		if (!/[A-Z]/.test(password)) {
			return 'Password must contain at least one uppercase letter.';
		}

		if (!/[0-9]/.test(password)) {
			return 'Password must contain at least one digit.';
		}

		if (!/[^A-Za-z0-9]/.test(password)) {
			return 'Password must contain at least one symbol.';
		}

		if (/\s/.test(password)) {
			return 'Password must not contain spaces.';
		}

		if (email) {
			const trimmedEmail = email.trim();
			if (trimmedEmail) {
				const escapedEmail = escape(trimmedEmail);
				const emailInPassword = new RegExp(escapedEmail, 'i');

				if (emailInPassword.test(password)) {
					return 'Password must not contain your email.';
				}
			}
		}

		return null;
	}

	// --- confirm password validation ---
	static validateConfirmPassword(
		password: string,
		confirmPassword: string,
	): string | null {
		if (!confirmPassword) {
			return 'Please confirm your password.';
		}

		if (password !== confirmPassword) {
			return 'Passwords do not match.';
		}

		return null;
	}

	// --- full validation entrypoint ---
	static validate(
		fields: RegisterFields,
	): { ok: boolean; errors: RegisterErrors } {
		const errors: RegisterErrors = {};

		const emailError = this.validateEmail(fields.email);
		if (emailError) errors.email = emailError;

		const passwordError = this.validatePassword(
			fields.password,
			fields.email,
		);
		if (passwordError) errors.password = passwordError;

		const confirmError = this.validateConfirmPassword(
			fields.password,
			fields.confirmPassword,
		);
		if (confirmError) errors.confirmPassword = confirmError;

		const ok = Object.keys(errors).length === 0;

		return { ok, errors };
	}
}

```

### File: packages\ui\deno.json

```json
{
  "name": "@ui",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\ui\mod.ts

```ts

```

### File: packages\ui\utils\ThemeSwitcher.ts

```ts
import { effect, signal } from '@preact/signals';

export const theme = signal<'light' | 'dark'>('dark');

if (typeof window !== 'undefined') {
	const saved = localStorage.getItem('theme');
	if (saved === 'light' || saved === 'dark') theme.value = saved;

	effect(() => {
		document.documentElement.setAttribute('data-theme', theme.value);
		try {
			localStorage.setItem('theme', theme.value);
		} catch {
			//
		}
	});
}

```

### File: packages\utils\server\cookies.ts

```ts

```

### File: packages\utils\server\index.ts

```ts
// packages/server-utils/index.ts

export { ENV } from '../../backend/config.ts';
export { rateLimitByIP } from './rateLimiter.ts';
export {
	buildAccessCookie,
	buildRefreshCookie,
	mintAccessToken,
	mintRefreshToken,
	type SessionClaims,
} from '../../shared/auth/token.ts';
export { hashArgon2id, randomTokenString } from '../../backend/crypto.ts';

```

### File: packages\utils\server\rateLimiter.ts

```ts
// packages/server-utils/rateLimiter.ts

type BucketInfo = {
	count: number;
	resetAt: number; // ms timestamp
};

// naive in-memory store (resets on server restart)
const buckets = new Map<string, BucketInfo>();

export function rateLimitByIP(ip: string, limit = 20, windowMs = 60_000) {
	const now = Date.now();
	const bucket = buckets.get(ip);

	if (!bucket || now > bucket.resetAt) {
		// start/reset bucket
		buckets.set(ip, {
			count: 1,
			resetAt: now + windowMs,
		});
		return { allowed: true, remaining: limit - 1 };
	}

	if (bucket.count >= limit) {
		return { allowed: false, remaining: 0 };
	}

	bucket.count += 1;
	return { allowed: true, remaining: limit - bucket.count };
}

```

### File: scripts\validate_names.ts

```ts
// scripts/validate_names.ts
// Adds support for special route files that start with "_" (e.g. _app, _layout, _middleware, _404)

const kebab = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
const pascal = /^[A-Z][A-Za-z0-9]*$/;

function isDynamicSegment(name: string) {
	return /^\[.+\]$/.test(name);
}

function isSpecialRouteBase(base: string) {
	if (!base.startsWith('_')) return false;
	const rest = base.slice(1);

	// Allow numeric error pages like _404, _500
	if (/^\d+$/.test(rest)) return true;

	// Common special names (Fresh/Next-style)
	const specials = new Set([
		'app',
		'layout',
		'middleware',
		'document',
		'error',
		'404',
		'500',
	]);
	if (specials.has(rest)) return true;

	// Or allow "_<kebab-case>" generally (e.g., _app-shell)
	if (kebab.test(rest)) return true;

	return false;
}

function norm(p: string) {
	return p.replaceAll('\\', '/');
}

async function* walk(dir: string): AsyncGenerator<string> {
	try {
		for await (const entry of Deno.readDir(dir)) {
			const p = `${dir}/${entry.name}`;
			if (entry.isDirectory) yield* walk(p);
			else yield p;
		}
	} catch {
		// ignore missing dirs
	}
}

function pathHasSegment(p: string, segment: 'routes' | 'islands' | 'components'): boolean {
	const parts = norm(p).split('/');
	return parts.includes(segment);
}

function nearestSegmentRoot(p: string, segment: 'routes' | 'islands' | 'components'): string {
	const parts = norm(p).split('/');
	const idx = parts.lastIndexOf(segment);
	return idx >= 0 ? parts.slice(0, idx + 1).join('/') : segment;
}

function checkRoutesPath(filePath: string): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	const root = nearestSegmentRoot(normalized, 'routes');
	const rel = normalized.slice(root.length + 1); // part under routes/

	const parts = rel.split('/');

	// Validate route directories (not filenames)
	for (let i = 0; i < parts.length - 1; i++) {
		const seg = parts[i];
		if (isDynamicSegment(seg)) continue; // allow [id], [...all]
		if (/\s/.test(seg)) errors.push(`folder "${seg}" must not contain spaces`);
		if (/[A-Z]/.test(seg)) errors.push(`folder "${seg}" must not contain uppercase`);
		if (!kebab.test(seg)) errors.push(`folder "${seg}" must be kebab-case or [dynamic]`);
	}

	// Validate filename
	const file = parts[parts.length - 1];
	const extMatch = file.match(/\.(tsx|ts|jsx|js)$/);
	if (!extMatch) return errors; // only care about code files

	const base = file.replace(/\.(tsx|ts|jsx|js)$/, '');
	if (
		base === 'index' ||
		isDynamicSegment(base) ||
		isSpecialRouteBase(base) // <-- NEW: allow _app, _layout, _404, or _<kebab>
	) {
		return errors;
	}

	if (/\s/.test(base)) errors.push(`file "${file}" must not contain spaces`);
	if (/[A-Z]/.test(base)) errors.push(`file "${file}" must not contain uppercase`);
	if (!kebab.test(base)) {
		errors.push(`file "${file}" must be kebab-case (or [dynamic]/index/_special)`);
	}

	return errors.map((e) => `routes: ${e} -> ${normalized}`);
}

function checkPascalDir(filePath: string, segment: 'islands' | 'components'): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	if (!/\.tsx$/.test(normalized)) return errors; // only enforce for TSX components

	const file = normalized.split('/').pop()!;
	const base = file.replace(/\.tsx$/, '');
	if (!pascal.test(base)) {
		errors.push(`${segment}: "${file}" must be PascalCase.tsx -> ${normalized}`);
	}
	return errors;
}

async function run() {
	const violations: string[] = [];
	for await (const file of walk('.')) {
		const p = norm(file);

		// Skip obvious non-source areas
		if (
			p.includes('/node_modules/') ||
			p.includes('/dist/') ||
			p.includes('/tmp/') ||
			p.includes('/infra/') ||
			p.includes('/supabase/')
		) continue;

		if (pathHasSegment(p, 'routes')) violations.push(...checkRoutesPath(p));
		if (pathHasSegment(p, 'islands')) violations.push(...checkPascalDir(p, 'islands'));
		if (pathHasSegment(p, 'components')) violations.push(...checkPascalDir(p, 'components'));
	}

	if (violations.length) {
		console.error('\n❌ Naming violations (' + violations.length + '):');
		for (const v of violations) console.error(' - ' + v);
		Deno.exit(1);
	} else {
		console.log('✅ Naming conventions OK');
	}
}

await run();

```

### File: vite.config.ts

```ts
import { defineConfig } from 'vite';
import { fresh } from '@fresh/plugin-vite';
import { fileURLToPath } from 'node:url';

const r = (p: string) => fileURLToPath(new URL(p, import.meta.url));

export default defineConfig({
	root: 'apps/web',

	plugins: [fresh()],

	resolve: {
		alias: {
			'@': r('./apps/web/'),
			'@styles': r('./apps/web/styles/'),
			'@components': r('./apps/web/components/'),
			'@features': r('./apps/web/features/'),
			'@islands': r('./apps/web/islands/'),
			'@server': r('./apps/web/server/'),
			'@services': r('./apps/web/services/'),
			'@types': r('./apps/web/types/'),
			'@utils': r('./apps/web/utils.ts'),
			'packages': r('./packages'),
		},
	},
});

```


```

### File: db\functions\auth_project_or_dm_participant.sql

```sql
��- -   E x a m p l e   S Q L   f u n c t i o n  
 
```

### File: db\migrations\0001_init_schemas.sql

```sql
-- db/migrations/0001_init_schemas.sql

-- core schemas
CREATE SCHEMA IF NOT EXISTS security;
CREATE SCHEMA IF NOT EXISTS org;
CREATE SCHEMA IF NOT EXISTS projects;
CREATE SCHEMA IF NOT EXISTS comms;
CREATE SCHEMA IF NOT EXISTS finance;
CREATE SCHEMA IF NOT EXISTS marketplace;
CREATE SCHEMA IF NOT EXISTS search;
CREATE SCHEMA IF NOT EXISTS ops;
CREATE SCHEMA IF NOT EXISTS analytics;
CREATE SCHEMA IF NOT EXISTS integrations;

-- enums
CREATE TYPE profile_type AS ENUM ('freelancer', 'business');
CREATE TYPE assignment_type AS ENUM ('freelancer', 'team');
CREATE TYPE visibility AS ENUM ('public', 'invite_only', 'unlisted');
CREATE TYPE project_status AS ENUM ('draft', 'active', 'on_hold', 'completed', 'cancelled');
CREATE TYPE stage_status AS ENUM ('open','assigned','in_progress','submitted','approved','revisions','paid');
CREATE TYPE dispute_status AS ENUM ('open', 'under_review', 'resolved', 'refunded');


```

### File: db\migrations\0002_security_tables.sql

```sql
CREATE TABLE security.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  action text NOT NULL,
  entity_table text NOT NULL,
  entity_id uuid NOT NULL,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  ip inet,
  user_agent text,
  request_id uuid,
  actor_profile_id uuid,
  actor_team_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);

CREATE TABLE security.feature_flags (
  key text NOT NULL,
  enabled boolean NOT NULL DEFAULT false,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT feature_flags_pkey PRIMARY KEY (key)
);

CREATE TABLE security.refresh_tokens (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL,
    token_hash text NOT NULL,
    revoked boolean NOT NULL DEFAULT false,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        replaced_by uuid,
        CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id),
        CONSTRAINT refresh_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id),
        CONSTRAINT refresh_tokens_replaced_by_fkey FOREIGN KEY (replaced_by) REFERENCES security.refresh_tokens (id)
);

CREATE TABLE security.session_context (
    user_id uuid NOT NULL,
    active_profile_type USER - DEFINED NOT NULL,
    active_profile_id uuid NOT NULL,
    active_team_id uuid,
    updated_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT session_context_pkey PRIMARY KEY (user_id),
        CONSTRAINT session_context_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);

CREATE TABLE security.turnstile_verifications (
    id uuid NOT NULL DEFAULT gen_random_uuid (),
    user_id uuid,
    ip inet NOT NULL,
    token_prefix text NOT NULL,
    success boolean NOT NULL,
    created_at timestamp
    with
        time zone NOT NULL DEFAULT now(),
        CONSTRAINT turnstile_verifications_pkey PRIMARY KEY (id),
        CONSTRAINT turnstile_verifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id)
);
```

### File: db\migrations\0003_org_tables.sql

```sql
CREATE TABLE org.business_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_user_id uuid NOT NULL REFERENCES auth.users(id),
  name text NOT NULL,
  legal_name text,
  logo_url text,
  country text,
  billing_email text NOT NULL,
  plan text NOT NULL DEFAULT 'free',
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  default_currency text
);

CREATE TABLE org.freelancer_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id),
  hourly_rate integer,
  skills text[] NOT NULL DEFAULT '{}',
  bio text NOT NULL DEFAULT '',
  headline text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  country text,
  visibility text NOT NULL DEFAULT 'public', 
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.skills (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    slug text NOT NULL UNIQUE,
    label text NOT NULL
);

CREATE TABLE org.user_skills (
    user_id uuid NOT NULL REFERENCES auth.users (id),
    skill_id uuid NOT NULL REFERENCES org.skills (id),
    proficiency smallint,
    PRIMARY KEY (user_id, skill_id)
);

CREATE TABLE org.users_public (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id),
  avatar_url text,
  country text,
  created_at timestamptz NOT NULL DEFAULT now(),
  headline text NOT NULL DEFAULT '',
  bio text NOT NULL DEFAULT '',
  languages text[] NOT NULL DEFAULT '{}',
  timezone text,
  visibility text NOT NULL DEFAULT 'unlisted',
  first_name text,
  last_name text,
  username text NOT NULL UNIQUE
);

CREATE TABLE org.teams (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    name text NOT NULL,
    owner_user_id uuid NOT NULL REFERENCES auth.users (id),
    description text NOT NULL DEFAULT '',
    visibility text NOT NULL DEFAULT 'invite_only',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.team_memberships (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    role text NOT NULL DEFAULT 'freelancer',
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (team_id, user_id)
);

CREATE TABLE org.team_roles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    team_id uuid NOT NULL REFERENCES org.teams (id),
    title text NOT NULL,
    permissions jsonb NOT NULL DEFAULT '{}'
);

CREATE TABLE org.user_emails (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id),
    email text NOT NULL,
    is_primary boolean NOT NULL DEFAULT false,
    verified_at timestamptz,
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (user_id, email)
);

CREATE TABLE org.attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_profile_id uuid NOT NULL,
    bucket text NOT NULL,
    path text NOT NULL,
    original_filename text NOT NULL,
    display_name text NOT NULL,
    mime_type text NOT NULL,
    size_bytes bigint NOT NULL,
    sha256 text,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_freelancer FOREIGN KEY (owner_profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.attachments
ADD CONSTRAINT fk_attachments_owner_business FOREIGN KEY (owner_profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.portfolios (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id),
    title text NOT NULL,
    description text NOT NULL,
    cover_url text,
    attachment_id uuid REFERENCES org.attachments (id) ON DELETE SET NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE org.profile_links (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_type text NOT NULL,
    profile_id uuid NOT NULL,
    kind text NOT NULL,
    url text NOT NULL,
    is_public boolean NOT NULL DEFAULT true,
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE org.profile_links
ADD CONSTRAINT fk_profile_links_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED;

CREATE TABLE org.org_invitations (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    inviter_user_id uuid NOT NULL REFERENCES auth.users (id),
    target_email text NOT NULL,
    team_id uuid REFERENCES org.teams (id) ON DELETE CASCADE,
    business_profile_id uuid REFERENCES org.business_profiles (id) ON DELETE CASCADE,
    token text NOT NULL,
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz NOT NULL DEFAULT now()
);
```

### File: db\migrations\0004_ops_tables.sql

```sql
CREATE TABLE ops.admin_users (
  user_id uuid NOT NULL,
  role text NOT NULL DEFAULT 'admin'::text,
  granted_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT admin_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT admin_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT admin_users_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES auth.users(id)
);
```

### File: db\migrations\0005_projects_tables.sql

```sql
CREATE TABLE IF NOT EXISTS projects.projects (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    client_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    title text NOT NULL,
    description text NOT NULL,
    status project_status NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_projects_client_business ON projects.projects (client_business_id);

CREATE INDEX IF NOT EXISTS idx_projects_status_created_at ON projects.projects (status, created_at DESC);

CREATE TABLE IF NOT EXISTS projects.project_stages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    "order" integer NOT NULL,
    description text NOT NULL,
    status stage_status NOT NULL DEFAULT 'open',
    due_date timestamptz NULL,
    completed_at timestamptz NULL,
    stage_type text NULL,
    ip_mode text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_project_stages_project_order ON projects.project_stages (project_id, "order");

CREATE INDEX IF NOT EXISTS idx_project_stages_project_status ON projects.project_stages (project_id, status);

CREATE TABLE IF NOT EXISTS projects.stage_budget_rules (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    type text NOT NULL,
    amount_currency text NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    notes text NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_budget_rules_stage ON projects.stage_budget_rules (project_stage_id);

CREATE TABLE IF NOT EXISTS projects.stage_assignments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    assignee_type assignment_type NOT NULL,
    freelancer_profile_id uuid NULL REFERENCES org.freelancer_profiles (id) ON DELETE SET NULL,
    team_id uuid NULL REFERENCES org.teams (id) ON DELETE SET NULL,
    assigned_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    status text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_stage_assignments_assignee CHECK (
        (
            assignee_type = 'freelancer'
            AND freelancer_profile_id IS NOT NULL
            AND team_id IS NULL
        )
        OR (
            assignee_type = 'team'
            AND team_id IS NOT NULL
            AND freelancer_profile_id IS NULL
        )
    )
);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_stage ON projects.stage_assignments (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_assignments_freelancer ON projects.stage_assignments (freelancer_profile_id)
WHERE
    freelancer_profile_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_stage_assignments_team ON projects.stage_assignments (team_id)
WHERE
    team_id IS NOT NULL;

CREATE TABLE IF NOT EXISTS projects.stage_submissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    submitted_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_stage_submissions_stage_created ON projects.stage_submissions (
    project_stage_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS projects.stage_revision_requests (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    requested_by uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    type text NOT NULL,
    reason text NOT NULL,
    status text NOT NULL DEFAULT 'open',
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_stage ON projects.stage_revision_requests (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_stage_revision_requests_status ON projects.stage_revision_requests (status);

CREATE TABLE IF NOT EXISTS projects.maintenance_contracts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    freelancer_profile_id uuid NOT NULL REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT,
    business_profile_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    amount_cents bigint NOT NULL CHECK (amount_cents >= 0),
    currency text NOT NULL,
    interval text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_project ON projects.maintenance_contracts (project_id);

CREATE INDEX IF NOT EXISTS idx_maintenance_contracts_business ON projects.maintenance_contracts (business_profile_id);

CREATE TABLE IF NOT EXISTS projects.project_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_project_participants_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_project_participants_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_project_participants_project_profile ON projects.project_participants (
    project_id,
    profile_type,
    profile_id
);

CREATE INDEX IF NOT EXISTS idx_project_participants_profile ON projects.project_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS projects.project_activity (
id            uuid        PRIMARY KEY DEFAULT gen_random_uuid(),
project_id    uuid        NOT NULL REFERENCES projects.projects(id) ON DELETE CASCADE,
actor_user_id uuid        NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
kind          text        NOT NULL, 
payload       jsonb       NOT NULL DEFAULT '{}'::jsonb,
entity_table  text        NOT NULL,
entity_id     uuid        NOT NULL,
created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_project_activity_project_created ON projects.project_activity (project_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_project_activity_entity ON projects.project_activity (entity_table, entity_id);

COMMIT;
```

### File: db\migrations\0006_comms_tables.sql

```sql
CREATE TABLE IF NOT EXISTS comms.project_channels (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    name text NOT NULL,
    stage_id uuid NULL REFERENCES projects.project_stages (id) ON DELETE SET NULL,
    visibility text NOT NULL DEFAULT 'project_all',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_project_channels_project_name UNIQUE (project_id, name)
);

CREATE INDEX IF NOT EXISTS idx_project_channels_project ON comms.project_channels (project_id);

CREATE INDEX IF NOT EXISTS idx_project_channels_stage ON comms.project_channels (stage_id);

CREATE TABLE IF NOT EXISTS comms.project_channel_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    profile_type profile_type NOT NULL,
    profile_id uuid NOT NULL,
    role text NOT NULL DEFAULT 'participant',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT fk_projchan_participant_freelancer FOREIGN KEY (profile_id) REFERENCES org.freelancer_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT fk_projchan_participant_business FOREIGN KEY (profile_id) REFERENCES org.business_profiles (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED,
    CONSTRAINT uq_project_channel_participant UNIQUE (
        channel_id,
        profile_type,
        profile_id
    )
);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_channel ON comms.project_channel_participants (channel_id);

CREATE INDEX IF NOT EXISTS idx_project_channel_participants_profile ON comms.project_channel_participants (profile_type, profile_id);

CREATE TABLE IF NOT EXISTS comms.project_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_id uuid NOT NULL REFERENCES comms.project_channels (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    edited_at timestamptz NULL,
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_project_messages_channel_created ON comms.project_messages (channel_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.dm_threads (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    created_by_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dm_threads_creator ON comms.dm_threads (
    created_by_user_id,
    created_at DESC
);

CREATE TABLE IF NOT EXISTS comms.dm_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    joined_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_dm_participants_thread_user UNIQUE (thread_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_dm_participants_user ON comms.dm_participants (user_id);

CREATE TABLE IF NOT EXISTS comms.dm_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    thread_id uuid NOT NULL REFERENCES comms.dm_threads (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_dm_messages_thread_created ON comms.dm_messages (thread_id, created_at DESC);

CREATE TABLE IF NOT EXISTS comms.message_attachments (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    message_table text NOT NULL,
    message_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_message_attachments_table CHECK (
        message_table IN (
            'comms.project_messages',
            'comms.dm_messages'
        )
    ),
    CONSTRAINT uq_message_attachment UNIQUE (
        message_table,
        message_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_message_attachments_message ON comms.message_attachments (message_table, message_id);

CREATE INDEX IF NOT EXISTS idx_message_attachments_attachment ON comms.message_attachments (attachment_id);

CREATE TABLE IF NOT EXISTS comms.channel_files (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    channel_type text NOT NULL,
    channel_id uuid NOT NULL,
    attachment_id uuid NOT NULL REFERENCES org.attachments (id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT chk_channel_files_type CHECK (
        channel_type IN ('project', 'dm')
    ),
    CONSTRAINT uq_channel_files_channel_attachment UNIQUE (
        channel_type,
        channel_id,
        attachment_id
    )
);

CREATE INDEX IF NOT EXISTS idx_channel_files_channel ON comms.channel_files (channel_type, channel_id);

CREATE INDEX IF NOT EXISTS idx_channel_files_attachment ON comms.channel_files (attachment_id);

CREATE TABLE IF NOT EXISTS comms.notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    type text NOT NULL,
    title text NOT NULL,
    body text NOT NULL,
    entity_table text NULL,
    entity_id uuid NULL,
    read_at timestamptz NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notifications_user_created ON comms.notifications (user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_notifications_user_unread ON comms.notifications (user_id)
WHERE
    read_at IS NULL;

CREATE TABLE IF NOT EXISTS comms.notification_prefs (
    user_id uuid PRIMARY KEY REFERENCES auth.users (id) ON DELETE CASCADE,
    email boolean NOT NULL DEFAULT true,
    push boolean NOT NULL DEFAULT false,
    in_app boolean NOT NULL DEFAULT true,
    digest boolean NOT NULL DEFAULT false,
    quiet_hours tstzrange NULL
);

CREATE TABLE IF NOT EXISTS comms.device_tokens (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
    provider text NOT NULL,
    token text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_device_tokens_provider_token UNIQUE (provider, token)
);

CREATE INDEX IF NOT EXISTS idx_device_tokens_user ON comms.device_tokens (user_id);

DO $$
BEGIN
PERFORM 1
FROM pg_publication
WHERE pubname = 'supabase_realtime';

IF NOT FOUND THEN
CREATE PUBLICATION supabase_realtime;
END IF;
END;
$$;


ALTER TABLE comms.project_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.dm_messages REPLICA IDENTITY FULL;

ALTER TABLE comms.notifications REPLICA IDENTITY FULL;

ALTER PUBLICATION supabase_realtime
ADD
TABLE comms.project_messages,
comms.dm_messages,
comms.notifications;
```

### File: db\migrations\0007_finance_tables.sql

```sql
CREATE TABLE IF NOT EXISTS finance.wallets (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    currency text NOT NULL,
    balance_cents bigint NOT NULL DEFAULT 0 CHECK (balance_cents >= 0),
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_wallet_owner_currency UNIQUE (
        owner_type,
        owner_id,
        currency
    )
);

CREATE INDEX IF NOT EXISTS idx_wallets_owner ON finance.wallets (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.transactions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    wallet_id uuid NOT NULL REFERENCES finance.wallets (id) ON DELETE CASCADE,
    direction text NOT NULL CHECK (
        direction IN ('credit', 'debit')
    ),
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    reason text NOT NULL,
    ref_table text NULL,
    ref_id uuid NULL,
    balance_after_cents bigint NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_transactions_wallet_created ON finance.transactions (wallet_id, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.escrows (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE RESTRICT,
    payer_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    payee_type assignment_type NOT NULL,
    payee_id uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'funded',
    created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_freelancer FOREIGN KEY (payee_id) REFERENCES org.freelancer_profiles (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

ALTER TABLE finance.escrows
ADD CONSTRAINT fk_escrows_payee_team FOREIGN KEY (payee_id) REFERENCES org.teams (id) ON DELETE RESTRICT DEFERRABLE INITIALLY DEFERRED;

CREATE INDEX IF NOT EXISTS idx_escrows_stage ON finance.escrows (project_stage_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payer_business ON finance.escrows (payer_business_id);

CREATE INDEX IF NOT EXISTS idx_escrows_payee ON finance.escrows (payee_type, payee_id);

CREATE TABLE IF NOT EXISTS finance.payout_accounts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    owner_type text NOT NULL,
    owner_id uuid NOT NULL,
    provider text NOT NULL,
    account_id text NOT NULL,
    status text NOT NULL DEFAULT 'pending_verification',
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uq_payout_accounts_provider_account UNIQUE (provider, account_id)
);

CREATE INDEX IF NOT EXISTS idx_payout_accounts_owner ON finance.payout_accounts (owner_type, owner_id);

CREATE TABLE IF NOT EXISTS finance.invoices (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_stage_id uuid NOT NULL REFERENCES projects.project_stages (id) ON DELETE CASCADE,
    issue_to_business_id uuid NOT NULL REFERENCES org.business_profiles (id) ON DELETE RESTRICT,
    issue_from_profile uuid NOT NULL,
    amount_cents bigint NOT NULL CHECK (amount_cents > 0),
    currency text NOT NULL,
    status text NOT NULL DEFAULT 'draft',
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_invoices_business ON finance.invoices (
    issue_to_business_id,
    created_at DESC
);

CREATE INDEX IF NOT EXISTS idx_invoices_stage ON finance.invoices (project_stage_id);

CREATE TABLE IF NOT EXISTS finance.disputes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    escrow_id uuid NOT NULL REFERENCES finance.escrows (id) ON DELETE CASCADE,
    opened_by_profile uuid NOT NULL,
    reason text NOT NULL,
    status dispute_status NOT NULL DEFAULT 'open',
    resolution_notes text NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    resolved_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_disputes_escrow ON finance.disputes (escrow_id);

CREATE INDEX IF NOT EXISTS idx_disputes_status ON finance.disputes (status, created_at DESC);

CREATE TABLE IF NOT EXISTS finance.dispute_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    dispute_id uuid NOT NULL REFERENCES finance.disputes (id) ON DELETE CASCADE,
    sender_user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE RESTRICT,
    body text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_dispute_messages_dispute_created ON finance.dispute_messages (dispute_id, created_at ASC);

CREATE TABLE IF NOT EXISTS finance.ratings (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    project_id uuid NOT NULL REFERENCES projects.projects (id) ON DELETE CASCADE,
    rater_profile uuid NOT NULL,
    ratee_type text NOT NULL,
    ratee_id uuid NOT NULL,
    score smallint NOT NULL CHECK (score BETWEEN 1 AND 5),
    comment text NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_ratings_ratee ON finance.ratings (ratee_type, ratee_id);

CREATE INDEX IF NOT EXISTS idx_ratings_project ON finance.ratings (project_id);

CREATE TABLE IF NOT EXISTS finance.subscriptions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid (),
    profile_id uuid NOT NULL,
    plan text NOT NULL,
    status text NOT NULL DEFAULT 'active',
    started_at timestamptz NOT NULL DEFAULT now(),
    ends_at timestamptz NULL
);

CREATE INDEX IF NOT EXISTS idx_subscriptions_profile ON finance.subscriptions (profile_id, status);
```

### File: db\migrations\0020_helpers_functions.sql

```sql
-- db/migrations/0004_helpers_functions.sql

-- NOTE: we rely on pgcrypto/gen_random_uuid(). Make sure extension is on.
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- is_admin(): check ops.admin_users
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean
LANGUAGE sql
STABLE
SECURITY DEFINER
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$;

-- simple debug helper: return current JWT context
CREATE OR REPLACE FUNCTION security.current_context()
RETURNS jsonb
LANGUAGE sql
STABLE
AS $$
  SELECT jsonb_build_object(
    'user_id', auth.uid(),
    'active_profile_type', auth.jwt()->>'active_profile_type',
    'active_profile_id',   auth.jwt()->>'active_profile_id',
    'active_team_id',      auth.jwt()->>'active_team_id'
  );
$$;

```

### File: db\policies\org\business_profiles.sql

```sql
ALTER TABLE org.business_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_business_profiles_select_owner
ON org.business_profiles
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create business profiles for themselves
CREATE POLICY pol_org_business_profiles_insert_self
ON org.business_profiles
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: owner or admin
CREATE POLICY pol_org_business_profiles_update_owner
ON org.business_profiles
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_business_profiles_delete_owner
ON org.business_profiles
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\freelancer_profiles.sql

```sql
ALTER TABLE org.freelancer_profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: owner or admin
CREATE POLICY pol_org_freelancer_profiles_select_owner
ON org.freelancer_profiles
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: user can create exactly one freelancer profile tied to themselves
CREATE POLICY pol_org_freelancer_profiles_insert_self
ON org.freelancer_profiles
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner / admin can edit
CREATE POLICY pol_org_freelancer_profiles_update_owner
ON org.freelancer_profiles
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

/* no DELETE */

```

### File: db\policies\org\teams.sql

```sql
ALTER TABLE org.teams ENABLE ROW LEVEL SECURITY;

-- SELECT: show teams you are a member of OR that you own OR admin
CREATE POLICY pol_org_teams_select_member_or_owner
ON org.teams
FOR SELECT
USING (
  owner_user_id = auth.uid()
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships tm
    WHERE tm.team_id = id
      AND tm.user_id = auth.uid()
      AND tm.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: any user can create a team they own
CREATE POLICY pol_org_teams_insert_self
ON org.teams
FOR INSERT
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: only owner or admin
CREATE POLICY pol_org_teams_update_owner
ON org.teams
FOR UPDATE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: owner or admin
CREATE POLICY pol_org_teams_delete_owner
ON org.teams
FOR DELETE
USING (
  owner_user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\org\team_memberships.sql

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;

-- SELECT: any active member of the same team may view
CREATE POLICY pol_org_team_memberships_select_team_member
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin) can add members
CREATE POLICY pol_org_team_memberships_insert_team_owner
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner, team_lead/admin role, or platform admin
CREATE POLICY pol_org_team_memberships_update_team_owner
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK (
  TRUE
);

-- DELETE: same as update (remove member)
CREATE POLICY pol_org_team_memberships_delete_team_owner
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

```

### File: db\policies\org\users_public.sql

```sql
��A L T E R   T A B L E   o r g . u s e r s _ p u b l i c   E N A B L E   R O W   L E V E L   S E C U R I T Y ;  
  
 - -   A n y   l o g g e d - i n   u s e r   c a n   r e a d   p u b l i c   p r o f i l e s  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ s e l e c t _ a l l _ a u t h  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   S E L E C T  
 U S I N G   (   a u t h . u i d ( )   I S   N O T   N U L L   ) ;  
  
 - -   U s e r   c a n   c r e a t e   t h e i r   o w n   p u b l i c   r o w  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ i n s e r t _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   I N S E R T  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 - -   U s e r   c a n   u p d a t e   o n l y   t h e i r   o w n   r o w   ( o r   a d m i n   c a n )  
 C R E A T E   P O L I C Y   p o l _ o r g _ u s e r s _ p u b l i c _ u p d a t e _ s e l f  
 O N   o r g . u s e r s _ p u b l i c  
 F O R   U P D A T E  
 U S I N G   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 )  
 W I T H   C H E C K   (  
     u s e r _ i d   =   a u t h . u i d ( )  
     O R   s e c u r i t y . i s _ a d m i n ( )   =   t r u e  
 ) ;  
  
 / *   n o   D E L E T E   * /  
 
```

### File: db\policies\org\user_emails.sql

```sql
ALTER TABLE org.user_emails ENABLE ROW LEVEL SECURITY;

-- SELECT: you can read only your own email records
CREATE POLICY pol_org_user_emails_select_self
ON org.user_emails
FOR SELECT
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- INSERT: you can add an email for yourself
CREATE POLICY pol_org_user_emails_insert_self
ON org.user_emails
FOR INSERT
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- UPDATE: you can update only your own row
CREATE POLICY pol_org_user_emails_update_self
ON org.user_emails
FOR UPDATE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
)
WITH CHECK (
  user_id = auth.uid()
  OR security.is_admin() = true
);

-- DELETE: you can delete only your own row
CREATE POLICY pol_org_user_emails_delete_self
ON org.user_emails
FOR DELETE
USING (
  user_id = auth.uid()
  OR security.is_admin() = true
);

```

### File: db\policies\security\audit_logs.sql

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

-- allow a user to read only their own audit trail, plus admins
CREATE POLICY pol_security_audit_logs_select_self_or_admin
ON security.audit_logs
FOR SELECT
USING (
  audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- no INSERT/UPDATE/DELETE policies for public
-- audit rows are inserted by service_role from the API layer

```

### File: db\policies\security\refresh_tokens.sql

```sql
ALTER TABLE security.refresh_tokens ENABLE ROW LEVEL SECURITY;

-- DO NOT expose refresh tokens to regular users at all.
-- No SELECT/INSERT/UPDATE/DELETE policies on purpose.

-- Only service_role should ever touch this table, and service_role bypasses RLS.
-- That means from the browser you literally cannot query this table.

```

### File: db\policies\security\session_context.sql

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;

-- SELECT own context
CREATE POLICY pol_security_session_context_select_self
ON security.session_context
FOR SELECT
USING ( user_id = auth.uid() );

-- INSERT own context
CREATE POLICY pol_security_session_context_insert_self
ON security.session_context
FOR INSERT
WITH CHECK ( user_id = auth.uid() );

-- UPDATE own context
CREATE POLICY pol_security_session_context_update_self
ON security.session_context
FOR UPDATE
USING ( user_id = auth.uid() )
WITH CHECK ( user_id = auth.uid() );

-- no DELETE policy for normal users

```

### File: db\policies\security\v_current_context.sql

```sql
ALTER VIEW security.v_current_context SET (security_invoker = true);

-- Views don’t use RLS directly, so we do NOT need policies here.
-- The WHERE clause already ties it to auth.uid().
-- (If Supabase complains about querying this view from the client,
-- you can instead expose a helper RPC function.)

```

### File: db\views\analytics_earnings_by_stage_mv.sql

```sql
��- -   E x a m p l e   m a t e r i a l i z e d   v i e w  
 
```

### File: db\views\security\v_current_context.sql

```sql
CREATE OR REPLACE VIEW security.v_current_context AS
SELECT
  sc.user_id,
  sc.active_profile_type,
  sc.active_profile_id,
  sc.active_team_id,
  sc.updated_at
FROM security.session_context sc
WHERE sc.user_id = auth.uid();

```

### File: deno.json

```json
{
  "nodeModulesDir": "auto",
  "workspace": [
    "./apps/web",
    "./packages/shared",
    "./packages/backend",
    "./packages/ui"
  ],
  "tasks": {
    "format": "deno fmt --check",
    "lint": "deno lint",
    "typecheck": "deno check",
    "names": "deno run -A scripts/validate_names.ts",
    "check": "deno fmt --check && deno lint && deno check && deno run -A scripts/validate_names.ts",
    "test": "deno test --fail-fast --coverage=coverage -A --trace-leaks",
    "dev": "vite --port 3000 --open --host --mode development",
    "build": "vite build --mode production",
    "start": "deno serve -A --watch --port 3000 --env-file=.env.production apps/web/_fresh/server.js",
    "update": "deno run -A -r jsr:@fresh/update .",
    "db:reset": "bash db/scripts/test_db_reset.sh",
    "db:smoke": "supabase db query < db/scripts/test_db_smoke.sql",
    "coverage:lcov": "deno coverage coverage --lcov --output=coverage.lcov",
    "coverage:html": "deno coverage coverage --html",
    "preview": "deno run -A main.ts"
  },
  "fmt": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "_fresh/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx",
        "*.css"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "options": {
      "lineWidth": 100,
      "indentWidth": 2,
      "useTabs": true,
      "singleQuote": true
    }
  },
  "lint": {
    "files": {
      "include": [
        "apps/web/**/*",
        "routes/**/*",
        "islands/**/*",
        "components/**/*",
        "features/**/*",
        "plugins/**/*",
        "utils/**/*",
        "services/**/*",
        "scripts/**/*",
        "lib/**/*",
        "*.ts",
        "*.tsx",
        "*.js",
        "*.jsx"
      ],
      "exclude": [
        "node_modules/**",
        "dist/**",
        "tmp/**",
        "infra/**",
        "supabase/**",
        "**/*.md"
      ]
    },
    "rules": { "tags": ["recommended", "fresh"] }
  },
  "compilerOptions": {
    "lib": ["dom", "dom.asynciterable", "dom.iterable", "deno.ns"],
    "jsx": "react-jsx",
    "jsxImportSource": "preact",
    "jsxPrecompileSkipElements": [
      "a",
      "img",
      "source",
      "body",
      "html",
      "head",
      "title",
      "meta",
      "script",
      "link",
      "style",
      "base",
      "noscript",
      "template"
    ],
    "types": ["vite/client"]
  },
  "imports": {
    "@std/assert": "jsr:@std/assert@^1.0.15",
    "@std/dotenv": "jsr:@std/dotenv@^0.225.5",
    "@std/http": "jsr:@std/http@^1.0.21",
    "@fresh/plugin-vite": "jsr:@fresh/plugin-vite@^1.0.8",
    "@preact/signals": "npm:@preact/signals@^2.5.0",
    "@std/regexp": "jsr:@std/regexp@^1.0.1",
    "@tabler/icons-preact": "npm:@tabler/icons-preact@^3.35.0",
    "djwt": "jsr:@zaubrik/djwt@^3.0.2",
    "fresh": "jsr:@fresh/core@^2.2.0",
    "preact": "npm:preact@^10.27.2",
    "supabaseClient": "npm:@supabase/supabase-js@2.76.1",

    "packages/": "./packages/",
    "@shared": "./packages/shared/mod.ts",
    "@backend": "./packages/backend/mod.ts",
    "@ui": "./packages/ui/mod.ts",

    "@/": "./apps/web/",
    "@components/": "./apps/web/components/",
    "@islands/": "./apps/web/islands/",
    "@styles/": "./apps/web/styles/",
    "@server/": "./apps/web/server/",
    "@contracts/": "./apps/web/contracts/",
    "@utils": "./apps/web/utils.ts"
  },
  "exclude": ["**/_fresh/*"]
}

```

### File: docs\01_Vision.md

```md
# Platform for Collaborative Freelancing

### Vision

A modern freelancing ecosystem where businesses can hire individuals, multiple freelancers, or entire teams to collaborate on structured projects with predefined costs and deliverables.

### Core Philosophy

- **Collaboration-first**: Freelancers can form teams that function like micro-agencies.
- **Transparency**: Clear pricing per stage, no endless negotiations.
- **Scalability**: Businesses can scale from one freelancer to entire coordinated teams.
- **Fair entry**: Low barrier for new freelancers via transparent stage pricing and templated projects.

### Problem

Traditional freelancing platforms (Upwork, Fiverr) isolate freelancers and force clients into constant negotiation. This slows projects, fragments collaboration, and inflates costs.

### Solution

A project-based collaboration platform that:

- Simplifies hiring through structured **project templates**.
- Allows **freelancers and teams** to work together.
- Supports **fixed-stage budgets** with optional revisions.
- Provides a **shared workspace** with chat, file exchange, and progress tracking.

### Elevator Pitch

> “A collaborative freelancing marketplace where teams deliver complete projects with predictable pricing — the efficiency of Fiverr meets the teamwork of Upwork agencies.”

```

### File: docs\02_Features.md

```md
# Core Features

## For Businesses

- Post projects or use guided templates.
- Hire individuals or full teams.
- Mix freelancers and teams per project stage.
- Track progress, files, and communications in one workspace.
- Approve and pay by stage (Design, MVP, Testing, etc.).
- Set budgets for revisions and maintenance.

## For Freelancers

- Create portfolios with previous work.
- Form or join **freelancer teams**.
- Offer stage-based pricing.
- Apply to project templates.
- Showcase completed work and, later, sell digital assets.

## For Freelancer Teams

- Define roles, pricing, and collaborative tools.
- Manage internal task boards.
- Share revenue and reviews collectively.

---

# Future Enhancements (Phase 4+)

- **Marketplace Layer:** Sell digital assets, templates, or previous work.
- **Smart Matching:** AI-assisted team and project pairing.
- **Escrow & Payments:** Stripe Connect for milestone-based transactions.

```

### File: docs\03_TechStack.md

```md
# Technology Overview

## Frontend

- **Framework:** Deno Fresh + Preact Islands.
- **Runtime:** Deno Deploy (Edge-first).
- **Styling:** Tailwind CSS + Shadcn UI.

## Backend / API

- **Database:** Supabase (PostgreSQL + RLS).
- **Auth:** Supabase Auth (JWT + custom refresh tokens hashed with Argon2id).
- **Realtime:** Supabase Realtime (WebSocket events).
- **Rate Limiting / KV:** Deno KV atomic counters.
- **WASM:** Rust modules compiled to WebAssembly for CPU-heavy work (e.g., image optimization, file processing).
- **Security:**
  - JWT access tokens (short-lived).
  - Hashed refresh tokens (rotated).
  - Strict RLS policies per user/team.
  - CORS & CSP via middleware.
  - Cloudflare Turnstile for bot protection.
  - Signed URLs for all file access.

## Architecture

```text
Frontend (FreshJS Islands)
  |
  ├── Auth + API Gateway (Fresh API routes, Hono optional)
  │     ├── JWT verification
  │     ├── Rate limiting (Deno KV)
  │     ├── Supabase queries (role-based)
  │     └── WASM modules (Rust compute)
  |
  └── Supabase (DB, Auth, Realtime, Storage)
```

## Account Switching Logic

- A single `users` record may own:
  - **One `freelancer_profile`**
  - **Many `business_profiles`**
- The UI includes an **Account Switcher** in the dashboard header.
- When a user switches:
  - Frontend updates the `active_profile_id` in session.
  - Backend JWT claims change (`sub` = user_id, `active_profile` = selected profile).
  - Supabase Row-Level Security filters all queries using `active_profile_id`.
- Context is cached in Deno KV for quick lookups and revocation.

### Example

```text
User (uuid: U1)
├── FreelancerProfile (uuid: F1)
├── BusinessProfile (uuid: B1)
└── BusinessProfile (uuid: B2)

Active session: `{ user_id: U1, active_profile_type: "business", active_profile_id: B2 }`
```

## Team Membership Architecture

- Freelancers can join **multiple teams**.
- Each membership record links a `user_id` to a `team_id` with role-based permissions.
- The UI displays a **Team Selector** (similar to the Account Switcher) showing:
  - Teams owned
  - Teams joined
- Switching between teams updates `active_team_id` in session.
- Supabase RLS filters project data by both `active_profile_id` and `active_team_id`.
- Permissions flow:
  - `freelancer` → can access personal and joined team projects.
  - `team_lead` → can manage members and approve work.
  - `business` → can interact only with teams they hire.

```

### File: docs\04_Roadmap.md

```md
# Phased Roadmap

## Phase 1 — MVP: Core Collaboration

- Auth + roles (client, freelancer, team lead)
- Project creation & management
- Team formation
- Messaging & file sharing
- Stage-based pricing & revision budgets
- Supabase RLS enforcement

## Phase 2 — Payments & Trust

- Stripe Connect (escrow)
- Stage payments & revision releases
- Review & rating system
- Dispute workflow
- Analytics dashboards

## Phase 3 — Guided Hiring

- Project templates (e.g., Web App Build, Marketing Campaign)
- Smart freelancer/team suggestions
- Template-based pricing generator
- Search & recommendation via pgvector

## Phase 4 — Marketplace Expansion

- Freelancer storefronts for templates / assets
- Digital delivery & licensing
- Passive income for freelancers
- Referral & affiliate programs

## Phase 5 — Enterprise Layer

- Multi-team orchestration
- API access for enterprise clients
- Reporting dashboards & audits

```

### File: docs\05_Security.md

```md
# Security Overview

## Authentication & Authorization

- JWT-based access tokens (15m expiry).
- Opaque refresh tokens (rotating, Argon2id-hashed).
- Supabase RLS per project, user, team.
- Project ownership & membership validation at query level.

## API Security

- Rate limiting with Deno KV (60 req/min/user).
- CORS allowlist via env var.
- Content-Security-Policy & Referrer-Policy in middleware.
- CAPTCHA (Turnstile) for anon POST endpoints.
- HTTPS enforced; cookies marked Secure + HttpOnly.

## Data Security

- All Supabase buckets private by default.
- Signed URLs (60s TTL) for file access.
- Encryption at rest (Supabase-managed).
- Sanitized file uploads (MIME + size checks).

## Performance & Scalability

- Edge caching for static routes (Fresh Islands).
- Lazy hydration (Preact islands).
- Deno Deploy’s auto-scaling edge functions.
- Supabase horizontally scalable with PG bloat control.
- Optional Rust WASM compute for heavy workloads.

```

### File: docs\06_InvestorSummary.md

```md
# Executive Summary

### Elevator Pitch

A collaborative freelancing marketplace that lets businesses hire entire teams to deliver projects end-to-end — predictable costs, faster delivery, and fairer work for freelancers.

### Why Now

The freelancing economy is fragmented and inefficient. Businesses waste time managing multiple freelancers separately, while freelancers struggle to collaborate and scale.

### Market

- Global freelancing market: $1.5T (Upwork 2023 report)
- Increasing shift toward distributed, project-based work.
- Opportunity: become the go-to “agency builder” for freelance teams.

### Competitive Advantage

- Collaboration-first architecture (teams > individuals)
- Fixed stage pricing (no endless bidding)
- Built-in transparency for clients
- Future-ready (marketplace + AI-guided hiring)

### Monetization (Phase 2+)

- 10% service fee per project stage
- Subscription tiers for freelancers/teams
- Marketplace commissions (digital assets)
- Team analytics & premium project templates

### Status

- MVP under development using Deno Fresh, Supabase, and Rust WASM.
- Fully open-source stack; minimal operational cost.
- Designed for scalability and transparency.

```

### File: docs\07_UserStories.md

```md
# User Stories – Collaborative Freelancing Platform

## Overview

The platform enables **businesses**, **freelancers**, and **freelancer teams** to collaborate on structured projects with clear budgets and milestones.  
It combines the simplicity of Fiverr, the project depth of Upwork, and the collaboration of small consultancies.

---

## 👤 User Roles

1. **Business Client** – posts projects, hires freelancers or teams, approves work, and manages budgets.
2. **Freelancer** – offers services, applies for projects, and can join multiple teams.
3. **Freelancer Team** – a group of freelancers acting as a mini-agency with shared portfolios and collective pricing.
4. **Multi-Account User (Hybrid)** – a single registered person who can:
   - Own **one freelancer profile** (personal or part of a team).
   - Own and manage **multiple business profiles** (companies, brands, or projects).
   - **Switch accounts** from a single login session without re-authenticating.

---

## 🧱 Core Platform Features

- Discover and filter **individual freelancers**.
- View detailed **freelancer portfolios** and past projects.
- **Create and manage teams** (by freelancers themselves).
- **Hire individuals or full teams** for project stages.
- **Post projects** or choose from **guided project templates**.
- **Set and manage budgets** per project stage or revision type.
- Built-in **messaging and file sharing** for collaboration.
- **Freelancers can sell previous work** (digital templates, products).

---

## 🏗️ Epic 1 – Discovery & Profiles

### As a Business Client:

- I want to **browse and filter freelancers** by skills, experience, rating, and location.
- I want to **view freelancer portfolios** to see examples of past work before hiring.
- I want to **search for teams** that specialize in certain project types.

### As a Freelancer:

- I want to **create a public portfolio** to showcase my best work.
- I want to **list my services and stage-based pricing** clearly.
- I want to **tag my profile with specializations** (e.g., “UI Design”, “MVP Implementation”).

### As a Freelancer Team:

- I want to **build a shared team profile** that highlights collective experience.
- I want to **add or remove members** dynamically as projects evolve.
- I want to **share reviews and ratings** collectively as a team brand.

---

## 🧩 Epic 2 – Project Creation & Hiring

### As a Business Client:

- I want to **post new projects** with clear descriptions, budgets, and deadlines.
- I want to **use project templates** that automatically define common stages (e.g., “Design”, “Testing”).
- I want to **mix and match freelancers or teams per stage** of a project.
- I want to **view cost breakdowns** for each stage before committing.
- I want to **hire multiple freelancers** for larger jobs.
- I want to **hire full teams** for complex, multi-stage projects.

### As a Freelancer or Team:

- I want to **apply to posted projects** that match my skills.
- I want to **see which stages of a project are open for bids or collaboration.**
- I want to **set budgets per stage**, including optional revision costs.
- I want to **propose stage pricing** dynamically (e.g., higher for “Major Revisions”, lower for “Tweaks”).

---

## 💰 Epic 3 – Budgets & Stage Pricing

### As a Business Client:

- I want to **view total project cost** broken down by stage.
- I want to **approve or modify budgets** before finalizing a contract.
- I want to **see optional revision costs** (“Minor Tweaks”, “Major Revisions”).

### As a Freelancer or Team:

- I want to **set fixed budgets per stage** (e.g., Design £40, Implementation £260).
- I want to **offer certain stages for free** to attract clients (e.g., “Consultation – Free”).
- I want to **charge monthly maintenance fees** for ongoing work.

### Example – Team Pricing:

| Stage                        | Description            | Budget     |
| ---------------------------- | ---------------------- | ---------- |
| Market Research & Consulting | Discovery phase        | Free       |
| Design                       | UI/UX layout           | £40        |
| MVP Implementation           | Prototype build        | £260       |
| Full Implementation          | Production-ready build | £430       |
| Testing                      | QA, bug fixes          | £70        |
| Minor Tweaks                 | Post-launch fixes      | £10        |
| Major Revisions              | Reworks                | Up to £300 |
| Maintenance                  | Monthly retainer       | £50/month  |
| Marketing                    | Launch campaigns       | Up to £500 |

---

## 🧑‍💻 Epic 3A – Team Membership

### As a Freelancer:

- I want to **join multiple teams** so I can collaborate on different projects simultaneously.
- I want to **see which teams I belong to** and easily switch between them in my dashboard.
- I want to **set my visibility** (public or invite-only membership).
- I want to **choose whether a project invitation goes to me personally or via one of my teams**.
- I want to **leave a team at any time**, unless I have an active project stage assigned to me.

### As a Team Lead:

- I want to **invite existing freelancers** to join my team.
- I want to **see all members across multiple active projects**.
- I want to **assign roles** (e.g., Developer, Designer, Tester) within the team.
- I want to **review and rate freelancers** after project completion.

### As a Business Client:

- I want to **see the full composition of any team** I hire (roles, members, reputation).
- I want to **know if a freelancer I hire is already part of another team** for transparency.

---

## 🧠 Epic 4 – Guided Project Templates

### As a Business Client:

- I want to **select a project template** (e.g., “Build a SaaS MVP”, “Design a Landing Page”).
- I want the platform to **recommend suitable freelancers or teams** for each stage.
- I want to **customize the template** by replacing or removing stages.
- I want to **preview total cost and timeline** before confirming.

### As a Freelancer:

- I want to **attach my services to specific template stages**.
- I want to **see when businesses select my stage** in a template.
- I want to **get notified when a template project matches my profile.**

---

## 🤝 Epic 5 – Collaboration & Communication

### As a Business Client:

- I want to **chat with freelancers and teams** directly inside project rooms.
- I want to **upload reference files and documentation**.
- I want to **receive milestone updates** as stages are completed.

### As a Freelancer/Team:

- I want to **collaborate with others on the same project** (shared workspace).
- I want to **track progress** with task boards or checklists.
- I want to **share deliverables securely** through Supabase Storage.

---

## 💼 Epic 6 – Review, Payments & Revisions (Phase 2+)

### As a Business Client:

- I want to **approve deliverables per stage** before payment is released.
- I want to **request revisions** if I’m not satisfied.
- I want to **rate freelancers and teams** after project completion.

### As a Freelancer:

- I want to **receive payments securely** (via Stripe Connect).
- I want to **track my earnings and withdrawal history.**
- I want to **see client feedback** for continuous improvement.

---

## 🛍️ Epic 7 – Marketplace for Previous Work (Future Expansion)

### As a Freelancer:

- I want to **sell past designs, templates, or products** directly on my profile.
- I want to **define licenses or exclusivity** (e.g., “Full Rights”, “Template Use Only”).
- I want to **track downloads and sales analytics**.

### As a Business Client:

- I want to **browse and buy ready-made assets** (website templates, designs, code).
- I want to **preview and customize digital assets** before purchase.

**Examples:**

- A designer sells a T-shirt design and optionally prints the product.
- A developer sells an unused website domain or UI template.

---

## 🔐 Epic 8 – Account & Security

### As Any User:

- I want to **log in securely** using Supabase Auth (email/password or OAuth).
- I want to **receive session tokens that expire safely** (JWT + hashed refresh).
- I want to **recover my account** if I forget credentials.
- I want to **verify my identity** before taking payments or forming teams.

---

## 📊 Epic 9 – Analytics & Insights (Later Phase)

- Businesses can view **budget breakdowns** and project performance.
- Freelancers can view **earnings analytics** and stage efficiency.
- Teams can track **member contributions** and client satisfaction.

---

## 🔮 Epic 10 – Long-Term Vision

- **AI-assisted team recommendations** (“Best team for your budget”).
- **Automated milestone forecasting** (timeline prediction based on prior data).
- **Cross-platform integrations** (Notion, Slack, GitHub).
- **API access** for enterprise clients.

---

## 🔄 Epic 11 – Multi-Account Switching

### As a User:

- I want to **associate multiple business accounts** under my profile.
- I want to **switch between my business accounts and my freelancer profile** from a single dashboard.
- I want to **see which account is currently active** when viewing projects or payments.
- I want to **maintain separate wallets and analytics** for each business account.
- I want to **use the same email/login credentials** for all associated accounts.

### As a Business Owner:

- I want to **delegate access** to collaborators (e.g., team members or assistants).
- I want to **assign roles** (Owner, Manager, Viewer) per business account.

### As a Freelancer:

- I want to **operate my freelancer account independently** of any business accounts.
- I want my freelancer identity (ratings, portfolio) to remain consistent even if I switch to a business context.

---

## 🔐 Account & Security (Updated)

- Each **user ID** can own one `freelancer_profile` and multiple `business_profiles`.
- Switching context updates `active_profile_id` in session JWT.
- **RLS policies** ensure all database operations are filtered by the currently active account.
- All **API endpoints** respect `active_profile_type` (`freelancer` or `business`) for access control.
- **Audit logs** record all account switches for transparency.

```

### File: docs\08_UserFlows.md

```md
# Projective User Flows  
Version: Draft MVP Architecture  
Date: 25 Oct 2025  
Author: GPT-5 (Projective System Docs)

---

## Actors (Who’s doing what)

### Business / Creator
- A person or company that wants work done.
- They can own multiple business profiles.
- They create projects, approve work, fund payments, open disputes.

### Freelancer
- An individual who offers services.
- Can act solo, join multiple teams, and sell work.
- Can take on different types of work modes (Create, Run, Educate, etc.).

### Team
- A group of freelancers acting like a micro-agency.
- Can be hired as a unit for certain stages or entire projects.

### Platform / System
- Handles auth, RLS isolation, escrow, dispute moderation, file access, audit trail, IP policy references, etc.

### Moderator (Internal / Admin)
- Only steps in for escalated disputes, fraud, abuse, safety, or IP claims.

---

## 1. Onboarding → First Project Flow (End-to-end narrative)

High level:
1. User signs up.
2. User chooses what they are.
3. User sets up profile + payout/billing.
4. User either posts a project (as a creator/business) or looks for work (as a freelancer).
5. The first project is created and staffed.
6. Work is delivered, paid, reviewed, possibly disputed.

We'll break that into phases.

---

### 1.1 Account Creation & Role Setup

``` text
Start
↓
Signup/Login (Supabase Auth)
- email/password OR OAuth
- Turnstile check for bots
↓
Verify Email (token link)
↓
Choose Path:
  [ I'm here to HIRE / I need work done ] → becomes Creator
  [ I'm here to WORK / Offer services ] → becomes Freelancer
↓
System creates:
- `auth.users` row
- `security.session_context` row
- If Freelancer path: create `org.freelancer_profiles`
- If Creator path: create `org.business_profiles`
↓
Dashboard boot
```

Details:
- A single human user can actually become both later. This is done through the account switcher (they can own one freelancer profile and many business profiles).
- We store in `session_context` which profile is “active,” and that value is embedded in the JWT for RLS.

Security notes:
- Refresh tokens are hashed and rotated.
- Every request to the API uses the active profile for access filtering via RLS.

---

### 1.2 Profile Completion

For Freelancers:
- Add headline, skills, pricing style, availability.
- Attach portfolio samples (uploads go → `attachments` bucket → scanned in `quarantine` first).
- Optionally join or create a Team.

For Creators (business):
- Add business name, billing email, location.
- Add payment method for funding stages later (Stripe on file).
- (Later phase) Verify identity for high-value spend / anti-fraud.

For Teams:
- A freelancer can create a team, invite others, and define roles (designer, dev, QA, PM).
- Team shows up as a hireable “unit” for a stage.

---

### 1.3 Payment Setup (Creator side)

Why early?
- You can’t actually start a paid stage without funding escrow.

Flow:
- Creator adds payment details (card / business payment method).
- The platform prepares “wallets” and enables escrows.
- No money moves yet, but escrow will be pulled before work starts.

``` text
Creator Dashboard
↓
Settings / Wallet
↓
Add Payment Method
↓
Stripe Connect / billing link
↓
Ready to fund escrows
```

(Teams / freelancers later add payout accounts so they can receive funds after stage approval.)

---

## 2. Project Lifecycle Overview

Now we zoom into how a project is created, staffed, executed, delivered, paid, and possibly disputed.

We cover:
- Full project (multi-stage)
- Single-stage projects
- Stage types and how they behave
- Tabs within a stage
- Escrow and approvals
- Revisions and disputes
- IP handling

---

### 2.1 Creating a Project (Creator perspective)

There are two paths:
A. Custom project (“Describe what you need”)  
B. Template (“Landing Page Build”, “SEO Campaign”, “Pitch Deck Coaching”, “App MVP”)

``` text
Creator Dashboard
↓
"New Project"
↓
Option A: Custom Project
  - Title, description, goals, timeline, budget comfort
  - Add first stage(s) manually
Option B: Use Template
  - Pick template category
  - System auto-loads suggested stages (Design, Build MVP, Test, etc.)
  - Each stage has a recommended Stage Type and suggested cost ranges
↓
Project Draft Created in DB:
- projects.projects (status = draft)
- projects.project_stages[] (status = open)
↓
Creator Reviews Stage List
  - Can remove stages
  - Can reorder them
  - Can change who they want to hire per stage:
    - Single freelancer
    - Multiple freelancers across stages
    - Whole team for multiple stages
↓
Save
```

During this step:
- No one is hired yet.
- Budget rules can be defined per stage:
  - fixed price
  - cap / hourly cap
  - free (like discovery/consult)

This maps to `projects.stage_budget_rules`.

---

### 2.2 Stage Types (How work is structured)

Stages are atomic units of work that can be assigned to either:
- A single freelancer
- A team
- (Eventually) multiple freelancers in parallel, but MVP tends toward 1 assignee per stage

Each stage has a “Stage Type,” which drives UI, approval rules, completion signals, and payment triggers.

#### 2.2.1 File Based
Typical freelancer types:
- Create (design, code, copywriting)
- Run / Execute (do the task and provide output)
- Test / Tweak (QA report, improved version)
What delivery looks like:
- Deliverable is a file, zip, doc, or link.
- Stage is marked “submitted” when files are uploaded as a Submission.
Tabs:
- Chat
- Attachments
- Details
- Submissions (required for File Based)

#### 2.2.2 Session Based
Typical freelancer types:
- Educate
- Advise
What delivery looks like:
- A booked call / session between creator and freelancer.
- Completion is logged after the session happens.
Tabs:
- Chat
- Attachments
- Details
- Calendar (session scheduling tab)

#### 2.2.3 Group Session Based
Typical freelancer types:
- Educate (group coaching / training class)
What delivery looks like:
- A live session with multiple attendees (e.g. 1 freelancer coach + 10 attendees from the creator’s team or audience).
- Completion is attendance + confirmation by the creator.
Tabs:
- Chat
- Attachments
- Details
- Calendar
- Attendees (list of registered participants, attendance log)

#### 2.2.4 Management Based
Typical freelancer types:
- Empower / Manage
(Example: project manager / producer / coordinator role.)
What delivery looks like:
- Ongoing coordination, reporting, decisions, directing other contributors.
- Completion may be time-bound (e.g. “2 weeks of PM coverage”).
Tabs:
- Chat
- Attachments
- Details
No special Submission tab because the “output” is the process itself, not one packaged file.

#### 2.2.5 Maintenance Based
Typical freelancer types:
- Execute
- Test / Tweak
(Example: “Keep the landing page updated weekly,” “Monthly bug fixes,” “Social calendar maintenance”.)
What delivery looks like:
- Ongoing recurring work for a period or retainer.
- Completion is either:
  - a recurring billing cycle (weekly/monthly), OR
  - explicit “maintenance complete” for this window.
Tabs:
- Chat
- Attachments
- Details
- Submissions (can be used to log periodic drops/updates)

---

### 2.3 Mapping Freelancer Types ↔ Stage Types

- Create → File Based  
  (Designer delivers Figma file, Developer delivers repo, Writer delivers copy doc.)
- Run / Execute → File Based or Maintenance Based  
  (VA uploads spreadsheets, marketing operator posts campaign reports weekly.)
- Educate → Session Based  
  (1:1 coaching call.)
- Educate (Group) → Group Session Based  
  (Training workshop for 20 employees.)
- Advise → Session Based  
  (Consulting, strategy call, technical guidance call.)
- Test / Tweak → File Based or Maintenance Based  
  (QA report, code review, performance audit, copy edit pass.)
- Empower / Manage → Management Based  
  (Project manager keeps everyone moving, communicates status, tracks blockers.)

This matters because:
- Different stage types imply different “what counts as done”.
- Different stage types change which tabs are shown in the UI.
- Different stage types can affect how escrow pays out.

---

### 2.4 Staffing a Stage (Hiring flow)

A stage can be filled in two main ways:

1. Creator browses and directly invites a freelancer or team.
2. Freelancers/teams apply to open stages of public or semi-public projects.

Hiring flow:
1. Creator selects a stage like “UI Design (File Based)”.
2. Creator views suggested freelancers / teams with matching skills.
3. Creator invites one (or more) to take that stage.
4. Invitee accepts.

When accepted:
- `projects.stage_assignments` is populated with who’s responsible.
- Stage status moves from `open` → `assigned` → `in_progress`.

If a team is hired, the team lead can internally assign sub-work. The platform does not need to micromanage internal distribution at MVP; we only track which team is accountable to deliver.

---

### 2.5 Funding & Escrow (Before work starts)

Before work officially starts, the Creator must fund that stage.

``` text
Stage "Design Landing Page" (File Based)
status: open
↓
Creator selects freelancer or team
↓
Platform calculates cost from stage_budget_rules
↓
Creator clicks "Fund Stage"
↓
Escrow created in finance.escrows
- status = funded
- amount_cents = agreed fee
↓
Stage moves to in_progress
Freelancer/team starts work
```

This prevents “do work first, maybe get paid later.”  
Funds sit in escrow, not yet released to the freelancer/team.

---

### 2.6 Collaboration During the Stage

Every stage has a “Stage Room” (like a mini workspace). Tabs:

- Chat  
  Real-time thread between the creator and the assigned freelancer/team (plus PM, plus anyone else allowed on that stage).
- Attachments  
  Shared files (stored in `attachments` bucket, mapped through `comms.message_attachments`, etc.).
- Details  
  Scope, acceptance criteria, deadlines, budget, revision terms.
- Submissions  
  (File Based / Maintenance Based only) Formal handover of deliverables. This is how payment approval is triggered.
- Calendar  
  (Session Based / Group Session Based only) Schedule, upcoming calls.
- Attendees  
  (Group Session Based only) Who’s attending the session(s), attendance history.

For Management Based stages:
- The PM / coordinator is expected to keep Chat, Details, and Attachments updated.  
- There is often no “final file,” just reporting and management outcomes.

---

### 2.7 Submission, Review, and Approval

For File Based and Maintenance Based stages:
1. Freelancer/team uploads final deliverable(s) to Submissions.
2. Stage status moves to `submitted`.
3. Creator reviews.

The creator now has 3 options:
- Approve  
- Request Revision  
- Dispute

#### Approve
- Stage status: `approved`.
- Escrow is released.
- Freelancer/team wallet is credited (transactions + payouts).

#### Request Revision
- Stage status: `revisions`.
- A `stage_revision_request` record is created:
  - type: minor | major
  - reason / requested changes
- The freelancer/team updates the work and resubmits.
- This can repeat, but eventually should converge to approval or dispute.

#### Dispute
- If the creator claims “this is not what we agreed,” “low quality,” “fraud,” etc., they can open a dispute tied to that stage’s escrow.
- finance.disputes is created:
  - opened_by_profile
  - reason
  - status = open
- Both parties can post statements / evidence into `finance.dispute_messages`.
- A moderator can escalate, rule, refund, partially release, etc.
- Stage is blocked from payout until dispute is resolved.

---

### 2.8 Session Based & Group Session Based completion

For these stage types, “submission” is not a file. It’s “did the session happen?”

- After the scheduled call/session:
  - Freelancer/team marks session delivered.
  - Creator confirms attendance and value received.
  - Creator can Approve, Request Revision (rare: e.g. “this session never happened / you didn’t show”), or Dispute.

For Group Session Based:
- Creator can confirm attendee list vs. what was promised.
- Freelancers/coaches get paid upon approval.

---

### 2.9 Management Based completion

Management Based stages (Empower / Manage type) are usually:
- “2 weeks project management”
- “Campaign coordination for October”
- “Launch oversight until go-live date”

They close when:
- The agreed period ends
- The creator is satisfied that the PM/manager fulfilled the agreed responsibilities

Approval then triggers escrow release.

If the creator claims “you didn’t actually manage anything,” that can become a dispute.

---

### 2.10 Maintenance Based & Retainers

Maintenance Based stages can act like mini-retainers or recurring upkeep:
- “Ongoing bug fixes for 30 days”
- “Weekly content uploads”
- “Monthly social media upkeep”

Two patterns:
- As one stage within a larger project (single billing window)
- As recurring contract (post-launch maintenance, long-term relationship)

In the recurring case, this evolves into something like a `maintenance_contract`:
- amount per period
- renewal cadence (weekly/monthly)
- who’s responsible

Payment is sliced per billing window and approved like any other stage window. This can be auto-approved if no dispute is filed by cutoff.

---

## 3. Single-Stage Projects

Not every job needs a complex multi-stage project.

Example use cases:
- “Write me a blog post”
- “Run an audit call for my landing page”
- “Coach my team for 1 hour”
- “Fix this bug”
- “Manage my launch this weekend”

Flow is simpler:

``` text
Creator → New Project
↓
Add one Stage only
  e.g. "SEO audit call" (Session Based)
  or "Fix Stripe webhook bug" (File Based)
↓
Invite freelancer OR pick from suggestions
↓
Fund escrow
↓
Work happens
↓
Submission or Session Complete
↓
Approve → Release escrow
(Or Revision / Dispute)
↓
Project marked completed
```

In DB terms:
- projects.projects has one row
- projects.project_stages has exactly one row
- After approval and payout, project.status becomes `completed`

This is crucial for early adoption: very low friction, same trust mechanics.

---

## 4. Disputes and IP Ownership

### 4.1 Disputes

A dispute can be opened when:
- Work not delivered
- Work delivered but not matching scope
- Work quality is unacceptable
- Freelancer says creator is abusing revision requests
- Session did not occur as claimed
- Breach of terms / harassment / non-payment
- IP misuse

What happens when a dispute opens:
1. finance.disputes row is created (status = open).
2. Linked to escrow for that stage (so funds are locked).
3. Both parties can submit evidence/messages (finance.dispute_messages).
4. Moderator is notified.

Outcomes:
- Release full escrow to freelancer/team.
- Refund full escrow to creator.
- Split escrow (partial payout).
- Mark as resolved with notes.
- In extreme cases: suspend accounts, flag IP, restrict withdrawals.

The RLS model ensures only involved parties plus moderators can see the dispute data.

### 4.2 IP & Licensing

We need IP clarity because:
- You explicitly said you want freelancers and creators to both be able to reuse work unless they choose otherwise.
- You also said you'd like the platform to carry liability.

So at stage creation / agreement, we capture an “IP mode” for that stage:
- Exclusive Transfer — Creator fully owns the deliverable.
- Licensed Use — Creator can use it commercially, but freelancer retains rights to resell.
- Internal/Non-Commercial — Coaching / strategy / internal insights that aren’t to be resold.
- Public / Template — Work that was already a template or asset and can be resold (think marketplace item).

This IP mode should live in stage details (either within `projects.project_stages` or a related `stage_contract_terms` table in the future).

Why:
- In a dispute that claims “you’re reselling my brand assets,” the moderator checks that selected IP mode.
- Reviews/ratings can mention “Delivered exclusive rights as promised,” which protects both sides.

During dispute resolution over IP:
- Moderator can instruct takedown / forbid resale / require removal from marketplace.
- Moderator’s decision goes into `finance.disputes.resolution_notes`.

---

## 5. End State of a Project

Project is considered done when:
- All stages are approved and paid out, OR
- All remaining stages are cancelled/removed, and whatever is left is not owed.

End-of-project flow:

``` text
All stages either:
  - approved + paid
  - cancelled
  - resolved via dispute
↓
Creator leaves ratings for freelancers / teams
↓
Freelancers / teams rate the creator (mutual rating system)
↓
Project is archived as completed
↓
Its assets (final deliverables, transcripts, etc.) stay accessible in project files
↓
Wallets updated, payouts queued
```

After completion:
- Ratings affect discoverability.
- Assets can optionally be turned into marketplace items (future phase):  
  e.g. “the landing page template we built for you could be sold as a generic template,” depending on IP mode.

---

## 6. Flow Library (Quick Reference)

Below are the core flows in short form.

### 6.1 User Onboarding Flow (Freelancer or Creator)

``` text
Sign Up / Login
↓
Email Verify
↓
Pick Role (Hire vs Work)
↓
System creates profile(s)
↓
Payment setup:
  - Creator: add funding method
  - Freelancer/Team: add payout info
↓
Land in dashboard with proper context
```

---

### 6.2 Project Creation Flow (Creator)

``` text
Dashboard → New Project
↓
Pick Template OR Custom
↓
Auto-generate stages (with Stage Type + suggested pricing)
↓
Tweak stages / scope / IP mode / budget rules
↓
Save Draft
```

---

### 6.3 Staffing & Funding Flow

``` text
For each Stage:
  Invite freelancer OR team
  ↓
  Assignee accepts
  ↓
  Creator funds escrow
  ↓
  Stage moves to in_progress
  ↓
  Collaboration begins in Stage Room
```

---

### 6.4 Delivery & Approval Flow

For File Based / Maintenance Based:
``` text
Freelancer submits deliverable
↓
Creator reviews
↓
Approve → escrow releases → payout
OR
Request Revision → stage_revision_request logged
OR
Open Dispute → funds locked, moderator notified
```

For Session Based / Group Session Based:
``` text
Session happens
↓
Creator confirms attendance/value
↓
Approve → escrow releases → payout
OR
Mark "didn't happen" → dispute
```

For Management Based:
``` text
Time window ends
↓
Creator marks satisfied or not
↓
Approve → payout
OR
Dispute quality of management
```

---

### 6.5 Dispute Flow

``` text
Creator OR Freelancer opens Dispute on a Stage
↓
finance.disputes row created
↓
Dispute Messages open (evidence, conversation)
↓
Moderator review
↓
Moderator resolves:
- release funds
- partial split
- refund
- restrict IP reuse if applicable
↓
Stage + Project updated accordingly
↓
Ratings still can proceed
```

---

### 6.6 Project Completion Flow

``` text
All stages finalized (approved/cancelled/resolved)
↓
Project marked completed
↓
Both sides rate each other
↓
Final assets remain accessible
↓
Wallets / payouts finalized
↓
Project archived
```

---

## 7. Why this matters for build order

From an engineering standpoint:
1. You cannot build “projects” in isolation — you need:
   - Onboarding (session_context in JWT)
   - Stage types (so UI knows which tabs to render)
   - Escrow (for trust)
2. You cannot build payouts without:
   - Submission → Approval → Release trigger
   - Dispute path
3. You cannot build retention / long-tail revenue without:
   - Maintenance Based stages / maintenance contracts
4. You cannot scale trust without:
   - Ratings
   - IP mode logging
   - Audit trails
   - Dispute messaging

All of that informs tables like:
- `projects.stage_revision_requests`
- `finance.disputes` + `finance.dispute_messages`
- `projects.maintenance_contracts`
- `finance.wallets`, `finance.escrows`, `finance.transactions`
- `finance.ratings`

And all of that ties back to access control via RLS using `active_profile_id` and `active_team_id`.

---

## 8. TL;DR Core Flows You Now Have Spec’d

- Onboarding (account creation → active profile)
- Payment setup (funding & payout)
- Project creation (custom or template)
- Stage typing (File, Session, Group Session, Management, Maintenance)
- Hiring & escrow funding
- Workroom collaboration per stage (Chat / Attachments / Details / etc.)
- Submission / approval / revision loop
- Disputes, including IP edge cases
- Ratings and closeout
- Single-stage “micro-projects”
- Long-running “maintenance / retainer” stages

This document should live in `docs/product/user-flows.md` in the repo, next to `UserStories.md` and `Sitemap.md`.

```

### File: docs\09_Tables.md

```md
# Projective Database Schema (Relational Model)

Format: Table-per-entity with columns, types, PK/FK notes\
Date: 25 Oct 2025 (revised for client profiles & future organisations)\
Status: UPDATED (includes maintenance contracts, revision requests, dispute messages, subscriptions,
portfolios, organisation scaffolding, column refinements)

---

## ENUMS

### `profile_type`

| Value        | Description                          |
| ------------ | ------------------------------------ |
| `freelancer` | A freelancer profile context         |
| `business`   | A business / creator profile context |

> Used where a row is “owned” by a freelancer or business profile.\
> **Note:** Future `organisation` entities are modelled separately and use explicit FKs instead of
> this enum.

### `assignment_type`

| Value        | Description                               |
| ------------ | ----------------------------------------- |
| `freelancer` | Stage is assigned to a freelancer profile |
| `team`       | Stage is assigned to a team               |

### `visibility`

| Value         | Description                                 |
| ------------- | ------------------------------------------- |
| `public`      | Visible in search / market                  |
| `invite_only` | Only visible to invited collaborators/teams |

### `project_status`

| Value       | Description                        |
| ----------- | ---------------------------------- |
| `draft`     | Project created but not yet active |
| `active`    | In progress                        |
| `on_hold`   | Paused                             |
| `completed` | Finished and archived              |
| `cancelled` | Killed before completion           |

### `stage_status`

| Value         | Description                                             |
| ------------- | ------------------------------------------------------- |
| `open`        | Stage exists but not yet staffed                        |
| `assigned`    | Someone has been assigned but hasn't accepted / started |
| `in_progress` | Actively being worked on                                |
| `submitted`   | Work / session delivered for approval                   |
| `approved`    | Buyer/creator approved deliverable                      |
| `revisions`   | Creator requested changes / corrections                 |
| `paid`        | Escrow released / payout processed                      |

### `dispute_status`

| Value          | Description                       |
| -------------- | --------------------------------- |
| `open`         | Dispute filed                     |
| `under_review` | Moderator actively mediating      |
| `resolved`     | Outcome decided                   |
| `refunded`     | Payout refunded (full or partial) |

---

## 1. Supabase built-ins (`auth`, `storage`)

### Table: `auth.users`

| Column     | Type        | Notes                      |
| ---------- | ----------- | -------------------------- |
| id         | uuid        | PK                         |
| email      | text        | Unique per user (Supabase) |
| phone      | text        |                            |
| created_at | timestamptz |                            |
| updated_at | timestamptz |                            |

### Table: `auth.identities`

| Column        | Type        | Notes                                  |
| ------------- | ----------- | -------------------------------------- |
| id            | uuid        | PK                                     |
| user_id       | uuid        | FK → `auth.users.id`                   |
| provider      | text        | e.g. `email`, `github`, `google`, etc. |
| identity_data | jsonb       | Provider payload                       |
| created_at    | timestamptz |                                        |

### Table: `storage.buckets`

| Column     | Type        | Notes |
| ---------- | ----------- | ----- |
| id         | text        | PK    |
| name       | text        |       |
| created_at | timestamptz |       |

### Table: `storage.objects`

| Column     | Type        | Notes                                           |
| ---------- | ----------- | ----------------------------------------------- |
| id         | uuid        | PK                                              |
| bucket_id  | text        | FK → `storage.buckets.id`                       |
| name       | text        | Full path inside bucket (unique per bucket)     |
| owner      | uuid        | Owner user_id or profile id depending on policy |
| metadata   | jsonb       | sha256, mime_type, etc.                         |
| created_at | timestamptz |                                                 |
| updated_at | timestamptz |                                                 |

---

## 2. Security Schema (`security`)

### Table: `security.session_context`

| Column              | Type         | Notes                                                       |
| ------------------- | ------------ | ----------------------------------------------------------- |
| user_id             | uuid         | PK, FK → `auth.users.id`                                    |
| active_profile_type | profile_type | `freelancer` or `business`                                  |
| active_profile_id   | uuid         | The currently active freelancer_profile or business_profile |
| active_team_id      | uuid         | Active team context (if acting "as team")                   |
| updated_at          | timestamptz  | Last context switch                                         |

### Table: `security.audit_logs`

| Column           | Type        | Notes                                                                         |
| ---------------- | ----------- | ----------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                            |
| user_id          | uuid        | FK → `auth.users.id`                                                          |
| action           | text        | e.g. `stage.approved`, `profile.updated`, `dispute.opened`                    |
| entity_table     | text        | Logical target table name (`projects.project_stages`, etc.)                   |
| entity_id        | uuid        | Entity row id                                                                 |
| metadata         | jsonb       | Arbitrary contextual data                                                     |
| ip               | inet        | Calling IP                                                                    |
| created_at       | timestamptz | Timestamp                                                                     |
| request_id       | uuid        | (NEW) Correlates platform logs / trace id                                     |
| actor_profile_id | uuid        | (NEW) Active profile the user was acting as at the time (mirrors RLS context) |
| actor_team_id    | uuid        | (NEW) Active team context (if any)                                            |
| user_agent       | text        | (NEW) Captured UA / client info for abuse/fraud audit                         |

### Table: `security.turnstile_verifications`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| user_id      | uuid        | FK-ish (nullable before auth) |
| ip           | inet        | IP of request                 |
| token_prefix | text        | Partial token for reference   |
| success      | boolean     | CAPTCHA success               |
| created_at   | timestamptz | Timestamp                     |

### Table: `security.feature_flags`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| key        | text        | PK (flag key)            |
| enabled    | boolean     | Feature on/off           |
| payload    | jsonb       | Extra config for rollout |
| updated_at | timestamptz |                          |

---

## 3. Org Schema (`org`)

Users, freelancer profiles, client business profiles, teams, skills, attachments, emails,
portfolios, and (future) multi-user organisations.

### Table: `org.users_public`

| Column       | Type        | Notes                    |
| ------------ | ----------- | ------------------------ |
| user_id      | uuid        | PK, FK → `auth.users.id` |
| display_name | text        | Public-facing name       |
| avatar_url   | text        | Signed URL / storage ref |
| country      | text        | Optional                 |
| created_at   | timestamptz |                          |

> Public but still served under RLS; safe to show to any authenticated user.

---

### Table: `org.freelancer_profiles`

| Column      | Type        | Notes                                                              |
| ----------- | ----------- | ------------------------------------------------------------------ |
| id          | uuid        | PK                                                                 |
| user_id     | uuid        | FK → `auth.users.id`, UNIQUE (1 freelancer profile per human user) |
| headline    | text        | Short pitch (e.g. “Logo Designer                                   |
| bio         | text        | Profile description                                                |
| hourly_rate | integer     | Optional, rough signalling                                         |
| visibility  | visibility  | `public` or `invite_only`                                          |
| skills      | text[]      | Skill tags / fast filter                                           |
| languages   | text[]      | e.g. `{"English","Spanish"}`                                       |
| timezone    | text        | IANA string or human label (e.g. `Europe/London`)                  |
| country     | text        | For location filters                                               |
| created_at  | timestamptz |                                                                    |

> This is the main “seller” identity.\
> Social/portfolio links are stored in `org.profile_links` and `org.portfolios`.

---

### Table: `org.business_profiles` (client-facing profiles, MVP + future-proofed)

These are **lightweight client profiles** owned by a single human.\
They cover individual clients and small businesses that don’t need full organisation features.

| Column           | Type        | Notes                                                                                      |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                         |
| owner_user_id    | uuid        | FK → `auth.users.id` (who controls this client profile)                                    |
| name             | text        | Public / brand display name (“Acme Studio”, “Jane Doe – Marketing”)                        |
| headline         | text        | Short tagline (“E-commerce brand hiring design + UGC”)                                     |
| bio              | text        | “About” copy visible on the client profile page                                            |
| logo_url         | text        | Storage ref (used as avatar/logo for this client)                                          |
| country          | text        | Primary operating location                                                                 |
| languages        | text[]      | Languages this client can communicate in                                                   |
| timezone         | text        | Main timezone for meetings / deadlines                                                     |
| billing_email    | text        | Invoice recipient                                                                          |
| default_currency | text        | e.g. `GBP`, `USD` (helps with budgets and invoices)                                        |
| visibility       | visibility  | `public` for discoverable clients, `invite_only` to hide from search (optional future use) |
| plan             | text        | Current tier or plan label (`free`, `pro`, `enterprise-seed`, etc.)                        |
| created_at       | timestamptz |                                                                                            |

**Notes**

- A **single user can own multiple business_profiles** (different brands / ventures).
- Reviews left _about_ this client attach to `business_profiles.id`.
- Future **organisations** can associate many `business_profiles` under a single corporate umbrella
  without breaking this table.

---

### Table: `org.organisations` (NEW – future enterprise clients)

Represents a multi-user organisation (e.g. Google, Sony) that can have many employees and many
brands.

| Column          | Type        | Notes                                                                          |
| --------------- | ----------- | ------------------------------------------------------------------------------ |
| id              | uuid        | PK                                                                             |
| name            | text        | Organisation display name (“Google”, “Stripe”)                                 |
| legal_name      | text        | Registered legal entity name (optional initially)                              |
| logo_url        | text        | Logo / emblem                                                                  |
| country         | text        | Primary jurisdiction                                                           |
| website_url     | text        | Corporate site (used mainly for verification, not direct traffic off-platform) |
| billing_email   | text        | Central billing contact                                                        |
| plan            | text        | `enterprise`, `team`, etc.                                                     |
| verified_status | text        | `unverified`, `pending`, `verified`, `rejected`                                |
| settings        | jsonb       | Misc. org-wide settings (SSO required, 2FA policy, procurement rules, etc.)    |
| created_at      | timestamptz |                                                                                |

> MVP may not create rows here yet; this table is for Phase 3+ without requiring breaking
> migrations.

---

### Table: `org.organisation_members` (NEW – mapping users into organisations)

| Column                           | Type                                                      | Notes                                               |
| -------------------------------- | --------------------------------------------------------- | --------------------------------------------------- |
| id                               | uuid                                                      | PK                                                  |
| organisation_id                  | uuid                                                      | FK → `org.organisations.id`                         |
| user_id                          | uuid                                                      | FK → `auth.users.id`                                |
| role                             | text                                                      | e.g. `owner`, `admin`, `manager`, `buyer`, `viewer` |
| status                           | text                                                      | `active`, `invited`, `left`, `removed`              |
| created_at                       | timestamptz                                               |                                                     |
| UNIQUE(organisation_id, user_id) | Each user has at most one membership row per organisation |                                                     |

> Permissions in the app are derived from `role` + `status` on this table.\
> Reviews target the organisation itself, not individual members.

---

### Table: `org.organisation_departments` (NEW – optional departmental scoping)

| Column          | Type        | Notes                           |
| --------------- | ----------- | ------------------------------- |
| id              | uuid        | PK                              |
| organisation_id | uuid        | FK → `org.organisations.id`     |
| name            | text        | e.g. `Marketing`, `IT`, `Legal` |
| created_at      | timestamptz |                                 |

> Projects can optionally reference a department for reporting and routing.\
> MVP can ignore this; future enterprise features can hook into it.

---

### Table: `org.teams`

| Column        | Type        | Notes                                      |
| ------------- | ----------- | ------------------------------------------ |
| id            | uuid        | PK                                         |
| name          | text        | Team brand / label                         |
| owner_user_id | uuid        | FK → `auth.users.id` (ultimate controller) |
| description   | text        | Pitch / positioning                        |
| visibility    | visibility  | `public` or `invite_only`                  |
| created_at    | timestamptz |                                            |

### Table: `org.team_memberships`

| Column                   | Type               | Notes                                   |
| ------------------------ | ------------------ | --------------------------------------- |
| id                       | uuid               | PK                                      |
| team_id                  | uuid               | FK → `org.teams.id`                     |
| user_id                  | uuid               | FK → `auth.users.id`                    |
| role                     | text               | e.g. `freelancer`, `team_lead`, `admin` |
| status                   | text               | e.g. `active`, `invited`, `left`        |
| created_at               | timestamptz        |                                         |
| UNIQUE(team_id, user_id) | Enforced via index |                                         |

### Table: `org.team_roles`

| Column      | Type  | Notes                                   |
| ----------- | ----- | --------------------------------------- |
| id          | uuid  | PK                                      |
| team_id     | uuid  | FK → `org.teams.id`                     |
| title       | text  | e.g. "Designer", "PM", "QA Lead"        |
| permissions | jsonb | Serialized permission map for that role |

### Table: `org.org_invitations`

| Column              | Type        | Notes                                                             |
| ------------------- | ----------- | ----------------------------------------------------------------- |
| id                  | uuid        | PK                                                                |
| inviter_user_id     | uuid        | FK → `auth.users.id`                                              |
| target_email        | text        | Invitation target                                                 |
| team_id             | uuid        | FK → `org.teams.id` (optional depending on invite type)           |
| business_profile_id | uuid        | FK → `org.business_profiles.id` (optional)                        |
| organisation_id     | uuid        | FK → `org.organisations.id` (optional, future enterprise invites) |
| token               | text        | Secure/random token                                               |
| status              | text        | `pending`, `accepted`, `declined`, `expired`                      |
| created_at          | timestamptz |                                                                   |

### Table: `org.skills`

| Column | Type | Notes                   |
| ------ | ---- | ----------------------- |
| id     | uuid | PK                      |
| slug   | text | Unique machine-readable |
| label  | text | Human-readable display  |

### Table: `org.user_skills`

| Column                         | Type         | Notes                    |
| ------------------------------ | ------------ | ------------------------ |
| user_id                        | uuid         | FK → `auth.users.id`     |
| skill_id                       | uuid         | FK → `org.skills.id`     |
| proficiency                    | smallint     | User self-rating / level |
| PRIMARY KEY(user_id, skill_id) | Composite PK |                          |

### Table: `org.attachments`

| Column            | Type        | Notes                                                        |
| ----------------- | ----------- | ------------------------------------------------------------ |
| id                | uuid        | PK                                                           |
| owner_profile_id  | uuid        | The freelancer/business profile that "owns" this attachment  |
| bucket            | text        | FK → `storage.buckets.id` (e.g. `attachments`, `chat`, etc.) |
| path              | text        | Object path in bucket                                        |
| original_filename | text        | Client-side filename at upload time                          |
| display_name      | text        | User-editable "pretty name"                                  |
| mime_type         | text        | Sanitized / validated                                        |
| size_bytes        | bigint      |                                                              |
| sha256            | text        | File integrity                                               |
| status            | text        | e.g. `draft`, `uploaded`, `quarantined`, `clean`             |
| created_at        | timestamptz |                                                              |
| updated_at        | timestamptz |                                                              |

### Table: `org.user_emails`

| Column                 | Type               | Notes                                  |
| ---------------------- | ------------------ | -------------------------------------- |
| id                     | uuid               | PK                                     |
| user_id                | uuid               | FK → `auth.users.id`                   |
| email                  | text               | Secondary / alternate emails           |
| is_primary             | boolean            | Exactly one per user should be primary |
| verified_at            | timestamptz        | Null until verified                    |
| created_at             | timestamptz        |                                        |
| UNIQUE(user_id, email) | Prevent duplicates |                                        |

---

### Table: `org.portfolios`

| Column                | Type        | Notes                                                       |
| --------------------- | ----------- | ----------------------------------------------------------- |
| id                    | uuid        | PK                                                          |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`                           |
| title                 | text        | "Landing Page Redesign for Client X"                        |
| description           | text        | What was done / why it matters                              |
| cover_url             | text        | Screenshot / hero image (signed URL / preview)              |
| attachment_id         | uuid        | FK → `org.attachments.id` for source files / proof / output |
| is_public             | boolean     | Publicly viewable on freelancer profile                     |
| created_at            | timestamptz |                                                             |

### Table: `org.profile_links`

Stores social/portfolio links for both freelancers and business profiles.

| Column       | Type         | Notes                                                                                       |
| ------------ | ------------ | ------------------------------------------------------------------------------------------- |
| id           | uuid         | PK                                                                                          |
| profile_type | profile_type | `freelancer` or `business`                                                                  |
| profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `profile_type` |
| kind         | text         | `github`, `behance`, `dribbble`, `linkedin`, `youtube`, `website`, `other`                  |
| url          | text         | Validated URL                                                                               |
| is_public    | boolean      | Whether link is shown on the public profile                                                 |
| created_at   | timestamptz  |                                                                                             |

**Notes**

- UI can restrict certain `kind` values (e.g. hide `website` for MVP if you want to reduce
  off-platform leakage).
- Schema is flexible enough for future changes without new tables.

---

## 4. Projects Schema (`projects`)

Projects, stages, assignments, revisions, submissions, maintenance contracts, activity log.

### Table: `projects.projects`

| Column             | Type           | Notes                                                                                        |
| ------------------ | -------------- | -------------------------------------------------------------------------------------------- |
| id                 | uuid           | PK                                                                                           |
| client_business_id | uuid           | FK → `org.business_profiles.id` (the hiring creator / buyer profile for MVP and SMB clients) |
| title              | text           | Project name / headline                                                                      |
| description        | text           | Goals / scope                                                                                |
| status             | project_status | `draft`, `active`, `completed`, etc.                                                         |
| created_at         | timestamptz    |                                                                                              |

**Notes**

- For **MVP**, only `client_business_id` is populated; `organisation_id` / `department_id` remain
  NULL.
- For enterprise, `organisation_id` becomes the primary “owner” for reporting; `client_business_id`
  can represent a specific brand or sub-account under that org.

---

### Table: `projects.project_stages`

| Column       | Type         | Notes                                                                                |
| ------------ | ------------ | ------------------------------------------------------------------------------------ |
| id           | uuid         | PK                                                                                   |
| project_id   | uuid         | FK → `projects.projects.id`                                                          |
| name         | text         | e.g. "UI Design", "Coaching Call", "PM Oversight - Sprint 1"                         |
| "order"      | int          | Display order within the project                                                     |
| description  | text         | Scope / deliverables / agenda                                                        |
| status       | stage_status | `open`, `in_progress`, `submitted`, `approved`, `paid`, etc.                         |
| due_date     | timestamptz  | (NEW) Target completion date                                                         |
| completed_at | timestamptz  | (NEW) When stage was actually approved / closed                                      |
| stage_type   | text         | (Recommended) "file_based", "session", "group_session", "management", "maintenance"  |
| ip_mode      | text         | (Recommended) "exclusive_transfer", "licensed_use", "template_only", "internal_only" |
| created_at   | timestamptz  |                                                                                      |

> `stage_type` and `ip_mode` are important for UI behavior, payouts, disputes, and later licensing
> enforcement.

---

### Table: `projects.stage_budget_rules`

| Column           | Type   | Notes                                                                        |
| ---------------- | ------ | ---------------------------------------------------------------------------- |
| id               | uuid   | PK                                                                           |
| project_stage_id | uuid   | FK → `projects.project_stages.id`                                            |
| type             | text   | `fixed`, `cap`, `free`                                                       |
| amount_currency  | text   | e.g. `USD`, `GBP`                                                            |
| amount_cents     | bigint | Budget / cap / fee for that stage                                            |
| notes            | text   | Any custom pricing explanation (e.g. "First 2h free, then 50/hr up to £300") |

---

### Table: `projects.stage_assignments`

| Column                | Type            | Notes                                                                         |
| --------------------- | --------------- | ----------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                            |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                             |
| assignee_type         | assignment_type | `freelancer` or `team`                                                        |
| freelancer_profile_id | uuid            | FK → `org.freelancer_profiles.id` (nullable if assigned to team)              |
| team_id               | uuid            | FK → `org.teams.id` (nullable if assigned to single freelancer)               |
| assigned_by           | uuid            | FK → `auth.users.id` (the creator/buyer or team lead who made the assignment) |
| status                | text            | `invited`, `accepted`, `declined`, `active`                                   |
| created_at            | timestamptz     |                                                                               |

---

### Table: `projects.stage_submissions`

| Column           | Type        | Notes                                                                                                  |
| ---------------- | ----------- | ------------------------------------------------------------------------------------------------------ |
| id               | uuid        | PK                                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                                      |
| submitted_by     | uuid        | FK → `auth.users.id` (who actually clicked submit)                                                     |
| notes            | text        | Context: "Final files attached", "Recording of session", "Maintenance summary for this billing period" |
| created_at       | timestamptz |                                                                                                        |

> Files linked to a submission will exist via `org.attachments` and tables like
> `comms.message_attachments` or a future `stage_submission_files` join.

---

### Table: `projects.stage_revision_requests`

| Column           | Type        | Notes                                                                                  |
| ---------------- | ----------- | -------------------------------------------------------------------------------------- |
| id               | uuid        | PK                                                                                     |
| project_stage_id | uuid        | FK → `projects.project_stages.id`                                                      |
| requested_by     | uuid        | FK → `auth.users.id` (usually creator/business-side)                                   |
| type             | text        | `minor` or `major` (also drives potential extra budget or escalation)                  |
| reason           | text        | "The copy tone isn't what we agreed"; "You missed section 3"; "Session didn't cover X" |
| status           | text        | `open`, `in_progress`, `resolved`                                                      |
| created_at       | timestamptz |                                                                                        |
| resolved_at      | timestamptz |                                                                                        |

---

### Table: `projects.maintenance_contracts`

| Column                | Type        | Notes                               |
| --------------------- | ----------- | ----------------------------------- |
| id                    | uuid        | PK                                  |
| project_id            | uuid        | FK → `projects.projects.id`         |
| freelancer_profile_id | uuid        | FK → `org.freelancer_profiles.id`   |
| business_profile_id   | uuid        | FK → `org.business_profiles.id`     |
| amount_cents          | bigint      | Recurring cost per billing interval |
| currency              | text        | e.g. `USD`, `GBP`                   |
| interval              | text        | `weekly`, `monthly`, `quarterly`    |
| status                | text        | `active`, `paused`, `ended`         |
| created_at            | timestamptz |                                     |

> Covers ongoing "Maintenance Based" work such as retainer-style upkeep.

---

### Table: `projects.project_participants`

| Column                                       | Type                                       | Notes                                                                                            |
| -------------------------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| id                                           | uuid                                       | PK                                                                                               |
| project_id                                   | uuid                                       | FK → `projects.projects.id`                                                                      |
| profile_type                                 | profile_type                               | `freelancer` or `business`                                                                       |
| profile_id                                   | uuid                                       | Refers to `org.freelancer_profiles.id` OR `org.business_profiles.id` depending on `profile_type` |
| role                                         | text                                       | `viewer`, `collaborator`, maybe `owner`                                                          |
| UNIQUE(project_id, profile_type, profile_id) | Ensures no duplicate role rows per profile |                                                                                                  |

---

### Table: `projects.project_activity`

| Column        | Type        | Notes                                                                                               |
| ------------- | ----------- | --------------------------------------------------------------------------------------------------- |
| id            | uuid        | PK                                                                                                  |
| project_id    | uuid        | FK → `projects.projects.id`                                                                         |
| actor_user_id | uuid        | FK → `auth.users.id`                                                                                |
| kind          | text        | `status_change`, `file_upload`, `comment`, `budget_update`, etc.                                    |
| payload       | jsonb       | Arbitrary structured metadata (e.g. old_status/new_status, attachment refs, message ids)            |
| entity_table  | text        | Which entity this activity is about (`projects.project_stages`, `projects.stage_submissions`, etc.) |
| entity_id     | uuid        | The specific row in that entity                                                                     |
| created_at    | timestamptz |                                                                                                     |

---

## 5. Communication Schema (`comms`)

Project channels, DM threads, messages, and notification infrastructure.

### Table: `comms.project_channels`

| Column                   | Type                                                | Notes                                                                               |
| ------------------------ | --------------------------------------------------- | ----------------------------------------------------------------------------------- |
| id                       | uuid                                                | PK                                                                                  |
| project_id               | uuid                                                | FK → `projects.projects.id`                                                         |
| name                     | text                                                | `#general`, `#design`, etc. Must be unique per project                              |
| stage_id                 | uuid                                                | FK → `projects.project_stages.id` (optional: a stage-specific room like `#stage-2`) |
| visibility               | text                                                | `project_all` or `owner_and_assignees`                                              |
| created_at               | timestamptz                                         |                                                                                     |
| UNIQUE(project_id, name) | Prevent duplicate channel names inside same project |                                                                                     |

---

### Table: `comms.project_channel_participants`

| Column                                       | Type                                             | Notes                                |
| -------------------------------------------- | ------------------------------------------------ | ------------------------------------ |
| id                                           | uuid                                             | PK                                   |
| channel_id                                   | uuid                                             | FK → `comms.project_channels.id`     |
| profile_type                                 | profile_type                                     | `freelancer` or `business`           |
| profile_id                                   | uuid                                             | The profile in that channel          |
| role                                         | text                                             | `viewer`, `participant`, `moderator` |
| created_at                                   | timestamptz                                      |                                      |
| UNIQUE(channel_id, profile_type, profile_id) | Ensures no duplicate memberships in same channel |                                      |

---

### Table: `comms.project_messages`

| Column                        | Type                         | Notes                                   |
| ----------------------------- | ---------------------------- | --------------------------------------- |
| id                            | uuid                         | PK                                      |
| channel_id                    | uuid                         | FK → `comms.project_channels.id`        |
| sender_user_id                | uuid                         | FK → `auth.users.id`                    |
| body                          | text                         | Message text                            |
| created_at                    | timestamptz                  |                                         |
| edited_at                     | timestamptz                  | Null unless edited                      |
| deleted_at                    | timestamptz                  | Soft-delete flag for moderation / audit |
| INDEX(channel_id, created_at) | For chronological pagination |                                         |

---

### Table: `comms.dm_threads`

| Column             | Type        | Notes                |
| ------------------ | ----------- | -------------------- |
| id                 | uuid        | PK                   |
| created_by_user_id | uuid        | FK → `auth.users.id` |
| created_at         | timestamptz |                      |

### Table: `comms.dm_participants`

| Column                     | Type                                         | Notes                      |
| -------------------------- | -------------------------------------------- | -------------------------- |
| id                         | uuid                                         | PK                         |
| thread_id                  | uuid                                         | FK → `comms.dm_threads.id` |
| user_id                    | uuid                                         | FK → `auth.users.id`       |
| joined_at                  | timestamptz                                  |                            |
| UNIQUE(thread_id, user_id) | Prevent duplicate joins for same user/thread |                            |

### Table: `comms.dm_messages`

| Column                       | Type        | Notes                      |
| ---------------------------- | ----------- | -------------------------- |
| id                           | uuid        | PK                         |
| thread_id                    | uuid        | FK → `comms.dm_threads.id` |
| sender_user_id               | uuid        | FK → `auth.users.id`       |
| body                         | text        | Message text               |
| created_at                   | timestamptz |                            |
| INDEX(thread_id, created_at) | Pagination  |                            |

---

### Table: `comms.message_attachments`

| Column                                           | Type                                            | Notes                                                               |
| ------------------------------------------------ | ----------------------------------------------- | ------------------------------------------------------------------- |
| id                                               | uuid                                            | PK                                                                  |
| message_table                                    | text                                            | `'comms.project_messages'` or `'comms.dm_messages'`                 |
| message_id                                       | uuid                                            | References the row in whichever message table `message_table` names |
| attachment_id                                    | uuid                                            | FK → `org.attachments.id`                                           |
| created_at                                       | timestamptz                                     |                                                                     |
| UNIQUE(message_table, message_id, attachment_id) | Avoid attaching same file twice to same message |                                                                     |

> Allows any message to link to uploaded files (designs, deliverables, audit logs, etc.).

---

### Table: `comms.channel_files`

| Column                                          | Type                                              | Notes                                                                            |
| ----------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------------------------------- |
| id                                              | uuid                                              | PK                                                                               |
| channel_type                                    | text                                              | `'project'` or `'dm'`                                                            |
| channel_id                                      | uuid                                              | `comms.project_channels.id` OR `comms.dm_threads.id` depending on `channel_type` |
| attachment_id                                   | uuid                                              | FK → `org.attachments.id`                                                        |
| created_at                                      | timestamptz                                       |                                                                                  |
| UNIQUE(channel_type, channel_id, attachment_id) | Each file appears once in a channel-level gallery |                                                                                  |

---

### Table: `comms.notifications`

| Column       | Type        | Notes                                                     |
| ------------ | ----------- | --------------------------------------------------------- |
| id           | uuid        | PK                                                        |
| user_id      | uuid        | FK → `auth.users.id`                                      |
| type         | text        | e.g. `message.new`, `stage.submitted`, `payment.released` |
| title        | text        | Short summary                                             |
| body         | text        | Longer description                                        |
| entity_table | text        | Where this event originated                               |
| entity_id    | uuid        | The row ID in that entity                                 |
| read_at      | timestamptz | Null until read                                           |
| created_at   | timestamptz |                                                           |

### Table: `comms.notification_prefs`

| Column      | Type      | Notes                             |
| ----------- | --------- | --------------------------------- |
| user_id     | uuid      | PK, FK → `auth.users.id`          |
| email       | boolean   | Email alerts?                     |
| push        | boolean   | Push/mobile alerts?               |
| in_app      | boolean   | In-app notifications?             |
| digest      | boolean   | Summary digests allowed?          |
| quiet_hours | tstzrange | Time range where pushes are muted |

### Table: `comms.device_tokens`

| Column     | Type        | Notes                    |
| ---------- | ----------- | ------------------------ |
| id         | uuid        | PK                       |
| user_id    | uuid        | FK → `auth.users.id`     |
| provider   | text        | `apns`, `fcm`, `webpush` |
| token      | text        | Push token               |
| created_at | timestamptz |                          |

---

## 6. Finance Schema (`finance`)

Wallets, escrows, payments, invoices, disputes, ratings, subscriptions.

### Table: `finance.wallets`

| Column                                 | Type                              | Notes                                                         |
| -------------------------------------- | --------------------------------- | ------------------------------------------------------------- |
| id                                     | uuid                              | PK                                                            |
| owner_type                             | text                              | `freelancer`, `team`, `business`, `organisation`              |
| owner_id                               | uuid                              | The profile/team/business/organisation this wallet belongs to |
| currency                               | text                              | `USD`, `GBP`, etc.                                            |
| balance_cents                          | bigint                            | Current balance                                               |
| created_at                             | timestamptz                       |                                                               |
| UNIQUE(owner_type, owner_id, currency) | One wallet per owner per currency |                                                               |

---

### Table: `finance.transactions`

| Column                       | Type                     | Notes                                                            |
| ---------------------------- | ------------------------ | ---------------------------------------------------------------- |
| id                           | uuid                     | PK                                                               |
| wallet_id                    | uuid                     | FK → `finance.wallets.id`                                        |
| direction                    | text                     | `credit` or `debit`                                              |
| amount_cents                 | bigint                   | Movement amount                                                  |
| currency                     | text                     | Currency code                                                    |
| reason                       | text                     | `escrow_release`, `refund`, `payout`, etc.                       |
| ref_table                    | text                     | Origin reference (e.g. `finance.escrows`)                        |
| ref_id                       | uuid                     | Origin row ID                                                    |
| balance_after_cents          | bigint                   | Snapshot of wallet after this transaction (for ledger reconcile) |
| created_at                   | timestamptz              |                                                                  |
| INDEX(wallet_id, created_at) | For statements / history |                                                                  |

---

### Table: `finance.escrows`

| Column                | Type            | Notes                                                                                     |
| --------------------- | --------------- | ----------------------------------------------------------------------------------------- |
| id                    | uuid            | PK                                                                                        |
| project_stage_id      | uuid            | FK → `projects.project_stages.id`                                                         |
| payer_business_id     | uuid            | FK → `org.business_profiles.id` (who funded the stage)                                    |
| payer_organisation_id | uuid            | FK → `org.organisations.id` (optional; for enterprise payers)                             |
| payee_type            | assignment_type | `freelancer` or `team`                                                                    |
| payee_id              | uuid            | Points to either `org.freelancer_profiles.id` OR `org.teams.id` depending on `payee_type` |
| amount_cents          | bigint          | Escrowed amount                                                                           |
| currency              | text            |                                                                                           |
| status                | text            | `funded`, `released`, `refunded`, `disputed`                                              |
| created_at            | timestamptz     |                                                                                           |

---

### Table: `finance.payout_accounts`

| Column                       | Type                     | Notes                                                              |
| ---------------------------- | ------------------------ | ------------------------------------------------------------------ |
| id                           | uuid                     | PK                                                                 |
| owner_type                   | text                     | `freelancer`, `team`, `business`, `organisation`                   |
| owner_id                     | uuid                     | Profile / team / business / organisation referencing who gets paid |
| provider                     | text                     | `stripe`, etc.                                                     |
| account_id                   | text                     | External payout account reference                                  |
| status                       | text                     | `active`, `pending_verification`, `disabled`, etc.                 |
| UNIQUE(provider, account_id) | Avoid duplicate bindings |                                                                    |

---

### Table: `finance.invoices`

| Column                   | Type        | Notes                                                                 |
| ------------------------ | ----------- | --------------------------------------------------------------------- |
| id                       | uuid        | PK                                                                    |
| project_stage_id         | uuid        | FK → `projects.project_stages.id`                                     |
| issue_to_business_id     | uuid        | FK → `org.business_profiles.id` (buyer profile)                       |
| issue_to_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer)              |
| issue_from_profile       | uuid        | The freelancer profile / team / business that is issuing this invoice |
| amount_cents             | bigint      |                                                                       |
| currency                 | text        |                                                                       |
| status                   | text        | `draft`, `sent`, `paid`, `void`                                       |
| created_at               | timestamptz |                                                                       |

---

### Table: `finance.disputes`

| Column            | Type           | Notes                                                               |
| ----------------- | -------------- | ------------------------------------------------------------------- |
| id                | uuid           | PK                                                                  |
| escrow_id         | uuid           | FK → `finance.escrows.id` (the pot of money being fought over)      |
| opened_by_profile | uuid           | The profile_id (business or freelancer/team) who opened the dispute |
| reason            | text           | Human-readable complaint                                            |
| status            | dispute_status | `open`, `under_review`, `resolved`, `refunded`                      |
| resolution_notes  | text           | Moderator notes / final decision                                    |
| created_at        | timestamptz    |                                                                     |

### Table: `finance.dispute_messages`

| Column         | Type        | Notes                                  |
| -------------- | ----------- | -------------------------------------- |
| id             | uuid        | PK                                     |
| dispute_id     | uuid        | FK → `finance.disputes.id`             |
| sender_user_id | uuid        | FK → `auth.users.id`                   |
| body           | text        | Message / statement / evidence summary |
| created_at     | timestamptz |                                        |

> Internal "conversation" log for mediation / escalation during a dispute.

---

### Table: `finance.ratings`

| Column        | Type        | Notes                                            |
| ------------- | ----------- | ------------------------------------------------ |
| id            | uuid        | PK                                               |
| project_id    | uuid        | FK → `projects.projects.id`                      |
| rater_profile | uuid        | The profile who is leaving the rating            |
| ratee_type    | text        | `freelancer`, `team`, `business`, `organisation` |
| ratee_id      | uuid        | Profile/team/business/organisation being rated   |
| score         | smallint    | 1-5 stars                                        |
| comment       | text        | Public / semi-public feedback                    |
| created_at    | timestamptz |                                                  |

> This supports: freelancers rating clients (business or organisation) and clients rating
> freelancers/teams.

---

### Table: `finance.subscriptions`

| Column     | Type        | Notes                                                                           |
| ---------- | ----------- | ------------------------------------------------------------------------------- |
| id         | uuid        | PK                                                                              |
| profile_id | uuid        | The paying entity (freelancer_profile, team, business_profile, or organisation) |
| plan       | text        | Plan tier, e.g. `free`, `pro`, `team`, `enterprise`                             |
| status     | text        | `active`, `canceled`, `expired`                                                 |
| started_at | timestamptz | When billing/benefits started                                                   |
| ends_at    | timestamptz | When billing/benefits end if canceled or scheduled to lapse                     |

---

## 7. Marketplace Schema (`marketplace`)

Digital assets/templates for sale and purchase.

### Table: `marketplace.assets`

| Column            | Type        | Notes                                                   |
| ----------------- | ----------- | ------------------------------------------------------- |
| id                | uuid        | PK                                                      |
| seller_profile_id | uuid        | The freelancer/team/business profile selling this asset |
| title             | text        | Asset name                                              |
| description       | text        | Marketing copy                                          |
| preview_url       | text        | Public-ish preview (signed URL or downsample)           |
| file_ref          | text        | Internal reference to storage path of original asset    |
| category          | text        | For browsing / filtering                                |
| price_cents       | bigint      |                                                         |
| currency          | text        |                                                         |
| license_type      | text        | `full_rights`, `template_only`, etc.                    |
| status            | text        | `draft`, `published`                                    |
| created_at        | timestamptz |                                                         |

---

### Table: `marketplace.asset_versions`

| Column     | Type        | Notes                                       |
| ---------- | ----------- | ------------------------------------------- |
| id         | uuid        | PK                                          |
| asset_id   | uuid        | FK → `marketplace.assets.id`                |
| version    | int         | Version number                              |
| changelog  | text        | "Updated icons", "Fixed license text", etc. |
| file_ref   | text        | Storage ref for that specific version       |
| created_at | timestamptz |                                             |

---

### Table: `marketplace.asset_purchases`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id` (buyer).                 |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| amount_cents          | bigint      | Purchase amount                                          |
| currency              | text        |                                                          |
| license_granted       | text        | Snapshot of license terms at purchase time               |
| download_token        | text        | Token to enable secure short-lived download              |
| created_at            | timestamptz |                                                          |

---

### Table: `marketplace.asset_downloads`

| Column        | Type        | Notes                                 |
| ------------- | ----------- | ------------------------------------- |
| id            | uuid        | PK                                    |
| purchase_id   | uuid        | FK → `marketplace.asset_purchases.id` |
| downloaded_at | timestamptz | Timestamp of download                 |
| ip            | inet        | IP for audit / fraud                  |

---

### Table: `marketplace.asset_ratings`

| Column                | Type        | Notes                                                    |
| --------------------- | ----------- | -------------------------------------------------------- |
| id                    | uuid        | PK                                                       |
| asset_id              | uuid        | FK → `marketplace.assets.id`                             |
| buyer_business_id     | uuid        | FK → `org.business_profiles.id`                          |
| buyer_organisation_id | uuid        | FK → `org.organisations.id` (optional; enterprise buyer) |
| score                 | smallint    | Rating (1-5)                                             |
| comment               | text        | Feedback                                                 |
| created_at            | timestamptz |                                                          |

### Table: `marketplace.services`

| Column              | Type         | Notes                                                                                |
| ------------------- | ------------ | ------------------------------------------------------------------------------------ |
| id                  | uuid         | PK                                                                                   |
| seller_profile_type | profile_type | `freelancer` or `business` (future: extend enum if teams become first-class sellers) |
| seller_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on type    |
| title               | text         | Short name of the service (“Brand Audit”, “1:1 Coaching Call”)                       |
| slug                | text         | URL-safe identifier, unique per seller (e.g. `brand-audit`)                          |
| description         | text         | Long-form description of what’s included                                             |
| category            | text         | For browsing/filtering; can align with `search.topics.slug`                          |
| service_type        | text         | `one_off`, `package`, `retainer`, `session`                                          |
| base_price_cents    | bigint       | Starting price in minor units                                                        |
| currency            | text         | e.g. `GBP`, `USD`                                                                    |
| visibility          | visibility   | `public` or `invite_only`                                                            |
| status              | text         | `draft`, `published`, `paused`, `archived`                                           |
| estimated_duration  | interval     | Optional estimate (e.g. `2 hours`, `7 days`)                                         |
| created_at          | timestamptz  |                                                                                      |
| updated_at          | timestamptz  |                                                                                      |

---

## 8. Search Schema (`search`)

Search index and saved filters.

### Table: `search.search_index`

| Column                    | Type                                            | Notes                                                   |
| ------------------------- | ----------------------------------------------- | ------------------------------------------------------- |
| id                        | uuid                                            | PK                                                      |
| entity                    | text                                            | `freelancer`, `team`, `project_template`, `asset`, etc. |
| entity_id                 | uuid                                            | The row ID in that entity                               |
| text                      | tsvector                                        | Full-text index for Postgres search                     |
| updated_at                | timestamptz                                     |                                                         |
| UNIQUE(entity, entity_id) | De-duplicate search records per entity instance |                                                         |

### Table: `search.embeddings`

| Column                    | Type        | Notes                                   |
| ------------------------- | ----------- | --------------------------------------- |
| id                        | uuid        | PK                                      |
| entity                    | text        |                                         |
| entity_id                 | uuid        |                                         |
| embedding                 | vector      | pgvector column for semantic similarity |
| updated_at                | timestamptz |                                         |
| UNIQUE(entity, entity_id) |             |                                         |

### Table: `search.user_embeddings`

| Column     | Type        | Notes                     |
| ---------- | ----------- | ------------------------- |
| user_id    | uuid        | PK, FK → `auth.users.id`  |
| embedding  | vector      | User preference embedding |
| updated_at | timestamptz | Last rebuild time         |

### Table: `search.filters`

| Column        | Type  | Notes                                                |
| ------------- | ----- | ---------------------------------------------------- |
| id            | uuid  | PK                                                   |
| owner_user_id | uuid  | FK → `auth.users.id`                                 |
| name          | text  | Human-readable label ("My SEO/Figma freelancers UK") |
| query         | jsonb | Serialized filter config                             |

### Table: `search.topics`

| Column | Type | Notes                                                            |
| ------ | ---- | ---------------------------------------------------------------- |
| id     | uuid | PK                                                               |
| slug   | text | Unique machine-readable topic name (`marketing`, `design`, etc.) |
| label  | text | Human-readable display label                                     |

### Table: `search.entity_topics`

| Column                                   | Type | Notes                                          |
| ---------------------------------------- | ---- | ---------------------------------------------- |
| entity                                   | text | Same entity type used in `search.search_index` |
| entity_id                                | uuid | FK into the corresponding table                |
| topic_id                                 | uuid | FK → `search.topics.id`                        |
| PRIMARY KEY(entity, entity_id, topic_id) |      |                                                |

```sql
-- Suggested index
CREATE INDEX entity_topics_topic_idx ON search.entity_topics (topic_id);
```

---

## 9. Ops Schema (`ops`)

Admin/moderation, outbound webhooks, email queue, rate limit tracking.

### Table: `ops.admin_users`

| Column  | Type | Notes                              |
| ------- | ---- | ---------------------------------- |
| user_id | uuid | PK, FK → `auth.users.id`           |
| role    | text | `moderator`, `admin`, `superadmin` |

### Table: `ops.moderation_flags`

| Column       | Type        | Notes                         |
| ------------ | ----------- | ----------------------------- |
| id           | uuid        | PK                            |
| entity_table | text        | Which table/entity is flagged |
| entity_id    | uuid        | Row being flagged             |
| reason       | text        | Why it's flagged              |
| status       | text        | `open`, `reviewing`, `closed` |
| created_at   | timestamptz |                               |

### Table: `ops.webhook_outbox`

| Column        | Type        | Notes                                                       |
| ------------- | ----------- | ----------------------------------------------------------- |
| id            | uuid        | PK                                                          |
| topic         | text        | Event type e.g. `project.updated`, `payment.released`, etc. |
| payload       | jsonb       | Serialized payload                                          |
| status        | text        | `pending`, `sent`, `failed`                                 |
| retry_count   | int         | Number of retry attempts                                    |
| next_retry_at | timestamptz | When to try next                                            |
| created_at    | timestamptz |                                                             |

### Table: `ops.email_queue`

| Column     | Type        | Notes                       |
| ---------- | ----------- | --------------------------- |
| id         | uuid        | PK                          |
| to_email   | text        | Recipient                   |
| template   | text        | Template key                |
| vars       | jsonb       | Template variables          |
| status     | text        | `pending`, `sent`, `failed` |
| created_at | timestamptz |                             |

### Table: `ops.rate_limit_counters`

| Column           | Type        | Notes                                                          |
| ---------------- | ----------- | -------------------------------------------------------------- |
| id               | uuid        | PK                                                             |
| bucket_key       | text        | User/IP/bucket identifier (like `user:123-action:sendMessage`) |
| count            | int         | Count in the active rate limit window                          |
| window_starts_at | timestamptz | Start timestamp for the rolling / fixed window                 |

---

## 10. Analytics Schema (`analytics`)

Event logs + rollups.

### Table: `analytics.event_log`

| Column     | Type        | Notes                                                     |
| ---------- | ----------- | --------------------------------------------------------- |
| id         | uuid        | PK                                                        |
| user_id    | uuid        | FK → `auth.users.id`                                      |
| event      | text        | e.g. `stage.submitted`, `escrow.funded`, `dispute.opened` |
| props      | jsonb       | Extra analytics data                                      |
| created_at | timestamptz | Timestamp                                                 |

### Table: `analytics.daily_rollups`

| Column                   | Type   | Notes                                                           |
| ------------------------ | ------ | --------------------------------------------------------------- |
| day                      | date   | Part of composite PK                                            |
| metric                   | text   | Part of composite PK (e.g. `new_projects`, `escrow_volume_gbp`) |
| value                    | bigint | Metric value                                                    |
| PRIMARY KEY(day, metric) |        |                                                                 |

### Table: `analytics.entity_stats`

| Column                         | Type         | Notes                                                           |
| ------------------------------ | ------------ | --------------------------------------------------------------- |
| entity                         | text         | e.g., `freelancer`, `team`, `service`, `asset`, `article`, etc. |
| entity_id                      | uuid         | PK (together with entity)                                       |
| rating_avg                     | numeric(3,2) | Aggregated rating                                               |
| rating_count                   | integer      | Number of ratings                                               |
| views_7d                       | integer      | View count past 7 days                                          |
| clicks_7d                      | integer      | Click count past 7 days                                         |
| saves_7d                       | integer      | Save/shortlist count past 7 days                                |
| hires_7d                       | integer      | Hire/purchase count past 7 days                                 |
| views_30d                      | integer      | View count past 30 days                                         |
| hires_30d                      | integer      | Hire/purchase count past 30 days                                |
| dispute_rate                   | numeric(5,4) | Derived from finance.disputes vs completed work                 |
| last_activity_at               | timestamptz  | Last meaningful update                                          |
| PRIMARY KEY(entity, entity_id) |              |                                                                 |

```sql
CREATE INDEX entity_stats_activity_idx ON analytics.entity_stats (last_activity_at DESC);
```

### Table: `analytics.user_entity_stats`

| Column                                  | Type        | Notes                           |
| --------------------------------------- | ----------- | ------------------------------- |
| user_id                                 | uuid        | FK → `auth.users.id`            |
| entity                                  | text        | Entity type                     |
| entity_id                               | uuid        | FK into the corresponding table |
| views                                   | integer     | Total views by this user        |
| clicks                                  | integer     | Total clicks                    |
| saves                                   | integer     | Saved/shortlisted count         |
| hires                                   | integer     | Hires or purchases              |
| last_interaction_at                     | timestamptz | Most recent interaction         |
| PRIMARY KEY(user_id, entity, entity_id) |             |                                 |

```sql
CREATE INDEX user_entity_stats_user_idx ON analytics.user_entity_stats (user_id);
```

### View / Materialized View: `analytics.earnings_by_stage_mv`

| Column            | Type        | Notes                                  |
| ----------------- | ----------- | -------------------------------------- |
| project_stage_id  | uuid        | FK → `projects.project_stages.id`      |
| total_cents       | bigint      | Sum of released payouts for that stage |
| currency          | text        |                                        |
| last_refreshed_at | timestamptz | When MV was last updated               |

(Backed by SQL view / materialized view files in `/db/views/analytics/`.)

---

## 11. Integrations Schema (`integrations`)

External service hookups (GitHub, Trello, Notion, etc.).

### Table: `integrations.providers`

| Column     | Type        | Notes                                   |
| ---------- | ----------- | --------------------------------------- |
| id         | text        | PK (`github`, `trello`, `notion`, etc.) |
| label      | text        | Display name                            |
| auth_type  | text        | `oauth2`, `api_key`, `none`             |
| scopes     | text[]      | Required perms/scopes                   |
| created_at | timestamptz |                                         |

### Table: `integrations.connections`

| Column                                   | Type                                      | Notes                                                                                 |
| ---------------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------- |
| id                                       | uuid                                      | PK                                                                                    |
| provider_id                              | text                                      | FK → `integrations.providers.id`                                                      |
| owner_type                               | profile_type                              | Which profile context this belongs to (`freelancer`, `business`), or `user` if needed |
| owner_id                                 | uuid                                      | Profile or user this connection belongs to                                            |
| external_account_id                      | text                                      | External provider account identifier                                                  |
| access                                   | jsonb                                     | Encrypted tokens/config                                                               |
| status                                   | text                                      | `active`, `revoked`                                                                   |
| created_at                               | timestamptz                               |                                                                                       |
| INDEX(provider_id, owner_type, owner_id) | Helpful for "show me all my integrations" |                                                                                       |

### Table: `integrations.installs`

| Column        | Type        | Notes                              |
| ------------- | ----------- | ---------------------------------- |
| id            | uuid        | PK                                 |
| connection_id | uuid        | FK → `integrations.connections.id` |
| scope         | text        | e.g. `project:{id}` or `workspace` |
| settings      | jsonb       | Install-level configuration        |
| created_at    | timestamptz |                                    |

## 12. Content Schema (`content`)

Author-created content such as articles, guides, and thought-leadership pieces. Used to drive
discovery for sellers and educate buyers.

### Table: `content.articles`

| Column              | Type         | Notes                                                                                              |
| ------------------- | ------------ | -------------------------------------------------------------------------------------------------- |
| id                  | uuid         | PK                                                                                                 |
| author_profile_type | profile_type | `freelancer` or `business` (later extend if you want org/team-authored content)                    |
| author_profile_id   | uuid         | FK → `org.freelancer_profiles.id` or `org.business_profiles.id` depending on `author_profile_type` |
| title               | text         | Article title                                                                                      |
| slug                | text         | URL-safe identifier, unique per author (e.g. `how-to-brief-a-designer`)                            |
| excerpt             | text         | Short summary for cards/previews                                                                   |
| body                | text         | Main article content (Markdown or rich-text serialisation)                                         |
| cover_attachment_id | uuid         | FK → `org.attachments.id` (optional cover image)                                                   |
| tags                | text[]       | Optional tag list; for display only (search tags live in `search.entity_topics`)                   |
| visibility          | visibility   | `public` or `invite_only`                                                                          |
| status              | text         | `draft`, `published`, `archived`                                                                   |
| published_at        | timestamptz  | When article went live (NULL while draft)                                                          |
| created_at          | timestamptz  |                                                                                                    |
| updated_at          | timestamptz  |                                                                                                    |

```

### File: docs\10_APIEndpints.md

```md
# Projective API Specification

**Base URL:** `/api/v1`  
**Auth:** Bearer JWT (short-lived access)  
**Refresh:** Opaque token rotation  
**CAPTCHA:** Cloudflare Turnstile for anonymous POSTs  
**Storage:** Supabase signed URLs (60s TTL)  
**Rate Limiting:** Per-IP and per-user  
**RLS Context:** `active_profile_id`, `active_team_id`

---

## 🧩 Auth & Session

| Method | Endpoint                 | Description                                 |
| ------ | ------------------------ | ------------------------------------------- |
| POST   | `/auth/signup`           | Create account (email/password + Turnstile) |
| POST   | `/auth/login`            | Login, returns access + refresh tokens      |
| POST   | `/auth/refresh`          | Rotate refresh → new access token           |
| POST   | `/auth/logout`           | Revoke refresh token                        |
| GET    | `/auth/me`               | Get current user context                    |
| POST   | `/auth/turnstile/verify` | Verify CAPTCHA token                        |
| POST   | `/auth/switch-profile`   | Switch between freelancer/business profiles |
| POST   | `/auth/switch-team`      | Switch active team                          |

---

### Emails

| Method | Endpoint                      | Description                |
| ------ | ----------------------------- | -------------------------- |
| GET    | `/account/emails`             | List linked emails         |
| POST   | `/account/emails`             | Add email (sends verify)   |
| GET    | `/account/emails/:id`         | Check verification         |
| PATCH  | `/account/emails/:id/primary` | Make primary               |
| DELETE | `/account/emails/:id`         | Remove (guards if primary) |

---

## 👤 Users & Profiles

### Users

| Method | Endpoint     | Description           |
| ------ | ------------ | --------------------- |
| GET    | `/users/:id` | Public user info      |
| PATCH  | `/users/:id` | Update profile (self) |

### Freelancer Profiles

| Method | Endpoint           | Description                                   |
| ------ | ------------------ | --------------------------------------------- |
| GET    | `/freelancers/:id` | Get freelancer details                        |
| POST   | `/freelancers`     | Create freelancer profile                     |
| PATCH  | `/freelancers/:id` | Update freelancer info                        |
| DELETE | `/freelancers/:id` | Delete freelancer profile                     |
| GET    | `/freelancers`     | Discover freelancers (filter by skills, rate) |

### Business Profiles

| Method | Endpoint          | Description             |
| ------ | ----------------- | ----------------------- |
| GET    | `/businesses/:id` | Get business details    |
| POST   | `/businesses`     | Create business profile |
| PATCH  | `/businesses/:id` | Update business         |
| DELETE | `/businesses/:id` | Delete business profile |
| GET    | `/businesses`     | List user’s businesses  |

### Skills

| Method | Endpoint                         | Description          |
| ------ | -------------------------------- | -------------------- |
| GET    | `/skills`                        | List skill directory |
| POST   | `/users/:userId/skills`          | Add a skill to user  |
| DELETE | `/users/:userId/skills/:skillId` | Remove skill         |

### Attachments

| Method | Endpoint           | Description             |
| ------ | ------------------ | ----------------------- |
| POST   | `/attachments`     | Get signed upload URL   |
| GET    | `/attachments/:id` | Get attachment metadata |
| DELETE | `/attachments/:id` | Delete attachment       |

---

## 🧑‍🤝‍🧑 Teams & Organizations

| Method | Endpoint     | Description               |
| ------ | ------------ | ------------------------- |
| GET    | `/teams/:id` | Get team profile          |
| POST   | `/teams`     | Create new team           |
| PATCH  | `/teams/:id` | Update team               |
| DELETE | `/teams/:id` | Delete team               |
| GET    | `/teams`     | List owned & joined teams |

### Memberships

| Method | Endpoint                           | Description        |
| ------ | ---------------------------------- | ------------------ |
| POST   | `/teams/:id/members`               | Invite/add member  |
| PATCH  | `/teams/:id/members/:membershipId` | Update member role |
| DELETE | `/teams/:id/members/:membershipId` | Remove member      |

### Roles

| Method | Endpoint                   | Description |
| ------ | -------------------------- | ----------- |
| GET    | `/teams/:id/roles`         | List roles  |
| POST   | `/teams/:id/roles`         | Create role |
| PATCH  | `/teams/:id/roles/:roleId` | Update role |
| DELETE | `/teams/:id/roles/:roleId` | Delete role |

### Invitations

| Method | Endpoint                          | Description                     |
| ------ | --------------------------------- | ------------------------------- |
| POST   | `/org/invitations`                | Create invitation (email token) |
| POST   | `/org/invitations/:token/accept`  | Accept invitation               |
| POST   | `/org/invitations/:token/decline` | Decline invitation              |

---

## 🧱 Projects & Stages

| Method | Endpoint        | Description                                        |
| ------ | --------------- | -------------------------------------------------- |
| POST   | `/projects`     | Create a new project for a business or client      |
| GET    | `/projects/:id` | Get project details                                |
| PATCH  | `/projects/:id` | Update project information                         |
| DELETE | `/projects/:id` | Delete a project                                   |
| GET    | `/projects`     | List projects (filtered by role, status, or owner) |

### Stages

| Method | Endpoint                       | Description                                   |
| ------ | ------------------------------ | --------------------------------------------- |
| POST   | `/projects/:id/stages`         | Create stage(s) for a project                 |
| GET    | `/projects/:id/stages`         | List all stages for a project                 |
| PATCH  | `/stages/:stageId`             | Update a stage (status, name, etc.)           |
| PUT    | `/stages/:stageId/budget-rule` | Define pricing model (fixed, hourly, capped)  |
| POST   | `/stages/:stageId/assign`      | Assign freelancer or team to a stage          |
| DELETE | `/stages/:stageId/assign`      | Unassign freelancer or team                   |
| POST   | `/stages/:stageId/submissions` | Submit deliverables for approval              |
| GET    | `/stages/:stageId/submissions` | View stage submissions                        |
| POST   | `/stages/:stageId/approve`     | Approve the stage submission                  |
| GET    | `/projects/:id/activity`       | View recent activity or updates for a project |

### Participants & Activity

| Method | Endpoint                     | Description                |
| ------ | ---------------------------- | -------------------------- |
| POST   | `/projects/:id/participants` | Add project collaborator   |
| GET    | `/projects/:id/participants` | List participants          |
| GET    | `/projects/:id/activity`     | View project activity feed |

---

## 💬 Collaboration & Messaging

### 🧱 Project Channels

Project-based chats between the project owner and assigned freelancers/teams.  
Each project can have multiple channels — for stages, roles, or general discussion.

| Method | Endpoint                                    | Description                                                |
| ------ | ------------------------------------------- | ---------------------------------------------------------- |
| POST   | `/projects/:id/channels`                    | Create a new project channel (`#general`, `#design`, etc.) |
| GET    | `/projects/:id/channels`                    | List all channels within a project                         |
| POST   | `/project-channels/:channelId/messages`     | Send a message to a project channel                        |
| GET    | `/project-channels/:channelId/messages`     | Get messages in a project channel (paginated)              |
| GET    | `/project-channels/:channelId/files`        | View all files uploaded or shared in this channel          |
| POST   | `/project-channels/:channelId/participants` | Add or remove channel participants (by profile/team)       |

---

### 💬 Private Chats (DMs)

One-to-one or group conversations between any users on the platform.  
Ideal for team discussions or networking — fully separate from project communications.

| Method | Endpoint                          | Description                                      |
| ------ | --------------------------------- | ------------------------------------------------ |
| POST   | `/dms/threads`                    | Start a new DM or group chat with selected users |
| GET    | `/dms/threads`                    | List all your private DM threads                 |
| POST   | `/dms/threads/:threadId/messages` | Send a message to a DM thread                    |
| GET    | `/dms/threads/:threadId/messages` | Get messages in a DM thread (paginated)          |
| GET    | `/dms/threads/:threadId/files`    | View all files shared in this DM thread          |

---

### 🔔 Notifications

System and in-app alerts for messages, mentions, and activity.

| Method | Endpoint                  | Description                                             |
| ------ | ------------------------- | ------------------------------------------------------- |
| GET    | `/notifications`          | Get all notifications for the current user              |
| PATCH  | `/notifications/:id/read` | Mark notification(s) as read                            |
| GET    | `/notification-prefs`     | Retrieve notification preferences (email, push, digest) |
| PUT    | `/notification-prefs`     | Update notification preferences                         |
| POST   | `/device-tokens`          | Register a device for push notifications                |
| DELETE | `/device-tokens/:id`      | Remove registered device token                          |

---

## 🧠 Templates (Guided Hiring)

| Method | Endpoint                                             | Description               |
| ------ | ---------------------------------------------------- | ------------------------- |
| POST   | `/templates`                                         | Create template           |
| GET    | `/templates/:id`                                     | Get template              |
| PATCH  | `/templates/:id`                                     | Update template           |
| DELETE | `/templates/:id`                                     | Delete template           |
| GET    | `/templates`                                         | Browse templates          |
| POST   | `/templates/:id/stages`                              | Add template stage        |
| PATCH  | `/templates/stages/:templateStageId`                 | Update stage              |
| PUT    | `/templates/stages/:templateStageId/recommendations` | Add AI recommendations    |
| PUT    | `/templates/stages/:templateStageId/price`           | Set suggested price       |
| POST   | `/templates/:id/apply-to-project/:projectId`         | Apply template to project |

---

## 💰 Finance

| Method | Endpoint                    | Description                |
| ------ | --------------------------- | -------------------------- |
| GET    | `/wallets/mine`             | Get wallet by profile/team |
| GET    | `/wallets/:id/transactions` | Transaction history        |
| POST   | `/escrows`                  | Create escrow for stage    |
| POST   | `/escrows/:id/release`      | Release payment            |
| POST   | `/escrows/:id/refund`       | Refund payment             |
| GET    | `/escrows/:id`              | Get escrow details         |
| GET    | `/stages/:stageId/escrow`   | Get escrow for stage       |
| POST   | `/invoices`                 | Create invoice             |
| GET    | `/invoices/:id`             | Get invoice                |
| PATCH  | `/invoices/:id`             | Update invoice             |
| POST   | `/disputes`                 | Create dispute             |
| PATCH  | `/disputes/:id`             | Update dispute status      |
| POST   | `/ratings`                  | Submit rating              |
| POST   | `/webhooks/stripe`          | Stripe webhook endpoint    |

---

## 🛍️ Marketplace

| Method | Endpoint                  | Description               |
| ------ | ------------------------- | ------------------------- |
| POST   | `/assets`                 | Upload new asset          |
| GET    | `/assets/:id`             | Get asset info            |
| PATCH  | `/assets/:id`             | Update asset              |
| DELETE | `/assets/:id`             | Delete asset              |
| POST   | `/assets/:id/versions`    | Add asset version         |
| GET    | `/assets`                 | Browse marketplace assets |
| POST   | `/assets/:id/purchase`    | Purchase asset            |
| GET    | `/purchases/:id/download` | Download purchased asset  |
| POST   | `/assets/:id/ratings`     | Rate asset                |

---

## 🔍 Search

| Method | Endpoint              | Description                                  |
| ------ | --------------------- | -------------------------------------------- |
| GET    | `/search`             | Search freelancers, teams, templates, assets |
| POST   | `/search/filters`     | Save search filter                           |
| GET    | `/search/filters`     | List saved filters                           |
| DELETE | `/search/filters/:id` | Delete saved filter                          |

---

## 🛠️ Admin & Ops

| Method | Endpoint                          | Description               |
| ------ | --------------------------------- | ------------------------- |
| GET    | `/admin/users`                    | Admin list users          |
| POST   | `/admin/moderation/flags`         | Create content flag       |
| PATCH  | `/admin/moderation/flags/:id`     | Update moderation flag    |
| GET    | `/admin/webhook-outbox`           | List outbound webhooks    |
| POST   | `/admin/webhook-outbox/:id/retry` | Retry webhook delivery    |
| POST   | `/admin/email-queue`              | Queue transactional email |
| GET    | `/admin/rate-limits/:bucketKey`   | Inspect rate limit bucket |
| GET    | `/admin/audit-logs`               | Filter audit events       |

---

## 📈 Analytics

| Method | Endpoint                                | Description                   |
| ------ | --------------------------------------- | ----------------------------- |
| POST   | `/analytics/events`                     | Record client analytics event |
| GET    | `/analytics/daily`                      | View daily metrics            |
| GET    | `/analytics/earnings-by-stage/:stageId` | View stage earnings report    |

---

## ⚙️ Meta & Health

| Method | Endpoint             | Description           |
| ------ | -------------------- | --------------------- |
| GET    | `/health`            | Health check          |
| GET    | `/ready`             | Readiness probe       |
| GET    | `/version`           | Current API version   |
| GET    | `/feature-flags`     | Get feature flags     |
| POST   | `/csp-report`        | Report CSP violation  |
| GET    | `/rate-limit-status` | Show user rate limits |

---

## ✉️ Notifications & Emails

| Method | Endpoint                        | Description             |
| ------ | ------------------------------- | ----------------------- |
| POST   | `/emails/test`                  | Send test email         |
| POST   | `/notifications/broadcast`      | Admin broadcast message |
| POST   | `/notifications/digest/preview` | Preview digest email    |

---

## 📦 Storage & Files

Users can manage their personal file library, rename files before upload, and re-use files in chats or projects without re-uploading.

### 🗂️ User File Library

| Method | Endpoint              | Description                                                                         |
| ------ | --------------------- | ----------------------------------------------------------------------------------- |
| GET    | `/files`              | List all files in the user’s personal library (filterable by status, type, or name) |
| POST   | `/files/initiate`     | Begin a new file upload (returns signed upload URL)                                 |
| PATCH  | `/files/:id/rename`   | Rename a file before or after upload                                                |
| PATCH  | `/files/:id/finalize` | Mark a file as uploaded and available for reuse                                     |
| GET    | `/files/:id`          | Get file metadata and signed download URL                                           |
| DELETE | `/files/:id`          | Delete a file from the user’s library                                               |

---

### 📎 Chat File Reuse

| Method | Endpoint                               | Description                                         |
| ------ | -------------------------------------- | --------------------------------------------------- |
| POST   | `/project-messages/:msgId/attachments` | Attach an existing file to a project message        |
| POST   | `/dm-messages/:msgId/attachments`      | Attach an existing file to a private DM message     |
| GET    | `/project-channels/:channelId/files`   | View all files shared in a specific project channel |
| GET    | `/dms/threads/:threadId/files`         | View all files shared in a private DM thread        |

---

## 🔔 Realtime

| Method | Endpoint             | Description                      |
| ------ | -------------------- | -------------------------------- |
| GET    | `/realtime/auth`     | Get Supabase Realtime auth token |
| POST   | `/realtime/presence` | Announce realtime presence       |

---

## 🌐 Webhooks (Outbound)

| Method | Endpoint                                                                                                | Description               |
| ------ | ------------------------------------------------------------------------------------------------------- | ------------------------- |
| POST   | `/hooks`                                                                                                | Register external webhook |
| DELETE | `/hooks/:id`                                                                                            | Remove webhook            |
| Topics | `project.updated`, `stage.status_changed`, `payment.released`, `dispute.opened`, `asset.purchased`, ... |

---

## 🧩 Non-CRUD Action Endpoints

| Method | Endpoint                   | Description                        |
| ------ | -------------------------- | ---------------------------------- |
| POST   | `/auth/switch-profile`     | Switch active profile              |
| POST   | `/auth/switch-team`        | Switch active team                 |
| POST   | `/stages/:stageId/submit`  | Submit work (alias for submission) |
| POST   | `/stages/:stageId/approve` | Approve stage (shortcut)           |
| POST   | `/escrows/:id/release`     | Release escrow funds               |
| POST   | `/escrows/:id/refund`      | Refund escrow funds                |
| POST   | `/assets/:id/purchase`     | Purchase marketplace asset         |
| GET    | `/purchases/:id/download`  | Download purchased item            |

## 🔌 Integrations & Plugins

Future-ready integration endpoints to connect tools such as GitHub, Trello, Notion, or AI assistants.

| Method | Endpoint                        | Description                                                         |
| ------ | ------------------------------- | ------------------------------------------------------------------- |
| GET    | `/integrations/providers`       | List all available integration providers                            |
| POST   | `/integrations/connections`     | Connect an external account (OAuth or API key)                      |
| GET    | `/integrations/connections`     | List connected integrations for the current user/profile            |
| DELETE | `/integrations/connections/:id` | Disconnect an integration                                           |
| POST   | `/integrations/installs`        | Install or enable a connected integration in a workspace or project |
| GET    | `/integrations/installs`        | List integrations installed in the current workspace/project        |

---

**Last Updated:** October 2025  
**Generated For:** Projective Platform v1  
**Author:** GPT-5 (Projective System Docs)

```

### File: docs\11_Storage.md

```md
# 🗄️ Projective Storage Architecture

Supabase Storage layout for Projective — covering user file libraries, chat attachments, project assets, marketplace items, and future plugin integrations.

All buckets are **private** by default.  
Access is always managed via the database (RLS) and **short-lived signed URLs (TTL 60 s)**.

---

## 📁 Bucket Overview

| Bucket         | Purpose                                             | Visibility                           | Lifecycle                  |
| -------------- | --------------------------------------------------- | ------------------------------------ | -------------------------- |
| `avatars`      | User/team/business avatars                          | Private (optional public read later) | Keep; replace on upload    |
| `attachments`  | User personal file library (draft → uploaded)       | Private                              | Drafts expire after 7 days |
| `chat`         | Optional denormalized copies for project & DM chats | Private                              | Mirrors message lifetime   |
| `project`      | Project-scoped exports/artifacts                    | Private                              | Keep or purge by project   |
| `marketplace`  | Publicly listed assets & paid versions              | Mixed (previews vs originals)        | Keep versions              |
| `previews`     | Thumbnails / PDF & video previews                   | Private                              | Delete after 30 days       |
| `quarantine`   | Virus/MIME scan staging                             | Private                              | Delete after 24 h          |
| `integrations` | External provider import/export data                | Private                              | Keep 90 days               |
| `tmp`          | Ephemeral exports/transcodes                        | Private                              | Delete after 1 h           |

---

## 🧍 Avatars (`avatars`)

**Purpose:** Profile pictures and logos.  
**Paths**

- avatars/users/{user_id}/{uuid}.{ext}
- avatars/teams/{team_id}/{uuid}.{ext}
- avatars/businesses/{business_id}/{uuid}.{ext}

**RLS**

- Write: owner or admin.
- Read: via signed URL (or make public later).

---

## 📎 Attachments (`attachments`)

**Purpose:** Core personal file library — powers pre-upload rename & re-use across chats.  
Backed by `org.attachments` table. :contentReference[oaicite:1]{index=1}

**Paths**

- attachments/{owner_profile_id}/drafts/{attachment_id}/{original_filename}
- attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}

**Flow**

1. **Initiate:** create DB row (`status=draft`) → signed upload URL to `drafts/…`.
2. **Rename:** update `display_name` before finalize.
3. **Finalize:** verify file, scan → move to `files/…`, set `status=uploaded`.

**RLS**

- `SELECT/UPDATE/DELETE`: owner only.
- Others access only through `message_attachments` / `channel_files` joins.

**Lifecycle**

- Delete drafts > 7 days old.
- Keep uploaded files until deleted.

---

## 💬 Chat Files (`chat`) _(optional)_

**Purpose:** Direct per-channel galleries (may be omitted; DB joins work fine). :contentReference[oaicite:2]{index=2}

**Paths**

- chat/projects/{project_id}/channels/{channel_id}/{attachment_id}/{filename}
- chat/dms/{thread_id}/{attachment_id}/{filename}

**Policy**

- Participants can read/write within their channels or DM threads.

**TTL**

- 60 s signed URLs; keep while messages exist.

---

## 🧱 Project Assets (`project`)

**Purpose:** Store compiled deliverables or exports not owned by individuals.

**Paths**

- project/{project_id}/exports/{yyyy-mm}/{uuid}.pdf
- project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}

**RLS**

- Project owners and participants can read.
- Writes by system jobs.

---

## 🛍️ Marketplace (`marketplace`)

**Purpose:** Marketplace asset versions and buyer-only downloads. :contentReference[oaicite:3]{index=3}

**Paths**

- marketplace/assets/{asset_id}/versions/{version_id}/{filename}
- marketplace/assets/{asset_id}/previews/{uuid}.{ext}
- marketplace/purchases/{purchase_id}/license/{license_id}.pdf

**Access**

- Previews: readable by anyone via signed URL.
- Originals: only verified buyers via `/purchases/:id/download`.

---

## 🖼️ Previews (`previews`)

**Purpose:** Generated thumbnails and PDF/video snapshots.

**Paths**

- previews/attachments/{attachment_id}/thumb.{ext}
- previews/attachments/{attachment_id}/page-1.png
- previews/marketplace/{asset_id}/grid/{size}/{uuid}.jpg

**Lifecycle:** purge after 30 days (regenerate on demand).

---

## 🧪 Quarantine (`quarantine`)

**Purpose:** Temporary holding area for antivirus & MIME scanning.

**Paths**

- quarantine/{owner_profile_id}/{attachment_id}/{original_filename}

**Flow**

1. Upload → scan service.
2. Move to `attachments/.../files` if clean.
3. Delete otherwise.

**Lifecycle:** delete after 24 h.

---

## 🔌 Integrations (`integrations`)

**Purpose:** Store plugin-related imports/exports (GitHub, Trello, Notion, etc.).

**Paths**

- integrations/{provider}/{owner_type}-{owner_id}/imports/{yyyy-mm}/{uuid}.json
- integrations/{provider}/{owner_type}-{owner_id}/exports/{yyyy-mm}/{uuid}.json

**RLS:** only connection owner may read/write.

---

## ⚙️ Temporary Files (`tmp`)

**Purpose:** Ad-hoc zips, transcodes, analytics exports.

**Paths**

- tmp/{user_id}/{uuid}.{ext}

**Lifecycle:** auto-delete after 1 h.

---

## 🔐 Cross-Cutting Settings

### Signed URL TTL

Default **60 seconds**; increase selectively for large transfers. :contentReference[oaicite:4]{index=4}

### Metadata (object headers)

| Key                   | Purpose             |
| --------------------- | ------------------- |
| `attachment_id`       | Link back to DB row |
| `owner_profile_id`    | RLS lookup          |
| `sha256`              | Integrity           |
| `mime_type`           | Validation          |
| `uploaded_by_user_id` | Audit trail         |

### Lifecycle Rules

| Path                      | Action | Retention |
| ------------------------- | ------ | --------- |
| `attachments/**/drafts/*` | Delete | 7 days    |
| `tmp/**`                  | Delete | 1 h       |
| `quarantine/**`           | Delete | 24 h      |
| `previews/**`             | Delete | 30 days   |

### Antivirus

Uploads start in `quarantine` → scan → move to destination on success → mark DB row clean.

---

## 🧾 Example Storage Policies (pseudocode)

**attachments**

```sql
CREATE POLICY "attachments_read_own_or_shared"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'attachments' AND (
    EXISTS (
      SELECT 1 FROM org.attachments a
      WHERE a.bucket = 'attachments'
        AND a.path = objects.name
        AND (
          a.owner_profile_id = auth.jwt()->>'active_profile_id'
          OR EXISTS (
            SELECT 1 FROM comms.message_attachments ma
            JOIN comms.channel_files cf ON cf.attachment_id = a.id
            WHERE ma.attachment_id = a.id
              AND project_or_dm_participant(auth.uid())
          )
        )
    )
  )
);

CREATE POLICY "chat_read_participants_only"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'chat' AND user_is_channel_participant(objects.name)
);

CREATE POLICY "marketplace_read_purchased_or_preview"
ON storage.objects
FOR SELECT USING (
  bucket_id = 'marketplace' AND (
    path LIKE 'marketplace/assets/%/previews/%'
    OR EXISTS (
      SELECT 1 FROM marketplace.asset_purchases p
      WHERE path LIKE format('marketplace/assets/%s/%%', p.asset_id)
        AND p.buyer_profile_id = auth.jwt()->>'active_profile_id'
    )
  )
);
```

```

### File: docs\12_RLS.md

```md
# RLS Strategy & Claims Matrix

Projective Supabase RLS Strategy & Claims Matrix\
Last Updated: 28 Oct 2025\
Author: GPT-5 Thinking (Projective Security Spec)

---

## Purpose

We enforce “you only see what you’re currently acting as.”

- A single human user (`auth.users`) can act as:
  - themself
  - their freelancer profile
  - one of their business profiles (“creator” / “client”)
  - a team they’re part of (mini-agency)
- The frontend explicitly switches context and refreshes the JWT.
- The DB never trusts arbitrary row data — it always checks:
  - `auth.uid()` (the Supabase user id)
  - `auth.jwt()->>'active_profile_type'`
  - `auth.jwt()->>'active_profile_id'`
  - `auth.jwt()->>'active_team_id'`

Every table with sensitive data must:

1. Be RLS-enabled.
2. Have policies that assert:\
   “Row is visible only if it’s tied to the caller’s active profile, team, or user.”

This doc is the baseline reference for implementing policies in `/db/policies/**`.

---

## 1. JWT Claims (Session Context)

### Required JWT custom claims

| Claim                 | Example Value                  | Notes                                                             |
| --------------------- | ------------------------------ | ----------------------------------------------------------------- |
| `sub`                 | `"9a7f...uuid"`                | The Supabase `auth.users.id`                                      |
| `active_profile_type` | `"freelancer"` or `"business"` | Explicit role context for this session                            |
| `active_profile_id`   | `"f44c...uuid"`                | The freelancer_profile.id OR business_profile.id you’re acting as |
| `active_team_id`      | `"a12b...uuid"` or `null`      | If you’re acting on behalf of a team / agency                     |

These claims are derived from `security.session_context` for the current `user_id`.\
On profile/team switch, we write a new row (or update) in `security.session_context` then mint a new JWT.

### Access helpers in SQL

- `auth.uid()` → UUID of the logged-in human user.
- `auth.jwt()->>'active_profile_id'` → profile (string) for row scoping.
- `auth.jwt()->>'active_profile_type'` → `"freelancer"` / `"business"`.
- `auth.jwt()->>'active_team_id'` → team (string) for team-scope rules.

We assume helper functions like:

```sql
-- Returns true if the current human user is an active participant in
-- a given project or DM thread (used by comms/chat access).
CREATE OR REPLACE FUNCTION security.project_or_dm_participant(_channel_id uuid)
RETURNS boolean AS $$
  -- implementation detail lives in /db/functions/security.project_or_dm_participant.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;

-- Returns array of all team_ids that are considered valid actors
-- on a given project (for team-based access).
CREATE OR REPLACE FUNCTION security.project_team_ids(_project_id uuid)
RETURNS uuid[] AS $$
  -- implementation detail lives in /db/functions/security.project_team_ids.sql
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

You’ll create/maintain these in `db/functions/`.

---

## 2. Default Policy Templates

These are “starter snippets” we’ll reuse per table.\
All policies should be named clearly (e.g. `pol_projects_projects_owner_select`).

### 2.1 SELECT template

Goal: allow reading rows that belong to the active profile, active team, or self.

```sql
CREATE POLICY "select_visible_rows"
ON <schema>.<table>
FOR SELECT
USING (
  (
    -- direct ownership via profile
    (<table>.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- direct ownership via team
    (<table>.team_id::text = auth.jwt()->>'active_team_id')
    OR
    -- direct ownership via user
    (<table>.user_id = auth.uid())
  )
  OR
  (
    -- project / channel participation (optional, for collab tables)
    security.project_or_dm_participant(<table>.id) = true
  )
);
```

### 2.2 INSERT template

Goal: user can only insert rows “as” their active context.

```sql
CREATE POLICY "insert_as_active_context"
ON <schema>.<table>
FOR INSERT
WITH CHECK (
  (
    -- user is inserting a row for themselves
    (NEW.user_id = auth.uid())
    OR
    -- user is inserting a row for the profile they are currently acting as
    (NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id')
    OR
    -- user is inserting on behalf of team they currently act as
    (NEW.team_id::text = auth.jwt()->>'active_team_id')
  )
);
```

### 2.3 UPDATE template

Goal: cannot update things outside your scope.

```sql
CREATE POLICY "update_owned_rows"
ON <schema>.<table>
FOR UPDATE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
)
WITH CHECK (
  (
    NEW.user_id = auth.uid()
    OR NEW.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR NEW.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

### 2.4 DELETE template

Goal: usually only owners or business “client_business_id” or project owners can delete.

```sql
CREATE POLICY "delete_owned_rows"
ON <schema>.<table>
FOR DELETE
USING (
  (
    <table>.user_id = auth.uid()
    OR <table>.owner_profile_id::text = auth.jwt()->>'active_profile_id'
    OR <table>.team_id::text = auth.jwt()->>'active_team_id'
  )
);
```

Note: for some tables (finance.escrows, audit logs, etc.) delete is disabled entirely.

---

## 3. Admin / Service Role Bypass

- Supabase “service_role” key runs queries with `role = service_role`, which ignores RLS.\
  Use this ONLY for:
  - background jobs
  - Stripe webhooks
  - scheduled maintenance
  - internal moderation dashboards

- Admin users (in `ops.admin_users`) still go through RLS at query time unless you explicitly add policies that check admin membership.

Recommended pattern:

```sql
-- Helper: is current user an admin?
CREATE OR REPLACE FUNCTION security.is_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1
    FROM ops.admin_users au
    WHERE au.user_id = auth.uid()
  );
$$ LANGUAGE sql STABLE SECURITY DEFINER;
```

Then in any table where admins need read access:

```sql
... OR security.is_admin() = true
```

### Restricted tables

- `security.refresh_tokens` (not shown in schema but implied by our auth model)
- `security.session_context`
- `security.audit_logs`

These SHOULD NOT be directly queryable by normal users except in the minimal ways documented below.

---

## 4. Table-by-Table RLS Examples

Below are concrete examples for seven key tables.\
These are examples, not final migrations.\
You’ll drop them in `/db/policies/<schema>/<table>.sql` and adapt columns.

---

### 4.1 `org.users_public`

**Purpose:** public display info per human user.\
Columns: `user_id`, `display_name`, etc.\
Rule:

- Anyone logged-in can `SELECT` any row (public directory-like).
- User can `UPDATE` ONLY their own row.
- Insert happens at onboarding.
- Delete is blocked (soft-delete or anonymize instead).

Enable RLS:

```sql
ALTER TABLE org.users_public ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read: any authenticated user can see public profiles
CREATE POLICY "org_users_public_select_all_auth"
ON org.users_public
FOR SELECT
USING ( auth.uid() IS NOT NULL );

-- Insert: user may create their own entry
CREATE POLICY "org_users_public_insert_self"
ON org.users_public
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

-- Update: user may update only their own row
CREATE POLICY "org_users_public_update_self"
ON org.users_public
FOR UPDATE
USING ( org.users_public.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- Delete: nobody (omit policy, or explicitly deny)
```

Note: If we want moderation/admin edit, extend `USING (...) OR security.is_admin()`.

---

### 4.2 `security.session_context`

**Purpose:** source of truth for the user’s current acting profile/team.\
Columns: `user_id`, `active_profile_type`, `active_profile_id`, `active_team_id`, `updated_at`.

Rules:

- User can read ONLY their own row.
- User can update ONLY their own row.
- No deletes.

Enable RLS:

```sql
ALTER TABLE security.session_context ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- Read own session context
CREATE POLICY "security_session_context_select_self"
ON security.session_context
FOR SELECT
USING ( security.session_context.user_id = auth.uid() );

-- Insert/Update own context (used on profile/team switch)
CREATE POLICY "security_session_context_upsert_self"
ON security.session_context
FOR INSERT
WITH CHECK ( NEW.user_id = auth.uid() );

CREATE POLICY "security_session_context_update_self"
ON security.session_context
FOR UPDATE
USING ( security.session_context.user_id = auth.uid() )
WITH CHECK ( NEW.user_id = auth.uid() );

-- No delete policy (effectively blocked for normal users)
```

Note: Background jobs and auth middleware can still overwrite via service_role.

---

### 4.3 `projects.projects`

Relevant columns:

- `id`
- `client_business_id` → `org.business_profiles.id` (the “buyer” / creator)
- (via joins) freelancers, teams, etc. in `projects.project_participants`

Access rules:

- The business profile that owns the project can read/update/delete that project.
- Any freelancer/team added to that project via `project_participants` can also `SELECT`.
- Only the business owner (`client_business_id`) can `UPDATE` or `DELETE`.

We’ll assume helper `projects.is_project_member(projects.id)` which checks:

- `auth.jwt()->>'active_profile_id'` matches a row in `project_participants`
  OR
- the project’s `client_business_id` matches `active_profile_id`
  OR
- current `active_team_id` is in `security.project_team_ids(projects.id)`.

Enable RLS:

```sql
ALTER TABLE projects.projects ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: project members or owning business can view
CREATE POLICY "projects_projects_select_members"
ON projects.projects
FOR SELECT
USING (
  (
    projects.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  EXISTS (
    SELECT 1
    FROM projects.project_participants pp
    WHERE pp.project_id = projects.id
      AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  (
    auth.jwt()->>'active_team_id' IS NOT NULL
    AND auth.jwt()->>'active_team_id' = ANY(
      security.project_team_ids(projects.id)
    )
  )
  OR security.is_admin() = true
);

-- INSERT: only a business profile can create a project,
-- and they can only do it for themselves.
CREATE POLICY "projects_projects_insert_business_owner"
ON projects.projects
FOR INSERT
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
  AND auth.jwt()->>'active_profile_type' = 'business'
);

-- UPDATE: only the owning business can update core project data
CREATE POLICY "projects_projects_update_owner"
ON projects.projects
FOR UPDATE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
)
WITH CHECK (
  NEW.client_business_id::text = auth.jwt()->>'active_profile_id'
);

-- DELETE: only the owning business can delete (e.g. cancel draft)
CREATE POLICY "projects_projects_delete_owner"
ON projects.projects
FOR DELETE
USING (
  projects.client_business_id::text = auth.jwt()->>'active_profile_id'
);
```

---

### 4.4 `projects.project_stages`

Relevant columns:

- `project_id`
- assignment happens through `projects.stage_assignments`
- different actors (client, assigned freelancer/team) need visibility

Rules:

- Anyone who can see the parent project can `SELECT` its stages.
- UPDATE allowed if:
  - caller is `client_business_id` of parent project, OR
  - caller is the assigned freelancer/team for that stage.

Enable RLS:

```sql
ALTER TABLE projects.project_stages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: you can read a stage if you can read its parent project
CREATE POLICY "project_stages_select_members"
ON projects.project_stages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND (
        p.client_business_id::text = auth.jwt()->>'active_profile_id'
        OR EXISTS (
          SELECT 1
          FROM projects.project_participants pp
          WHERE pp.project_id = p.id
            AND pp.profile_id::text = auth.jwt()->>'active_profile_id'
        )
        OR (
          auth.jwt()->>'active_team_id' IS NOT NULL
          AND auth.jwt()->>'active_team_id' = ANY(
            security.project_team_ids(p.id)
          )
        )
        OR security.is_admin() = true
      )
  )
);

-- INSERT: only project owner (business) can add stages
CREATE POLICY "project_stages_insert_owner"
ON projects.project_stages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = NEW.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
);

-- UPDATE: owner OR assigned freelancer/team
CREATE POLICY "project_stages_update_owner_or_assignee"
ON projects.project_stages
FOR UPDATE
USING (
  -- project owner?
  EXISTS (
    SELECT 1
    FROM projects.projects p
    WHERE p.id = project_stages.project_id
      AND p.client_business_id::text = auth.jwt()->>'active_profile_id'
  )
  OR
  -- assigned freelancer?
  EXISTS (
    SELECT 1
    FROM projects.stage_assignments sa
    WHERE sa.project_stage_id = project_stages.id
      AND (
        sa.freelancer_profile_id::text = auth.jwt()->>'active_profile_id'
        OR sa.team_id::text = auth.jwt()->>'active_team_id'
      )
      AND sa.status IN ('accepted','active')
  )
  OR security.is_admin() = true
)
WITH CHECK ( true ); -- we trust USING above for now

-- DELETE: usually disallowed (stages form payment trails), so no policy
```

---

### 4.5 `finance.transactions`

Relevant columns:

- `wallet_id` → belongs to a wallet
- `wallets.owner_type`, `wallets.owner_id`

Rules:

- You can read transactions only if you control the wallet’s owner (your active profile, or your active team, or you’re that business).
- No INSERT/UPDATE/DELETE from clients directly — finance is system-only.

Enable RLS:

```sql
ALTER TABLE finance.transactions ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: wallet owner only
CREATE POLICY "finance_transactions_select_wallet_owner"
ON finance.transactions
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM finance.wallets w
    WHERE w.id = transactions.wallet_id
      AND (
        -- acting profile owns the wallet
        w.owner_id::text = auth.jwt()->>'active_profile_id'
        OR
        -- acting team owns the wallet
        w.owner_id::text = auth.jwt()->>'active_team_id'
      )
  )
  OR security.is_admin() = true
);

-- No INSERT/UPDATE/DELETE policies for normal users
-- (service_role bypasses RLS for ledger writes)
```

---

### 4.6 `org.team_memberships`

Relevant columns:

- `team_id`
- `user_id` (the human account)
- `role`, `status`

Rules:

- A user can read rows if they are in that team.
- Team owner (and maybe `team_lead`) can update membership rows.
- You can’t randomly add yourself to teams you don’t control.

Enable RLS:

```sql
ALTER TABLE org.team_memberships ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: anyone who is an active member of that same team can view membership
CREATE POLICY "team_memberships_select_team_member"
ON org.team_memberships
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.status = 'active'
  )
  OR security.is_admin() = true
);

-- INSERT: only team owner (or admin role) can add members
CREATE POLICY "team_memberships_insert_team_owner"
ON org.team_memberships
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = NEW.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- UPDATE: team owner or admin-level membership
CREATE POLICY "team_memberships_update_team_owner"
ON org.team_memberships
FOR UPDATE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR
  EXISTS (
    SELECT 1
    FROM org.team_memberships me
    WHERE me.team_id = team_memberships.team_id
      AND me.user_id = auth.uid()
      AND me.role IN ('team_lead','admin')
      AND me.status = 'active'
  )
  OR security.is_admin() = true
)
WITH CHECK ( true );

-- DELETE: team owner (or admin) can remove members
CREATE POLICY "team_memberships_delete_team_owner"
ON org.team_memberships
FOR DELETE
USING (
  EXISTS (
    SELECT 1
    FROM org.teams t
    WHERE t.id = team_memberships.team_id
      AND t.owner_user_id = auth.uid()
  )
  OR security.is_admin() = true
);
```

This gives team leads power to manage their roster without giving global access.

---

### 4.7 `comms.dm_threads` / `comms.dm_messages`

We’ll show `dm_threads` + `dm_messages` because they’re the cleanest messaging case.\
Core idea applies similarly to `comms.project_channels` and `comms.project_messages` (but those also check project membership).

#### `comms.dm_threads`

Columns:

- `id`
- `created_by_user_id`

Membership comes from `comms.dm_participants (thread_id, user_id)`.

RLS rules:

- You can `SELECT` a thread only if you’re in `dm_participants`.
- You can `INSERT` a new thread if you’re authenticated.
- You can’t `UPDATE` or `DELETE` other people’s threads (no policy).

Enable RLS:

```sql
ALTER TABLE comms.dm_threads ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant
CREATE POLICY "dm_threads_select_participant"
ON comms.dm_threads
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_threads.id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: any logged-in user can create a new DM thread
CREATE POLICY "dm_threads_insert_creator"
ON comms.dm_threads
FOR INSERT
WITH CHECK (
  NEW.created_by_user_id = auth.uid()
);
```

#### `comms.dm_messages`

Columns:

- `thread_id`
- `sender_user_id`
- `body`

RLS rules:

- You can `SELECT` messages in threads you participate in.
- You can `INSERT` only if you’re in that thread and you’re the sender.
- UPDATE/DELETE are disallowed to keep auditability (or can be “soft-delete”).

Enable RLS:

```sql
ALTER TABLE comms.dm_messages ENABLE ROW LEVEL SECURITY;
```

Policies:

```sql
-- SELECT: must be a participant in the thread
CREATE POLICY "dm_messages_select_participant"
ON comms.dm_messages
FOR SELECT
USING (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = dm_messages.thread_id
      AND dp.user_id = auth.uid()
  )
  OR security.is_admin() = true
);

-- INSERT: must be participant AND the sender
CREATE POLICY "dm_messages_insert_participant_sender"
ON comms.dm_messages
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM comms.dm_participants dp
    WHERE dp.thread_id = NEW.thread_id
      AND dp.user_id = auth.uid()
  )
  AND NEW.sender_user_id = auth.uid()
);
```

For `comms.project_messages`, your `USING` and `WITH CHECK` clauses would mirror logic from `projects.project_stages`, except the join is via `comms.project_channel_participants` instead of `comms.dm_participants`, and the scope is `active_profile_id` / `active_team_id` instead of just `auth.uid()`.

---

## 5. Special Notes & Gotchas

### 5.1 Service Role

- The Supabase “service_role” bypasses ALL RLS.
- Use it strictly in trusted server code (Edge runtime with secret key, cron, Stripe webhooks).
- Never expose service_role to the browser.

### 5.2 `ops.*`, `analytics.*`

- Operational / analytics tables (audit trail, rollups, rate limit counters) should either:
  - be service-role only, OR
  - expose read-only slices via views with stricter policies.

### 5.3 `security.audit_logs`

- Don’t let normal users read the global audit log of other users.
- You MAY allow a user to read back only their own entries for transparency.

Example:

```sql
ALTER TABLE security.audit_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "audit_logs_select_self_or_admin"
ON security.audit_logs
FOR SELECT
USING (
  security.audit_logs.user_id = auth.uid()
  OR security.is_admin() = true
);

-- No insert/update/delete policies for public;
-- logs are written by service_role only.
```

### 5.4 `security.refresh_tokens`

(If you store hashed refresh tokens in DB.)

- NO RLS policies for public.
- Table should be fully private: only service_role inserts/rotates/invalidates refresh tokens.
- Do not expose this table to clients at all. Never query from browser context.

### 5.5 `storage.objects`

- Storage also uses RLS in Supabase.
- You must align `storage.objects` policies with `org.attachments` and channel/project membership.
- Ensure that object path/bucket metadata can be joined back to a profile_id, project_id, channel_id, etc.

You’ll enforce rules like:

- “Attachment belongs to `auth.jwt()->>'active_profile_id'`”
- OR “Attachment is shared in a channel where `auth.uid()` is a participant”
- OR “Attachment is part of a project where active profile/team is a participant”
- Admin override OR service_role.

(See `11_Storage.md` for deeper per-bucket rules.)

---

## 6. Policy Naming, Placement & Conventions

- All policies live in versioned SQL under `db/policies/<schema>/<table>.sql`.
- One table per file.
- Names reflect WHO and WHY, not just CRUD:
  - `pol_projects_projects_owner_select`
  - `pol_projects_project_stages_update_owner_or_assignee`
  - `pol_finance_transactions_select_wallet_owner`
  - `pol_comms_dm_messages_insert_participant_sender`

This avoids mystery and helps audits.

---

## 7. Recap / TL;DR

1. Every authenticated request includes:
   - `auth.uid()`
   - `auth.jwt()->>'active_profile_type'`
   - `auth.jwt()->>'active_profile_id'`
   - `auth.jwt()->>'active_team_id'`

2. All sensitive tables are RLS-enabled.

3. Policies check:
   - Does this row belong to my active profile OR my active team?
   - Am I directly assigned / participating in this project, stage, channel, or thread?
   - Am I the wallet/payee/payer on the money row?
   - Am I the team owner / business owner / freelancer assigned?
   - OR am I an admin (`security.is_admin()`)?
   - Otherwise: no access.

4. Finance tables are read-only for end users, write-only for the system.
5. `security.*` tables are locked down to self or admin, never world-readable.
6. Storage rules mirror DB row ownership + sharing, never public by default.
7. The service_role key bypasses RLS and is only used in trusted server code (Stripe webhooks, cron, moderation tools).

This guarantees isolation between:

- different business profiles owned by the same human,
- freelancers inside and outside teams,
- teams hired by a business,
- and unrelated projects/DMs.

Everything is enforced at the database layer — even if the API layer forgets.

```
```

```

### File: docs\13_FolderStructure.md

```md
# Projective Monorepo — Folder Structure & Naming Conventions

This is a pragmatic structure for a Deno Fresh + Supabase (Postgres + RLS) + Rust WASM project. It keeps the edge app, API routes, database, and infra tidy; is CI-friendly; and scales from MVP to multi-team.

---

## 1) Top-Level Layout

```text
projective/
├─ apps/
│  └─ web/                     # Fresh (Deno) app: UI + API routes
├─ packages/
│  ├─ ui/                      # Shared UI (islands/components, Tailwind, shadcn wrappers)
│  ├─ lib/                     # Isomorphic TS utilities (validators, schema, errors, dates)
│  ├─ sdk/                     # Typed client for calling /api/v1 from browser/edge jobs
│  └─ wasm/                    # Rust crates compiled to WebAssembly
├─ db/
│  ├─ migrations/              # SQL migrations (idempotent, forward-only)
│  ├─ seeds/                   # Non-essential seed data
│  ├─ policies/                # RLS policies split by schema/table
│  ├─ functions/               # SQL & plpgsql functions (e.g., auth helpers)
│  ├─ views/                   # Views/materialized views
│  └─ scripts/                 # Local helpers (dump/restore, diff)
├─ supabase/
│  ├─ config/                  # Supabase CLI config, access roles
│  ├─ storage-rules/           # Storage (policy) snippets per bucket
│  └─ edge-functions/          # (Optional) Supabase Edge Functions
├─ infra/
│  ├─ deno/                    # Deno Deploy or self-host manifests
│  ├─ cf/                      # Cloudflare Turnstile or Workers (if used)
│  ├─ stripe/                  # Webhook fixtures & CLI scripts
│  └─ github/                  # GitHub Actions workflows
├─ docs/
│  ├─ architecture/            # ADRs, diagrams
│  ├─ api/                     # OpenAPI (generated), endpoint docs
│  └─ product/                 # Feature specs, user flows
├─ scripts/                    # Cross-repo task runners (deno task aliases)
├─ .env.example                # Example env config (never commit real secrets)
├─ deno.json                   # Deno config (tasks, import map, lint)
├─ import_map.json             # Bare module specifiers mapping
├─ README.md
└─ LICENSE
```

---

## 2) `apps/web` (Fresh App) Structure

```text

apps/web/
├─ routes/                     # Fresh routes: pages + API endpoints
│  ├─ (public)/                # Authless pages (marketing, landing)
│  ├─ (auth)/                  # /login, /signup
│  ├─ (dashboard)/             # Authenticated areas
│  ├─ api/                     # Fresh API routes (edge)
│  │  └─ v1/                   # /api/v1/*
│  │     ├─ auth/
│  │     ├─ users/
│  │     ├─ freelancers/
│  │     ├─ businesses/
│  │     ├─ teams/
│  │     ├─ projects/
│  │     ├─ stages/
│  │     ├─ dms/
│  │     ├─ templates/
│  │     ├─ finance/
│  │     ├─ marketplace/
│  │     ├─ search/
│  │     └─ meta/
│  └─ _app.tsx                 # App shell
├─ islands/                    # Preact interactive islands
├─ components/                 # Presentational components
├─ features/                   # Feature slices (screens, hooks, services)
│  ├─ auth/
│  ├─ account-switcher/
│  ├─ team-selector/
│  ├─ messaging/
│  ├─ projects/
│  ├─ marketplace/
│  └─ templates/
├─ server/                     # Server-side helpers (KV, cookies, auth)
│  ├─ auth/
│  ├─ kv/
│  └─ middleware/
├─ services/                   # API integrations (Supabase client, Stripe, Turnstile)
├─ styles/                     # Tailwind CSS, global styles
├─ types/                      # App-level TypeScript types
├─ tests/                      # e2e/integration tests (deno test)
└─ static/                     # Assets served as static files
```

**API route filenames** mirror endpoint paths. Example:

- `/api/v1/projects/[id].ts` → `GET, PATCH, DELETE` handlers
- `/api/v1/stages/[stageId]/approve.ts` → action endpoints  
  Keep one file per resource or action for discoverability.

---

## 3) `packages` (Shared Code)

```text

packages/ui/                   # Reusable UI (Tailwind + shadcn)
packages/lib/                  # Pure TS: zod schemas, errors, utils
packages/sdk/                  # Typed fetchers for /api/v1 (request/response types)
packages/wasm/
└─ image_ops/                  # Rust crate compiled to wasm (wasm-bindgen)
```

**Naming**

- Packages: `kebab-case`.
- Exports: prefer named exports; default export only for React components.
- WASM crates: `snake_case` (Rust convention); built artifacts published to `packages/wasm/<crate>/dist/`.

---

## 4) Database Files (`/db`)

```text

db/
├─ migrations/
│  ├─ 0001_init_schemas.sql
│  ├─ 0002_org_tables.sql
│  ├─ 0003_projects_tables.sql
│  ├─ 0004_comms_tables.sql
│  ├─ 0005_finance_tables.sql
│  ├─ 0006_marketplace_tables.sql
│  ├─ 0007_search_templates.sql
│  ├─ 0008_indexes_constraints.sql
│  ├─ 0009_rls_enable.sql
│  └─ 0010_policies_batch_1.sql
├─ policies/
│  ├─ org/
│  │  ├─ freelancer_profiles.sql
│  │  ├─ business_profiles.sql
│  │  ├─ team_memberships.sql
│  │  └─ attachments.sql
│  ├─ projects/
│  ├─ comms/
│  ├─ finance/
│  ├─ marketplace/
│  └─ storage/
├─ functions/
│  ├─ auth/
│  │  └─ project_or_dm_participant.sql
│  └─ helpers/
│     └─ project_team_ids.sql
├─ views/
│  └─ analytics/
│     ├─ earnings_by_stage_mv.sql
│     └─ refresh_earnings_by_stage.sql
├─ seeds/
│  ├─ 100_skills.sql
│  └─ demo_users.sql
└─ scripts/
   ├─ dump.sh
   ├─ restore.sh
   └─ diff.sh
```

**Migration naming**: `NNNN_descriptive_snake_case.sql` (monotonic, forward-only).  
**Policy files**: one table per file, named exactly as `<schema>/<table>.sql`.  
**Functions/Views**: 1 file per function/view; name equals the function/view.

---

## 5) Supabase Storage Conventions

**Buckets** (all lowercase, singular): `avatars`, `attachments`, `chat`, `project`, `marketplace`, `previews`, `quarantine`, `integrations`, `tmp`.

**Object path format** (use stable IDs, never user-provided names in path segments):

- `avatars/users/{user_id}/{uuid}.{ext}`
- `attachments/{owner_profile_id}/files/{attachment_id}/{sanitized_filename}`
- `project/{project_id}/artifacts/{stage_id}/{uuid}.{ext}`
- `marketplace/assets/{asset_id}/versions/{version_id}/{filename}`

**Naming**: folder segments `snake_case`, files keep original name sanitized to `kebab-case.ext`.

---

## 6) Code & File Naming Conventions

### 6.1 General

- Directories: `kebab-case`
- Files: `kebab-case`
- TypeScript types: `PascalCase` (`UserProfile`, `ProjectStage`)
- Functions/variables: `camelCase`
- Constants: `UPPER_SNAKE_CASE`
- Enums (TS): `PascalCase` enum + `SCREAMING_SNAKE_CASE` members if numeric; otherwise `camelCase` string unions.

### 6.2 UI & Components

- Components: `PascalCase` files with `.tsx` (`AccountSwitcher.tsx`)
- Hooks: `use-*.ts` (`use-active-profile.ts`)
- Cons: `*-con.ts` (`session-con.ts`)
- Islands: end with `.island.tsx` when needed (`AccountSwitcher.island.tsx`)

### 6.3 API Routes (Fresh)

- Resource handlers in `/api/v1/...` named like the path:
  - `/api/v1/projects/[id].ts` (export `GET`, `PATCH`, `DELETE`)
  - `/api/v1/stages/[stageId]/approve.ts` (export `POST`)
- Do not suffix with `controller` or `handler`; the route file **is** the handler.

### 6.4 Services & Integrations

- Service modules: `*-service.ts` (`stripe-service.ts`, `supabase-service.ts`)
- Repositories (DB access wrappers when needed): `*-repo.ts`
- Validation schemas (zod): `*-schema.ts` (`project-schema.ts`)

### 6.5 Tests

- Unit tests: colocate as `*.test.ts` next to source.
- Integration/e2e: `apps/web/tests/*.test.ts` with helpers under `tests/_helpers/`.

---

## 7) Database Naming Conventions

- Schemas: `security`, `org`, `projects`, `comms`, `finance`, `marketplace`, `search`, `ops`, `analytics`, `integrations`.
- Tables: **`snake_case` plural** (`freelancer_profiles`, `project_stages`).
- Columns: `snake_case`. Primary keys named `id` (uuid). Foreign keys reference `<table>.<id>`.
- Enums: `snake_case` values (`draft`, `in_progress`), type names `snake_case`.
- Indexes: `idx_<table>_<col1>[_<col2>]` (e.g., `idx_project_stages_project_id_order`)
- Constraints: `chk_<table>_<column>`, `uq_<table>_<column(s)>`, `fk_<table>_<ref>`
- Policies: `pol_<schema>_<table>_<purpose>` (`pol_projects_projects_owner_access`)
- Triggers: `trg_<table>_<action>` (`trg_stage_submissions_set_timestamp`)
- Functions: `schema.fn_name(argtypes)` with file `schema/fn_name.sql`

**Do not** embed business meaning in primary keys; always use UUIDs.

---

## 8) RLS Policy Organization

- Enable RLS in a single migration early (`0009_rls_enable.sql`).
- One policy file per table in `db/policies/<schema>/<table>.sql`.
- Policy names reflect **who** and **why**:  
  `pol_project_messages_channel_participant_select`,  
  `pol_wallets_owner_select`,  
  `pol_attachments_owner_or_shared_select`.

---

## 9) Env Vars & Secrets

**Naming**: `UPPER_SNAKE_CASE`.  
**Prefixes**:

- Public (exposed to client): `PUBLIC_` (e.g., `PUBLIC_TURNSTILE_SITE_KEY`)
- Server-only: no `PUBLIC_` (e.g., `SUPABASE_SERVICE_ROLE_KEY`, `STRIPE_SECRET_KEY`)

**Files**:

- `.env.example` committed; `.env` ignored.
- For Deno Deploy: use project secrets UI; mirror keys from `.env.example`.

---

## 10) Commit, Branch & PR Conventions

- Branches: `type/short-description`
  - Types: `feat`, `fix`, `chore`, `docs`, `refactor`, `perf`, `test`
  - Example: `feat/account-switcher`, `fix/rls-attachments`
- Commits (Conventional Commits):
  - `feat(projects): add stage approval endpoint`
  - `fix(rls): allow team participants to read channel files`
- PR titles mirror first commit; include “**Scope**” and “**Testing**” sections in description.

---

## 11) Linting, Formatting, and Tasks

- Use Deno’s built-in: `deno lint`, `deno fmt`.
- `deno.json` tasks (examples):

```text json
{
  "tasks": {
    "dev": "deno task -q _dev",
    "_dev": "deno run -A --watch=routes,islands,components main.ts",
    "test": "deno test -A --fail-fast",
    "lint": "deno lint",
    "fmt": "deno fmt",
    "db:migrate": "supabase db reset --db-url $SUPABASE_DB_URL",
    "db:diff": "supabase db diff --linked",
    "typecheck": "deno check apps/web/routes/_app.tsx"
  }
}
```

---

## 12) Error Handling & Response Shapes

- Error objects: `{ error: { code: string, message: string, details?: unknown } }`
- Codes: `auth.invalid_token`, `auth.forbidden`, `validation.failed`, `resource.not_found`, `rate.limit_exceeded`
- Never leak internal stack traces to clients.

---

## 13) API Response & File Naming

- JSON fields: `snake_case` or `camelCase`? **Pick one and stick to it.**  
  For Deno + TS frontends, prefer **camelCase in JSON** (DX), keep **snake_case in DB**.
- Download filenames: `kebab-case` + semantic suffixes (`project-export-2025-10-18.zip`).

---

## 14) Logging, Metrics, and Audit

- App logs: `server/logger.ts` with levels `debug|info|warn|error`.
- Audit logs table: `security.audit_logs`.
- Structured log keys: `timestamp`, `level`, `message`, `con` (request id, user id, profile id).

---

## 15) Testing Conventions

- Unit: colocated `*.test.ts`.
- API integration: `apps/web/tests/api/*.test.ts` hitting `/api/v1` with mocked auth.
- DB invariants: SQL assertions in migration follow-ups (e.g., check policies compile).

---

## 16) Example File Names (Grab-bag)

- Component: `apps/web/components/avatar-uploader.tsx`
- Island: `apps/web/islands/account-switcher.island.tsx`
- Hook: `apps/web/features/auth/use-session.ts`
- Route: `apps/web/routes/api/v1/stages/[stageId]/approve.ts`
- Service: `apps/web/services/turnstile-service.ts`
- Policy file: `db/policies/org/attachments.sql`
- Function file: `db/functions/auth/project_or_dm_participant.sql`
- View file: `db/views/analytics/earnings_by_stage_mv.sql`

---

## 17) CI/CD (GitHub Actions)

```text
yaml
name: ci
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v1
        with: { deno-version: v1.x }
      - run: deno fmt --check
      - run: deno lint
      - run: deno test -A
```

Deploy workflows live under `infra/github/`. Separate jobs for `preview` and `production`.

---

## 18) Accessibility & i18n

- Components accept `aria-*` props; follow WAI-ARIA roles.
- Strings centralized in `packages/lib/i18n/` (lazy-loaded dictionaries).

---

## 19) Security Defaults

- CSP in middleware: default-deny; allow self + asset CDN; disallow inline except hashed.
- Cookies: `Secure; HttpOnly; SameSite=Lax`.
- JWT: short-lived access; opaque refresh rotated; store refresh in HttpOnly cookie.
- Turnstile for anonymous POST endpoints.
- Signed URLs (60s TTL) for Storage downloads.

---

## 20) Documentation

- API contracts in `docs/api/` (OpenAPI generated from handlers or typed definitions).
- Architecture Decision Records in `docs/architecture/adr-XXXX-title.md` (YYYY-MM-DD).
- Product docs in `docs/product/` (features, user stories, flows).

---

## 21) Versioning & Releases

- Tag format: `vMAJOR.MINOR.PATCH` (e.g., `v0.7.3`).
- Changelog: `docs/CHANGELOG.md` using Keep a Changelog syntax.
- Database: bump with each migration; record in `db/migrations/` and `docs/CHANGELOG.md`.

---

### TL;DR Defaults

- **Directories & files**: `kebab-case`.
- **DB**: schemas/tables/cols `snake_case` plural tables.
- **TS**: `camelCase` for code & JSON; `PascalCase` for types/components.
- **Migrations**: `NNNN_description.sql` (forward-only).
- **Routes**: path-mirrored filenames under `/api/v1`.
- **Policies/Functions/Views**: one object per file, name = object.
- **Env**: `PUBLIC_` for client-exposed, everything else server-only.

This scaffolding + naming playbook prevents bikeshedding and keeps velocity high as the codebase grows.

```

### File: docs\14_Sitemap.md

```md
# 🗺️ Projective – Routes & Sitemap (Freelancers, Creators, Teams)

> Tech: **Deno Fresh 2.x**  
> Conventions:  
> - **Route Groups**: `(group-name)/` — folder name does **not** appear in the URL.  
> - **Slug**: `[param]`  
> - **Catch-all**: `[...path]`  
> - **Regex / Constraints**: put a `matchers.ts` next to the route to validate params (see examples).  
> - Auth-gated areas live under `(dashboard)/…` with a shared `_middleware.ts`.

---

## 🌍 Public

| URL Path | Page | Route File (apps/web/routes) | Notes |
|---|---|---|---|
| `/` | Home | `(public)/index.tsx` | Marketing landing |
| `/about` | About | `(public)/about.tsx` |  |
| `/explore` | Explore / Search | `(public)/explore/index.tsx` | Unified search hub |
| `/categories` | Categories | `(public)/categories/index.tsx` | List all |
| `/categories/[slug]` | Category detail | `(public)/categories/[slug].tsx` | **Matcher**: `slug=/^[a-z0-9-]+$/` |
| `/freelancers/[handle]` | Public freelancer profile | `(public)/freelancers/[handle].tsx` | **Matcher**: `handle=/^[a-z0-9_-]{3,32}$/` |
| `/teams/[slug]` | Public team profile | `(public)/teams/[slug].tsx` | Slug constrained via matcher |
| `/articles` | Articles directory | `(public)/articles/index.tsx` |  |
| `/templates` | Templates directory | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Template detail | `(public)/templates/[id].tsx` | UUID matcher |
| `/assets` | Marketplace (future) | `(public)/marketplace/index.tsx` |  |
| `/assets/[id]` | Asset page (future) | `(public)/marketplace/[id].tsx` | UUID matcher |
| `/pricing` | Pricing (future) | `(public)/pricing.tsx` |  |
| `/help` | Help / Support | `(public)/help/index.tsx` |  |
| `/help/[...path]` | Help article catch-all | `(public)/help/[...path].tsx` | MD/MDX renderer |
| `/terms` | Terms | `(public)/legal/terms.tsx` |  |
| `/privacy` | Privacy | `(public)/legal/privacy.tsx` |  |

---

## 🔐 Auth & Account

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/login` | Login | `(auth)/login.tsx` |  |
| `/signup` | Signup | `(auth)/signup.tsx` |  |
| `/auth/verify/[token]` | Email verify | `(auth)/verify/[token].tsx` | **Matcher**: base64/uuid |
| `/auth/forgot-password` | Forgot | `(auth)/forgot-password.tsx` |  |
| `/auth/reset/[token]` | Reset | `(auth)/reset/[token].tsx` |  |
| `/setup` | Choose role | `(auth)/setup/index.tsx` |  |
| `/setup/freelancer` | Freelancer setup | `(auth)/setup/freelancer.tsx` |  |
| `/setup/creator` | Creator setup | `(auth)/setup/creator.tsx` |  |
| `/account` | User account (global) | `(dashboard)/account/index.tsx` | Security, profiles, emails, 2FA |
| `/switch-account` | Account switcher | `(dashboard)/switch-account.tsx` | Updates session context |

> `(dashboard)/_middleware.ts` enforces auth + injects session context (`active_profile_id`, `active_team_id`).

---

## 🧑‍🎨 Freelancer

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/freelancer` | Redirect → dashboard | `(dashboard)/freelancer/index.tsx` |  |
| `/freelancer/dashboard` | Overview | `(dashboard)/freelancer/dashboard.tsx` |  |
| `/freelancer/projects` | My projects | `(dashboard)/freelancer/projects/index.tsx` |  |
| `/freelancer/projects/[id]` | Project workspace | `(dashboard)/freelancer/projects/[id]/index.tsx` | UUID |
| `/freelancer/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/freelancer/projects/[id]/stage/[stageId].tsx` | UUIDs |
| `/freelancer/messages` | Inbox | `(dashboard)/freelancer/messages/index.tsx` |  |
| `/freelancer/messages/[threadId]` | Thread | `(dashboard)/freelancer/messages/[threadId].tsx` |  |
| `/freelancer/teams` | Teams list | `(dashboard)/freelancer/teams/index.tsx` |  |
| `/freelancer/teams/create` | Create team | `(dashboard)/freelancer/teams/create.tsx` |  |
| `/freelancer/teams/[teamId]` | Team dashboard | `(dashboard)/freelancer/teams/[teamId]/index.tsx` | UUID |
| `/freelancer/teams/[teamId]/members` | Manage members | `(dashboard)/freelancer/teams/[teamId]/members.tsx` |  |
| `/freelancer/profile` | Edit profile | `(dashboard)/freelancer/profile/index.tsx` |  |
| `/freelancer/portfolio/new` | Add portfolio item | `(dashboard)/freelancer/portfolio/new.tsx` |  |
| `/freelancer/earnings` | Wallet & payouts | `(dashboard)/freelancer/earnings.tsx` |  |
| `/freelancer/notifications` | Notifications | `(dashboard)/freelancer/notifications.tsx` |  |
| `/freelancer/settings` | Settings | `(dashboard)/freelancer/settings.tsx` |  |

---

## 🧑‍🤝‍🧑 Teams (shared)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/teams/[teamId]` | Team dashboard | `(dashboard)/teams/[teamId]/index.tsx` |  |
| `/teams/[teamId]/projects` | Team projects | `(dashboard)/teams/[teamId]/projects/index.tsx` |  |
| `/teams/[teamId]/projects/[projectId]` | Team project | `(dashboard)/teams/[teamId]/projects/[projectId]/index.tsx` |  |
| `/teams/[teamId]/members` | Members | `(dashboard)/teams/[teamId]/members.tsx` |  |
| `/teams/[teamId]/settings` | Settings | `(dashboard)/teams/[teamId]/settings.tsx` |  |
| `/teams/[teamId]/analytics` | Analytics (future) | `(dashboard)/teams/[teamId]/analytics.tsx` |  |

---

## ✨ Creator (formerly Business)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/creator` | Redirect → dashboard | `(dashboard)/creator/index.tsx` |  |
| `/creator/dashboard` | Overview | `(dashboard)/creator/dashboard.tsx` |  |
| `/creator/projects` | All projects | `(dashboard)/creator/projects/index.tsx` |  |
| `/creator/projects/new` | New project | `(dashboard)/creator/projects/new.tsx` |  |
| `/creator/projects/new/template` | Guided creation | `(dashboard)/creator/projects/new-template.tsx` |  |
| `/creator/projects/[id]` | Project overview | `(dashboard)/creator/projects/[id]/index.tsx` |  |
| `/creator/projects/[id]/stage/[stageId]` | Stage view | `(dashboard)/creator/projects/[id]/stage/[stageId].tsx` |  |
| `/creator/messages` | Inbox | `(dashboard)/creator/messages/index.tsx` |  |
| `/creator/messages/[threadId]` | Thread | `(dashboard)/creator/messages/[threadId].tsx` |  |
| `/creator/wallet` | Payments & invoices | `(dashboard)/creator/wallet.tsx` |  |
| `/creator/settings` | Creator profile & billing | `(dashboard)/creator/settings.tsx` |  |
| `/creator/notifications` | Notifications | `(dashboard)/creator/notifications.tsx` |  |

---

## 🧱 Project Workspace (URL-based, role-agnostic)

These mirror deep-links that both roles can use; they live under `(dashboard)/projects` to keep logic centralized. Your role decides what controls render.

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/projects/[id]` | Project dashboard | `(dashboard)/projects/[id]/index.tsx` |  |
| `/projects/[id]/stages` | Stages list | `(dashboard)/projects/[id]/stages.tsx` |  |
| `/projects/[id]/stage/[stageId]` | Stage details | `(dashboard)/projects/[id]/stage/[stageId].tsx` |  |
| `/projects/[id]/chat` | Project chat (general) | `(dashboard)/projects/[id]/chat/index.tsx` |  |
| `/projects/[id]/chat/[channelId]` | Channel view | `(dashboard)/projects/[id]/chat/[channelId].tsx` |  |
| `/projects/[id]/files` | File gallery | `(dashboard)/projects/[id]/files.tsx` |  |
| `/projects/[id]/activity` | Activity feed | `(dashboard)/projects/[id]/activity.tsx` |  |

---

## 💬 Global Messaging & Notifications

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/messages` | Unified inbox | `(dashboard)/(comms)/messages/index.tsx` | Combines DMs + project threads |
| `/messages/[threadId]` | DM / group thread | `(dashboard)/(comms)/messages/[threadId].tsx` |  |
| `/notifications` | Notification center | `(dashboard)/(comms)/notifications.tsx` |  |

---

## 🧩 Templates (creator & freelancer)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/templates` | Browse (public) | `(public)/templates/index.tsx` |  |
| `/templates/[id]` | Detail (public) | `(public)/templates/[id].tsx` |  |
| `/dashboard/templates` | My templates | `(dashboard)/dashboard/templates/index.tsx` | owner view |
| `/dashboard/templates/create` | Create template | `(dashboard)/dashboard/templates/create.tsx` |  |
| `/dashboard/templates/[id]/edit` | Edit template | `(dashboard)/dashboard/templates/[id]/edit.tsx` |  |

---

## Articles (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/articles` | Browse (public) | `(public)/articles/index.tsx` |  |
| `/articles/[id]` | Detail (public) | `(public)/articles/[id].tsx` |  |
| `/dashboard/articles` | My article | `(dashboard)/dashboard/articles/index.tsx` | owner view |
| `/dashboard/articles/create` | Create article | `(dashboard)/dashboard/articles/create.tsx` |  |
| `/dashboard/articles/[id]/edit` | Edit article | `(dashboard)/dashboard/articles/[id]/edit.tsx` |  |

---

## 🛍️ Marketplace (future)

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/marketplace` | Catalog | `(public)/marketplace/index.tsx` |  |
| `/marketplace/[id]` | Asset | `(public)/marketplace/[id].tsx` |  |
| `/dashboard/marketplace/upload` | Upload asset | `(dashboard)/dashboard/marketplace/upload.tsx` |  |
| `/dashboard/marketplace/sales` | My sales | `(dashboard)/dashboard/marketplace/sales.tsx` |  |
| `/dashboard/marketplace/purchases` | My purchases | `(dashboard)/dashboard/marketplace/purchases.tsx` |  |

---

## 💰 Finance

| URL Path | Page | Route File | Notes |
|---|---|---|---|
| `/wallet` | Wallet overview | `(dashboard)/finance/wallet/index.tsx` | Context-aware (profile/team) |
| `/transactions` | Transactions | `(dashboard)/finance/transactions.tsx` |  |
| `/invoices` | Invoices | `(dashboard)/finance/invoices/index.tsx` |  |
| `/invoices/[id]` | Invoice detail | `(dashboard)/finance/invoices/[id].tsx` |  |
| `/disputes` | Disputes | `(dashboard)/finance/disputes/index.tsx` |  |
| `/ratings` | Ratings & reviews | `(dashboard)/finance/ratings.tsx` |  |
| `/subscription` | Subscription (future) | `(dashboard)/finance/subscription.tsx` | Promoted listings mgmt later |

---

## 📊 Analytics (later)

| URL Path | Page | Route File |
|---|---|---|
| `/analytics/freelancer` | Freelancer insights | `(dashboard)/analytics/freelancer.tsx` |
| `/analytics/creator` | Creator insights | `(dashboard)/analytics/creator.tsx` |
| `/analytics/team` | Team insights | `(dashboard)/analytics/team.tsx` |

---

## ⚙️ Admin (internal)

| URL Path | Page | Route File |
|---|---|---|
| `/admin` | Dashboard | `(dashboard)/admin/index.tsx` |
| `/admin/users` | Users | `(dashboard)/admin/users.tsx` |
| `/admin/projects` | Projects | `(dashboard)/admin/projects.tsx` |
| `/admin/flags` | Moderation flags | `(dashboard)/admin/flags.tsx` |
| `/admin/emails` | Email queue | `(dashboard)/admin/emails.tsx` |
| `/admin/webhooks` | Webhooks | `(dashboard)/admin/webhooks.tsx` |
| `/admin/feature-flags` | Feature flags | `(dashboard)/admin/feature-flags.tsx` |

---

## 🔧 Matchers (Regex) — Examples

Create a `matchers.ts` next to any dynamic route to constrain params:

```ts
// apps/web/routes/(public)/freelancers/[handle].tsx
export const match = { handle: /^[a-z0-9_-]{3,32}$/i };

// apps/web/routes/(public)/templates/[id].tsx
export const match = { id: /^[0-9a-f-]{36}$/i }; // UUID v4 relaxed

// apps/web/routes/(dashboard)/projects/[id]/stage/[stageId].tsx
export const match = {
  id: /^[0-9a-f-]{36}$/i,
  stageId: /^[0-9a-f-]{36}$/i,
};
```

```text
apps/web/routes/
├─ (public)/
│  ├─ index.tsx
│  ├─ about.tsx
│  ├─ explore/index.tsx
│  ├─ categories/[slug].tsx
│  ├─ freelancers/[handle].tsx
│  ├─ teams/[slug].tsx
│  ├─ templates/[id].tsx
│  ├─ marketplace/[id].tsx
│  └─ help/[...path].tsx
├─ (auth)/
│  ├─ login.tsx
│  ├─ signup.tsx
│  ├─ verify/[token].tsx
│  ├─ forgot-password.tsx
│  ├─ reset/[token].tsx
│  └─ onboarding/{index.tsx, freelancer.tsx, creator.tsx}
├─ (dashboard)/
│  ├─ _middleware.ts
│  ├─ account/index.tsx
│  ├─ switch-account.tsx
│  ├─ freelancer/…
│  ├─ creator/…
│  ├─ teams/…
│  ├─ projects/…
│  ├─ comms/…
│  ├─ templates/…
│  ├─ finance/…
│  ├─ analytics/…
│  ├─ admin/…
│  └─ account/…
└─ _app.tsx
```
```

### File: packages\backend\auth\jwt.ts

```ts
import { ENV } from "../config.ts";

// packages/server-utils/jwt.ts
let _jwtKey: CryptoKey | null = null;

export async function getJwtKey(): Promise<CryptoKey> {
	if (_jwtKey) return _jwtKey;

	// ENV.JWT_SECRET is a string. We have to turn it into bytes for importKey.
	const raw = new TextEncoder().encode(ENV.JWT_SECRET);

	_jwtKey = await crypto.subtle.importKey(
		"raw",
		raw,
		{ name: "HMAC", hash: "SHA-256" },
		false,
		["sign", "verify"],
	);

	return _jwtKey;
}

```

### File: packages\backend\auth\tokens.ts

```ts
import { create } from 'djwt';
import { hashArgon2id, randomTokenString } from '../crypto.ts';
import { getJwtKey } from './jwt.ts'; // <-- new

const ACCESS_TTL_SECONDS = 15 * 60; // 15 minutes
const REFRESH_TTL_SECONDS = 60 * 60 * 24 * 30; // ~30 days

export type SessionClaims = {
	userId: string;
	activeProfileType: 'freelancer' | 'business' | null;
	activeProfileId: string | null;
	activeTeamId: string | null;
};

export async function mintAccessToken(claims: SessionClaims) {
	const exp = Math.floor(Date.now() / 1000) + ACCESS_TTL_SECONDS;

	const payload = {
		sub: claims.userId,
		active_profile_type: claims.activeProfileType,
		active_profile_id: claims.activeProfileId,
		active_team_id: claims.activeTeamId,
		exp,
	};

	const key = await getJwtKey();

	const token = await create(
		{ alg: 'HS256', typ: 'JWT' },
		payload,
		key,
	);

	return { token, exp };
}

/**
 * Creates a new refresh token (opaque random string),
 * hashes it, and returns both the plaintext token (for cookie)
 * and the hash (for DB storage).
 */
export async function mintRefreshToken() {
	const plaintext = randomTokenString(32);
	const hash = await hashArgon2id(plaintext);
	const exp = Math.floor(Date.now() / 1000) + REFRESH_TTL_SECONDS;
	return { plaintext, hash, exp };
}

export function buildAccessCookie(accessToken: string, maxAgeSeconds = ACCESS_TTL_SECONDS) {
	return [
		'access_token=',
		accessToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		`; Max-Age=${maxAgeSeconds}`,
		'; Path=/',
	].join('');
}

export function buildRefreshCookie(refreshToken: string) {
	return [
		'refresh_token=',
		refreshToken,
		'; HttpOnly',
		'; Secure',
		'; SameSite=Lax',
		'; Path=/api/v1/auth',
	].join('');
}

```

### File: packages\backend\config.ts

```ts
import './env.ts';

function requireEnv(name: string): string {
	const value = Deno.env.get(name);
	if (!value) {
		console.error(`Missing required env var: ${name}`);
		if (Deno.env.get('DENO_DEPLOYMENT_ID')) return '';
		throw new Error(`Missing env: ${name}`);
	}
	return value;
}

export const Config = {
	SUPABASE_URL: requireEnv('SUPABASE_URL'),
	SUPABASE_SERVICE_ROLE_KEY: requireEnv('SUPABASE_SERVICE_ROLE_KEY'),
	JWT_SECRET: requireEnv('JWT_SECRET'),
	APP_ENV: Deno.env.get('APP_ENV') ?? 'development',
	BASE_URL: Deno.env.get('URL'),
};

```

### File: packages\backend\cookies.ts

```ts
import { type Cookie, deleteCookie, getCookies, setCookie } from '@std/http/cookie';

type SetAuthOpts = {
	accessToken: string;
	refreshToken: string;
	/** Pass the current request URL so we can decide secure + naming correctly. */
	requestUrl: URL;
};

/** Local dev can’t use __Host-* (requires secure + no Domain + Path=/ on HTTPS). */
function resolveCookieNames(isSecureOrigin: boolean, isLocalhost: boolean) {
	if (isSecureOrigin && !isLocalhost) {
		return { ACCESS_NAME: '__Host-pjv-at', REFRESH_NAME: '__Host-pjv-rt' };
	}
	return { ACCESS_NAME: 'pjv-at', REFRESH_NAME: 'pjv-rt' };
}

function isLocalhostHost(hostname: string) {
	return (
		hostname === 'localhost' ||
		hostname === '127.0.0.1' ||
		hostname === '[::1]' ||
		/\.local(domain)?$/i.test(hostname)
	);
}

export function setAuthCookies(
	headers: Headers,
	{ accessToken, refreshToken, requestUrl }: SetAuthOpts,
) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	// Common attributes for auth cookies
	const common: Partial<Cookie> = {
		httpOnly: true,
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal, // never mark Secure on localhost
		path: '/', // required for __Host-* and fine for non-__Host too
	};

	// Access: ~15 minutes
	setCookie(headers, {
		...common,
		name: ACCESS_NAME,
		value: accessToken,
		maxAge: 60 * 15,
	});

	// Refresh: ~30 days
	setCookie(headers, {
		...common,
		name: REFRESH_NAME,
		value: refreshToken,
		maxAge: 60 * 60 * 24 * 30,
	});

	// CSRF (readable) — double-submit token, same naming irrespective of env
	setCookie(headers, {
		name: 'pjv-csrf',
		value: randomToken(),
		httpOnly: false, // must be readable by JS
		sameSite: 'Lax',
		secure: isSecureOrigin && !isLocal,
		path: '/',
		maxAge: 60 * 60 * 24 * 30,
	});
}

export function clearAuthCookies(headers: Headers, requestUrl: URL) {
	const isSecureOrigin = requestUrl.protocol === 'https:';
	const isLocal = isLocalhostHost(requestUrl.hostname);
	const { ACCESS_NAME, REFRESH_NAME } = resolveCookieNames(isSecureOrigin, isLocal);

	const base = { path: '/', secure: isSecureOrigin && !isLocal } as const;

	// Delete both possible names just in case a previous env wrote the other variant.
	deleteCookie(headers, ACCESS_NAME, base);
	deleteCookie(headers, REFRESH_NAME, base);
	deleteCookie(headers, 'pjv-csrf', base);

	// Also try deleting the opposite flavor to avoid sticky leftovers across envs.
	deleteCookie(headers, '__Host-pjv-at', base);
	deleteCookie(headers, '__Host-pjv-rt', base);
	deleteCookie(headers, 'pjv-at', base);
	deleteCookie(headers, 'pjv-rt', base);
}

export function getAuthCookies(req: Request) {
	const c = getCookies(req.headers);
	// Support both name variants seamlessly.
	const accessToken = c['__Host-pjv-at'] ?? c['pjv-at'];
	const refreshToken = c['__Host-pjv-rt'] ?? c['pjv-rt'];
	return {
		accessToken,
		refreshToken,
		csrf: c['pjv-csrf'],
	};
}

// ---- CSRF helpers ----

export function verifyCsrf(req: Request): boolean {
	const method = req.method.toUpperCase();
	if (!['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) return true;

	const cookies = getCookies(req.headers);
	const sent = req.headers.get('X-CSRF');
	const expected = cookies['pjv-csrf'];
	return Boolean(sent && expected && sent === expected);
}

// Generate a CSRF token
function randomToken(bytes = 32) {
	const a = new Uint8Array(bytes);
	crypto.getRandomValues(a);
	return btoa(String.fromCharCode(...a)).replace(/=+$/, '');
}

```

### File: packages\backend\crypto.ts

```ts
// packages/server-utils/crypto.ts

// Generate URL-safe random string (base64-ish) for refresh tokens
export function randomTokenString(byteLength = 32): string {
	const raw = crypto.getRandomValues(new Uint8Array(byteLength));
	// convert Uint8Array -> binary string -> base64
	const bin = String.fromCharCode(...raw);
	return btoa(bin); // you can further make it URL-safe if you want
}

// TODO: replace with real Argon2id
export async function hashArgon2id(value: string): Promise<string> {
	// WARNING: placeholder.
	// You MUST replace this with a secure Argon2id hash implementation
	// before production. We're returning a SHA-256 for now just so dev works.
	const data = new TextEncoder().encode(value);
	const digest = await crypto.subtle.digest('SHA-256', data);
	const bytes = new Uint8Array(digest);
	return Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
}

```

### File: packages\backend\deno.json

```json
{
  "name": "@backend",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\backend\env.ts

```ts
import { loadSync } from '@std/dotenv';

loadSync({ export: true });

const mode = Deno.env.get('MODE') ??
	Deno.env.get('NODE_ENV') ??
	Deno.env.get('VITE_MODE') ??
	'development';

loadSync({ envPath: `.env.${mode}`, export: true });

```

### File: packages\backend\mod.ts

```ts
import { loadSync } from '@std/dotenv';

loadSync({ export: true });

export * from './config.ts';
export * from './crypto.ts';
export * from './auth/jwt.ts';
export * from './auth/tokens.ts';
export * from './cookies.ts';
export * from './rateLimiter.ts';

```

### File: packages\backend\rateLimiter.ts

```ts
type BucketInfo = {
	count: number;
	resetAt: number;
};

// Note: In a serverless environment (Deno Deploy), this Map is not shared across regions/isolates.
// For strict global rate limiting, you must use Deno KV.
// For now, this is "per-isolate" limiting.
const buckets = new Map<string, BucketInfo>();

export function rateLimitByIP(ip: string, limit = 20, windowMs = 60_000) {
	const now = Date.now();
	const bucket = buckets.get(ip);

	if (!bucket || now > bucket.resetAt) {
		buckets.set(ip, {
			count: 1,
			resetAt: now + windowMs,
		});
		return { allowed: true, remaining: limit - 1 };
	}

	if (bucket.count >= limit) {
		return { allowed: false, remaining: 0 };
	}

	bucket.count += 1;
	return { allowed: true, remaining: limit - bucket.count };
}

```

### File: packages\shared\cookies.ts

```ts
export function getCsrfToken(name = 'pjv-csrf'): string | null {
	const cookie = typeof document !== 'undefined' ? document.cookie : '';
	if (!cookie) return null;

	const match = cookie.match(
		new RegExp('(?:^|; )' + name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&') + '=([^;]*)'),
	);

	return match ? decodeURIComponent(match[1]) : null;
}

```

### File: packages\shared\deno.json

```json
{
  "name": "@shared",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\shared\mod.ts

```ts
// export * from './types.ts';
export * from './validation/auth.ts';
export * from './cookies.ts';

```

### File: packages\shared\types.ts

```ts

```

### File: packages\shared\validation\auth.ts

```ts
import { escape } from '@std/regexp/escape';

export type RegisterFields = {
	email: string;
	password: string;
	confirmPassword: string;
};

export type RegisterErrors = {
	email?: string;
	password?: string;
	confirmPassword?: string;
};

export class AuthValidator {
	// --- email validation ---
	static validateEmail(email: string): string | null {
		const trimmed = email.trim();
		if (!trimmed) return 'Email is required.';
		// Basic regex, can be improved
		const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailPattern.test(trimmed)) return 'Enter a valid email address.';
		return null;
	}

	// --- password validation ---
	static validatePassword(password: string, email?: string): string | null {
		if (!password) {
			return 'Password is required.';
		}

		if (password.length < 8) {
			return 'Password must be at least 8 characters long.';
		}

		if (!/[a-z]/.test(password)) {
			return 'Password must contain at least one lowercase letter.';
		}

		if (!/[A-Z]/.test(password)) {
			return 'Password must contain at least one uppercase letter.';
		}

		if (!/[0-9]/.test(password)) {
			return 'Password must contain at least one digit.';
		}

		if (!/[^A-Za-z0-9]/.test(password)) {
			return 'Password must contain at least one symbol.';
		}

		if (/\s/.test(password)) {
			return 'Password must not contain spaces.';
		}

		if (email) {
			const trimmedEmail = email.trim();
			if (trimmedEmail) {
				const escapedEmail = escape(trimmedEmail);
				const emailInPassword = new RegExp(escapedEmail, 'i');

				if (emailInPassword.test(password)) {
					return 'Password must not contain your email.';
				}
			}
		}

		return null;
	}

	// --- confirm password validation ---
	static validateConfirmPassword(
		password: string,
		confirmPassword: string,
	): string | null {
		if (!confirmPassword) {
			return 'Please confirm your password.';
		}

		if (password !== confirmPassword) {
			return 'Passwords do not match.';
		}

		return null;
	}

	// --- full validation entrypoint ---
	static validate(
		fields: RegisterFields,
	): { ok: boolean; errors: RegisterErrors } {
		const errors: RegisterErrors = {};

		const emailError = this.validateEmail(fields.email);
		if (emailError) errors.email = emailError;

		const passwordError = this.validatePassword(
			fields.password,
			fields.email,
		);
		if (passwordError) errors.password = passwordError;

		const confirmError = this.validateConfirmPassword(
			fields.password,
			fields.confirmPassword,
		);
		if (confirmError) errors.confirmPassword = confirmError;

		const ok = Object.keys(errors).length === 0;

		return { ok, errors };
	}
}

```

### File: packages\ui\deno.json

```json
{
  "name": "@ui",
  "version": "0.0.0",
  "exports": "./mod.ts"
}

```

### File: packages\ui\mod.ts

```ts

```

### File: packages\ui\utils\ThemeSwitcher.ts

```ts
import { effect, signal } from '@preact/signals';

export const theme = signal<'light' | 'dark'>('dark');

if (typeof window !== 'undefined') {
	const saved = localStorage.getItem('theme');
	if (saved === 'light' || saved === 'dark') theme.value = saved;

	effect(() => {
		document.documentElement.setAttribute('data-theme', theme.value);
		try {
			localStorage.setItem('theme', theme.value);
		} catch {
			//
		}
	});
}

```

### File: scripts\validate_names.ts

```ts
// scripts/validate_names.ts
// Adds support for special route files that start with "_" (e.g. _app, _layout, _middleware, _404)

const kebab = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
const pascal = /^[A-Z][A-Za-z0-9]*$/;

function isDynamicSegment(name: string) {
	return /^\[.+\]$/.test(name);
}

function isSpecialRouteBase(base: string) {
	if (!base.startsWith('_')) return false;
	const rest = base.slice(1);

	// Allow numeric error pages like _404, _500
	if (/^\d+$/.test(rest)) return true;

	// Common special names (Fresh/Next-style)
	const specials = new Set([
		'app',
		'layout',
		'middleware',
		'document',
		'error',
		'404',
		'500',
	]);
	if (specials.has(rest)) return true;

	// Or allow "_<kebab-case>" generally (e.g., _app-shell)
	if (kebab.test(rest)) return true;

	return false;
}

function norm(p: string) {
	return p.replaceAll('\\', '/');
}

async function* walk(dir: string): AsyncGenerator<string> {
	try {
		for await (const entry of Deno.readDir(dir)) {
			const p = `${dir}/${entry.name}`;
			if (entry.isDirectory) yield* walk(p);
			else yield p;
		}
	} catch {
		// ignore missing dirs
	}
}

function pathHasSegment(p: string, segment: 'routes' | 'islands' | 'components'): boolean {
	const parts = norm(p).split('/');
	return parts.includes(segment);
}

function nearestSegmentRoot(p: string, segment: 'routes' | 'islands' | 'components'): string {
	const parts = norm(p).split('/');
	const idx = parts.lastIndexOf(segment);
	return idx >= 0 ? parts.slice(0, idx + 1).join('/') : segment;
}

function checkRoutesPath(filePath: string): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	const root = nearestSegmentRoot(normalized, 'routes');
	const rel = normalized.slice(root.length + 1); // part under routes/

	const parts = rel.split('/');

	// Validate route directories (not filenames)
	for (let i = 0; i < parts.length - 1; i++) {
		const seg = parts[i];
		if (isDynamicSegment(seg)) continue; // allow [id], [...all]
		if (/\s/.test(seg)) errors.push(`folder "${seg}" must not contain spaces`);
		if (/[A-Z]/.test(seg)) errors.push(`folder "${seg}" must not contain uppercase`);
		if (!kebab.test(seg)) errors.push(`folder "${seg}" must be kebab-case or [dynamic]`);
	}

	// Validate filename
	const file = parts[parts.length - 1];
	const extMatch = file.match(/\.(tsx|ts|jsx|js)$/);
	if (!extMatch) return errors; // only care about code files

	const base = file.replace(/\.(tsx|ts|jsx|js)$/, '');
	if (
		base === 'index' ||
		isDynamicSegment(base) ||
		isSpecialRouteBase(base) // <-- NEW: allow _app, _layout, _404, or _<kebab>
	) {
		return errors;
	}

	if (/\s/.test(base)) errors.push(`file "${file}" must not contain spaces`);
	if (/[A-Z]/.test(base)) errors.push(`file "${file}" must not contain uppercase`);
	if (!kebab.test(base)) {
		errors.push(`file "${file}" must be kebab-case (or [dynamic]/index/_special)`);
	}

	return errors.map((e) => `routes: ${e} -> ${normalized}`);
}

function checkPascalDir(filePath: string, segment: 'islands' | 'components'): string[] {
	const errors: string[] = [];
	const normalized = norm(filePath);
	if (!/\.tsx$/.test(normalized)) return errors; // only enforce for TSX components

	const file = normalized.split('/').pop()!;
	const base = file.replace(/\.tsx$/, '');
	if (!pascal.test(base)) {
		errors.push(`${segment}: "${file}" must be PascalCase.tsx -> ${normalized}`);
	}
	return errors;
}

async function run() {
	const violations: string[] = [];
	for await (const file of walk('.')) {
		const p = norm(file);

		// Skip obvious non-source areas
		if (
			p.includes('/node_modules/') ||
			p.includes('/dist/') ||
			p.includes('/tmp/') ||
			p.includes('/infra/') ||
			p.includes('/supabase/')
		) continue;

		if (pathHasSegment(p, 'routes')) violations.push(...checkRoutesPath(p));
		if (pathHasSegment(p, 'islands')) violations.push(...checkPascalDir(p, 'islands'));
		if (pathHasSegment(p, 'components')) violations.push(...checkPascalDir(p, 'components'));
	}

	if (violations.length) {
		console.error('\n❌ Naming violations (' + violations.length + '):');
		for (const v of violations) console.error(' - ' + v);
		Deno.exit(1);
	} else {
		console.log('✅ Naming conventions OK');
	}
}

await run();

```

### File: vite.config.ts

```ts
import { defineConfig } from 'vite';
import { fresh } from '@fresh/plugin-vite';
import { fileURLToPath } from 'node:url';

const r = (p: string) => fileURLToPath(new URL(p, import.meta.url));

export default defineConfig({
	root: 'apps/web',

	plugins: [fresh()],

	resolve: {
		alias: {
			'@': r('./apps/web/'),
			'@styles': r('./apps/web/styles/'),
			'@components': r('./apps/web/components/'),
			'@features': r('./apps/web/features/'),
			'@islands': r('./apps/web/islands/'),
			'@server': r('./apps/web/server/'),
			'@services': r('./apps/web/services/'),
			'@types': r('./apps/web/types/'),
			'@utils': r('./apps/web/utils.ts'),
			'packages': r('./packages'),
		},
	},
});

```

